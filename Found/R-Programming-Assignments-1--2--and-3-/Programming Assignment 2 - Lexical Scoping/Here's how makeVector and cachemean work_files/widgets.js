(function(undefined){function padToken(func,count){return function(a){return leftZeroFill(func.call(this,a),count)}}function ordinalizeToken(func,period){return function(a){return this.lang().ordinal(func.call(this,a),period)}}function Language(){}function Moment(config){checkOverflow(config),extend(this,config)}function Duration(duration){var normalizedInput=normalizeObjectUnits(duration),years=normalizedInput.year||0,months=normalizedInput.month||0,weeks=normalizedInput.week||0,days=normalizedInput.day||0,hours=normalizedInput.hour||0,minutes=normalizedInput.minute||0,seconds=normalizedInput.second||0,milliseconds=normalizedInput.millisecond||0;this._input=duration,this._milliseconds=+milliseconds+1e3*seconds+6e4*minutes+36e5*hours,this._days=+days+7*weeks,this._months=+months+12*years,this._data={},this._bubble()}function extend(a,b){for(var i in b)if(b.hasOwnProperty(i))a[i]=b[i];if(b.hasOwnProperty("toString"))a.toString=b.toString;if(b.hasOwnProperty("valueOf"))a.valueOf=b.valueOf;return a}function absRound(number){if(0>number)return Math.ceil(number);else return Math.floor(number)}function leftZeroFill(number,targetLength){for(var output=number+"";output.length<targetLength;)output="0"+output;return output}function addOrSubtractDurationFromMoment(mom,duration,isAdding,ignoreUpdateOffset){var milliseconds=duration._milliseconds,days=duration._days,months=duration._months,minutes,hours;if(milliseconds)mom._d.setTime(+mom._d+milliseconds*isAdding);if(days||months)minutes=mom.minute(),hours=mom.hour();if(days)mom.date(mom.date()+days*isAdding);if(months)mom.month(mom.month()+months*isAdding);if(milliseconds&&!ignoreUpdateOffset)moment.updateOffset(mom);if(days||months)mom.minute(minutes),mom.hour(hours)}function isArray(input){return"[object Array]"===Object.prototype.toString.call(input)}function isDate(input){return"[object Date]"===Object.prototype.toString.call(input)}function compareArrays(array1,array2,dontConvert){var len=Math.min(array1.length,array2.length),lengthDiff=Math.abs(array1.length-array2.length),diffs=0,i;for(i=0;len>i;i++)if(dontConvert&&array1[i]!==array2[i]||!dontConvert&&toInt(array1[i])!==toInt(array2[i]))diffs++;return diffs+lengthDiff}function normalizeUnits(units){return units?unitAliases[units]||units.toLowerCase().replace(/(.)s$/,"$1"):units}function normalizeObjectUnits(inputObject){var normalizedInput={},normalizedProp,prop,index;for(prop in inputObject)if(inputObject.hasOwnProperty(prop))if(normalizedProp=normalizeUnits(prop))normalizedInput[normalizedProp]=inputObject[prop];return normalizedInput}function makeList(field){var count,setter;if(0===field.indexOf("week"))count=7,setter="day";else if(0===field.indexOf("month"))count=12,setter="month";else return;moment[field]=function(format,index){var i,getter,method=moment.fn._lang[field],results=[];if("number"==typeof format)index=format,format=undefined;if(getter=function(i){var m=moment().utc().set(setter,i);return method.call(moment.fn._lang,m,format||"")},index)return getter(index);else{for(i=0;count>i;i++)results.push(getter(i));return results}}}function toInt(argumentForCoercion){var coercedNumber=+argumentForCoercion,value=0;if(0!==coercedNumber&&isFinite(coercedNumber))if(coercedNumber>=0)value=Math.floor(coercedNumber);else value=Math.ceil(coercedNumber);return value}function daysInMonth(year,month){return moment.utc([year,month+1,0]).date()}function isLeapYear(year){return year%4===0&&year%100!==0||year%400===0}function checkOverflow(m){var overflow;if(m._a&&-2===m._pf.overflow){if(overflow=m._a[MONTH]<0||m._a[MONTH]>11?MONTH:m._a[DATE]<1||m._a[DATE]>daysInMonth(m._a[YEAR],m._a[MONTH])?DATE:m._a[HOUR]<0||m._a[HOUR]>23?HOUR:m._a[MINUTE]<0||m._a[MINUTE]>59?MINUTE:m._a[SECOND]<0||m._a[SECOND]>59?SECOND:m._a[MILLISECOND]<0||m._a[MILLISECOND]>999?MILLISECOND:-1,m._pf._overflowDayOfYear&&(YEAR>overflow||overflow>DATE))overflow=DATE;m._pf.overflow=overflow}}function initializeParsingFlags(config){config._pf={empty:!1,unusedTokens:[],unusedInput:[],overflow:-2,charsLeftOver:0,nullInput:!1,invalidMonth:null,userInvalidated:!1}}function isValid(m){if(null==m._isValid)if(m._isValid=!isNaN(m._d.getTime())&&m._pf.overflow<0&&!m._pf.empty&&!m._pf.invalidMonth&&!m._pf.nullInput&&!m._pf.userInvalidated,m._strict)m._isValid=m._isValid&&0===m._pf.charsLeftOver&&0===m._pf.unusedTokens.length;return m._isValid}function normalizeLanguage(key){return key?key.toLowerCase().replace("_","-"):key}function loadLang(key,values){if(values.abbr=key,!languages[key])languages[key]=new Language;return languages[key].set(values),languages[key]}function unloadLang(key){delete languages[key]}function getLangDefinition(key){var i=0,j,lang,next,split,get=function(k){if(!languages[k]&&hasModule)try{require("./lang/"+k)}catch(e){}return languages[k]};if(!key)return moment.fn._lang;if(!isArray(key)){if(lang=get(key))return lang;key=[key]}for(;i<key.length;){for(split=normalizeLanguage(key[i]).split("-"),j=split.length,next=normalizeLanguage(key[i+1]),next=next?next.split("-"):null;j>0;){if(lang=get(split.slice(0,j).join("-")))return lang;if(next&&next.length>=j&&compareArrays(split,next,!0)>=j-1)break;j--}i++}return moment.fn._lang}function removeFormattingTokens(input){if(input.match(/\[[\s\S]/))return input.replace(/^\[|\]$/g,"");else return input.replace(/\\/g,"")}function makeFormatFunction(format){var array=format.match(formattingTokens),i,length;for(i=0,length=array.length;length>i;i++)if(formatTokenFunctions[array[i]])array[i]=formatTokenFunctions[array[i]];else array[i]=removeFormattingTokens(array[i]);return function(mom){var output="";for(i=0;length>i;i++)output+=array[i]instanceof Function?array[i].call(mom,format):array[i];return output}}function formatMoment(m,format){if(!m.isValid())return m.lang().invalidDate();if(format=expandFormat(format,m.lang()),!formatFunctions[format])formatFunctions[format]=makeFormatFunction(format);return formatFunctions[format](m)}function expandFormat(format,lang){function replaceLongDateFormatTokens(input){return lang.longDateFormat(input)||input}var i=5;for(localFormattingTokens.lastIndex=0;i>=0&&localFormattingTokens.test(format);)format=format.replace(localFormattingTokens,replaceLongDateFormatTokens),localFormattingTokens.lastIndex=0,i-=1;return format}function getParseRegexForToken(token,config){var a;switch(token){case"DDDD":return parseTokenThreeDigits;case"YYYY":return parseTokenFourDigits;case"YYYYY":return parseTokenSixDigits;case"S":case"SS":case"SSS":case"DDD":return parseTokenOneToThreeDigits;case"MMM":case"MMMM":case"dd":case"ddd":case"dddd":return parseTokenWord;case"a":case"A":return getLangDefinition(config._l)._meridiemParse;case"X":return parseTokenTimestampMs;case"Z":case"ZZ":return parseTokenTimezone;case"T":return parseTokenT;case"MM":case"DD":case"YY":case"HH":case"hh":case"mm":case"ss":case"M":case"D":case"d":case"H":case"h":case"m":case"s":return parseTokenOneOrTwoDigits;default:return a=new RegExp(regexpEscape(unescapeFormat(token.replace("\\","")),"i"))}}function timezoneMinutesFromString(string){var tzchunk=(parseTokenTimezone.exec(string)||[])[0],parts=(tzchunk+"").match(parseTimezoneChunker)||["-",0,0],minutes=+(60*parts[1])+toInt(parts[2]);return"+"===parts[0]?-minutes:minutes}function addTimeToArrayFromToken(token,input,config){var a,datePartArray=config._a;switch(token){case"M":case"MM":if(null!=input)datePartArray[MONTH]=toInt(input)-1;break;case"MMM":case"MMMM":if(a=getLangDefinition(config._l).monthsParse(input),null!=a)datePartArray[MONTH]=a;else config._pf.invalidMonth=input;break;case"D":case"DD":if(null!=input)datePartArray[DATE]=toInt(input);break;case"DDD":case"DDDD":if(null!=input)config._dayOfYear=toInt(input);break;case"YY":datePartArray[YEAR]=toInt(input)+(toInt(input)>68?1900:2e3);break;case"YYYY":case"YYYYY":datePartArray[YEAR]=toInt(input);break;case"a":case"A":config._isPm=getLangDefinition(config._l).isPM(input);break;case"H":case"HH":case"h":case"hh":datePartArray[HOUR]=toInt(input);break;case"m":case"mm":datePartArray[MINUTE]=toInt(input);break;case"s":case"ss":datePartArray[SECOND]=toInt(input);break;case"S":case"SS":case"SSS":datePartArray[MILLISECOND]=toInt(1e3*("0."+input));break;case"X":config._d=new Date(1e3*parseFloat(input));break;case"Z":case"ZZ":config._useUTC=!0,config._tzm=timezoneMinutesFromString(input)}}function dateFromConfig(config){var i,date,input=[],currentDate,yearToUse;if(!config._d){if(currentDate=currentDateArray(config),config._dayOfYear){if(yearToUse=null==config._a[YEAR]?currentDate[YEAR]:config._a[YEAR],config._dayOfYear>(isLeapYear(yearToUse)?364:365))config._pf._overflowDayOfYear=!0;date=makeUTCDate(yearToUse,0,config._dayOfYear),config._a[MONTH]=date.getUTCMonth(),config._a[DATE]=date.getUTCDate()}for(i=0;3>i&&null==config._a[i];++i)config._a[i]=input[i]=currentDate[i];for(;7>i;i++)config._a[i]=input[i]=null==config._a[i]?2===i?1:0:config._a[i];input[HOUR]+=toInt((config._tzm||0)/60),input[MINUTE]+=toInt((config._tzm||0)%60),config._d=(config._useUTC?makeUTCDate:makeDate).apply(null,input)}}function dateFromObject(config){var normalizedInput;if(!config._d)normalizedInput=normalizeObjectUnits(config._i),config._a=[normalizedInput.year,normalizedInput.month,normalizedInput.day,normalizedInput.hour,normalizedInput.minute,normalizedInput.second,normalizedInput.millisecond],dateFromConfig(config)}function currentDateArray(config){var now=new Date;if(config._useUTC)return[now.getUTCFullYear(),now.getUTCMonth(),now.getUTCDate()];else return[now.getFullYear(),now.getMonth(),now.getDate()]}function makeDateFromStringAndFormat(config){config._a=[],config._pf.empty=!0;var lang=getLangDefinition(config._l),string=""+config._i,i,parsedInput,tokens,token,skipped,stringLength=string.length,totalParsedInputLength=0;for(tokens=expandFormat(config._f,lang).match(formattingTokens)||[],i=0;i<tokens.length;i++){if(token=tokens[i],parsedInput=(getParseRegexForToken(token,config).exec(string)||[])[0]){if(skipped=string.substr(0,string.indexOf(parsedInput)),skipped.length>0)config._pf.unusedInput.push(skipped);string=string.slice(string.indexOf(parsedInput)+parsedInput.length),totalParsedInputLength+=parsedInput.length}if(formatTokenFunctions[token]){if(parsedInput)config._pf.empty=!1;else config._pf.unusedTokens.push(token);addTimeToArrayFromToken(token,parsedInput,config)}else if(config._strict&&!parsedInput)config._pf.unusedTokens.push(token)}if(config._pf.charsLeftOver=stringLength-totalParsedInputLength,string.length>0)config._pf.unusedInput.push(string);if(config._isPm&&config._a[HOUR]<12)config._a[HOUR]+=12;if(config._isPm===!1&&12===config._a[HOUR])config._a[HOUR]=0;dateFromConfig(config),checkOverflow(config)}function unescapeFormat(s){return s.replace(/\\(\[)|\\(\])|\[([^\]\[]*)\]|\\(.)/g,function(matched,p1,p2,p3,p4){return p1||p2||p3||p4})}function regexpEscape(s){return s.replace(/[\-\/\\\^$*+?.()|\[\]{}]/g,"\\$&")}function makeDateFromStringAndArray(config){var tempConfig,bestMoment,scoreToBeat=1e3,i,currentScore;for(i=0;i<config._f.length;i++)if(currentScore=0,tempConfig=extend({},config),initializeParsingFlags(tempConfig),tempConfig._f=config._f[i],makeDateFromStringAndFormat(tempConfig),isValid(tempConfig)){if(currentScore+=tempConfig._pf.charsLeftOver,currentScore+=10*tempConfig._pf.unusedTokens.length,tempConfig._pf.score=currentScore,scoreToBeat>currentScore)scoreToBeat=currentScore,bestMoment=tempConfig}else;extend(config,bestMoment||tempConfig)}function makeDateFromString(config){var i,string=config._i,match=isoRegex.exec(string);if(match){for(config._f="YYYY-MM-DD"+(match[2]||" "),i=0;4>i;i++)if(isoTimes[i][1].exec(string)){config._f+=isoTimes[i][0];break}if(parseTokenTimezone.exec(string))config._f+=" Z";makeDateFromStringAndFormat(config)}else config._d=new Date(string)}function makeDateFromInput(config){var input=config._i,matched=aspNetJsonRegex.exec(input);if(input===undefined)config._d=new Date;else if(matched)config._d=new Date(+matched[1]);else if("string"==typeof input)makeDateFromString(config);else if(isArray(input))config._a=input.slice(0),dateFromConfig(config);else if(isDate(input))config._d=new Date(+input);else if("object"==typeof input)dateFromObject(config);else config._d=new Date(input)}function makeDate(y,m,d,h,M,s,ms){var date=new Date(y,m,d,h,M,s,ms);if(1970>y)date.setFullYear(y);return date}function makeUTCDate(y){var date=new Date(Date.UTC.apply(null,arguments));if(1970>y)date.setUTCFullYear(y);return date}function substituteTimeAgo(string,number,withoutSuffix,isFuture,lang){return lang.relativeTime(number||1,!!withoutSuffix,string,isFuture)}function relativeTime(milliseconds,withoutSuffix,lang){var seconds=round(Math.abs(milliseconds)/1e3),minutes=round(seconds/60),hours=round(minutes/60),days=round(hours/24),years=round(days/365),args=45>seconds&&["s",seconds]||1===minutes&&["m"]||45>minutes&&["mm",minutes]||1===hours&&["h"]||22>hours&&["hh",hours]||1===days&&["d"]||25>=days&&["dd",days]||45>=days&&["M"]||345>days&&["MM",round(days/30)]||1===years&&["y"]||["yy",years];return args[2]=withoutSuffix,args[3]=milliseconds>0,args[4]=lang,substituteTimeAgo.apply({},args)}function weekOfYear(mom,firstDayOfWeek,firstDayOfWeekOfYear){var end=firstDayOfWeekOfYear-firstDayOfWeek,daysToDayOfWeek=firstDayOfWeekOfYear-mom.day(),adjustedMoment;if(daysToDayOfWeek>end)daysToDayOfWeek-=7;if(end-7>daysToDayOfWeek)daysToDayOfWeek+=7;return adjustedMoment=moment(mom).add("d",daysToDayOfWeek),{week:Math.ceil(adjustedMoment.dayOfYear()/7),year:adjustedMoment.year()}}function makeMoment(config){var input=config._i,format=config._f;if("undefined"==typeof config._pf)initializeParsingFlags(config);if(null===input)return moment.invalid({nullInput:!0});if("string"==typeof input)config._i=input=getLangDefinition().preparse(input);if(moment.isMoment(input))config=extend({},input),config._d=new Date(+input._d);else if(format)if(isArray(format))makeDateFromStringAndArray(config);else makeDateFromStringAndFormat(config);else makeDateFromInput(config);return new Moment(config)}function makeGetterAndSetter(name,key){moment.fn[name]=moment.fn[name+"s"]=function(input){var utc=this._isUTC?"UTC":"";if(null!=input)return this._d["set"+utc+key](input),moment.updateOffset(this),this;else return this._d["get"+utc+key]()}}function makeDurationGetter(name){moment.duration.fn[name]=function(){return this._data[name]}}function makeDurationAsGetter(name,factor){moment.duration.fn["as"+name]=function(){return+this/factor}}function makeGlobal(){if("undefined"==typeof ender)this.moment=moment}for(var moment,VERSION="2.2.1",round=Math.round,i,YEAR=0,MONTH=1,DATE=2,HOUR=3,MINUTE=4,SECOND=5,MILLISECOND=6,languages={},hasModule="undefined"!=typeof module&&module.exports,aspNetJsonRegex=/^\/?Date\((\-?\d+)/i,aspNetTimeSpanJsonRegex=/(\-)?(?:(\d*)\.)?(\d+)\:(\d+)(?:\:(\d+)\.?(\d{3})?)?/,isoDurationRegex=/^(-)?P(?:(?:([0-9,.]*)Y)?(?:([0-9,.]*)M)?(?:([0-9,.]*)D)?(?:T(?:([0-9,.]*)H)?(?:([0-9,.]*)M)?(?:([0-9,.]*)S)?)?|([0-9,.]*)W)$/,formattingTokens=/(\[[^\[]*\])|(\\)?(Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|YYYYY|YYYY|YY|gg(ggg?)?|GG(GGG?)?|e|E|a|A|hh?|HH?|mm?|ss?|SS?S?|X|zz?|ZZ?|.)/g,localFormattingTokens=/(\[[^\[]*\])|(\\)?(LT|LL?L?L?|l{1,4})/g,parseTokenOneOrTwoDigits=/\d\d?/,parseTokenOneToThreeDigits=/\d{1,3}/,parseTokenThreeDigits=/\d{3}/,parseTokenFourDigits=/\d{1,4}/,parseTokenSixDigits=/[+\-]?\d{1,6}/,parseTokenWord=/[0-9]*['a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+|[\u0600-\u06FF\/]+(\s*?[\u0600-\u06FF]+){1,2}/i,parseTokenTimezone=/Z|[\+\-]\d\d:?\d\d/i,parseTokenT=/T/i,parseTokenTimestampMs=/[\+\-]?\d+(\.\d{1,3})?/,isoRegex=/^\s*\d{4}-\d\d-\d\d((T| )(\d\d(:\d\d(:\d\d(\.\d\d?\d?)?)?)?)?([\+\-]\d\d:?\d\d)?)?$/,isoFormat="YYYY-MM-DDTHH:mm:ssZ",isoTimes=[["HH:mm:ss.S",/(T| )\d\d:\d\d:\d\d\.\d{1,3}/],["HH:mm:ss",/(T| )\d\d:\d\d:\d\d/],["HH:mm",/(T| )\d\d:\d\d/],["HH",/(T| )\d\d/]],parseTimezoneChunker=/([\+\-]|\d\d)/gi,proxyGettersAndSetters="Date|Hours|Minutes|Seconds|Milliseconds".split("|"),unitMillisecondFactors={Milliseconds:1,Seconds:1e3,Minutes:6e4,Hours:36e5,Days:864e5,Months:2592e6,Years:31536e6},unitAliases={ms:"millisecond",s:"second",m:"minute",h:"hour",d:"day",w:"week",W:"isoweek",M:"month",y:"year"},formatFunctions={},ordinalizeTokens="DDD w W M D d".split(" "),paddedTokens="M D H h m s w W".split(" "),formatTokenFunctions={M:function(){return this.month()+1},MMM:function(format){return this.lang().monthsShort(this,format)},MMMM:function(format){return this.lang().months(this,format)},D:function(){return this.date()},DDD:function(){return this.dayOfYear()},d:function(){return this.day()},dd:function(format){return this.lang().weekdaysMin(this,format)},ddd:function(format){return this.lang().weekdaysShort(this,format)},dddd:function(format){return this.lang().weekdays(this,format)},w:function(){return this.week()},W:function(){return this.isoWeek()},YY:function(){return leftZeroFill(this.year()%100,2)},YYYY:function(){return leftZeroFill(this.year(),4)},YYYYY:function(){return leftZeroFill(this.year(),5)},gg:function(){return leftZeroFill(this.weekYear()%100,2)},gggg:function(){return this.weekYear()},ggggg:function(){return leftZeroFill(this.weekYear(),5)},GG:function(){return leftZeroFill(this.isoWeekYear()%100,2)},GGGG:function(){return this.isoWeekYear()},GGGGG:function(){return leftZeroFill(this.isoWeekYear(),5)},e:function(){return this.weekday()},E:function(){return this.isoWeekday()},a:function(){return this.lang().meridiem(this.hours(),this.minutes(),!0)},A:function(){return this.lang().meridiem(this.hours(),this.minutes(),!1)},H:function(){return this.hours()},h:function(){return this.hours()%12||12},m:function(){return this.minutes()},s:function(){return this.seconds()},S:function(){return toInt(this.milliseconds()/100)},SS:function(){return leftZeroFill(toInt(this.milliseconds()/10),2)},SSS:function(){return leftZeroFill(this.milliseconds(),3)},Z:function(){var a=-this.zone(),b="+";if(0>a)a=-a,b="-";return b+leftZeroFill(toInt(a/60),2)+":"+leftZeroFill(toInt(a)%60,2)},ZZ:function(){var a=-this.zone(),b="+";if(0>a)a=-a,b="-";return b+leftZeroFill(toInt(10*a/6),4)},z:function(){return this.zoneAbbr()},zz:function(){return this.zoneName()},X:function(){return this.unix()}},lists=["months","monthsShort","weekdays","weekdaysShort","weekdaysMin"];ordinalizeTokens.length;)i=ordinalizeTokens.pop(),formatTokenFunctions[i+"o"]=ordinalizeToken(formatTokenFunctions[i],i);for(;paddedTokens.length;)i=paddedTokens.pop(),formatTokenFunctions[i+i]=padToken(formatTokenFunctions[i],2);for(formatTokenFunctions.DDDD=padToken(formatTokenFunctions.DDD,3),extend(Language.prototype,{set:function(config){var prop,i;for(i in config)if(prop=config[i],"function"==typeof prop)this[i]=prop;else this["_"+i]=prop},_months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),months:function(m){return this._months[m.month()]},_monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),monthsShort:function(m){return this._monthsShort[m.month()]},monthsParse:function(monthName){var i,mom,regex;if(!this._monthsParse)this._monthsParse=[];for(i=0;12>i;i++){if(!this._monthsParse[i])mom=moment.utc([2e3,i]),regex="^"+this.months(mom,"")+"|^"+this.monthsShort(mom,""),this._monthsParse[i]=new RegExp(regex.replace(".",""),"i");if(this._monthsParse[i].test(monthName))return i}},_weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdays:function(m){return this._weekdays[m.day()]},_weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysShort:function(m){return this._weekdaysShort[m.day()]},_weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),weekdaysMin:function(m){return this._weekdaysMin[m.day()]},weekdaysParse:function(weekdayName){var i,mom,regex;if(!this._weekdaysParse)this._weekdaysParse=[];for(i=0;7>i;i++){if(!this._weekdaysParse[i])mom=moment([2e3,1]).day(i),regex="^"+this.weekdays(mom,"")+"|^"+this.weekdaysShort(mom,"")+"|^"+this.weekdaysMin(mom,""),this._weekdaysParse[i]=new RegExp(regex.replace(".",""),"i");if(this._weekdaysParse[i].test(weekdayName))return i}},_longDateFormat:{LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D YYYY",LLL:"MMMM D YYYY LT",LLLL:"dddd, MMMM D YYYY LT"},longDateFormat:function(key){var output=this._longDateFormat[key];if(!output&&this._longDateFormat[key.toUpperCase()])output=this._longDateFormat[key.toUpperCase()].replace(/MMMM|MM|DD|dddd/g,function(val){return val.slice(1)}),this._longDateFormat[key]=output;return output},isPM:function(input){return"p"===(input+"").toLowerCase().charAt(0)},_meridiemParse:/[ap]\.?m?\.?/i,meridiem:function(hours,minutes,isLower){if(hours>11)return isLower?"pm":"PM";else return isLower?"am":"AM"},_calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},calendar:function(key,mom){var output=this._calendar[key];return"function"==typeof output?output.apply(mom):output},_relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},relativeTime:function(number,withoutSuffix,string,isFuture){var output=this._relativeTime[string];return"function"==typeof output?output(number,withoutSuffix,string,isFuture):output.replace(/%d/i,number)},pastFuture:function(diff,output){var format=this._relativeTime[diff>0?"future":"past"];return"function"==typeof format?format(output):format.replace(/%s/i,output)},ordinal:function(number){return this._ordinal.replace("%d",number)},_ordinal:"%d",preparse:function(string){return string},postformat:function(string){return string},week:function(mom){return weekOfYear(mom,this._week.dow,this._week.doy).week},_week:{dow:0,doy:6},_invalidDate:"Invalid date",invalidDate:function(){return this._invalidDate}}),moment=function(input,format,lang,strict){if("boolean"==typeof lang)strict=lang,lang=undefined;return makeMoment({_i:input,_f:format,_l:lang,_strict:strict,_isUTC:!1})},moment.utc=function(input,format,lang,strict){var m;if("boolean"==typeof lang)strict=lang,lang=undefined;return m=makeMoment({_useUTC:!0,_isUTC:!0,_l:lang,_i:input,_f:format,_strict:strict}).utc()},moment.unix=function(input){return moment(1e3*input)},moment.duration=function(input,key){var isDuration=moment.isDuration(input),isNumber="number"==typeof input,duration=isDuration?input._input:isNumber?{}:input,match=null,sign,ret,parseIso,timeEmpty,dateTimeEmpty;if(isNumber)if(key)duration[key]=input;else duration.milliseconds=input;else if(match=aspNetTimeSpanJsonRegex.exec(input))sign="-"===match[1]?-1:1,duration={y:0,d:toInt(match[DATE])*sign,h:toInt(match[HOUR])*sign,m:toInt(match[MINUTE])*sign,s:toInt(match[SECOND])*sign,ms:toInt(match[MILLISECOND])*sign};else if(match=isoDurationRegex.exec(input))sign="-"===match[1]?-1:1,parseIso=function(inp){var res=inp&&parseFloat(inp.replace(",","."));return(isNaN(res)?0:res)*sign},duration={y:parseIso(match[2]),M:parseIso(match[3]),d:parseIso(match[4]),h:parseIso(match[5]),m:parseIso(match[6]),s:parseIso(match[7]),w:parseIso(match[8])};if(ret=new Duration(duration),isDuration&&input.hasOwnProperty("_lang"))ret._lang=input._lang;return ret},moment.version=VERSION,moment.defaultFormat=isoFormat,moment.updateOffset=function(){},moment.lang=function(key,values){var r;if(!key)return moment.fn._lang._abbr;if(values)loadLang(normalizeLanguage(key),values);else if(null===values)unloadLang(key),key="en";else if(!languages[key])getLangDefinition(key);return r=moment.duration.fn._lang=moment.fn._lang=getLangDefinition(key),r._abbr},moment.langData=function(key){if(key&&key._lang&&key._lang._abbr)key=key._lang._abbr;return getLangDefinition(key)},moment.isMoment=function(obj){return obj instanceof Moment},moment.isDuration=function(obj){return obj instanceof Duration},i=lists.length-1;i>=0;--i)makeList(lists[i]);for(moment.normalizeUnits=function(units){return normalizeUnits(units)},moment.invalid=function(flags){var m=moment.utc(0/0);if(null!=flags)extend(m._pf,flags);else m._pf.userInvalidated=!0;return m},moment.parseZone=function(input){return moment(input).parseZone()},extend(moment.fn=Moment.prototype,{clone:function(){return moment(this)},valueOf:function(){return+this._d+6e4*(this._offset||0)},unix:function(){return Math.floor(+this/1e3)},toString:function(){return this.clone().lang("en").format("ddd MMM DD YYYY HH:mm:ss [GMT]ZZ")},toDate:function(){return this._offset?new Date(+this):this._d},toISOString:function(){return formatMoment(moment(this).utc(),"YYYY-MM-DD[T]HH:mm:ss.SSS[Z]")},toArray:function(){var m=this;return[m.year(),m.month(),m.date(),m.hours(),m.minutes(),m.seconds(),m.milliseconds()]},isValid:function(){return isValid(this)},isDSTShifted:function(){if(this._a)return this.isValid()&&compareArrays(this._a,(this._isUTC?moment.utc(this._a):moment(this._a)).toArray())>0;else return!1},parsingFlags:function(){return extend({},this._pf)},invalidAt:function(){return this._pf.overflow},utc:function(){return this.zone(0)},local:function(){return this.zone(0),this._isUTC=!1,this},format:function(inputString){var output=formatMoment(this,inputString||moment.defaultFormat);return this.lang().postformat(output)},add:function(input,val){var dur;if("string"==typeof input)dur=moment.duration(+val,input);else dur=moment.duration(input,val);return addOrSubtractDurationFromMoment(this,dur,1),this},subtract:function(input,val){var dur;if("string"==typeof input)dur=moment.duration(+val,input);else dur=moment.duration(input,val);return addOrSubtractDurationFromMoment(this,dur,-1),this},diff:function(input,units,asFloat){var that=this._isUTC?moment(input).zone(this._offset||0):moment(input).local(),zoneDiff=6e4*(this.zone()-that.zone()),diff,output;if(units=normalizeUnits(units),"year"===units||"month"===units){if(diff=432e5*(this.daysInMonth()+that.daysInMonth()),output=12*(this.year()-that.year())+(this.month()-that.month()),output+=(this-moment(this).startOf("month")-(that-moment(that).startOf("month")))/diff,output-=6e4*(this.zone()-moment(this).startOf("month").zone()-(that.zone()-moment(that).startOf("month").zone()))/diff,"year"===units)output/=12}else diff=this-that,output="second"===units?diff/1e3:"minute"===units?diff/6e4:"hour"===units?diff/36e5:"day"===units?(diff-zoneDiff)/864e5:"week"===units?(diff-zoneDiff)/6048e5:diff;return asFloat?output:absRound(output)},from:function(time,withoutSuffix){return moment.duration(this.diff(time)).lang(this.lang()._abbr).humanize(!withoutSuffix)},fromNow:function(withoutSuffix){return this.from(moment(),withoutSuffix)},calendar:function(){var diff=this.diff(moment().zone(this.zone()).startOf("day"),"days",!0),format=-6>diff?"sameElse":-1>diff?"lastWeek":0>diff?"lastDay":1>diff?"sameDay":2>diff?"nextDay":7>diff?"nextWeek":"sameElse";return this.format(this.lang().calendar(format,this))},isLeapYear:function(){return isLeapYear(this.year())},isDST:function(){return this.zone()<this.clone().month(0).zone()||this.zone()<this.clone().month(5).zone()},day:function(input){var day=this._isUTC?this._d.getUTCDay():this._d.getDay();if(null!=input){if("string"==typeof input)if(input=this.lang().weekdaysParse(input),"number"!=typeof input)return this;return this.add({d:input-day})}else return day},month:function(input){var utc=this._isUTC?"UTC":"",dayOfMonth;if(null!=input){if("string"==typeof input)if(input=this.lang().monthsParse(input),"number"!=typeof input)return this;return dayOfMonth=this.date(),this.date(1),this._d["set"+utc+"Month"](input),this.date(Math.min(dayOfMonth,this.daysInMonth())),moment.updateOffset(this),this}else return this._d["get"+utc+"Month"]()},startOf:function(units){switch(units=normalizeUnits(units)){case"year":this.month(0);case"month":this.date(1);case"week":case"isoweek":case"day":this.hours(0);case"hour":this.minutes(0);case"minute":this.seconds(0);case"second":this.milliseconds(0)}if("week"===units)this.weekday(0);else if("isoweek"===units)this.isoWeekday(1);return this},endOf:function(units){return units=normalizeUnits(units),this.startOf(units).add("isoweek"===units?"week":units,1).subtract("ms",1)},isAfter:function(input,units){return units="undefined"!=typeof units?units:"millisecond",+this.clone().startOf(units)>+moment(input).startOf(units)},isBefore:function(input,units){return units="undefined"!=typeof units?units:"millisecond",+this.clone().startOf(units)<+moment(input).startOf(units)},isSame:function(input,units){return units="undefined"!=typeof units?units:"millisecond",+this.clone().startOf(units)===+moment(input).startOf(units)},min:function(other){return other=moment.apply(null,arguments),this>other?this:other},max:function(other){return other=moment.apply(null,arguments),other>this?this:other},zone:function(input){var offset=this._offset||0;if(null!=input){if("string"==typeof input)input=timezoneMinutesFromString(input);if(Math.abs(input)<16)input=60*input;if(this._offset=input,this._isUTC=!0,offset!==input)addOrSubtractDurationFromMoment(this,moment.duration(offset-input,"m"),1,!0)}else return this._isUTC?offset:this._d.getTimezoneOffset();return this},zoneAbbr:function(){return this._isUTC?"UTC":""},zoneName:function(){return this._isUTC?"Coordinated Universal Time":""},parseZone:function(){if("string"==typeof this._i)this.zone(this._i);return this},hasAlignedHourOffset:function(input){if(!input)input=0;else input=moment(input).zone();return(this.zone()-input)%60===0},daysInMonth:function(){return daysInMonth(this.year(),this.month())},dayOfYear:function(input){var dayOfYear=round((moment(this).startOf("day")-moment(this).startOf("year"))/864e5)+1;return null==input?dayOfYear:this.add("d",input-dayOfYear)},weekYear:function(input){var year=weekOfYear(this,this.lang()._week.dow,this.lang()._week.doy).year;return null==input?year:this.add("y",input-year)},isoWeekYear:function(input){var year=weekOfYear(this,1,4).year;return null==input?year:this.add("y",input-year)},week:function(input){var week=this.lang().week(this);return null==input?week:this.add("d",7*(input-week))},isoWeek:function(input){var week=weekOfYear(this,1,4).week;return null==input?week:this.add("d",7*(input-week))},weekday:function(input){var weekday=(this.day()+7-this.lang()._week.dow)%7;return null==input?weekday:this.add("d",input-weekday)},isoWeekday:function(input){return null==input?this.day()||7:this.day(this.day()%7?input:input-7)},get:function(units){return units=normalizeUnits(units),this[units.toLowerCase()]()},set:function(units,value){return units=normalizeUnits(units),this[units.toLowerCase()](value),this},lang:function(key){if(key===undefined)return this._lang;else return this._lang=getLangDefinition(key),this}}),i=0;i<proxyGettersAndSetters.length;i++)makeGetterAndSetter(proxyGettersAndSetters[i].toLowerCase().replace(/s$/,""),proxyGettersAndSetters[i]);makeGetterAndSetter("year","FullYear"),moment.fn.days=moment.fn.day,moment.fn.months=moment.fn.month,moment.fn.weeks=moment.fn.week,moment.fn.isoWeeks=moment.fn.isoWeek,moment.fn.toJSON=moment.fn.toISOString,extend(moment.duration.fn=Duration.prototype,{_bubble:function(){var milliseconds=this._milliseconds,days=this._days,months=this._months,data=this._data,seconds,minutes,hours,years;data.milliseconds=milliseconds%1e3,seconds=absRound(milliseconds/1e3),data.seconds=seconds%60,minutes=absRound(seconds/60),data.minutes=minutes%60,hours=absRound(minutes/60),data.hours=hours%24,days+=absRound(hours/24),data.days=days%30,months+=absRound(days/30),data.months=months%12,years=absRound(months/12),data.years=years},weeks:function(){return absRound(this.days()/7)},valueOf:function(){return this._milliseconds+864e5*this._days+this._months%12*2592e6+31536e6*toInt(this._months/12)},humanize:function(withSuffix){var difference=+this,output=relativeTime(difference,!withSuffix,this.lang());if(withSuffix)output=this.lang().pastFuture(difference,output);return this.lang().postformat(output)},add:function(input,val){var dur=moment.duration(input,val);
return this._milliseconds+=dur._milliseconds,this._days+=dur._days,this._months+=dur._months,this._bubble(),this},subtract:function(input,val){var dur=moment.duration(input,val);return this._milliseconds-=dur._milliseconds,this._days-=dur._days,this._months-=dur._months,this._bubble(),this},get:function(units){return units=normalizeUnits(units),this[units.toLowerCase()+"s"]()},as:function(units){return units=normalizeUnits(units),this["as"+units.charAt(0).toUpperCase()+units.slice(1)+"s"]()},lang:moment.fn.lang,toIsoString:function(){var years=Math.abs(this.years()),months=Math.abs(this.months()),days=Math.abs(this.days()),hours=Math.abs(this.hours()),minutes=Math.abs(this.minutes()),seconds=Math.abs(this.seconds()+this.milliseconds()/1e3);if(!this.asSeconds())return"P0D";else return(this.asSeconds()<0?"-":"")+"P"+(years?years+"Y":"")+(months?months+"M":"")+(days?days+"D":"")+(hours||minutes||seconds?"T":"")+(hours?hours+"H":"")+(minutes?minutes+"M":"")+(seconds?seconds+"S":"")}});for(i in unitMillisecondFactors)if(unitMillisecondFactors.hasOwnProperty(i))makeDurationAsGetter(i,unitMillisecondFactors[i]),makeDurationGetter(i.toLowerCase());if(makeDurationAsGetter("Weeks",6048e5),moment.duration.fn.asMonths=function(){return(+this-31536e6*this.years())/2592e6+12*this.years()},moment.lang("en",{ordinal:function(number){var b=number%10,output=1===toInt(number%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th";return number+output}}),hasModule)module.exports=moment,makeGlobal();else if("function"==typeof define&&define.amd)define("js/lib/moment",[],function(){return moment});else makeGlobal()}).call(this),!function(wndw){var cookie=function($){var cookie=function(key,value,options){if(arguments.length>1&&(!/Object/.test(Object.prototype.toString.call(value))||null===value||void 0===value)){if(options=$.extend({},options),null===value||void 0===value)options.expires=-1;if(!options.path)options.path="/";if("number"==typeof options.expires){var days=options.expires,t=options.expires=new Date;t.setDate(t.getDate()+days)}return value=String(value),wndw.document.cookie=[encodeURIComponent(key),"=",options.raw?value:encodeURIComponent(value),options.expires?"; expires="+options.expires.toUTCString():"",options.path?"; path="+options.path:"",options.domain?"; domain="+options.domain:"",options.secure?"; secure":""].join("")}options=value||{};for(var decode=options.raw?function(s){return s}:decodeURIComponent,pairs=wndw.document.cookie.split("; "),i=0,pair;pairs[i];i++)if(pair=pairs[i].split("="),decode(pair[0])===key)return decode(pair[1]||"");return null};return{get:cookie,set:cookie,clear:function(key,options){for(var cookies=wndw.document.cookie.split("; "),i=0;i<cookies.length;i++){var equals=cookies[i].indexOf("="),name=equals>-1?cookies[i].substr(0,equals):cookies[i];if(!key||key==name)cookie(name,null,options)}}}};if("function"==typeof define&&define.amd)define("js/lib/cookie",["jquery"],function($){return cookie($)});else if("undefined"!=typeof wndw&&"undefined"==typeof ender)wndw.Cookie=cookie(wndw.$)}(window),!function(factory){if("function"==typeof define&&define.amd)define("js/lib/lucid",factory);else if(("object"==typeof module||"function"==typeof module)&&module.exports)module.exports=factory();else window.LucidJS=factory()}(function(){function EventEmitter(object){function on(event){function clear(){if(listeners[event]){for(aI=0;aI<args.length;aI+=1)listeners[event].splice(listeners[event].indexOf(args[aI]),1);if(listeners[event].length<1)delete listeners[event]}}function batchOn(events,args){function clear(){var bI;for(bI=0;bI<bindings.length;bI+=1)bindings[bI].clear()}var eI,binding={},bindings=[];for(eI=0;eI<events.length;eI+=1)args.unshift(events[eI]),bindings.push(on.apply(this,args)),args.shift();return binding.clear=clear,binding}var args=Array.prototype.slice.apply(arguments,[1]),binding={},aI,sI;if("object"==typeof event&&"function"==typeof event.push)return batchOn(event,args);if("emitter"!==event.slice(0,7))trigger("emitter.listener",event,args);if(setEvents[event]){for(aI=0;aI<args.length;aI+=1){if("function"!=typeof args[aI])throw new Error("Cannot bind event. All callbacks must be functions.");for(sI=0;sI<setEvents[event].length;sI+=1)args[aI].apply(this,setEvents[event][sI])}return binding.clear=function(){},binding}if(!listeners[event])listeners[event]=[];for(aI=0;aI<args.length;aI+=1){if("function"!=typeof args[aI])throw new Error("Cannot bind event. All callbacks must be functions.");listeners[event].push(args[aI])}return binding.clear=clear,binding}function off(event){var args=Array.prototype.slice.apply(arguments,[1]),aI,sI;if("object"!=typeof event||"function"!=typeof event.push){if(!listeners[event])throw new Error('Tried to remove an event from a non-existant event of type "'+event+'".');for(aI=0;aI<args.length;aI+=1){if("function"!=typeof args[aI])throw new Error("Tried to remove a non-function.");var listenerIndex=listeners[event].indexOf(args[aI]);listeners[event].splice(listenerIndex,1)}}else for(sI=0;sI<event.length;sI+=1)off.apply(null,[event[sI]].concat(args))}function once(event){var binding,args=Array.prototype.slice.apply(arguments,[1]),result=!0;return binding=on(event,function(){var aI,eventArgs=Array.prototype.slice.apply(arguments);for(binding.clear(),aI=0;aI<args.length;aI+=1)if(args[aI].apply(this,eventArgs)===!1)result=!1;return result})}function trigger(event,a1,a2,a3,a4,la){function batchTrigger(events,a1,a2,a3,a4,la){var eI,result=!0;if("undefined"!=typeof la)longArgs=Array.prototype.slice.apply(arguments,[1]);for(eI=0;eI<events.length;eI+=1)if(longArgs){if(args.unshift(events[eI]),trigger.apply(this,args)===!1)result=!1;args.shift()}else if(trigger(events[eI],a1,a2,a3,a4)===!1)result=!1;return result}var longArgs,lI,eventListeners,result=!0;if("undefined"!=typeof la)longArgs=Array.prototype.slice.apply(arguments,[1]);if("object"==typeof event&&"function"==typeof event.push)if(longArgs)return batchTrigger.apply(null,arguments);else return batchTrigger(event,a1,a2,a3,a4);for(event=event.split(".");event.length;){if(eventListeners=listeners[event.join(".")],"emitter"!==event[0])if(longArgs)trigger.apply(this,[].concat("emitter.event",event.join("."),longArgs));else trigger("emitter.event",a1,a2,a3,a4);if(eventListeners)for(eventListeners=[].concat(eventListeners),lI=0;lI<eventListeners.length;lI+=1)if(longArgs){if(eventListeners[lI].apply(this,longArgs)===!1)result=!1}else if(eventListeners[lI](a1,a2,a3,a4)===!1)result=!1;event.pop()}return result}function set(event){function batchSet(events,args){var eI,result=!0;for(eI=0;eI<events.length;eI+=1){if(args.unshift(events[eI]),trigger.apply(this,args)===!1)result=!1;args.shift()}return result}function clear(){if(setEvents[event])if(setEvents[event].splice(setEvents[event].indexOf(args),1),setEvents[event].length<1)delete setEvents[event]}var args=Array.prototype.slice.apply(arguments),setEvent={};if("object"==typeof event&&"function"==typeof event.push)return batchSet(event,args);if(trigger.apply(this,args),clearListeners(event),!setEvents[event])setEvents[event]=[];return setEvents[event].push(args.slice(1)),setEvent.clear=clear,setEvent}function clearSet(event){if(event)delete setEvents[event];else setEvents={}}function pipe(event){function captureListener(connection,emitter){connection.listenerBinding=on("emitter.listener",function(event){if(-1===connection.events.indexOf(event))connection.bindings.push(captureEvent(emitter,event)),connection.events.push(event)})}function captureEvent(emitter,event){return emitter.on(event,function(){var args=Array.prototype.slice.apply(arguments);return args.unshift(event),trigger.apply(this,args)})}function clearBatch(){if(bindings.length)for(;bindings.length;)bindings[0].clear(),bindings.splice(0,1)}function clear(){for(;connections.length;){if(connections[0].listenerBinding)connections[0].listenerBinding.clear();for(;connections[0].bindings.length;)connections[0].bindings[0].clear(),connections[0].bindings.splice(0,1);pipes.splice(pipes.indexOf(connections[0]),1),connections.splice(0,1)}}var api={},args=Array.prototype.slice.apply(arguments),eI,aI,pI,connections=[],connection,bindings=[],binding;if("object"==typeof event&&"function"==typeof event.push&&"string"==typeof event[0]){for(eI=0;eI<event.length;eI+=1)bindings.push(pipe.apply(null,[event[eI]].concat(args)));return api.clear=clearBatch,api}if("object"==typeof event&&"function"==typeof event.on)event=!1;else args.shift();if(event!==!1&&"string"!=typeof event)throw new Error("Cannot create pipe. The first argument must be an event string or an emitter.");for(aI=0;aI<args.length;aI+=1){for(pI=0;pI<pipes.length;pI+=1)if(pipes[pI].emitter===args[aI]){connection=pipes[pI];break}if(!connection||2!==connection.type){if(!connection)if(connection={},connection.emitter=args[aI],connection.bindings=[],connection.events=[],event)connection.type=1;else connection.type=2;if(-1===connection.events.indexOf(event)){if(connection.events.push(event),1===connection.type)binding=captureEvent(args[aI],event),binding.event=event,connection.bindings.push(binding);else if(2===connection.type){for(event in listeners)if(listeners.hasOwnProperty(event))binding=args[aI].on(event,captureEvent),binding.event=event,connection.bindings.push(binding),connection.events.push(event);else;captureListener(connection,args[aI])}connections.push(connection),pipes.push(connection)}else;}else;}return api.clear=clear,api}function clearPipes(event){var pI,bI,binding;for(pI=0;pI<pipes.length;pI+=1){if(event){if(2===pipes[pI].type)continue;if(-1===pipes[pI].events.indexOf(event))continue;pipes[pI].events.splice(pipes[pI].events.indexOf(event),1)}if(2===pipes[pI].type)pipes[pI].listenerBinding.clear();for(bI=0;bI<pipes[pI].bindings.length;bI+=1)if(!event||pipes[pI].bindings[bI].event===event)pipes[pI].bindings[bI].clear(),pipes[pI].bindings.splice(bI,1),bI-=1;else;if(pipes[pI].bindings.length<1)pipes.splice(pI,1),pI-=1}}function getListeners(event){if(event)return listeners[event];else return listeners}function clearListeners(event){if(event)delete listeners[event];else listeners={}}function clear(){trigger("emitter.clear"),listeners={},setEvents={},pipes={},delete emitter.on,delete emitter.once,delete emitter.trigger,delete emitter.set,delete emitter.pipe,delete emitter.listeners,delete emitter.clear}function handleNode(node){function clearNodeEmitter(){var DI;for(DI=0;DI<DOMEventListeners.length;DI+=1)try{if(node.removeEventListener)node.removeEventListener(DOMEventListeners[DI].event,DOMEventListeners[DI].listener,!1);else if(node.detachEvent)node.detachEvent("on"+DOMEventListeners[DI].event,DOMEventListeners[DI].listener)}catch(e){console.error(e)}handledEvents=[],listenerBinding.clear()}var handledEvents=[],listenerBinding,DOMEventListeners=[];listenerBinding=on("emitter.listener",function(event){function nodeListener(eventObj){var args=Array.prototype.slice.apply(arguments);if(args.unshift([event,"dom."+event]),trigger.apply(this,args)===!1)eventObj.preventDefault(),eventObj.stopPropagation()}if(!(handledEvents.indexOf(event)>-1)){handledEvents.push(event);try{if(node.addEventListener)node.addEventListener(event,nodeListener,!1),DOMEventListeners.push({event:event,listener:nodeListener});else if(node.attachEvent)node.attachEvent("on"+event,nodeListener),DOMEventListeners.push({event:event,listener:nodeListener})}catch(e){console.error(e)}}}),emitter.clearNodeEmitter=clearNodeEmitter}var emitter=object||{},listeners={},setEvents={},pipes=[];if(!(emitter.on||emitter.once||emitter.trigger||emitter.set||emitter.pipe||emitter.listeners))emitter.on=on,emitter.off=off,emitter.once=once,emitter.trigger=trigger,emitter.set=set,emitter.set.clear=clearSet,emitter.pipe=pipe,emitter.pipe.clear=clearPipes,emitter.listeners=getListeners,emitter.listeners.clear=clearListeners;else return emitter;if(emitter.addEventListener||emitter.attachEvent)handleNode(emitter);return emitter}var api;return api={emitter:EventEmitter},[].indexOf||(Array.prototype.indexOf=function(a,b,c){for(c=this.length,b=(c+~~b)%c;c>b&&(!(b in this)||this[b]!==a);b++);return b^c?b:-1}),api}),!function(){var DataAttributes=function($){var parse=function(el,defaults,_prefix){var settings={},prefix=_prefix||"";for(var key in defaults){var pkey=prefix+key.replace(/\./g,"-"),attr=$(el).attr(pkey);if(void 0===attr)settings[key]=defaults[key];else if("string"==typeof attr&&0===attr.length||/^\s*true\s*$/.test(attr)||pkey==attr)settings[key]=!0;else if(/^\s*false\s*$/.test(attr))settings[key]=!1;else settings[key]=attr}return settings},exports={parse:parse};return exports};if("function"==typeof define&&define.amd)define("js/lib/data.attributes",["jquery"],function($){return DataAttributes($)});else if("undefined"!=typeof window&&"undefined"==typeof ender)window.DataAttributes=DataAttributes(window.$)}(),!function(){var Modals=function($,LucidJS,_,DataAttributes){var CLOSED=0,OPEN=1,_private={defaults:{"bind.open":"click","bind.close":"click","bind.action":"click","attribute.open":"data-modal","attribute.close":"data-modal-close","attribute.iframe":"data-modal-iframe","attribute.action":"data-modal-action","attribute.focus":"data-modal-focus","attribute.focus.index":1e4,"animate.modal.open":null,"animate.modal.close":null,"animate.modal.duration":250,"animate.overlay.open":null,"animate.overlay.close":null,"animate.overlay.duration":250,"overlay.show":!0,"overlay.class":"overlay","overlay.close":!0,"z.index":9999,"position.top":"50%","position.left":"50%",position:"fixed","iframe.autoclose":!0},$overlay:null,count:0,prevScroll:null,prevModal:null,getModal:function(el,options){var modal=$(el).data("modal.me");if(modal&&modal.constructor==Modal.prototype.constructor)if(options)return modal.customize(options);else return modal;else return null},makeModal:function(el,options){var $el=$(el),modal=_private.getModal($el);if(!modal)modal=new Modal($el,options),$el.data("modal.me",modal);return modal},setOverlayHeight:function(){if($(window).height()<$(document).height())_private.$overlay.css({height:$(document).height()+"px"});else _private.$overlay.css({height:"100%"})},observeKeyPress:function(e){if(this.options["overlay.close"])if(27==e.keyCode||27==e.DOM_VK_ESCAPE&&0===e.which)this.emitter.trigger("action",!1,this),this.close();this.emitter.trigger("key",e)},cycleTabs:function(e){var $tabbable=this.$el.find("a,input,select,textarea,button").filter(":visible");if(9==e.keyCode&&$(e.target).is($tabbable.last()))window.setTimeout(function(){$tabbable.first().focus()},0)},actionTrigger:function(e){var $el=$(e.currentTarget),action=$el.attr(this.options["attribute.action"]);this.emitter.trigger("action",action,this)},open:function(){if("fixed"!=this.options.position)_private.prevScroll={top:$(document).scrollTop(),left:$(document).scrollLeft()},window.scrollTo(0,0);if(this.$iframe){var iframeUrl=this.options["iframe.url"]||$(this.anchor).attr(this.options["attribute.iframe"]);this.$iframe.attr("src",iframeUrl),this.$iframe.focus()}else{var $focus=this.$el.find("["+this.options["attribute.focus"]+"]"),$focusable_elements=this.$el.find("a,input,select,textarea,button");for(i=0;i<$focusable_elements.length;i++)$focusable_elements.eq(i).attr("tabindex",this.options["attribute.focus.index"]+1+i);if($focus.size()>0)$focus.filter(":visible").eq(0).attr("tabindex",this.options["attribute.focus.index"]),$focus.filter(":visible").eq(0).focus();else if($focusable_elements.size()>0)$focusable_elements.filter(":visible").eq(0).attr("tabindex",this.options["attribute.focus.index"]),$focusable_elements.filter(":visible").eq(0).focus()}this.state=OPEN,this.$el.on(this.options["bind.action"],"["+this.options["attribute.action"]+"]",_.bind(_private.actionTrigger,this)),this.emitter.trigger("open")},close:function(){var $iframe=this.$el.find("iframe");if(this.$el.off(".modal").hide(),this.options["iframe.autoclose"]&&$iframe.size())$iframe.attr({src:"about:blank"});if(_private.prevScroll)window.scrollTo(_private.prevScroll.left,_private.prevScroll.top),_private.prevScroll=null;this.anchor=null,this.$parent.append(this.$el),this.state=CLOSED,this.emitter.trigger("close")}},Modal=function(el,settings){var that=this;this.$el=$(el),this.state=CLOSED,this.$parent=this.$el.parent(),this.customize(settings),this.emitter=LucidJS.emitter(this)};Modal.prototype.customize=function(settings){return this.options=_.extend({},DataAttributes.parse(this.$el,_private.defaults,"data-modal-"),settings),this},Modal.prototype.open=function(){var that=this,iframeUrl;if(this.anchor)iframeUrl=$(this.anchor).attr(this.options["attribute.iframe"]);if(this.options["iframe.url"])iframeUrl=this.options["iframe.url"];if(iframeUrl)if(this.$iframe=this.$el.find("iframe"),/^https?:\/\/|^\/|^\.\.\//.test(iframeUrl))if(!this.$iframe.size()||this.$iframe.attr("src")!=iframeUrl)if(this.$iframe.attr("src","about:blank").remove(),this.$iframe=$("<iframe>").css({height:"100%",width:"100%"}).attr({scrolling:"no",frameborder:0}),this.$el.append(this.$iframe),this.state!=CLOSED)this.$iframe.attr("src",iframeUrl);if(this.state==CLOSED){if(this.options["overlay.show"]){if(_private.$overlay&&"none"!=_private.$overlay.css("display")&&_private.$overlay.hasClass(this.options["overlay.class"]))this.$overlay=_private.$overlay;else{if(_private.$overlay)_private.$overlay.off(".modal").hide().remove();this.$overlay=_private.$overlay=$("<div>").addClass(this.options["overlay.class"]).hide(),this.$overlay.css({position:"fixed",width:"100%",top:0,left:0,right:0,bottom:0,zIndex:this.options["z.index"]++}),$("body").append(this.$overlay)}if(_private.setOverlayHeight(),this.reposition(),this.options["animate.overlay.open"])this.$overlay.animate(this.options["animate.overlay.open"],{duration:this.options["animate.overlay.duration"]});else this.$overlay.show();_private.count++,this.$overlay.data("modal",this)}if(this.emitter.trigger("opening"),"fixed"!=this.options.position||0===this.$el.closest("html").length)this.$el.appendTo("body");if(this.reposition(),this.$el.show(),this.options["animate.modal.open"])this.$el.animate(this.options["animate.modal.open"],{duration:this.options["animate.modal.duration"],complete:function(){_private.open.call(that)}});else _private.open.call(this);if($(window).on("resize.modal",_.bind(_private.setOverlayHeight,that)).on("resize.modal",_.bind(that.reposition,that)).on("scroll.modal",_.bind(that.reposition,that)),this.$el.on("keydown.modal",_.bind(_private.cycleTabs,that)),$(window).on("keyup.modal",_.bind(_private.observeKeyPress,that)),this.options["overlay.close"])this.$overlay.on(this.options["bind.close"]+".modal",function(e){that.emitter.trigger("action",!1,that),that.close()});if(this.options["attribute.close"])this.$el.on(this.options["bind.close"]+".modal","["+this.options["attribute.close"]+"]",function(e){var $target=$(e.currentTarget);if("disabled"!=$target.attr("disabled")){if(void 0===$target.attr(that.options["attribute.action"]))that.emitter.trigger("action",!1,that);that.close()}});return this}},Modal.prototype.reposition=function(){var left=this.options["position.left"],top=this.options["position.top"];if(left)this.$el.css({position:this.options.position,left:left,marginLeft:/%/.test(left)?this.$el.outerWidth()/2*-1:0,zIndex:this.options["z.index"]++});if(top)this.$el.css({position:this.options.position,top:top,marginTop:/%/.test(top)?this.$el.outerHeight()/2*-1:0,zIndex:this.options["z.index"]++});return this},Modal.prototype.close=function(){var that=this;if(this.state==OPEN)if(this.trigger("closeRequest")!==!1){if(this.$el.off(".modal"),$(window).off(".modal"),this.emitter.trigger("closing"),this.options["animate.modal.close"])this.$el.animate(this.options["animate.modal.close"],{duration:this.options["animate.modal.duration"],complete:function(){_private.close.call(that)}});else _private.close.call(this);if(0===--_private.count)if(this.options["overlay.show"]&&this.$overlay)if(this.$overlay.off(".modal"),this.options["animate.overlay.close"])this.$overlay.animate(this.options["animate.overlay.close"],{duration:this.options["animate.overlay.duration"],complete:function(){this.$overlay.hide().remove()}});else this.$overlay.hide().remove();return this}};var external=function(){return _private.getModal.apply(null,arguments)||_private.makeModal.apply(this,arguments)};return external.start=function(view,_options){var $view=$(view),options=_.extend({},_private.defaults,_options);if(!$view.data("modals-initialized"))$view.data("modals-initialized",1),$view.on(options["bind.open"]+".modal","["+options["attribute.open"]+"]",function(e){var $anchor=$(this),selector=$anchor.attr(options["attribute.open"]),$modal=$view.find(selector);options=_.extend({},options,DataAttributes.parse($modal,_private.defaults,"data-modal-"));var modal=_private.getModal($modal,options)||_private.makeModal($modal,options);if(/^https?:\/\/|^\/|^\.\.\//.test($anchor.attr("href"))&&!e.ctrlKey&&!e.metaKey)e.preventDefault();modal.anchor=this,_private.prevModal=$modal[0],modal.open()})},external.stop=function(view){var $view=$(view);if($view.unbind(".modal"),$view.data("modals-initialized",0),_private.prevModal)Modal(_private.prevModal).close()},external.start("body"),external};if("function"==typeof define&&define.amd)define("js/lib/modals",["jquery","js/lib/lucid","underscore","js/lib/data.attributes"],function($,LucidJS,_,DataAttributes){return Modals($,LucidJS,_,DataAttributes)});else if("undefined"!=typeof window&&"undefined"==typeof ender)window.Modal=Modals(window.$,window.LucidJS,window._,window.DataAttributes)}(),!function(wndw){function nulls(val){return null!=val&&""!==val}function joinClasses(val){return Array.isArray(val)?val.map(joinClasses).filter(nulls).join(" "):val}var exports={};if(!Array.isArray)Array.isArray=function(arr){return"[object Array]"==Object.prototype.toString.call(arr)};if(!Object.keys)Object.keys=function(obj){var arr=[];for(var key in obj)if(obj.hasOwnProperty(key))arr.push(key);return arr};if(exports.merge=function merge(a,b){if(1===arguments.length){for(var attrs=a[0],i=1;i<a.length;i++)attrs=merge(attrs,a[i]);return attrs}var ac=a["class"],bc=b["class"];if(ac||bc){if(ac=ac||[],bc=bc||[],!Array.isArray(ac))ac=[ac];if(!Array.isArray(bc))bc=[bc];a["class"]=ac.concat(bc).filter(nulls)}for(var key in b)if("class"!=key)a[key]=b[key];return a},exports.joinClasses=joinClasses,exports.cls=function cls(classes,escaped){for(var buf=[],i=0;i<classes.length;i++)if(escaped&&escaped[i])buf.push(exports.escape(joinClasses([classes[i]])));else buf.push(joinClasses(classes[i]));var text=joinClasses(buf);if(text.length)return' class="'+text+'"';else return""},exports.attr=function attr(key,val,escaped,terse){if("boolean"==typeof val||null==val)if(val)return" "+(terse?key:key+'="'+key+'"');else return"";else if(0==key.indexOf("data")&&"string"!=typeof val)return" "+key+"='"+JSON.stringify(val).replace(/'/g,"&apos;")+"'";else if(escaped)return" "+key+'="'+exports.escape(val)+'"';else return" "+key+'="'+val+'"'},exports.attrs=function attrs(obj,terse){var buf=[],keys=Object.keys(obj);if(keys.length)for(var i=0;i<keys.length;++i){var key=keys[i],val=obj[key];if("class"==key){if(val=joinClasses(val))buf.push(" "+key+'="'+val+'"')}else buf.push(exports.attr(key,val,!1,terse))}return buf.join("")},exports.escape=function escape(html){var result=String(html).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");if(result===""+html)return html;else return result},exports.rethrow=function rethrow(err,filename,lineno,str){if(!(err instanceof Error))throw err;if(!("undefined"==typeof window&&filename||str))throw err.message+=" on line "+lineno,err;try{str=str||require("fs").readFileSync(filename,"utf8")}catch(ex){rethrow(err,null,lineno)}var context=3,lines=str.split("\n"),start=Math.max(lineno-context,0),end=Math.min(lines.length,lineno+context),context=lines.slice(start,end).map(function(line,i){var curr=i+start+1;return(curr==lineno?"  > ":"    ")+curr+"| "+line}).join("\n");throw err.path=filename,err.message=(filename||"Jade")+":"+lineno+"\n"+context+"\n\n"+err.message,err},"function"==typeof define&&define.amd)define("js/lib/jade",[],function(){return exports});else wndw.jade={helpers:exports,templates:{}}}(window),define("js/core/nls/confirmNavigation",{es:!0,fr:!0,pt:!0,ru:!0,tr:!0,zh:!0,"zh-hk":"zh-tw","zh-mo":"zh-tw","zh-tw":!0}),define("js/core/nls/root/confirmNavigation",{"Are you sure you want to leave this page?":"Are you sure you want to leave this page?","Confirm Navigation":"Confirm Navigation","Leave this Page":"Leave this Page","Stay on this Page":"Stay on this Page"}),!function(wndw){var jadify=function(jade,_t){var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(_t){buf.push('<div class="hide confirm-navigation modal"><div class="modal-header"><h3>'+jade.escape(null==(jade_interp=_t("Confirm Navigation"))?"":jade_interp)+'</h3></div><div class="modal-body"><div class="confirm-navigation-message"></div><div>'+jade.escape(null==(jade_interp=_t("Are you sure you want to leave this page?"))?"":jade_interp)+'</div></div><div class="modal-footer"><button data-modal-close="data-modal-close" class="btn confirm-navigation-stay">'+jade.escape(null==(jade_interp=_t("Stay on this Page"))?"":jade_interp)+'</button><button data-modal-close="data-modal-close" class="btn btn-danger confirm-navigation-leave">'+jade.escape(null==(jade_interp=_t("Leave this Page"))?"":jade_interp)+"</button></div></div>")}("_t"in locals_for_with?locals_for_with._t:"undefined"!=typeof _t?_t:void 0),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("js/core/confirmNavigation.html",["js/lib/jade","i18n!js/core/nls/confirmNavigation"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["js.core.confirmNavigation"]=jadify(wndw.jade.helpers)}(window),!function(definition){if("function"==typeof bootstrap)bootstrap("promise",definition);else if("object"==typeof exports)module.exports=definition();else if("function"==typeof define&&define.amd)define("js/lib/q",definition);else if("undefined"!=typeof ses)if(!ses.ok())return;else ses.makeQ=definition;else Q=definition()}(function(){function uncurryThis(f){return function(){return call.apply(f,arguments)}}function isObject(value){return value===Object(value)}function isStopIteration(exception){return"[object StopIteration]"===object_toString(exception)||exception instanceof QReturnValue}function makeStackTraceLong(error,promise){if(hasStacks&&promise.stack&&"object"==typeof error&&null!==error&&error.stack&&-1===error.stack.indexOf(STACK_JUMP_SEPARATOR)){for(var stacks=[],p=promise;p;p=p.source)if(p.stack)stacks.unshift(p.stack);stacks.unshift(error.stack);var concatedStacks=stacks.join("\n"+STACK_JUMP_SEPARATOR+"\n");error.stack=filterStackString(concatedStacks)}}function filterStackString(stackString){for(var lines=stackString.split("\n"),desiredLines=[],i=0;i<lines.length;++i){var line=lines[i];if(!isInternalFrame(line)&&!isNodeFrame(line)&&line)desiredLines.push(line)}return desiredLines.join("\n")}function isNodeFrame(stackLine){return-1!==stackLine.indexOf("(module.js:")||-1!==stackLine.indexOf("(node.js:")}function getFileNameAndLineNumber(stackLine){var attempt1=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(stackLine);if(attempt1)return[attempt1[1],Number(attempt1[2])];var attempt2=/at ([^ ]+):(\d+):(?:\d+)$/.exec(stackLine);if(attempt2)return[attempt2[1],Number(attempt2[2])];var attempt3=/.*@(.+):(\d+)$/.exec(stackLine);if(attempt3)return[attempt3[1],Number(attempt3[2])];else return void 0}function isInternalFrame(stackLine){var fileNameAndLineNumber=getFileNameAndLineNumber(stackLine);if(!fileNameAndLineNumber)return!1;var fileName=fileNameAndLineNumber[0],lineNumber=fileNameAndLineNumber[1];return fileName===qFileName&&lineNumber>=qStartingLine&&qEndingLine>=lineNumber}function captureLine(){if(hasStacks)try{throw new Error}catch(e){var lines=e.stack.split("\n"),firstLine=lines[0].indexOf("@")>0?lines[1]:lines[2],fileNameAndLineNumber=getFileNameAndLineNumber(firstLine);if(!fileNameAndLineNumber)return;return qFileName=fileNameAndLineNumber[0],fileNameAndLineNumber[1]}}function deprecate(callback,name,alternative){return function(){if("undefined"!=typeof console&&"function"==typeof console.warn)console.warn(name+" is deprecated, use "+alternative+" instead.",new Error("").stack);return callback.apply(callback,arguments)}}function Q(value){if(isPromise(value))return value;if(isPromiseAlike(value))return coerce(value);else return fulfill(value)}function defer(){function become(newPromise){resolvedPromise=newPromise,promise.source=newPromise,array_reduce(messages,function(undefined,message){nextTick(function(){newPromise.promiseDispatch.apply(newPromise,message)})},void 0),messages=void 0,progressListeners=void 0}var messages=[],progressListeners=[],resolvedPromise,deferred=object_create(defer.prototype),promise=object_create(Promise.prototype);if(promise.promiseDispatch=function(resolve,op,operands){var args=array_slice(arguments);if(messages){if(messages.push(args),"when"===op&&operands[1])progressListeners.push(operands[1])}else nextTick(function(){resolvedPromise.promiseDispatch.apply(resolvedPromise,args)})},promise.valueOf=deprecate(function(){if(messages)return promise;var nearerValue=nearer(resolvedPromise);if(isPromise(nearerValue))resolvedPromise=nearerValue;return nearerValue},"valueOf","inspect"),promise.inspect=function(){if(!resolvedPromise)return{state:"pending"};else return resolvedPromise.inspect()},Q.longStackSupport&&hasStacks)try{throw new Error}catch(e){promise.stack=e.stack.substring(e.stack.indexOf("\n")+1)}return deferred.promise=promise,deferred.resolve=function(value){if(!resolvedPromise)become(Q(value))},deferred.fulfill=function(value){if(!resolvedPromise)become(fulfill(value))},deferred.reject=function(reason){if(!resolvedPromise)become(reject(reason))},deferred.notify=function(progress){if(!resolvedPromise)array_reduce(progressListeners,function(undefined,progressListener){nextTick(function(){progressListener(progress)})},void 0)},deferred}function promise(resolver){if("function"!=typeof resolver)throw new TypeError("resolver must be a function.");var deferred=defer();try{resolver(deferred.resolve,deferred.reject,deferred.notify)}catch(reason){deferred.reject(reason)}return deferred.promise}function race(answerPs){return promise(function(resolve,reject){for(var i=0,len=answerPs.length;len>i;i++)Q(answerPs[i]).then(resolve,reject)})}function Promise(descriptor,fallback,inspect){if(void 0===fallback)fallback=function(op){return reject(new Error("Promise does not support operation: "+op))};if(void 0===inspect)inspect=function(){return{state:"unknown"}};var promise=object_create(Promise.prototype);if(promise.promiseDispatch=function(resolve,op,args){var result;try{if(descriptor[op])result=descriptor[op].apply(promise,args);else result=fallback.call(promise,op,args)}catch(exception){result=reject(exception)}if(resolve)resolve(result)},promise.inspect=inspect,inspect){var inspected=inspect();if("rejected"===inspected.state)promise.exception=inspected.reason;promise.valueOf=deprecate(function(){var inspected=inspect();if("pending"===inspected.state||"rejected"===inspected.state)return promise;else return inspected.value})}return promise}function when(value,fulfilled,rejected,progressed){return Q(value).then(fulfilled,rejected,progressed)}function nearer(value){if(isPromise(value)){var inspected=value.inspect();if("fulfilled"===inspected.state)return inspected.value}return value}function isPromise(object){return isObject(object)&&"function"==typeof object.promiseDispatch&&"function"==typeof object.inspect}function isPromiseAlike(object){return isObject(object)&&"function"==typeof object.then}function isPending(object){return isPromise(object)&&"pending"===object.inspect().state}function isFulfilled(object){return!isPromise(object)||"fulfilled"===object.inspect().state
}function isRejected(object){return isPromise(object)&&"rejected"===object.inspect().state}function displayUnhandledReasons(){if(!unhandledReasonsDisplayed&&"undefined"!=typeof window&&!window.Touch&&window.console)console.warn("[Q] Unhandled rejection reasons (should be empty):",unhandledReasons);unhandledReasonsDisplayed=!0}function logUnhandledReasons(){for(var i=0;i<unhandledReasons.length;i++){var reason=unhandledReasons[i];if(reason&&"undefined"!=typeof reason.stack)console.warn("Unhandled rejection reason:",reason.stack);else console.warn("Unhandled rejection reason (no stack):",reason)}}function resetUnhandledRejections(){if(unhandledReasons.length=0,unhandledRejections.length=0,unhandledReasonsDisplayed=!1,!trackUnhandledRejections)if(trackUnhandledRejections=!0,"undefined"!=typeof process&&process.on)process.on("exit",logUnhandledReasons)}function trackRejection(promise,reason){if(trackUnhandledRejections)unhandledRejections.push(promise),unhandledReasons.push(reason),displayUnhandledReasons()}function untrackRejection(promise){if(trackUnhandledRejections){var at=array_indexOf(unhandledRejections,promise);if(-1!==at)unhandledRejections.splice(at,1),unhandledReasons.splice(at,1)}}function reject(reason){var rejection=Promise({when:function(rejected){if(rejected)untrackRejection(this);return rejected?rejected(reason):this}},function fallback(){return this},function inspect(){return{state:"rejected",reason:reason}});return trackRejection(rejection,reason),rejection}function fulfill(value){return Promise({when:function(){return value},get:function(name){return value[name]},set:function(name,rhs){value[name]=rhs},"delete":function(name){delete value[name]},post:function(name,args){if(null===name||void 0===name)return value.apply(void 0,args);else return value[name].apply(value,args)},apply:function(thisp,args){return value.apply(thisp,args)},keys:function(){return object_keys(value)}},void 0,function inspect(){return{state:"fulfilled",value:value}})}function coerce(promise){var deferred=defer();return nextTick(function(){try{promise.then(deferred.resolve,deferred.reject,deferred.notify)}catch(exception){deferred.reject(exception)}}),deferred.promise}function master(object){return Promise({isDef:function(){}},function fallback(op,args){return dispatch(object,op,args)},function(){return Q(object).inspect()})}function spread(value,fulfilled,rejected){return Q(value).spread(fulfilled,rejected)}function async(makeGenerator){return function(){function continuer(verb,arg){var result;if(hasES6Generators){try{result=generator[verb](arg)}catch(exception){return reject(exception)}if(result.done)return result.value;else return when(result.value,callback,errback)}else{try{result=generator[verb](arg)}catch(exception){if(isStopIteration(exception))return exception.value;else return reject(exception)}return when(result,callback,errback)}}var generator=makeGenerator.apply(this,arguments),callback=continuer.bind(continuer,"next"),errback=continuer.bind(continuer,"throw");return callback()}}function spawn(makeGenerator){Q.done(Q.async(makeGenerator)())}function _return(value){throw new QReturnValue(value)}function promised(callback){return function(){return spread([this,all(arguments)],function(self,args){return callback.apply(self,args)})}}function dispatch(object,op,args){return Q(object).dispatch(op,args)}function all(promises){return when(promises,function(promises){var countDown=0,deferred=defer();if(array_reduce(promises,function(undefined,promise,index){var snapshot;if(isPromise(promise)&&"fulfilled"===(snapshot=promise.inspect()).state)promises[index]=snapshot.value;else++countDown,when(promise,function(value){if(promises[index]=value,0===--countDown)deferred.resolve(promises)},deferred.reject,function(progress){deferred.notify({index:index,value:progress})})},void 0),0===countDown)deferred.resolve(promises);return deferred.promise})}function allResolved(promises){return when(promises,function(promises){return promises=array_map(promises,Q),when(all(array_map(promises,function(promise){return when(promise,noop,noop)})),function(){return promises})})}function allSettled(promises){return Q(promises).allSettled()}function progress(object,progressed){return Q(object).then(void 0,void 0,progressed)}function nodeify(object,nodeback){return Q(object).nodeify(nodeback)}var hasStacks=!1;try{throw new Error}catch(e){hasStacks=!!e.stack}var qStartingLine=captureLine(),qFileName,noop=function(){},nextTick=function(){function flush(){for(;head.next;){head=head.next;var task=head.task;head.task=void 0;var domain=head.domain;if(domain)head.domain=void 0,domain.enter();try{task()}catch(e){if(isNodeJS){if(domain)domain.exit();if(setTimeout(flush,0),domain)domain.enter();throw e}else setTimeout(function(){throw e},0)}if(domain)domain.exit()}flushing=!1}var head={task:void 0,next:null},tail=head,flushing=!1,requestTick=void 0,isNodeJS=!1;if(nextTick=function(task){if(tail=tail.next={task:task,domain:isNodeJS&&process.domain,next:null},!flushing)flushing=!0,requestTick()},"undefined"!=typeof process&&process.nextTick)isNodeJS=!0,requestTick=function(){process.nextTick(flush)};else if("function"==typeof setImmediate)if("undefined"!=typeof window)requestTick=setImmediate.bind(window,flush);else requestTick=function(){setImmediate(flush)};else if("undefined"!=typeof MessageChannel){var channel=new MessageChannel;channel.port1.onmessage=flush,requestTick=function(){channel.port2.postMessage(0)}}else requestTick=function(){setTimeout(flush,0)};return nextTick}(),call=Function.call,array_slice=uncurryThis(Array.prototype.slice),array_reduce=uncurryThis(Array.prototype.reduce||function(callback,basis){var index=0,length=this.length;if(1===arguments.length)for(;;){if(index in this){basis=this[index++];break}if(++index>=length)throw new TypeError}for(;length>index;index++)if(index in this)basis=callback(basis,this[index],index);return basis}),array_indexOf=uncurryThis(Array.prototype.indexOf||function(value){for(var i=0;i<this.length;i++)if(this[i]===value)return i;return-1}),array_map=uncurryThis(Array.prototype.map||function(callback,thisp){var self=this,collect=[];return array_reduce(self,function(undefined,value,index){collect.push(callback.call(thisp,value,index,self))},void 0),collect}),object_create=Object.create||function(prototype){function Type(){}return Type.prototype=prototype,new Type},object_hasOwnProperty=uncurryThis(Object.prototype.hasOwnProperty),object_keys=Object.keys||function(object){var keys=[];for(var key in object)if(object_hasOwnProperty(object,key))keys.push(key);return keys},object_toString=uncurryThis(Object.prototype.toString),QReturnValue;if("undefined"!=typeof ReturnValue)QReturnValue=ReturnValue;else QReturnValue=function(value){this.value=value};var hasES6Generators;try{new Function("(function* (){ yield 1; })"),hasES6Generators=!0}catch(e){hasES6Generators=!1}var STACK_JUMP_SEPARATOR="From previous event:";Q.resolve=Q,Q.nextTick=nextTick,Q.longStackSupport=!1,Q.defer=defer,defer.prototype.makeNodeResolver=function(){var self=this;return function(error,value){if(error)self.reject(error);else if(arguments.length>2)self.resolve(array_slice(arguments,1));else self.resolve(value)}},Q.promise=promise,Q.passByCopy=function(object){return object},Promise.prototype.passByCopy=function(){return this},Q.join=function(x,y){return Q(x).join(y)},Promise.prototype.join=function(that){return Q([this,that]).spread(function(x,y){if(x===y)return x;else throw new Error("Can't join: not the same: "+x+" "+y)})},Q.race=race,Promise.prototype.race=function(){return this.then(Q.race)},Q.makePromise=Promise,Promise.prototype.toString=function(){return"[object Promise]"},Promise.prototype.then=function(fulfilled,rejected,progressed){function _fulfilled(value){try{return"function"==typeof fulfilled?fulfilled(value):value}catch(exception){return reject(exception)}}function _rejected(exception){if("function"==typeof rejected){makeStackTraceLong(exception,self);try{return rejected(exception)}catch(newException){return reject(newException)}}return reject(exception)}function _progressed(value){return"function"==typeof progressed?progressed(value):value}var self=this,deferred=defer(),done=!1;return nextTick(function(){self.promiseDispatch(function(value){if(!done)done=!0,deferred.resolve(_fulfilled(value))},"when",[function(exception){if(!done)done=!0,deferred.resolve(_rejected(exception))}])}),self.promiseDispatch(void 0,"when",[void 0,function(value){var newValue,threw=!1;try{newValue=_progressed(value)}catch(e){if(threw=!0,Q.onerror)Q.onerror(e);else throw e}if(!threw)deferred.notify(newValue)}]),deferred.promise},Q.when=when,Promise.prototype.thenResolve=function(value){return this.then(function(){return value})},Q.thenResolve=function(promise,value){return Q(promise).thenResolve(value)},Promise.prototype.thenReject=function(reason){return this.then(function(){throw reason})},Q.thenReject=function(promise,reason){return Q(promise).thenReject(reason)},Q.nearer=nearer,Q.isPromise=isPromise,Q.isPromiseAlike=isPromiseAlike,Q.isPending=isPending,Promise.prototype.isPending=function(){return"pending"===this.inspect().state},Q.isFulfilled=isFulfilled,Promise.prototype.isFulfilled=function(){return"fulfilled"===this.inspect().state},Q.isRejected=isRejected,Promise.prototype.isRejected=function(){return"rejected"===this.inspect().state};var unhandledReasons=[],unhandledRejections=[],unhandledReasonsDisplayed=!1,trackUnhandledRejections=!0;Q.resetUnhandledRejections=resetUnhandledRejections,Q.getUnhandledReasons=function(){return unhandledReasons.slice()},Q.stopUnhandledRejectionTracking=function(){if(resetUnhandledRejections(),"undefined"!=typeof process&&process.on)process.removeListener("exit",logUnhandledReasons);trackUnhandledRejections=!1},resetUnhandledRejections(),Q.reject=reject,Q.fulfill=fulfill,Q.master=master,Q.spread=spread,Promise.prototype.spread=function(fulfilled,rejected){return this.all().then(function(array){return fulfilled.apply(void 0,array)},rejected)},Q.async=async,Q.spawn=spawn,Q["return"]=_return,Q.promised=promised,Q.dispatch=dispatch,Promise.prototype.dispatch=function(op,args){var self=this,deferred=defer();return nextTick(function(){self.promiseDispatch(deferred.resolve,op,args)}),deferred.promise},Q.get=function(object,key){return Q(object).dispatch("get",[key])},Promise.prototype.get=function(key){return this.dispatch("get",[key])},Q.set=function(object,key,value){return Q(object).dispatch("set",[key,value])},Promise.prototype.set=function(key,value){return this.dispatch("set",[key,value])},Q.del=Q["delete"]=function(object,key){return Q(object).dispatch("delete",[key])},Promise.prototype.del=Promise.prototype["delete"]=function(key){return this.dispatch("delete",[key])},Q.mapply=Q.post=function(object,name,args){return Q(object).dispatch("post",[name,args])},Promise.prototype.mapply=Promise.prototype.post=function(name,args){return this.dispatch("post",[name,args])},Q.send=Q.mcall=Q.invoke=function(object,name){return Q(object).dispatch("post",[name,array_slice(arguments,2)])},Promise.prototype.send=Promise.prototype.mcall=Promise.prototype.invoke=function(name){return this.dispatch("post",[name,array_slice(arguments,1)])},Q.fapply=function(object,args){return Q(object).dispatch("apply",[void 0,args])},Promise.prototype.fapply=function(args){return this.dispatch("apply",[void 0,args])},Q["try"]=Q.fcall=function(object){return Q(object).dispatch("apply",[void 0,array_slice(arguments,1)])},Promise.prototype.fcall=function(){return this.dispatch("apply",[void 0,array_slice(arguments)])},Q.fbind=function(object){var promise=Q(object),args=array_slice(arguments,1);return function fbound(){return promise.dispatch("apply",[this,args.concat(array_slice(arguments))])}},Promise.prototype.fbind=function(){var promise=this,args=array_slice(arguments);return function fbound(){return promise.dispatch("apply",[this,args.concat(array_slice(arguments))])}},Q.keys=function(object){return Q(object).dispatch("keys",[])},Promise.prototype.keys=function(){return this.dispatch("keys",[])},Q.all=all,Promise.prototype.all=function(){return all(this)},Q.allResolved=deprecate(allResolved,"allResolved","allSettled"),Promise.prototype.allResolved=function(){return allResolved(this)},Q.allSettled=allSettled,Promise.prototype.allSettled=function(){return this.then(function(promises){return all(array_map(promises,function(promise){function regardless(){return promise.inspect()}return promise=Q(promise),promise.then(regardless,regardless)}))})},Q.fail=Q["catch"]=function(object,rejected){return Q(object).then(void 0,rejected)},Promise.prototype.fail=Promise.prototype["catch"]=function(rejected){return this.then(void 0,rejected)},Q.progress=progress,Promise.prototype.progress=function(progressed){return this.then(void 0,void 0,progressed)},Q.fin=Q["finally"]=function(object,callback){return Q(object)["finally"](callback)},Promise.prototype.fin=Promise.prototype["finally"]=function(callback){return callback=Q(callback),this.then(function(value){return callback.fcall().then(function(){return value})},function(reason){return callback.fcall().then(function(){throw reason})})},Q.done=function(object,fulfilled,rejected,progress){return Q(object).done(fulfilled,rejected,progress)},Promise.prototype.done=function(fulfilled,rejected,progress){var onUnhandledError=function(error){nextTick(function(){if(makeStackTraceLong(error,promise),Q.onerror)Q.onerror(error);else throw error})},promise=fulfilled||rejected||progress?this.then(fulfilled,rejected,progress):this;if("object"==typeof process&&process&&process.domain)onUnhandledError=process.domain.bind(onUnhandledError);promise.then(void 0,onUnhandledError)},Q.timeout=function(object,ms,message){return Q(object).timeout(ms,message)},Promise.prototype.timeout=function(ms,message){var deferred=defer(),timeoutId=setTimeout(function(){deferred.reject(new Error(message||"Timed out after "+ms+" ms"))},ms);return this.then(function(value){clearTimeout(timeoutId),deferred.resolve(value)},function(exception){clearTimeout(timeoutId),deferred.reject(exception)},deferred.notify),deferred.promise},Q.delay=function(object,timeout){if(void 0===timeout)timeout=object,object=void 0;return Q(object).delay(timeout)},Promise.prototype.delay=function(timeout){return this.then(function(value){var deferred=defer();return setTimeout(function(){deferred.resolve(value)},timeout),deferred.promise})},Q.nfapply=function(callback,args){return Q(callback).nfapply(args)},Promise.prototype.nfapply=function(args){var deferred=defer(),nodeArgs=array_slice(args);return nodeArgs.push(deferred.makeNodeResolver()),this.fapply(nodeArgs).fail(deferred.reject),deferred.promise},Q.nfcall=function(callback){var args=array_slice(arguments,1);return Q(callback).nfapply(args)},Promise.prototype.nfcall=function(){var nodeArgs=array_slice(arguments),deferred=defer();return nodeArgs.push(deferred.makeNodeResolver()),this.fapply(nodeArgs).fail(deferred.reject),deferred.promise},Q.nfbind=Q.denodeify=function(callback){var baseArgs=array_slice(arguments,1);return function(){var nodeArgs=baseArgs.concat(array_slice(arguments)),deferred=defer();return nodeArgs.push(deferred.makeNodeResolver()),Q(callback).fapply(nodeArgs).fail(deferred.reject),deferred.promise}},Promise.prototype.nfbind=Promise.prototype.denodeify=function(){var args=array_slice(arguments);return args.unshift(this),Q.denodeify.apply(void 0,args)},Q.nbind=function(callback,thisp){var baseArgs=array_slice(arguments,2);return function(){function bound(){return callback.apply(thisp,arguments)}var nodeArgs=baseArgs.concat(array_slice(arguments)),deferred=defer();return nodeArgs.push(deferred.makeNodeResolver()),Q(bound).fapply(nodeArgs).fail(deferred.reject),deferred.promise}},Promise.prototype.nbind=function(){var args=array_slice(arguments,0);return args.unshift(this),Q.nbind.apply(void 0,args)},Q.nmapply=Q.npost=function(object,name,args){return Q(object).npost(name,args)},Promise.prototype.nmapply=Promise.prototype.npost=function(name,args){var nodeArgs=array_slice(args||[]),deferred=defer();return nodeArgs.push(deferred.makeNodeResolver()),this.dispatch("post",[name,nodeArgs]).fail(deferred.reject),deferred.promise},Q.nsend=Q.nmcall=Q.ninvoke=function(object,name){var nodeArgs=array_slice(arguments,2),deferred=defer();return nodeArgs.push(deferred.makeNodeResolver()),Q(object).dispatch("post",[name,nodeArgs]).fail(deferred.reject),deferred.promise},Promise.prototype.nsend=Promise.prototype.nmcall=Promise.prototype.ninvoke=function(name){var nodeArgs=array_slice(arguments,1),deferred=defer();return nodeArgs.push(deferred.makeNodeResolver()),this.dispatch("post",[name,nodeArgs]).fail(deferred.reject),deferred.promise},Q.nodeify=nodeify,Promise.prototype.nodeify=function(nodeback){if(nodeback)this.then(function(value){nextTick(function(){nodeback(null,value)})},function(error){nextTick(function(){nodeback(error)})});else return this};var qEndingLine=captureLine();return Q}),define("js/core/origami",["jquery","underscore","backbone","require","js/lib/modals","js/core/confirmNavigation.html","i18n!js/core/nls/confirmNavigation","js/lib/q"],function($,_,Backbone,require,Modal,confirmNavigationTemplate,confirmNavigationTemplate_t,Q){Backbone.View.prototype._super=function(funcName){return this.constructor.__super__[funcName].apply(this,_.rest(arguments))};var _singleton=null,_private={current:null,body:"#origami",views:{},beforeUnloadMessage:"There are unsaved changes that will be lost if you reload or leave this page.",regionHasUnsavedModel:function(region){if(!region)return!1;var viewHasUnsavedModel=region.view.hasUnsavedModel?region.view.hasUnsavedModel():!1;if(viewHasUnsavedModel)return!0;else{for(var name in region.regions){var subRegion=region.regions[name];if(_private.regionHasUnsavedModel(subRegion))return!0}return!1}}};if(window.location.hash.match(/^#!/))window.location.hash=window.location.hash.replace(/^#!/,"#");var router=Backbone.Router.extend({initialize:function(){var self=this;self.routePrefix="",self.linkClass="internal",$("body").on("click","a.internal",function(e){if(!e.ctrlKey&&!e.metaKey)e.preventDefault(),self.navigate($(e.currentTarget).attr("href"),!0)}),this.$confirmNavigation=$(confirmNavigationTemplate({_t:confirmNavigationTemplate_t})),$("body").append(this.$confirmNavigation),$(window).on("beforeunload.origami",function(){if(_private.regionHasUnsavedModel(_private.current))return _private.beforeUnloadMessage})},setupLinks:function(routePrefix,linkClass){var self=this;this.routePrefix=routePrefix,this.linkClass=linkClass,$("body").on("click","a."+this.linkClass,function(e){if(!e.ctrlKey&&!e.metaKey)e.preventDefault(),self.navigateTo($(e.currentTarget).attr("href"),!0)})},navigateTo:function(href,silent){this.navigate(href.replace(this.routePrefix,""),silent)},navigate:function(fragment,options){if(_private.current&&_private.regionHasUnsavedModel(_private.current)){var $message=$(".confirm-navigation-message");$message.text(_private.beforeUnloadMessage);var $leave=$(".confirm-navigation-leave");$leave.one("click",function(){Backbone.Router.prototype.navigate.call(this,fragment,options)});var modalOptions={"overlay.class":"coursera-overlay"};Modal(".confirm-navigation",modalOptions).open()}else Backbone.Router.prototype.navigate.call(this,fragment,options)},addRoutes:function(routes){var self=this;for(var route in routes)self.route(route,route,routes[route]),self.route(route+"/",route+"/",function(){var url=Backbone.history.getFragment(),rewrite=url.replace(/\/(?:\?.*)*$/,"");self.navigate(rewrite,{trigger:!0,replace:!0})})}}),animateManager={resize:function(outgoing,incoming,callback){$("body").append(incoming.$el.css({visibility:"hidden"}));var height={from:outgoing.$el.outerHeight(),to:incoming.$el.outerHeight()};outgoing.$el.animate({height:height.to},300,function(){if(outgoing.$el.replaceWith(incoming.$el.css({visibility:"visible"})),incoming.$el.find("img").on("load",function(){incoming.$el.animate({height:incoming.$el.outerHeight()})}),callback)callback()})},slideLeft:function(outgoing,incoming,callback){var going=outgoing.$el,coming=incoming.$el,position=going.position(),width=going.outerWidth(),height=going.outerHeight(),parent=$("<div>").css({position:"relative",width:width,height:height}),restoreIn={position:coming.css("absolute")||"static",width:coming.get(0).style.width,left:coming.get(0).style.left},restoreOut={position:going.css("absolute")||"static",width:going.get(0).style.width,left:going.get(0).style.left};going.wrap(parent),going.css({width:width,left:position.left,position:"absolute"}),coming.css({width:width,left:position.left+width,position:"absolute"}),going.parent().append(coming),going.animate({left:-width},{duration:500,step:function(moved){coming.css({left:position.left+width+moved})},complete:function(){if(coming.css(restoreIn),going.css(restoreOut).hide(),going.unwrap(),callback)callback()}})},slideRight:function(outgoing,incoming,callback){var going=outgoing.$el,coming=incoming.$el,position=going.position(),width=going.outerWidth(),height=going.outerHeight(),parent=$("<div>").css({position:"relative",width:width,height:height}),restoreIn={position:coming.css("absolute")||"static",width:coming.get(0).style.width,left:coming.get(0).style.left},restoreOut={position:going.css("absolute")||"static",width:going.get(0).style.width,left:going.get(0).style.left};going.wrap(parent),going.css({width:width,left:position.left,position:"absolute"}),coming.css({width:width,left:-(position.left+width),position:"absolute"}),going.parent().append(coming),going.animate({left:width},{duration:500,step:function(moved){coming.css({left:-(position.left+width)+moved})},complete:function(){if(coming.css(restoreIn),going.css(restoreOut).hide(),going.unwrap(),callback)callback()}})},replace:function(outgoing,incoming,callback){if(outgoing.$el.replaceWith(incoming.el),callback)callback()}},region=function(type,_options){var self=this,options=_options||{};self.type=type,self.animate=options.animate||{},self.regions=options.regions||{},self.initialize=options.initialize||{},self.options={},self.id=options.id||type.prototype.name,self.name=type.prototype.name,self.view=null,self.regions=$.extend(!0,{},type.prototype.subregions,options.regions||{})};region.prototype.close=function(keep){var self=this;if(_.each(self.regions,function(_region,key){delete self.regions[key],_region.close(keep)}),!keep)self.view.remove();self.view.undelegateEvents(),self.view.trigger("view:closed"),self.view.off("view")},region.prototype.closing=function(){this.view.trigger("view:closing"),delete _private.views[this.view.cid]},region.prototype.render=function(origami){var self=this;if(_.each(self.regions,function(view,key){if(!view)return;view.render(),view.parent=self}),self.view=new self.type(self.initialize),self.view.region=self,self.view.render(self.render),origami)self.view.on("view:appended",function(){origami.trigger("region:appended",{name:self.name})});return self},region.prototype.appended=function(){var that=this;if(that.view)setTimeout(function(){that.view.trigger("view:appended")},0)},region.prototype.append=function(view,options){var that=this,appended=Q.defer();if(!this.regions)this.regions={};var render_and_append=function(_region){for(var key=view,count=0,$el;that.regions[key];)key+=++count;if(that.regions[key]=_region,_region.render(_singleton),options.to)$el=_.isElement(options.to)?that.view.$(options.to):options.to;else $el=that.view.$el;$el.append(_region.view.el),_region.appended(),_singleton.trigger("region:rendered",{name:_region}),appended.resolve(_region)};if("string"==typeof view)_singleton.region.fetch(view,options,render_and_append);else render_and_append(new region(view,options));return appended.promise},region.prototype.is=function(_region){return _region.type==this.type&&_region.id==this.id},region.prototype.replace=function(incoming,callback){var outgoing=this,how="replace",animate={incoming:incoming.view.animate,outgoing:outgoing.view.animate};if(_.isString(animate.incoming))how=animate.incoming;else if(_.isFunction(animate.incoming))how=animate.incoming();else if(_.isString(animate.outgoing))how=animate.outgoing;else if(_.isFunction(animate.outgoing))how=animate.outgoing();if(!animateManager[how])how="replace";animateManager[how](outgoing.view,incoming.view,callback)},region.prototype.merge=function(incoming,origami){var self=this;if(self.is(incoming))_.each(incoming.regions,function(_region,view){self.regions[view].view.trigger("view:merging",_region.initialize),self.regions[view].merge(_region,origami),self.regions[view].view.trigger("view:merged",_region.initialize)});else if(self.name==incoming.name)self.closing(),incoming.render(origami),self.replace(incoming,function(){if(self.parent)self.parent.regions[incoming.name]=incoming,incoming.parent=self.parent,self.parent.appended();self.close(),incoming.appended()})};var Origami=function(body,current){if(_singleton)return _singleton;_singleton=this;var that=this;_private.body=body,_private.current=current,$(window).on("resize",function(){for(var cid in _private.views)_private.views[cid].trigger("view:resize")}),this.region={make:function(type,options){return new region(type,options)},fetch:function(_region,conf,callback){var uid=_.uniqueId();that.trigger("region:fetching",{name:_region,uid:uid}),require([_region],function(view){that.trigger("region:fetched",{name:_region,uid:uid}),callback(new region(view,conf))})},append:function(parent,view,options,callback){if(!parent)parent={regions:{}};var render_and_append=function(_region){for(var key=view,count=0;parent.regions[key];)key+=++count;if(parent.regions[key]=_region,_region.render(that),callback)callback(_region);return _region.appended(),that.trigger("region:rendered",{name:_region}),_region};if("string"==typeof view)that.region.fetch(view,options,render_and_append);else return render_and_append(new region(view,options))},open:function(name,callback){var view=name,conf={};if(_.isObject(name))view=_.keys(name)[0],conf=name[view];that.region.fetch(view,conf,callback||function(parent){var validRegions=_(parent.regions).filter(function(region){return region}),render=_.after(_.keys(validRegions||{}).length+1,function(){if(_private.current){if(_private.current.is(parent))return void _private.current.merge(parent,that);else if(_private.current.name==parent.name)return parent.render(that),void _private.current.replace(parent,function(){_private.current.close(),_private.current=parent,_private.current.appended()});_private.current.close(!0)}_private.current=parent,$(_private.body).html(_private.current.render(that).view.el),_private.current.appended(),_.each(_private.current.regions,function(_region){if(_region)_region.appended()})});render(that),_.each(parent.regions,function(subregion,name){if(!subregion)return;that.region.open(subregion,function(_region){parent.regions[name]=_region,render(that)})})})}},this.animate=animateManager,this.router=new router,this.store={},this.tracker=[]};return _.extend(Origami.prototype,Backbone.Events),Origami}),function(wndw){var config={environment:"production",out:"js/core/config.js",log:"error",debug:!1,url:{maestro:"/maestro/api/",base:"https://www.coursera.org/",api:"/maestro/api/",cloudfront_api:"https://d1hpa2gdx2lr6r.cloudfront.net/maestro/api/",accounts:"https://accounts.coursera.org/",assets:"https://d2wvvaown1ul17.cloudfront.net/site-static/",resource_assets:"https://coursera_assets.s3.amazonaws.com/",app_assets:"https://d2wvvaown1ul17.cloudfront.net/site-static/d302c0fad09313d7a5e7b60702e3afbd6ea74baf/"},version:"d302c0fad09313d7a5e7b60702e3afbd6ea74baf",dir:{home:"/"},gapi_eventing_data:{project_number:"274249572679",api_key:"",client_id:"274249572679-al8nc3ttcavj0n91due232a3h6s3r9vk.apps.googleusercontent.com"},bigquery:{dataset:"mydataset",table_prefix:"livedata_"}};if("function"==typeof define&&define.amd)define("js/core/config",[],function(){return config});else return wndw.configure=config}(window),define("js/lib/supports",[],function(){var supports={},prefix="supports-";if(document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#Image","1.1"))document.documentElement.className=prefix+"svg",supports.svg=!0;if(window.XMLHttpRequest&&"withCredentials"in new window.XMLHttpRequest&&navigator.userAgent.indexOf("MSIE 10.0")<0)supports.cors=!0;var userAgent=navigator.userAgent.toLowerCase();if(/safari/.test(userAgent)&&!/chrome/.test(userAgent))supports.accepts=!1;else supports.accepts=!0;return supports}),!function(wndw){var module=function(_,$){var thirdparty={loadScript:function(url,success,body){var newScript=document.createElement("script"),scripts=document.getElementsByTagName("script");if(newScript.type="text/javascript",newScript.async=!0,newScript.src=url,body)newScript.innerHTML=body;if(success)newScript.onload=newScript.onreadystatechange=function(){newScript.onreadystatechange=newScript.onload=null,success()};if(scripts&&scripts.length)scripts[0].parentNode.insertBefore(newScript,scripts[0]);else if(window.document&&window.document.body)window.document.body.appendChild(newScript)},isDefined:function(parent,name){for(var parts=name.split("."),part=parts.shift(),cur=parent;part;)if(cur[part])cur=cur[part],part=parts.shift();else cur=null,part=null;return null!==cur},ready:function(global,callback){if(thirdparty.isDefined(window,global))callback.call();else{var base=global.split(".")[0];if(_.isArray(pool[global]))pool[global].push(callback);else pool[global]=[callback],third_party_globals[base].call(null,global)}}},pool={},poll=function(global){if(thirdparty.isDefined(window,global))for(var base=global.split(".")[0];pool[global]&&pool[global].length;)pool[global].pop().call();else window.setTimeout(function(){poll(global)},100)},third_party_globals={IN:function(x){var funcName="itsThirdPartyTime"+(new Date).getTime();window[funcName]=function(){delete window[funcName],poll(x)},thirdparty.loadScript("https://platform.linkedin.com/in.js",function(){},"onLoad:"+funcName+"\napi_key: v7ah6tdxsqt6")},google:function(x){var funcName;if(/^google\.maps.places/.test(x))funcName="itsThirdPartyTime"+(new Date).getTime(),window[funcName]=function(){delete window[funcName],poll(x)},thirdparty.loadScript("https://maps.googleapis.com/maps/api/js?sensor=false&key=AIzaSyC7XENXcXiE_oj0HvDUC_MiLY9zI3xTW0g&libraries=places&callback="+funcName);if(/^google\.maps\.Map/.test(x))funcName="itsThirdPartyTime"+(new Date).getTime(),window[funcName]=function(){delete window[funcName],poll(x)},thirdparty.loadScript("https://maps.googleapis.com/maps/api/js?sensor=false&key=AIzaSyCzodUI0p0hH-8n6tZ45vMNlaNfKEpuEMU&callback="+funcName)},FB:function(x){thirdparty.loadScript("https://connect.facebook.net/en_US/all.js#xfbml=1&appId=274998519252278",function(){poll(x)})},gapi:function(x){window.___gcfg={lang:"en-US",parsetags:"explicit"},thirdparty.loadScript("https://apis.google.com/js/plusone.js",function(){delete window.___gcfg,poll(x)})},twttr:function(x){thirdparty.loadScript("https://platform.twitter.com/widgets.js",function(){poll(x)})},MathJax:function(x){thirdparty.loadScript("https://d2265nx4vomwra.cloudfront.net/2.1/MathJax.js?delayStartupUntil=configured",function(){poll(x)})}};return thirdparty};if("function"==typeof define&&define.amd)define("js/lib/third-parties",["underscore","jquery"],function(_,$){return module(_,$)});else window.thirdparties=module(window._,window.$)}(window),!function(wndw){var module=function(){if(wndw.console=wndw.console||{},wndw.console.log=wndw.console.log||function(){},wndw.console.error=wndw.console.error||function(){},wndw.console.warn=wndw.console.warn||function(){},wndw.console.info=wndw.console.info||function(){},!wndw.console.log.apply)wndw.console.log=Function.prototype.bind.call(wndw.console.log,wndw.console),wndw.console.error=Function.prototype.bind.call(wndw.console.error,wndw.console),wndw.console.warn=Function.prototype.bind.call(wndw.console.warn,wndw.console),wndw.console.info=Function.prototype.bind.call(wndw.console.info,wndw.console);
var Logger=function(options){this.options=options||{}};Logger.prototype.customize=function(options){return this.options=options||{},this},Logger.prototype.info=function(){if("info"==this.options.level)wndw.console.info.apply(wndw.console,arguments);return this},Logger.prototype.warn=function(){if(/info|warn/.test(this.options.level))wndw.console.warn.apply(wndw.console,arguments);return this},Logger.prototype.error=function(){if(/error|warn|info/.test(this.options.level))wndw.console.error.apply(wndw.console,arguments);return this};var exports=function(options){return new Logger(options)};return exports};if("function"==typeof define&&define.amd)define("js/lib/log",[],function(){return module()});else if("undefined"!=typeof wndw&&"undefined"==typeof ender)wndw.Log=module()}(window),!function(){var JSON;if(!JSON)JSON={};var json=function(){function f(n){return 10>n?"0"+n:n}function quote(string){return escapable.lastIndex=0,escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return"string"==typeof c?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+string+'"'}function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value&&"object"==typeof value&&"function"==typeof value.toJSON)value=value.toJSON(key);if("function"==typeof rep)value=rep.call(holder,key,value);switch(typeof value){case"string":return quote(value);case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value)return"null";if(gap+=indent,partial=[],"[object Array]"===Object.prototype.toString.apply(value)){for(length=value.length,i=0;length>i;i+=1)partial[i]=str(i,value)||"null";return v=0===partial.length?"[]":gap?"[\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"]":"["+partial.join(",")+"]",gap=mind,v}if(rep&&"object"==typeof rep){for(length=rep.length,i=0;length>i;i+=1)if("string"==typeof rep[i])if(k=rep[i],v=str(k,value))partial.push(quote(k)+(gap?": ":":")+v)}else for(k in value)if(Object.prototype.hasOwnProperty.call(value,k))if(v=str(k,value))partial.push(quote(k)+(gap?": ":":")+v);return v=0===partial.length?"{}":gap?"{\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"}":"{"+partial.join(",")+"}",gap=mind,v}}if("function"!=typeof Date.prototype.toJSON)Date.prototype.toJSON=function(key){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(key){return this.valueOf()};var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;if("function"!=typeof JSON.stringify)JSON.stringify=function(value,replacer,space){var i;if(gap="",indent="","number"==typeof space)for(i=0;space>i;i+=1)indent+=" ";else if("string"==typeof space)indent=space;if(rep=replacer,replacer&&"function"!=typeof replacer&&("object"!=typeof replacer||"number"!=typeof replacer.length))throw new Error("JSON.stringify");return str("",{"":value})};if("function"!=typeof JSON.parse)JSON.parse=function(text,reviver){function walk(holder,key){var k,v,value=holder[key];if(value&&"object"==typeof value)for(k in value)if(Object.prototype.hasOwnProperty.call(value,k))if(v=walk(value,k),void 0!==v)value[k]=v;else delete value[k];return reviver.call(holder,key,value)}var j;if(text=String(text),cx.lastIndex=0,cx.test(text))text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)});if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),"function"==typeof reviver?walk({"":j},""):j;throw new SyntaxError("JSON.parse")}};if("function"==typeof define&&define.amd)define("js/lib/json2",[],function(){return json(),JSON});else if("undefined"!=typeof window&&"undefined"==typeof ender)json(),window.JSON=JSON}(),!function(wndw){var module=function(_){var MultiTracker=function(opts){var options=opts||{};this.trackers={},this.logger=options.logger||Log({level:"error"})};MultiTracker.prototype.register=function(name,queue,type,parser){this.trackers[name]={queue:queue||[],type:type||"key-value",parse:parser}},MultiTracker.prototype.get=function(name){return this.trackers[name]},MultiTracker.prototype.push=function(){for(var trackings=arguments,k=0;k<trackings.length;k++){var tracking=_.isArray(trackings[k])?trackings[k]:[trackings[k]];for(var tracker in this.trackers){var trackEvent,i,handler;if("google"==this.trackers[tracker].type){if("pageview"==tracking[0])for(trackEvent=["_trackPageview"],i=1;i<tracking.length;i++)trackEvent.push(_.isString(tracking[i])?tracking[i]:JSON.stringify(tracking[i]))}else if("key-value"==this.trackers[tracker].type){for(var value=[],a=1;a<tracking.length;a++)if("function"==typeof tracking[a])handler=tracking[a];else value.push(_.isString(tracking[a])?tracking[a]:JSON.stringify(tracking[a]));if(value.length)trackEvent={key:tracking[0],value:value.join(".")};else trackEvent={key:tracking[0]}}else if("custom"==this.trackers[tracker].type&&this.trackers[tracker].parse)trackEvent=this.trackers[tracker].parse.apply(this,tracking);if(trackEvent)if(handler)this.trackers[tracker].queue.push(["send",trackEvent,handler]);else this.trackers[tracker].queue.push(trackEvent)}this.logger.info.apply(this.logger,tracking)}};var external=function(options){return new MultiTracker(options)};return external};if("function"==typeof define&&define.amd)define("js/lib/multitracker",["underscore","js/lib/json2"],function(_){return module(_)});else wndw.MultiTracker=module(wndw._)}(window),define("js/lib/metatags",["jquery","underscore"],function($,_){function nameToType(name){return nameToTypeMapping[name]||"name"}function select(name){return $("meta["+nameToType(name)+"='"+name+"']")}function stripTags(str){return(str||"").replace(/<\w+(\s+("[^"]*"|'[^']*'|[^>])+)?>|<\/\w+>/gi,"")}function setMetaTag(name,value){var $metaTag=select(name);if(0===$metaTag.length){var metaHtml="<meta "+nameToType(name)+'="'+name+'" />';$metaTag=$(metaHtml).appendTo("head")}$metaTag.attr("content",stripTags(value))}function set(name,value){if("object"==typeof name)_.each(name,function(val,key){setMetaTag(key,val)});else setMetaTag(name,value)}function share(title,image,description,url){set({"og:title":title,"og:url":url,"og:image":image,"og:site_name":title,"og:description":description,description:description,image:image})}function setDocumentDefault(){set({"og:title":document.title,"og:url":window.location.href,"og:site_name":document.title,name:document.title})}function clear(name){var $metaTag=select(name);$metaTag.remove()}var nameToTypeMapping={"og:title":"property","og:url":"property","og:image":"property","og:site_name":"property","og:description":"property",description:"name",image:"name"};return{set:set,setDocumentDefault:setDocumentDefault,clear:clear,share:share}}),define("js/lib/language",["jquery","underscore"],function($,_){function shortenLanguageCode(code){return(normalizeLanguageCode(code)||"").split("-")[0]}function languageCodeCSVtoLanguages(csv){var subtitlesLangs=_.compact((csv||"").split(/,\s*/g));return _.reduce(subtitlesLangs,function(memo,code){return memo[code]=languageCodeToName(code),memo},{})}function isRightToLeft(language){var rightToLeftLanguages=["ar","he"];return _.contains(rightToLeftLanguages,shortenLanguageCode(language))}function languageCodeToName(code){code=normalizeLanguageCode(code||"");var components=code.split("-"),language,languageMappingExists=_.any(components,function(c,i){var codeToTest=components.slice(0,components.length-i).join("-");return language=languageCodeToNameObj[codeToTest],!!language});return languageMappingExists?language:code}function normalizeLanguageCode(languageCode){var code=(languageCode||"").toLowerCase().replace(/_/g,"-");return code.split(/[;=,]/)[0]}function getLanguageCode(){var code;try{code=window.require.s.contexts._.config.config.i18n.locale}catch(e){code=normalizeLanguageCode($("#_require").attr("data-locale"))||"en"}return code}function latinizeText(string){return string.replace(/[^A-Za-z0-9\[\] ]/g,function(a){return LATIN_MAP[a]||a})}var languageCodeToNameObj={ab:"Abkhaz",aa:"Afar",af:"Afrikaans",ak:"Akan",sq:"Albanian",am:"Amharic",ar:"Arabic",an:"Aragonese",hy:"Armenian",as:"Assamese",av:"Avaric",ae:"Avestan",ay:"Aymara",az:"Azerbaijani",bm:"Bambara",ba:"Bashkir",eu:"Basque",be:"Belarusian",bn:"Bengali",bh:"Bihari",bi:"Bislama",bs:"Bosnian",br:"Breton",bg:"Bulgarian",my:"Burmese",ca:"Catalan",ch:"Chamorro",ce:"Chechen",ny:"Chichewa",zh:"Chinese","zh-cn":"Chinese (Simplified)","zh-tw":"Chinese (Traditional)",cv:"Chuvash",kw:"Cornish",co:"Corsican",cr:"Cree",hr:"Croatian",cs:"Czech",da:"Danish",dv:"Divehi",nl:"Dutch",dz:"Dzongkha",en:"English",eo:"Esperanto",et:"Estonian",ee:"Ewe",fo:"Faroese",fj:"Fijian",fi:"Finnish",fr:"French",ff:"Fula",gl:"Galician",ka:"Georgian",de:"German",el:"Greek",gn:"Guaraní",gu:"Gujarati",ht:"Haitian",ha:"Hausa",he:"Hebrew",hz:"Herero",hi:"Hindi",ho:"Hiri Motu",hu:"Hungarian",ia:"Interlingua",id:"Indonesian",ie:"Interlingue",ga:"Irish",ig:"Igbo",ik:"Inupiaq",io:"Ido",is:"Icelandic",it:"Italian",iu:"Inuktitut",ja:"Japanese",jv:"Javanese",kl:"Kalaallisut",kn:"Kannada",kr:"Kanuri",ks:"Kashmiri",kk:"Kazakh",km:"Khmer",ki:"Kikuyu",rw:"Kinyarwanda",ky:"Kyrgyz",kv:"Komi",kg:"Kongo",ko:"Korean",ku:"Kurdish",kj:"Kwanyama",la:"Latin",lb:"Luxembourgish",lg:"Ganda",li:"Limburgish",ln:"Lingala",lo:"Lao",lt:"Lithuanian",lu:"Luba-Katanga",lv:"Latvian",gv:"Manx",mk:"Macedonian",mg:"Malagasy",ms:"Malay",ml:"Malayalam",mt:"Maltese",mi:"Māori",mr:"Marathi",mh:"Marshallese",mn:"Mongolian",na:"Nauru",nv:"Navajo",nb:"Norwegian Bokmål",nd:"North Ndebele",ne:"Nepali",ng:"Ndonga",nn:"Norwegian Nynorsk",no:"Norwegian",ii:"Nuosu",nr:"South Ndebele",oc:"Occitan",oj:"Ojibwe",cu:"Old Church Slavonic",om:"Oromo",or:"Oriya",os:"Ossetian",pa:"Panjabi",pi:"Pāli",fa:"Persian",pl:"Polish",ps:"Pashto",pt:"Portuguese","pt-br":"Portuguese (Brazilian)",qu:"Quechua",rm:"Romansh",rn:"Kirundi",ro:"Romanian",ru:"Russian",sa:"Sanskrit",sc:"Sardinian",sd:"Sindhi",se:"Northern Sami",sm:"Samoan",sg:"Sango",sr:"Serbian",gd:"Gaelic",sn:"Shona",si:"Sinhala",sk:"Slovak",sl:"Slovene",so:"Somali",st:"Southern Sotho",es:"Spanish",su:"Sundanese",sw:"Swahili",ss:"Swati",sv:"Swedish",ta:"Tamil",te:"Telugu",tg:"Tajik",th:"Thai",ti:"Tigrinya",bo:"Tibetan",tk:"Turkmen",tl:"Tagalog",tn:"Tswana",to:"Tonga",tr:"Turkish",ts:"Tsonga",tt:"Tatar",tw:"Twi",ty:"Tahitian",ug:"Uighur",uk:"Ukrainian",ur:"Urdu",uz:"Uzbek",ve:"Venda",vi:"Vietnamese",vo:"Volapük",wa:"Walloon",cy:"Welsh",wo:"Wolof",fy:"Western Frisian",xh:"Xhosa",yi:"Yiddish",yo:"Yoruba",za:"Zhuang",zu:"Zulu"},LATIN_MAP={A:"Á Ă Ắ Ặ Ằ Ẳ Ẵ Ǎ Â Ấ Ậ Ầ Ẩ Ẫ Ä Ǟ Ȧ Ǡ Ạ Ȁ À Ả Ȃ Ā Ą Å Ǻ Ḁ Ⱥ Ã Ɐ ᴀ",AA:"Ꜳ",AE:"Æ Ǽ Ǣ ᴁ",AO:"Ꜵ",AU:"Ꜷ",AV:"Ꜹ Ꜻ",AY:"Ꜽ",B:"Ḃ Ḅ Ɓ Ḇ Ƀ Ƃ ʙ ᴃ",C:"Ć Č Ç Ḉ Ĉ Ċ Ƈ Ȼ Ꜿ ᴄ",D:"Ď Ḑ Ḓ Ḋ Ḍ Ɗ Ḏ ǲ ǅ Đ Ƌ Ꝺ ᴅ",DZ:"Ǳ Ǆ",E:"É Ĕ Ě Ȩ Ḝ Ê Ế Ệ Ề Ể Ễ Ḙ Ë Ė Ẹ Ȅ È Ẻ Ȇ Ē Ḗ Ḕ Ę Ɇ Ẽ Ḛ Ɛ Ǝ ᴇ ⱻ",ET:"Ꝫ",F:"Ḟ Ƒ Ꝼ ꜰ",G:"Ǵ Ğ Ǧ Ģ Ĝ Ġ Ɠ Ḡ Ǥ Ᵹ ɢ ʛ",H:"Ḫ Ȟ Ḩ Ĥ Ⱨ Ḧ Ḣ Ḥ Ħ ʜ",I:"Í Ĭ Ǐ Î Ï Ḯ İ Ị Ȉ Ì Ỉ Ȋ Ī Į Ɨ Ĩ Ḭ ɪ",R:"Ꞃ Ŕ Ř Ŗ Ṙ Ṛ Ṝ Ȑ Ȓ Ṟ Ɍ Ɽ ʁ ʀ ᴙ ᴚ",S:"Ꞅ Ś Ṥ Š Ṧ Ş Ŝ Ș Ṡ Ṣ Ṩ ꜱ",T:"Ꞇ Ť Ţ Ṱ Ț Ⱦ Ṫ Ṭ Ƭ Ṯ Ʈ Ŧ ᴛ",IS:"Ꝭ",J:"Ĵ Ɉ ᴊ",K:"Ḱ Ǩ Ķ Ⱪ Ꝃ Ḳ Ƙ Ḵ Ꝁ Ꝅ ᴋ",L:"Ĺ Ƚ Ľ Ļ Ḽ Ḷ Ḹ Ⱡ Ꝉ Ḻ Ŀ Ɫ ǈ Ł Ꞁ ʟ ᴌ",LJ:"Ǉ",M:"Ḿ Ṁ Ṃ Ɱ Ɯ ᴍ",N:"Ń Ň Ņ Ṋ Ṅ Ṇ Ǹ Ɲ Ṉ Ƞ ǋ Ñ ɴ ᴎ",NJ:"Ǌ",O:"Ó Ŏ Ǒ Ô Ố Ộ Ồ Ổ Ỗ Ö Ȫ Ȯ Ȱ Ọ Ő Ȍ Ò Ỏ Ơ Ớ Ợ Ờ Ở Ỡ Ȏ Ꝋ Ꝍ Ō Ṓ Ṑ Ɵ Ǫ Ǭ Ø Ǿ Õ Ṍ Ṏ Ȭ Ɔ ᴏ ᴐ",OI:"Ƣ",OO:"Ꝏ",OU:"Ȣ ᴕ",P:"Ṕ Ṗ Ꝓ Ƥ Ꝕ Ᵽ Ꝑ ᴘ",Q:"Ꝙ Ꝗ",V:"Ʌ Ꝟ Ṿ Ʋ Ṽ ᴠ",TZ:"Ꜩ",U:"Ú Ŭ Ǔ Û Ṷ Ü Ǘ Ǚ Ǜ Ǖ Ṳ Ụ Ű Ȕ Ù Ủ Ư Ứ Ự Ừ Ử Ữ Ȗ Ū Ṻ Ų Ů Ũ Ṹ Ṵ ᴜ",VY:"Ꝡ",W:"Ẃ Ŵ Ẅ Ẇ Ẉ Ẁ Ⱳ ᴡ",X:"Ẍ Ẋ",Y:"Ý Ŷ Ÿ Ẏ Ỵ Ỳ Ƴ Ỷ Ỿ Ȳ Ɏ Ỹ ʏ",Z:"Ź Ž Ẑ Ⱬ Ż Ẓ Ȥ Ẕ Ƶ ᴢ",IJ:"Ĳ",OE:"Œ ɶ",a:"á ă ắ ặ ằ ẳ ẵ ǎ â ấ ậ ầ ẩ ẫ ä ǟ ȧ ǡ ạ ȁ à ả ȃ ā ą ᶏ ẚ å ǻ ḁ ⱥ ã ɐ ₐ",aa:"ꜳ",ae:"æ ǽ ǣ ᴂ",ao:"ꜵ",au:"ꜷ",av:"ꜹ ꜻ",ay:"ꜽ",b:"ḃ ḅ ɓ ḇ ᵬ ᶀ ƀ ƃ",o:"ɵ ó ŏ ǒ ô ố ộ ồ ổ ỗ ö ȫ ȯ ȱ ọ ő ȍ ò ỏ ơ ớ ợ ờ ở ỡ ȏ ꝋ ꝍ ⱺ ō ṓ ṑ ǫ ǭ ø ǿ õ ṍ ṏ ȭ ɔ ᶗ ᴑ ᴓ ₒ",c:"ć č ç ḉ ĉ ɕ ċ ƈ ȼ ↄ ꜿ",d:"ď ḑ ḓ ȡ ḋ ḍ ɗ ᶑ ḏ ᵭ ᶁ đ ɖ ƌ ꝺ",i:"ı í ĭ ǐ î ï ḯ ị ȉ ì ỉ ȋ ī į ᶖ ɨ ĩ ḭ ᴉ ᵢ",j:"ȷ ɟ ʄ ǰ ĵ ʝ ɉ ⱼ",dz:"ǳ ǆ",e:"é ĕ ě ȩ ḝ ê ế ệ ề ể ễ ḙ ë ė ẹ ȅ è ẻ ȇ ē ḗ ḕ ⱸ ę ᶒ ɇ ẽ ḛ ɛ ᶓ ɘ ǝ ₑ",et:"ꝫ",f:"ḟ ƒ ᵮ ᶂ ꝼ",g:"ǵ ğ ǧ ģ ĝ ġ ɠ ḡ ᶃ ǥ ᵹ ɡ ᵷ",h:"ḫ ȟ ḩ ĥ ⱨ ḧ ḣ ḥ ɦ ẖ ħ ɥ ʮ ʯ",hv:"ƕ",r:"ꞃ ŕ ř ŗ ṙ ṛ ṝ ȑ ɾ ᵳ ȓ ṟ ɼ ᵲ ᶉ ɍ ɽ ɿ ɹ ɻ ɺ ⱹ ᵣ",s:"ꞅ ſ ẜ ẛ ẝ ś ṥ š ṧ ş ŝ ș ṡ ṣ ṩ ʂ ᵴ ᶊ ȿ",t:"ꞇ ť ţ ṱ ț ȶ ẗ ⱦ ṫ ṭ ƭ ṯ ᵵ ƫ ʈ ŧ ʇ",is:"ꝭ",k:"ḱ ǩ ķ ⱪ ꝃ ḳ ƙ ḵ ᶄ ꝁ ꝅ ʞ",l:"ĺ ƚ ɬ ľ ļ ḽ ȴ ḷ ḹ ⱡ ꝉ ḻ ŀ ɫ ᶅ ɭ ł ꞁ",lj:"ǉ",m:"ḿ ṁ ṃ ɱ ᵯ ᶆ ɯ ɰ",n:"ń ň ņ ṋ ȵ ṅ ṇ ǹ ɲ ṉ ƞ ᵰ ᶇ ɳ ñ",nj:"ǌ",oi:"ƣ",oo:"ꝏ",ou:"ȣ",p:"ṕ ṗ ꝓ ƥ ᵱ ᶈ ꝕ ᵽ ꝑ",q:"ꝙ ʠ ɋ ꝗ",u:"ᴝ ú ŭ ǔ û ṷ ü ǘ ǚ ǜ ǖ ṳ ụ ű ȕ ù ủ ư ứ ự ừ ử ữ ȗ ū ṻ ų ᶙ ů ũ ṹ ṵ ᵤ",th:"ᵺ",oe:"ᴔ œ",v:"ʌ ⱴ ꝟ ṿ ʋ ᶌ ⱱ ṽ ᵥ",w:"ʍ ẃ ŵ ẅ ẇ ẉ ẁ ⱳ ẘ",y:"ʎ ý ŷ ÿ ẏ ỵ ỳ ƴ ỷ ỿ ȳ ẙ ɏ ỹ",tz:"ꜩ",ue:"ᵫ",um:"ꝸ",vy:"ꝡ",x:"ẍ ẋ ᶍ ₓ",z:"ź ž ẑ ʑ ⱬ ż ẓ ȥ ẕ ᵶ ᶎ ʐ ƶ ɀ",ff:"ﬀ",ffi:"ﬃ",ffl:"ﬄ",fi:"ﬁ",fl:"ﬂ",ij:"ĳ",st:"ﬆ"};return LATIN_MAP=_.chain(LATIN_MAP).map(function(value,key){return _.map(value.split(" "),function(v){return[v,key]})}).flatten(!0).reduce(function(memo,pair){return memo[pair[0]]=pair[1],memo},{}).value(),{shortenLanguageCode:shortenLanguageCode,languageCodeCSVtoLanguages:languageCodeCSVtoLanguages,languageCodeToName:languageCodeToName,latinizeText:latinizeText,isRightToLeft:isRightToLeft,normalizeLanguageCode:normalizeLanguageCode,getLanguageCode:getLanguageCode}}),define("js/lib/nls/moment.lang",{es:!0,fr:!0,pt:!0,ru:!0,zh:!0,"zh-hk":"zh-tw","zh-mo":"zh-tw","zh-tw":!0}),define("js/lib/nls/root/moment.lang",["js/lib/moment"],function(moment){moment.lang("en")}),define("js/core/coursera",["js/core/origami","js/core/config","jquery","underscore","backbone","js/lib/supports","js/lib/third-parties","js/lib/log","js/lib/multitracker","js/lib/metatags","js/lib/language","js/lib/moment","i18n!js/lib/nls/moment.lang"],function(Origami,config,$,_,Backbone,supports,thirdparty,Logger,MultiTracker,metatags,language,moment){moment.lang(language.getLanguageCode());var Coursera=new Origami("#origami");if(Coursera.config=config,Coursera.supports=supports,Coursera.log=Logger({level:config.log}),window.onerror=function(message,url,lineNum){if(url=url||window.location.href,void 0!==lineNum&&null!=lineNum){if(message.target&&message.type)message=message.type;if(!message.indexOf)message="Non-string, non-event error: "+typeof message;var errorDescrip={message:message,script:url,line:lineNum,url:document.URL};Coursera.multitracker.push(["page.error.javascript",errorDescrip])}},"production"==config.environment)requirejs.onError=function(Error){Coursera.multitracker.push(["page.error.requirejs",{url:location.href,message:Error.message,type:Error.requireType,modules:Error.requireModules}]),Coursera.log.error(Error);var match=Error.message.match(/context:\s*(.*)\s*\n/);if(match&&"_"==match[1]){var message="<div>oooops! something unexpected happened, please <a href='"+location.href+"'>refresh</a> your browser</div>",$screen=$("<div>").addClass("fullscreen");Coursera.message.add($(message).addClass("message")),$screen.appendTo("body").show()}};return Coursera.multitracker=MultiTracker({logger:Coursera.log}),Coursera.multitracker.register("204",[]),Coursera.multitracker.register("ga",window._gaq=[],"google"),$(document).ready(function(){if(/staging|production/.test(Coursera.config.environment))requirejs.config({context:"204js",paths:{_204:"https://eventing.coursera.org/204.min"}})(["_204"],function(_204){if(_204){for(var parts=location.host.split(".");parts.length>2;)parts.shift();Coursera.multitracker.get("204").queue.push(["domain","."+parts.join(".")]),Coursera.multitracker.get("204").queue=_204.batch(Coursera.multitracker.get("204").queue)}}),Coursera.multitracker.get("ga").queue.push(["_setAccount","UA-28377374-1"],["_setDomainName","coursera.org"],["_setAllowLinker",!0],["_trackPageview"]),thirdparty.loadScript(("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js",function(){Coursera.multitracker.get("ga").queue=window._gaq});var routerEvent="0.9.2"==Backbone.VERSION?"all":"route";Coursera.router.on(routerEvent,function(){var currentURL=Coursera.config.dir.home+Backbone.history.getFragment();metatags.share("Coursera","http://s3.amazonaws.com/coursera/media/Coursera_Computer_Narrow.png","Take free online classes from 80+ top universities and organizations. Coursera is a social entrepreneurship company partnering with Stanford University, Yale University, Princeton University and others around the world to offer courses online for anyone to take, for free. We believe in connecting people to a great education so that anyone around the world can learn without limits.",currentURL),Coursera.multitracker.push(["pageview",currentURL])});var $window=$(window),scrollTracker=function(){var source=_.compact((window.location.pathname||"").split("/")).join("-")||"homepage";Coursera.multitracker.push(["user.scroll."+source,$window.scrollTop()])};$window.scroll(_.throttle(scrollTracker,2e3))}),Coursera}),define("js/lib/util",["jquery","underscore","js/lib/moment","js/lib/cookie","js/core/coursera"],function($,_,moment,cookie,Coursera){function handleAPIError(err,requestUrl){if(404==err)Coursera.router.trigger("error",404,requestUrl,{message:"this page does not exist"});else if(500==err)Coursera.router.trigger("error",500,requestUrl,{message:"backend server has seen an error"});else if(401==err)location.href=Coursera.config.url.accounts+"signin?post_redirect="+page;else if(403==err)Coursera.router.trigger("error",403,requestUrl,{message:"you do not have permission to view this page"})}function handleRedirect(redirect){if(!redirect)return;var parse=/^(?:https?:\/\/)?((?:[\d\w\-]+?\.)?[\w\d-]+(?:\.[\w]+)?)(\/.*|$)/,parts=parse.exec(redirect),host=(parts&&parts.length?parts[1]:"").split("."),hostm=parse.exec(location.host)[1].split(".");if(host&&host.length&&host[host.length-1]==hostm[hostm.length-1]&&host[host.length-2]==hostm[hostm.length-2])location.href=redirect;else if(/^\/.*/.test(redirect))location.href=redirect;else Coursera.router.navigate(Coursera.config.dir.home,!0)}function redirectToAccounts(page){location.href=Coursera.config.url.accounts+page}function createAccountsUrl(page,params){if(void 0!==params){if(void 0!==params.r)params.post_redirect=params.r,delete params.r;var urlParams=$.param(params);return Coursera.config.url.accounts+page+"?"+urlParams.split("+").join("%20")}return Coursera.config.url.accounts+page}function scrollToInternalLink($dom,section){var $target=$dom.find('[data-section="'+section+'"]');if(!$target.length)return;var newTop=$target.position().top,scrollDiff=Math.abs($(document).scrollTop()-newTop);if(scrollDiff>1e3)$("html,body").scrollTop(newTop);else $("html,body").animate({scrollTop:newTop});if(Coursera.multitracker)Coursera.multitracker.push([document.title.split(" |")[0]+" "+section,"Open"])}function setupInternalLinks(view){view.bind("view:appended",function(){scrollToInternalLink(view.$el,this.options.section)}),view.$el.on("click","a.internal-page",function(e){if(!e.ctrlKey&&!e.metaKey){var linkPath=e.currentTarget.pathname,section=linkPath.substr(linkPath.lastIndexOf("/")+1);if(view.$("[data-section="+section+"]").length)e.preventDefault(),scrollToInternalLink(view.$el,section),Coursera.router.navigateTo(linkPath,{trigger:!1})}})}function getToday(){return new Date}function prettyJoin(items){if(items)if(items.length>1)return items.slice(0,-1).join(", ")+" and "+items[items.length-1];else return items.toString()}function addCommas(numberStr){return numberStr.replace(/(^|[^\w.])(\d{4,})/g,function($0,$1,$2){return $1+$2.replace(/\d(?=(?:\d\d\d)+(?!\d))/g,"$&,")})}function makeHttps(url){return url.replace(/^http:\/\//i,"https://")}function getUrlParam(url,name){name=name.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var regexS="[\\?&]"+name+"=([^&#]*)",regex=new RegExp(regexS),results=regex.exec(unescape(url));if(null===results)return null;else return results[1]}function changeUrlParam(uri,key,value){var re=new RegExp("([?&])"+key+"=[^&]*(&|$)","i");if(separator=-1!==uri.indexOf("?")?"&":"?",uri.match(re))return uri.replace(re,"$1"+key+"="+value+"$2");else return uri+separator+key+"="+value}function getUrlPath(url){return(url||"").replace(Coursera.config.url.base,"/")}function setupFormSave($form,xhrOptions,autoSave){function changeButtonText(message){var messageText=$saveButton.attr("data-"+message+"-message");$saveButton.html(messageText)}function resetButton(){var $requiredCheckboxes=$form.find('input[type="checkbox"]').filter("[required]");if($requiredCheckboxes.length&&!$requiredCheckboxes.is(":checked"))return void $saveButton.attr("disabled","disabled");$saveButton.removeAttr("disabled"),changeButtonText("default")}function sendXHR(){lastFormData=$form.serialize();var type=(xhrOptions.type||"POST").toLowerCase();if(Coursera.api[type])Coursera.api[type](xhrOptions.url,{data:xhrOptions.data||$form.serialize()||null,headers:xhrOptions.headers||{},dataType:xhrOptions.dataType||"json"}).done(function(responseJSON,textStatus,xhr){if(xhrOptions.success)xhrOptions.success(responseJSON,textStatus,xhr);changeButtonText("success"),$saveStatus.html("(Saved!)"),renderAllErrors($form,null)}).fail(function(xhr,textStatus,errorThrown){var data=$.parseJSON(xhr.responseText);if(xhrOptions.error)xhrOptions.error(xhr,textStatus,errorThrown);resetButton(),$form.find("input").off(".validate"),renderAllErrors($form,data)})}function triggerSave(){if($form.serialize()!=lastFormData)$saveButton.trigger("click"),$saveStatus.html("(Saving...)")}xhrOptions=xhrOptions||{};var lastFormData=$form.serialize();xhrOptions.url=xhrOptions.url||$form.attr("action"),xhrOptions.type=xhrOptions.type||$form.attr("type");var $saveButton=$form.find('button[type="submit"]'),$saveStatus=$($saveButton.attr("data-update"));$form.find("input, select").on("change",resetButton),$form.find("input, textarea").on("keyup",resetButton);var $allInputs=$form.find("input, select");$allInputs.each(function(ind,elem){if(ind!=$allInputs.length-1)$(elem).on("keypress",function(event){return 13!=event.keyCode})});var shouldValidateForm="true"==$form.attr("data-validate");if(shouldValidateForm)$form.find("input").each(function(){var $field=$(this);if("checkbox"==$field.attr("type"))return;$field.on("keyup.validate",function(){if(!validateField($field))renderFieldErrors($field,null)}),$field.on("blur.validate paste.validate",function(){renderFieldErrors($field,validateField($field))})});if($saveButton.on("click",function(event){if(event.preventDefault(),!shouldValidateForm||shouldValidateForm&&!validateForm($form))changeButtonText("inflight"),$saveButton.attr("disabled","disabled"),sendXHR(xhrOptions)}),autoSave){var triggerSaveD=_.debounce(triggerSave,1e3);$form.find("input, select").on("change.autosave",triggerSaveD),$form.find("input, textarea").on("keyup.autosave",triggerSaveD),$form.find("input, select, blur").on("blur.autosave paste.autosave",triggerSave)}}function validateForm($form){var foundError=null;if($form.find("input").each(function(){var $field=$(this),fieldError=validateField($field);if(renderFieldErrors($field,fieldError),foundError=foundError||fieldError,fieldError&&!foundError&&0===$("input:focus").length)$field.focus()}),foundError){var invalidMessage=$form.attr("data-invalid-message")||"Uh-oh, please check the form!";renderFormError($form,invalidMessage),$form.find('button[type="submit"]').animate({opacity:.4},100).animate({"margin-left":"-=10"},100).animate({"margin-left":"+=20"},100).animate({"margin-left":"-=20"},100).animate({"margin-left":"+=10"},100).animate({opacity:1},100)}return foundError}function validateField($field){var fieldType=$field.attr("type"),fieldValue=$field.val(),fieldPattern=$field.attr("pattern"),error=null,regEx=null;if("email"==fieldType)regEx=new RegExp(/[a-zA-Z0-9!#$%&'*+\/=?\^_`{|}~\-]+(?:\.[a-zA-Z0-9!#$%&'*+\/=?\^_`{|}~\-]+)*@(?:[a-zA-Z0-9](?:[a-zA-Z0-9\-]*[a-zA-Z0-9])?\.)+[a-zA-Z0-9](?:[a-zA-Z0-9\-]*[a-zA-Z0-9])?/);else if(fieldPattern)regEx=new RegExp(fieldPattern);if(regEx)if(!regEx.test(fieldValue))error=$field.attr("data-invalid-message")||"Invalid field";if($field.attr("required")){if("text"==fieldType&&0===fieldValue.length)error="This field is required.";if("checkbox"==fieldType&&!$field.is(":checked"))error="⬆ Please check this!"}return error}function renderAllErrors($form,data){var $errorsDom;if($form.find(".form-errors").remove(),$form.find(".error .help-inline").remove(),$form.find(".error").removeClass("error"),!data)return;if(data.error_message)renderFormError($form,data.error_message);if(data.field_errors)for(var fieldName in data.field_errors){var $fieldDom=$form.find('*[name="'+fieldName+'"]');renderFieldErrors($fieldDom,data.field_errors[fieldName]),$fieldDom.focus()}}function renderFormError($form,error){if($form.find(".form-errors").remove(),$errorsDom=$("<span></span>").addClass("form-errors").attr("role","alert").attr("aria-live","assertive").html(error),$form.find(".actions").length)$form.find(".actions").children(":last").after($errorsDom);else if($form.find(".modal-footer").length)$form.find(".modal-footer").children(":last").after($errorsDom);else if($form.find('button[type="submit"]'))$form.find('button[type="submit"]').after($errorsDom)}function renderFieldErrors($fieldDom,fieldErrors){var $parentGroup=$fieldDom.parents(".control-mini-group").length&&$fieldDom.parents(".control-mini-group")||$fieldDom.parents(".control-group");if($parentGroup.removeClass("error"),$parentGroup.find(".help-inline.error").remove(),fieldErrors){var errorId=($fieldDom.attr("id")||"")+"-form-field-error-"+(new Date).getTime(),describedBy=($fieldDom.attr("aria-describedby")||"").split(",");if(describedBy.push(errorId),$fieldDom.attr("aria-describedby",describedBy.join(",")),$errorsDom=$("<span></span>").addClass("help-inline error").attr("role","alert").attr("aria-live","assertive").attr("id",errorId),fieldErrors instanceof Array)for(var i=0;i<fieldErrors.length;i++)$errorsDom.append("<span>"+fieldErrors[i]+"</span>");else $errorsDom.append(fieldErrors);if($parentGroup.addClass("error"),"checkbox"==$fieldDom.attr("type"))$parentGroup.find(".controls").append($errorsDom);else $fieldDom.after($errorsDom)}}function isMobileDevice(){var ua=navigator.userAgent||navigator.vendor||window.opera;return/iPhone|iPod|iPad|Android|BlackBerry|Opera Mini|IEMobile/.test(ua)}function isIOS(){var ua=navigator.userAgent||navigator.vendor||window.opera;return/iPhone|iPod|iPad/.test(ua)}function isTouchSupported(){return"ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch}function isCanvasSupported(){var elem=document.createElement("canvas");return!(!elem.getContext||!elem.getContext("2d"))}function getViewportHeight(){var height=window.innerHeight,mode=document.compatMode;if(mode||!$.support.boxModel)height="CSS1Compat"==mode?document.documentElement.clientHeight:document.body.clientHeight;return height}function inView($elem,nearThreshold){nearThreshold=nearThreshold||0;var viewportHeight=getViewportHeight(),scrollTop=document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop,startRange=scrollTop-nearThreshold,endRange=scrollTop+viewportHeight+nearThreshold,elemTop=$elem.offset().top,elemHeight=$elem.height(),elemBottom=elemTop+elemHeight;return endRange>elemBottom&&elemBottom>startRange}function countCS(courses){var numCS=0,csCats=["cs-programming","cs-systems","cs-theory","cs-ai","cs","fmgb"];return courses.each(function(course){if(course.get("topic")&&_.intersection(course.get("topic").get("category-ids"),csCats).length>0)numCS++}),numCS}function setupPromos(){var $promos=$("[data-promo-id]");$promos.each(function(){var $promo=$(this);if($promo.find(".close").length){var promoId=$promo.attr("data-promo-id");if(cookie.get(promoId))$promo.hide();else $promo.show(),$promo.find(".close").on("click",function(){$promo.hide(),cookie.set(promoId,"closed")})}})}function prettifyTime($dom){var dateTime=moment.unix($dom.attr("datetime"));if(Math.abs(moment().diff(dateTime))<6e4)$dom.text("just now");else $dom.text(dateTime.fromNow());$dom.attr("title",dateTime.format("dddd, MMMM Do YYYY, h:mm a Z"))}function prettifyUrl(url){return url=url.replace(/^.*:\/\//,""),url=url.replace(/\/$/,"")}function extractFirstSubdir(url){var urlRegex=/(.*\/).*\//;return urlRegex.exec(url)[1]}function linkifyText(string){if(string)string=string.replace(/((https?\:\/\/)|(www\.))(\S+)(\w{2,4})(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/gi,function(url){var full_url=url;if(!full_url.match("^https?://"))full_url="http://"+full_url;return'<a target="_blank" href="'+full_url+'">'+url+"</a>"});return string}function rgbToHsl(r,g,b){r/=255,g/=255,b/=255;var max=Math.max(r,g,b),min=Math.min(r,g,b),h,s,l=(max+min)/2;if(max==min)h=s=0;else{var d=max-min;switch(s=l>.5?d/(2-max-min):d/(max+min),max){case r:h=(g-b)/d+(b>g?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4}h/=6}return[h,s,l]}function hslToRgb(h,s,l){var r,g,b;if(0===s)r=g=b=l;else{var hue2rgb=function(p,q,t){if(0>t)t+=1;if(t>1)t-=1;if(1/6>t)return p+6*(q-p)*t;if(.5>t)return q;if(2/3>t)return p+(q-p)*(2/3-t)*6;return p},q=.5>l?l*(1+s):l+s-l*s,p=2*l-q;r=hue2rgb(p,q,h+1/3),g=hue2rgb(p,q,h),b=hue2rgb(p,q,h-1/3)}return[Math.round(255*r),Math.round(255*g),Math.round(255*b)]}function rgbToHsv(r,g,b){r/=255,g/=255,b/=255;var max=Math.max(r,g,b),min=Math.min(r,g,b),h,s,v=max,d=max-min;if(s=0===max?0:d/max,max==min)h=0;else{switch(max){case r:h=(g-b)/d+(b>g?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4}h/=6}return[h,s,v]}function hsvToRgb(h,s,v){var r,g,b,i=Math.floor(6*h),f=6*h-i,p=v*(1-s),q=v*(1-f*s),t=v*(1-(1-f)*s);switch(i%6){case 0:r=v,g=t,b=p;break;case 1:r=q,g=v,b=p;break;case 2:r=p,g=v,b=t;break;case 3:r=p,g=q,b=v;break;case 4:r=t,g=p,b=v;break;case 5:r=v,g=p,b=q}return[Math.round(255*r),Math.round(255*g),Math.round(255*b)]}function sortedGroupBy(list,groupByIter,sortByIter){var groups=_.groupBy(list,groupByIter);return groups=_.sortBy(groups,sortByIter)}function splitIntoGroups(list,nGroups){var groups=[];if(!list)return groups;for(var groupSize=Math.ceil(list.length/nGroups),i=0;i<list.length;i+=groupSize)groups.push(list.slice(i,i+groupSize));return groups}function verticalCenterEl($container,$el){$el.css("position","relative"),$el.css("top",$container.height()/2-$el.height()/2)}function concatName(nameObj){var full_name=nameObj.first_name;if(nameObj.middle_name)full_name=full_name+" "+nameObj.middle_name;if(nameObj.last_name)full_name=full_name+" "+nameObj.last_name;return full_name}function removeDiacritics(str){for(var i=0;i<defaultDiacriticsRemovalMap.length;i++)str=str.replace(defaultDiacriticsRemovalMap[i].letters,defaultDiacriticsRemovalMap[i].base);return str}function getCourseName(home_link){if(!_.isString(home_link))return null;var regexp=new RegExp("^https://([^.]+)\\.[^.]+\\.org/(.*)$"),match=regexp.exec(home_link);if(null===match)return null;else return{courseDomain:match[1],courseName:match[2]}}function isChina(){var subdomain=window.location.hostname.split(".")[0];return["cn","staging-china"].indexOf(subdomain)>=0}function styleRightToLeft($el){$el.find("[data-user-generated]").attr("dir","auto"),$el.find("[data-user-generated] code").attr("dir","ltr"),$el.find("[data-user-generated] > ol,ul").attr("dir","rtl"),$el.find("[data-user-generated] a,li").wrapInner("<bdi></bdi>")}function makeCheckCertFn(filename){return function(universityShortName){var deferred=$.Deferred();if(universityShortName=universityShortName||"_generic",universityShortName in ST_CERT_CACHE){if(ST_CERT_CACHE[universityShortName])deferred.resolve("https://s3.amazonaws.com/coursera/universities/"+universityShortName+"/"+filename);
else deferred.resolve("https://s3.amazonaws.com/coursera/universities/_generic/"+filename);return deferred}var img=new Image;return img.onload=function(){ST_CERT_CACHE[universityShortName]=!0,deferred.resolve("https://s3.amazonaws.com/coursera/universities/"+universityShortName+"/"+filename)},img.onerror=function(){ST_CERT_CACHE[universityShortName]=!1,deferred.resolve("https://s3.amazonaws.com/coursera/universities/_generic/"+filename)},img.src="https://s3.amazonaws.com/coursera/universities/"+universityShortName+"/"+filename,deferred}}var defaultDiacriticsRemovalMap=[{base:"A",letters:/[\u0041\u24B6\uFF21\u00C0\u00C1\u00C2\u1EA6\u1EA4\u1EAA\u1EA8\u00C3\u0100\u0102\u1EB0\u1EAE\u1EB4\u1EB2\u0226\u01E0\u00C4\u01DE\u1EA2\u00C5\u01FA\u01CD\u0200\u0202\u1EA0\u1EAC\u1EB6\u1E00\u0104\u023A\u2C6F]/g},{base:"AA",letters:/[\uA732]/g},{base:"AE",letters:/[\u00C6\u01FC\u01E2]/g},{base:"AO",letters:/[\uA734]/g},{base:"AU",letters:/[\uA736]/g},{base:"AV",letters:/[\uA738\uA73A]/g},{base:"AY",letters:/[\uA73C]/g},{base:"B",letters:/[\u0042\u24B7\uFF22\u1E02\u1E04\u1E06\u0243\u0182\u0181]/g},{base:"C",letters:/[\u0043\u24B8\uFF23\u0106\u0108\u010A\u010C\u00C7\u1E08\u0187\u023B\uA73E]/g},{base:"D",letters:/[\u0044\u24B9\uFF24\u1E0A\u010E\u1E0C\u1E10\u1E12\u1E0E\u0110\u018B\u018A\u0189\uA779]/g},{base:"DZ",letters:/[\u01F1\u01C4]/g},{base:"Dz",letters:/[\u01F2\u01C5]/g},{base:"E",letters:/[\u0045\u24BA\uFF25\u00C8\u00C9\u00CA\u1EC0\u1EBE\u1EC4\u1EC2\u1EBC\u0112\u1E14\u1E16\u0114\u0116\u00CB\u1EBA\u011A\u0204\u0206\u1EB8\u1EC6\u0228\u1E1C\u0118\u1E18\u1E1A\u0190\u018E]/g},{base:"F",letters:/[\u0046\u24BB\uFF26\u1E1E\u0191\uA77B]/g},{base:"G",letters:/[\u0047\u24BC\uFF27\u01F4\u011C\u1E20\u011E\u0120\u01E6\u0122\u01E4\u0193\uA7A0\uA77D\uA77E]/g},{base:"H",letters:/[\u0048\u24BD\uFF28\u0124\u1E22\u1E26\u021E\u1E24\u1E28\u1E2A\u0126\u2C67\u2C75\uA78D]/g},{base:"I",letters:/[\u0049\u24BE\uFF29\u00CC\u00CD\u00CE\u0128\u012A\u012C\u0130\u00CF\u1E2E\u1EC8\u01CF\u0208\u020A\u1ECA\u012E\u1E2C\u0197]/g},{base:"J",letters:/[\u004A\u24BF\uFF2A\u0134\u0248]/g},{base:"K",letters:/[\u004B\u24C0\uFF2B\u1E30\u01E8\u1E32\u0136\u1E34\u0198\u2C69\uA740\uA742\uA744\uA7A2]/g},{base:"L",letters:/[\u004C\u24C1\uFF2C\u013F\u0139\u013D\u1E36\u1E38\u013B\u1E3C\u1E3A\u0141\u023D\u2C62\u2C60\uA748\uA746\uA780]/g},{base:"LJ",letters:/[\u01C7]/g},{base:"Lj",letters:/[\u01C8]/g},{base:"M",letters:/[\u004D\u24C2\uFF2D\u1E3E\u1E40\u1E42\u2C6E\u019C]/g},{base:"N",letters:/[\u004E\u24C3\uFF2E\u01F8\u0143\u00D1\u1E44\u0147\u1E46\u0145\u1E4A\u1E48\u0220\u019D\uA790\uA7A4]/g},{base:"NJ",letters:/[\u01CA]/g},{base:"Nj",letters:/[\u01CB]/g},{base:"O",letters:/[\u004F\u24C4\uFF2F\u00D2\u00D3\u00D4\u1ED2\u1ED0\u1ED6\u1ED4\u00D5\u1E4C\u022C\u1E4E\u014C\u1E50\u1E52\u014E\u022E\u0230\u00D6\u022A\u1ECE\u0150\u01D1\u020C\u020E\u01A0\u1EDC\u1EDA\u1EE0\u1EDE\u1EE2\u1ECC\u1ED8\u01EA\u01EC\u00D8\u01FE\u0186\u019F\uA74A\uA74C]/g},{base:"OI",letters:/[\u01A2]/g},{base:"OO",letters:/[\uA74E]/g},{base:"OU",letters:/[\u0222]/g},{base:"P",letters:/[\u0050\u24C5\uFF30\u1E54\u1E56\u01A4\u2C63\uA750\uA752\uA754]/g},{base:"Q",letters:/[\u0051\u24C6\uFF31\uA756\uA758\u024A]/g},{base:"R",letters:/[\u0052\u24C7\uFF32\u0154\u1E58\u0158\u0210\u0212\u1E5A\u1E5C\u0156\u1E5E\u024C\u2C64\uA75A\uA7A6\uA782]/g},{base:"S",letters:/[\u0053\u24C8\uFF33\u1E9E\u015A\u1E64\u015C\u1E60\u0160\u1E66\u1E62\u1E68\u0218\u015E\u2C7E\uA7A8\uA784]/g},{base:"T",letters:/[\u0054\u24C9\uFF34\u1E6A\u0164\u1E6C\u021A\u0162\u1E70\u1E6E\u0166\u01AC\u01AE\u023E\uA786]/g},{base:"TZ",letters:/[\uA728]/g},{base:"U",letters:/[\u0055\u24CA\uFF35\u00D9\u00DA\u00DB\u0168\u1E78\u016A\u1E7A\u016C\u00DC\u01DB\u01D7\u01D5\u01D9\u1EE6\u016E\u0170\u01D3\u0214\u0216\u01AF\u1EEA\u1EE8\u1EEE\u1EEC\u1EF0\u1EE4\u1E72\u0172\u1E76\u1E74\u0244]/g},{base:"V",letters:/[\u0056\u24CB\uFF36\u1E7C\u1E7E\u01B2\uA75E\u0245]/g},{base:"VY",letters:/[\uA760]/g},{base:"W",letters:/[\u0057\u24CC\uFF37\u1E80\u1E82\u0174\u1E86\u1E84\u1E88\u2C72]/g},{base:"X",letters:/[\u0058\u24CD\uFF38\u1E8A\u1E8C]/g},{base:"Y",letters:/[\u0059\u24CE\uFF39\u1EF2\u00DD\u0176\u1EF8\u0232\u1E8E\u0178\u1EF6\u1EF4\u01B3\u024E\u1EFE]/g},{base:"Z",letters:/[\u005A\u24CF\uFF3A\u0179\u1E90\u017B\u017D\u1E92\u1E94\u01B5\u0224\u2C7F\u2C6B\uA762]/g},{base:"a",letters:/[\u0061\u24D0\uFF41\u1E9A\u00E0\u00E1\u00E2\u1EA7\u1EA5\u1EAB\u1EA9\u00E3\u0101\u0103\u1EB1\u1EAF\u1EB5\u1EB3\u0227\u01E1\u00E4\u01DF\u1EA3\u00E5\u01FB\u01CE\u0201\u0203\u1EA1\u1EAD\u1EB7\u1E01\u0105\u2C65\u0250]/g},{base:"aa",letters:/[\uA733]/g},{base:"ae",letters:/[\u00E6\u01FD\u01E3]/g},{base:"ao",letters:/[\uA735]/g},{base:"au",letters:/[\uA737]/g},{base:"av",letters:/[\uA739\uA73B]/g},{base:"ay",letters:/[\uA73D]/g},{base:"b",letters:/[\u0062\u24D1\uFF42\u1E03\u1E05\u1E07\u0180\u0183\u0253]/g},{base:"c",letters:/[\u0063\u24D2\uFF43\u0107\u0109\u010B\u010D\u00E7\u1E09\u0188\u023C\uA73F\u2184]/g},{base:"d",letters:/[\u0064\u24D3\uFF44\u1E0B\u010F\u1E0D\u1E11\u1E13\u1E0F\u0111\u018C\u0256\u0257\uA77A]/g},{base:"dz",letters:/[\u01F3\u01C6]/g},{base:"e",letters:/[\u0065\u24D4\uFF45\u00E8\u00E9\u00EA\u1EC1\u1EBF\u1EC5\u1EC3\u1EBD\u0113\u1E15\u1E17\u0115\u0117\u00EB\u1EBB\u011B\u0205\u0207\u1EB9\u1EC7\u0229\u1E1D\u0119\u1E19\u1E1B\u0247\u025B\u01DD]/g},{base:"f",letters:/[\u0066\u24D5\uFF46\u1E1F\u0192\uA77C]/g},{base:"g",letters:/[\u0067\u24D6\uFF47\u01F5\u011D\u1E21\u011F\u0121\u01E7\u0123\u01E5\u0260\uA7A1\u1D79\uA77F]/g},{base:"h",letters:/[\u0068\u24D7\uFF48\u0125\u1E23\u1E27\u021F\u1E25\u1E29\u1E2B\u1E96\u0127\u2C68\u2C76\u0265]/g},{base:"hv",letters:/[\u0195]/g},{base:"i",letters:/[\u0069\u24D8\uFF49\u00EC\u00ED\u00EE\u0129\u012B\u012D\u00EF\u1E2F\u1EC9\u01D0\u0209\u020B\u1ECB\u012F\u1E2D\u0268\u0131]/g},{base:"j",letters:/[\u006A\u24D9\uFF4A\u0135\u01F0\u0249]/g},{base:"k",letters:/[\u006B\u24DA\uFF4B\u1E31\u01E9\u1E33\u0137\u1E35\u0199\u2C6A\uA741\uA743\uA745\uA7A3]/g},{base:"l",letters:/[\u006C\u24DB\uFF4C\u0140\u013A\u013E\u1E37\u1E39\u013C\u1E3D\u1E3B\u017F\u0142\u019A\u026B\u2C61\uA749\uA781\uA747]/g},{base:"lj",letters:/[\u01C9]/g},{base:"m",letters:/[\u006D\u24DC\uFF4D\u1E3F\u1E41\u1E43\u0271\u026F]/g},{base:"n",letters:/[\u006E\u24DD\uFF4E\u01F9\u0144\u00F1\u1E45\u0148\u1E47\u0146\u1E4B\u1E49\u019E\u0272\u0149\uA791\uA7A5]/g},{base:"nj",letters:/[\u01CC]/g},{base:"o",letters:/[\u006F\u24DE\uFF4F\u00F2\u00F3\u00F4\u1ED3\u1ED1\u1ED7\u1ED5\u00F5\u1E4D\u022D\u1E4F\u014D\u1E51\u1E53\u014F\u022F\u0231\u00F6\u022B\u1ECF\u0151\u01D2\u020D\u020F\u01A1\u1EDD\u1EDB\u1EE1\u1EDF\u1EE3\u1ECD\u1ED9\u01EB\u01ED\u00F8\u01FF\u0254\uA74B\uA74D\u0275]/g},{base:"oi",letters:/[\u01A3]/g},{base:"ou",letters:/[\u0223]/g},{base:"oo",letters:/[\uA74F]/g},{base:"p",letters:/[\u0070\u24DF\uFF50\u1E55\u1E57\u01A5\u1D7D\uA751\uA753\uA755]/g},{base:"q",letters:/[\u0071\u24E0\uFF51\u024B\uA757\uA759]/g},{base:"r",letters:/[\u0072\u24E1\uFF52\u0155\u1E59\u0159\u0211\u0213\u1E5B\u1E5D\u0157\u1E5F\u024D\u027D\uA75B\uA7A7\uA783]/g},{base:"s",letters:/[\u0073\u24E2\uFF53\u00DF\u015B\u1E65\u015D\u1E61\u0161\u1E67\u1E63\u1E69\u0219\u015F\u023F\uA7A9\uA785\u1E9B]/g},{base:"t",letters:/[\u0074\u24E3\uFF54\u1E6B\u1E97\u0165\u1E6D\u021B\u0163\u1E71\u1E6F\u0167\u01AD\u0288\u2C66\uA787]/g},{base:"tz",letters:/[\uA729]/g},{base:"u",letters:/[\u0075\u24E4\uFF55\u00F9\u00FA\u00FB\u0169\u1E79\u016B\u1E7B\u016D\u00FC\u01DC\u01D8\u01D6\u01DA\u1EE7\u016F\u0171\u01D4\u0215\u0217\u01B0\u1EEB\u1EE9\u1EEF\u1EED\u1EF1\u1EE5\u1E73\u0173\u1E77\u1E75\u0289]/g},{base:"v",letters:/[\u0076\u24E5\uFF56\u1E7D\u1E7F\u028B\uA75F\u028C]/g},{base:"vy",letters:/[\uA761]/g},{base:"w",letters:/[\u0077\u24E6\uFF57\u1E81\u1E83\u0175\u1E87\u1E85\u1E98\u1E89\u2C73]/g},{base:"x",letters:/[\u0078\u24E7\uFF58\u1E8B\u1E8D]/g},{base:"y",letters:/[\u0079\u24E8\uFF59\u1EF3\u00FD\u0177\u1EF9\u0233\u1E8F\u00FF\u1EF7\u1E99\u1EF5\u01B4\u024F\u1EFF]/g},{base:"z",letters:/[\u007A\u24E9\uFF5A\u017A\u1E91\u017C\u017E\u1E93\u1E95\u01B6\u0225\u0240\u2C6C\uA763]/g}],ST_CERT_CACHE={_generic:!0};return{handleAPIError:handleAPIError,handleRedirect:handleRedirect,redirectToAccounts:redirectToAccounts,createAccountsUrl:createAccountsUrl,setupInternalLinks:setupInternalLinks,setupFormSave:setupFormSave,renderAllErrors:renderAllErrors,renderFieldErrors:renderFieldErrors,isMobileDevice:isMobileDevice,isIOS:isIOS,isTouchSupported:isTouchSupported,isCanvasSupported:isCanvasSupported,scrollToInternalLink:scrollToInternalLink,makeHttps:makeHttps,getToday:getToday,prettyJoin:prettyJoin,getUrlParam:getUrlParam,changeUrlParam:changeUrlParam,getUrlPath:getUrlPath,inView:inView,countCS:countCS,setupPromos:setupPromos,prettifyTime:prettifyTime,prettifyUrl:prettifyUrl,addCommas:addCommas,extractFirstSubdir:extractFirstSubdir,linkifyText:linkifyText,rgbToHsl:rgbToHsl,hslToRgb:hslToRgb,rgbToHsv:rgbToHsv,hsvToRgb:hsvToRgb,verticalCenterEl:verticalCenterEl,sortedGroupBy:sortedGroupBy,splitIntoGroups:splitIntoGroups,concatName:concatName,removeDiacritics:removeDiacritics,getCourseName:getCourseName,isChina:isChina,styleRightToLeft:styleRightToLeft,getSTCertCorner:makeCheckCertFn("signature-cert-corner.png"),getSTCertIcon:makeCheckCertFn("signature-cert-icon.png")}}),!function(wndw){var globalActiveAjaxCount=0,api=function($,_,cookie,Backbone){var _private={defaults:{type:"normal","csrf.token":"X-CSRFToken","csrf.cookie":"csrftoken","csrf.path":null,"csrf.domain":null,"csrf2.token_header":"X-CSRF2-Token","csrf2.cookie_name_header":"X-CSRF2-Cookie","csrf2.cookie_prefix":"csrf2_token_","emulate.patch":!0,"emulate.put":!1,"emulate.delete":!1,"custom.header.name":null,"custom.header.value":null},csrfGet:function(){var token=cookie.get(this.options["csrf.cookie"]);if(token)return token;else return _private.csrfSet.call(this,_private.csrfMake())},csrfClear:function(){cookie.clear(this.options["csrf.cookie"],{secure:this.options["csrf.secure"],path:this.options["csrf.path"],domain:this.options["csrf.domain"]})},csrfSet:function(token){return cookie.set(this.options["csrf.cookie"],token,{secure:this.options["csrf.secure"],path:this.options["csrf.path"],domain:this.options["csrf.domain"],expires:new Date((new Date).getTime()+6e4)}),token},csrfMake:function(length,chars){var output=[];chars=chars||"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",length=length||24;for(var i=0;length>i;i++)output.push(chars[Math.floor(Math.random()*chars.length)]);return output.join("")},csrf2SetUp:function(ajaxOptions){if("GET"==ajaxOptions.type)return{};var cookieName=this.options["csrf2.cookie_prefix"]+_private.csrfMake(8),token=_private.csrfMake();cookie.set(cookieName,token,{secure:this.options["csrf.secure"],path:this.options["csrf.path"],domain:this.options["csrf.domain"],expires:new Date((new Date).getTime()+6e4)}),ajaxOptions.headers[this.options["csrf2.cookie_name_header"]]=cookieName,ajaxOptions.headers[this.options["csrf2.token_header"]]=token},csrf2TearDown:function(ajaxHeaders){var cookieName=ajaxHeaders[this.options["csrf2.cookie_name_header"]];if(cookieName)cookie.clear(cookieName,{secure:this.options["csrf.secure"],path:this.options["csrf.path"],domain:this.options["csrf.domain"]})},invoke:function(path,_options){_options=_.extend({},_options);var options=_options||{},url;if(0!==path.indexOf("http"))url=this.root+path;else url=path;this.trigger("before",url,options);var params="GET"==options.type?options.data:null,remove=function(e,item){this.remove(item.options.id)},message=options.message||{},codes=message.codes?_.keys(message.codes):[],asyncMessage=this.options.message,that=this;if(delete options.message,"GET"!=options.type&&_.isUndefined(options.processData)&&"rest"==this.options.type)options.contentType="application/json; charset=utf-8",options.processData=!1,options.data=JSON.stringify(options.data);options.beforeSend=function(){globalActiveAjaxCount++};var jqXHR=$.ajax(url,options);if(asyncMessage){if(message.waiting){var waitID=asyncMessage.add($("<div>").append(message.waiting).addClass("waiting"),{delay:100});jqXHR.always(function(jqXHR,textStatus){asyncMessage.remove(waitID)})}if(message.success||message.codes&&_.min(codes)<300)jqXHR.done(function(jqXHR,textStatus){if(message.codes&&message.codes[jqXHR.status])asyncMessage.add($("<div>").append(message.codes[jqXHR.status]).addClass("success"),{timeout:500});else if(message.success)asyncMessage.add($("<div>").append(message.success).addClass("success"),{timeout:500})});if(message.error||message.timeout||message.codes&&_.max(codes)>=300)jqXHR.fail(function(jqXHR,textStatus){if(message.timeout&&"timeout"==textStatus)asyncMessage.add($("<div>").append(message.timeout).addClass("error"),{events:{click:remove}});else if(message.codes&&message.codes[jqXHR.status])asyncMessage.add($("<div>").append(message.codes[jsXHR.status]).addClass("error"),{events:{click:remove}});else if(message.error)asyncMessage.add($("<div>").append(message.error).addClass("error"),{events:{click:remove}})})}var start=(new Date).getTime();return that.trigger("send",{xhr:jqXHR,url:url}),jqXHR.always(function(){if(0===--globalActiveAjaxCount)_private.csrfClear.call(that);_private.csrf2TearDown.call(that,options.headers||{}),that.trigger("always",{xhr:jqXHR,url:url,params:params,timing:(new Date).getTime()-start})}),jqXHR.fail(function(){that.trigger("fail",{xhr:jqXHR,url:url,params:params})}),jqXHR},restify:function(method,_options){var options=_options||{};switch(options.data=options.data||{},options.headers=options.headers||{},method){case"POST":options.type="POST";break;case"PATCH":if(this.options["emulate.patch"])options.type="POST",options.headers["X-HTTP-Method-Override"]="PATCH";else options.type="PATCH";break;case"PUT":if(this.options["emulate.put"])options.type="POST",options.headers["X-HTTP-Method-Override"]="PUT";else options.type="PUT";break;case"DELETE":if(this.options["emulate.delete"])options.type="POST",options.headers["X-HTTP-Method-Override"]="DELETE";else options.type="DELETE";break;default:options.type="GET"}if("GET"!=options.type)options.headers[this.options["csrf.token"]]=_private.csrfGet.call(this),_private.csrf2SetUp.call(this,options);if(this.options["custom.header.name"])options.headers[this.options["custom.header.name"]]=this.options["custom.header.value"];return options}},api=function(root,options){this.root=root,this.options=_.extend({},_private.defaults,options)};return api.prototype.customize=function(options){return this.options=_.extend(this.options,options),this},api.prototype.get=function(path,options){return _private.invoke.call(this,path,_private.restify.call(this,"GET",options))},api.prototype.patch=function(path,options){return _private.invoke.call(this,path,_private.restify.call(this,"PATCH",options))},api.prototype["delete"]=function(path,options){return _private.invoke.call(this,path,_private.restify.call(this,"DELETE",options))},api.prototype.post=function(path,options){return _private.invoke.call(this,path,_private.restify.call(this,"POST",options))},api.prototype.put=function(path,options){return _private.invoke.call(this,path,_private.restify.call(this,"PUT",options))},_.extend(api.prototype,Backbone.Events),function(root,options){return new api(root,options)}};if("function"==typeof define&&define.amd)define("js/lib/api",["jquery","underscore","js/lib/cookie","backbone","js/lib/json2"],function($,_,Cookie,Backbone){return api($,_,Cookie,Backbone)});else wndw.API=api(wndw.$,wndw._,wndw.Cookie,wndw.Backbone)}(window),define("pages/spark/api",["js/core/coursera","js/lib/api","pages/spark/models/course.json"],function(Coursera,API,course){var homeApi=API("/"+course.sessionName+"/api/",{type:"rest","csrf.secure":!Coursera.config.debug,"csrf.path":"/"+course.sessionName+"/"});return homeApi.on("always",function(api){if(api.xhr.status>=400)Coursera.multitracker.push(["api.error."+api.xhr.status,{timing:api.timing,url:api.url,params:api.params,status:api.xhr.status,response:api.xhr.responseText}]);else Coursera.multitracker.push(["api.ok."+api.xhr.status,{timing:api.timing,url:api.url,params:api.params,status:api.xhr.status,cf_age:api.xhr.getResponseHeader("Age"),cf_hit:api.xhr.getResponseHeader("X-Cache")}])}),homeApi}),define("js/lib/asyncMessages",["jquery","underscore","js/lib/cookie","backbone"],function($,_,cookie,Backbone){var _private={defaults:{selector:null},defaults_item:{timeout:0},item_remove:function(item){var index=_.indexOf(this.stack,item.options.id);if(-1!=index){this.stack.splice(index,1);for(var _event in item.options.events)item.$ele.off(_event+".asyncMessage");item.$ele.remove()}delete this.items[item.options.id]},item_show:function(item){var that=this;if(this.stack.length){var previous=this.items[this.stack[0]];if(previous)previous.$ele.remove()}if(this.$container.append(item.$ele),this.trigger("showing",item.$ele),this.$container.show(),this.stack.unshift(item.options.id),this.trigger("show",item),item.options.timeout)setTimeout(function(){that.trigger("hiding",item),that.remove(item.options.id),that.trigger("hide",item)},item.options.timeout);for(var _event in item.options.events)item.$ele.on(_event+".asyncMessage",function(e){item.options.events[_event].call(that,e,item)})}},asyncMessage=function(ele,options){this.options=$.extend({},_private.defaults,options),this.$ele=$(ele||$("<div>").appendTo("body")),this.$container=this.options.selector?this.$ele.find(this.options.selector):this.$ele,this.stack=[],this.items={}};return asyncMessage.prototype.add=function(ele,_options){var $item=$(ele),options=$.extend({},_private.defaults_item,_options),that=this;if(options.id=options.id||_.uniqueId(),_.has(this.items,options.id))return options.id;this.items[options.id]={$ele:$item,options:options,timer:null};var show=function(){if(!that.stack.length)that.trigger("opening");if(_private.item_show.call(that,that.items[options.id]),1==that.stack.length)that.trigger("open")};if(options.delay)this.items[options.id].timer=setTimeout(show,options.delay);else show();return options.id},asyncMessage.prototype.remove=function(id){var item=this.items[id];if(item)if(clearTimeout(item.timer),1==this.stack.length)this.trigger("closing"),_private.item_remove.call(this,item),this.$container.hide(),this.trigger("close");else{if(this.stack.length){var toShow=this.items[this.stack.shift()];if(toShow)_private.item_show.call(this,toShow)}_private.item_remove.call(this,item)}},_.extend(asyncMessage.prototype,Backbone.Events),{create:function(ele,options){return new asyncMessage(ele,options)}}}),define("pages/spark/models/user",["jquery","backbone","js/core/coursera","js/lib/cookie","underscore","js/lib/api"],function($,Backbone,Coursera,cookie,_,API){var User=Backbone.Model.extend({canAccessAdmin:function(){return _.contains(this.get("permissions"),"admin_access")},can:function(permission){return _.contains(this.get("permissions"),permission)},cannot:function(permission){return!this.can(permission)},isAdmin:function(){return 1==this.get("access_group_id")},isStaffOrSuperuser:function(){return 1==this.get("access_group_id")||2==this.get("access_group_id")||3==this.get("access_group_id")},isAnonymous:function(){return this.get("anonymous")},inSignatureTrack:function(){return 1==this.get("in_signature_track")},inACE:function(){return 1==this.get("wishes_proctored_exam")},canModerateForum:function(){return _.contains(this.get("permissions"),"forum_moderate")},hasSubmissionForItem:function(itemType,itemId){if("quiz"!==itemType)return;return $.inArray(itemId.toString(),this.get("submitted_quizzes"))>=0}});return User}),define("pages/spark/models/course",["jquery","backbone","underscore","js/core/config","js/core/coursera"],function($,Backbone,_,config,Coursera){var Course=Backbone.Model.extend({getReportUrl:function(reportName,format){return"/"+this.get("sessionName")+"/data/api/reports/"+reportName+"."+format},getReportJson:function(reportName){return $.getJSON(this.getReportUrl(reportName,"json"))},getReportUpdateUrl:function(reportName){return"/"+this.get("sessionName")+"/data/api/reports/"+reportName+"/update"},postReportUpdate:function(reportName){var updateUrl=window.location.protocol+"//"+window.location.hostname+this.getReportUpdateUrl(reportName);return Coursera.api.post(updateUrl,{})}});return Course}),define("pages/spark/models/navbar",["jquery","backbone","underscore"],function($,Backbone,_){var Navbar=Backbone.Model.extend({});return Navbar}),define("pages/spark/app",["jquery","underscore","backbone","pages/spark/api","js/core/coursera","js/lib/asyncMessages","js/lib/cookie","pages/spark/models/user.json","pages/spark/models/course.json","pages/spark/models/navbar.json","pages/spark/models/user","pages/spark/models/course","pages/spark/models/navbar"],function($,_,Backbone,sparkApi,Coursera,asyncMessages,cookie,user,course,navbar,User,Course,Navbar){var $message=$("<div>").appendTo("body").addClass("coursera-async-message");return Coursera.user=new User(user),Coursera.course=new Course(course),Coursera.navbar=new Navbar(navbar),Coursera.message=asyncMessages.create($message),Coursera.api=sparkApi.customize({message:Coursera.message}),Coursera.on("region:fetching",function(region){Coursera.message.add($("<div>loading page</div>").addClass("waiting"),{id:region.name+region.uid})}),Coursera.on("region:fetched",function(region){Coursera.message.remove(region.name+region.uid)}),Coursera}),define("js/lib/backbone.api",["backbone","underscore","js/lib/api"],function(Backbone,_,API){var apiModel={sync:function(method,model,options){options=_.extend({},options);var that=this,action=[],id=this.urlId||this.idAttribute||"id",query="",url=options.url?options.url:_.isFunction(this.url)?this.url():this.url;if(options.query){var qs=[];for(var p in options.query)qs.push(encodeURIComponent(p)+"="+encodeURIComponent(options.query[p]));query+=-1==url.indexOf("?")?"?"+qs.join("&"):"&"+qs.join("&")}if(!this.api){var urlRoot=url||(_.isFunction(this.urlRoot)?this.urlRoot():this.urlRoot);this.api=API(urlRoot)}if("create"==method)return options.data=_.extend(this.toJSON(),options.data||{}),this.api.post(url+query,options);else if("update"==method)if(this.partialUpdate){if(options.data=_.extend(this.changedAttributes()||{},options.data||{}),options.force)if(_.isArray(options.force))_.each(options.force,function(force){options.data[force]=that.get(force)});else options.data[options.force]=this.get(options.force);return this.api.patch(url+"/"+this.get(id)+query,options)}else return options.data=_.extend(this.toJSON(),options.data||{}),this.api.put(url+"/"+this.get(id)+query,options);else if("delete"==method)return this.api["delete"](url+"/"+this.get(id)+query,options);else if("read"==method)if(this instanceof Backbone.Collection||void 0===this.get(id))return this.api.get(url+query,options);else return this.api.get(url+"/"+this.get(id)+query,options)},create:function(options,callback){var that=this;return this.save(null,options).done(function(data){if(callback)callback.call(that,null,data)}).fail(function(jqXHR,textStatus){if(callback)callback.call(that,textStatus)})},update:function(attributes,_options,callback){var that=this,options=_options||{};if(attributes&&!this.isNew())options.silent=void 0!==options.silent?options.silent:!0;return this.save(attributes,options).done(function(data){if(callback)callback.call(that,null,data)}).fail(function(jqXHR,textStatus){if(callback)callback.call(that,textStatus)})},read:function(options,callback){var that=this;return this.fetch(options).done(function(data){if(callback)callback.call(that,null,data)}).fail(function(jqXHR,textStatus){if(callback)callback.call(that,textStatus)})},"delete":function(options,callback){var that=this;return this.destroy(options).done(function(data){if(callback)callback.call(that,null,data)}).fail(function(jqXHR,textStatus){if(callback)callback.call(that,textStatus)})}};return apiModel}),!function(undefined){var RelationalModule=function(Backbone,_,exports){Backbone.Relational={showWarnings:!0},Backbone.Semaphore={_permitsAvailable:null,_permitsUsed:0,acquire:function(){if(this._permitsAvailable&&this._permitsUsed>=this._permitsAvailable)throw new Error("Max permits acquired");else this._permitsUsed++},release:function(){if(0===this._permitsUsed)throw new Error("All permits released");else this._permitsUsed--},isLocked:function(){return this._permitsUsed>0},setAvailablePermits:function(amount){if(this._permitsUsed>amount)throw new Error("Available permits cannot be less than used permits");this._permitsAvailable=amount}},Backbone.BlockingQueue=function(){this._queue=[]},_.extend(Backbone.BlockingQueue.prototype,Backbone.Semaphore,{_queue:null,add:function(func){if(this.isBlocked())this._queue.push(func);else func()},process:function(){var queue=this._queue;for(this._queue=[];queue&&queue.length;)queue.shift()()},block:function(){this.acquire()},unblock:function(){if(this.release(),!this.isBlocked())this.process()},isBlocked:function(){return this.isLocked()}}),Backbone.Relational.eventQueue=new Backbone.BlockingQueue,Backbone.Store=function(){this._collections=[],this._reverseRelations=[],this._orphanRelations=[],this._subModels=[],this._modelScopes=[exports]},_.extend(Backbone.Store.prototype,Backbone.Events,{initializeRelation:function(model,relation,options){var type=!_.isString(relation.type)?relation.type:Backbone[relation.type]||this.getObjectByName(relation.type);if(type&&type.prototype instanceof Backbone.Relation)new type(model,relation,options);else Backbone.Relational.showWarnings&&"undefined"!=typeof console&&console.warn("Relation=%o; missing or invalid relation type!",relation)},addModelScope:function(scope){this._modelScopes.push(scope)},removeModelScope:function(scope){this._modelScopes=_.without(this._modelScopes,scope)},addSubModels:function(subModelTypes,superModelType){this._subModels.push({superModelType:superModelType,subModels:subModelTypes})},setupSuperModel:function(modelType){_.find(this._subModels,function(subModelDef){return _.find(subModelDef.subModels||[],function(subModelTypeName,typeValue){var subModelType=this.getObjectByName(subModelTypeName);if(modelType===subModelType)return subModelDef.superModelType._subModels[typeValue]=modelType,modelType._superModel=subModelDef.superModelType,modelType._subModelTypeValue=typeValue,modelType._subModelTypeAttribute=subModelDef.superModelType.prototype.subModelTypeAttribute,!0;else return void 0},this)},this)},addReverseRelation:function(relation){var exists=_.any(this._reverseRelations,function(rel){return _.all(relation||[],function(val,key){return val===rel[key]})});if(!exists&&relation.model&&relation.type)this._reverseRelations.push(relation),this._addRelation(relation.model,relation),this.retroFitRelation(relation)},addOrphanRelation:function(relation){var exists=_.any(this._orphanRelations,function(rel){return _.all(relation||[],function(val,key){return val===rel[key]})});if(!exists&&relation.model&&relation.type)this._orphanRelations.push(relation)},processOrphanRelations:function(){_.each(this._orphanRelations.slice(0),function(rel){var relatedModel=Backbone.Relational.store.getObjectByName(rel.relatedModel);if(relatedModel)this.initializeRelation(null,rel),this._orphanRelations=_.without(this._orphanRelations,rel)},this)},_addRelation:function(type,relation){if(!type.prototype.relations)type.prototype.relations=[];type.prototype.relations.push(relation),_.each(type._subModels||[],function(subModel){this._addRelation(subModel,relation)},this)},retroFitRelation:function(relation){var coll=this.getCollection(relation.model,!1);coll&&coll.each(function(model){if(model instanceof relation.model)new relation.type(model,relation)},this)},getCollection:function(type,create){if(type instanceof Backbone.RelationalModel)type=type.constructor;for(var rootModel=type;rootModel._superModel;)rootModel=rootModel._superModel;var coll=_.find(this._collections,function(item){return item.model===rootModel});if(!coll&&create!==!1)coll=this._createCollection(rootModel);return coll},getObjectByName:function(name){var parts=name.split("."),type=null;return _.find(this._modelScopes,function(scope){if(type=_.reduce(parts||[],function(memo,val){return memo?memo[val]:undefined},scope),type&&type!==scope)return!0;else return void 0},this),type},_createCollection:function(type){var coll;if(type instanceof Backbone.RelationalModel)type=type.constructor;if(type.prototype instanceof Backbone.RelationalModel)coll=new Backbone.Collection,coll.model=type,this._collections.push(coll);return coll},resolveIdForItem:function(type,item){var id=_.isString(item)||_.isNumber(item)?item:null;if(null===id)if(item instanceof Backbone.RelationalModel)id=item.id;else if(_.isObject(item))id=item[type.prototype.idAttribute];if(!id&&0!==id)id=null;return id},find:function(type,item){var id=this.resolveIdForItem(type,item),coll=this.getCollection(type);if(coll){var obj=coll.get(id);if(obj instanceof type)return obj}return null},register:function(model){var coll=this.getCollection(model);if(coll){var modelColl=model.collection;coll.add(model),this.listenTo(model,"destroy",this.unregister,this),this.listenTo(model,"relational:unregister",this.unregister,this),model.collection=modelColl}},checkId:function(model,id){var coll=this.getCollection(model),duplicate=coll&&coll.get(id);if(duplicate&&model!==duplicate){if(Backbone.Relational.showWarnings&&"undefined"!=typeof console)console.warn("Duplicate id! Old RelationalModel=%o, new RelationalModel=%o",duplicate,model);throw new Error("Cannot instantiate more than one Backbone.RelationalModel with the same id per type!")}},update:function(model){var coll=this.getCollection(model);coll._onModelEvent("change:"+model.idAttribute,model,coll),model.trigger("relational:change:id",model,coll)},unregister:function(model,collection,options){this.stopListening(model);var coll=this.getCollection(model);coll&&coll.remove(model,options)},reset:function(){this.stopListening(),this._collections=[],this._subModels=[],this._modelScopes=[exports]}}),Backbone.Relational.store=new Backbone.Store,Backbone.Relation=function(instance,options,opts){if(this.instance=instance,options=_.isObject(options)?options:{},this.reverseRelation=_.defaults(options.reverseRelation||{},this.options.reverseRelation),this.options=_.defaults(options,this.options,Backbone.Relation.prototype.options),this.reverseRelation.type=!_.isString(this.reverseRelation.type)?this.reverseRelation.type:Backbone[this.reverseRelation.type]||Backbone.Relational.store.getObjectByName(this.reverseRelation.type),this.key=this.options.key,this.keySource=this.options.keySource||this.key,this.keyDestination=this.options.keyDestination||this.keySource||this.key,this.model=this.options.model||this.instance.constructor,this.relatedModel=this.options.relatedModel,_.isFunction(this.relatedModel)&&!(this.relatedModel.prototype instanceof Backbone.RelationalModel))this.relatedModel=_.result(this,"relatedModel");if(_.isString(this.relatedModel))this.relatedModel=Backbone.Relational.store.getObjectByName(this.relatedModel);if(this.checkPreconditions()){if(!this.options.isAutoRelation&&this.reverseRelation.type&&this.reverseRelation.key)Backbone.Relational.store.addReverseRelation(_.defaults({isAutoRelation:!0,model:this.relatedModel,relatedModel:this.model,reverseRelation:this.options},this.reverseRelation));if(instance){var contentKey=this.keySource;if(contentKey!==this.key&&"object"==typeof this.instance.get(this.key))contentKey=this.key;if(this.setKeyContents(this.instance.get(contentKey)),this.relatedCollection=Backbone.Relational.store.getCollection(this.relatedModel),this.keySource!==this.key)delete this.instance.attributes[this.keySource];if(this.instance._relations[this.key]=this,this.initialize(opts),this.options.autoFetch)this.instance.fetchRelated(this.key,_.isObject(this.options.autoFetch)?this.options.autoFetch:{});this.listenTo(this.instance,"destroy",this.destroy).listenTo(this.relatedCollection,"relational:add relational:change:id",this.tryAddRelated).listenTo(this.relatedCollection,"relational:remove",this.removeRelated)}}},Backbone.Relation.extend=Backbone.Model.extend,_.extend(Backbone.Relation.prototype,Backbone.Events,Backbone.Semaphore,{options:{createModels:!0,includeInJSON:!0,isAutoRelation:!1,autoFetch:!1,parse:!1},instance:null,key:null,keyContents:null,relatedModel:null,relatedCollection:null,reverseRelation:null,related:null,checkPreconditions:function(){var i=this.instance,k=this.key,m=this.model,rm=this.relatedModel,warn=Backbone.Relational.showWarnings&&"undefined"!=typeof console;
if(!m||!k||!rm)return warn&&console.warn("Relation=%o: missing model, key or relatedModel (%o, %o, %o).",this,m,k,rm),!1;if(!(m.prototype instanceof Backbone.RelationalModel))return warn&&console.warn("Relation=%o: model does not inherit from Backbone.RelationalModel (%o).",this,i),!1;if(!(rm.prototype instanceof Backbone.RelationalModel))return warn&&console.warn("Relation=%o: relatedModel does not inherit from Backbone.RelationalModel (%o).",this,rm),!1;if(this instanceof Backbone.HasMany&&this.reverseRelation.type===Backbone.HasMany)return warn&&console.warn("Relation=%o: relation is a HasMany, and the reverseRelation is HasMany as well.",this),!1;if(i&&_.keys(i._relations).length){var existing=_.find(i._relations,function(rel){return rel.key===k},this);if(existing)return warn&&console.warn("Cannot create relation=%o on %o for model=%o: already taken by relation=%o.",this,k,i,existing),!1}return!0},setRelated:function(related){this.related=related,this.instance.acquire(),this.instance.attributes[this.key]=related,this.instance.release()},_isReverseRelation:function(relation){return relation.instance instanceof this.relatedModel&&this.reverseRelation.key===relation.key&&this.key===relation.reverseRelation.key},getReverseRelations:function(model){var reverseRelations=[],models=!_.isUndefined(model)?[model]:this.related&&(this.related.models||[this.related]);return _.each(models||[],function(related){_.each(related.getRelations()||[],function(relation){if(this._isReverseRelation(relation))reverseRelations.push(relation)},this)},this),reverseRelations},destroy:function(){if(this.stopListening(),this instanceof Backbone.HasOne)this.setRelated(null);else if(this instanceof Backbone.HasMany)this.setRelated(this._prepareCollection());_.each(this.getReverseRelations(),function(relation){relation.removeRelated(this.instance)},this)}}),Backbone.HasOne=Backbone.Relation.extend({options:{reverseRelation:{type:"HasMany"}},initialize:function(opts){this.listenTo(this.instance,"relational:change:"+this.key,this.onChange);var related=this.findRelated(opts);this.setRelated(related),_.each(this.getReverseRelations(),function(relation){relation.addRelated(this.instance,opts)},this)},findRelated:function(options){var related=null;if(options=_.defaults({parse:this.options.parse},options),this.keyContents instanceof this.relatedModel)related=this.keyContents;else if(this.keyContents||0===this.keyContents){var opts=_.defaults({create:this.options.createModels},options);related=this.relatedModel.findOrCreate(this.keyContents,opts)}if(related)this.keyId=null;return related},setKeyContents:function(keyContents){this.keyContents=keyContents,this.keyId=Backbone.Relational.store.resolveIdForItem(this.relatedModel,this.keyContents)},onChange:function(model,attr,options){if(!this.isLocked()){this.acquire(),options=options?_.clone(options):{};var changed=_.isUndefined(options.__related),oldRelated=changed?this.related:options.__related;if(changed){this.setKeyContents(attr);var related=this.findRelated(options);this.setRelated(related)}if(oldRelated&&this.related!==oldRelated)_.each(this.getReverseRelations(oldRelated),function(relation){relation.removeRelated(this.instance,null,options)},this);if(_.each(this.getReverseRelations(),function(relation){relation.addRelated(this.instance,options)},this),!options.silent&&this.related!==oldRelated){var dit=this;this.changed=!0,Backbone.Relational.eventQueue.add(function(){dit.instance.trigger("change:"+dit.key,dit.instance,dit.related,options,!0),dit.changed=!1})}this.release()}},tryAddRelated:function(model,coll,options){if((this.keyId||0===this.keyId)&&model.id===this.keyId)this.addRelated(model,options),this.keyId=null},addRelated:function(model,options){var dit=this;model.queue(function(){if(model!==dit.related){var oldRelated=dit.related||null;dit.setRelated(model),dit.onChange(dit.instance,model,_.defaults({__related:oldRelated},options))}})},removeRelated:function(model,coll,options){if(this.related)if(model===this.related){var oldRelated=this.related||null;this.setRelated(null),this.onChange(this.instance,model,_.defaults({__related:oldRelated},options))}}}),Backbone.HasMany=Backbone.Relation.extend({collectionType:null,options:{reverseRelation:{type:"HasOne"},collectionType:Backbone.Collection,collectionKey:!0,collectionOptions:{}},initialize:function(opts){if(this.listenTo(this.instance,"relational:change:"+this.key,this.onChange),this.collectionType=this.options.collectionType,_.isFunction(this.collectionType)&&this.collectionType!==Backbone.Collection&&!(this.collectionType.prototype instanceof Backbone.Collection))this.collectionType=_.result(this,"collectionType");if(_.isString(this.collectionType))this.collectionType=Backbone.Relational.store.getObjectByName(this.collectionType);if(this.collectionType!==Backbone.Collection&&!(this.collectionType.prototype instanceof Backbone.Collection))throw new Error("`collectionType` must inherit from Backbone.Collection");var related=this.findRelated(opts);this.setRelated(related)},_prepareCollection:function(collection){if(this.related)this.stopListening(this.related);if(!(collection&&collection instanceof Backbone.Collection)){var options=_.isFunction(this.options.collectionOptions)?this.options.collectionOptions(this.instance):this.options.collectionOptions;collection=new this.collectionType(null,options)}if(collection.model=this.relatedModel,this.options.collectionKey){var key=this.options.collectionKey===!0?this.options.reverseRelation.key:this.options.collectionKey;if(collection[key]&&collection[key]!==this.instance){if(Backbone.Relational.showWarnings&&"undefined"!=typeof console)console.warn("Relation=%o; collectionKey=%s already exists on collection=%o",this,key,this.options.collectionKey)}else if(key)collection[key]=this.instance}return this.listenTo(collection,"relational:add",this.handleAddition).listenTo(collection,"relational:remove",this.handleRemoval).listenTo(collection,"relational:reset",this.handleReset),collection},findRelated:function(options){var related=null;if(options=_.defaults({parse:this.options.parse},options),this.keyContents instanceof Backbone.Collection)this._prepareCollection(this.keyContents),related=this.keyContents;else{var toAdd=[];if(_.each(this.keyContents,function(attributes){if(attributes instanceof this.relatedModel)var model=attributes;else model=this.relatedModel.findOrCreate(attributes,_.extend({merge:!0},options,{create:this.options.createModels}));model&&toAdd.push(model)},this),this.related instanceof Backbone.Collection)related=this.related;else related=this._prepareCollection();related.set(toAdd,_.defaults({merge:!1,parse:!1},options))}return this.keyIds=_.difference(this.keyIds,_.pluck(related.models,"id")),related},setKeyContents:function(keyContents){if(this.keyContents=keyContents instanceof Backbone.Collection?keyContents:null,this.keyIds=[],!this.keyContents&&(keyContents||0===keyContents))this.keyContents=_.isArray(keyContents)?keyContents:[keyContents],_.each(this.keyContents,function(item){var itemId=Backbone.Relational.store.resolveIdForItem(this.relatedModel,item);if(itemId||0===itemId)this.keyIds.push(itemId)},this)},onChange:function(model,attr,options){options=options?_.clone(options):{},this.setKeyContents(attr),this.changed=!1;var related=this.findRelated(options);if(this.setRelated(related),!options.silent){var dit=this;Backbone.Relational.eventQueue.add(function(){if(dit.changed)dit.instance.trigger("change:"+dit.key,dit.instance,dit.related,options,!0),dit.changed=!1})}},handleAddition:function(model,coll,options){options=options?_.clone(options):{},this.changed=!0,_.each(this.getReverseRelations(model),function(relation){relation.addRelated(this.instance,options)},this);var dit=this;!options.silent&&Backbone.Relational.eventQueue.add(function(){dit.instance.trigger("add:"+dit.key,model,dit.related,options)})},handleRemoval:function(model,coll,options){options=options?_.clone(options):{},this.changed=!0,_.each(this.getReverseRelations(model),function(relation){relation.removeRelated(this.instance,null,options)},this);var dit=this;!options.silent&&Backbone.Relational.eventQueue.add(function(){dit.instance.trigger("remove:"+dit.key,model,dit.related,options)})},handleReset:function(coll,options){var dit=this;options=options?_.clone(options):{},!options.silent&&Backbone.Relational.eventQueue.add(function(){dit.instance.trigger("reset:"+dit.key,dit.related,options)})},tryAddRelated:function(model,coll,options){var item=_.contains(this.keyIds,model.id);if(item)this.addRelated(model,options),this.keyIds=_.without(this.keyIds,model.id)},addRelated:function(model,options){var dit=this;model.queue(function(){if(dit.related&&!dit.related.get(model))dit.related.add(model,_.defaults({parse:!1},options))})},removeRelated:function(model,coll,options){if(this.related.get(model))this.related.remove(model,options)}}),Backbone.RelationalModel=Backbone.Model.extend({relations:null,_relations:null,_isInitialized:!1,_deferProcessing:!1,_queue:null,_attributeChangeFired:!1,subModelTypeAttribute:"type",subModelTypes:null,constructor:function(attributes,options){if(options&&options.collection){var dit=this,collection=this.collection=options.collection;delete options.collection,this._deferProcessing=!0;var processQueue=function(model){if(model===dit)dit._deferProcessing=!1,dit.processQueue(),collection.off("relational:add",processQueue)};collection.on("relational:add",processQueue),_.defer(function(){processQueue(dit)})}Backbone.Relational.store.processOrphanRelations(),this._queue=new Backbone.BlockingQueue,this._queue.block(),Backbone.Relational.eventQueue.block();try{Backbone.Model.apply(this,arguments)}finally{Backbone.Relational.eventQueue.unblock()}},trigger:function(eventName){if(eventName.length>5&&0===eventName.indexOf("change")){var dit=this,args=arguments;Backbone.Relational.eventQueue.add(function(){if(dit._isInitialized){var changed=!0;if("change"===eventName)changed=dit.hasChanged()||dit._attributeChangeFired,dit._attributeChangeFired=!1;else{var attr=eventName.slice(7),rel=dit.getRelation(attr);if(rel){if(changed=args[4]===!0)dit.changed[attr]=args[2];else if(!rel.changed)delete dit.changed[attr]}else if(changed)dit._attributeChangeFired=!0}changed&&Backbone.Model.prototype.trigger.apply(dit,args)}})}else Backbone.Model.prototype.trigger.apply(this,arguments);return this},initializeRelations:function(options){this.acquire(),this._relations={},_.each(_.result(this,"relations")||[],function(rel){Backbone.Relational.store.initializeRelation(this,rel,options)},this),this._isInitialized=!0,this.release(),this.processQueue()},updateRelations:function(changedAttrs,options){if(this._isInitialized&&!this.isLocked())_.each(this._relations,function(rel){if(!changedAttrs||rel.keySource in changedAttrs||rel.key in changedAttrs){var value=this.attributes[rel.keySource]||this.attributes[rel.key],attr=changedAttrs&&(changedAttrs[rel.keySource]||changedAttrs[rel.key]);if(rel.related!==value||null===value&&null===attr)this.trigger("relational:change:"+rel.key,this,value,options||{})}if(rel.keySource!==rel.key)delete this.attributes[rel.keySource]},this)},queue:function(func){this._queue.add(func)},processQueue:function(){if(this._isInitialized&&!this._deferProcessing&&this._queue.isBlocked())this._queue.unblock()},getRelation:function(key){return this._relations[key]},getRelations:function(){return _.values(this._relations)},fetchRelated:function(key,options,refresh){options=_.extend({update:!0,remove:!1},options);var models,setUrl,requests=[],rel=this.getRelation(key),idsToFetch=rel&&(rel.keyIds&&rel.keyIds.slice(0)||(rel.keyId||0===rel.keyId?[rel.keyId]:[]));if(refresh)models=rel.related instanceof Backbone.Collection?rel.related.models:[rel.related],_.each(models,function(model){if(model.id||0===model.id)idsToFetch.push(model.id)});if(idsToFetch&&idsToFetch.length){var created=[];if(models=_.map(idsToFetch,function(id){var model=Backbone.Relational.store.find(rel.relatedModel,id);if(!model){var attrs={};attrs[rel.relatedModel.prototype.idAttribute]=id,model=rel.relatedModel.findOrCreate(attrs,options),created.push(model)}return model},this),rel.related instanceof Backbone.Collection&&_.isFunction(rel.related.url))setUrl=rel.related.url(models);if(setUrl&&setUrl!==rel.related.url()){var opts=_.defaults({error:function(){var args=arguments;_.each(created,function(model){model.trigger("destroy",model,model.collection,options),options.error&&options.error.apply(model,args)})},url:setUrl},options);requests=[rel.related.fetch(opts)]}else requests=_.map(models,function(model){var opts=_.defaults({error:function(){if(_.contains(created,model))model.trigger("destroy",model,model.collection,options),options.error&&options.error.apply(model,arguments)}},options);return model.fetch(opts)},this)}return requests},get:function(attr){var originalResult=Backbone.Model.prototype.get.call(this,attr);if(!this.dotNotation||-1===attr.indexOf("."))return originalResult;var splits=attr.split("."),result=_.reduce(splits,function(model,split){if(_.isNull(model)||_.isUndefined(model))return undefined;else if(model instanceof Backbone.Model)return Backbone.Model.prototype.get.call(model,split);else if(model instanceof Backbone.Collection)return Backbone.Collection.prototype.at.call(model,split);else throw new Error("Attribute must be an instanceof Backbone.Model or Backbone.Collection. Is: "+model+", currentSplit: "+split)},this);if(originalResult!==undefined&&result!==undefined)throw new Error("Ambiguous result for '"+attr+"'. direct result: "+originalResult+", dotNotation: "+result);return originalResult||result},set:function(key,value,options){Backbone.Relational.eventQueue.block();var attributes;if(_.isObject(key)||null==key)attributes=key,options=value;else attributes={},attributes[key]=value;try{var id=this.id,newId=attributes&&this.idAttribute in attributes&&attributes[this.idAttribute];Backbone.Relational.store.checkId(this,newId);var result=Backbone.Model.prototype.set.apply(this,arguments);if(!this._isInitialized&&!this.isLocked())this.constructor.initializeModelHierarchy(),Backbone.Relational.store.register(this),this.initializeRelations(options);else if(newId&&newId!==id)Backbone.Relational.store.update(this);if(attributes)this.updateRelations(attributes,options)}finally{Backbone.Relational.eventQueue.unblock()}return result},clone:function(){var attributes=_.clone(this.attributes);if(!_.isUndefined(attributes[this.idAttribute]))attributes[this.idAttribute]=null;return _.each(this.getRelations(),function(rel){delete attributes[rel.key]}),new this.constructor(attributes)},toJSON:function(options){if(this.isLocked())return this.id;this.acquire();var json=Backbone.Model.prototype.toJSON.call(this,options);if(this.constructor._superModel&&!(this.constructor._subModelTypeAttribute in json))json[this.constructor._subModelTypeAttribute]=this.constructor._subModelTypeValue;return _.each(this._relations,function(rel){var related=json[rel.key],includeInJSON=rel.options.includeInJSON,value=null;if(includeInJSON===!0){if(related&&_.isFunction(related.toJSON))value=related.toJSON(options)}else if(_.isString(includeInJSON)){if(related instanceof Backbone.Collection)value=related.pluck(includeInJSON);else if(related instanceof Backbone.Model)value=related.get(includeInJSON);if(includeInJSON===rel.relatedModel.prototype.idAttribute)if(rel instanceof Backbone.HasMany)value=value.concat(rel.keyIds);else if(rel instanceof Backbone.HasOne)if(value=value||rel.keyId,!value&&!_.isObject(rel.keyContents))value=rel.keyContents||null}else if(_.isArray(includeInJSON)){if(related instanceof Backbone.Collection)value=[],related.each(function(model){var curJson={};_.each(includeInJSON,function(key){curJson[key]=model.get(key)}),value.push(curJson)});else if(related instanceof Backbone.Model)value={},_.each(includeInJSON,function(key){value[key]=related.get(key)})}else delete json[rel.key];if(includeInJSON)json[rel.keyDestination]=value;if(rel.keyDestination!==rel.key)delete json[rel.key]}),this.release(),json}},{setup:function(superModel){if(this.prototype.relations=(this.prototype.relations||[]).slice(0),this._subModels={},this._superModel=null,this.prototype.hasOwnProperty("subModelTypes"))Backbone.Relational.store.addSubModels(this.prototype.subModelTypes,this);else this.prototype.subModelTypes=null;return _.each(this.prototype.relations||[],function(rel){if(!rel.model)rel.model=this;if(rel.reverseRelation&&rel.model===this){var preInitialize=!0;if(_.isString(rel.relatedModel)){var relatedModel=Backbone.Relational.store.getObjectByName(rel.relatedModel);preInitialize=relatedModel&&relatedModel.prototype instanceof Backbone.RelationalModel}if(preInitialize)Backbone.Relational.store.initializeRelation(null,rel);else if(_.isString(rel.relatedModel))Backbone.Relational.store.addOrphanRelation(rel)}},this),this},build:function(attributes,options){this.initializeModelHierarchy();var model=this._findSubModelType(this,attributes)||this;return new model(attributes,options)},_findSubModelType:function(type,attributes){if(type._subModels&&type.prototype.subModelTypeAttribute in attributes){var subModelTypeAttribute=attributes[type.prototype.subModelTypeAttribute],subModelType=type._subModels[subModelTypeAttribute];if(subModelType)return subModelType;else for(subModelTypeAttribute in type._subModels)if(subModelType=this._findSubModelType(type._subModels[subModelTypeAttribute],attributes))return subModelType}return null},initializeModelHierarchy:function(){if(this.inheritRelations(),this.prototype.subModelTypes){var resolvedSubModels=_.keys(this._subModels),unresolvedSubModels=_.omit(this.prototype.subModelTypes,resolvedSubModels);_.each(unresolvedSubModels,function(subModelTypeName){var subModelType=Backbone.Relational.store.getObjectByName(subModelTypeName);subModelType&&subModelType.initializeModelHierarchy()})}},inheritRelations:function(){if(_.isUndefined(this._superModel)||_.isNull(this._superModel))if(Backbone.Relational.store.setupSuperModel(this),this._superModel){if(this._superModel.inheritRelations(),this._superModel.prototype.relations){var inheritedRelations=_.select(this._superModel.prototype.relations||[],function(superRel){return!_.any(this.prototype.relations||[],function(rel){return superRel.relatedModel===rel.relatedModel&&superRel.key===rel.key},this)},this);this.prototype.relations=inheritedRelations.concat(this.prototype.relations)}}else this._superModel=!1},findOrCreate:function(attributes,options){options||(options={});var parsedAttributes=_.isObject(attributes)&&options.parse&&this.prototype.parse?this.prototype.parse(_.clone(attributes)):attributes,model=Backbone.Relational.store.find(this,parsedAttributes);if(_.isObject(attributes))if(model&&options.merge!==!1)delete options.collection,delete options.url,model.set(parsedAttributes,options);else if(!model&&options.create!==!1)model=this.build(attributes,options);return model},find:function(attributes,options){return options||(options={}),options.create=!1,this.findOrCreate(attributes,options)}}),_.extend(Backbone.RelationalModel.prototype,Backbone.Semaphore),Backbone.Collection.prototype.__prepareModel=Backbone.Collection.prototype._prepareModel,Backbone.Collection.prototype._prepareModel=function(attrs,options){var model;if(attrs instanceof Backbone.Model){if(!attrs.collection)attrs.collection=this;model=attrs}else{if(options=options?_.clone(options):{},options.collection=this,"undefined"!=typeof this.model.findOrCreate)model=this.model.findOrCreate(attrs,options);else model=new this.model(attrs,options);if(model&&model.validationError)this.trigger("invalid",this,attrs,options),model=!1}return model};var set=Backbone.Collection.prototype.__set=Backbone.Collection.prototype.set;Backbone.Collection.prototype.set=function(models,options){if(!(this.model.prototype instanceof Backbone.RelationalModel))return set.apply(this,arguments);if(options&&options.parse)models=this.parse(models,options);models=_.isArray(models)?models.slice():models?[models]:[];var newModels=[],toAdd=[];_.each(models,function(model){if(!(model instanceof Backbone.Model))model=Backbone.Collection.prototype._prepareModel.call(this,model,options);if(model)if(toAdd.push(model),!this.get(model)&&!this.get(model.cid))newModels.push(model);else if(null!=model.id)this._byId[model.id]=model},this);var result=set.call(this,toAdd,_.defaults({parse:!1},options));return _.each(newModels,function(model){if(this.get(model)||this.get(model.cid))this.trigger("relational:add",model,this,options)},this),result};var remove=Backbone.Collection.prototype.__remove=Backbone.Collection.prototype.remove;Backbone.Collection.prototype.remove=function(models,options){if(!(this.model.prototype instanceof Backbone.RelationalModel))return remove.apply(this,arguments);models=_.isArray(models)?models.slice():[models],options||(options={});var toRemove=[];_.each(models,function(model){model=this.get(model)||model&&this.get(model.cid),model&&toRemove.push(model)},this);var result=remove.call(this,toRemove,options);return _.each(toRemove,function(model){this.trigger("relational:remove",model,this,options)},this),result};var reset=Backbone.Collection.prototype.__reset=Backbone.Collection.prototype.reset;Backbone.Collection.prototype.reset=function(models,options){options=_.extend({merge:!0},options);var result=reset.call(this,models,options);if(this.model.prototype instanceof Backbone.RelationalModel)this.trigger("relational:reset",this,options);return result};var sort=Backbone.Collection.prototype.__sort=Backbone.Collection.prototype.sort;Backbone.Collection.prototype.sort=function(options){var result=sort.call(this,options);if(this.model.prototype instanceof Backbone.RelationalModel)this.trigger("relational:reset",this,options);return result};var trigger=Backbone.Collection.prototype.__trigger=Backbone.Collection.prototype.trigger;Backbone.Collection.prototype.trigger=function(eventName){if(!(this.model.prototype instanceof Backbone.RelationalModel))return trigger.apply(this,arguments);if("add"===eventName||"remove"===eventName||"reset"===eventName||"sort"===eventName){var dit=this,args=arguments;if(_.isObject(args[3]))args=_.toArray(args),args[3]=_.clone(args[3]);Backbone.Relational.eventQueue.add(function(){trigger.apply(dit,args)})}else trigger.apply(this,arguments);return this},Backbone.RelationalModel.extend=function(protoProps,classProps){var child=Backbone.Model.extend.apply(this,arguments);return child.setup(this),child}},_,Backbone,exports;if("undefined"==typeof window)_=require("underscore"),Backbone=require("backbone"),exports=Backbone,"undefined"==typeof module||(module.exports=exports),RelationalModule(Backbone,_,exports);else if("function"==typeof define&&define.amd)define("backbone.relational",["backbone","underscore"],function(Backbone,_){return RelationalModule(Backbone,_,window),Backbone.Relational});else _=window._,Backbone=window.Backbone,exports=window,RelationalModule(Backbone,_,exports)}(),function(){function Lexer(options){if(this.tokens=[],this.tokens.links={},this.options=options||marked.defaults,this.rules=block.normal,this.options.gfm)if(this.options.tables)this.rules=block.tables;else this.rules=block.gfm}function InlineLexer(links,options){if(this.options=options||marked.defaults,this.links=links,this.rules=inline.normal,!this.links)throw new Error("Tokens array requires a `links` property.");if(this.options.gfm)if(this.options.breaks)this.rules=inline.breaks;else this.rules=inline.gfm;else if(this.options.pedantic)this.rules=inline.pedantic}function Parser(options){this.tokens=[],this.token=null,this.options=options||marked.defaults}function escape(html,encode){return html.replace(!encode?/&(?!#?\w+;)/g:/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function replace(regex,opt){return regex=regex.source,opt=opt||"",function self(name,val){if(!name)return new RegExp(regex,opt);else return val=val.source||val,val=val.replace(/(^|[^\[])\^/g,"$1"),regex=regex.replace(name,val),self}}function noop(){}function merge(obj){for(var i=1,target,key;i<arguments.length;i++){target=arguments[i];for(key in target)if(Object.prototype.hasOwnProperty.call(target,key))obj[key]=target[key]}return obj}function marked(src,opt,callback){if(!callback&&"function"!=typeof opt)try{if(opt)opt=merge({},marked.defaults,opt);return Parser.parse(Lexer.lex(src,opt),opt)}catch(e){if(e.message+="\nPlease report this to https://github.com/chjj/marked.",(opt||marked.defaults).silent)return"<p>An error occured:</p><pre>"+escape(e.message+"",!0)+"</pre>";throw e}else{if(!callback)callback=opt,opt=null;opt=merge({},marked.defaults,opt||{});var highlight=opt.highlight,tokens,pending,i=0;try{tokens=Lexer.lex(src,opt)}catch(e){return callback(e)}pending=tokens.length;var done=function(){var out,err;try{out=Parser.parse(tokens,opt)}catch(e){err=e}return opt.highlight=highlight,err?callback(err):callback(null,out)};if(!highlight||highlight.length<3)return done();if(delete opt.highlight,!pending)return done();for(;i<tokens.length;i++)!function(token){if("code"!==token.type)return--pending||done();else return highlight(token.text,token.lang,function(err,code){if(null==code||code===token.text)return--pending||done();else return token.text=code,token.escaped=!0,void(--pending||done())})}(tokens[i])}}var block={newline:/^\n+/,code:/^( {4}[^\n]+\n*)+/,fences:noop,hr:/^( *[-*_]){3,} *(?:\n+|$)/,heading:/^ *(#{1,6}) *([^\n]+?) *#* *(?:\n+|$)/,nptable:noop,lheading:/^([^\n]+)\n *(=|-){2,} *(?:\n+|$)/,blockquote:/^( *>[^\n]+(\n[^\n]+)*\n*)+/,list:/^( *)(bull) [\s\S]+?(?:hr|\n{2,}(?! )(?!\1bull )\n*|\s*$)/,html:/^ *(?:comment|closed|closing) *(?:\n{2,}|\s*$)/,def:/^ *\[([^\]]+)\]: *<?([^\s>]+)>?(?: +["(]([^\n]+)[")])? *(?:\n+|$)/,table:noop,paragraph:/^((?:[^\n]+\n?(?!hr|heading|lheading|blockquote|tag|def))+)\n*/,text:/^[^\n]+/};block.bullet=/(?:[*+-]|\d+\.)/,block.item=/^( *)(bull) [^\n]*(?:\n(?!\1bull )[^\n]*)*/,block.item=replace(block.item,"gm")(/bull/g,block.bullet)(),block.list=replace(block.list)(/bull/g,block.bullet)("hr",/\n+(?=(?: *[-*_]){3,} *(?:\n+|$))/)(),block._tag="(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:/|@)\\b",block.html=replace(block.html)("comment",/<!--[\s\S]*?-->/)("closed",/<(tag)[\s\S]+?<\/\1>/)("closing",/<tag(?:"[^"]*"|'[^']*'|[^'">])*?>/)(/tag/g,block._tag)(),block.paragraph=replace(block.paragraph)("hr",block.hr)("heading",block.heading)("lheading",block.lheading)("blockquote",block.blockquote)("tag","<"+block._tag)("def",block.def)(),block.normal=merge({},block),block.gfm=merge({},block.normal,{fences:/^ *(`{3,}|~{3,}) *(\S+)? *\n([\s\S]+?)\s*\1 *(?:\n+|$)/,paragraph:/^/}),block.gfm.paragraph=replace(block.paragraph)("(?!","(?!"+block.gfm.fences.source.replace("\\1","\\2")+"|"+block.list.source.replace("\\1","\\3")+"|")(),block.tables=merge({},block.gfm,{nptable:/^ *(\S.*\|.*)\n *([-:]+ *\|[-| :]*)\n((?:.*\|.*(?:\n|$))*)\n*/,table:/^ *\|(.+)\n *\|( *[-:]+[-| :]*)\n((?: *\|.*(?:\n|$))*)\n*/}),Lexer.rules=block,Lexer.lex=function(src,options){var lexer=new Lexer(options);return lexer.lex(src)},Lexer.prototype.lex=function(src){return src=src.replace(/\r\n|\r/g,"\n").replace(/\t/g,"    ").replace(/\u00a0/g," ").replace(/\u2424/g,"\n"),this.token(src,!0)},Lexer.prototype.token=function(src,top){for(var src=src.replace(/^ +$/gm,""),next,loose,cap,bull,b,item,space,i,l;src;){if(cap=this.rules.newline.exec(src))if(src=src.substring(cap[0].length),cap[0].length>1)this.tokens.push({type:"space"});if(!(cap=this.rules.code.exec(src)))if(!(cap=this.rules.fences.exec(src)))if(!(cap=this.rules.heading.exec(src)))if(!top||!(cap=this.rules.nptable.exec(src)))if(!(cap=this.rules.lheading.exec(src)))if(!(cap=this.rules.hr.exec(src)))if(!(cap=this.rules.blockquote.exec(src)))if(!(cap=this.rules.list.exec(src)))if(!(cap=this.rules.html.exec(src)))if(!top||!(cap=this.rules.def.exec(src)))if(!top||!(cap=this.rules.table.exec(src)))if(!top||!(cap=this.rules.paragraph.exec(src)))if(!(cap=this.rules.text.exec(src))){if(src)throw new Error("Infinite loop on byte: "+src.charCodeAt(0))}else src=src.substring(cap[0].length),this.tokens.push({type:"text",text:cap[0]});else src=src.substring(cap[0].length),this.tokens.push({type:"paragraph",text:"\n"===cap[1].charAt(cap[1].length-1)?cap[1].slice(0,-1):cap[1]});else{for(src=src.substring(cap[0].length),item={type:"table",header:cap[1].replace(/^ *| *\| *$/g,"").split(/ *\| */),align:cap[2].replace(/^ *|\| *$/g,"").split(/ *\| */),cells:cap[3].replace(/(?: *\| *)?\n$/,"").split("\n")},i=0;i<item.align.length;i++)if(/^ *-+: *$/.test(item.align[i]))item.align[i]="right";else if(/^ *:-+: *$/.test(item.align[i]))item.align[i]="center";else if(/^ *:-+ *$/.test(item.align[i]))item.align[i]="left";else item.align[i]=null;for(i=0;i<item.cells.length;i++)item.cells[i]=item.cells[i].replace(/^ *\| *| *\| *$/g,"").split(/ *\| */);this.tokens.push(item)}else src=src.substring(cap[0].length),this.tokens.links[cap[1].toLowerCase()]={href:cap[2],title:cap[3]};else src=src.substring(cap[0].length),this.tokens.push({type:this.options.sanitize?"paragraph":"html",pre:"pre"===cap[1]||"script"===cap[1]||"style"===cap[1],text:cap[0]});else{for(src=src.substring(cap[0].length),bull=cap[2],this.tokens.push({type:"list_start",ordered:bull.length>1}),cap=cap[0].match(this.rules.item),next=!1,l=cap.length,i=0;l>i;i++){if(item=cap[i],space=item.length,item=item.replace(/^ *([*+-]|\d+\.) +/,""),~item.indexOf("\n "))space-=item.length,item=!this.options.pedantic?item.replace(new RegExp("^ {1,"+space+"}","gm"),""):item.replace(/^ {1,4}/gm,"");if(this.options.smartLists&&i!==l-1)if(b=block.bullet.exec(cap[i+1])[0],bull!==b&&!(bull.length>1&&b.length>1))src=cap.slice(i+1).join("\n")+src,i=l-1;if(loose=next||/\n\n(?!\s*$)/.test(item),i!==l-1)if(next="\n"===item.charAt(item.length-1),!loose)loose=next;this.tokens.push({type:loose?"loose_item_start":"list_item_start"}),this.token(item,!1),this.tokens.push({type:"list_item_end"})}this.tokens.push({type:"list_end"})}else src=src.substring(cap[0].length),this.tokens.push({type:"blockquote_start"}),cap=cap[0].replace(/^ *> ?/gm,""),this.token(cap,top),this.tokens.push({type:"blockquote_end"});else src=src.substring(cap[0].length),this.tokens.push({type:"hr"});else src=src.substring(cap[0].length),this.tokens.push({type:"heading",depth:"="===cap[2]?1:2,text:cap[1]});else{for(src=src.substring(cap[0].length),item={type:"table",header:cap[1].replace(/^ *| *\| *$/g,"").split(/ *\| */),align:cap[2].replace(/^ *|\| *$/g,"").split(/ *\| */),cells:cap[3].replace(/\n$/,"").split("\n")},i=0;i<item.align.length;i++)if(/^ *-+: *$/.test(item.align[i]))item.align[i]="right";else if(/^ *:-+: *$/.test(item.align[i]))item.align[i]="center";else if(/^ *:-+ *$/.test(item.align[i]))item.align[i]="left";else item.align[i]=null;for(i=0;i<item.cells.length;i++)item.cells[i]=item.cells[i].split(/ *\| */);this.tokens.push(item)}else src=src.substring(cap[0].length),this.tokens.push({type:"heading",depth:cap[1].length,text:cap[2]});else src=src.substring(cap[0].length),this.tokens.push({type:"code",lang:cap[2],text:cap[3]});else src=src.substring(cap[0].length),cap=cap[0].replace(/^ {4}/gm,""),this.tokens.push({type:"code",text:!this.options.pedantic?cap.replace(/\n+$/,""):cap})}return this.tokens};var inline={escape:/^\\([\\`*{}\[\]()#+\-.!_>\$])/,autolink:/^<([^ >]+(@|:\/)[^ >]+)>/,url:noop,tag:/^<!--[\s\S]*?-->|^<\/?\w+(?:"[^"]*"|'[^']*'|[^'">])*?>/,link:/^!?\[(inside)\]\(href\)/,reflink:/^!?\[(inside)\]\s*\[([^\]]*)\]/,nolink:/^!?\[((?:\[[^\]]*\]|[^\[\]])*)\]/,strong:/^__([\s\S]+?)__(?!_)|^\*\*([\s\S]+?)\*\*(?!\*)/,em:/^\b_((?:__|[\s\S])+?)_\b|^\*((?:\*\*|[\s\S])+?)\*(?!\*)/,code:/^(`+)\s*([\s\S]*?[^`])\s*\1(?!`)/,br:/^ {2,}\n(?!\s*$)/,del:noop,text:/^[\s\S]+?(?=[\$\\<!\[_*`]| {2,}\n|$)/,math:/^\$\$([^ \t\n\$][^\$]*[^ \t\n\$])\$\$/};if(inline._inside=/(?:\[[^\]]*\]|[^\[\]]|\](?=[^\[]*\]))*/,inline._href=/\s*<?([\s\S]*?)>?(?:\s+['"]([\s\S]*?)['"])?\s*/,inline.link=replace(inline.link)("inside",inline._inside)("href",inline._href)(),inline.reflink=replace(inline.reflink)("inside",inline._inside)(),inline.normal=merge({},inline),inline.pedantic=merge({},inline.normal,{strong:/^__(?=\S)([\s\S]*?\S)__(?!_)|^\*\*(?=\S)([\s\S]*?\S)\*\*(?!\*)/,em:/^_(?=\S)([\s\S]*?\S)_(?!_)|^\*(?=\S)([\s\S]*?\S)\*(?!\*)/,math:noop}),inline.gfm=merge({},inline.normal,{escape:replace(inline.escape)("])","~|])")(),url:/^(https?:\/\/[^\s<]+[^<.,:;"')\]\s])/,del:/^~~(?=\S)([\s\S]*?\S)~~/,text:replace(inline.text)("]|","~]|")("|","|https?://|")()}),inline.breaks=merge({},inline.gfm,{br:replace(inline.br)("{2,}","*")(),text:replace(inline.gfm.text)("{2,}","*")()}),InlineLexer.rules=inline,InlineLexer.output=function(src,links,options){var inline=new InlineLexer(links,options);
return inline.output(src)},InlineLexer.prototype.output=function(src){for(var out="",link,text,href,cap;src;)if(!(cap=this.rules.escape.exec(src)))if(!this.options.math||!(cap=this.rules.math.exec(src)))if(!(cap=this.rules.autolink.exec(src)))if(!(cap=this.rules.url.exec(src)))if(!(cap=this.rules.tag.exec(src)))if(!(cap=this.rules.link.exec(src)))if(!(cap=this.rules.reflink.exec(src))&&!(cap=this.rules.nolink.exec(src)))if(!(cap=this.rules.strong.exec(src)))if(!(cap=this.rules.em.exec(src)))if(!(cap=this.rules.code.exec(src)))if(!(cap=this.rules.br.exec(src)))if(!(cap=this.rules.del.exec(src)))if(!(cap=this.rules.text.exec(src))){if(src)throw new Error("Infinite loop on byte: "+src.charCodeAt(0))}else src=src.substring(cap[0].length),out+=escape(this.smartypants(cap[0]));else src=src.substring(cap[0].length),out+="<del>"+this.output(cap[1])+"</del>";else src=src.substring(cap[0].length),out+="<br>";else src=src.substring(cap[0].length),out+="<code>"+escape(cap[2],!0)+"</code>";else src=src.substring(cap[0].length),out+="<em>"+this.output(cap[2]||cap[1])+"</em>";else src=src.substring(cap[0].length),out+="<strong>"+this.output(cap[2]||cap[1])+"</strong>";else{if(src=src.substring(cap[0].length),link=(cap[2]||cap[1]).replace(/\s+/g," "),link=this.links[link.toLowerCase()],!link||!link.href){out+=cap[0].charAt(0),src=cap[0].substring(1)+src;continue}out+=this.outputLink(cap,link)}else src=src.substring(cap[0].length),out+=this.outputLink(cap,{href:cap[2],title:cap[3]});else src=src.substring(cap[0].length),out+=this.options.sanitize?escape(cap[0]):cap[0];else src=src.substring(cap[0].length),text=escape(cap[1]),href=text,out+='<a href="'+href+'">'+text+"</a>";else{if(src=src.substring(cap[0].length),"@"===cap[2])text=":"===cap[1].charAt(6)?this.mangle(cap[1].substring(7)):this.mangle(cap[1]),href=this.mangle("mailto:")+text;else text=escape(cap[1]),href=text;out+='<a href="'+href+'">'+text+"</a>"}else src=src.substring(cap[0].length),out+="$$"+cap[1]+"$$";else src=src.substring(cap[0].length),out+=cap[1];return out},InlineLexer.prototype.outputLink=function(cap,link){if("!"!==cap[0].charAt(0))return'<a href="'+escape(link.href)+'"'+(link.title?' title="'+escape(link.title)+'"':"")+">"+this.output(cap[1])+"</a>";else return'<img src="'+escape(link.href)+'" alt="'+escape(cap[1])+'"'+(link.title?' title="'+escape(link.title)+'"':"")+">"},InlineLexer.prototype.smartypants=function(text){if(!this.options.smartypants)return text;else return text.replace(/--/g,"—").replace(/(^|[-\u2014/(\[{"\s])'/g,"$1‘").replace(/'/g,"’").replace(/(^|[-\u2014/(\[{\u2018\s])"/g,"$1“").replace(/"/g,"”").replace(/\.{3}/g,"…")},InlineLexer.prototype.mangle=function(text){for(var out="",l=text.length,i=0,ch;l>i;i++){if(ch=text.charCodeAt(i),Math.random()>.5)ch="x"+ch.toString(16);out+="&#"+ch+";"}return out},Parser.parse=function(src,options){var parser=new Parser(options);return parser.parse(src)},Parser.prototype.parse=function(src){this.inline=new InlineLexer(src.links,this.options),this.tokens=src.reverse();for(var out="";this.next();)out+=this.tok();return out},Parser.prototype.next=function(){return this.token=this.tokens.pop()},Parser.prototype.peek=function(){return this.tokens[this.tokens.length-1]||0},Parser.prototype.parseText=function(){for(var body=this.token.text;"text"===this.peek().type;)body+="\n"+this.next().text;return this.inline.output(body)},Parser.prototype.tok=function(){switch(this.token.type){case"space":return"";case"hr":return"<hr>\n";case"heading":return"<h"+this.token.depth+' id="'+this.options.headerPrefix+this.token.text.toLowerCase().replace(/[^\w]+/g,"-")+'">'+this.inline.output(this.token.text)+"</h"+this.token.depth+">\n";case"code":if(this.options.highlight){var code=this.options.highlight(this.token.text,this.token.lang);if(null!=code&&code!==this.token.text)this.token.escaped=!0,this.token.text=code}if(!this.token.escaped)this.token.text=escape(this.token.text,!0);return"<pre><code"+(this.token.lang?' class="'+this.options.langPrefix+this.token.lang+'"':"")+">"+this.token.text+"</code></pre>\n";case"table":var body="",heading,i,row,cell,j;for(body+="<thead>\n<tr>\n",i=0;i<this.token.header.length;i++){if(heading=this.inline.output(this.token.header[i]),body+="<th",this.token.align[i])body+=' style="text-align:'+this.token.align[i]+'"';body+=">"+heading+"</th>\n"}for(body+="</tr>\n</thead>\n",body+="<tbody>\n",i=0;i<this.token.cells.length;i++){for(row=this.token.cells[i],body+="<tr>\n",j=0;j<row.length;j++){if(cell=this.inline.output(row[j]),body+="<td",this.token.align[j])body+=' style="text-align:'+this.token.align[j]+'"';body+=">"+cell+"</td>\n"}body+="</tr>\n"}return body+="</tbody>\n","<table>\n"+body+"</table>\n";case"blockquote_start":for(var body="";"blockquote_end"!==this.next().type;)body+=this.tok();return"<blockquote>\n"+body+"</blockquote>\n";case"list_start":for(var type=this.token.ordered?"ol":"ul",body="";"list_end"!==this.next().type;)body+=this.tok();return"<"+type+">\n"+body+"</"+type+">\n";case"list_item_start":for(var body="";"list_item_end"!==this.next().type;)body+="text"===this.token.type?this.parseText():this.tok();return"<li>"+body+"</li>\n";case"loose_item_start":for(var body="";"list_item_end"!==this.next().type;)body+=this.tok();return"<li>"+body+"</li>\n";case"html":return!this.token.pre&&!this.options.pedantic?this.inline.output(this.token.text):this.token.text;case"paragraph":return"<p>"+this.inline.output(this.token.text)+"</p>\n";case"text":return"<p>"+this.parseText()+"</p>\n"}},noop.exec=noop,marked.options=marked.setOptions=function(opt){return merge(marked.defaults,opt),marked},marked.defaults={gfm:!0,tables:!0,breaks:!1,pedantic:!1,sanitize:!1,smartLists:!1,silent:!1,highlight:null,langPrefix:"lang-",smartypants:!1,headerPrefix:""},marked.Parser=Parser,marked.parser=Parser.parse,marked.Lexer=Lexer,marked.lexer=Lexer.lex,marked.InlineLexer=InlineLexer,marked.inlineLexer=InlineLexer.output,marked.parse=marked,"object"==typeof exports)module.exports=marked;else if("function"==typeof define&&define.amd)define("js/lib/marked",[],function(){return marked});else this.marked=marked}.call(function(){return this||("undefined"!=typeof window?window:global)}()),define("pages/forum/models/EntryModel",["underscore","backbone","pages/spark/app","js/lib/backbone.api","backbone.relational","js/lib/marked"],function(_,Backbone,Coursera,BackboneModelAPI,BackboneRelational,Marked){var model=Backbone.RelationalModel.extend({defaults:{_viewer_vote:0,_viewer_voted:!1},api:Coursera.api,partialUpdate:!0,textProp:null,entryType:null,initialize:function(){this.bind("change",this.updateThreadMaybe,this)},updateThreadMaybe:function(){if(this.changedAttributes()&&_.contains(_.keys(this.changedAttributes()),"_viewer_subscription")&&this.get("thread"))this.get("thread").set("_viewer_subscription",this.get("_viewer_subscription"))},getPermalinkHash:function(){return this.entryType+"-"+this.get("id")},getPermalink:function(){if(this.get("thread")&&this.get("thread").get("link"))return this.get("thread").get("link")+"#"+this.getPermalinkHash();else return window.location.href.split("#")[0]+"#"+this.getPermalinkHash()},votesUrl:function(){return this.url()+"/"+this.get("id")+"/votes"},reportsUrl:function(){return this.url()+"/"+this.get("id")+"/reports"},getMessageHtml:function(){var message=this.get(this.textProp);if(!message)return"";if("html"==this.get("text_type"))return message;else return Marked(message)},getEditableHtml:function(){return this.getMessageHtml().replace("&lt;","&amp;lt;").replace("&gt;","&amp;gt;")}});return _.extend(model.prototype,BackboneModelAPI),model}),define("pages/forum/models/PostModel",["pages/forum/models/EntryModel"],function(EntryModel){return EntryModel.extend({defaults:{order:9999999999},textProp:"post_text",entryType:"post",url:function(){return"forum/threads/"+this.get("thread_id")+"/posts"}})}),define("pages/forum/models/PostCollection",["backbone","pages/forum/models/PostModel"],function(Backbone,PostModel){var PostCollection=Backbone.Collection.extend({model:PostModel});return PostCollection}),define("pages/forum/models/CommentModel",["pages/forum/models/EntryModel"],function(EntryModel){var model=EntryModel.extend({textProp:"comment_text",entryType:"comment",url:function(){return"forum/posts/"+this.get("post_id")+"/comments"}});return model}),define("pages/forum/models/CommentCollection",["backbone","pages/forum/models/CommentModel"],function(Backbone,CommentModel){var CommentCollection=Backbone.Collection.extend({model:CommentModel});return CommentCollection}),!function(){var BadgevilleUtil=function($){return BadgevilleUtil};if(BadgevilleUtil.isEnabled=function(){return!!window.Badgeville},BadgevilleUtil.isAPILoaded=function(){return!(!window.Badgeville||!window.BVSDK)},BadgevilleUtil.getPlayerId=function(userId){return userId+"@badgeville.coursera.org"},BadgevilleUtil.getPlayerObject=function(playerId,callback){if(BadgevilleUtil.isEnabled()){if(!Badgeville.PlayerCache)Badgeville.PlayerCache={};var playerObject=Badgeville.PlayerCache[playerId];if(playerObject)callback(playerObject);else Badgeville.getPlayer(playerId,function(playerObject){callback(playerObject),Badgeville.PlayerCache[playerId]=playerObject})}},BadgevilleUtil.setupPlayerTip=function(userId,$dom){if(BadgevilleUtil.isEnabled()){var playerId=BadgevilleUtil.getPlayerId(userId);BadgevilleUtil.getPlayerObject(BadgevilleUtil.getPlayerId(userId),function(playerObject){Badgeville.Gears.playerTip(window.Badgeville($dom),playerObject)})}},BadgevilleUtil.renderByline=function(rewards,$dom){function makeBadge($dom,label,count,color){if(0!==count){var $badgeSpan=$("<span></span>").css("margin-right","5px").attr("title",count+" "+label+" badges"),$colorSpan=$('<span class="icon-circle"></span>');$colorSpan.css({color:color,fontSize:"10px"});var $countSpan=$("<span></span>").css("font-weight","bold").append(count);$badgeSpan.append($colorSpan),$badgeSpan.append("&nbsp;"),$badgeSpan.append($countSpan),$dom.append($badgeSpan)}}function isBadgeType(reward,type){if(!reward.tags)return!1;for(var i=0;i<reward.tags.length;i++)if(reward.tags[i].toLowerCase()==type.toLowerCase())return!0;return!1}for(var bronze=0,silver=0,gold=0,diamond=0,i=0;i<rewards.length;i++){var reward=rewards[i];if(reward.definition_id){var rewardName=reward.name;if(isBadgeType(reward,"diamond"))diamond++;else if(isBadgeType(reward,"gold"))gold++;else if(isBadgeType(reward,"silver"))silver++;else if(isBadgeType(reward,"bronze"))bronze++}else;}makeBadge($dom,"Bronze",bronze,"#a67c52"),makeBadge($dom,"Silver",silver,"#959595"),makeBadge($dom,"Gold",gold,"#dcae4b"),makeBadge($dom,"Diamond",diamond,"white")},BadgevilleUtil.setupByline=function(userId,$dom){if(BadgevilleUtil.isAPILoaded()){if(!Badgeville.RewardsCache)Badgeville.RewardsCache={};BadgevilleUtil.getPlayerObject(BadgevilleUtil.getPlayerId(userId),function(playerObject){if(Badgeville.RewardsCache[playerObject.id])BadgevilleUtil.renderByline(Badgeville.RewardsCache[playerObject.id],$dom);else BVSDK("players/rewards",{players:playerObject.id},{fields:"all",limit:50}).ok(function(data){Badgeville.RewardsCache[playerObject.id]=data.rewards,BadgevilleUtil.renderByline(Badgeville.RewardsCache[playerObject.id],$dom)})})}},BadgevilleUtil.setupMissionsDisplay=function(userId,$dom,enableLadder,pronoun){function setupRewardBadge(reward,rewardNum){var $rewardDiv=$("<div></div>").addClass("coursera-badgeville-missions-badge"),$rewardImg=$("<img></img>");if($rewardDiv.attr("title","To earn this badge, "+reward.hint),$rewardDiv.append($rewardImg),$rewardImg.attr("src",reward.image),rewardNum>0){if(rewardNum>1)$rewardDiv.append('<span class="coursera-badgeville-missions-badge-num">'+rewardNum+"</span>")}else $rewardImg.css("opacity",".4"),$rewardDiv.append('<span class="icon-lock"></span>');return $rewardDiv.append('<div class="coursera-badgeville-missions-badge-name">'+reward.name+"</div>"),$rewardDiv}if(BadgevilleUtil.isAPILoaded()){if(!Badgeville.MissionsCache)Badgeville.MissionsCache={};BadgevilleUtil.getPlayerObject(BadgevilleUtil.getPlayerId(userId),function(playerObject){var allRewardsPromise=BVSDK("rewards",{},{limit:50,fields:"all"}),playerRewardsPromise=BVSDK("players/rewards",{players:playerObject.id},{fields:"hint",limit:50}),siteMissionsPromise=BVSDK("missions",{players:playerObject.id},{includes:"rewards",fields:["hint","type"]});BVSDK.when(allRewardsPromise,playerRewardsPromise,siteMissionsPromise).ok(function(allRewardsData,playerRewardsData,siteMissionsData){function sortByMetal(rewardA,rewardB){function getValue(reward){if(0===reward.name.indexOf("Diamond"))return 4;if(0===reward.name.indexOf("Gold"))return 3;if(0===reward.name.indexOf("Silver"))return 2;if(0===reward.name.indexOf("Bronze"))return 1;else return 0}return getValue(rewardA)-getValue(rewardB)}var allRewards=allRewardsData.rewards,playerRewards=playerRewardsData.rewards,missions=siteMissionsData.missions,allRewardsHash={},playerRewardsHash={},mission,i,r,reward,rewardNum,$rewardDiv;for(i=allRewards.length;i--;)allRewardsHash[allRewards[i].id]=allRewards[i];for(i=playerRewards.length;i--;){if(!playerRewardsHash[playerRewards[i].definition_id])playerRewardsHash[playerRewards[i].definition_id]=[];playerRewardsHash[playerRewards[i].definition_id].push(playerRewards[i])}if(i=null,$dom.empty(),enableLadder){var singleNum=0,$singleHeader=$("<h5>Single Badges</h5>");for($dom.append($singleHeader),i=0;i<missions.length;i++)if(mission=missions[i],"progressive"!=mission.type){for(mission.rewards.sort(sortByMetal),r=0;r<mission.rewards.length;r++)if(reward=allRewardsHash[mission.rewards[r].definition_id],rewardNum=(playerRewardsHash[mission.rewards[r].definition_id]||[]).length,rewardNum>0)$rewardDiv=setupRewardBadge(reward,rewardNum),$dom.append($rewardDiv),singleNum+=rewardNum}else;$singleHeader.append(" ("+singleNum+" earned)");var seriesNum=0,$seriesHeader=$("<h5>Badge Series</h5>");$dom.append($seriesHeader);var $headerDiv=$("<div></div>").addClass("coursera-badgeville-missions-header");for($headerDiv.append("<div></div>"),$headerDiv.append("<h4>Bronze</h4>"),$headerDiv.append("<h4>Silver</h4>"),$headerDiv.append("<h4>Gold</h4>"),$headerDiv.append("<h4>Diamond</h4>"),$dom.append($headerDiv),i=0;i<missions.length;i++)if(mission=missions[i],"progressive"==mission.type){var $missionDiv=$("<div></div>").addClass("coursera-badgeville-missions-mission"),$labelDiv=$("<div></div>");$labelDiv.append("<h5>"+mission.name+"</h5>"),$missionDiv.append($labelDiv);var nextTip=null,nextBadge=null;for(mission.rewards.sort(sortByMetal),r=0;r<mission.rewards.length;r++){if(reward=allRewardsHash[mission.rewards[r].definition_id],rewardNum=(playerRewardsHash[mission.rewards[r].definition_id]||[]).length,$rewardDiv=setupRewardBadge(reward,rewardNum),0===rewardNum&&!nextTip)nextTip=reward.hint,nextBadge=reward.name.split("-")[0];if($missionDiv.append($rewardDiv),r<mission.rewards.length-1){var $bridgeDiv=$("<div></div>").addClass("coursera-badgeville-missions-bridge");$missionDiv.append($bridgeDiv)}if(rewardNum)seriesNum+=rewardNum}if(nextTip)$labelDiv.append("<p>To earn the next badge ("+nextBadge+"), "+pronoun+" must "+nextTip+".</p>");else $labelDiv.append("<p>Congrats! You earned every badge in this series!</p>");$dom.append($missionDiv)}else;$seriesHeader.append(" ("+seriesNum+" earned)")}else{for($dom.append("<h5>Badges</h5>"),i=0;i<missions.length;i++)for(mission=missions[i],mission.rewards.sort(sortByMetal),r=0;r<mission.rewards.length;r++)if(reward=allRewardsHash[mission.rewards[r].definition_id],rewardNum=(playerRewardsHash[mission.rewards[r].definition_id]||[]).length,rewardNum>0)$rewardDiv=setupRewardBadge(reward,rewardNum),$dom.append($rewardDiv);if($dom.is(":empty"))$dom.html("No badges yet. ☹")}})})}},BadgevilleUtil.setupMissionsExplanation=function(userId,$dom,enableLadder,pronoun){function setupRewardBadge(reward){var $rewardDiv=$("<div></div>").css({"float":"left",position:"relative"}),$rewardImg=$("<img></img>").css({width:"65px",height:"64px"});$rewardDiv.append($rewardImg),$rewardImg.attr("src",reward.image_medium_url);var re=new RegExp(/\d+\s\w+/),tip=reward.tip.match(re)&&reward.tip.match(re)[0];if(tip)$rewardDiv.append("<div>"+tip+"</div>").css({"text-align":"center","font-size":"13px"});return $rewardDiv}if(BadgevilleUtil.isAPILoaded())pronoun="you",BadgevilleUtil.getPlayerObject(BadgevilleUtil.getPlayerId(userId),function(playerObject){Badgeville.getAPI("player_site_missions",{id:playerObject.id},function(data){$dom.empty();var missions=data.missions,mission,i,r,reward,rewardNum,$rewardDiv,headerCss={"border-bottom":"1px solid #CCC",clear:"left","padding-top":"15px"};for($dom.append($("<h5>Single Badges</h5>").css(headerCss)),i=0;i<missions.length;i++)if(mission=missions[i],"ladder"!=mission.type)for(r=0;r<mission.reward_definitions.length;r++){reward=mission.reward_definitions[r];var $badgeDiv=$("<div></div>").css({"float":"left","margin-top":"10px"}),$descripDiv=$("<div></div>").css({width:"300px","float":"left","padding-left":"8px"});$descripDiv.append($("<h5>"+reward.name+"</h5>").css({"margin-top":"0px","margin-bottom":"0px"})),$descripDiv.append($("<p>To earn this badge, "+reward.tip+"</p>").css({margin:"0px","margin-right":"10px"})),$rewardDiv=setupRewardBadge(reward),$badgeDiv.append($rewardDiv),$badgeDiv.append($descripDiv),$dom.append($badgeDiv)}else;$dom.append($("<h5>Badge Series</h5>").css(headerCss)).css("clear","left");var $headerDiv=$("<div></div>").css("clear","left");$headerDiv.append($("<div>&nbsp;</div>").css({width:"300px","float":"left"}));var h4css={width:"63px","margin-right":"20px","text-align":"center","float":"left","font-size":"11px","margin-bottom":"0px","margin-top":"0px","text-transform":"uppercase"};for($headerDiv.append($("<h4>Bronze</h4>").css(h4css)),$headerDiv.append($("<h4>Silver</h4>").css(h4css)),$headerDiv.append($("<h4>Gold</h4>").css(h4css)),$headerDiv.append($("<h4>Diamond</h4>").css(h4css)),$dom.append($headerDiv),i=0;i<missions.length;i++)if(mission=missions[i],"ladder"==mission.type){var $missionDiv=$("<div></div>").css({"padding-top":"10px",clear:"left"}),$labelDiv=$("<div></div>").css({width:"300px","float":"left"});$labelDiv.append($("<h5>"+mission.name+"</h5>").css("margin-top","0px")),$labelDiv.append($("<p>To earn these badges, "+mission.tip+"</p>").css({margin:"0px","margin-right":"10px"})),$missionDiv.append($labelDiv);var nextTip=null,nextBadge=null;for(r=0;r<mission.reward_definitions.length;r++)if(reward=mission.reward_definitions[r],rewardNum=mission.reward_counters[reward.id],$rewardDiv=setupRewardBadge(reward,rewardNum),$missionDiv.append($rewardDiv),r<mission.reward_definitions.length-1){var $bridgeDiv=$("<div></div>").css({"background-color":"#BDBDBD",width:"20px",height:"20px","float":"left","border-top":"4px solid lightGrey","border-bottom":"4px solid #9C9C9C","margin-top":"20px","margin-left":"-1px","margin-right":"-1px"});$missionDiv.append($bridgeDiv)}$dom.append($missionDiv)}else;$dom.append('<p style="clear:both">* A reply/thread is considered "good" if it has been upvoted by 3 of your classmates.</p>')})})},BadgevilleUtil.setPlayer=function(userDetails){if(BadgevilleUtil.isEnabled())window.Badgeville.setPlayer({display_name:userDetails.name,nickname:userDetails.id,email:BadgevilleUtil.getPlayerId(userDetails.id),picture_url:userDetails.photo||null})},BadgevilleUtil.credit=function(behavior,callback){if(BadgevilleUtil.isEnabled())window.Badgeville.credit(behavior,function(data){if(callback)callback(data)})},BadgevilleUtil.creditOther=function(userId,behavior){if(BadgevilleUtil.isEnabled())window.Badgeville.creditOther(BadgevilleUtil.getPlayerId(userId),behavior)},BadgevilleUtil.getUserBucket=function(userId){var buckets=[{top_byline:0,thread_byline:0,badge_ladder:0},{top_byline:0,thread_byline:0,badge_ladder:1},{top_byline:0,thread_byline:1,badge_ladder:0},{top_byline:0,thread_byline:1,badge_ladder:1},{top_byline:1,thread_byline:0,badge_ladder:0},{top_byline:1,thread_byline:0,badge_ladder:1},{top_byline:1,thread_byline:1,badge_ladder:0},{top_byline:1,thread_byline:1,badge_ladder:1}],bucket=buckets[userId%8];return bucket},BadgevilleUtil.getWeek=function(date){var weekNum=1,startDate=new Date(2013,3,22),today=date||new Date,diff=today.getTime()-startDate.getTime(),weekDiff=diff/1e3/60/60/24/7;if(weekDiff>0)weekNum=Math.ceil(weekDiff);return weekNum},"function"==typeof define&&define.amd)define("js/lib/badgeville",["jquery"],function($){return new BadgevilleUtil($)});else window.BadgevilleUtil=BadgevilleUtil}(),define("pages/triage/constants",[],function(){return{sync_codes:{TRIAGE_SYNC_NOTRIAGE:0,TRIAGE_SYNC_SUCCESS:1,TRIAGE_SYNC_FAILED:-1},status_codes:{1:"New",2:"Reopened",311:"Investigating",411:"Resolved",420:"No Reponse Needed"},open_status_codes:[1,2,311],resolved_status_codes:[411],closed_status_codes:[411,420],priorities:{0:"No Priority",1:"Low",2:"Standard",3:"Urgent",4:"Wakeup"}}}),define("pages/forum/models/ThreadModel",["jquery","underscore","backbone","js/lib/api","js/lib/util","pages/spark/app","pages/forum/models/PostModel","pages/forum/models/PostCollection","pages/forum/models/CommentModel","pages/forum/models/CommentCollection","js/lib/badgeville","js/lib/backbone.api","backbone.relational","pages/triage/constants"],function($,_,Backbone,API,util,Coursera,PostModel,PostCollection,CommentModel,CommentCollection,BadgevilleUtil,BackboneModelAPI,backboneRelational,triageConstants){var model=Backbone.RelationalModel.extend({url:"forum/threads",subscriptionsUrl:function(){return this.url+"/"+this.get("id")+"/subscriptions"},tagsUrl:function(){return this.url+"/"+this.get("id")+"/tags"},triagePingUrl:function(){return this.url+"/"+this.get("id")+"/triage_ping"},triageStatusUrl:function(){return this.url+"/"+this.get("id")+"/triage_change_status"},api:Coursera.api,partialUpdate:!0,defaults:{_user_profiles:{},tags:[],sort:"oldest","private":0,problem_id:null},relations:[{type:Backbone.HasMany,key:"posts",relatedModel:PostModel,collectionType:PostCollection,reverseRelation:{key:"thread"},includeInJSON:!0,collectionOptions:{comparator:function(post){return post.get("order")}}},{type:Backbone.HasMany,key:"comments",relatedModel:CommentModel,collectionType:CommentCollection,reverseRelation:{key:"thread"},includeInJSON:!0}],initialize:function(){this.bind("change",this.updateComputed,this),this.set("sort",util.getUrlParam(window.location,"sort")),this.courseraWWWAPI=API("",{type:"rest","csrf.cookie":"csrf_token","csrf.token":"X-CSRF-Token"})},updateComputed:function(){var self=this;if(!this.get("_ignore_profiles")){var userIds=[];if(this.get("posts").each(function(post){userIds.push(post.get("user_id"))}),this.get("comments").each(function(comment){userIds.push(comment.get("user_id"))}),this.attributes._user_ids=userIds,userIds.length>0)this.getUserProfiles(),this.updateProfilesOnEntries()}},updateRange:function(){var first=this.getFirstPost(),last=this.getLastPost();this.set({start_range:first.get("order"),end_range:last.get("order")})},getPostsBefore:function(cb){var self=this,id=self.getFirstPostId();this.api.get("forum/threads/"+this.get("id"),{data:{post_id:id,position:"before",sort:this.get("_sort_order")},message:{waiting:"fetching earlier posts",success:"earlier posts fetched"}}).done(_.bind(this.onFetchPosts,self,cb))},getPostsAfter:function(cb){var self=this,id=self.getLastPostId();this.api.get("forum/threads/"+this.get("id"),{data:{post_id:id,position:"after",sort:this.get("_sort_order")},message:{waiting:"fetching next posts",success:"next posts fetched"}}).done(_.bind(this.onFetchPosts,self,cb))},onFetchPosts:function(cb,data){if(data)this.set(data,{silent:!0});if(this.updateRange(),cb)cb.call(this)},getSavedPosts:function(){var savedPosts=this.get("posts").filter(function(post){return!post.isNew()});return savedPosts},getFullPosts:function(){var fullPosts=this.get("posts").filter(function(post){return post.get("post_time")});return fullPosts},getFirstPost:function(){return this.getFullPosts().shift()},getLastPost:function(){return this.getFullPosts().pop()},getFirstPostId:function(){return this.getFirstPost().get("id")},getLastPostId:function(){return this.getLastPost().get("id")},getCommentsForPost:function(post){var self=this,comments=this.get("comments").filter(function(comment){return comment.get("post_id")==post.get("id")});return new CommentCollection(comments)},updateProfilesOnEntries:function(){var self=this;_.each(self.get("_user_profiles"),function(profile){self.get("comments").each(function(entry){if(entry.get("user_id")==profile.id&&!entry.get("_user_profile"))entry.set("_user_profile",profile)}),self.get("posts").each(function(entry){if(entry.get("user_id")==profile.id&&!entry.get("_user_profile"))entry.set("_user_profile",profile)})})},getUserProfiles:function(){var self=this,newIds=_.filter(self.get("_user_ids"),function(id){return id&&!self.get("_user_profiles")[id]});newIds=_.uniq(newIds);var url=Coursera.config.url.base+Coursera.config.url.api+"user/profiles?user-ids="+newIds.join(",");self.courseraWWWAPI.get(url,{dataType:"jsonp",type:"get",success:function(profiles){_.each(profiles,function(profile){if(!self.get("_user_profiles")[profile.id])self.get("_user_profiles")[profile.id]=profile;if(Coursera.user.get("id")===profile.id)BadgevilleUtil.setPlayer({name:profile.display_name,id:profile.id,photo:profile.photo_120})}),self.updateProfilesOnEntries()}})},getTotalVotes:function(){var totalVotes=0;return this.get("comments").each(function(entry){totalVotes+=entry.get("votes")||0}),this.get("posts").each(function(entry){totalVotes+=entry.get("votes")||0}),totalVotes},userContributed:function(userId){var self=this,foundUser=!1;return self.get("comments").each(function(entry){if(entry.get("user_id")==userId)foundUser=!0}),self.get("posts").each(function(entry){if(entry.get("user_id")==userId)foundUser=!0}),foundUser},getURLForSortOrder:function(order){var url=window.location.pathname+window.location.search.split("&sort")[0]+"&sort="+order;return url},isUnresolved:function(){switch(this.threadResolutionType()){case"forum-backed":case"unresolvable":return 1===this.get("unresolved");case"triage-backed":return _.contains(triageConstants.open_status_codes,this.get("triage_status"))}},isResolved:function(){switch(this.threadResolutionType()){case"forum-backed":return 0===this.get("unresolved");case"triage-backed":return _.contains(triageConstants.resolved_status_codes,this.get("triage_status"));case"unresolvable":return!1}},viewerCanResolve:function(){switch(this.threadResolutionType()){case"forum-backed":return this.get("_viewer_can_resolve_without_triage");case"triage-backed":return this.get("_viewer_can_resolve_with_triage");case"unresolvable":return!1}},setResolved:function(resolved){var self=this;switch(this.threadResolutionType()){case"forum-backed":return this.update({unresolved:!resolved},{silent:!1,message:{waiting:"Processing...",success:"Processed!"}});case"triage-backed":var newStatusName=resolved?"Resolved":"Reopened",newStatus;return _.each(triageConstants.status_codes,function(name,code){if(name==newStatusName)newStatus=parseInt(code,10)}),Coursera.api.post(this.triageStatusUrl(),{message:{waiting:"Processing...",success:"Processed!"},data:{status:newStatus}}).done(function(data){data.unresolved=!resolved,self.set(data)});case"unresolvable":return}},threadResolutionType:function(){if(this.get("triage_sync_status")==triageConstants.sync_codes.TRIAGE_SYNC_SUCCESS)return"triage-backed";else if(this.get("_thread_can_be_resolved_without_triage"))return"forum-backed";else return"unresolvable"}});return _.extend(model.prototype,BackboneModelAPI),model}),define("pages/forum/models/ForumModel",["underscore","backbone","js/lib/backbone.api","backbone.relational","js/lib/util","pages/spark/app"],function(_,Backbone,BackboneModelAPI,BackboneRelational,util,Coursera){var model=Backbone.RelationalModel.extend({defaults:{},url:"forum/forums",api:Coursera.api,subscriptionsUrl:function(id){if("undefined"==typeof id)id=this.get("id");return this.url+"/"+id+"/subscriptions"},readRecordsUrl:function(){return this.url+"/"+this.get("id")+"/read_records"},getParent:function(){return this.collection.get(this.get("parent_id"))},getFullName:function(){var parent=this.getParent(),name=this.get("name");if(!parent||-1==parent.get("parent_id"))return name;else return parent.getFullName()+" > "+name},isOpen:function(){var d=new Date(0);return d.setUTCSeconds(this.get("open_time")),d<=new Date}});return _.extend(model.prototype,BackboneModelAPI),model}),define("pages/forum/models/ThreadCollection",["backbone","pages/forum/models/ThreadModel"],function(Backbone,ThreadModel){var collection=Backbone.Collection.extend({model:ThreadModel});return collection}),define("pages/forum/models/ForumThreadsModel",["underscore","backbone","js/lib/backbone.api","js/lib/util","pages/spark/app","pages/forum/models/ThreadModel","pages/forum/models/ThreadCollection"],function(_,Backbone,BackboneModelAPI,util,Coursera,ThreadModel,ThreadCollection){var model=Backbone.Model.extend({defaults:{page:1,page_size:25,sort:"lastupdated",threads:new ThreadCollection},api:Coursera.api,loadPage:function(pageNum){var self=this,url="forum/forums/"+this.get("id")+"/threads";return Coursera.api.get(url,{data:{sort:this.get("sort"),tag_id:this.get("tag_id"),tag_name:this.get("tag_name"),page:pageNum,page_size:this.get("page_size")},message:{waiting:"Fetching forum threads...",success:"Fetched threads!"}}).done(function(data){data.threads=new ThreadCollection(data.threads),self.set(data)})}});return _.extend(model.prototype,BackboneModelAPI),model}),define("pages/forum/models/ReputationsCollection",["underscore","backbone","pages/spark/app","pages/spark/models/user","js/lib/backbone.api"],function(_,Backbone,Coursera,UserModel,BackboneModelAPI){var collection=Backbone.Collection.extend({model:UserModel,url:"forum/reputations",api:Coursera.api});return _.extend(collection.prototype,BackboneModelAPI),collection}),!function(wndw){var jadify=function(jade,_t){var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(reporterLink){buf.push('<a target="_blank"'+jade.attr("href",reporterLink,!0,!1)+' title="Help center for course issues. This will open in a new tab." class="coursera-reporter-link">Help</a><div class="course-forum-thread-crumbs"></div><div class="course-forum-thread-header-wrapper"></div><div class="course-forum-thread-sort"></div><div class="course-forum-thread-tags"></div><div class="course-forum-thread-area-container"><div class="course-forum-top-scroll-indicator">⬆ scroll up for more ⬆</div><div style="clear: right;" class="course-forum-thread-posts-container"></div><div class="course-forum-bottom-scroll-indicator">⬇ scroll down for more ⬇</div><div class="course-forum-thread-new-post"></div></div><div style="display:none; position: fixed; bottom: 10px; right: 40px; width: 240px;" class="alert alert-info course-forum-hangouts-popup"><button type="button" data-action="hide" class="close">&times;</button>This looks like a great topic! Maybe you\'d like to...<a style="margin-bottom:6px;" data-action="start" class="btn btn-info">Start a Google+ Hangout on this topic</a><p style="margin-bottom:10px; display:none;">Go to <a href="https://class.coursera.org/behavioralecon-001/wiki/view?page=ScheduleGoogleHangouts&from_popout" target="_blank">the scheduler page</a> to learn how, and post the URL to this thread after to let people know.</p><a data-action="join" class="btn btn-info">Join a Google+ Hangout on this topic</a><p style="margin-bottom:15px; display:none;">Hm, it looks like there\'s none yet on this topic, but you can <a href="https://class.coursera.org/behavioralecon-001/wiki/view?page=ScheduleGoogleHangouts&from_popout" target="_blank">go here</a> to check out all the upcoming hangouts or schedule your own.</p><a href="javascript:void(0)" data-action="nothanks">No, thanks, I\'m not interested in hangouts.</a></div>')
}("reporterLink"in locals_for_with?locals_for_with.reporterLink:"undefined"!=typeof reporterLink?reporterLink:void 0),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("pages/forum/views/ThreadView.html",["js/lib/jade"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["pages.forum.views.ThreadView"]=jadify(wndw.jade.helpers)}(window),!function(wndw){var jadify=function(jade,_t){_t="undefined"!=typeof _t?_t:function(key,interpolationHash){if("object"==typeof interpolationHash)return key.replace(/[#!]\{([^}]+?)\}/g,function(match,interpKey){return interpolationHash[interpKey]||interpKey});else return key};var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(thread){if(thread.get("num_posts")>1)buf.push('<ul class="nav nav-pills pull-right"><li><span style="padding: 8px; display: inline-block;">Sort replies by:</span></li><li data-sort-name="oldest"><a'+jade.attr("href",thread.getURLForSortOrder("oldest"),!0,!1)+'>Oldest first</a></li><li data-sort-name="newest"><a'+jade.attr("href",thread.getURLForSortOrder("newest"),!0,!1)+'>Newest first</a></li><li data-sort-name="popular"><a'+jade.attr("href",thread.getURLForSortOrder("popular"),!0,!1)+">Most popular</a></li></ul>")}("thread"in locals_for_with?locals_for_with.thread:"undefined"!=typeof thread?thread:void 0),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("pages/forum/views/ThreadSortView.html",["js/lib/jade"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["pages.forum.views.ThreadSortView"]=jadify(wndw.jade.helpers)}(window),!function(wndw){var jadify=function(jade,_t){_t="undefined"!=typeof _t?_t:function(key,interpolationHash){if("object"==typeof interpolationHash)return key.replace(/[#!]\{([^}]+?)\}/g,function(match,interpKey){return interpolationHash[interpKey]||interpKey});else return key};var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(_,crumbs){buf.push('<ul class="course-forum-breadcrumb">'),_.each(crumbs,function(crumb,i){if(buf.push("<li><a"+jade.attr("href",crumb.link,!0,!1)+">"+jade.escape(null==(jade_interp=crumb.title)?"":jade_interp)+"</a>"),i!==crumbs.length-1)buf.push('<span class="divider"> / </span>');buf.push("</li>")}),buf.push("</ul>")}("_"in locals_for_with?locals_for_with._:"undefined"!=typeof _?_:void 0,"crumbs"in locals_for_with?locals_for_with.crumbs:"undefined"!=typeof crumbs?crumbs:void 0),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("pages/forum/views/ForumCrumbsView.html",["js/lib/jade"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["pages.forum.views.ForumCrumbsView"]=jadify(wndw.jade.helpers)}(window),define("pages/forum/models/ForumCollection",["backbone","pages/forum/models/ForumModel"],function(Backbone,ForumModel){var ForumCollection=Backbone.Collection.extend({model:ForumModel,comparator:function(forum){return forum.getFullName()}});return ForumCollection}),define("js/lib/path",[],function(){var path={};return path.join=function(parts){var args=parts instanceof Array?parts:Array.prototype.slice.call(arguments);return args.join("/").replace(/[/]{2,}/g,"/")},path}),define("js/lib/jade._h",["js/lib/path"],function(path){var slice=Array.prototype.slice,_h={link:{outline:function(courseSlug){return path.join("/learn",courseSlug,"outline")}},merge:function(){var sources=[this].concat(slice.call(arguments)),merged={},length=sources.length,i,source,key;for(i=0;length>i;i++)if(source=sources[i])for(key in source)merged[key]=source[key];return merged}};return _h}),!function(wndw){var jadify=function(jade,_t,_h){var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(thread,user){if(1==thread.get("private"))buf.push('<div class="course-forum-thread-private alert alert-warning">This is a private thread. Only the author, university administrators, course staff, and Coursera staff can see the thread. </div>');if(buf.push('<div dir="auto" class="course-forum-thread-title"><h2>'+jade.escape(null==(jade_interp=thread.get("title"))?"":jade_interp)+'</h2></div><div class="course-forum-thread-header"><div class="course-forum-thread-controls">'),thread.get("stickied"))buf.push('<span title="This thread was pinned." class="course-forum-thread-indicator course-forum-indicator-good"><i title="Pinned Post" class="icon-pushpin"></i> Pinned</span>');if(thread.get("approved"))buf.push('<span title="This thread was approved by staff." class="course-forum-thread-indicator course-forum-indicator-good"><i class="icon-star"></i> Approved</span>');if(thread.isResolved())buf.push('<span title="This thread was marked as resolved." class="course-forum-thread-indicator course-forum-indicator-good"><i class="icon-check"></i> Resolved</span>');if(thread.isUnresolved())buf.push('<span title="This thread is unresolved." class="course-forum-thread-indicator"><i class="icon-question-sign"></i> Unresolved</span>');if(thread.get("locked"))buf.push('<span title="This thread was locked by an admin." class="course-forum-thread-indicator"><i class="icon-lock"></i> Locked</span>');if(thread.get("is_spam"))buf.push('<span title="This thread was marked as spam by an admin." class="course-forum-thread-indicator course-forum-indicator-bad"><i class="icon-trash"></i> Spam</span>');if(1==thread.get("deleted"))buf.push('<span title="This thread was deleted by an admin." class="course-forum-thread-indicator course-forum-indicator-bad"><i class="icon-trash"></i> Deleted</span>');var popupId="course-forum-thread-controls-popup"+thread.get("id");if(thread.get("_viewer_can_resolve_without_triage")||thread.get("_viewer_can_delete")||thread.get("_viewer_can_edit_title")||user.canModerateForum()){if(buf.push('<a title="Thread controls" tabindex="0" role="button" aria-haspopup="true" aria-expanded="false"'+jade.attr("aria-owns",popupId,!0,!1)+jade.attr("data-popup","#"+popupId,!0,!1)+' data-popup-direction="se" class="course-forum-thread-controls-toggle"><i class="icon-cog"><span class="hidden">Thread controls</span></i></a><div'+jade.attr("id",popupId,!0,!1)+' class="course-forum-thread-controls-popup hide">'),user.canModerateForum()){if(thread.get("locked"))buf.push('<a href="javascript:void(0)" data-property="locked" data-popup-close="data-popup-close" data-value="0" class="course-forum-thread-action-link">Un-lock</a>');else buf.push('<a href="javascript:void(0)" data-property="locked" data-popup-close="data-popup-close" data-value="1" class="course-forum-thread-action-link">Lock</a>');if(thread.get("stickied"))buf.push('<a href="javascript:void(0)" data-property="stickied" data-popup-close="data-popup-close" data-value="0" class="course-forum-thread-action-link">Un-pin</a>');else buf.push('<a href="javascript:void(0)" data-property="stickied" data-popup-close="data-popup-close" data-value="1" class="course-forum-thread-action-link">Pin</a>');if(thread.get("approved"))buf.push('<a href="javascript:void(0)" data-property="approved" data-popup-close="data-popup-close" data-value="0" class="course-forum-thread-action-link">Un-approve</a>');else buf.push('<a href="javascript:void(0)" data-property="approved" data-popup-close="data-popup-close" data-value="1" class="course-forum-thread-action-link">Approve</a>');if(thread.get("is_spam"))buf.push('<a href="javascript:void(0)" data-property="is_spam" data-popup-close="data-popup-close" data-value="0" class="course-forum-thread-action-link">Not spam</a>');else buf.push('<a href="javascript:void(0)" data-property="is_spam" data-popup-close="data-popup-close" data-value="1" class="course-forum-thread-action-link">Spam</a>')}if(thread.get("_viewer_can_edit_title"))buf.push('<a href="javascript:void(0)" data-popup-close="data-popup-close" class="course-forum-thread-edit-title-link">Edit title</a>');if(thread.get("_viewer_can_delete"))if(thread.get("deleted"))buf.push('<a href="javascript:void(0)" data-popup-close="data-popup-close" data-property="deleted" data-value="0" class="course-forum-thread-action-link">Un-delete</a>');else buf.push('<a href="javascript:void(0)" data-popup-close="data-popup-close" data-property="deleted" data-value="1" class="course-forum-thread-action-link">Delete</a>');if(buf.push('<a href="javascript:void(0)" data-property="move" data-popup-close="data-popup-close" class="course-forum-thread-move-link">Move Thread</a>'),thread.viewerCanResolve())if(thread.isResolved())buf.push('<a href="javascript:void(0)" data-popup-close="data-popup-close" data-property="unresolved" data-value="1" class="course-forum-thread-action-link">Un-resolve</a>');else if(thread.isUnresolved())buf.push('<a href="javascript:void(0)" data-popup-close="data-popup-close" data-property="unresolved" data-value="0" class="course-forum-thread-action-link">Resolve</a>');if(user.canModerateForum())buf.push('<a href="javascript:void(0)" data-popup-close="data-popup-close" class="course-forum-thread-admin-details-link">Show Admin Details</a>');if(thread.get("triageEnabled")&&user.canModerateForum())buf.push('<a href="javascript:void(0)" data-popup-close="data-popup-close" class="course-forum-thread-ping-coursera">Notify Coursera</a>');if(thread.get("triagerLink"))buf.push('<a target="_blank"'+jade.attr("href",thread.get("triagerLink"),!0,!1)+' data-popup-close="data-popup-close">Detailed Issue Status</a>');if(thread.get("_viewer_can_toggle_private"))if(thread.get("private"))buf.push('<a href="javascript:void(0)" data-popup-close="data-popup-close" data-property="private" data-value="0" class="course-forum-thread-action-link">Make Public</a>');else buf.push('<a href="javascript:void(0)" data-popup-close="data-popup-close" data-property="private" data-value="1" class="course-forum-thread-action-link">Make Private</a>');buf.push("</div>")}if(buf.push('</div><div style="margin-right:10px; display:inline-block;">'),thread.get("_viewer_subscription"))buf.push('<i class="icon-envelope"></i> You are subscribed.  <a href="javascript:void(0);" class="course-forum-thread-unsubscribe-link">Unsubscribe</a>');else buf.push('<a href="javascript:void(0);" class="course-forum-thread-subscribe-link">Subscribe for email updates.</a>');buf.push('</div><div class="course-forum-thread-move hide"><span data-can-move=\'0\' class="hide">You cannot move this thread until this issue is resolved.</span><div data-can-move=\'1\' class="hide">Move this thread!&nbsp;<select class="course-forum-move-select"></select><span>&nbsp;</span><button type="button" class="btn course-forum-move-btn">Move!</button></div></div></div>')}("thread"in locals_for_with?locals_for_with.thread:"undefined"!=typeof thread?thread:void 0,"user"in locals_for_with?locals_for_with.user:"undefined"!=typeof user?user:void 0),buf.join("")};return function(locals){if(locals)if(locals._h)_h=locals._h.merge(_h);return yudify(locals)}};if("function"==typeof define&&define.amd)define("pages/forum/views/ThreadHeaderView.html",["js/lib/jade","js/lib/jade._h"],function(jade,_h){var _t;return jadify(jade,_t,_h)});else wndw.jade.templates["pages.forum.views.ThreadHeaderView"]=jadify(wndw.jade.helpers)}(window),!function(wndw){var jadify=function(jade,_t){_t="undefined"!=typeof _t?_t:function(key,interpolationHash){if("object"==typeof interpolationHash)return key.replace(/[#!]\{([^}]+?)\}/g,function(match,interpKey){return interpolationHash[interpKey]||interpKey});else return key};var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(thread){buf.push('<form class="form-inline"><input type="text" ,=","'+jade.attr("value",thread.get("title"),!0,!1)+' style="height:100%;"/><button type="submit" style="margin-left: 10px;" class="btn">Save</button><span>&nbsp; &nbsp;</span><a href="javascript:void(0)" role="Button">Cancel</a></form>')}("thread"in locals_for_with?locals_for_with.thread:"undefined"!=typeof thread?thread:void 0),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("pages/forum/views/ThreadTitleEditView.html",["js/lib/jade"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["pages.forum.views.ThreadTitleEditView"]=jadify(wndw.jade.helpers)}(window),!function(wndw){var jadify=function(jade,_t){_t="undefined"!=typeof _t?_t:function(key,interpolationHash){if("object"==typeof interpolationHash)return key.replace(/[#!]\{([^}]+?)\}/g,function(match,interpKey){return interpolationHash[interpKey]||interpKey});else return key};var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp;return buf.push('<div data-modal-overlay-class="course-modal-overlay-light" style="width:800px;" class="modal hide course-forum-ping-modal"><div class="modal-header"><a href="javascript:void(0)" data-modal-close="data-modal-close" class="close">×</a><h3>Notify Coursera</h3></div><div style="max-height:800px;" class="modal-body"><p>Use this form to help bring this issue to Coursera\'s attention. Please \nlet us know if this is a:</p><ul><li><strong>Standard issue: </strong>A problem you can reproduce that is apparent to all \nstudents, but that is not significantly affecting the course experience \nfor the majority of students. Examples: a non-essential link on the \ncourse page is broken; the video speed change feature is not functioning \n(but videos are still loading and viewable at standard speed).</li><li><strong>Time-sensitive issue: </strong>A problem you can reproduce that is disrupting, \nor has the potential to disrupt, the course experience for a majority of \nstudents. Examples: a quiz due this week can\'t be submitted due to an \nerror message; one of the week\'s videos isn\'t loading.</li></ul><p class="course-forum-ping-coursera-staff-note hide">Please note that to ensure our \nfast response, it is best to report urgent or critical problems through the <a href="https://class.coursera.org/mooc/forum">Coursera Partners’ Portal Forums.</a> If this thread is relevant to an urgent or critical issue, you can \ninclude a link to this thread in the report submitted through the \nPartners’ Portal.</p><p>Please use the "Notes" space on this form to summarize as much \ninformation as you know about the problem, including as much specific \ndetail as possible. If other forum threads reference this problem, please \ninclude links to those threads.</p><p class="course-forum-ping-coursera-staff-note hide"></p><div class="control-group"><label class="control-label">Priority</label><div class="controls"><select name="priority" class="course-forum-ping-priority"><option value="2">Standard Issue </option><option value="3">Time-Sensitive Issue </option></select></div><label class="control-label">Notes</label><div class="controls"><textarea style="height: 100px; width:90%;" name="notes" dir="auto" class="course-forum-ping-notes"></textarea></div></div><div class="control-group"><div class="controls"><button type="submit" value="value" class="btn course-forum-ping-coursera-send">Notify Coursera </button><span class="course-forum-ping-modal-status"></span></div></div></div></div>'),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("pages/forum/views/PingView.html",["js/lib/jade"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["pages.forum.views.PingView"]=jadify(wndw.jade.helpers)}(window),!function(wndw){var popup=function($,_,LucidJS,DataAttributes){var UP_ARROW=38,DOWN_ARROW=40,SPACE_BAR=32,ESCAPE=27,ENTER=13,OPENED=1,CLOSED=0,_private={defaults:{"bind.open":"click","bind.close":"click","bind.cancel.document":"mousemove","bind.cancel":"mouseleave","bind.uncancel":"mouseenter","bind.keydown":"keydown",direction:"sw","offset.x":0,"offset.y":0,timeout:450,"timeout.intent":350,resize:!1,width:!1,"attribute.open":"data-popup","attribute.close":"data-popup-close","attribute.item":"data-popup-item",position:"absolute"},prevPopup:null,prevTimeout:null,timeout:null,timeoutClear:null,getPopup:function(el,options){var pop=$(el).data("popup.me");if(pop&&pop.constructor==Popup.prototype.constructor)if(options)return pop.customize(options);else return pop;else return null},getPopupForAnchor:function($anchor,options){var selector=$anchor.attr(_private.defaults["attribute.open"]),$pop=$(selector),pop=_private.makePopup($pop,options);return pop},closeOlderPopups:function(){if(_private.prevPopup)_private.prevPopup.close(),_private.prevPopup=null},isTouch:"ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch,makePopup:function(el,settings){var $el=$(el),pop;if($el.attr("data-popup"))pop=_private.getPopupForAnchor($el);else pop=_private.getPopup($el);if(!pop)pop=new Popup($el,settings),$el.data("popup.me",pop);return pop},monitorKeys:function(e){if(_.contains([UP_ARROW,DOWN_ARROW],e.keyCode))e.preventDefault(),e.stopPropagation(),_private.changeFocus.call(this,e);else if(e.keyCode==ESCAPE)this.$anchor.focus(),this.close();else if(e.keyCode==ENTER)this.emitter.trigger("enter",this)},monitorActions:function(e){var el=this.$el[0],$target=$(e.target),that=this;if("mouseleave"!=e.type){if($target.closest(this.$el).size()>0||$target.closest(this.$anchor).size()>0)return void window.clearTimeout(_private.timeout)}else _private.timeout=window.setTimeout(function(){if(that.state==OPENED)that.close()},this.options.timeout)},intentOpen:function(e,popup,$anchor){var anchor=$anchor[0],x=e.pageX,y=e.pageY;if(_private.prevTimeout)$(document).off(".popup"),window.clearTimeout(_private.prevTimeout);_private.prevTimeout=window.setTimeout(function(){if(window.clearTimeout(_private.prevTimeout),$(document).off(".popup"),!popup.isOpen())popup.open($anchor)},popup.options["timeout.intent"]),$(document).on("mousemove.popup mouseleave.popup",function(e){if("mouseleave"==e.type||e.target!=anchor&&0===$(e.target).closest(anchor).size())$(document).off(".popup"),window.clearTimeout(_private.prevTimeout)})},changeFocus:function(e){if(this.$anchor){var item_selector=this.$anchor.attr(this.options["attribute.item"]),$items=this.$el.children(":visible");if(item_selector)$items=$items.filter(item_selector);if($items.length){if(index=$items.index($items.filter(":focus")),e.keyCode==UP_ARROW)index--;if(e.keyCode==DOWN_ARROW)index++;if(0>index||index>=$items.length)this.$anchor.focus();else if(index<$items.length)$items.eq(index).focus()}}}},Popup=function(el,settings){this.$el=$(el),this.$parent=this.$el.parent(),this.$anchor=null,this.emitter=LucidJS.emitter(this),this.customize(settings)};Popup.prototype.customize=function(settings){return this.options=_.extend({},DataAttributes.parse(this.$el,_private.defaults,"data-popup-"),settings),this},Popup.prototype.get=function(){return this.$el},Popup.prototype.open=function(anchor){if(this.state!=OPENED){var that=this,$anchor=$(anchor);if(!this.$anchor||this.$anchor[0]!=$anchor[0]){var position=$anchor.position();if(this.options=DataAttributes.parse($anchor,this.options,"data-popup-"),this.$anchor=$anchor,this.$anchor.parent().append(this.$el),this.$anchor.attr("aria-expanded","true"),that.options.resize)this.$el.width(this.$anchor.outerWidth());if(that.options.width)this.$el.css("width",that.options.width);this.emitter.trigger("opening",this.$anchor);var offset={x:parseInt(this.options["offset.x"],10),y:parseInt(this.options["offset.y"],10)};if(this.$el.css({position:this.options.position}),!this.options.direction||"sw"==this.options.direction)this.move(position.left+offset.x,position.top+$anchor.outerHeight()+offset.y);else if("se"==this.options.direction)this.move(position.left+$anchor.outerWidth()+offset.x-this.$el.outerWidth(),position.top+$anchor.outerHeight()+offset.y);else if("ne"==this.options.direction)this.move(position.left+$anchor.outerWidth()+offset.x-this.$el.outerWidth(),position.top-this.$el.outerHeight()-offset.y);else if("s"==this.options.direction)this.move(position.left+$anchor.outerWidth()/2+offset.x-this.$el.outerWidth()/2,position.top+$anchor.outerHeight()+offset.y);else if("n"==this.options.direction)this.move(position.left+$anchor.outerWidth()/2+offset.x-this.$el.outerWidth()/2,position.top-this.$el.outerHeight()+offset.y);else if("w"==this.options.direction)this.move(position.left+offset.x-this.$el.outerWidth(),position.top+offset.y);this.$el.show(),window.setTimeout(function(){if(_private.closeOlderPopups(),$anchor.addClass("popup-opened"),!$anchor.is(":focus"))$anchor.focus();if(that.emitter.trigger("opened",that.$anchor),that.state=OPENED,_private.prevPopup=that,that.options["bind.cancel"])that.$el.on(that.options["bind.cancel"]+".popup",_.bind(_private.monitorActions,that)),that.$anchor.on(that.options["bind.cancel"]+".popup",_.bind(_private.monitorActions,that)),that.$el.on(that.options["bind.uncancel"]+".popup",_.bind(_private.monitorActions,that)),that.$anchor.on(that.options["bind.uncancel"]+".popup",_.bind(_private.monitorActions,that));if($(document).on(that.options["bind.cancel.document"]+".popup",_.bind(_private.monitorActions,that)).on(that.options["bind.keydown"]+".popup",_.bind(_private.monitorKeys,that)),that.options["attribute.close"])that.$el.on(that.options["bind.close"]+".popup","["+that.options["attribute.close"]+"]",function(e){if("disabled"!=$(e.currentTarget).attr("disabled"))that.close()})},0)}return this}},Popup.prototype.move=function(x,y,z){return this.$el.css({left:x,top:y,"z-index":z||1e4}),this},Popup.prototype.close=function(){return $(document).off(".popup"),this.$anchor.attr("aria-expanded","false"),this.$anchor.removeClass("popup-opened"),this.emitter.trigger("closing",this.$anchor),this.$el.off(".popup").hide(),this.$anchor.off(".popup"),this.$parent.append(this.$el),this.emitter.trigger("closed",this.$anchor),this.$anchor=null,this.state=CLOSED,window.clearTimeout(this.timeout),_private.prevPopup=null,this},Popup.prototype.isOpen=function(){return this.$el.is(":visible")};var external=function(){return _private.getPopup.apply(null,arguments)||_private.makePopup.apply(this,arguments)};return external.start=function(view,options){function openPopup(pop,$anchor){if(!pop.isOpen())pop.open($anchor)}var $view=$(view);if(!$view.data("popups-initialized"))$view.data("popups-initialized",1),$view.on("click.popup mouseenter.popup keydown.popup","["+_private.defaults["attribute.open"]+"]",function(e){var $anchor=$(this),bind=$anchor.attr("data-popup-bind-open");if("disabled"!=$anchor.attr("disabled")){var pop=_private.getPopupForAnchor($anchor,options);if("keydown"==e.type&&_.contains([UP_ARROW,DOWN_ARROW,SPACE_BAR],e.keyCode))if(e.preventDefault(),e.stopPropagation(),e.keyCode==DOWN_ARROW||e.keyCode==SPACE_BAR){if(!pop.isOpen())openPopup(pop,$anchor);_private.changeFocus.call(pop,e)}else if(e.keyCode==UP_ARROW&&pop.isOpen())pop.close();if(e.type==bind||!bind&&"click"==e.type||_private.isTouch&&"click"==e.type)if("mouseover"==e.type||"mouseenter"==e.type)_private.intentOpen(e,pop,$anchor);else openPopup(pop,$anchor)}}),$($view.find("["+_private.defaults["attribute.open"]+"]")).each(function(index){var $elem=$(this);if("true"==$elem.attr("aria-expanded")){var pop=_private.getPopupForAnchor($elem,options);openPopup(pop,$elem),window.setTimeout(function(){pop.close($elem)},3e3)}})},external.stop=function(view){var $view=$(view);$view.data("popups-initialized",0),$view.off(".popup"),_private.closeOlderPopups()},external.start("body"),external};if("function"==typeof define&&define.amd)define("js/lib/popups",["jquery","underscore","js/lib/lucid","js/lib/data.attributes"],function($,_,LucidJS,DataAttributes){return popup($,_,LucidJS,DataAttributes)});else wndw.Popup=popup(wndw.$,wndw._,wndw.LucidJS,wndw.DataAttributes)}(window),define("pages/forum/views/ThreadHeaderView",["backbone","jquery","underscore","pages/spark/app","pages/forum/models/ForumCollection","pages/forum/views/ThreadHeaderView.html","pages/forum/views/ThreadTitleEditView.html","pages/forum/views/PingView.html","js/lib/popups","js/lib/modals"],function(Backbone,$,_,Coursera,ForumCollection,ThreadHeaderTemplate,ThreadTitleEditTemplate,pingTemplate,Popup,Modal){var TRACKER_LABEL="Forum Thread",THREAD_FIELDS=["title","stickied","approved","unresolved","locked","deleted","is_spam","_viewer_subscription","_viewer_can_delete","_viewer_can_edit_title","_viewer_can_resolve_without_triage","triage_sync_status","triage_status","private"],view=Backbone.View.extend({defaults:{},events:{"click .course-forum-thread-action-link":"onThreadActionClick","click .course-forum-thread-controls-toggle .icon-cog":"onGearClick","click .course-forum-thread-subscribe-link":"onThreadSubscribeClick","click .course-forum-thread-unsubscribe-link":"onThreadUnsubscribeClick","click .course-forum-thread-edit-title-link":"onThreadEditTitleClick","click .course-forum-thread-title button":"onThreadEditTitleSave","click .course-forum-thread-title a":"onThreadEditTitleCancel","click .course-forum-thread-ping-coursera":"onThreadPingCourseraClick","click .course-forum-ping-coursera-send":"onThreadPingCourseraSend","click .course-forum-thread-move-link":"onThreadMoveGearClick","click .course-forum-move-btn":"onThreadMoveBtnClick"},initialize:function(options){this.options=options,this.thread=this.model,this.thread.bind("change",this.render,this)},render:function(){var changedAttrs=this.thread.changedAttributes();if(!this.$(".course-forum-thread-controls").length||changedAttrs&&_.intersection(_.keys(changedAttrs),THREAD_FIELDS).length>0)this.renderViewMode();return this},renderViewMode:function(){this.$el.html(ThreadHeaderTemplate({user:Coursera.user,thread:this.thread})),this.$title=this.$(".course-forum-thread-title")},onGearClick:function(e){Coursera.multitracker.push([TRACKER_LABEL,"Controls Open"])},onThreadActionClick:function(e){var self=this,$link=$(e.target),property=$link.attr("data-property"),value=$link.attr("data-value");if("unresolved"==property){var resolved="0"==value;this.thread.setResolved(resolved)}else{var props={};props[property]=value,this.thread.update(props,{message:{waiting:"Processing...",success:"Processed!"},silent:!1})}Coursera.multitracker.push([TRACKER_LABEL,"Action "+property+" "+value])},onThreadMoveGearClick:function(e){var self=this;self.$(".course-forum-thread-move").show();var $select=self.$(".course-forum-move-select");if(!this.thread.isUnresolved()){self.$(".course-forum-thread-move [data-can-move=1]").show();var data={data:{can_move:1}};Coursera.api.get("forum/forums",data).done(function(forums){var supportForums=[1e4,10001,10002],otherOptions=[],forumCollection=new ForumCollection(forums),recursiveHelper=function(forum){if(forum.isOpen()&&!forum.forum_moderators_only){if(0!==forum.get("id")&&(forum.get("can_post")||Coursera.user.canModerateForum())&&forum.id!=self.thread.get("forum_id"))if(supportForums.indexOf(forum.id)<0)$select.append("<option value="+forum.get("id")+">"+forum.getFullName()+"</option>");else otherOptions.push(forum);for(var childForums=forumCollection.where({parent_id:forum.get("id")}),i=0;i<childForums.length;i++)recursiveHelper(childForums[i])}};recursiveHelper(forumCollection.get(0));for(var j=0;j<otherOptions.length;j++)if(10002!=otherOptions[j].id)$select.append("<option value="+otherOptions[j].get("id")+">"+otherOptions[j].getFullName()+"</option>")})}else self.$(".course-forum-thread-move [data-can-move=0]").show()},onThreadMoveBtnClick:function(e){var self=this;if(self.$(".course-forum-thread-move").show(),!this.thread.isUnresolved()){var $moveBtn=self.$(".course-forum-move-btn");$moveBtn.attr("disabled",!0);var $select=self.$(".course-forum-move-select");self.thread.update({forum_id:$select.val()},{silent:!0}).done(function(response){window.location.reload()}).fail(function(err){alert("There was an error moving this thread to a different forum.")})}},onThreadEditTitleClick:function(e){var self=this,titleHeight=self.$title.height();self.$title.html(ThreadTitleEditTemplate({thread:this.thread})),self.$title.find("form").height(titleHeight).focus(),self.$title.find("input").focus(),self.$title.find(".course-forum-thread-title button").attr("disabled",null),Coursera.multitracker.push([TRACKER_LABEL,"Title Edit Start"])},onThreadEditTitleSave:function(e){e.preventDefault();var self=this,title=self.$("input").val();self.thread.update({title:title},{silent:!1,message:{waiting:"Saving title...",success:"Saved title!"}}),self.$title.find(".course-forum-thread-title button").attr("disabled","disabled"),Coursera.multitracker.push([TRACKER_LABEL,"Title Edit Save"])},onThreadEditTitleCancel:function(e){e.preventDefault(),this.renderViewMode(),Coursera.multitracker.push([TRACKER_LABEL,"Title Edit Cancel"])},onThreadSubscribeClick:function(e){var self=this;Coursera.api.post(this.model.subscriptionsUrl(),{message:{waiting:"Subscribing...",success:"Subscribed!"}}).done(function(data){self.thread.set({_viewer_subscription:data})})},onThreadUnsubscribeClick:function(e){var self=this;Coursera.api["delete"](this.model.subscriptionsUrl(),{message:{waiting:"Unsubscribing...",success:"Unsubscribed!"}}).done(function(data){self.thread.set({_viewer_subscription:data})})},onThreadPingCourseraClick:function(e){if(!this.pingModal)if(this.$el.append(pingTemplate()),this.pingModal=new Modal(this.$(".course-forum-ping-modal")),Coursera.user.isAdmin())this.$(".course-forum-ping-coursera-staff-note").show();this.pingModal.open()},onThreadPingCourseraSend:function(e){var self=this;Coursera.api.post(self.model.triagePingUrl(),{message:{waiting:"Sending...",success:"Sent!"},data:{priority:self.$(".course-forum-ping-priority").val(),notes:self.$(".course-forum-ping-notes").val()}}).done(function(data){self.model.set(data),self.$(".course-forum-ping-modal-status").text(""),self.pingModal.close()}).fail(function(err){self.$(".course-forum-ping-modal-status").css("color","red"),self.$(".course-forum-ping-modal-status").text("Error: "+err.responseText)}),self.$(".course-forum-ping-modal-status").css("color","black"),self.$(".course-forum-ping-modal-status").text("Sending...")}});return view}),!function(wndw){var jadify=function(jade,_t){_t="undefined"!=typeof _t?_t:function(key,interpolationHash){if("object"==typeof interpolationHash)return key.replace(/[#!]\{([^}]+?)\}/g,function(match,interpKey){return interpolationHash[interpKey]||interpKey});else return key};var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(config,thread){if(buf.push("<link"+jade.attr("href",config.url.assets+"pages/home/account/select2.css",!0,!1)+' rel="stylesheet" type="text/css"/><h5 style="display:inline-block;"><span class="hidden">Tags </span><i class="icon-tags"></i>&nbsp;</h5>'),thread.get("tags").length)buf.push('<ul style="display:inline-block;" class="unstyled">'),function(){var $$obj=thread.get("tags");if("number"==typeof $$obj.length)for(var $index=0,$$l=$$obj.length;$$l>$index;$index++){var tag=$$obj[$index];buf.push('<li class="course-forum-thread-tag"><a'+jade.attr("href",tag.link,!0,!1)+">"+jade.escape(null==(jade_interp=tag.tag_name)?"":jade_interp)+"</a>&nbsp;<a"+jade.attr("data-tag",tag.tag_name,!0,!1)+' href="javascript:void(0)" class="course-forum-thread-tag-delete"><span class="hidden">Delete Tag</span>×</a></li>')}else{var $$l=0;for(var $index in $$obj){$$l++;var tag=$$obj[$index];buf.push('<li class="course-forum-thread-tag"><a'+jade.attr("href",tag.link,!0,!1)+">"+jade.escape(null==(jade_interp=tag.tag_name)?"":jade_interp)+"</a>&nbsp;<a"+jade.attr("data-tag",tag.tag_name,!0,!1)+' href="javascript:void(0)" class="course-forum-thread-tag-delete"><span class="hidden">Delete Tag</span>×</a></li>')
}}}.call(this),buf.push("</ul>");else buf.push("<span>No tags yet.</span>");buf.push('&nbsp;<a href="javascript:void(0)" class="course-forum-thread-tags-link">+ Add Tag</a><form class="course-forum-thread-tags-form form-inline hide"><label>Please try to use existing tags.   &nbsp;</label><input type="text" name="tags" style="margin-left:10px" class="input-medium"/><button type="button" style="margin-left:10px" disabled="disabled" class="btn">Save</button><a href="javascript:void(0)" role="button" style="margin-left:10px">Cancel</a></form>')}("config"in locals_for_with?locals_for_with.config:"undefined"!=typeof config?config:void 0,"thread"in locals_for_with?locals_for_with.thread:"undefined"!=typeof thread?thread:void 0),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("pages/forum/views/ThreadTagsView.html",["js/lib/jade"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["pages.forum.views.ThreadTagsView"]=jadify(wndw.jade.helpers)}(window),!function(){var Select2Plugin=function($){function escapeMarkup(markup){if(markup&&"string"==typeof markup)return markup.replace(/&/g,"&amp;").replace(/<\/?script>/gi,"&lt;script&gt;");else return markup}function indexOf(value,array){var i=0,l=array.length,v;if("undefined"==typeof value)return-1;if(value.constructor===String){for(;l>i;i+=1)if(0===value.localeCompare(array[i]))return i}else for(;l>i;i+=1)if(v=array[i],v.constructor===String){if(0===v.localeCompare(value))return i}else if(v===value)return i;return-1}function equal(a,b){if(a===b)return!0;if(void 0===a||void 0===b)return!1;if(null===a||null===b)return!1;if(a.constructor===String)return 0===a.localeCompare(b);if(b.constructor===String)return 0===b.localeCompare(a);else return!1}function splitVal(string,separator){var val,i,l;if(null===string||string.length<1)return[];for(val=string.split(separator),i=0,l=val.length;l>i;i+=1)val[i]=$.trim(val[i]);return val}function getSideBorderPadding(element){return element.outerWidth()-element.width()}function installKeyUpChangeEvent(element){var key="keyup-change-value";element.bind("keydown",function(){if(void 0===$.data(element,key))$.data(element,key,element.val())}),element.bind("keyup",function(){var val=$.data(element,key);if(void 0!==val&&element.val()!==val)$.removeData(element,key),element.trigger("keyup-change")})}function installFilteredMouseMove(element){element.bind("mousemove",function(e){var lastpos=$.data(document,"select2-lastpos");if(void 0===lastpos||lastpos.x!==e.pageX||lastpos.y!==e.pageY)$(e.target).trigger("mousemove-filtered",e)})}function debounce(quietMillis,fn){var timeout;return function(){window.clearTimeout(timeout),timeout=window.setTimeout(fn,quietMillis)}}function thunk(formula){var evaluated=!1,value;return function(){if(evaluated===!1)value=formula(),evaluated=!0;return value}}function installDebouncedScroll(threshold,element){var notify=debounce(threshold,function(e){element.trigger("scroll-debounced",e)});element.bind("scroll",function(e){if(indexOf(e.target,element.get())>=0)notify(e)})}function killEvent(event){event.preventDefault(),event.stopPropagation()}function measureTextWidth(e){if(!sizer){var style=e[0].currentStyle||window.getComputedStyle(e[0],null);sizer=$("<div></div>").css({position:"absolute",left:"-10000px",top:"-10000px",display:"none",fontSize:style.fontSize,fontFamily:style.fontFamily,fontStyle:style.fontStyle,fontWeight:style.fontWeight,letterSpacing:style.letterSpacing,textTransform:style.textTransform,whiteSpace:"nowrap"}),$("body").append(sizer)}return sizer.text(e.val()),sizer.width()}function markMatch(text,term,markup){var match=text.toUpperCase().indexOf(term.toUpperCase()),tl=term.length;if(0>match)return void markup.push(text);else return markup.push(text.substring(0,match)),markup.push("<span class='select2-match'>"),markup.push(text.substring(match,match+tl)),markup.push("</span>"),void markup.push(text.substring(match+tl,text.length))}function ajax(options){var timeout,requestSequence=0,handler=null,quietMillis=options.quietMillis||100;return function(query){window.clearTimeout(timeout),timeout=window.setTimeout(function(){requestSequence+=1;var requestNumber=requestSequence,data=options.data,transport=options.transport||$.ajax,traditional=options.traditional||!1,type=options.type||"GET";if(data=data.call(this,query.term,query.page,query.context),null!==handler)handler.abort();handler=transport.call(null,{url:options.url,dataType:options.dataType,data:data,type:type,traditional:traditional,success:function(data){if(!(requestSequence>requestNumber)){var results=options.results(data,query.page);query.callback(results)}}})},quietMillis)}}function local(options){var data=options,dataText,text=function(item){return""+item.text};if(!$.isArray(data)){if(text=data.text,!$.isFunction(text))dataText=data.text,text=function(item){return item[dataText]};data=data.results}return function(query){var t=query.term,filtered={};if(""===t)return void query.callback({results:data});else return filtered.results=$(data).filter(function(){return query.matcher(t,text(this))}).get(),void query.callback(filtered)}}function tags(data){if($.isFunction(data))return data;else return function(query){var t=query.term,filtered={results:[]};$(data).each(function(){var isObject=void 0!==this.text,text=isObject?this.text:this;if(""===t||query.matcher(t,text))filtered.results.push(isObject?this:{id:this,text:this})}),query.callback(filtered)}}function checkFormatter(formatter,formatterName){if($.isFunction(formatter))return!0;if(!formatter)return!1;throw new Error("formatterName must be a function or a falsy value")}function evaluate(val){return $.isFunction(val)?val():val}function countResults(results){var count=0;return $.each(results,function(i,item){if(item.children)count+=countResults(item.children);else count++}),count}function defaultTokenizer(input,selection,selectCallback,opts){var original=input,dupe=!1,token,index,i,l,separator;if(!opts.createSearchChoice||!opts.tokenSeparators||opts.tokenSeparators.length<1)return void 0;for(;;){for(index=-1,i=0,l=opts.tokenSeparators.length;l>i&&(separator=opts.tokenSeparators[i],index=input.indexOf(separator),!(index>=0));i++);if(0>index)break;if(token=input.substring(0,index),input=input.substring(index+separator.length),token.length>0)if(token=opts.createSearchChoice(token,selection),void 0!==token&&null!==token&&void 0!==opts.id(token)&&null!==opts.id(token)){for(dupe=!1,i=0,l=selection.length;l>i;i++)if(equal(opts.id(token),opts.id(selection[i]))){dupe=!0;break}if(!dupe)selectCallback(token)}}if(0!=original.localeCompare(input))return input;else return void 0}function clazz(SuperClass,methods){var constructor=function(){};return constructor.prototype=new SuperClass,constructor.prototype.constructor=constructor,constructor.prototype.parent=SuperClass.prototype,constructor.prototype=$.extend(constructor.prototype,methods),constructor}if("undefined"==typeof $.fn.each2)$.fn.extend({each2:function(c){for(var j=$([0]),i=-1,l=this.length;++i<l&&(j.context=j[0]=this[i])&&c.call(j[0],i,j)!==!1;);return this}});if(void 0===window.Select2){var KEY,AbstractSelect2,SingleSelect2,MultiSelect2,nextUid,sizer;KEY={TAB:9,ENTER:13,ESC:27,SPACE:32,LEFT:37,UP:38,RIGHT:39,DOWN:40,SHIFT:16,CTRL:17,ALT:18,PAGE_UP:33,PAGE_DOWN:34,HOME:36,END:35,BACKSPACE:8,DELETE:46,isArrow:function(k){switch(k=k.which?k.which:k){case KEY.LEFT:case KEY.RIGHT:case KEY.UP:case KEY.DOWN:return!0}return!1},isControl:function(e){var k=e.which;switch(k){case KEY.SHIFT:case KEY.CTRL:case KEY.ALT:return!0}if(e.metaKey)return!0;else return!1},isFunctionKey:function(k){return k=k.which?k.which:k,k>=112&&123>=k}},nextUid=function(){var counter=1;return function(){return counter++}}(),$(document).delegate("*","mousemove",function(e){$.data(document,"select2-lastpos",{x:e.pageX,y:e.pageY})}),$(document).ready(function(){$(document).delegate("*","mousedown touchend",function(e){var target=$(e.target).closest("div.select2-container").get(0),attr;if(target)$(document).find("div.select2-container-active").each(function(){if(this!==target)$(this).data("select2").blur()});else target=$(e.target).closest("div.select2-drop").get(0),$(document).find("div.select2-drop-active").each(function(){if(this!==target)$(this).data("select2").blur()});if(target=$(e.target),attr=target.attr("for"),"LABEL"===e.target.tagName&&attr&&attr.length>0)if(target=$("#"+attr),target=target.data("select2"),void 0!==target)target.focus(),e.preventDefault()})}),AbstractSelect2=clazz(Object,{bind:function(func){var self=this;return function(){func.apply(self,arguments)}},init:function(opts){var results,search,resultsSelector=".select2-results";if(this.opts=opts=this.prepareOpts(opts),this.id=opts.id,void 0!==opts.element.data("select2")&&null!==opts.element.data("select2"))this.destroy();if(this.enabled=!0,this.container=this.createContainer(),this.containerId="s2id"+nextUid(),this.container.attr("id",this.containerId),this.body=thunk(function(){return opts.element.closest("body")}),void 0!==opts.element.attr("class"))this.container.addClass(opts.element.attr("class"));if(this.container.css(evaluate(opts.containerCss)),this.container.addClass(evaluate(opts.containerCssClass)),this.opts.element.data("select2",this).hide().before(this.container),this.container.data("select2",this),this.dropdown=this.container.find(".select2-drop"),this.dropdown.addClass(evaluate(opts.dropdownCssClass)),this.dropdown.data("select2",this),this.results=results=this.container.find(resultsSelector),this.search=search=this.container.find("input.select2-input"),search.attr("tabIndex",this.opts.element.attr("tabIndex")),this.resultsPage=0,this.context=null,this.initContainer(),this.initContainerWidth(),installFilteredMouseMove(this.results),this.dropdown.delegate(resultsSelector,"mousemove-filtered",this.bind(this.highlightUnderEvent)),installDebouncedScroll(80,this.results),this.dropdown.delegate(resultsSelector,"scroll-debounced",this.bind(this.loadMoreIfNeeded)),$.fn.mousewheel)results.mousewheel(function(e,delta,deltaX,deltaY){var top=results.scrollTop(),height;if(deltaY>0&&0>=top-deltaY)results.scrollTop(0),killEvent(e);else if(0>deltaY&&results.get(0).scrollHeight-results.scrollTop()+deltaY<=results.height())results.scrollTop(results.get(0).scrollHeight-results.height()),killEvent(e)});if(installKeyUpChangeEvent(search),search.bind("keyup-change",this.bind(this.updateResults)),search.bind("focus",function(){if(search.addClass("select2-focused")," "===search.val())search.val("")}),search.bind("blur",function(){search.removeClass("select2-focused")}),this.dropdown.delegate(resultsSelector,"mouseup",this.bind(function(e){if($(e.target).closest(".select2-result-selectable:not(.select2-disabled)").length>0)this.highlightUnderEvent(e),this.selectHighlighted(e);else this.focusSearch();killEvent(e)})),this.dropdown.bind("click mouseup mousedown",function(e){e.stopPropagation()}),$.isFunction(this.opts.initSelection))this.initSelection(),this.monitorSource();if(opts.element.is(":disabled")||opts.element.is("[readonly='readonly']"))this.disable()},destroy:function(){var select2=this.opts.element.data("select2");if(void 0!==select2&&void 0!==select2.opts)select2.container.remove(),select2.dropdown.remove(),select2.opts.element.removeData("select2").unbind(".select2").show()},prepareOpts:function(opts){var element,select,idKey,ajaxUrl;if(element=opts.element,"select"===element.get(0).tagName.toLowerCase())this.select=select=opts.element;if(select)$.each(["id","multiple","ajax","query","createSearchChoice","initSelection","data","tags"],function(){if(this in opts)throw new Error("Option '"+this+"' is not allowed for Select2 when attached to a <select> element.")});if(opts=$.extend({},{populateResults:function(container,results,query){var populate,data,result,children,id=this.opts.id,self=this;(populate=function(results,container,depth){var i,l,result,selectable,compound,node,label,innerContainer,formatted;for(i=0,l=results.length;l>i;i+=1){if(result=results[i],selectable=void 0!==id(result),compound="children"in result&&result.children.length>0,node=$("<li></li>"),node.addClass("select2-results-dept-"+depth),node.addClass("select2-result"),node.addClass(selectable?"select2-result-selectable":"select2-result-unselectable"),compound)node.addClass("select2-result-with-children");if(node.addClass(self.opts.formatResultCssClass(result)),label=$("<div></div>"),label.addClass("select2-result-label"),formatted=opts.formatResult(result,label,query),void 0!==formatted)label.html(escapeMarkup(formatted));if(node.append(label),compound)innerContainer=$("<ul></ul>"),innerContainer.addClass("select2-result-sub"),populate(result.children,innerContainer,depth+1),node.append(innerContainer);node.data("select2-data",result),container.append(node)}})(results,container,0)}},$.fn.select2.defaults,opts),"function"!=typeof opts.id)idKey=opts.id,opts.id=function(e){return e[idKey]};if(select)opts.query=this.bind(function(query){var data={results:[],more:!1},term=query.term,children,firstChild,process;if(process=function(element,collection){var group;if(element.is("option")){if(query.matcher(term,element.text(),element))collection.push({id:element.attr("value"),text:element.text(),element:element.get(),css:element.attr("class")})}else if(element.is("optgroup"))if(group={text:element.attr("label"),children:[],element:element.get(),css:element.attr("class")},element.children().each2(function(i,elm){process(elm,group.children)}),group.children.length>0)collection.push(group)},children=element.children(),void 0!==this.getPlaceholder()&&children.length>0)if(firstChild=children[0],""===$(firstChild).text())children=children.not(firstChild);children.each2(function(i,elm){process(elm,data.results)}),query.callback(data)}),opts.id=function(e){return e.id},opts.formatResultCssClass=function(data){return data.css};else if(!("query"in opts))if("ajax"in opts){if(ajaxUrl=opts.element.data("ajax-url"),ajaxUrl&&ajaxUrl.length>0)opts.ajax.url=ajaxUrl;opts.query=ajax(opts.ajax)}else if("data"in opts)opts.query=local(opts.data);else if("tags"in opts)opts.query=tags(opts.tags),opts.createSearchChoice=function(term){return{id:term,text:term}},opts.initSelection=function(element,callback){var data=[];$(splitVal(element.val(),opts.separator)).each(function(){var id=this,text=this,tags=opts.tags;if($.isFunction(tags))tags=tags();$(tags).each(function(){if(equal(this.id,id))return text=this.text,!1;else return void 0}),data.push({id:id,text:text})}),callback(data)};if("function"!=typeof opts.query)throw"query function not defined for Select2 "+opts.element.attr("id");return opts},monitorSource:function(){this.opts.element.bind("change.select2",this.bind(function(e){if(this.opts.element.data("select2-change-triggered")!==!0)this.initSelection()}))},triggerChange:function(details){details=details||{},details=$.extend({},details,{type:"change",val:this.val()}),this.opts.element.data("select2-change-triggered",!0),this.opts.element.trigger(details),this.opts.element.data("select2-change-triggered",!1),this.opts.element.click()},enable:function(){if(!this.enabled)this.enabled=!0,this.container.removeClass("select2-container-disabled")},disable:function(){if(this.enabled)this.close(),this.enabled=!1,this.container.addClass("select2-container-disabled")},opened:function(){return this.container.hasClass("select2-dropdown-open")},positionDropdown:function(){var offset=this.container.offset(),height=this.container.outerHeight(),width=this.container.outerWidth(),dropHeight=this.dropdown.outerHeight(),viewportBottom=$(window).scrollTop()+document.documentElement.clientHeight,dropTop=offset.top+height,enoughRoomBelow=viewportBottom>=dropTop+dropHeight,enoughRoomAbove=offset.top-dropHeight>=this.body().scrollTop(),aboveNow=this.dropdown.hasClass("select2-drop-above"),above,css;if(aboveNow){if(above=!0,!enoughRoomAbove&&enoughRoomBelow)above=!1}else if(above=!1,!enoughRoomBelow&&enoughRoomAbove)above=!0;if(above)dropTop=offset.top-dropHeight,this.container.addClass("select2-drop-above"),this.dropdown.addClass("select2-drop-above");else this.container.removeClass("select2-drop-above"),this.dropdown.removeClass("select2-drop-above");css={top:dropTop,left:offset.left,width:width},this.dropdown.css(css)},shouldOpen:function(){var event;if(this.opened())return!1;else return event=jQuery.Event("open"),this.opts.element.trigger(event),!event.isDefaultPrevented()},clearDropdownAlignmentPreference:function(){this.container.removeClass("select2-drop-above"),this.dropdown.removeClass("select2-drop-above")},open:function(){if(!this.shouldOpen())return!1;else return window.setTimeout(this.bind(this.opening),1),!0},opening:function(){var cid=this.containerId,selector="#"+cid,scroll="scroll."+cid,resize="resize."+cid;if(this.container.parents().each(function(){$(this).bind(scroll,function(){var s2=$(selector);if(0==s2.length)$(this).unbind(scroll);s2.select2("close")})}),$(window).bind(resize,function(){var s2=$(selector);if(0==s2.length)$(window).unbind(resize);s2.select2("close")}),this.clearDropdownAlignmentPreference()," "===this.search.val())this.search.val("");if(this.dropdown.css(evaluate(this.opts.dropdownCss)),this.dropdown.addClass("select2-drop-active"),this.container.addClass("select2-dropdown-open").addClass("select2-container-active"),this.updateResults(!0),this.dropdown[0]!==this.body().children().last()[0])this.dropdown.detach().appendTo(this.body());this.dropdown.show(),this.ensureHighlightVisible(),this.positionDropdown(),this.focusSearch()},close:function(){if(this.opened()){var self=this;this.container.parents().each(function(){$(this).unbind("scroll."+self.containerId)}),$(window).unbind("resize."+this.containerId),this.clearDropdownAlignmentPreference(),this.dropdown.hide(),this.container.removeClass("select2-dropdown-open").removeClass("select2-container-active"),this.results.empty(),this.clearSearch(),this.opts.element.trigger(jQuery.Event("close"))}},clearSearch:function(){},ensureHighlightVisible:function(){var results=this.results,children,index,child,hb,rb,y,more;if(index=this.highlight(),!(0>index)){if(0==index)return void results.scrollTop(0);if(children=results.find(".select2-result-selectable"),child=$(children[index]),hb=child.offset().top+child.outerHeight(),index===children.length-1)if(more=results.find("li.select2-more-results"),more.length>0)hb=more.offset().top+more.outerHeight();if(rb=results.offset().top+results.outerHeight(),hb>rb)results.scrollTop(results.scrollTop()+(hb-rb));if(y=child.offset().top-results.offset().top,0>y)results.scrollTop(results.scrollTop()+y)}},moveHighlight:function(delta){for(var choices=this.results.find(".select2-result-selectable"),index=this.highlight();index>-1&&index<choices.length;){index+=delta;var choice=$(choices[index]);if(choice.hasClass("select2-result-selectable")&&!choice.hasClass("select2-disabled")){this.highlight(index);break}}},highlight:function(index){var choices=this.results.find(".select2-result-selectable").not(".select2-disabled");if(0===arguments.length)return indexOf(choices.filter(".select2-highlighted")[0],choices.get());if(index>=choices.length)index=choices.length-1;if(0>index)index=0;choices.removeClass("select2-highlighted"),$(choices[index]).addClass("select2-highlighted"),this.ensureHighlightVisible()},countSelectableResults:function(){return this.results.find(".select2-result-selectable").not(".select2-disabled").length},highlightUnderEvent:function(event){var el=$(event.target).closest(".select2-result-selectable");if(el.length>0&&!el.is(".select2-highlighted")){var choices=this.results.find(".select2-result-selectable");this.highlight(choices.index(el))}else if(0==el.length)this.results.find(".select2-highlighted").removeClass("select2-highlighted")},loadMoreIfNeeded:function(){var results=this.results,more=results.find("li.select2-more-results"),below,offset=-1,page=this.resultsPage+1,self=this,term=this.search.val(),context=this.context;if(0!==more.length)if(below=more.offset().top-results.offset().top-results.height(),0>=below)more.addClass("select2-active"),this.opts.query({term:term,page:page,context:context,matcher:this.opts.matcher,callback:this.bind(function(data){if(self.opts.populateResults.call(this,results,data.results,{term:term,page:page,context:context}),data.more===!0)more.detach().appendTo(results).text(self.opts.formatLoadMore(page+1)),window.setTimeout(function(){self.loadMoreIfNeeded()},10);else more.remove();self.positionDropdown(),self.resultsPage=page})})},tokenize:function(){},updateResults:function(initial){function postRender(){results.scrollTop(0),search.removeClass("select2-active"),self.positionDropdown()}function render(html){results.html(escapeMarkup(html)),postRender()}var search=this.search,results=this.results,opts=this.opts,data,self=this,input;if(initial===!0||this.showSearchInput!==!1&&this.opened()){if(search.addClass("select2-active"),opts.maximumSelectionSize>=1)if(data=this.data(),$.isArray(data)&&data.length>=opts.maximumSelectionSize&&checkFormatter(opts.formatSelectionTooBig,"formatSelectionTooBig"))return void render("<li class='select2-selection-limit'>"+opts.formatSelectionTooBig(opts.maximumSelectionSize)+"</li>");if(search.val().length<opts.minimumInputLength&&checkFormatter(opts.formatInputTooShort,"formatInputTooShort"))return void render("<li class='select2-no-results'>"+opts.formatInputTooShort(search.val(),opts.minimumInputLength)+"</li>");else render("<li class='select2-searching'>"+opts.formatSearching()+"</li>");if(input=this.tokenize(),void 0!=input&&null!=input)search.val(input);this.resultsPage=1,opts.query({term:search.val(),page:this.resultsPage,context:null,matcher:opts.matcher,callback:this.bind(function(data){var def;if(this.context=void 0===data.context?null:data.context,this.opts.createSearchChoice&&""!==search.val())if(def=this.opts.createSearchChoice.call(null,search.val(),data.results),void 0!==def&&null!==def&&void 0!==self.id(def)&&null!==self.id(def))if(0===$(data.results).filter(function(){return equal(self.id(this),self.id(def))}).length)data.results.unshift(def);if(0===data.results.length&&checkFormatter(opts.formatNoMatches,"formatNoMatches"))return void render("<li class='select2-no-results'>"+opts.formatNoMatches(search.val())+"</li>");if(results.empty(),self.opts.populateResults.call(this,results,data.results,{term:search.val(),page:this.resultsPage,context:null}),data.more===!0&&checkFormatter(opts.formatLoadMore,"formatLoadMore"))results.append("<li class='select2-more-results'>"+escapeMarkup(opts.formatLoadMore(this.resultsPage))+"</li>"),window.setTimeout(function(){self.loadMoreIfNeeded()},10);this.postprocessResults(data,initial),postRender()})})}},cancel:function(){this.close()},blur:function(){if(this.close(),this.container.removeClass("select2-container-active"),this.dropdown.removeClass("select2-drop-active"),this.search[0]===document.activeElement)this.search.blur();this.clearSearch(),this.selection.find(".select2-search-choice-focus").removeClass("select2-search-choice-focus")},focusSearch:function(){window.setTimeout(this.bind(function(){this.search.focus(),this.search.val(this.search.val())}),10)},selectHighlighted:function(){var index=this.highlight(),highlighted=this.results.find(".select2-highlighted").not(".select2-disabled"),data=highlighted.closest(".select2-result-selectable").data("select2-data");if(data)highlighted.addClass("select2-disabled"),this.highlight(index),this.onSelect(data)},getPlaceholder:function(){return this.opts.element.attr("placeholder")||this.opts.element.attr("data-placeholder")||this.opts.element.data("placeholder")||this.opts.placeholder},initContainerWidth:function(){function resolveContainerWidth(){var style,attrs,matches,i,l;if("off"===this.opts.width)return null;else if("element"===this.opts.width)return 0===this.opts.element.outerWidth()?"auto":this.opts.element.outerWidth()+"px";else if("copy"===this.opts.width||"resolve"===this.opts.width){if(style=this.opts.element.attr("style"),void 0!==style)for(attrs=style.split(";"),i=0,l=attrs.length;l>i;i+=1)if(matches=attrs[i].replace(/\s/g,"").match(/width:(([-+]?([0-9]*\.)?[0-9]+)(px|em|ex|%|in|cm|mm|pt|pc))/),null!==matches&&matches.length>=1)return matches[1];if("resolve"===this.opts.width)if(style=this.opts.element.css("width"),style.indexOf("%")>0)return style;else return 0===this.opts.element.outerWidth()?"auto":this.opts.element.outerWidth()+"px";return null}else if($.isFunction(this.opts.width))return this.opts.width();else return this.opts.width}var width=resolveContainerWidth.call(this);if(null!==width)this.container.attr("style","width: "+width)}}),SingleSelect2=clazz(AbstractSelect2,{createContainer:function(){var container=$("<div></div>",{"class":"select2-container"}).html(["    <a href='javascript:void(0)' class='select2-choice'>","   <span></span><abbr class='select2-search-choice-close' style='display:none;'></abbr>","   <div><b></b></div>","</a>","    <div class='select2-drop select2-offscreen'>","   <div class='select2-search'>","       <input type='text' autocomplete='off' class='select2-input'/>","   </div>","   <ul class='select2-results'>","   </ul>","</div>"].join(""));return container},opening:function(){this.search.show(),this.parent.opening.apply(this,arguments),this.dropdown.removeClass("select2-offscreen")},close:function(){if(this.opened())this.parent.close.apply(this,arguments),this.dropdown.removeAttr("style").addClass("select2-offscreen").insertAfter(this.selection).show()},focus:function(){this.close(),this.selection.focus()},isFocused:function(){return this.selection[0]===document.activeElement},cancel:function(){this.parent.cancel.apply(this,arguments),this.selection.focus()},initContainer:function(){var selection,container=this.container,dropdown=this.dropdown,clickingInside=!1;this.selection=selection=container.find(".select2-choice"),this.search.bind("keydown",this.bind(function(e){if(this.enabled){if(e.which===KEY.PAGE_UP||e.which===KEY.PAGE_DOWN)return void killEvent(e);if(this.opened())switch(e.which){case KEY.UP:case KEY.DOWN:return this.moveHighlight(e.which===KEY.UP?-1:1),void killEvent(e);case KEY.TAB:case KEY.ENTER:return this.selectHighlighted(),void killEvent(e);case KEY.ESC:return this.cancel(e),void killEvent(e)}else{if(e.which===KEY.TAB||KEY.isControl(e)||KEY.isFunctionKey(e)||e.which===KEY.ESC)return;if(this.opts.openOnEnter===!1&&e.which===KEY.ENTER)return;if(this.open(),e.which===KEY.ENTER)return}}})),this.search.bind("focus",this.bind(function(){this.selection.attr("tabIndex","-1")})),this.search.bind("blur",this.bind(function(){if(!this.opened())this.container.removeClass("select2-container-active");window.setTimeout(this.bind(function(){this.selection.attr("tabIndex",this.opts.element.attr("tabIndex"))}),10)})),selection.bind("mousedown",this.bind(function(e){if(clickingInside=!0,this.opened())this.close(),this.selection.focus();else if(this.enabled)this.open();clickingInside=!1})),dropdown.bind("mousedown",this.bind(function(){this.search.focus()})),selection.bind("focus",this.bind(function(){this.container.addClass("select2-container-active"),this.search.attr("tabIndex","-1")})),selection.bind("blur",this.bind(function(){if(!this.opened())this.container.removeClass("select2-container-active");window.setTimeout(this.bind(function(){this.search.attr("tabIndex",this.opts.element.attr("tabIndex"))}),10)})),selection.bind("keydown",this.bind(function(e){if(this.enabled){if(e.which===KEY.PAGE_UP||e.which===KEY.PAGE_DOWN)return void killEvent(e);if(e.which!==KEY.TAB&&!KEY.isControl(e)&&!KEY.isFunctionKey(e)&&e.which!==KEY.ESC)if(this.opts.openOnEnter!==!1||e.which!==KEY.ENTER)if(e.which!=KEY.DELETE){if(this.open(),e.which===KEY.ENTER)return void killEvent(e);if(e.which<48)return void killEvent(e);var keyWritten=String.fromCharCode(e.which).toLowerCase();if(e.shiftKey)keyWritten=keyWritten.toUpperCase();this.search.focus(),this.search.val(keyWritten),killEvent(e)}else if(this.opts.allowClear)this.clear()}})),selection.delegate("abbr","mousedown",this.bind(function(e){if(this.enabled)this.clear(),killEvent(e),this.close(),this.triggerChange(),this.selection.focus()})),this.setPlaceholder(),this.search.bind("focus",this.bind(function(){this.container.addClass("select2-container-active")}))},clear:function(){this.opts.element.val(""),this.selection.find("span").empty(),this.selection.removeData("select2-data"),this.setPlaceholder()},initSelection:function(){var selected;if(""===this.opts.element.val()&&""===this.opts.element.text())this.close(),this.setPlaceholder();else{var self=this;this.opts.initSelection.call(null,this.opts.element,function(selected){if(void 0!==selected&&null!==selected)self.updateSelection(selected),self.close(),self.setPlaceholder()})}},prepareOpts:function(){var opts=this.parent.prepareOpts.apply(this,arguments);if("select"===opts.element.get(0).tagName.toLowerCase())opts.initSelection=function(element,callback){var selected=element.find(":selected");if($.isFunction(callback))callback({id:selected.attr("value"),text:selected.text()})};return opts},setPlaceholder:function(){var placeholder=this.getPlaceholder();if(""===this.opts.element.val()&&void 0!==placeholder){if(this.select&&""!==this.select.find("option:first").text())return;this.selection.find("span").html(escapeMarkup(placeholder)),this.selection.addClass("select2-default"),this.selection.find("abbr").hide()}},postprocessResults:function(data,initial){var selected=0,self=this,showSearchInput=!0;if(this.results.find(".select2-result-selectable").each2(function(i,elm){if(equal(self.id(elm.data("select2-data")),self.opts.element.val()))return selected=i,!1;else return void 0}),this.highlight(selected),initial===!0)showSearchInput=this.showSearchInput=countResults(data.results)>=this.opts.minimumResultsForSearch,this.dropdown.find(".select2-search")[showSearchInput?"removeClass":"addClass"]("select2-search-hidden"),$(this.dropdown,this.container)[showSearchInput?"addClass":"removeClass"]("select2-with-searchbox")},onSelect:function(data){var old=this.opts.element.val();if(this.opts.element.val(this.id(data)),this.updateSelection(data),this.close(),this.selection.focus(),!equal(old,this.id(data)))this.triggerChange()},updateSelection:function(data){var container=this.selection.find("span"),formatted;if(this.selection.data("select2-data",data),container.empty(),formatted=this.opts.formatSelection(data,container),void 0!==formatted)container.append(escapeMarkup(formatted));if(this.selection.removeClass("select2-default"),this.opts.allowClear&&void 0!==this.getPlaceholder())this.selection.find("abbr").show()},val:function(){var val,data=null,self=this;if(0===arguments.length)return this.opts.element.val();if(val=arguments[0],this.select)this.select.val(val).find(":selected").each2(function(i,elm){return data={id:elm.attr("value"),text:elm.text()},!1}),this.updateSelection(data),this.setPlaceholder();else{if(void 0===this.opts.initSelection)throw new Error("cannot call val() if initSelection() is not defined");if(!val)return void this.clear();this.opts.initSelection(this.opts.element,function(data){self.opts.element.val(!data?"":self.id(data)),self.updateSelection(data),self.setPlaceholder()})}},clearSearch:function(){this.search.val("")},data:function(value){var data;if(0===arguments.length){if(data=this.selection.data("select2-data"),void 0==data)data=null;return data}else if(!value||""===value)this.clear();else this.opts.element.val(!value?"":this.id(value)),this.updateSelection(value)}}),MultiSelect2=clazz(AbstractSelect2,{createContainer:function(){var container=$("<div></div>",{"class":"select2-container select2-container-multi"}).html(["    <ul class='select2-choices'>","  <li class='select2-search-field'>","    <input type='text' autocomplete='off' class='select2-input'>","  </li>","</ul>","<div class='select2-drop select2-drop-multi' style='display:none;'>","   <ul class='select2-results'>","   </ul>","</div>"].join(""));
return container},prepareOpts:function(){var opts=this.parent.prepareOpts.apply(this,arguments);if("select"===opts.element.get(0).tagName.toLowerCase())opts.initSelection=function(element,callback){var data=[];if(element.find(":selected").each2(function(i,elm){data.push({id:elm.attr("value"),text:elm.text()})}),$.isFunction(callback))callback(data)};return opts},initContainer:function(){var selector=".select2-choices",selection;this.searchContainer=this.container.find(".select2-search-field"),this.selection=selection=this.container.find(selector),this.search.bind("keydown",this.bind(function(e){if(this.enabled){if(e.which===KEY.BACKSPACE&&""===this.search.val()){this.close();var choices,selected=selection.find(".select2-search-choice-focus");if(selected.length>0)return this.unselect(selected.first()),this.search.width(10),void killEvent(e);if(choices=selection.find(".select2-search-choice"),choices.length>0)choices.last().addClass("select2-search-choice-focus")}else selection.find(".select2-search-choice-focus").removeClass("select2-search-choice-focus");if(this.opened())switch(e.which){case KEY.UP:case KEY.DOWN:return this.moveHighlight(e.which===KEY.UP?-1:1),void killEvent(e);case KEY.ENTER:case KEY.TAB:return this.selectHighlighted(),void killEvent(e);case KEY.ESC:return this.cancel(e),void killEvent(e)}if(e.which!==KEY.TAB&&!KEY.isControl(e)&&!KEY.isFunctionKey(e)&&e.which!==KEY.BACKSPACE&&e.which!==KEY.ESC)if(this.opts.openOnEnter!==!1||e.which!==KEY.ENTER)if(this.open(),e.which===KEY.PAGE_UP||e.which===KEY.PAGE_DOWN)killEvent(e)}})),this.search.bind("keyup",this.bind(this.resizeSearch)),this.search.bind("blur",this.bind(function(){this.container.removeClass("select2-container-active")})),this.container.delegate(selector,"mousedown",this.bind(function(e){if(this.enabled)this.clearPlaceholder(),this.open(),this.focusSearch(),e.preventDefault()})),this.container.delegate(selector,"focus",this.bind(function(){if(this.enabled)this.container.addClass("select2-container-active"),this.dropdown.addClass("select2-drop-active"),this.clearPlaceholder()})),this.clearSearch()},enable:function(){if(!this.enabled)this.parent.enable.apply(this,arguments),this.search.removeAttr("disabled")},disable:function(){if(this.enabled)this.parent.disable.apply(this,arguments),this.search.attr("disabled",!0)},initSelection:function(){var data;if(""===this.opts.element.val()&&""===this.opts.element.text())this.updateSelection([]),this.close(),this.clearSearch();if(this.select||""!==this.opts.element.val()){var self=this;this.opts.initSelection.call(null,this.opts.element,function(data){if(void 0!==data&&null!==data)self.updateSelection(data),self.close(),self.clearSearch()})}},clearSearch:function(){var placeholder=this.getPlaceholder();if(void 0!==placeholder&&0===this.getVal().length&&this.search.hasClass("select2-focused")===!1)this.search.val(placeholder).addClass("select2-default"),this.resizeSearch();else this.search.val(" ").width(10)},clearPlaceholder:function(){if(this.search.hasClass("select2-default"))this.search.val("").removeClass("select2-default");else if(" "===this.search.val())this.search.val("")},opening:function(){this.parent.opening.apply(this,arguments),this.clearPlaceholder(),this.resizeSearch(),this.focusSearch()},close:function(){if(this.opened())this.parent.close.apply(this,arguments)},focus:function(){this.close(),this.search.focus()},isFocused:function(){return this.search.hasClass("select2-focused")},updateSelection:function(data){var ids=[],filtered=[],self=this;$(data).each(function(){if(indexOf(self.id(this),ids)<0)ids.push(self.id(this)),filtered.push(this)}),data=filtered,this.selection.find(".select2-search-choice").remove(),$(data).each(function(){self.addSelectedChoice(this)}),self.postprocessResults()},tokenize:function(){var input=this.search.val();if(input=this.opts.tokenizer(input,this.data(),this.bind(this.onSelect),this.opts),null!=input&&void 0!=input)if(this.search.val(input),input.length>0)this.open()},onSelect:function(data){if(this.addSelectedChoice(data),this.select)this.postprocessResults();if(this.opts.closeOnSelect)this.close(),this.search.width(10);else if(this.countSelectableResults()>0)this.search.width(10),this.resizeSearch(),this.positionDropdown();else this.close();this.triggerChange({added:data}),this.focusSearch()},cancel:function(){this.close(),this.focusSearch()},addSelectedChoice:function(data){var choice=$("<li class='select2-search-choice'>    <div></div>    <a href='javascript:void(0)' class='select2-search-choice-close' tabindex='-1'></a></li>"),id=this.id(data),val=this.getVal(),formatted;formatted=this.opts.formatSelection(data,choice),choice.find("div").replaceWith("<div>"+escapeMarkup(formatted)+"</div>"),choice.find(".select2-search-choice-close").bind("mousedown",killEvent).bind("click dblclick",this.bind(function(e){if(this.enabled)$(e.target).closest(".select2-search-choice").fadeOut("fast").animate({width:"hide"},50,this.bind(function(){this.unselect($(e.target)),this.selection.find(".select2-search-choice-focus").removeClass("select2-search-choice-focus"),this.close(),this.focusSearch()})).dequeue(),killEvent(e)})).bind("focus",this.bind(function(){if(this.enabled)this.container.addClass("select2-container-active"),this.dropdown.addClass("select2-drop-active")})),choice.data("select2-data",data),choice.insertBefore(this.searchContainer),val.push(id),this.setVal(val)},unselect:function(selected){var val=this.getVal(),data,index;if(selected=selected.closest(".select2-search-choice"),0===selected.length)throw"Invalid argument: "+selected+". Must be .select2-search-choice";if(data=selected.data("select2-data"),index=indexOf(this.id(data),val),index>=0)if(val.splice(index,1),this.setVal(val),this.select)this.postprocessResults();selected.remove(),this.triggerChange({removed:data})},postprocessResults:function(){var val=this.getVal(),choices=this.results.find(".select2-result-selectable"),compound=this.results.find(".select2-result-with-children"),self=this;choices.each2(function(i,choice){var id=self.id(choice.data("select2-data"));if(indexOf(id,val)>=0)choice.addClass("select2-disabled").removeClass("select2-result-selectable");else choice.removeClass("select2-disabled").addClass("select2-result-selectable")}),compound.each2(function(i,e){if(0==e.find(".select2-result-selectable").length)e.addClass("select2-disabled");else e.removeClass("select2-disabled")}),choices.each2(function(i,choice){if(!choice.hasClass("select2-disabled")&&choice.hasClass("select2-result-selectable"))return self.highlight(0),!1;else return void 0})},resizeSearch:function(){var minimumWidth,left,maxWidth,containerLeft,searchWidth,sideBorderPadding=getSideBorderPadding(this.search);if(minimumWidth=measureTextWidth(this.search)+10,left=this.search.offset().left,maxWidth=this.selection.width(),containerLeft=this.selection.offset().left,searchWidth=maxWidth-(left-containerLeft)-sideBorderPadding,minimumWidth>searchWidth)searchWidth=maxWidth-sideBorderPadding;if(40>searchWidth)searchWidth=maxWidth-sideBorderPadding;this.search.width(searchWidth)},getVal:function(){var val;if(this.select)return val=this.select.val(),null===val?[]:val;else return val=this.opts.element.val(),splitVal(val,this.opts.separator)},setVal:function(val){var unique;if(this.select)this.select.val(val);else unique=[],$(val).each(function(){if(indexOf(this,unique)<0)unique.push(this)}),this.opts.element.val(0===unique.length?"":unique.join(this.opts.separator))},val:function(){var val,data=[],self=this;if(0===arguments.length)return this.getVal();if(val=arguments[0],!val)return this.opts.element.val(""),this.updateSelection([]),void this.clearSearch();if(this.setVal(val),this.select)this.select.find(":selected").each(function(){data.push({id:$(this).attr("value"),text:$(this).text()})}),this.updateSelection(data);else{if(void 0===this.opts.initSelection)throw new Error("val() cannot be called if initSelection() is not defined");this.opts.initSelection(this.opts.element,function(data){var ids=$(data).map(self.id);self.setVal(ids),self.updateSelection(data),self.clearSearch()})}this.clearSearch()},onSortStart:function(){if(this.select)throw new Error("Sorting of elements is not supported when attached to <select>. Attach to <input type='hidden'/> instead.");this.search.width(0),this.searchContainer.hide()},onSortEnd:function(){var val=[],self=this;this.searchContainer.show(),this.searchContainer.appendTo(this.searchContainer.parent()),this.resizeSearch(),this.selection.find(".select2-search-choice").each(function(){val.push(self.opts.id($(this).data("select2-data")))}),this.setVal(val),this.triggerChange()},data:function(values){var self=this,ids;if(0===arguments.length)return this.selection.find(".select2-search-choice").map(function(){return $(this).data("select2-data")}).get();else{if(!values)values=[];ids=$.map(values,function(e){return self.opts.id(e)}),this.setVal(ids),this.updateSelection(values),this.clearSearch()}}}),$.fn.select2=function(){var args=Array.prototype.slice.call(arguments,0),opts,select2,value,multiple,allowedMethods=["val","destroy","opened","open","close","focus","isFocused","container","onSortStart","onSortEnd","enable","disable","positionDropdown","data"];return this.each(function(){if(0===args.length||"object"==typeof args[0]){if(opts=0===args.length?{}:$.extend({},args[0]),opts.element=$(this),"select"===opts.element.get(0).tagName.toLowerCase())multiple=opts.element.attr("multiple");else if(multiple=opts.multiple||!1,"tags"in opts)opts.multiple=multiple=!0;select2=multiple?new MultiSelect2:new SingleSelect2,select2.init(opts)}else if("string"==typeof args[0]){if(indexOf(args[0],allowedMethods)<0)throw"Unknown method: "+args[0];if(value=void 0,select2=$(this).data("select2"),void 0===select2)return;if("container"===args[0])value=select2.container;else value=select2[args[0]].apply(select2,args.slice(1));if(void 0!==value)return!1}else throw"Invalid arguments to select2 plugin: "+args}),void 0===value?this:value},$.fn.select2.defaults={width:"copy",closeOnSelect:!0,openOnEnter:!0,containerCss:{},dropdownCss:{},containerCssClass:"",dropdownCssClass:"",formatResult:function(result,container,query){var markup=[];return markMatch(result.text,query.term,markup),markup.join("")},formatSelection:function(data,container){return data.text},formatResultCssClass:function(data){return void 0},formatNoMatches:function(){return"No matches found"},formatInputTooShort:function(input,min){return"Please enter "+(min-input.length)+" more characters"},formatSelectionTooBig:function(limit){return"You can only select "+limit+" items"},formatLoadMore:function(pageNumber){return"Loading more results..."},formatSearching:function(){return"Searching..."},minimumResultsForSearch:0,minimumInputLength:0,maximumSelectionSize:0,id:function(e){return e.id},matcher:function(term,text){return text.toUpperCase().indexOf(term.toUpperCase())>=0},separator:",",tokenSeparators:[],tokenizer:defaultTokenizer}}};if("function"==typeof define&&define.amd)define("js/lib/select2",["jquery"],function($){return Select2Plugin($)});else if("undefined"!=typeof window&&"undefined"==typeof ender)return Select2Plugin(window.jQuery)}(),define("pages/forum/views/ThreadTagsView",["backbone","jquery","underscore","pages/spark/app","pages/forum/views/ThreadTagsView.html","js/lib/select2"],function(Backbone,$,_,Coursera,ThreadTagsTemplate){var TRACKER_LABEL="Forum Thread",view=Backbone.View.extend({defaults:{},events:{"click .course-forum-thread-tags-link":"onThreadTagsClick","click .course-forum-thread-tags-form button":"onThreadTagsSave","click .course-forum-thread-tags-form a":"onThreadTagsCancel","click .course-forum-thread-tag-delete":"onThreadTagDelete"},initialize:function(options){this.options=options,this.thread=this.model,this.thread.bind("change",this.render,this)},render:function(){var changedAttrs=this.thread.changedAttributes();if(!this.$(".course-forum-thread-tags-form").length||changedAttrs&&_.intersection(_.keys(changedAttrs),["tags"]).length>0)this.$el.html(ThreadTagsTemplate({config:Coursera.config,thread:this.thread})),this.$form=this.$(".course-forum-thread-tags-form");return this},onThreadTagsClick:function(e){e.preventDefault();var self=this;self.$form.show(),Coursera.api.get("forum/tags",{message:{waiting:"Fetching tags..."}}).done(function(data){var currentTags=_.pluck(self.thread.get("tags"),"tag_name"),allTags=_.pluck(data,"tag_name"),possibleTags=_.without(allTags,currentTags);self.$form.find("input").select2({width:"400px",tags:possibleTags}),self.$form.find("button").attr("disabled",null)})},onThreadTagsSave:function(e){e.preventDefault();var self=this,tagNames=self.$("input[name=tags]").val().split(","),tags=_.map(_.uniq(tagNames),function(tagName){return{tag_name:tagName}});Coursera.api.post(this.thread.tagsUrl(),{data:tags,message:{waiting:"Saving tags...",success:"Saved tags!"}}).done(function(data){self.thread.set({tags:data})}),self.$form.find("button").attr("disabled","disabled"),Coursera.multitracker.push([TRACKER_LABEL,"Tags Save"])},onThreadTagsCancel:function(e){var self=this;e.preventDefault(),self.$form[0].reset(),self.$form.hide(),Coursera.multitracker.push([TRACKER_LABEL,"Tags Cancel"])},onThreadTagDelete:function(e){e.preventDefault();var self=this,tags=[{tag_name:$(e.target).attr("data-tag")}];Coursera.api["delete"](this.thread.tagsUrl(),{data:tags,message:{waiting:"Deleting tag...",success:"Deleted tag"}}).done(function(data){self.thread.set({tags:data})}),Coursera.multitracker.push([TRACKER_LABEL,"Tag Delete"])}});return view}),!function(wndw){var jadify=function(jade,_t){_t="undefined"!=typeof _t?_t:function(key,interpolationHash){if("object"==typeof interpolationHash)return key.replace(/[#!]\{([^}]+?)\}/g,function(match,interpKey){return interpolationHash[interpKey]||interpKey});else return key};var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(post){if(buf.push('<div class="course-forum-post-container"><div class="course-forum-post-top-container"></div>'),!post.isNew())if(buf.push('<div class="course-forum-comments-container"></div>'),!post.get("original"))buf.push('<div class="course-forum-new-comment-container"></div><div class="course-forum-new-comment-link-container"><a href="javascript:void(0);" class="course-forum-new-comment-link">+ Comment</a></div>');buf.push("</div>")}("post"in locals_for_with?locals_for_with.post:"undefined"!=typeof post?post:void 0),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("pages/forum/views/PostContainerView.html",["js/lib/jade"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["pages.forum.views.PostContainerView"]=jadify(wndw.jade.helpers)}(window),!function(wndw){var jadify=function(jade,_t){_t="undefined"!=typeof _t?_t:function(key,interpolationHash){if("object"==typeof interpolationHash)return key.replace(/[#!]\{([^}]+?)\}/g,function(match,interpKey){return interpolationHash[interpKey]||interpKey});else return key};var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(entry,user,reporterLink){if(entry.get("deleted")&&!user.canModerateForum())buf.push('<small class="course-forum-delete-indicator"><span class="icon-trash"></span>A post was deleted</small>');else{if(buf.push("<div"+jade.attr("data-permalink",entry.getPermalinkHash(),!0,!1)+jade.cls(["course-forum-post-view-container",1==entry.get("deleted")?"course-forum-post-deleted":""],[null,!0])+'><div class="course-forum-post-header"><div class="course-forum-post-controls">'),1==entry.get("stickied"))buf.push('<span title="Post was stickied by staff." class="course-forum-post-indicator course-forum-indicator-good"><i class="icon-pushpin"></i>Pinned</span>');if(1==entry.get("approved"))buf.push('<span title="Post was approved by staff." class="course-forum-post-indicator course-forum-indicator-good"><i class="icon-star"></i>Approved</span>');if(1==entry.get("is_spam"))buf.push('<span title="Post was marked as spam." class="course-forum-post-indicator course-forum-indicator-bad"><i class="icon-trash"></i>Spam</span>');var popupId="course-forum-post-controls-"+entry.get("id");if(entry.get("_viewer_can_edit")||user.canAccessAdmin()||user.canModerateForum()){if(buf.push('<a title="Controls" tabindex="0" role="button" aria-haspopup="true" aria-expanded="false"'+jade.attr("aria-owns",popupId,!0,!1)+jade.attr("data-popup","#"+popupId,!0,!1)+' data-popup-direction="se" class="course-forum-post-controls-toggle"><i class="icon-cog"><span class="hidden">Controls</span></i></a><div'+jade.attr("id",popupId,!0,!1)+' class="course-forum-post-controls-popup hide">'),user.canModerateForum())buf.push('<a href="javascript:void(0)" class="course-forum-post-admin-details-link">Show Admin Details</a>');if(buf.push("<!-- If you have editing rights, you can edit or delete-->"),entry.get("_viewer_can_edit"))if(buf.push('<a href="javascript:void(0)" class="course-forum-post-edit-link">Edit</a>'),0==entry.get("deleted"))buf.push('<a href="javascript:void(0)" data-property="deleted" data-value="1" class="course-forum-post-action-link">Delete</a>');else buf.push('<a href="javascript:void(0)" data-property="deleted" data-value="0" class="course-forum-post-action-link">Un-delete</a>');if(buf.push("<!-- Only forum moderators -->"),user.canModerateForum()&&"post"==entry.entryType){if(0==entry.get("stickied"))buf.push('<a href="javascript:void(0)" data-property="stickied" data-value="1" class="course-forum-post-action-link">Pin</a>');else buf.push('<a href="javascript:void(0)" data-property="stickied" data-value="0" class="course-forum-post-action-link">Un-pin</a>');if(0==entry.get("approved"))buf.push('<a href="javascript:void(0)" data-property="approved" data-value="1" class="course-forum-post-action-link">Approve</a>');else buf.push('<a href="javascript:void(0)" data-property="approved" data-value="0" class="course-forum-post-action-link">Un-approve</a>')}if(user.canModerateForum())if(0==entry.get("is_spam"))buf.push('<a href="javascript:void(0)" data-property="is_spam" data-value="1" class="course-forum-post-action-link">Spam</a>');else buf.push('<a href="javascript:void(0)" data-property="is_spam" data-value="0" class="course-forum-post-action-link">Not spam</a>');buf.push("</div>")}if(buf.push('</div><h5 class="course-forum-post-byline"></h5></div><div dir="auto" class="course-forum-post-text">'+(null==(jade_interp=entry.getMessageHtml())?"":jade_interp)+"</div>"),user.canModerateForum()){if(buf.push('<div class="course-forum-post-admin-container"><span>'+jade.escape(null==(jade_interp=entry.get("user_id"))?"":jade_interp)+"</span> &middot; &nbsp;<span>"+jade.escape(null==(jade_interp=entry.get("_user_full_name"))?"":jade_interp)+"</span> &middot; &nbsp;"),entry.get("_user_email_address"))buf.push("<span>"+jade.escape(null==(jade_interp=entry.get("_user_email_address"))?"":jade_interp)+"</span> &middot; &nbsp;");if(buf.push('<a target="_blank"'+jade.attr("href",entry.get("_user_search_link"),!0,!1)+'><span class="icon-comments"></span> All Posts</a> &middot; &nbsp;'),user.canAccessAdmin())buf.push('<a target="_blank"'+jade.attr("href",entry.get("_user_details_link"),!0,!1)+'><span class="icon-tasks"></span> More Student Details</a>');if(buf.push("<br/>"),entry.get("user_agent"))buf.push('<a target="_blank"'+jade.attr("href","http://user-agent-string.info/?Fuas="+entry.get("user_agent"),!0,!1)+">"+jade.escape(null==(jade_interp=entry.get("user_agent"))?"":jade_interp)+"</a>");buf.push("</div>")}var voteClass="";if(entry.get("votes")>0)voteClass="course-forum-votes-positive";if(entry.get("votes")<0)voteClass="course-forum-votes-negative";var voteTooltip="Please use votes to bring attention to thoughtful, helpful posts.";buf.push('<div aria-haspopup="true" aria-expanded="false"'+jade.attr("data-tooltip",voteTooltip,!0,!1)+' data-tooltip-position="down" class="course-forum-post-vote-controls"><div tabindex="0" aria-label="Vote this post up." data-direction-value="1" role="button"'+jade.cls(["course-forum-post-vote-button","course-forum-post-vote-up","1"==entry.get("_viewer_vote")?"course-forum-vote-active":"course-forum-vote-inactive"],[null,null,!0])+'><i class="icon-arrow-up"></i></div><span'+jade.cls(["course-forum-post-vote-count",voteClass],[null,!0])+">"+jade.escape(null==(jade_interp=entry.get("votes"))?"":jade_interp)+'</span><span class="accessible-text-for-reader">votes received.</span><div tabindex="0" aria-label="Vote this post down." data-direction-value="-1" role="button"'+jade.cls(["course-forum-post-vote-button","course-forum-post-vote-down","-1"==entry.get("_viewer_vote")?"course-forum-vote-active":"course-forum-vote-inactive"],[null,null,!0])+'><i class="icon-arrow-down"></i></div></div><a'+jade.attr("href",reporterLink,!0,!1)+' target="_blank" class="course-forum-post-controls-report">&middot;\nflag</a><div style="clear: both; height: 3px;"></div></div>')}}("entry"in locals_for_with?locals_for_with.entry:"undefined"!=typeof entry?entry:void 0,"user"in locals_for_with?locals_for_with.user:"undefined"!=typeof user?user:void 0,"reporterLink"in locals_for_with?locals_for_with.reporterLink:"undefined"!=typeof reporterLink?reporterLink:void 0),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("pages/forum/views/EntryView.html",["js/lib/jade"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["pages.forum.views.EntryView"]=jadify(wndw.jade.helpers)}(window),!function(wndw){var jadify=function(jade,_t){var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(entry,config,spark_class_short_name,spark_class_id){if(entry.get("anonymous"))buf.push("<span>Anonymous</span>");else{if(buf.push("<a"+jade.attr("href",entry.get("_user_profile_link"),!0,!1)+">"),entry.get("_user_profile")){if(entry.get("_user_profile").photo_24)buf.push("<img"+jade.attr("src",entry.get("_user_profile").photo_24,!0,!1)+' alt=""/>');buf.push(""+jade.escape(null==(jade_interp=entry.get("_user_profile").display_name)?"":jade_interp))}else buf.push(""+jade.escape(null==(jade_interp=entry.get("_user_full_name"))?"":jade_interp));buf.push("</a>")}if(!entry.get("anonymous"))if(entry.get("_user_title")&&"Student"!=entry.get("_user_title"))buf.push('<span class="course-forum-profile-badge">'+jade.escape(null==(jade_interp=entry.get("_user_title"))?"":jade_interp)+"</span>");else if(entry.get("_show_signature_track_label"))buf.push('<a style="text-decoration: none;"'+jade.attr("href",config.url.base+"signature/course/"+spark_class_short_name+"/"+spark_class_id+"?utm_source=spark&utm_medium=forum",!0,!1)+' target="_blank"><span class="course-forum-profile-badge-signaturetrack">Signature Track</span></a>');buf.push('<span style="vertical-align: middle; margin-left: 5px;" class="course-forum-profile-badgeville"></span><span style="vertical-align:middle">· </span><a'+jade.attr("href",entry.getPermalink(),!0,!1)+jade.attr("name",entry.getPermalinkHash(),!0,!1)+' style="vertical-align:middle"><time'+jade.attr("datetime",entry.get("post_time"),!0,!1)+">"+jade.escape(null==(jade_interp=entry.get("post_time"))?"":jade_interp)+'</time>&nbsp;<span class="icon-link"></span></a>')}("entry"in locals_for_with?locals_for_with.entry:"undefined"!=typeof entry?entry:void 0,"config"in locals_for_with?locals_for_with.config:"undefined"!=typeof config?config:void 0,"spark_class_short_name"in locals_for_with?locals_for_with.spark_class_short_name:"undefined"!=typeof spark_class_short_name?spark_class_short_name:void 0,"spark_class_id"in locals_for_with?locals_for_with.spark_class_id:"undefined"!=typeof spark_class_id?spark_class_id:void 0),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("pages/forum/views/EntryBylineView.html",["js/lib/jade"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["pages.forum.views.EntryBylineView"]=jadify(wndw.jade.helpers)}(window),!function(wndw){var jadify=function(jade,_t){_t="undefined"!=typeof _t?_t:function(key,interpolationHash){if("object"==typeof interpolationHash)return key.replace(/[#!]\{([^}]+?)\}/g,function(match,interpKey){return interpolationHash[interpKey]||interpKey});else return key};var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(entry,reportNewProblemLink){if(buf.push('<div><div class="course-forum-post-edit-container-loading hide">Posting ...</div><div class="course-forum-post-edit-container"><div class="course-forum-post-header">'),entry.isNew())buf.push('<span class="course-forum-post-new">New '+jade.escape(null==(jade_interp=entry.entryType)?"":jade_interp)+' </span><span style="font-style:italic;display:none;" class="course-forum-post-viewer-wants-unresolve">(thread will be unresolved upon posting)</span>');else buf.push("<span>Editing "+jade.escape(null==(jade_interp=entry.entryType)?"":jade_interp)+"...</span>");if(buf.push('</div><form class="course-forum-post-edit-form"><p class="help-block">To ensure a positive and productive discussion,\nplease read our <a target="_blank" href="http://help.coursera.org/customer/portal/articles/1220499-forum-code-of-conduct?ref=entryedit">forum posting policies</a> before posting.</p><input type="hidden" name="text_type" value="html"/><div class="control-group"><label class="hidden">Message</label><textarea'+jade.attr("name",entry.textProp,!0,!1)+' style="width:100%; min-height: 100px;" dir="auto">'+(null==(jade_interp=entry.getEditableHtml())?"":jade_interp)+"</textarea></div>"),entry.isNew())buf.push('<div style="display:none;" class="controls course-forum-post-viewer-wants-resolve"><label class="checkbox"><input type="checkbox" name="_viewer_wants_resolve" value="1"/>Resolve thread</label><div class="alert">This thread is marked as unresolved. If the problem is fixed, please check the above box and make a post to let staff know that they no longer need to monitor this thread. </div></div><div style="display:none;" class="controls course-forum-post-viewer-cant-unresolve"><div class="alert">This thread is marked as resolved. Staff are no longer monitoring this thread. If the problem is not fixed, please start a new thread <a'+jade.attr("href",reportNewProblemLink,!0,!1)+'>here</a> to let staff know that there is still a problem.</div></div><div class="controls"><label class="checkbox"><input type="checkbox" name="anonymous" value="1"/>Make this post anonymous to other students</label></div><div class="controls"><label class="checkbox"><input type="checkbox" name="subscribe" value="1" checked="checked"/>Subscribe to this thread at the same time</label></div>');if(buf.push('<div class="control-group"><button type="submit" class="btn course-forum-post-edit-save">'),entry.isNew())buf.push("Add "+jade.escape(null==(jade_interp=entry.entryType)?"":jade_interp));else buf.push("Update "+jade.escape(null==(jade_interp=entry.entryType)?"":jade_interp));buf.push('</button><span>&nbsp; &nbsp;</span><a href="javascript:void(0)" role="Button" class="course-forum-post-edit-cancel">Cancel</a></div></form></div></div>')}("entry"in locals_for_with?locals_for_with.entry:"undefined"!=typeof entry?entry:void 0,"reportNewProblemLink"in locals_for_with?locals_for_with.reportNewProblemLink:"undefined"!=typeof reportNewProblemLink?reportNewProblemLink:void 0),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("pages/forum/views/EntryEditView.html",["js/lib/jade"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["pages.forum.views.EntryEditView"]=jadify(wndw.jade.helpers)}(window),!function(global){var wysihtml5_init=function(){var document=global.document,wysihtml5={version:"0.4.0pre",commands:{},dom:{},quirks:{},toolbar:{},lang:{},selection:{},views:{},INVISIBLE_SPACE:"",EMPTY_FUNCTION:function(){},ELEMENT_NODE:1,TEXT_NODE:3,BACKSPACE_KEY:8,ENTER_KEY:13,ESCAPE_KEY:27,SPACE_KEY:32,DELETE_KEY:46},rangy=function(){function isHostMethod(o,p){var t=typeof o[p];return t==FUNCTION||!(t!=OBJECT||!o[p])||"unknown"==t}function isHostObject(o,p){return!(typeof o[p]!=OBJECT||!o[p])}function isHostProperty(o,p){return typeof o[p]!=UNDEFINED}function createMultiplePropertyTest(testFunc){return function(o,props){for(var i=props.length;i--;)if(!testFunc(o,props[i]))return!1;return!0}}function isTextRange(range){return range&&areHostMethods(range,textRangeMethods)&&areHostProperties(range,textRangeProperties)}function fail(reason){global.alert("Rangy not supported in your browser. Reason: "+reason),api.initialized=!0,api.supported=!1}function warn(msg){var warningMessage="Rangy warning: "+msg;if(api.config.alertOnWarn)global.alert(warningMessage);else if(typeof global.console!=UNDEFINED&&typeof window.console.log!=UNDEFINED)global.console.log(warningMessage)}function init(){if(!api.initialized){var testRange,implementsDomRange=!1,implementsTextRange=!1;if(isHostMethod(document,"createRange")){if(testRange=document.createRange(),areHostMethods(testRange,domRangeMethods)&&areHostProperties(testRange,domRangeProperties))implementsDomRange=!0;testRange.detach()}var body=isHostObject(document,"body")?document.body:document.getElementsByTagName("body")[0];if(body&&isHostMethod(body,"createTextRange"))if(testRange=body.createTextRange(),isTextRange(testRange))implementsTextRange=!0;if(!implementsDomRange&&!implementsTextRange)fail("Neither Range nor TextRange are implemented");api.initialized=!0,api.features={implementsDomRange:implementsDomRange,implementsTextRange:implementsTextRange};for(var allListeners=moduleInitializers.concat(initListeners),i=0,len=allListeners.length;len>i;++i)try{allListeners[i](api)}catch(ex){if(isHostObject(global,"console")&&isHostMethod(window.console,"log"))global.console.log("Init listener threw an exception. Continuing.",ex)}}}function createMissingNativeApi(win){win=win||global,init();for(var i=0,len=createMissingNativeApiListeners.length;len>i;++i)createMissingNativeApiListeners[i](win)}function Module(name){this.name=name,this.initialized=!1,this.supported=!1}var OBJECT="object",FUNCTION="function",UNDEFINED="undefined",domRangeProperties=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer","START_TO_START","START_TO_END","END_TO_START","END_TO_END"],domRangeMethods=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents","cloneRange","toString","detach"],textRangeProperties=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"],textRangeMethods=["collapse","compareEndPoints","duplicate","getBookmark","moveToBookmark","moveToElementText","parentElement","pasteHTML","select","setEndPoint","getBoundingClientRect"],areHostMethods=createMultiplePropertyTest(isHostMethod),areHostObjects=createMultiplePropertyTest(isHostObject),areHostProperties=createMultiplePropertyTest(isHostProperty),api={version:"1.2.2",initialized:!1,supported:!0,util:{isHostMethod:isHostMethod,isHostObject:isHostObject,isHostProperty:isHostProperty,areHostMethods:areHostMethods,areHostObjects:areHostObjects,areHostProperties:areHostProperties,isTextRange:isTextRange},features:{},modules:{},config:{alertOnWarn:!1,preferTextRange:!1}};if(api.fail=fail,api.warn=warn,{}.hasOwnProperty)api.util.extend=function(o,props){for(var i in props)if(props.hasOwnProperty(i))o[i]=props[i]};else fail("hasOwnProperty not supported");var initListeners=[],moduleInitializers=[];
api.init=init,api.addInitListener=function(listener){if(api.initialized)listener(api);else initListeners.push(listener)};var createMissingNativeApiListeners=[];api.addCreateMissingNativeApiListener=function(listener){createMissingNativeApiListeners.push(listener)},api.createMissingNativeApi=createMissingNativeApi,Module.prototype.fail=function(reason){throw this.initialized=!0,this.supported=!1,new Error("Module '"+this.name+"' failed to load: "+reason)},Module.prototype.warn=function(msg){api.warn("Module "+this.name+": "+msg)},Module.prototype.createError=function(msg){return new Error("Error in Rangy "+this.name+" module: "+msg)},api.createModule=function(name,initFunc){var module=new Module(name);api.modules[name]=module,moduleInitializers.push(function(api){initFunc(api,module),module.initialized=!0,module.supported=!0})},api.requireModules=function(modules){for(var i=0,len=modules.length,module,moduleName;len>i;++i){if(moduleName=modules[i],module=api.modules[moduleName],!(module&&module instanceof Module))throw new Error("Module '"+moduleName+"' not found");if(!module.supported)throw new Error("Module '"+moduleName+"' not supported")}};var docReady=!1,loadHandler=function(e){if(!docReady)if(docReady=!0,!api.initialized)init()};if(typeof global==UNDEFINED)return void fail("No window found");if(typeof document==UNDEFINED)return void fail("No document found");if(isHostMethod(document,"addEventListener"))document.addEventListener("DOMContentLoaded",loadHandler,!1);if(isHostMethod(global,"addEventListener"))global.addEventListener("load",loadHandler,!1);else if(isHostMethod(global,"attachEvent"))global.attachEvent("onload",loadHandler);else fail("Window does not have required addEventListener or attachEvent method");return api}();rangy.createModule("DomUtil",function(api,module){function isHtmlNamespace(node){var ns;return typeof node.namespaceURI==UNDEF||null===(ns=node.namespaceURI)||"http://www.w3.org/1999/xhtml"==ns}function parentElement(node){var parent=node.parentNode;return 1==parent.nodeType?parent:null}function getNodeIndex(node){for(var i=0;node=node.previousSibling;)i++;return i}function getNodeLength(node){var childNodes;return isCharacterDataNode(node)?node.length:(childNodes=node.childNodes)?childNodes.length:0}function getCommonAncestor(node1,node2){var ancestors=[],n;for(n=node1;n;n=n.parentNode)ancestors.push(n);for(n=node2;n;n=n.parentNode)if(arrayContains(ancestors,n))return n;return null}function isAncestorOf(ancestor,descendant,selfIsAncestor){for(var n=selfIsAncestor?descendant:descendant.parentNode;n;)if(n===ancestor)return!0;else n=n.parentNode;return!1}function getClosestAncestorIn(node,ancestor,selfIsAncestor){for(var p,n=selfIsAncestor?node:node.parentNode;n;){if(p=n.parentNode,p===ancestor)return n;n=p}return null}function isCharacterDataNode(node){var t=node.nodeType;return 3==t||4==t||8==t}function insertAfter(node,precedingNode){var nextNode=precedingNode.nextSibling,parent=precedingNode.parentNode;if(nextNode)parent.insertBefore(node,nextNode);else parent.appendChild(node);return node}function splitDataNode(node,index){var newNode=node.cloneNode(!1);return newNode.deleteData(0,index),node.deleteData(index,node.length-index),insertAfter(newNode,node),newNode}function getDocument(node){if(9==node.nodeType)return node;else if(typeof node.ownerDocument!=UNDEF)return node.ownerDocument;else if(typeof node.document!=UNDEF)return node.document;else if(node.parentNode)return getDocument(node.parentNode);else throw new Error("getDocument: no document found for node")}function getWindow(node){var doc=getDocument(node);if(typeof doc.defaultView!=UNDEF)return doc.defaultView;else if(typeof doc.parentWindow!=UNDEF)return doc.parentWindow;else throw new Error("Cannot get a window object for node")}function getIframeDocument(iframeEl){if(typeof iframeEl.contentDocument!=UNDEF)return iframeEl.contentDocument;else if(typeof iframeEl.contentWindow!=UNDEF)return iframeEl.contentWindow.document;else throw new Error("getIframeWindow: No Document object found for iframe element")}function getIframeWindow(iframeEl){if(typeof iframeEl.contentWindow!=UNDEF)return iframeEl.contentWindow;else if(typeof iframeEl.contentDocument!=UNDEF)return iframeEl.contentDocument.defaultView;else throw new Error("getIframeWindow: No Window object found for iframe element")}function getBody(doc){return util.isHostObject(doc,"body")?doc.body:doc.getElementsByTagName("body")[0]}function getRootContainer(node){for(var parent;parent=node.parentNode;)node=parent;return node}function comparePoints(nodeA,offsetA,nodeB,offsetB){var nodeC,root,childA,childB,n;if(nodeA==nodeB)return offsetA===offsetB?0:offsetB>offsetA?-1:1;else if(nodeC=getClosestAncestorIn(nodeB,nodeA,!0))return offsetA<=getNodeIndex(nodeC)?-1:1;else if(nodeC=getClosestAncestorIn(nodeA,nodeB,!0))return getNodeIndex(nodeC)<offsetB?-1:1;else if(root=getCommonAncestor(nodeA,nodeB),childA=nodeA===root?root:getClosestAncestorIn(nodeA,root,!0),childB=nodeB===root?root:getClosestAncestorIn(nodeB,root,!0),childA===childB)throw new Error("comparePoints got to case 4 and childA and childB are the same!");else{for(n=root.firstChild;n;){if(n===childA)return-1;else if(n===childB)return 1;n=n.nextSibling}throw new Error("Should not be here!")}}function fragmentFromNodeChildren(node){for(var fragment=getDocument(node).createDocumentFragment(),child;child=node.firstChild;)fragment.appendChild(child);return fragment}function inspectNode(node){if(!node)return"[No node]";if(isCharacterDataNode(node))return'"'+node.data+'"';else if(1==node.nodeType){var idAttr=node.id?' id="'+node.id+'"':"";return"<"+node.nodeName+idAttr+">["+node.childNodes.length+"]"}else return node.nodeName}function NodeIterator(root){this.root=root,this._next=root}function createIterator(root){return new NodeIterator(root)}function DomPosition(node,offset){this.node=node,this.offset=offset}function DOMException(codeName){this.code=this[codeName],this.codeName=codeName,this.message="DOMException: "+this.codeName}var UNDEF="undefined",util=api.util;if(!util.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"]))module.fail("document missing a Node creation method");if(!util.isHostMethod(document,"getElementsByTagName"))module.fail("document missing getElementsByTagName method");var el=document.createElement("div");if(!util.areHostMethods(el,["insertBefore","appendChild","cloneNode"]||!util.areHostObjects(el,["previousSibling","nextSibling","childNodes","parentNode"])))module.fail("Incomplete Element implementation");if(!util.isHostProperty(el,"innerHTML"))module.fail("Element is missing innerHTML property");var textNode=document.createTextNode("test");if(!util.areHostMethods(textNode,["splitText","deleteData","insertData","appendData","cloneNode"]||!util.areHostObjects(el,["previousSibling","nextSibling","childNodes","parentNode"])||!util.areHostProperties(textNode,["data"])))module.fail("Incomplete Text Node implementation");var arrayContains=function(arr,val){for(var i=arr.length;i--;)if(arr[i]===val)return!0;return!1};NodeIterator.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var n=this._current=this._next,child,next;if(this._current)if(child=n.firstChild)this._next=child;else{for(next=null;n!==this.root&&!(next=n.nextSibling);)n=n.parentNode;this._next=next}return this._current},detach:function(){this._current=this._next=this.root=null}},DomPosition.prototype={equals:function(pos){return this.node===pos.node&this.offset==pos.offset},inspect:function(){return"[DomPosition("+inspectNode(this.node)+":"+this.offset+")]"}},DOMException.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11},DOMException.prototype.toString=function(){return this.message},api.dom={arrayContains:arrayContains,isHtmlNamespace:isHtmlNamespace,parentElement:parentElement,getNodeIndex:getNodeIndex,getNodeLength:getNodeLength,getCommonAncestor:getCommonAncestor,isAncestorOf:isAncestorOf,getClosestAncestorIn:getClosestAncestorIn,isCharacterDataNode:isCharacterDataNode,insertAfter:insertAfter,splitDataNode:splitDataNode,getDocument:getDocument,getWindow:getWindow,getIframeWindow:getIframeWindow,getIframeDocument:getIframeDocument,getBody:getBody,getRootContainer:getRootContainer,comparePoints:comparePoints,inspectNode:inspectNode,fragmentFromNodeChildren:fragmentFromNodeChildren,createIterator:createIterator,DomPosition:DomPosition},api.DOMException=DOMException}),rangy.createModule("DomRange",function(api,module){function isNonTextPartiallySelected(node,range){return 3!=node.nodeType&&(dom.isAncestorOf(node,range.startContainer,!0)||dom.isAncestorOf(node,range.endContainer,!0))}function getRangeDocument(range){return dom.getDocument(range.startContainer)}function dispatchEvent(range,type,args){var listeners=range._listeners[type];if(listeners)for(var i=0,len=listeners.length;len>i;++i)listeners[i].call(range,{target:range,args:args})}function getBoundaryBeforeNode(node){return new DomPosition(node.parentNode,dom.getNodeIndex(node))}function getBoundaryAfterNode(node){return new DomPosition(node.parentNode,dom.getNodeIndex(node)+1)}function insertNodeAtPosition(node,n,o){var firstNodeInserted=11==node.nodeType?node.firstChild:node;if(dom.isCharacterDataNode(n))if(o==n.length)dom.insertAfter(node,n);else n.parentNode.insertBefore(node,0===o?n:dom.splitDataNode(n,o));else if(o>=n.childNodes.length)n.appendChild(node);else n.insertBefore(node,n.childNodes[o]);return firstNodeInserted}function cloneSubtree(iterator){for(var partiallySelected,node,frag=getRangeDocument(iterator.range).createDocumentFragment(),subIterator;node=iterator.next();){if(partiallySelected=iterator.isPartiallySelectedSubtree(),node=node.cloneNode(!partiallySelected),partiallySelected)subIterator=iterator.getSubtreeIterator(),node.appendChild(cloneSubtree(subIterator)),subIterator.detach(!0);if(10==node.nodeType)throw new DOMException("HIERARCHY_REQUEST_ERR");frag.appendChild(node)}return frag}function iterateSubtree(rangeIterator,func,iteratorState){var it,n;iteratorState=iteratorState||{stop:!1};for(var node,subRangeIterator;node=rangeIterator.next();)if(rangeIterator.isPartiallySelectedSubtree()){if(func(node)===!1)return void(iteratorState.stop=!0);else if(subRangeIterator=rangeIterator.getSubtreeIterator(),iterateSubtree(subRangeIterator,func,iteratorState),subRangeIterator.detach(!0),iteratorState.stop)return}else for(it=dom.createIterator(node);n=it.next();)if(func(n)===!1)return void(iteratorState.stop=!0)}function deleteSubtree(iterator){for(var subIterator;iterator.next();)if(iterator.isPartiallySelectedSubtree())subIterator=iterator.getSubtreeIterator(),deleteSubtree(subIterator),subIterator.detach(!0);else iterator.remove()}function extractSubtree(iterator){for(var node,frag=getRangeDocument(iterator.range).createDocumentFragment(),subIterator;node=iterator.next();){if(iterator.isPartiallySelectedSubtree())node=node.cloneNode(!1),subIterator=iterator.getSubtreeIterator(),node.appendChild(extractSubtree(subIterator)),subIterator.detach(!0);else iterator.remove();if(10==node.nodeType)throw new DOMException("HIERARCHY_REQUEST_ERR");frag.appendChild(node)}return frag}function getNodesInRange(range,nodeTypes,filter){var filterNodeTypes=!(!nodeTypes||!nodeTypes.length),regex,filterExists=!!filter;if(filterNodeTypes)regex=new RegExp("^("+nodeTypes.join("|")+")$");var nodes=[];return iterateSubtree(new RangeIterator(range,!1),function(node){if(!(filterNodeTypes&&!regex.test(node.nodeType)||filterExists&&!filter(node)))nodes.push(node)}),nodes}function inspect(range){var name="undefined"==typeof range.getName?"Range":range.getName();return"["+name+"("+dom.inspectNode(range.startContainer)+":"+range.startOffset+", "+dom.inspectNode(range.endContainer)+":"+range.endOffset+")]"}function RangeIterator(range,clonePartiallySelectedTextNodes){if(this.range=range,this.clonePartiallySelectedTextNodes=clonePartiallySelectedTextNodes,!range.collapsed){this.sc=range.startContainer,this.so=range.startOffset,this.ec=range.endContainer,this.eo=range.endOffset;var root=range.commonAncestorContainer;if(this.sc===this.ec&&dom.isCharacterDataNode(this.sc))this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc;else this._first=this._next=this.sc===root&&!dom.isCharacterDataNode(this.sc)?this.sc.childNodes[this.so]:dom.getClosestAncestorIn(this.sc,root,!0),this._last=this.ec===root&&!dom.isCharacterDataNode(this.ec)?this.ec.childNodes[this.eo-1]:dom.getClosestAncestorIn(this.ec,root,!0)}}function RangeException(codeName){this.code=this[codeName],this.codeName=codeName,this.message="RangeException: "+this.codeName}function RangeNodeIterator(range,nodeTypes,filter){this.nodes=getNodesInRange(range,nodeTypes,filter),this._next=this.nodes[0],this._position=0}function createAncestorFinder(nodeTypes){return function(node,selfIsAncestor){for(var t,n=selfIsAncestor?node:node.parentNode;n;){if(t=n.nodeType,dom.arrayContains(nodeTypes,t))return n;n=n.parentNode}return null}}function assertNoDocTypeNotationEntityAncestor(node,allowSelf){if(getDocTypeNotationEntityAncestor(node,allowSelf))throw new RangeException("INVALID_NODE_TYPE_ERR")}function assertNotDetached(range){if(!range.startContainer)throw new DOMException("INVALID_STATE_ERR")}function assertValidNodeType(node,invalidTypes){if(!dom.arrayContains(invalidTypes,node.nodeType))throw new RangeException("INVALID_NODE_TYPE_ERR")}function assertValidOffset(node,offset){if(0>offset||offset>(dom.isCharacterDataNode(node)?node.length:node.childNodes.length))throw new DOMException("INDEX_SIZE_ERR")}function assertSameDocumentOrFragment(node1,node2){if(getDocumentOrFragmentContainer(node1,!0)!==getDocumentOrFragmentContainer(node2,!0))throw new DOMException("WRONG_DOCUMENT_ERR")}function assertNodeNotReadOnly(node){if(getReadonlyAncestor(node,!0))throw new DOMException("NO_MODIFICATION_ALLOWED_ERR")}function assertNode(node,codeName){if(!node)throw new DOMException(codeName)}function isOrphan(node){return!dom.arrayContains(rootContainerNodeTypes,node.nodeType)&&!getDocumentOrFragmentContainer(node,!0)}function isValidOffset(node,offset){return offset<=(dom.isCharacterDataNode(node)?node.length:node.childNodes.length)}function assertRangeValid(range){if(assertNotDetached(range),isOrphan(range.startContainer)||isOrphan(range.endContainer)||!isValidOffset(range.startContainer,range.startOffset)||!isValidOffset(range.endContainer,range.endOffset))throw new Error("Range error: Range is no longer valid after DOM mutation ("+range.inspect()+")")}function RangePrototype(){}function copyComparisonConstantsToObject(obj){obj.START_TO_START=s2s,obj.START_TO_END=s2e,obj.END_TO_END=e2e,obj.END_TO_START=e2s,obj.NODE_BEFORE=n_b,obj.NODE_AFTER=n_a,obj.NODE_BEFORE_AND_AFTER=n_b_a,obj.NODE_INSIDE=n_i}function copyComparisonConstants(constructor){copyComparisonConstantsToObject(constructor),copyComparisonConstantsToObject(constructor.prototype)}function createRangeContentRemover(remover,boundaryUpdater){return function(){assertRangeValid(this);var sc=this.startContainer,so=this.startOffset,root=this.commonAncestorContainer,iterator=new RangeIterator(this,!0),node,boundary;if(sc!==root)node=dom.getClosestAncestorIn(sc,root,!0),boundary=getBoundaryAfterNode(node),sc=boundary.node,so=boundary.offset;iterateSubtree(iterator,assertNodeNotReadOnly),iterator.reset();var returnValue=remover(iterator);return iterator.detach(),boundaryUpdater(this,sc,so,sc,so),returnValue}}function createPrototypeRange(constructor,boundaryUpdater,detacher){function createBeforeAfterNodeSetter(isBefore,isStart){return function(node){assertNotDetached(this),assertValidNodeType(node,beforeAfterNodeTypes),assertValidNodeType(getRootContainer(node),rootContainerNodeTypes);var boundary=(isBefore?getBoundaryBeforeNode:getBoundaryAfterNode)(node);(isStart?setRangeStart:setRangeEnd)(this,boundary.node,boundary.offset)}}function setRangeStart(range,node,offset){var ec=range.endContainer,eo=range.endOffset;if(node!==range.startContainer||offset!==range.startOffset){if(getRootContainer(node)!=getRootContainer(ec)||1==dom.comparePoints(node,offset,ec,eo))ec=node,eo=offset;boundaryUpdater(range,node,offset,ec,eo)}}function setRangeEnd(range,node,offset){var sc=range.startContainer,so=range.startOffset;if(node!==range.endContainer||offset!==range.endOffset){if(getRootContainer(node)!=getRootContainer(sc)||-1==dom.comparePoints(node,offset,sc,so))sc=node,so=offset;boundaryUpdater(range,sc,so,node,offset)}}function setRangeStartAndEnd(range,node,offset){if(node!==range.startContainer||offset!==range.startOffset||node!==range.endContainer||offset!==range.endOffset)boundaryUpdater(range,node,offset,node,offset)}constructor.prototype=new RangePrototype,api.util.extend(constructor.prototype,{setStart:function(node,offset){assertNotDetached(this),assertNoDocTypeNotationEntityAncestor(node,!0),assertValidOffset(node,offset),setRangeStart(this,node,offset)},setEnd:function(node,offset){assertNotDetached(this),assertNoDocTypeNotationEntityAncestor(node,!0),assertValidOffset(node,offset),setRangeEnd(this,node,offset)},setStartBefore:createBeforeAfterNodeSetter(!0,!0),setStartAfter:createBeforeAfterNodeSetter(!1,!0),setEndBefore:createBeforeAfterNodeSetter(!0,!1),setEndAfter:createBeforeAfterNodeSetter(!1,!1),collapse:function(isStart){if(assertRangeValid(this),isStart)boundaryUpdater(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset);else boundaryUpdater(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(node){assertNotDetached(this),assertNoDocTypeNotationEntityAncestor(node,!0),boundaryUpdater(this,node,0,node,dom.getNodeLength(node))},selectNode:function(node){assertNotDetached(this),assertNoDocTypeNotationEntityAncestor(node,!1),assertValidNodeType(node,beforeAfterNodeTypes);var start=getBoundaryBeforeNode(node),end=getBoundaryAfterNode(node);boundaryUpdater(this,start.node,start.offset,end.node,end.offset)},extractContents:createRangeContentRemover(extractSubtree,boundaryUpdater),deleteContents:createRangeContentRemover(deleteSubtree,boundaryUpdater),canSurroundContents:function(){assertRangeValid(this),assertNodeNotReadOnly(this.startContainer),assertNodeNotReadOnly(this.endContainer);var iterator=new RangeIterator(this,!0),boundariesInvalid=iterator._first&&isNonTextPartiallySelected(iterator._first,this)||iterator._last&&isNonTextPartiallySelected(iterator._last,this);return iterator.detach(),!boundariesInvalid},detach:function(){detacher(this)},splitBoundaries:function(){assertRangeValid(this);var sc=this.startContainer,so=this.startOffset,ec=this.endContainer,eo=this.endOffset,startEndSame=sc===ec;if(dom.isCharacterDataNode(ec)&&eo>0&&eo<ec.length)dom.splitDataNode(ec,eo);if(dom.isCharacterDataNode(sc)&&so>0&&so<sc.length){if(sc=dom.splitDataNode(sc,so),startEndSame)eo-=so,ec=sc;else if(ec==sc.parentNode&&eo>=dom.getNodeIndex(sc))eo++;so=0}boundaryUpdater(this,sc,so,ec,eo)},normalizeBoundaries:function(){assertRangeValid(this);var sc=this.startContainer,so=this.startOffset,ec=this.endContainer,eo=this.endOffset,mergeForward=function(node){var sibling=node.nextSibling;if(sibling&&sibling.nodeType==node.nodeType)ec=node,eo=node.length,node.appendData(sibling.data),sibling.parentNode.removeChild(sibling)},mergeBackward=function(node){var sibling=node.previousSibling;if(sibling&&sibling.nodeType==node.nodeType){sc=node;var nodeLength=node.length;if(so=sibling.length,node.insertData(0,sibling.data),sibling.parentNode.removeChild(sibling),sc==ec)eo+=so,ec=sc;else if(ec==node.parentNode){var nodeIndex=dom.getNodeIndex(node);if(eo==nodeIndex)ec=node,eo=nodeLength;else if(eo>nodeIndex)eo--}}},normalizeStart=!0;if(dom.isCharacterDataNode(ec)){if(ec.length==eo)mergeForward(ec)}else{if(eo>0){var endNode=ec.childNodes[eo-1];if(endNode&&dom.isCharacterDataNode(endNode))mergeForward(endNode)}normalizeStart=!this.collapsed}if(normalizeStart){if(dom.isCharacterDataNode(sc)){if(0===so)mergeBackward(sc)}else if(so<sc.childNodes.length){var startNode=sc.childNodes[so];if(startNode&&dom.isCharacterDataNode(startNode))mergeBackward(startNode)}}else sc=ec,so=eo;boundaryUpdater(this,sc,so,ec,eo)},collapseToPoint:function(node,offset){assertNotDetached(this),assertNoDocTypeNotationEntityAncestor(node,!0),assertValidOffset(node,offset),setRangeStartAndEnd(this,node,offset)}}),copyComparisonConstants(constructor)}function updateCollapsedAndCommonAncestor(range){range.collapsed=range.startContainer===range.endContainer&&range.startOffset===range.endOffset,range.commonAncestorContainer=range.collapsed?range.startContainer:dom.getCommonAncestor(range.startContainer,range.endContainer)}function updateBoundaries(range,startContainer,startOffset,endContainer,endOffset){var startMoved=range.startContainer!==startContainer||range.startOffset!==startOffset,endMoved=range.endContainer!==endContainer||range.endOffset!==endOffset;range.startContainer=startContainer,range.startOffset=startOffset,range.endContainer=endContainer,range.endOffset=endOffset,updateCollapsedAndCommonAncestor(range),dispatchEvent(range,"boundarychange",{startMoved:startMoved,endMoved:endMoved})}function detach(range){assertNotDetached(range),range.startContainer=range.startOffset=range.endContainer=range.endOffset=null,range.collapsed=range.commonAncestorContainer=null,dispatchEvent(range,"detach",null),range._listeners=null}function Range(doc){this.startContainer=doc,this.startOffset=0,this.endContainer=doc,this.endOffset=0,this._listeners={boundarychange:[],detach:[]},updateCollapsedAndCommonAncestor(this)}api.requireModules(["DomUtil"]);var dom=api.dom,DomPosition=dom.DomPosition,DOMException=api.DOMException;RangeIterator.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=null,this._next=this._first},hasNext:function(){return!!this._next},next:function(){var current=this._current=this._next;if(current)if(this._next=current!==this._last?current.nextSibling:null,dom.isCharacterDataNode(current)&&this.clonePartiallySelectedTextNodes){if(current===this.ec)(current=current.cloneNode(!0)).deleteData(this.eo,current.length-this.eo);if(this._current===this.sc)(current=current.cloneNode(!0)).deleteData(0,this.so)}return current},remove:function(){var current=this._current,start,end;if(dom.isCharacterDataNode(current)&&(current===this.sc||current===this.ec)){if(start=current===this.sc?this.so:0,end=current===this.ec?this.eo:current.length,start!=end)current.deleteData(start,end-start)}else if(current.parentNode)current.parentNode.removeChild(current);else;},isPartiallySelectedSubtree:function(){var current=this._current;return isNonTextPartiallySelected(current,this.range)},getSubtreeIterator:function(){var subRange;if(this.isSingleCharacterDataNode)subRange=this.range.cloneRange(),subRange.collapse();else{subRange=new Range(getRangeDocument(this.range));var current=this._current,startContainer=current,startOffset=0,endContainer=current,endOffset=dom.getNodeLength(current);if(dom.isAncestorOf(current,this.sc,!0))startContainer=this.sc,startOffset=this.so;if(dom.isAncestorOf(current,this.ec,!0))endContainer=this.ec,endOffset=this.eo;updateBoundaries(subRange,startContainer,startOffset,endContainer,endOffset)}return new RangeIterator(subRange,this.clonePartiallySelectedTextNodes)},detach:function(detachRange){if(detachRange)this.range.detach();this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}},RangeException.prototype={BAD_BOUNDARYPOINTS_ERR:1,INVALID_NODE_TYPE_ERR:2},RangeException.prototype.toString=function(){return this.message},RangeNodeIterator.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){return this._current=this._next,this._next=this.nodes[++this._position],this._current},detach:function(){this._current=this._next=this.nodes=null}};var beforeAfterNodeTypes=[1,3,4,5,7,8,10],rootContainerNodeTypes=[2,9,11],readonlyNodeTypes=[5,6,10,12],insertableNodeTypes=[1,3,4,5,7,8,10,11],surroundNodeTypes=[1,3,4,5,7,8],getRootContainer=dom.getRootContainer,getDocumentOrFragmentContainer=createAncestorFinder([9,11]),getReadonlyAncestor=createAncestorFinder(readonlyNodeTypes),getDocTypeNotationEntityAncestor=createAncestorFinder([6,10,12]),styleEl=document.createElement("style"),htmlParsingConforms=!1;try{styleEl.innerHTML="<b>x</b>",htmlParsingConforms=3==styleEl.firstChild.nodeType}catch(e){}api.features.htmlParsingConforms=htmlParsingConforms;var createContextualFragment=htmlParsingConforms?function(fragmentStr){var node=this.startContainer,doc=dom.getDocument(node);if(!node)throw new DOMException("INVALID_STATE_ERR");var el=null;if(1==node.nodeType)el=node;else if(dom.isCharacterDataNode(node))el=dom.parentElement(node);if(null===el||"HTML"==el.nodeName&&dom.isHtmlNamespace(dom.getDocument(el).documentElement)&&dom.isHtmlNamespace(el))el=doc.createElement("body");else el=el.cloneNode(!1);return el.innerHTML=fragmentStr,dom.fragmentFromNodeChildren(el)}:function(fragmentStr){assertNotDetached(this);var doc=getRangeDocument(this),el=doc.createElement("body");return el.innerHTML=fragmentStr,dom.fragmentFromNodeChildren(el)},rangeProperties=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],s2s=0,s2e=1,e2e=2,e2s=3,n_b=0,n_a=1,n_b_a=2,n_i=3;RangePrototype.prototype={attachListener:function(type,listener){this._listeners[type].push(listener)},compareBoundaryPoints:function(how,range){assertRangeValid(this),assertSameDocumentOrFragment(this.startContainer,range.startContainer);var nodeA,offsetA,nodeB,offsetB,prefixA=how==e2s||how==s2s?"start":"end",prefixB=how==s2e||how==s2s?"start":"end";return nodeA=this[prefixA+"Container"],offsetA=this[prefixA+"Offset"],nodeB=range[prefixB+"Container"],offsetB=range[prefixB+"Offset"],dom.comparePoints(nodeA,offsetA,nodeB,offsetB)},insertNode:function(node){if(assertRangeValid(this),assertValidNodeType(node,insertableNodeTypes),assertNodeNotReadOnly(this.startContainer),dom.isAncestorOf(node,this.startContainer,!0))throw new DOMException("HIERARCHY_REQUEST_ERR");var firstNodeInserted=insertNodeAtPosition(node,this.startContainer,this.startOffset);this.setStartBefore(firstNodeInserted)},cloneContents:function(){assertRangeValid(this);var clone,frag;if(this.collapsed)return getRangeDocument(this).createDocumentFragment();else{if(this.startContainer===this.endContainer&&dom.isCharacterDataNode(this.startContainer))return clone=this.startContainer.cloneNode(!0),clone.data=clone.data.slice(this.startOffset,this.endOffset),frag=getRangeDocument(this).createDocumentFragment(),frag.appendChild(clone),frag;else{var iterator=new RangeIterator(this,!0);clone=cloneSubtree(iterator),iterator.detach()}return clone}},canSurroundContents:function(){assertRangeValid(this),assertNodeNotReadOnly(this.startContainer),assertNodeNotReadOnly(this.endContainer);var iterator=new RangeIterator(this,!0),boundariesInvalid=iterator._first&&isNonTextPartiallySelected(iterator._first,this)||iterator._last&&isNonTextPartiallySelected(iterator._last,this);return iterator.detach(),!boundariesInvalid},surroundContents:function(node){if(assertValidNodeType(node,surroundNodeTypes),!this.canSurroundContents())throw new RangeException("BAD_BOUNDARYPOINTS_ERR");var content=this.extractContents();if(node.hasChildNodes())for(;node.lastChild;)node.removeChild(node.lastChild);insertNodeAtPosition(node,this.startContainer,this.startOffset),node.appendChild(content),this.selectNode(node)},cloneRange:function(){assertRangeValid(this);for(var range=new Range(getRangeDocument(this)),i=rangeProperties.length,prop;i--;)prop=rangeProperties[i],range[prop]=this[prop];return range},toString:function(){assertRangeValid(this);var sc=this.startContainer;if(sc===this.endContainer&&dom.isCharacterDataNode(sc))return 3==sc.nodeType||4==sc.nodeType?sc.data.slice(this.startOffset,this.endOffset):"";else{var textBits=[],iterator=new RangeIterator(this,!0);return iterateSubtree(iterator,function(node){if(3==node.nodeType||4==node.nodeType)textBits.push(node.data)}),iterator.detach(),textBits.join("")}},compareNode:function(node){assertRangeValid(this);var parent=node.parentNode,nodeIndex=dom.getNodeIndex(node);if(!parent)throw new DOMException("NOT_FOUND_ERR");var startComparison=this.comparePoint(parent,nodeIndex),endComparison=this.comparePoint(parent,nodeIndex+1);if(0>startComparison)return endComparison>0?n_b_a:n_b;else return endComparison>0?n_a:n_i},comparePoint:function(node,offset){if(assertRangeValid(this),assertNode(node,"HIERARCHY_REQUEST_ERR"),assertSameDocumentOrFragment(node,this.startContainer),dom.comparePoints(node,offset,this.startContainer,this.startOffset)<0)return-1;else if(dom.comparePoints(node,offset,this.endContainer,this.endOffset)>0)return 1;return 0},createContextualFragment:createContextualFragment,toHtml:function(){assertRangeValid(this);var container=getRangeDocument(this).createElement("div");return container.appendChild(this.cloneContents()),container.innerHTML},intersectsNode:function(node,touchingIsIntersecting){if(assertRangeValid(this),assertNode(node,"NOT_FOUND_ERR"),dom.getDocument(node)!==getRangeDocument(this))return!1;var parent=node.parentNode,offset=dom.getNodeIndex(node);assertNode(parent,"NOT_FOUND_ERR");var startComparison=dom.comparePoints(parent,offset,this.endContainer,this.endOffset),endComparison=dom.comparePoints(parent,offset+1,this.startContainer,this.startOffset);return touchingIsIntersecting?0>=startComparison&&endComparison>=0:0>startComparison&&endComparison>0},isPointInRange:function(node,offset){return assertRangeValid(this),assertNode(node,"HIERARCHY_REQUEST_ERR"),assertSameDocumentOrFragment(node,this.startContainer),dom.comparePoints(node,offset,this.startContainer,this.startOffset)>=0&&dom.comparePoints(node,offset,this.endContainer,this.endOffset)<=0},intersectsRange:function(range,touchingIsIntersecting){if(assertRangeValid(this),getRangeDocument(range)!=getRangeDocument(this))throw new DOMException("WRONG_DOCUMENT_ERR");var startComparison=dom.comparePoints(this.startContainer,this.startOffset,range.endContainer,range.endOffset),endComparison=dom.comparePoints(this.endContainer,this.endOffset,range.startContainer,range.startOffset);return touchingIsIntersecting?0>=startComparison&&endComparison>=0:0>startComparison&&endComparison>0},intersection:function(range){if(this.intersectsRange(range)){var startComparison=dom.comparePoints(this.startContainer,this.startOffset,range.startContainer,range.startOffset),endComparison=dom.comparePoints(this.endContainer,this.endOffset,range.endContainer,range.endOffset),intersectionRange=this.cloneRange();if(-1==startComparison)intersectionRange.setStart(range.startContainer,range.startOffset);if(1==endComparison)intersectionRange.setEnd(range.endContainer,range.endOffset);return intersectionRange}return null},union:function(range){if(this.intersectsRange(range,!0)){var unionRange=this.cloneRange();if(-1==dom.comparePoints(range.startContainer,range.startOffset,this.startContainer,this.startOffset))unionRange.setStart(range.startContainer,range.startOffset);if(1==dom.comparePoints(range.endContainer,range.endOffset,this.endContainer,this.endOffset))unionRange.setEnd(range.endContainer,range.endOffset);return unionRange}else throw new RangeException("Ranges do not intersect")},containsNode:function(node,allowPartial){if(allowPartial)return this.intersectsNode(node,!1);else return this.compareNode(node)==n_i},containsNodeContents:function(node){return this.comparePoint(node,0)>=0&&this.comparePoint(node,dom.getNodeLength(node))<=0},containsRange:function(range){return this.intersection(range).equals(range)},containsNodeText:function(node){var nodeRange=this.cloneRange();nodeRange.selectNode(node);var textNodes=nodeRange.getNodes([3]);
if(textNodes.length>0){nodeRange.setStart(textNodes[0],0);var lastTextNode=textNodes.pop();nodeRange.setEnd(lastTextNode,lastTextNode.length);var contains=this.containsRange(nodeRange);return nodeRange.detach(),contains}else return this.containsNodeContents(node)},createNodeIterator:function(nodeTypes,filter){return assertRangeValid(this),new RangeNodeIterator(this,nodeTypes,filter)},getNodes:function(nodeTypes,filter){return assertRangeValid(this),getNodesInRange(this,nodeTypes,filter)},getDocument:function(){return getRangeDocument(this)},collapseBefore:function(node){assertNotDetached(this),this.setEndBefore(node),this.collapse(!1)},collapseAfter:function(node){assertNotDetached(this),this.setStartAfter(node),this.collapse(!0)},getName:function(){return"DomRange"},equals:function(range){return Range.rangesEqual(this,range)},inspect:function(){return inspect(this)}},createPrototypeRange(Range,updateBoundaries,detach),api.rangePrototype=RangePrototype.prototype,Range.rangeProperties=rangeProperties,Range.RangeIterator=RangeIterator,Range.copyComparisonConstants=copyComparisonConstants,Range.createPrototypeRange=createPrototypeRange,Range.inspect=inspect,Range.getRangeDocument=getRangeDocument,Range.rangesEqual=function(r1,r2){return r1.startContainer===r2.startContainer&&r1.startOffset===r2.startOffset&&r1.endContainer===r2.endContainer&&r1.endOffset===r2.endOffset},api.DomRange=Range,api.RangeException=RangeException}),rangy.createModule("WrappedRange",function(api,module){function getTextRangeContainerElement(textRange){var parentEl=textRange.parentElement(),range=textRange.duplicate();range.collapse(!0);var startEl=range.parentElement();range=textRange.duplicate(),range.collapse(!1);var endEl=range.parentElement(),startEndContainer=startEl==endEl?startEl:dom.getCommonAncestor(startEl,endEl);return startEndContainer==parentEl?startEndContainer:dom.getCommonAncestor(parentEl,startEndContainer)}function textRangeIsCollapsed(textRange){return 0===textRange.compareEndPoints("StartToEnd",textRange)}function getTextRangeBoundaryPosition(textRange,wholeRangeContainerElement,isStart,isCollapsed){var workingRange=textRange.duplicate();workingRange.collapse(isStart);var containerElement=workingRange.parentElement();if(!dom.isAncestorOf(wholeRangeContainerElement,containerElement,!0))containerElement=wholeRangeContainerElement;if(!containerElement.canHaveHTML)return new DomPosition(containerElement.parentNode,dom.getNodeIndex(containerElement));var workingNode=dom.getDocument(containerElement).createElement("span"),comparison,workingComparisonType=isStart?"StartToStart":"StartToEnd",previousNode,nextNode,boundaryPosition,boundaryNode;do containerElement.insertBefore(workingNode,workingNode.previousSibling),workingRange.moveToElementText(workingNode);while((comparison=workingRange.compareEndPoints(workingComparisonType,textRange))>0&&workingNode.previousSibling);if(boundaryNode=workingNode.nextSibling,-1==comparison&&boundaryNode&&dom.isCharacterDataNode(boundaryNode)){workingRange.setEndPoint(isStart?"EndToStart":"EndToEnd",textRange);var offset;if(/[\r\n]/.test(boundaryNode.data)){var tempRange=workingRange.duplicate(),rangeLength=tempRange.text.replace(/\r\n/g,"\r").length;for(offset=tempRange.moveStart("character",rangeLength);-1==(comparison=tempRange.compareEndPoints("StartToEnd",tempRange));)offset++,tempRange.moveStart("character",1)}else offset=workingRange.text.length;boundaryPosition=new DomPosition(boundaryNode,offset)}else if(previousNode=(isCollapsed||!isStart)&&workingNode.previousSibling,nextNode=(isCollapsed||isStart)&&workingNode.nextSibling,nextNode&&dom.isCharacterDataNode(nextNode))boundaryPosition=new DomPosition(nextNode,0);else if(previousNode&&dom.isCharacterDataNode(previousNode))boundaryPosition=new DomPosition(previousNode,previousNode.length);else boundaryPosition=new DomPosition(containerElement,dom.getNodeIndex(workingNode));return workingNode.parentNode.removeChild(workingNode),boundaryPosition}function createBoundaryTextRange(boundaryPosition,isStart){var boundaryNode,boundaryParent,boundaryOffset=boundaryPosition.offset,doc=dom.getDocument(boundaryPosition.node),workingNode,childNodes,workingRange=doc.body.createTextRange(),nodeIsDataNode=dom.isCharacterDataNode(boundaryPosition.node);if(nodeIsDataNode)boundaryNode=boundaryPosition.node,boundaryParent=boundaryNode.parentNode;else childNodes=boundaryPosition.node.childNodes,boundaryNode=boundaryOffset<childNodes.length?childNodes[boundaryOffset]:null,boundaryParent=boundaryPosition.node;if(workingNode=doc.createElement("span"),workingNode.innerHTML="&#feff;",boundaryNode)boundaryParent.insertBefore(workingNode,boundaryNode);else boundaryParent.appendChild(workingNode);if(workingRange.moveToElementText(workingNode),workingRange.collapse(!isStart),boundaryParent.removeChild(workingNode),nodeIsDataNode)workingRange[isStart?"moveStart":"moveEnd"]("character",boundaryOffset);return workingRange}api.requireModules(["DomUtil","DomRange"]);var WrappedRange,dom=api.dom,DomPosition=dom.DomPosition,DomRange=api.DomRange;if(api.features.implementsDomRange&&(!api.features.implementsTextRange||!api.config.preferTextRange))!function(){function updateRangeProperties(range){for(var i=rangeProperties.length,prop;i--;)prop=rangeProperties[i],range[prop]=range.nativeRange[prop]}function updateNativeRange(range,startContainer,startOffset,endContainer,endOffset){var startMoved=range.startContainer!==startContainer||range.startOffset!=startOffset,endMoved=range.endContainer!==endContainer||range.endOffset!=endOffset;if(startMoved||endMoved)range.setEnd(endContainer,endOffset),range.setStart(startContainer,startOffset)}function detach(range){range.nativeRange.detach(),range.detached=!0;for(var i=rangeProperties.length,prop;i--;)prop=rangeProperties[i],range[prop]=null}var rangeProto,rangeProperties=DomRange.rangeProperties,canSetRangeStartAfterEnd,createBeforeAfterNodeSetter;WrappedRange=function(range){if(!range)throw new Error("Range must be specified");this.nativeRange=range,updateRangeProperties(this)},DomRange.createPrototypeRange(WrappedRange,updateNativeRange,detach),rangeProto=WrappedRange.prototype,rangeProto.selectNode=function(node){this.nativeRange.selectNode(node),updateRangeProperties(this)},rangeProto.deleteContents=function(){this.nativeRange.deleteContents(),updateRangeProperties(this)},rangeProto.extractContents=function(){var frag=this.nativeRange.extractContents();return updateRangeProperties(this),frag},rangeProto.cloneContents=function(){return this.nativeRange.cloneContents()},rangeProto.surroundContents=function(node){this.nativeRange.surroundContents(node),updateRangeProperties(this)},rangeProto.collapse=function(isStart){this.nativeRange.collapse(isStart),updateRangeProperties(this)},rangeProto.cloneRange=function(){return new WrappedRange(this.nativeRange.cloneRange())},rangeProto.refresh=function(){updateRangeProperties(this)},rangeProto.toString=function(){return this.nativeRange.toString()};var testTextNode=document.createTextNode("test");dom.getBody(document).appendChild(testTextNode);var range=document.createRange();range.setStart(testTextNode,0),range.setEnd(testTextNode,0);try{range.setStart(testTextNode,1),canSetRangeStartAfterEnd=!0,rangeProto.setStart=function(node,offset){this.nativeRange.setStart(node,offset),updateRangeProperties(this)},rangeProto.setEnd=function(node,offset){this.nativeRange.setEnd(node,offset),updateRangeProperties(this)},createBeforeAfterNodeSetter=function(name){return function(node){this.nativeRange[name](node),updateRangeProperties(this)}}}catch(ex){canSetRangeStartAfterEnd=!1,rangeProto.setStart=function(node,offset){try{this.nativeRange.setStart(node,offset)}catch(ex){this.nativeRange.setEnd(node,offset),this.nativeRange.setStart(node,offset)}updateRangeProperties(this)},rangeProto.setEnd=function(node,offset){try{this.nativeRange.setEnd(node,offset)}catch(ex){this.nativeRange.setStart(node,offset),this.nativeRange.setEnd(node,offset)}updateRangeProperties(this)},createBeforeAfterNodeSetter=function(name,oppositeName){return function(node){try{this.nativeRange[name](node)}catch(ex){this.nativeRange[oppositeName](node),this.nativeRange[name](node)}updateRangeProperties(this)}}}if(rangeProto.setStartBefore=createBeforeAfterNodeSetter("setStartBefore","setEndBefore"),rangeProto.setStartAfter=createBeforeAfterNodeSetter("setStartAfter","setEndAfter"),rangeProto.setEndBefore=createBeforeAfterNodeSetter("setEndBefore","setStartBefore"),rangeProto.setEndAfter=createBeforeAfterNodeSetter("setEndAfter","setStartAfter"),range.selectNodeContents(testTextNode),range.startContainer==testTextNode&&range.endContainer==testTextNode&&0===range.startOffset&&range.endOffset==testTextNode.length)rangeProto.selectNodeContents=function(node){this.nativeRange.selectNodeContents(node),updateRangeProperties(this)};else rangeProto.selectNodeContents=function(node){this.setStart(node,0),this.setEnd(node,DomRange.getEndOffset(node))};range.selectNodeContents(testTextNode),range.setEnd(testTextNode,3);var range2=document.createRange();if(range2.selectNodeContents(testTextNode),range2.setEnd(testTextNode,4),range2.setStart(testTextNode,2),-1==range.compareBoundaryPoints(range.START_TO_END,range2)&1==range.compareBoundaryPoints(range.END_TO_START,range2))rangeProto.compareBoundaryPoints=function(type,range){if(range=range.nativeRange||range,type==range.START_TO_END)type=range.END_TO_START;else if(type==range.END_TO_START)type=range.START_TO_END;return this.nativeRange.compareBoundaryPoints(type,range)};else rangeProto.compareBoundaryPoints=function(type,range){return this.nativeRange.compareBoundaryPoints(type,range.nativeRange||range)};if(api.util.isHostMethod(range,"createContextualFragment"))rangeProto.createContextualFragment=function(fragmentStr){return this.nativeRange.createContextualFragment(fragmentStr)};dom.getBody(document).removeChild(testTextNode),range.detach(),range2.detach()}(),api.createNativeRange=function(doc){return doc=doc||document,doc.createRange()};else if(api.features.implementsTextRange){WrappedRange=function(textRange){this.textRange=textRange,this.refresh()},WrappedRange.prototype=new DomRange(document),WrappedRange.prototype.refresh=function(){var start,end,rangeContainerElement=getTextRangeContainerElement(this.textRange);if(textRangeIsCollapsed(this.textRange))end=start=getTextRangeBoundaryPosition(this.textRange,rangeContainerElement,!0,!0);else start=getTextRangeBoundaryPosition(this.textRange,rangeContainerElement,!0,!1),end=getTextRangeBoundaryPosition(this.textRange,rangeContainerElement,!1,!1);this.setStart(start.node,start.offset),this.setEnd(end.node,end.offset)},DomRange.copyComparisonConstants(WrappedRange);var globalObj=function(){return this}();if("undefined"==typeof globalObj.Range)globalObj.Range=WrappedRange;api.createNativeRange=function(doc){return doc=doc||document,doc.body.createTextRange()}}if(api.features.implementsTextRange)WrappedRange.rangeToTextRange=function(range){if(range.collapsed){var tr=createBoundaryTextRange(new DomPosition(range.startContainer,range.startOffset),!0);return tr}else{var startRange=createBoundaryTextRange(new DomPosition(range.startContainer,range.startOffset),!0),endRange=createBoundaryTextRange(new DomPosition(range.endContainer,range.endOffset),!1),textRange=dom.getDocument(range.startContainer).body.createTextRange();return textRange.setEndPoint("StartToStart",startRange),textRange.setEndPoint("EndToEnd",endRange),textRange}};WrappedRange.prototype.getName=function(){return"WrappedRange"},api.WrappedRange=WrappedRange,api.createRange=function(doc){return doc=doc||document,new WrappedRange(api.createNativeRange(doc))},api.createRangyRange=function(doc){return doc=doc||document,new DomRange(doc)},api.createIframeRange=function(iframeEl){return api.createRange(dom.getIframeDocument(iframeEl))},api.createIframeRangyRange=function(iframeEl){return api.createRangyRange(dom.getIframeDocument(iframeEl))},api.addCreateMissingNativeApiListener(function(win){var doc=win.document;if("undefined"==typeof doc.createRange)doc.createRange=function(){return api.createRange(this)};doc=win=null})}),rangy.createModule("WrappedSelection",function(api,module){function getWinSelection(winParam){return(winParam||global).getSelection()}function getDocSelection(winParam){return(winParam||global).document.selection}function updateAnchorAndFocusFromRange(sel,range,backwards){var anchorPrefix=backwards?"end":"start",focusPrefix=backwards?"start":"end";sel.anchorNode=range[anchorPrefix+"Container"],sel.anchorOffset=range[anchorPrefix+"Offset"],sel.focusNode=range[focusPrefix+"Container"],sel.focusOffset=range[focusPrefix+"Offset"]}function updateAnchorAndFocusFromNativeSelection(sel){var nativeSel=sel.nativeSelection;sel.anchorNode=nativeSel.anchorNode,sel.anchorOffset=nativeSel.anchorOffset,sel.focusNode=nativeSel.focusNode,sel.focusOffset=nativeSel.focusOffset}function updateEmptySelection(sel){sel.anchorNode=sel.focusNode=null,sel.anchorOffset=sel.focusOffset=0,sel.rangeCount=0,sel.isCollapsed=!0,sel._ranges.length=0}function getNativeRange(range){var nativeRange;if(range instanceof DomRange){if(nativeRange=range._selectionNativeRange,!nativeRange)nativeRange=api.createNativeRange(dom.getDocument(range.startContainer)),nativeRange.setEnd(range.endContainer,range.endOffset),nativeRange.setStart(range.startContainer,range.startOffset),range._selectionNativeRange=nativeRange,range.attachListener("detach",function(){this._selectionNativeRange=null})}else if(range instanceof WrappedRange)nativeRange=range.nativeRange;else if(api.features.implementsDomRange&&range instanceof dom.getWindow(range.startContainer).Range)nativeRange=range;return nativeRange}function rangeContainsSingleElement(rangeNodes){if(!rangeNodes.length||1!=rangeNodes[0].nodeType)return!1;for(var i=1,len=rangeNodes.length;len>i;++i)if(!dom.isAncestorOf(rangeNodes[0],rangeNodes[i]))return!1;return!0}function getSingleElementFromRange(range){var nodes=range.getNodes();if(!rangeContainsSingleElement(nodes))throw new Error("getSingleElementFromRange: range "+range.inspect()+" did not consist of a single element");return nodes[0]}function isTextRange(range){return!!range&&"undefined"!=typeof range.text}function updateFromTextRange(sel,range){var wrappedRange=new WrappedRange(range);sel._ranges=[wrappedRange],updateAnchorAndFocusFromRange(sel,wrappedRange,!1),sel.rangeCount=1,sel.isCollapsed=wrappedRange.collapsed}function updateControlSelection(sel){if(sel._ranges.length=0,"None"==sel.docSelection.type)updateEmptySelection(sel);else{var controlRange=sel.docSelection.createRange();if(isTextRange(controlRange))updateFromTextRange(sel,controlRange);else{sel.rangeCount=controlRange.length;for(var range,doc=dom.getDocument(controlRange.item(0)),i=0;i<sel.rangeCount;++i)range=api.createRange(doc),range.selectNode(controlRange.item(i)),sel._ranges.push(range);sel.isCollapsed=1==sel.rangeCount&&sel._ranges[0].collapsed,updateAnchorAndFocusFromRange(sel,sel._ranges[sel.rangeCount-1],!1)}}}function addRangeToControlSelection(sel,range){for(var controlRange=sel.docSelection.createRange(),rangeElement=getSingleElementFromRange(range),doc=dom.getDocument(controlRange.item(0)),newControlRange=dom.getBody(doc).createControlRange(),i=0,len=controlRange.length;len>i;++i)newControlRange.add(controlRange.item(i));try{newControlRange.add(rangeElement)}catch(ex){throw new Error("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)")}newControlRange.select(),updateControlSelection(sel)}function WrappedSelection(selection,docSelection,win){this.nativeSelection=selection,this.docSelection=docSelection,this._ranges=[],this.win=win,this.refresh()}function createControlSelection(sel,ranges){for(var doc=dom.getDocument(ranges[0].startContainer),controlRange=dom.getBody(doc).createControlRange(),i=0,el;rangeCount>i;++i){el=getSingleElementFromRange(ranges[i]);try{controlRange.add(el)}catch(ex){throw new Error("setRanges(): Element within the one of the specified Ranges could not be added to control selection (does it have layout?)")}}controlRange.select(),updateControlSelection(sel)}function assertNodeInSameDocument(sel,node){if(sel.anchorNode&&dom.getDocument(sel.anchorNode)!==dom.getDocument(node))throw new DOMException("WRONG_DOCUMENT_ERR")}function inspect(sel){var rangeInspects=[],anchor=new DomPosition(sel.anchorNode,sel.anchorOffset),focus=new DomPosition(sel.focusNode,sel.focusOffset),name="function"==typeof sel.getName?sel.getName():"Selection";if("undefined"!=typeof sel.rangeCount)for(var i=0,len=sel.rangeCount;len>i;++i)rangeInspects[i]=DomRange.inspect(sel.getRangeAt(i));return"["+name+"(Ranges: "+rangeInspects.join(", ")+")(anchor: "+anchor.inspect()+", focus: "+focus.inspect()+"]"}api.requireModules(["DomUtil","DomRange","WrappedRange"]),api.config.checkSelectionRanges=!0;var BOOLEAN="boolean",windowPropertyName="_rangySelection",dom=api.dom,util=api.util,DomRange=api.DomRange,WrappedRange=api.WrappedRange,DOMException=api.DOMException,DomPosition=dom.DomPosition,getSelection,selectionIsCollapsed,CONTROL="Control",implementsWinGetSelection=api.util.isHostMethod(global,"getSelection"),implementsDocSelection=api.util.isHostObject(document,"selection"),useDocumentSelection=implementsDocSelection&&(!implementsWinGetSelection||api.config.preferTextRange);if(useDocumentSelection)getSelection=getDocSelection,api.isSelectionValid=function(winParam){var doc=(winParam||global).document,nativeSel=doc.selection;return"None"!=nativeSel.type||dom.getDocument(nativeSel.createRange().parentElement())==doc};else if(implementsWinGetSelection)getSelection=getWinSelection,api.isSelectionValid=function(){return!0};else module.fail("Neither document.selection or window.getSelection() detected.");api.getNativeSelection=getSelection;var testSelection=getSelection(),testRange=api.createNativeRange(document),body=dom.getBody(document),selectionHasAnchorAndFocus=util.areHostObjects(testSelection,["anchorNode","focusNode"]&&util.areHostProperties(testSelection,["anchorOffset","focusOffset"]));api.features.selectionHasAnchorAndFocus=selectionHasAnchorAndFocus;var selectionHasExtend=util.isHostMethod(testSelection,"extend");api.features.selectionHasExtend=selectionHasExtend;var selectionHasRangeCount="number"==typeof testSelection.rangeCount;api.features.selectionHasRangeCount=selectionHasRangeCount;var selectionSupportsMultipleRanges=!1,collapsedNonEditableSelectionsSupported=!0;if(util.areHostMethods(testSelection,["addRange","getRangeAt","removeAllRanges"])&&"number"==typeof testSelection.rangeCount&&api.features.implementsDomRange)!function(){var iframe=document.createElement("iframe");body.appendChild(iframe);var iframeDoc=dom.getIframeDocument(iframe);iframeDoc.open(),iframeDoc.write("<html><head></head><body>12</body></html>"),iframeDoc.close();var sel=dom.getIframeWindow(iframe).getSelection(),docEl=iframeDoc.documentElement,iframeBody=docEl.lastChild,textNode=iframeBody.firstChild,r1=iframeDoc.createRange();r1.setStart(textNode,1),r1.collapse(!0),sel.addRange(r1),collapsedNonEditableSelectionsSupported=1==sel.rangeCount,sel.removeAllRanges();var r2=r1.cloneRange();r1.setStart(textNode,0),r2.setEnd(textNode,2),sel.addRange(r1),sel.addRange(r2),selectionSupportsMultipleRanges=2==sel.rangeCount,r1.detach(),r2.detach(),body.removeChild(iframe)}();api.features.selectionSupportsMultipleRanges=selectionSupportsMultipleRanges,api.features.collapsedNonEditableSelectionsSupported=collapsedNonEditableSelectionsSupported;var implementsControlRange=!1,testControlRange;if(body&&util.isHostMethod(body,"createControlRange"))if(testControlRange=body.createControlRange(),util.areHostProperties(testControlRange,["item","add"]))implementsControlRange=!0;if(api.features.implementsControlRange=implementsControlRange,selectionHasAnchorAndFocus)selectionIsCollapsed=function(sel){return sel.anchorNode===sel.focusNode&&sel.anchorOffset===sel.focusOffset};else selectionIsCollapsed=function(sel){return sel.rangeCount?sel.getRangeAt(sel.rangeCount-1).collapsed:!1};var getSelectionRangeAt;if(util.isHostMethod(testSelection,"getRangeAt"))getSelectionRangeAt=function(sel,index){try{return sel.getRangeAt(index)}catch(ex){return null}};else if(selectionHasAnchorAndFocus)getSelectionRangeAt=function(sel){var doc=dom.getDocument(sel.anchorNode),range=api.createRange(doc);if(range.setStart(sel.anchorNode,sel.anchorOffset),range.setEnd(sel.focusNode,sel.focusOffset),range.collapsed!==this.isCollapsed)range.setStart(sel.focusNode,sel.focusOffset),range.setEnd(sel.anchorNode,sel.anchorOffset);return range};api.getSelection=function(win){win=win||global;var sel=win[windowPropertyName],nativeSel=getSelection(win),docSel=implementsDocSelection?getDocSelection(win):null;if(sel)sel.nativeSelection=nativeSel,sel.docSelection=docSel,sel.refresh(win);else sel=new WrappedSelection(nativeSel,docSel,win),win[windowPropertyName]=sel;return sel},api.getIframeSelection=function(iframeEl){return api.getSelection(dom.getIframeWindow(iframeEl))};var selProto=WrappedSelection.prototype;if(!useDocumentSelection&&selectionHasAnchorAndFocus&&util.areHostMethods(testSelection,["removeAllRanges","addRange"])){selProto.removeAllRanges=function(){this.nativeSelection.removeAllRanges(),updateEmptySelection(this)};var addRangeBackwards=function(sel,range){var doc=DomRange.getRangeDocument(range),endRange=api.createRange(doc);endRange.collapseToPoint(range.endContainer,range.endOffset),sel.nativeSelection.addRange(getNativeRange(endRange)),sel.nativeSelection.extend(range.startContainer,range.startOffset),sel.refresh()};if(selectionHasRangeCount)selProto.addRange=function(range,backwards){if(implementsControlRange&&implementsDocSelection&&this.docSelection.type==CONTROL)addRangeToControlSelection(this,range);else if(backwards&&selectionHasExtend)addRangeBackwards(this,range);else{var previousRangeCount;if(selectionSupportsMultipleRanges)previousRangeCount=this.rangeCount;else this.removeAllRanges(),previousRangeCount=0;if(this.nativeSelection.addRange(getNativeRange(range)),this.rangeCount=this.nativeSelection.rangeCount,this.rangeCount==previousRangeCount+1){if(api.config.checkSelectionRanges){var nativeRange=getSelectionRangeAt(this.nativeSelection,this.rangeCount-1);if(nativeRange&&!DomRange.rangesEqual(nativeRange,range))range=new WrappedRange(nativeRange)}this._ranges[this.rangeCount-1]=range,updateAnchorAndFocusFromRange(this,range,selectionIsBackwards(this.nativeSelection)),this.isCollapsed=selectionIsCollapsed(this)}else this.refresh()}};else selProto.addRange=function(range,backwards){if(backwards&&selectionHasExtend)addRangeBackwards(this,range);else this.nativeSelection.addRange(getNativeRange(range)),this.refresh()};selProto.setRanges=function(ranges){if(implementsControlRange&&ranges.length>1)createControlSelection(this,ranges);else{this.removeAllRanges();for(var i=0,len=ranges.length;len>i;++i)this.addRange(ranges[i])}}}else if(util.isHostMethod(testSelection,"empty")&&util.isHostMethod(testRange,"select")&&implementsControlRange&&useDocumentSelection)selProto.removeAllRanges=function(){try{if(this.docSelection.empty(),"None"!=this.docSelection.type){var doc;if(this.anchorNode)doc=dom.getDocument(this.anchorNode);else if(this.docSelection.type==CONTROL){var controlRange=this.docSelection.createRange();if(controlRange.length)doc=dom.getDocument(controlRange.item(0)).body.createTextRange()}if(doc){var textRange=doc.body.createTextRange();textRange.select(),this.docSelection.empty()}}}catch(ex){}updateEmptySelection(this)},selProto.addRange=function(range){if(this.docSelection.type==CONTROL)addRangeToControlSelection(this,range);else WrappedRange.rangeToTextRange(range).select(),this._ranges[0]=range,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,updateAnchorAndFocusFromRange(this,range,!1)},selProto.setRanges=function(ranges){this.removeAllRanges();var rangeCount=ranges.length;if(rangeCount>1)createControlSelection(this,ranges);else if(rangeCount)this.addRange(ranges[0])};else return module.fail("No means of selecting a Range or TextRange was found"),!1;selProto.getRangeAt=function(index){if(0>index||index>=this.rangeCount)throw new DOMException("INDEX_SIZE_ERR");else return this._ranges[index]};var refreshSelection;if(useDocumentSelection)refreshSelection=function(sel){var range;if(api.isSelectionValid(sel.win))range=sel.docSelection.createRange();else range=dom.getBody(sel.win.document).createTextRange(),range.collapse(!0);if(sel.docSelection.type==CONTROL)updateControlSelection(sel);else if(isTextRange(range))updateFromTextRange(sel,range);else updateEmptySelection(sel)};else if(util.isHostMethod(testSelection,"getRangeAt")&&"number"==typeof testSelection.rangeCount)refreshSelection=function(sel){if(implementsControlRange&&implementsDocSelection&&sel.docSelection.type==CONTROL)updateControlSelection(sel);else{if(sel&&sel.nativeSelection)sel._ranges.length=sel.rangeCount=sel.nativeSelection.rangeCount;if(sel.rangeCount){for(var i=0,len=sel.rangeCount;len>i;++i)sel._ranges[i]=new api.WrappedRange(sel.nativeSelection.getRangeAt(i));updateAnchorAndFocusFromRange(sel,sel._ranges[sel.rangeCount-1],selectionIsBackwards(sel.nativeSelection)),sel.isCollapsed=selectionIsCollapsed(sel)}else updateEmptySelection(sel)}};else if(selectionHasAnchorAndFocus&&typeof testSelection.isCollapsed==BOOLEAN&&typeof testRange.collapsed==BOOLEAN&&api.features.implementsDomRange)refreshSelection=function(sel){var range,nativeSel=sel.nativeSelection;if(nativeSel.anchorNode)range=getSelectionRangeAt(nativeSel,0),sel._ranges=[range],sel.rangeCount=1,updateAnchorAndFocusFromNativeSelection(sel),sel.isCollapsed=selectionIsCollapsed(sel);else updateEmptySelection(sel)};else return module.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;selProto.refresh=function(checkForChanges){var oldRanges=checkForChanges?this._ranges.slice(0):null;if(refreshSelection(this),checkForChanges){var i=oldRanges.length;if(i!=this._ranges.length)return!1;for(;i--;)if(!DomRange.rangesEqual(oldRanges[i],this._ranges[i]))return!1;return!0}};var removeRangeManually=function(sel,range){var ranges=sel.getAllRanges(),removed=!1;sel.removeAllRanges();for(var i=0,len=ranges.length;len>i;++i)if(removed||range!==ranges[i])sel.addRange(ranges[i]);else removed=!0;if(!sel.rangeCount)updateEmptySelection(sel)};if(implementsControlRange)selProto.removeRange=function(range){if(this.docSelection.type==CONTROL){for(var controlRange=this.docSelection.createRange(),rangeElement=getSingleElementFromRange(range),doc=dom.getDocument(controlRange.item(0)),newControlRange=dom.getBody(doc).createControlRange(),el,removed=!1,i=0,len=controlRange.length;len>i;++i)if(el=controlRange.item(i),el!==rangeElement||removed)newControlRange.add(controlRange.item(i));else removed=!0;newControlRange.select(),updateControlSelection(this)}else removeRangeManually(this,range)};else selProto.removeRange=function(range){removeRangeManually(this,range)};var selectionIsBackwards;if(!useDocumentSelection&&selectionHasAnchorAndFocus&&api.features.implementsDomRange)selectionIsBackwards=function(sel){var backwards=!1;if(sel.anchorNode)backwards=1==dom.comparePoints(sel.anchorNode,sel.anchorOffset,sel.focusNode,sel.focusOffset);return backwards},selProto.isBackwards=function(){return selectionIsBackwards(this)};else selectionIsBackwards=selProto.isBackwards=function(){return!1};selProto.toString=function(){for(var rangeTexts=[],i=0,len=this.rangeCount;len>i;++i)rangeTexts[i]=""+this._ranges[i];return rangeTexts.join("")},selProto.collapse=function(node,offset){assertNodeInSameDocument(this,node);var range=api.createRange(dom.getDocument(node));range.collapseToPoint(node,offset),this.removeAllRanges(),this.addRange(range),this.isCollapsed=!0},selProto.collapseToStart=function(){if(this.rangeCount){var range=this._ranges[0];this.collapse(range.startContainer,range.startOffset)}else throw new DOMException("INVALID_STATE_ERR")},selProto.collapseToEnd=function(){if(this.rangeCount){var range=this._ranges[this.rangeCount-1];this.collapse(range.endContainer,range.endOffset)}else throw new DOMException("INVALID_STATE_ERR")},selProto.selectAllChildren=function(node){assertNodeInSameDocument(this,node);var range=api.createRange(dom.getDocument(node));range.selectNodeContents(node),this.removeAllRanges(),this.addRange(range)},selProto.deleteFromDocument=function(){if(implementsControlRange&&implementsDocSelection&&this.docSelection.type==CONTROL){for(var controlRange=this.docSelection.createRange(),element;controlRange.length;)element=controlRange.item(0),controlRange.remove(element),element.parentNode.removeChild(element);this.refresh()}else if(this.rangeCount){var ranges=this.getAllRanges();this.removeAllRanges();for(var i=0,len=ranges.length;len>i;++i)ranges[i].deleteContents();this.addRange(ranges[len-1])}},selProto.getAllRanges=function(){return this._ranges.slice(0)},selProto.setSingleRange=function(range){this.setRanges([range])},selProto.containsNode=function(node,allowPartial){for(var i=0,len=this._ranges.length;len>i;++i)if(this._ranges[i].containsNode(node,allowPartial))return!0;return!1},selProto.toHtml=function(){var html="";if(this.rangeCount){for(var container=DomRange.getRangeDocument(this._ranges[0]).createElement("div"),i=0,len=this._ranges.length;len>i;++i)container.appendChild(this._ranges[i].cloneContents());html=container.innerHTML}return html},selProto.getName=function(){return"WrappedSelection"},selProto.inspect=function(){return inspect(this)},selProto.detach=function(){this.win[windowPropertyName]=null,this.win=this.anchorNode=this.focusNode=null},WrappedSelection.inspect=inspect,api.Selection=WrappedSelection,api.selectionPrototype=selProto,api.addCreateMissingNativeApiListener(function(win){if("undefined"==typeof win.getSelection)win.getSelection=function(){return api.getSelection(this)};win=null})});var Base=function(){};return Base.extend=function(_instance,_static){var extend=Base.prototype.extend;Base._prototyping=!0;var proto=new this;extend.call(proto,_instance),proto.base=function(){},delete Base._prototyping;var constructor=proto.constructor,klass=proto.constructor=function(){if(!Base._prototyping)if(this._constructing||this.constructor==klass)this._constructing=!0,constructor.apply(this,arguments),delete this._constructing;else if(null!=arguments[0])return(arguments[0].extend||extend).call(arguments[0],proto)};if(klass.ancestor=this,klass.extend=this.extend,klass.forEach=this.forEach,klass.implement=this.implement,klass.prototype=proto,klass.toString=this.toString,klass.valueOf=function(type){return"object"==type?klass:constructor.valueOf()},extend.call(klass,_static),"function"==typeof klass.init)klass.init();return klass},Base.prototype={extend:function(source,value){if(arguments.length>1){var ancestor=this[source];if(ancestor&&"function"==typeof value&&(!ancestor.valueOf||ancestor.valueOf()!=value.valueOf())&&/\bbase\b/.test(value)){var method=value.valueOf();value=function(){var previous=this.base||Base.prototype.base;this.base=ancestor;var returnValue=method.apply(this,arguments);return this.base=previous,returnValue},value.valueOf=function(type){return"object"==type?value:method},value.toString=Base.toString}this[source]=value}else if(source){var extend=Base.prototype.extend;if(!Base._prototyping&&"function"!=typeof this)extend=this.extend||extend;for(var proto={toSource:null},hidden=["constructor","toString","valueOf"],i=Base._prototyping?0:1;key=hidden[i++];)if(source[key]!=proto[key])extend.call(this,key,source[key]);for(var key in source)if(!proto[key])extend.call(this,key,source[key])}return this}},Base=Base.extend({constructor:function(){this.extend(arguments[0])}},{ancestor:Object,version:"1.1",forEach:function(object,block,context){for(var key in object)if(void 0===this.prototype[key])block.call(context,object[key],key,object)
},implement:function(){for(var i=0;i<arguments.length;i++)if("function"==typeof arguments[i])arguments[i](this.prototype);else this.prototype.extend(arguments[i]);return this},toString:function(){return String(this.valueOf())}}),wysihtml5.browser=function(){function iosVersion(userAgent){return+(/ipad|iphone|ipod/.test(userAgent)&&userAgent.match(/ os (\d+).+? like mac os x/)||[void 0,0])[1]}function androidVersion(userAgent){return+(userAgent.match(/android (\d+)/)||[void 0,0])[1]}var userAgent=navigator.userAgent,testElement=document.createElement("div"),isIE=-1!==userAgent.indexOf("MSIE")&&-1===userAgent.indexOf("Opera"),isGecko=-1!==userAgent.indexOf("Gecko")&&-1===userAgent.indexOf("KHTML"),isWebKit=-1!==userAgent.indexOf("AppleWebKit/"),isChrome=-1!==userAgent.indexOf("Chrome/"),isOpera=-1!==userAgent.indexOf("Opera/");return{USER_AGENT:userAgent,supported:function(){var userAgent=this.USER_AGENT.toLowerCase(),hasContentEditableSupport="contentEditable"in testElement,hasEditingApiSupport=document.execCommand&&document.queryCommandSupported&&document.queryCommandState,hasQuerySelectorSupport=document.querySelector&&document.querySelectorAll,isIncompatibleMobileBrowser=this.isIos()&&iosVersion(userAgent)<5||this.isAndroid()&&androidVersion(userAgent)<4||-1!==userAgent.indexOf("opera mobi")||-1!==userAgent.indexOf("hpwos/");return hasContentEditableSupport&&hasEditingApiSupport&&hasQuerySelectorSupport&&!isIncompatibleMobileBrowser},isTouchDevice:function(){return this.supportsEvent("touchmove")},isIos:function(){return/ipad|iphone|ipod/i.test(this.USER_AGENT)},isAndroid:function(){return-1!==this.USER_AGENT.indexOf("Android")},supportsSandboxedIframes:function(){return isIE},throwsMixedContentWarningWhenIframeSrcIsEmpty:function(){return!("querySelector"in document)},displaysCaretInEmptyContentEditableCorrectly:function(){return isIE},hasCurrentStyleProperty:function(){return"currentStyle"in testElement},hasHistoryIssue:function(){return isGecko},insertsLineBreaksOnReturn:function(){return isGecko},supportsPlaceholderAttributeOn:function(element){return"placeholder"in element},supportsEvent:function(eventName){return"on"+eventName in testElement||function(){return testElement.setAttribute("on"+eventName,"return;"),"function"==typeof testElement["on"+eventName]}()},supportsEventsInIframeCorrectly:function(){return!isOpera},supportsHTML5Tags:function(context){var element=context.createElement("div"),html5="<article>foo</article>";return element.innerHTML=html5,element.innerHTML.toLowerCase()===html5},supportsCommand:function(){var buggyCommands={formatBlock:isIE,insertUnorderedList:isIE||isWebKit,insertOrderedList:isIE||isWebKit},supported={insertHTML:isGecko};return function(doc,command){var isBuggy=buggyCommands[command];if(!isBuggy){try{return doc.queryCommandSupported(command)}catch(e1){}try{return doc.queryCommandEnabled(command)}catch(e2){return!!supported[command]}}return!1}}(),doesAutoLinkingInContentEditable:function(){return isIE},canDisableAutoLinking:function(){return this.supportsCommand(document,"AutoUrlDetect")},clearsContentEditableCorrectly:function(){return isGecko||isOpera||isWebKit},supportsGetAttributeCorrectly:function(){var td=document.createElement("td");return"1"!=td.getAttribute("rowspan")},canSelectImagesInContentEditable:function(){return isGecko||isIE||isOpera},autoScrollsToCaret:function(){return!isWebKit},autoClosesUnclosedTags:function(){var clonedTestElement=testElement.cloneNode(!1),returnValue,innerHTML;return clonedTestElement.innerHTML="<p><div></div>",innerHTML=clonedTestElement.innerHTML.toLowerCase(),returnValue="<p></p><div></div>"===innerHTML||"<p><div></div></p>"===innerHTML,this.autoClosesUnclosedTags=function(){return returnValue},returnValue},supportsNativeGetElementsByClassName:function(){return-1!==String(document.getElementsByClassName).indexOf("[native code]")},supportsSelectionModify:function(){return"getSelection"in global&&"modify"in window.getSelection()},needsSpaceAfterLineBreak:function(){return isOpera},supportsSpeechApiOn:function(input){var chromeVersion=userAgent.match(/Chrome\/(\d+)/)||[void 0,0];return chromeVersion[1]>=11&&("onwebkitspeechchange"in input||"speech"in input)},crashesWhenDefineProperty:function(property){return isIE&&("XMLHttpRequest"===property||"XDomainRequest"===property)},doesAsyncFocus:function(){return isIE},hasProblemsSettingCaretAfterImg:function(){return isIE},hasUndoInContextMenu:function(){return isGecko||isChrome||isOpera},hasInsertNodeIssue:function(){return isOpera},hasIframeFocusIssue:function(){return isIE}}}(),wysihtml5.lang.array=function(arr){return{contains:function(needle){if(arr.indexOf)return-1!==arr.indexOf(needle);else{for(var i=0,length=arr.length;length>i;i++)if(arr[i]===needle)return!0;return!1}},without:function(arrayToSubstract){arrayToSubstract=wysihtml5.lang.array(arrayToSubstract);for(var newArr=[],i=0,length=arr.length;length>i;i++)if(!arrayToSubstract.contains(arr[i]))newArr.push(arr[i]);return newArr},get:function(){for(var i=0,length=arr.length,newArray=[];length>i;i++)newArray.push(arr[i]);return newArray}}},wysihtml5.lang.Dispatcher=Base.extend({on:function(eventName,handler){return this.events=this.events||{},this.events[eventName]=this.events[eventName]||[],this.events[eventName].push(handler),this},off:function(eventName,handler){this.events=this.events||{};var i=0,handlers,newHandlers;if(eventName){for(handlers=this.events[eventName]||[],newHandlers=[];i<handlers.length;i++)if(handlers[i]!==handler&&handler)newHandlers.push(handlers[i]);this.events[eventName]=newHandlers}else this.events={};return this},fire:function(eventName,payload,payload2){this.events=this.events||{};for(var handlers=this.events[eventName]||[],i=0;i<handlers.length;i++)handlers[i].call(this,payload,payload2);return this},observe:function(){return this.on.apply(this,arguments)},stopObserving:function(){return this.off.apply(this,arguments)}}),wysihtml5.lang.object=function(obj){return{merge:function(otherObj){for(var i in otherObj)obj[i]=otherObj[i];return this},get:function(){return obj},clone:function(){var newObj={},i;for(i in obj)newObj[i]=obj[i];return newObj},isArray:function(){return"[object Array]"===Object.prototype.toString.call(obj)}}},function(){var WHITE_SPACE_START=/^\s+/,WHITE_SPACE_END=/\s+$/;wysihtml5.lang.string=function(str){return str=String(str),{trim:function(){return str.replace(WHITE_SPACE_START,"").replace(WHITE_SPACE_END,"")},interpolate:function(vars){for(var i in vars)str=this.replace("#{"+i+"}").by(vars[i]);return str},replace:function(search){return{by:function(replace){return str.split(search).join(replace)}}}}}}(),function(wysihtml5){function autoLink(element){if(_hasParentThatShouldBeIgnored(element))return element;if(element===element.ownerDocument.documentElement)element=element.ownerDocument.body;return _parseNode(element)}function _convertUrlsToLinks(str){return str.replace(URL_REG_EXP,function(match,url){var punctuation=(url.match(TRAILING_CHAR_REG_EXP)||[])[1]||"",opening=BRACKETS[punctuation];if(url=url.replace(TRAILING_CHAR_REG_EXP,""),url.split(opening).length>url.split(punctuation).length)url+=punctuation,punctuation="";var realUrl=url,displayUrl=url;if(url.length>MAX_DISPLAY_LENGTH)displayUrl=displayUrl.substr(0,MAX_DISPLAY_LENGTH)+"...";if("www."===realUrl.substr(0,4))realUrl="http://"+realUrl;return'<a href="'+realUrl+'">'+displayUrl+"</a>"+punctuation})}function _getTempElement(context){var tempElement=context._wysihtml5_tempElement;if(!tempElement)tempElement=context._wysihtml5_tempElement=context.createElement("div");return tempElement}function _wrapMatchesInNode(textNode){var parentNode=textNode.parentNode,tempElement=_getTempElement(parentNode.ownerDocument);for(tempElement.innerHTML="<span></span>"+_convertUrlsToLinks(textNode.data),tempElement.removeChild(tempElement.firstChild);tempElement.firstChild;)parentNode.insertBefore(tempElement.firstChild,textNode);parentNode.removeChild(textNode)}function _hasParentThatShouldBeIgnored(node){for(var nodeName;node.parentNode;)if(node=node.parentNode,nodeName=node.nodeName,IGNORE_URLS_IN.contains(nodeName))return!0;else if("body"===nodeName)return!1;return!1}function _parseNode(element){if(!IGNORE_URLS_IN.contains(element.nodeName)){if(element.nodeType===wysihtml5.TEXT_NODE&&element.data.match(URL_REG_EXP))return void _wrapMatchesInNode(element);for(var childNodes=wysihtml5.lang.array(element.childNodes).get(),childNodesLength=childNodes.length,i=0;childNodesLength>i;i++)_parseNode(childNodes[i]);return element}}var IGNORE_URLS_IN=wysihtml5.lang.array(["CODE","PRE","A","SCRIPT","HEAD","TITLE","STYLE"]),URL_REG_EXP=/((https?:\/\/|www\.)[^\s<]{3,})/gi,TRAILING_CHAR_REG_EXP=/([^\w\/\-](,?))$/i,MAX_DISPLAY_LENGTH=100,BRACKETS={")":"(","]":"[","}":"{"};wysihtml5.dom.autoLink=autoLink,wysihtml5.dom.autoLink.URL_REG_EXP=URL_REG_EXP}(wysihtml5),function(wysihtml5){var api=wysihtml5.dom;api.addClass=function(element,className){var classList=element.classList;if(classList)return classList.add(className);if(!api.hasClass(element,className))element.className+=" "+className},api.removeClass=function(element,className){var classList=element.classList;if(classList)return classList.remove(className);else return void(element.className=element.className.replace(new RegExp("(^|\\s+)"+className+"(\\s+|$)")," "))},api.hasClass=function(element,className){var classList=element.classList;if(classList)return classList.contains(className);var elementClassName=element.className;return elementClassName.length>0&&(elementClassName==className||new RegExp("(^|\\s)"+className+"(\\s|$)").test(elementClassName))}}(wysihtml5),wysihtml5.dom.contains=function(){var documentElement=document.documentElement;if(documentElement.contains)return function(container,element){if(element.nodeType!==wysihtml5.ELEMENT_NODE)element=element.parentNode;return container!==element&&container.contains(element)};else if(documentElement.compareDocumentPosition)return function(container,element){return!!(16&container.compareDocumentPosition(element))}}(),wysihtml5.dom.convertToList=function(){function _createListItem(doc,list){var listItem=doc.createElement("li");return list.appendChild(listItem),listItem}function _createList(doc,type){return doc.createElement(type)}function convertToList(element,listType){if("UL"===element.nodeName||"OL"===element.nodeName||"MENU"===element.nodeName)return element;var doc=element.ownerDocument,list=_createList(doc,listType),lineBreaks=element.querySelectorAll("br"),lineBreaksLength=lineBreaks.length,childNodes,childNodesLength,childNode,lineBreak,parentNode,isBlockElement,isLineBreak,currentListItem,i;for(i=0;lineBreaksLength>i;i++)for(lineBreak=lineBreaks[i];(parentNode=lineBreak.parentNode)&&parentNode!==element&&parentNode.lastChild===lineBreak;){if("block"===wysihtml5.dom.getStyle("display").from(parentNode)){parentNode.removeChild(lineBreak);break}wysihtml5.dom.insert(lineBreak).after(lineBreak.parentNode)}for(childNodes=wysihtml5.lang.array(element.childNodes).get(),childNodesLength=childNodes.length,i=0;childNodesLength>i;i++)if(currentListItem=currentListItem||_createListItem(doc,list),childNode=childNodes[i],isBlockElement="block"===wysihtml5.dom.getStyle("display").from(childNode),isLineBreak="BR"===childNode.nodeName,!isBlockElement)if(!isLineBreak)currentListItem.appendChild(childNode);else currentListItem=currentListItem.firstChild?null:currentListItem;else currentListItem=currentListItem.firstChild?_createListItem(doc,list):currentListItem,currentListItem.appendChild(childNode),currentListItem=null;if(0===childNodes.length)_createListItem(doc,list);return element.parentNode.replaceChild(list,element),list}return convertToList}(),wysihtml5.dom.copyAttributes=function(attributesToCopy){return{from:function(elementToCopyFrom){return{to:function(elementToCopyTo){for(var attribute,i=0,length=attributesToCopy.length;length>i;i++)if(attribute=attributesToCopy[i],"undefined"!=typeof elementToCopyFrom[attribute]&&""!==elementToCopyFrom[attribute])elementToCopyTo[attribute]=elementToCopyFrom[attribute];return{andTo:arguments.callee}}}}}},function(dom){var BOX_SIZING_PROPERTIES=["-webkit-box-sizing","-moz-box-sizing","-ms-box-sizing","box-sizing"],shouldIgnoreBoxSizingBorderBox=function(element){if(hasBoxSizingBorderBox(element))return parseInt(dom.getStyle("width").from(element),10)<element.offsetWidth;else return!1},hasBoxSizingBorderBox=function(element){for(var i=0,length=BOX_SIZING_PROPERTIES.length;length>i;i++)if("border-box"===dom.getStyle(BOX_SIZING_PROPERTIES[i]).from(element))return BOX_SIZING_PROPERTIES[i]};dom.copyStyles=function(stylesToCopy){return{from:function(element){if(shouldIgnoreBoxSizingBorderBox(element))stylesToCopy=wysihtml5.lang.array(stylesToCopy).without(BOX_SIZING_PROPERTIES);for(var cssText="",length=stylesToCopy.length,i=0,property;length>i;i++)property=stylesToCopy[i],cssText+=property+":"+dom.getStyle(property).from(element)+";";return{to:function(element){return dom.setStyles(cssText).on(element),{andTo:arguments.callee}}}}}}}(wysihtml5.dom),function(wysihtml5){wysihtml5.dom.delegate=function(container,selector,eventName,handler){return wysihtml5.dom.observe(container,eventName,function(event){for(var target=event.target,match=wysihtml5.lang.array(container.querySelectorAll(selector));target&&target!==container;){if(match.contains(target)){handler.call(target,event);break}target=target.parentNode}})}}(wysihtml5),wysihtml5.dom.getAsDom=function(){var _innerHTMLShiv=function(html,context){var tempElement=context.createElement("div");tempElement.style.display="none",context.body.appendChild(tempElement);try{tempElement.innerHTML=html}catch(e){}return context.body.removeChild(tempElement),tempElement},_ensureHTML5Compatibility=function(context){if(!context._wysihtml5_supportsHTML5Tags){for(var i=0,length=HTML5_ELEMENTS.length;length>i;i++)context.createElement(HTML5_ELEMENTS[i]);context._wysihtml5_supportsHTML5Tags=!0}},HTML5_ELEMENTS=["abbr","article","aside","audio","bdi","canvas","command","datalist","details","figcaption","figure","footer","header","hgroup","keygen","mark","meter","nav","output","progress","rp","rt","ruby","svg","section","source","summary","time","track","video","wbr"];return function(html,context){context=context||document;var tempElement;if("object"==typeof html&&html.nodeType)tempElement=context.createElement("div"),tempElement.appendChild(html);else if(wysihtml5.browser.supportsHTML5Tags(context))tempElement=context.createElement("div"),tempElement.innerHTML=html;else _ensureHTML5Compatibility(context),tempElement=_innerHTMLShiv(html,context);return tempElement}}(),wysihtml5.dom.getParentElement=function(){function _isSameNodeName(nodeName,desiredNodeNames){if(!desiredNodeNames||!desiredNodeNames.length)return!0;if("string"==typeof desiredNodeNames)return nodeName===desiredNodeNames;else return wysihtml5.lang.array(desiredNodeNames).contains(nodeName)}function _isElement(node){return node.nodeType===wysihtml5.ELEMENT_NODE}function _hasClassName(element,className,classRegExp){var classNames=(element.className||"").match(classRegExp)||[];if(!className)return!!classNames.length;else return classNames[classNames.length-1]===className}function _getParentElementWithNodeName(node,nodeName,levels){for(;levels--&&node&&"BODY"!==node.nodeName;){if(_isSameNodeName(node.nodeName,nodeName))return node;node=node.parentNode}return null}function _getParentElementWithNodeNameAndClassName(node,nodeName,className,classRegExp,levels){for(;levels--&&node&&"BODY"!==node.nodeName;){if(_isElement(node)&&_isSameNodeName(node.nodeName,nodeName)&&_hasClassName(node,className,classRegExp))return node;node=node.parentNode}return null}return function(node,matchingSet,levels){if(levels=levels||50,matchingSet.className||matchingSet.classRegExp)return _getParentElementWithNodeNameAndClassName(node,matchingSet.nodeName,matchingSet.className,matchingSet.classRegExp,levels);else return _getParentElementWithNodeName(node,matchingSet.nodeName,levels)}}(),wysihtml5.dom.getStyle=function(){function camelize(str){return str.replace(REG_EXP_CAMELIZE,function(match){return match.charAt(1).toUpperCase()})}var stylePropertyMapping={"float":"styleFloat"in document.createElement("div").style?"styleFloat":"cssFloat"},REG_EXP_CAMELIZE=/\-[a-z]/g;return function(property){return{from:function(element){if(element.nodeType===wysihtml5.ELEMENT_NODE){var doc=element.ownerDocument,camelizedProperty=stylePropertyMapping[property]||camelize(property),style=element.style,currentStyle=element.currentStyle,styleValue=style[camelizedProperty];if(styleValue)return styleValue;if(currentStyle)try{return currentStyle[camelizedProperty]}catch(e){}var win=doc.defaultView||doc.parentWindow,needsOverflowReset=("height"===property||"width"===property)&&"TEXTAREA"===element.nodeName,originalOverflow,returnValue;if(win.getComputedStyle){if(needsOverflowReset)originalOverflow=style.overflow,style.overflow="hidden";if(returnValue=win.getComputedStyle(element,null).getPropertyValue(property),0===property.indexOf("border")&&-1!==property.indexOf("width"))returnValue=Math.round(parseFloat(returnValue))+"px";if(needsOverflowReset)style.overflow=originalOverflow||"";return returnValue}}}}}}(),wysihtml5.dom.hasElementWithTagName=function(){function _getDocumentIdentifier(doc){return doc._wysihtml5_identifier||(doc._wysihtml5_identifier=DOCUMENT_IDENTIFIER++)}var LIVE_CACHE={},DOCUMENT_IDENTIFIER=1;return function(doc,tagName){var key=_getDocumentIdentifier(doc)+":"+tagName,cacheEntry=LIVE_CACHE[key];if(!cacheEntry)cacheEntry=LIVE_CACHE[key]=doc.getElementsByTagName(tagName);return cacheEntry.length>0}}(),function(wysihtml5){function _getDocumentIdentifier(doc){return doc._wysihtml5_identifier||(doc._wysihtml5_identifier=DOCUMENT_IDENTIFIER++)}var LIVE_CACHE={},DOCUMENT_IDENTIFIER=1;wysihtml5.dom.hasElementWithClassName=function(doc,className){if(!wysihtml5.browser.supportsNativeGetElementsByClassName())return!!doc.querySelector("."+className);var key=_getDocumentIdentifier(doc)+":"+className,cacheEntry=LIVE_CACHE[key];if(!cacheEntry)cacheEntry=LIVE_CACHE[key]=doc.getElementsByClassName(className);return cacheEntry.length>0}}(wysihtml5),wysihtml5.dom.insert=function(elementToInsert){return{after:function(element){element.parentNode.insertBefore(elementToInsert,element.nextSibling)},before:function(element){element.parentNode.insertBefore(elementToInsert,element)},into:function(element){element.appendChild(elementToInsert)}}},wysihtml5.dom.insertCSS=function(rules){return rules=rules.join("\n"),{into:function(doc){var styleElement=doc.createElement("style");if(styleElement.type="text/css",styleElement.styleSheet)styleElement.styleSheet.cssText=rules;else styleElement.appendChild(doc.createTextNode(rules));var link=doc.querySelector("head link");if(link)return void link.parentNode.insertBefore(styleElement,link);else{var head=doc.querySelector("head");if(head)head.appendChild(styleElement)}}}},wysihtml5.dom.observe=function(element,eventNames,handler){eventNames="string"==typeof eventNames?[eventNames]:eventNames;for(var handlerWrapper,eventName,i=0,length=eventNames.length;length>i;i++)if(eventName=eventNames[i],element.addEventListener)if("DOMNodeRemoved"==eventName){var observeDOM=function(){var MutationObserver=window.MutationObserver||window.WebKitMutationObserver,eventListenerSupported=window.addEventListener;return function(obj,callback){if(MutationObserver){var obs=new MutationObserver(function(mutations,observer){if(mutations[0].removedNodes.length)callback()});obs.observe(obj,{childList:!0,subtree:!0})}else if(eventListenerSupported)obj.addEventListener("DOMNodeRemoved",callback,!1)}}();observeDOM(element,handler)}else element.addEventListener(eventName,handler,!1);else handlerWrapper=function(event){if(!("target"in event))event.target=event.srcElement;event.preventDefault=event.preventDefault||function(){this.returnValue=!1},event.stopPropagation=event.stopPropagation||function(){this.cancelBubble=!0},handler.call(element,event)},element.attachEvent("on"+eventName,handlerWrapper);return{stop:function(){for(var eventName,i=0,length=eventNames.length;length>i;i++)if(eventName=eventNames[i],element.removeEventListener)element.removeEventListener(eventName,handler,!1);else element.detachEvent("on"+eventName,handlerWrapper)}}},wysihtml5.dom.parse=function(){function parse(elementOrHtml,rules,context,cleanUp){wysihtml5.lang.object(currentRules).merge(defaultRules).merge(rules).get(),context=context||elementOrHtml.ownerDocument||document;var fragment=context.createDocumentFragment(),isString="string"==typeof elementOrHtml,element,newNode,firstChild;if(isString)element=wysihtml5.dom.getAsDom(elementOrHtml,context);else element=elementOrHtml;for(;element.firstChild;)if(firstChild=element.firstChild,element.removeChild(firstChild),newNode=currentRules.disable?firstChild:_convert(firstChild,cleanUp))fragment.appendChild(newNode);return element.innerHTML="",element.appendChild(fragment),isString?wysihtml5.quirks.getCorrectInnerHTML(element):element}function _convert(oldNode,cleanUp){var oldNodeType=oldNode.nodeType,oldChilds=oldNode.childNodes,oldChildsLength=oldChilds.length,method=NODE_TYPE_MAPPING[oldNodeType],i=0,newNode,newChild;if(newNode=method&&method(oldNode),!newNode)return null;for(i=0;oldChildsLength>i;i++)if(newChild=_convert(oldChilds[i],cleanUp))newNode.appendChild(newChild);if(cleanUp&&newNode.childNodes.length<=1&&newNode.nodeName.toLowerCase()===DEFAULT_NODE_NAME&&!newNode.attributes.length)return newNode.firstChild;else return newNode}function _handleElement(oldNode){var rule,newNode,tagRules=currentRules.tags,nodeName=oldNode.nodeName.toLowerCase(),scopeName=oldNode.scopeName;if(oldNode._wysihtml5)return null;if(oldNode._wysihtml5=1,"wysihtml5-temp"===oldNode.className)return null;if(scopeName&&"HTML"!=scopeName)nodeName=scopeName+":"+nodeName;if("outerHTML"in oldNode)if(!wysihtml5.browser.autoClosesUnclosedTags()&&"P"===oldNode.nodeName&&"</p>"!==oldNode.outerHTML.slice(-4).toLowerCase())nodeName="div";if(currentRules.disable)newNode=oldNode.ownerDocument.createElement(nodeName),_handleAttributes(oldNode,newNode,{disable:!0});else{if(nodeName in tagRules){if(rule=tagRules[nodeName],!rule||rule.remove)return null;rule="string"==typeof rule?{rename_tag:rule}:rule}else if(oldNode.firstChild)rule={rename_tag:DEFAULT_NODE_NAME};else return null;newNode=oldNode.ownerDocument.createElement(rule.rename_tag||nodeName),_handleAttributes(oldNode,newNode,rule)}return oldNode=null,newNode}function _handleAttributes(oldNode,newNode,rule){var attributes={},setClass=rule.set_class,addClass=rule.add_class,setAttributes=rule.set_attributes,checkAttributes=rule.check_attributes,allowedClasses=currentRules.classes,i=0,classes=[],newClasses=[],newUniqueClasses=[],oldClasses=[],classesLength,newClassesLength,currentClass,newClass,attributeName,newAttributeValue,method;if(setAttributes)attributes=wysihtml5.lang.object(setAttributes).clone();if(checkAttributes&&!rule.disable)for(attributeName in checkAttributes)if(method=attributeCheckMethods[checkAttributes[attributeName]]){if(newAttributeValue=method(_getAttribute(oldNode,attributeName)),"string"==typeof newAttributeValue)attributes[attributeName]=newAttributeValue}else;else if(rule.disable){var attrs=oldNode.attributes,len=attrs.length;for(i=0;len>i;i++)if(newAttributeValue=attrs[i].value,"string"==typeof newAttributeValue)attributes[attrs[i].name]=newAttributeValue}if(setClass)classes.push(setClass);if(addClass)for(attributeName in addClass)if(method=addClassMethods[addClass[attributeName]]){if(newClass=method(_getAttribute(oldNode,attributeName)),"string"==typeof newClass)classes.push(newClass)}else;if(allowedClasses["_wysihtml5-temp-placeholder"]=1,oldClasses=oldNode.getAttribute("class"))classes=classes.concat(oldClasses.split(WHITE_SPACE_REG_EXP));for(classesLength=classes.length,i=0;classesLength>i;i++)if(currentClass=classes[i],allowedClasses[currentClass])newClasses.push(currentClass);for(newClassesLength=newClasses.length;newClassesLength--;)if(currentClass=newClasses[newClassesLength],!wysihtml5.lang.array(newUniqueClasses).contains(currentClass))newUniqueClasses.unshift(currentClass);if(newUniqueClasses.length)attributes["class"]=newUniqueClasses.join(" ");for(attributeName in attributes)try{newNode.setAttribute(attributeName,attributes[attributeName])}catch(e){}if(attributes.src){if("undefined"!=typeof attributes.width)newNode.setAttribute("width",attributes.width);if("undefined"!=typeof attributes.height)newNode.setAttribute("height",attributes.height)}}function _getAttribute(node,attributeName){attributeName=attributeName.toLowerCase();var nodeName=node.nodeName;if("IMG"==nodeName&&"src"==attributeName&&_isLoadedImage(node)===!0)return node.src;else if(HAS_GET_ATTRIBUTE_BUG&&"outerHTML"in node){var outerHTML=node.outerHTML.toLowerCase(),hasAttribute=-1!=outerHTML.indexOf(" "+attributeName+"=");return hasAttribute?node.getAttribute(attributeName):null}else return node.getAttribute(attributeName)}function _isLoadedImage(node){try{return node.complete&&!node.mozMatchesSelector(":-moz-broken")}catch(e){if(node.complete&&"complete"===node.readyState)return!0}}function _handleText(oldNode){return oldNode.ownerDocument.createTextNode(oldNode.data)}var NODE_TYPE_MAPPING={1:_handleElement,3:_handleText},DEFAULT_NODE_NAME="span",WHITE_SPACE_REG_EXP=/\s+/,defaultRules={tags:{},classes:{}},currentRules={},HAS_GET_ATTRIBUTE_BUG=!wysihtml5.browser.supportsGetAttributeCorrectly(),attributeCheckMethods={url:function(){var REG_EXP=/^https?:\/\//i;return function(attributeValue){if(!attributeValue||!attributeValue.match(REG_EXP))return null;else return attributeValue.replace(REG_EXP,function(match){return match.toLowerCase()})}}(),src:function(){var REG_EXP=/^(\/|https?:\/\/)/i;return function(attributeValue){if(!attributeValue||!attributeValue.match(REG_EXP))return null;else return attributeValue.replace(REG_EXP,function(match){return match.toLowerCase()})}}(),href:function(){var REG_EXP=/^(\/|https?:\/\/|mailto:)/i;return function(attributeValue){if(!attributeValue||!attributeValue.match(REG_EXP))return null;else return attributeValue.replace(REG_EXP,function(match){return match.toLowerCase()})}}(),allow:function(){return function(attributeValue){return attributeValue}}(),alt:function(){var REG_EXP=/[^ a-z0-9_\-]/gi;return function(attributeValue){if(!attributeValue)return"";else return attributeValue.replace(REG_EXP,"")}}(),numbers:function(){var REG_EXP=/\D/g;return function(attributeValue){return attributeValue=(attributeValue||"").replace(REG_EXP,""),attributeValue||null}}()},addClassMethods={align_img:function(){var mapping={left:"wysiwyg-float-left",right:"wysiwyg-float-right"};return function(attributeValue){return mapping[String(attributeValue).toLowerCase()]}}(),align_text:function(){var mapping={left:"wysiwyg-text-align-left",right:"wysiwyg-text-align-right",center:"wysiwyg-text-align-center",justify:"wysiwyg-text-align-justify"};return function(attributeValue){return mapping[String(attributeValue).toLowerCase()]}}(),clear_br:function(){var mapping={left:"wysiwyg-clear-left",right:"wysiwyg-clear-right",both:"wysiwyg-clear-both",all:"wysiwyg-clear-both"};return function(attributeValue){return mapping[String(attributeValue).toLowerCase()]}}(),size_font:function(){var mapping={1:"wysiwyg-font-size-xx-small",2:"wysiwyg-font-size-small",3:"wysiwyg-font-size-medium",4:"wysiwyg-font-size-large",5:"wysiwyg-font-size-x-large",6:"wysiwyg-font-size-xx-large",7:"wysiwyg-font-size-xx-large","-":"wysiwyg-font-size-smaller","+":"wysiwyg-font-size-larger"};return function(attributeValue){return mapping[String(attributeValue).charAt(0)]}}()};return parse}(),wysihtml5.dom.removeEmptyTextNodes=function(node){for(var childNode,childNodes=wysihtml5.lang.array(node.childNodes).get(),childNodesLength=childNodes.length,i=0;childNodesLength>i;i++)if(childNode=childNodes[i],childNode.nodeType===wysihtml5.TEXT_NODE&&""===childNode.data)childNode.parentNode.removeChild(childNode)},wysihtml5.dom.renameElement=function(element,newNodeName){for(var newElement=element.ownerDocument.createElement(newNodeName),firstChild;firstChild=element.firstChild;)newElement.appendChild(firstChild);return wysihtml5.dom.copyAttributes(["align","className"]).from(element).to(newElement),element.parentNode.replaceChild(newElement,element),newElement},wysihtml5.dom.replaceWithChildNodes=function(node){if(node.parentNode){if(!node.firstChild)return void node.parentNode.removeChild(node);for(var fragment=node.ownerDocument.createDocumentFragment();node.firstChild;)fragment.appendChild(node.firstChild);node.parentNode.replaceChild(fragment,node),node=fragment=null}},function(dom){function _isBlockElement(node){return"block"===dom.getStyle("display").from(node)}function _isLineBreak(node){return"BR"===node.nodeName}function _appendLineBreak(element){var lineBreak=element.ownerDocument.createElement("br");element.appendChild(lineBreak)}function resolveList(list,useLineBreaks){if(list.nodeName.match(/^(MENU|UL|OL)$/)){var doc=list.ownerDocument,fragment=doc.createDocumentFragment(),previousSibling=list.previousElementSibling||list.previousSibling,firstChild,lastChild,isLastChild,shouldAppendLineBreak,paragraph,listItem;if(useLineBreaks){if(previousSibling&&!_isBlockElement(previousSibling))_appendLineBreak(fragment);for(;listItem=list.firstElementChild||list.firstChild;){for(lastChild=listItem.lastChild;firstChild=listItem.firstChild;)if(isLastChild=firstChild===lastChild,shouldAppendLineBreak=isLastChild&&!_isBlockElement(firstChild)&&!_isLineBreak(firstChild),fragment.appendChild(firstChild),shouldAppendLineBreak)_appendLineBreak(fragment);listItem.parentNode.removeChild(listItem)}}else for(;listItem=list.firstElementChild||list.firstChild;){if(listItem.querySelector&&listItem.querySelector("div, p, ul, ol, menu, blockquote, h1, h2, h3, h4, h5, h6"))for(;firstChild=listItem.firstChild;)fragment.appendChild(firstChild);else{for(paragraph=doc.createElement("p");firstChild=listItem.firstChild;)paragraph.appendChild(firstChild);fragment.appendChild(paragraph)}listItem.parentNode.removeChild(listItem)}list.parentNode.replaceChild(fragment,list)}}dom.resolveList=resolveList}(wysihtml5.dom),function(wysihtml5){var doc=document,windowProperties=["parent","top","opener","frameElement","frames","localStorage","globalStorage","sessionStorage","indexedDB"],windowProperties2=["open","close","openDialog","showModalDialog","alert","confirm","prompt","openDatabase","postMessage","XMLHttpRequest","XDomainRequest"],documentProperties=["referrer","write","open","close"];wysihtml5.dom.Sandbox=Base.extend({constructor:function(readyCallback,config){this.callback=readyCallback||wysihtml5.EMPTY_FUNCTION,this.config=wysihtml5.lang.object({}).merge(config).get(),this.iframe=this._createIframe()},insertInto:function(element){if("string"==typeof element)element=doc.getElementById(element);element.appendChild(this.iframe)},getIframe:function(){return this.iframe},getWindow:function(){this._readyError()},getDocument:function(){this._readyError()},destroy:function(){var iframe=this.getIframe();iframe.parentNode.removeChild(iframe)},_readyError:function(){throw new Error("wysihtml5.Sandbox: Sandbox iframe isn't loaded yet")},_createIframe:function(){var that=this,iframe=doc.createElement("iframe");if(iframe.className="wysihtml5-sandbox",wysihtml5.dom.setAttributes({security:"restricted",allowtransparency:"true",frameborder:0,width:0,height:0,marginwidth:0,marginheight:0}).on(iframe),wysihtml5.browser.throwsMixedContentWarningWhenIframeSrcIsEmpty())iframe.src="javascript:'<html></html>'";return iframe.onload=function(){iframe.onreadystatechange=iframe.onload=null,that._onLoadIframe(iframe)},iframe.onreadystatechange=function(){if(/loaded|complete/.test(iframe.readyState))iframe.onreadystatechange=iframe.onload=null,that._onLoadIframe(iframe)},iframe},_onLoadIframe:function(iframe){if(wysihtml5.dom.contains(doc.documentElement,iframe)){var that=this,iframeWindow=iframe.contentWindow,iframeDocument=iframe.contentWindow.document,charset=doc.characterSet||doc.charset||"utf-8",sandboxHtml=this._getHtml({charset:charset,stylesheets:this.config.stylesheets});
if(iframeDocument.open("text/html","replace"),iframeDocument.write(sandboxHtml),iframeDocument.close(),this.getWindow=function(){return iframe.contentWindow},this.getDocument=function(){return iframe.contentWindow.document},iframeWindow.onerror=function(errorMessage,fileName,lineNumber){throw new Error("wysihtml5.Sandbox: "+errorMessage,fileName,lineNumber)},!wysihtml5.browser.supportsSandboxedIframes()){var i,length;for(i=0,length=windowProperties.length;length>i;i++)this._unset(iframeWindow,windowProperties[i]);for(i=0,length=windowProperties2.length;length>i;i++)this._unset(iframeWindow,windowProperties2[i],wysihtml5.EMPTY_FUNCTION);for(i=0,length=documentProperties.length;length>i;i++)this._unset(iframeDocument,documentProperties[i]);this._unset(iframeDocument,"cookie","",!0)}this.loaded=!0,setTimeout(function(){that.callback(that)},0)}},_getHtml:function(templateVars){var stylesheets=templateVars.stylesheets,html="",i=0,length;if(stylesheets="string"==typeof stylesheets?[stylesheets]:stylesheets)for(length=stylesheets.length;length>i;i++)html+='<link rel="stylesheet" href="'+stylesheets[i]+'">';return templateVars.stylesheets=html,wysihtml5.lang.string('<!DOCTYPE html><html><head><meta charset="#{charset}">#{stylesheets}</head><body></body></html>').interpolate(templateVars)},_unset:function(object,property,value,setter){try{object[property]=value}catch(e){}try{object.__defineGetter__(property,function(){return value})}catch(e){}if(setter)try{object.__defineSetter__(property,function(){})}catch(e){}if(!wysihtml5.browser.crashesWhenDefineProperty(property))try{var config={get:function(){return value}};if(setter)config.set=function(){};Object.defineProperty(object,property,config)}catch(e){}}})}(wysihtml5),function(){var mapping={className:"class"};wysihtml5.dom.setAttributes=function(attributes){return{on:function(element){for(var i in attributes)element.setAttribute(mapping[i]||i,attributes[i])}}}}(),wysihtml5.dom.setStyles=function(styles){return{on:function(element){var style=element.style;if("string"==typeof styles)return void(style.cssText+=";"+styles);for(var i in styles)if("float"===i)style.cssFloat=styles[i],style.styleFloat=styles[i];else style[i]=styles[i]}}},function(dom){dom.simulatePlaceholder=function(editor,view,placeholderText){var CLASS_NAME="placeholder",unset=function(){if(view.hasPlaceholderSet())view.clear();view.placeholderSet=!1,dom.removeClass(view.element,CLASS_NAME)},set=function(){if(view.isEmpty())view.placeholderSet=!0,view.setValue(placeholderText),dom.addClass(view.element,CLASS_NAME)};editor.on("set_placeholder",set).on("unset_placeholder",unset).on("focus:composer",unset).on("paste:composer",unset).on("blur:composer",set),set()}}(wysihtml5.dom),function(dom){var documentElement=document.documentElement;if("textContent"in documentElement)dom.setTextContent=function(element,text){element.textContent=text},dom.getTextContent=function(element){return element.textContent};else if("innerText"in documentElement)dom.setTextContent=function(element,text){element.innerText=text},dom.getTextContent=function(element){return element.innerText};else dom.setTextContent=function(element,text){element.nodeValue=text},dom.getTextContent=function(element){return element.nodeValue}}(wysihtml5.dom),wysihtml5.quirks.cleanPastedHTML=function(){function cleanPastedHTML(elementOrHtml,rules,context){rules=rules||defaultRules,context=context||elementOrHtml.ownerDocument||document;var element,isString="string"==typeof elementOrHtml,method,matches,matchesLength,i,j=0;if(isString)element=wysihtml5.dom.getAsDom(elementOrHtml,context);else element=elementOrHtml;for(i in rules)for(matches=element.querySelectorAll(i),method=rules[i],matchesLength=matches.length;matchesLength>j;j++)method(matches[j]);return matches=elementOrHtml=rules=null,isString?element.innerHTML:element}var defaultRules={"a u":wysihtml5.dom.replaceWithChildNodes};return cleanPastedHTML}(),wysihtml5.quirks.ensureProperClearing=function(){var clearIfNecessary=function(){var element=this;setTimeout(function(){var innerHTML=element.innerHTML.toLowerCase();if("<p>&nbsp;</p>"==innerHTML||"<p>&nbsp;</p><p>&nbsp;</p>"==innerHTML)element.innerHTML=""},0)};return function(composer){wysihtml5.dom.observe(composer.element,["cut","keydown"],clearIfNecessary)}}(),function(wysihtml5){var TILDE_ESCAPED="%7E";wysihtml5.quirks.getCorrectInnerHTML=function(element){var innerHTML=element.innerHTML;if(-1===innerHTML.indexOf(TILDE_ESCAPED))return innerHTML;var elementsWithTilde=element.querySelectorAll("[href*='~'], [src*='~']"),url,urlToSearch,length,i;for(i=0,length=elementsWithTilde.length;length>i;i++)url=elementsWithTilde[i].href||elementsWithTilde[i].src,urlToSearch=wysihtml5.lang.string(url).replace("~").by(TILDE_ESCAPED),innerHTML=wysihtml5.lang.string(innerHTML).replace(urlToSearch).by(url);return innerHTML}}(wysihtml5),function(wysihtml5){var CLASS_NAME="wysihtml5-quirks-redraw";wysihtml5.quirks.redraw=function(element){wysihtml5.dom.addClass(element,CLASS_NAME),wysihtml5.dom.removeClass(element,CLASS_NAME);try{var doc=element.ownerDocument;doc.execCommand("italic",!1,null),doc.execCommand("italic",!1,null)}catch(e){}}}(wysihtml5),function(wysihtml5){function _getCumulativeOffsetTop(element){var top=0;if(element.parentNode)do top+=element.offsetTop||0,element=element.offsetParent;while(element);return top}var dom=wysihtml5.dom;wysihtml5.Selection=Base.extend({constructor:function(editor){rangy.init(),this.editor=editor,this.composer=editor.composer,this.doc=this.composer.doc},getBookmark:function(){var range=this.getRange();return range&&range.cloneRange()},setBookmark:function(bookmark){if(bookmark)this.setSelection(bookmark)},setBefore:function(node){var range=rangy.createRange(this.doc);return range.setStartBefore(node),range.setEndBefore(node),this.setSelection(range)},setAfter:function(node){var range=rangy.createRange(this.doc);return range.setStartAfter(node),range.setEndAfter(node),this.setSelection(range)},selectNode:function(node,avoidInvisibleSpace){var range=rangy.createRange(this.doc),isElement=node.nodeType===wysihtml5.ELEMENT_NODE,canHaveHTML="canHaveHTML"in node?node.canHaveHTML:"IMG"!==node.nodeName,content=isElement?node.innerHTML:node.data,isEmpty=""===content||content===wysihtml5.INVISIBLE_SPACE,displayStyle=dom.getStyle("display").from(node),isBlockElement="block"===displayStyle||"list-item"===displayStyle;if(isEmpty&&isElement&&canHaveHTML&&!avoidInvisibleSpace)try{node.innerHTML=wysihtml5.INVISIBLE_SPACE}catch(e){}if(canHaveHTML)range.selectNodeContents(node);else range.selectNode(node);if(canHaveHTML&&isEmpty&&isElement)range.collapse(isBlockElement);else if(canHaveHTML&&isEmpty)range.setStartAfter(node),range.setEndAfter(node);this.setSelection(range)},getSelectedNode:function(controlRange){var selection,range;if(controlRange&&this.doc.selection&&"Control"===this.doc.selection.type)if(range=this.doc.selection.createRange(),range&&range.length)return range.item(0);if(selection=this.getSelection(this.doc),selection.focusNode===selection.anchorNode)return selection.focusNode;else return range=this.getRange(this.doc),range?range.commonAncestorContainer:this.doc.body},executeAndRestore:function(method,restoreScrollPosition){var body=this.doc.body,oldScrollTop=restoreScrollPosition&&body.scrollTop,oldScrollLeft=restoreScrollPosition&&body.scrollLeft,className="_wysihtml5-temp-placeholder",placeholderHtml='<span class="'+className+'">'+wysihtml5.INVISIBLE_SPACE+"</span>",range=this.getRange(this.doc),caretPlaceholder,newCaretPlaceholder,nextSibling,node,newRange;if(!range)return void method(body,body);if(wysihtml5.browser.hasInsertNodeIssue())this.doc.execCommand("insertHTML",!1,placeholderHtml);else node=range.createContextualFragment(placeholderHtml),range.insertNode(node);try{method(range.startContainer,range.endContainer)}catch(e){setTimeout(function(){throw e},0)}if(caretPlaceholder=this.doc.querySelector("."+className)){if(newRange=rangy.createRange(this.doc),nextSibling=caretPlaceholder.nextSibling,wysihtml5.browser.hasInsertNodeIssue()&&nextSibling&&"BR"===nextSibling.nodeName)newCaretPlaceholder=this.doc.createTextNode(wysihtml5.INVISIBLE_SPACE),dom.insert(newCaretPlaceholder).after(caretPlaceholder),newRange.setStartBefore(newCaretPlaceholder),newRange.setEndBefore(newCaretPlaceholder);else newRange.selectNode(caretPlaceholder),newRange.deleteContents();this.setSelection(newRange)}else body.focus();if(restoreScrollPosition)body.scrollTop=oldScrollTop,body.scrollLeft=oldScrollLeft;try{caretPlaceholder.parentNode.removeChild(caretPlaceholder)}catch(e2){}},executeAndRestoreSimple:function(method){var range=this.getRange(),body=this.doc.body,newRange,firstNode,lastNode,textNodes,rangeBackup;if(!range)return void method(body,body);textNodes=range.getNodes([3]),firstNode=textNodes[0]||range.startContainer,lastNode=textNodes[textNodes.length-1]||range.endContainer,rangeBackup={collapsed:range.collapsed,startContainer:firstNode,startOffset:firstNode===range.startContainer?range.startOffset:0,endContainer:lastNode,endOffset:lastNode===range.endContainer?range.endOffset:lastNode.length};try{method(range.startContainer,range.endContainer)}catch(e){setTimeout(function(){throw e},0)}newRange=rangy.createRange(this.doc);try{newRange.setStart(rangeBackup.startContainer,rangeBackup.startOffset)}catch(e1){}try{newRange.setEnd(rangeBackup.endContainer,rangeBackup.endOffset)}catch(e2){}try{this.setSelection(newRange)}catch(e3){}},set:function(node,offset){var newRange=rangy.createRange(this.doc);newRange.setStart(node,offset||0),this.setSelection(newRange)},insertHTML:function(html){var range=rangy.createRange(this.doc),node=range.createContextualFragment(html),lastChild=node.lastChild;if(this.insertNode(node),lastChild)this.setAfter(lastChild)},insertNode:function(node){var range=this.getRange();if(range)range.insertNode(node)},surround:function(node){var range=this.getRange();if(range)try{range.surroundContents(node),this.selectNode(node)}catch(e){node.appendChild(range.extractContents()),range.insertNode(node)}},scrollIntoView:function(){var doc=this.doc,tolerance=5,hasScrollBars=doc.documentElement.scrollHeight>doc.documentElement.offsetHeight,tempElement=doc._wysihtml5ScrollIntoViewElement=doc._wysihtml5ScrollIntoViewElement||function(){var element=doc.createElement("span");return element.innerHTML=wysihtml5.INVISIBLE_SPACE,element}(),offsetTop;if(hasScrollBars)if(this.insertNode(tempElement),offsetTop=_getCumulativeOffsetTop(tempElement),tempElement.parentNode.removeChild(tempElement),offsetTop>=doc.body.scrollTop+doc.documentElement.offsetHeight-tolerance)doc.body.scrollTop=offsetTop},selectLine:function(){if(wysihtml5.browser.supportsSelectionModify())this._selectLine_W3C();else if(this.doc.selection)this._selectLine_MSIE()},_selectLine_W3C:function(){var win=this.doc.defaultView,selection=win.getSelection();selection.modify("extend","left","lineboundary"),selection.modify("extend","right","lineboundary")},_selectLine_MSIE:function(){var range=this.doc.selection.createRange(),rangeTop=range.boundingTop,scrollWidth=this.doc.body.scrollWidth,rangeBottom,rangeEnd,measureNode,i,j;if(range.moveToPoint){if(0===rangeTop)measureNode=this.doc.createElement("span"),this.insertNode(measureNode),rangeTop=measureNode.offsetTop,measureNode.parentNode.removeChild(measureNode);for(rangeTop+=1,i=-10;scrollWidth>i;i+=2)try{range.moveToPoint(i,rangeTop);break}catch(e1){}for(rangeBottom=rangeTop,rangeEnd=this.doc.selection.createRange(),j=scrollWidth;j>=0;j--)try{rangeEnd.moveToPoint(j,rangeBottom);break}catch(e2){}range.setEndPoint("EndToEnd",rangeEnd),range.select()}},getText:function(){var selection=this.getSelection();return selection?selection.toString():""},getNodes:function(nodeType,filter){var range=this.getRange();if(range)return range.getNodes([nodeType],filter);else return[]},getRange:function(){var selection=this.getSelection();return selection&&selection.rangeCount&&selection.getRangeAt(0)},getSelection:function(){return rangy.getSelection(this.doc.defaultView||this.doc.parentWindow)},setSelection:function(range){var win=this.doc.defaultView||this.doc.parentWindow,selection=rangy.getSelection(win);return selection.setSingleRange(range)}})}(wysihtml5),function(wysihtml5,rangy){function hasClass(el,cssClass,regExp){if(!el.className)return!1;var matchingClassNames=el.className.match(regExp)||[];return matchingClassNames[matchingClassNames.length-1]===cssClass}function addClass(el,cssClass,regExp){if(el.className)removeClass(el,regExp),el.className+=" "+cssClass;else el.className=cssClass}function removeClass(el,regExp){if(el.className)el.className=el.className.replace(regExp,"")}function hasSameClasses(el1,el2){return el1.className.replace(REG_EXP_WHITE_SPACE," ")==el2.className.replace(REG_EXP_WHITE_SPACE," ")}function replaceWithOwnChildren(el){for(var parent=el.parentNode;el.firstChild;)parent.insertBefore(el.firstChild,el);parent.removeChild(el)}function elementsHaveSameNonClassAttributes(el1,el2){if(el1.attributes.length!=el2.attributes.length)return!1;for(var i=0,len=el1.attributes.length,attr1,attr2,name;len>i;++i)if(attr1=el1.attributes[i],name=attr1.name,"class"!=name){if(attr2=el2.attributes.getNamedItem(name),attr1.specified!=attr2.specified)return!1;if(attr1.specified&&attr1.nodeValue!==attr2.nodeValue)return!1}return!0}function isSplitPoint(node,offset){if(rangy.dom.isCharacterDataNode(node))if(0===offset)return!!node.previousSibling;else if(offset==node.length)return!!node.nextSibling;else return!0;return offset>0&&offset<node.childNodes.length}function splitNodeAt(node,descendantNode,descendantOffset){var newNode;if(rangy.dom.isCharacterDataNode(descendantNode))if(0===descendantOffset)descendantOffset=rangy.dom.getNodeIndex(descendantNode),descendantNode=descendantNode.parentNode;else if(descendantOffset==descendantNode.length)descendantOffset=rangy.dom.getNodeIndex(descendantNode)+1,descendantNode=descendantNode.parentNode;else newNode=rangy.dom.splitDataNode(descendantNode,descendantOffset);if(!newNode){if(newNode=descendantNode.cloneNode(!1),newNode.id)newNode.removeAttribute("id");for(var child;child=descendantNode.childNodes[descendantOffset];)newNode.appendChild(child);rangy.dom.insertAfter(newNode,descendantNode)}return descendantNode==node?newNode:splitNodeAt(node,newNode.parentNode,rangy.dom.getNodeIndex(newNode))}function Merge(firstNode){this.isElementMerge=firstNode.nodeType==wysihtml5.ELEMENT_NODE,this.firstTextNode=this.isElementMerge?firstNode.lastChild:firstNode,this.textNodes=[this.firstTextNode]}function HTMLApplier(tagNames,cssClass,similarClassRegExp,normalize){this.tagNames=tagNames||[defaultTagName],this.cssClass=cssClass||"",this.similarClassRegExp=similarClassRegExp,this.normalize=normalize,this.applyToAnyTagName=!1}var defaultTagName="span",REG_EXP_WHITE_SPACE=/\s+/g;Merge.prototype={doMerge:function(){for(var textBits=[],textNode,parent,text,i=0,len=this.textNodes.length;len>i;++i)if(textNode=this.textNodes[i],parent=textNode.parentNode,textBits[i]=textNode.data,i)if(parent.removeChild(textNode),!parent.hasChildNodes())parent.parentNode.removeChild(parent);return this.firstTextNode.data=text=textBits.join(""),text},getLength:function(){for(var i=this.textNodes.length,len=0;i--;)len+=this.textNodes[i].length;return len},toString:function(){for(var textBits=[],i=0,len=this.textNodes.length;len>i;++i)textBits[i]="'"+this.textNodes[i].data+"'";return"[Merge("+textBits.join(",")+")]"}},HTMLApplier.prototype={getAncestorWithClass:function(node){for(var cssClassMatch;node;){if(cssClassMatch=this.cssClass?hasClass(node,this.cssClass,this.similarClassRegExp):!0,node.nodeType==wysihtml5.ELEMENT_NODE&&rangy.dom.arrayContains(this.tagNames,node.tagName.toLowerCase())&&cssClassMatch)return node;node=node.parentNode}return!1},postApply:function(textNodes,range){for(var firstNode=textNodes[0],lastNode=textNodes[textNodes.length-1],merges=[],currentMerge,rangeStartNode=firstNode,rangeEndNode=lastNode,rangeStartOffset=0,rangeEndOffset=lastNode.length,textNode,precedingTextNode,i=0,len=textNodes.length;len>i;++i)if(textNode=textNodes[i],precedingTextNode=this.getAdjacentMergeableTextNode(textNode.parentNode,!1)){if(!currentMerge)currentMerge=new Merge(precedingTextNode),merges.push(currentMerge);if(currentMerge.textNodes.push(textNode),textNode===firstNode)rangeStartNode=currentMerge.firstTextNode,rangeStartOffset=rangeStartNode.length;if(textNode===lastNode)rangeEndNode=currentMerge.firstTextNode,rangeEndOffset=currentMerge.getLength()}else currentMerge=null;var nextTextNode=this.getAdjacentMergeableTextNode(lastNode.parentNode,!0);if(nextTextNode){if(!currentMerge)currentMerge=new Merge(lastNode),merges.push(currentMerge);currentMerge.textNodes.push(nextTextNode)}if(merges.length){for(i=0,len=merges.length;len>i;++i)merges[i].doMerge();range.setStart(rangeStartNode,rangeStartOffset),range.setEnd(rangeEndNode,rangeEndOffset)}},getAdjacentMergeableTextNode:function(node,forward){var isTextNode=node.nodeType==wysihtml5.TEXT_NODE,el=isTextNode?node.parentNode:node,adjacentNode,propName=forward?"nextSibling":"previousSibling";if(isTextNode){if(adjacentNode=node[propName],adjacentNode&&adjacentNode.nodeType==wysihtml5.TEXT_NODE)return adjacentNode}else if(adjacentNode=el[propName],adjacentNode&&this.areElementsMergeable(node,adjacentNode))return adjacentNode[forward?"firstChild":"lastChild"];return null},areElementsMergeable:function(el1,el2){return rangy.dom.arrayContains(this.tagNames,(el1.tagName||"").toLowerCase())&&rangy.dom.arrayContains(this.tagNames,(el2.tagName||"").toLowerCase())&&hasSameClasses(el1,el2)&&elementsHaveSameNonClassAttributes(el1,el2)},createContainer:function(doc){var el=doc.createElement(this.tagNames[0]);if(this.cssClass)el.className=this.cssClass;return el},applyToTextNode:function(textNode){var parent=textNode.parentNode;if(1==parent.childNodes.length&&rangy.dom.arrayContains(this.tagNames,parent.tagName.toLowerCase())){if(this.cssClass)addClass(parent,this.cssClass,this.similarClassRegExp)}else{var el=this.createContainer(rangy.dom.getDocument(textNode));textNode.parentNode.insertBefore(el,textNode),el.appendChild(textNode)}},isRemovable:function(el){return rangy.dom.arrayContains(this.tagNames,el.tagName.toLowerCase())&&wysihtml5.lang.string(el.className).trim()==this.cssClass},undoToTextNode:function(textNode,range,ancestorWithClass){if(!range.containsNode(ancestorWithClass)){var ancestorRange=range.cloneRange();if(ancestorRange.selectNode(ancestorWithClass),ancestorRange.isPointInRange(range.endContainer,range.endOffset)&&isSplitPoint(range.endContainer,range.endOffset))splitNodeAt(ancestorWithClass,range.endContainer,range.endOffset),range.setEndAfter(ancestorWithClass);if(ancestorRange.isPointInRange(range.startContainer,range.startOffset)&&isSplitPoint(range.startContainer,range.startOffset))ancestorWithClass=splitNodeAt(ancestorWithClass,range.startContainer,range.startOffset)}if(this.similarClassRegExp)removeClass(ancestorWithClass,this.similarClassRegExp);if(this.isRemovable(ancestorWithClass))replaceWithOwnChildren(ancestorWithClass)},applyToRange:function(range){var textNodes=range.getNodes([wysihtml5.TEXT_NODE]);if(!textNodes.length)try{var node=this.createContainer(range.endContainer.ownerDocument);return range.surroundContents(node),void this.selectNode(range,node)}catch(e){}if(range.splitBoundaries(),textNodes=range.getNodes([wysihtml5.TEXT_NODE]),textNodes.length){for(var textNode,i=0,len=textNodes.length;len>i;++i)if(textNode=textNodes[i],!this.getAncestorWithClass(textNode))this.applyToTextNode(textNode);if(range.setStart(textNodes[0],0),textNode=textNodes[textNodes.length-1],range.setEnd(textNode,textNode.length),this.normalize)this.postApply(textNodes,range)}},undoToRange:function(range){var textNodes=range.getNodes([wysihtml5.TEXT_NODE]),textNode,ancestorWithClass;if(textNodes.length)range.splitBoundaries(),textNodes=range.getNodes([wysihtml5.TEXT_NODE]);else{var doc=range.endContainer.ownerDocument,node=doc.createTextNode(wysihtml5.INVISIBLE_SPACE);range.insertNode(node),range.selectNode(node),textNodes=[node]}for(var i=0,len=textNodes.length;len>i;++i)if(textNode=textNodes[i],ancestorWithClass=this.getAncestorWithClass(textNode))this.undoToTextNode(textNode,range,ancestorWithClass);if(1==len)this.selectNode(range,textNodes[0]);else if(range.setStart(textNodes[0],0),textNode=textNodes[textNodes.length-1],range.setEnd(textNode,textNode.length),this.normalize)this.postApply(textNodes,range)},selectNode:function(range,node){var isElement=node.nodeType===wysihtml5.ELEMENT_NODE,canHaveHTML="canHaveHTML"in node?node.canHaveHTML:!0,content=isElement?node.innerHTML:node.data,isEmpty=""===content||content===wysihtml5.INVISIBLE_SPACE;if(isEmpty&&isElement&&canHaveHTML)try{node.innerHTML=wysihtml5.INVISIBLE_SPACE}catch(e){}if(range.selectNodeContents(node),isEmpty&&isElement)range.collapse(!1);else if(isEmpty)range.setStartAfter(node),range.setEndAfter(node)},getTextSelectedByRange:function(textNode,range){var textRange=range.cloneRange();textRange.selectNodeContents(textNode);var intersectionRange=textRange.intersection(range),text=intersectionRange?intersectionRange.toString():"";return textRange.detach(),text},isAppliedToRange:function(range){var ancestors=[],ancestor,textNodes=range.getNodes([wysihtml5.TEXT_NODE]);if(!textNodes.length)return ancestor=this.getAncestorWithClass(range.startContainer),ancestor?[ancestor]:!1;for(var i=0,len=textNodes.length,selectedText;len>i;++i)if(selectedText=this.getTextSelectedByRange(textNodes[i],range),ancestor=this.getAncestorWithClass(textNodes[i]),""!==selectedText&&!ancestor)return!1;else ancestors.push(ancestor);return ancestors},toggleRange:function(range){if(this.isAppliedToRange(range))this.undoToRange(range);else this.applyToRange(range)}},wysihtml5.selection.HTMLApplier=HTMLApplier}(wysihtml5,rangy),wysihtml5.Commands=Base.extend({constructor:function(editor){this.editor=editor,this.composer=editor.composer,this.doc=this.composer.doc},support:function(command){return wysihtml5.browser.supportsCommand(this.doc,command)},exec:function(command,value){var obj=wysihtml5.commands[command],args=wysihtml5.lang.array(arguments).get(),method=obj&&obj.exec,result=null;if(this.editor.fire("beforecommand:composer"),method)args.unshift(this.composer),result=method.apply(obj,args);else try{result=this.doc.execCommand(command,!1,value)}catch(e){}if("styleWithCSS"!=command){if(this.composer.parent.synchronizer)this.composer.parent.synchronizer.sync();this.editor.fire("aftercommand:composer")}return result},state:function(command,commandValue){var obj=wysihtml5.commands[command],args=wysihtml5.lang.array(arguments).get(),method=obj&&obj.state;if(method)return args.unshift(this.composer),method.apply(obj,args);else try{return this.doc.queryCommandState(command)}catch(e){return!1}}}),wysihtml5.commands.bold={exec:function(composer,command){return wysihtml5.commands.formatInline.exec(composer,command,"strong")},state:function(composer,command){return wysihtml5.commands.formatInline.state(composer,command,"strong")}},function(wysihtml5){function _removeFormat(composer,anchors){for(var length=anchors.length,i=0,anchor,codeElement,textContent;length>i;i++)if(anchor=anchors[i],codeElement=dom.getParentElement(anchor,{nodeName:"code"}),textContent=dom.getTextContent(anchor),textContent.match(dom.autoLink.URL_REG_EXP)&&!codeElement)codeElement=dom.renameElement(anchor,"code");else dom.replaceWithChildNodes(anchor)}function _format(composer,attributes){var doc=composer.doc,tempClass="_wysihtml5-temp-"+ +new Date,tempClassRegExp=/non-matching-class/g,i=0,length,anchors,anchor,hasElementChild,isEmpty,elementToSetCaretAfter,textContent,whiteSpace,j;for(wysihtml5.commands.formatInline.exec(composer,undef,NODE_NAME,tempClass,tempClassRegExp),anchors=doc.querySelectorAll(NODE_NAME+"."+tempClass),length=anchors.length;length>i;i++){anchor=anchors[i],anchor.removeAttribute("class");for(j in attributes)anchor.setAttribute(j,attributes[j])}if(elementToSetCaretAfter=anchor,1===length)if(textContent=dom.getTextContent(anchor),hasElementChild=!!anchor.querySelector("*"),isEmpty=""===textContent||textContent===wysihtml5.INVISIBLE_SPACE,!hasElementChild&&isEmpty)dom.setTextContent(anchor,attributes.text||anchor.href),whiteSpace=doc.createTextNode(" "),composer.selection.setAfter(anchor),dom.insert(whiteSpace).after(anchor),elementToSetCaretAfter=whiteSpace;composer.selection.setAfter(elementToSetCaretAfter)}var undef,NODE_NAME="A",dom=wysihtml5.dom;wysihtml5.commands.createLink={exec:function(composer,command,value){var anchors=this.state(composer,command);if(anchors)composer.selection.executeAndRestore(function(){_removeFormat(composer,anchors)});else value="object"==typeof value?value:{href:value},_format(composer,value);composer.parent.synchronizer.sync()},state:function(composer,command){return wysihtml5.commands.formatInline.state(composer,command,"A")}}}(wysihtml5),function(wysihtml5){var undef,REG_EXP=/wysiwyg-font-size-[0-9a-z\-]+/g;wysihtml5.commands.fontSize={exec:function(composer,command,size){return wysihtml5.commands.formatInline.exec(composer,command,"span","wysiwyg-font-size-"+size,REG_EXP)},state:function(composer,command,size){return wysihtml5.commands.formatInline.state(composer,command,"span","wysiwyg-font-size-"+size,REG_EXP)},value:function(){return undef}}}(wysihtml5),function(wysihtml5){var REG_EXP=/wysiwyg-color-[0-9a-z]+/g;wysihtml5.commands.foreColor={exec:function(composer,command,color){return wysihtml5.commands.formatInline.exec(composer,command,"span","wysiwyg-color-"+color,REG_EXP)},state:function(composer,command,color){return wysihtml5.commands.formatInline.state(composer,command,"span","wysiwyg-color-"+color,REG_EXP)}}}(wysihtml5),function(wysihtml5){function _addClass(element,className,classRegExp){if(element.className)_removeClass(element,classRegExp),element.className+=" "+className;else element.className=className}function _removeClass(element,classRegExp){element.className=element.className.replace(classRegExp,"")}function _isBlankTextNode(node){return node.nodeType===wysihtml5.TEXT_NODE&&!wysihtml5.lang.string(node.data).trim()}function _getPreviousSiblingThatIsNotBlank(node){for(var previousSibling=node.previousSibling;previousSibling&&_isBlankTextNode(previousSibling);)previousSibling=previousSibling.previousSibling;return previousSibling}function _getNextSiblingThatIsNotBlank(node){for(var nextSibling=node.nextSibling;nextSibling&&_isBlankTextNode(nextSibling);)nextSibling=nextSibling.nextSibling;return nextSibling}function _addLineBreakBeforeAndAfter(node){var doc=node.ownerDocument,nextSibling=_getNextSiblingThatIsNotBlank(node),previousSibling=_getPreviousSiblingThatIsNotBlank(node);if(nextSibling&&!_isLineBreakOrBlockElement(nextSibling))node.parentNode.insertBefore(doc.createElement("br"),nextSibling);if(previousSibling&&!_isLineBreakOrBlockElement(previousSibling))node.parentNode.insertBefore(doc.createElement("br"),node)}function _removeLineBreakBeforeAndAfter(node){var nextSibling=_getNextSiblingThatIsNotBlank(node),previousSibling=_getPreviousSiblingThatIsNotBlank(node);if(nextSibling&&_isLineBreak(nextSibling))nextSibling.parentNode.removeChild(nextSibling);if(previousSibling&&_isLineBreak(previousSibling))previousSibling.parentNode.removeChild(previousSibling)}function _removeLastChildIfLineBreak(node){var lastChild=node.lastChild;if(lastChild&&_isLineBreak(lastChild))lastChild.parentNode.removeChild(lastChild)}function _isLineBreak(node){return"BR"===node.nodeName}function _isLineBreakOrBlockElement(element){if(_isLineBreak(element))return!0;if("block"===dom.getStyle("display").from(element))return!0;else return!1}function _execCommand(doc,command,nodeName,className){var eventListener;if(className)eventListener=dom.observe(doc,"DOMNodeInserted",function(event){var target=event.target,displayStyle;if(target.nodeType===wysihtml5.ELEMENT_NODE)if(displayStyle=dom.getStyle("display").from(target),"inline"!==displayStyle.substr(0,6))target.className+=" "+className});if(doc.execCommand(command,!1,nodeName),eventListener)eventListener.stop()}function _selectLineAndWrap(composer,element){composer.selection.selectLine(),composer.selection.surround(element),_removeLineBreakBeforeAndAfter(element),_removeLastChildIfLineBreak(element),composer.selection.selectNode(element,wysihtml5.browser.displaysCaretInEmptyContentEditableCorrectly())}function _hasClasses(element){return!!wysihtml5.lang.string(element.className).trim()}var dom=wysihtml5.dom,BLOCK_ELEMENTS_GROUP=["H1","H2","H3","H4","H5","H6","P","BLOCKQUOTE","DIV"];wysihtml5.commands.formatBlock={exec:function(composer,command,nodeName,className,classRegExp){var doc=composer.doc,blockElement=this.state(composer,command,nodeName,className,classRegExp),useLineBreaks=composer.config.useLineBreaks,defaultNodeName=useLineBreaks?"DIV":"P",selectedNode;if(nodeName="string"==typeof nodeName?nodeName.toUpperCase():nodeName,blockElement)return void composer.selection.executeAndRestoreSimple(function(){if(classRegExp)_removeClass(blockElement,classRegExp);var hasClasses=_hasClasses(blockElement);if(!hasClasses&&(useLineBreaks||"P"===nodeName))_addLineBreakBeforeAndAfter(blockElement),dom.replaceWithChildNodes(blockElement);else dom.renameElement(blockElement,"P"===nodeName?"DIV":defaultNodeName)});if(null===nodeName||wysihtml5.lang.array(BLOCK_ELEMENTS_GROUP).contains(nodeName))if(selectedNode=composer.selection.getSelectedNode(),blockElement=dom.getParentElement(selectedNode,{nodeName:BLOCK_ELEMENTS_GROUP}))return void composer.selection.executeAndRestore(function(){if(nodeName)blockElement=dom.renameElement(blockElement,nodeName);if(className)_addClass(blockElement,className,classRegExp)});if(composer.commands.support(command))return void _execCommand(doc,command,nodeName||defaultNodeName,className);if(blockElement=doc.createElement(nodeName||defaultNodeName),className)blockElement.className=className;_selectLineAndWrap(composer,blockElement)},state:function(composer,command,nodeName,className,classRegExp){nodeName="string"==typeof nodeName?nodeName.toUpperCase():nodeName;var selectedNode=composer.selection.getSelectedNode();return dom.getParentElement(selectedNode,{nodeName:nodeName,className:className,classRegExp:classRegExp})}}}(wysihtml5),function(wysihtml5){function _getTagNames(tagName){var alias=ALIAS_MAPPING[tagName];return alias?[tagName.toLowerCase(),alias.toLowerCase()]:[tagName.toLowerCase()]}function _getApplier(tagName,className,classRegExp){var identifier=tagName+":"+className;if(!htmlApplier[identifier])htmlApplier[identifier]=new wysihtml5.selection.HTMLApplier(_getTagNames(tagName),className,classRegExp,!0);return htmlApplier[identifier]}var ALIAS_MAPPING={strong:"b",em:"i",b:"strong",i:"em"},htmlApplier={};wysihtml5.commands.formatInline={exec:function(composer,command,tagName,className,classRegExp){var range=composer.selection.getRange();if(!range)return!1;else return _getApplier(tagName,className,classRegExp).toggleRange(range),void composer.selection.setSelection(range)},state:function(composer,command,tagName,className,classRegExp){var doc=composer.doc,aliasTagName=ALIAS_MAPPING[tagName]||tagName,range;if(!wysihtml5.dom.hasElementWithTagName(doc,tagName)&&!wysihtml5.dom.hasElementWithTagName(doc,aliasTagName))return!1;if(className&&!wysihtml5.dom.hasElementWithClassName(doc,className))return!1;if(range=composer.selection.getRange(),!range)return!1;else return _getApplier(tagName,className,classRegExp).isAppliedToRange(range)}}}(wysihtml5),wysihtml5.commands.insertHTML={exec:function(composer,command,html){if(composer.commands.support(command))composer.doc.execCommand(command,!1,html);else composer.selection.insertHTML(html);composer.parent.synchronizer.sync()},state:function(){return!1}},function(wysihtml5){var NODE_NAME="IMG";wysihtml5.commands.insertImage={exec:function(composer,command,value){value="object"==typeof value?value:{src:value};
var doc=composer.doc,image=this.state(composer),textNode,i,parent;if(image){if(composer.selection.setBefore(image),parent=image.parentNode,parent.removeChild(image),wysihtml5.dom.removeEmptyTextNodes(parent),"A"===parent.nodeName&&!parent.firstChild)composer.selection.setAfter(parent),parent.parentNode.removeChild(parent);return void wysihtml5.quirks.redraw(composer.element)}image=doc.createElement(NODE_NAME);for(i in value){if("className"===i)i="class";image.setAttribute(i,value[i])}if(composer.selection.insertNode(image),wysihtml5.browser.hasProblemsSettingCaretAfterImg())textNode=doc.createTextNode(wysihtml5.INVISIBLE_SPACE),composer.selection.insertNode(textNode),composer.selection.setAfter(textNode);else composer.selection.setAfter(image);composer.parent.synchronizer.sync()},state:function(composer){var doc=composer.doc,selectedNode,text,imagesInSelection;if(!wysihtml5.dom.hasElementWithTagName(doc,NODE_NAME))return!1;if(selectedNode=composer.selection.getSelectedNode(),!selectedNode)return!1;if(selectedNode.nodeName===NODE_NAME)return selectedNode;if(selectedNode.nodeType!==wysihtml5.ELEMENT_NODE)return!1;if(text=composer.selection.getText(),text=wysihtml5.lang.string(text).trim())return!1;if(imagesInSelection=composer.selection.getNodes(wysihtml5.ELEMENT_NODE,function(node){return"IMG"===node.nodeName}),1!==imagesInSelection.length)return!1;else return imagesInSelection[0]}}}(wysihtml5),function(wysihtml5){var LINE_BREAK="<br>"+(wysihtml5.browser.needsSpaceAfterLineBreak()?" ":"");wysihtml5.commands.insertLineBreak={exec:function(composer,command){if(composer.commands.support(command)){if(composer.doc.execCommand(command,!1,null),!wysihtml5.browser.autoScrollsToCaret())composer.selection.scrollIntoView()}else composer.commands.exec("insertHTML",LINE_BREAK)},state:function(){return!1}}}(wysihtml5),wysihtml5.commands.insertOrderedList={exec:function(composer,command){var doc=composer.doc,selectedNode=composer.selection.getSelectedNode(),list=wysihtml5.dom.getParentElement(selectedNode,{nodeName:"OL"}),otherList=wysihtml5.dom.getParentElement(selectedNode,{nodeName:"UL"}),tempClassName="_wysihtml5-temp-"+(new Date).getTime(),isEmpty,tempElement;if(!list&&!otherList&&composer.commands.support(command))return void doc.execCommand(command,!1,null);if(list)composer.selection.executeAndRestore(function(){wysihtml5.dom.resolveList(list,composer.config.useLineBreaks)});else if(otherList)composer.selection.executeAndRestore(function(){wysihtml5.dom.renameElement(otherList,"ol")});else if(composer.commands.exec("formatBlock","div",tempClassName),tempElement=doc.querySelector("."+tempClassName),isEmpty=""===tempElement.innerHTML||tempElement.innerHTML===wysihtml5.INVISIBLE_SPACE||"<br>"===tempElement.innerHTML,composer.selection.executeAndRestore(function(){list=wysihtml5.dom.convertToList(tempElement,"ol")}),isEmpty)composer.selection.selectNode(list.querySelector("li"),!0)},state:function(composer){var selectedNode=composer.selection.getSelectedNode();return wysihtml5.dom.getParentElement(selectedNode,{nodeName:"OL"})}},wysihtml5.commands.insertUnorderedList={exec:function(composer,command){var doc=composer.doc,selectedNode=composer.selection.getSelectedNode(),list=wysihtml5.dom.getParentElement(selectedNode,{nodeName:"UL"}),otherList=wysihtml5.dom.getParentElement(selectedNode,{nodeName:"OL"}),tempClassName="_wysihtml5-temp-"+(new Date).getTime(),isEmpty,tempElement;if(!list&&!otherList&&composer.commands.support(command))return void doc.execCommand(command,!1,null);if(list)composer.selection.executeAndRestore(function(){wysihtml5.dom.resolveList(list,composer.config.useLineBreaks)});else if(otherList)composer.selection.executeAndRestore(function(){wysihtml5.dom.renameElement(otherList,"ul")});else if(composer.commands.exec("formatBlock","div",tempClassName),tempElement=doc.querySelector("."+tempClassName),isEmpty=""===tempElement.innerHTML||tempElement.innerHTML===wysihtml5.INVISIBLE_SPACE||"<br>"===tempElement.innerHTML,composer.selection.executeAndRestore(function(){list=wysihtml5.dom.convertToList(tempElement,"ul")}),isEmpty)composer.selection.selectNode(list.querySelector("li"),!0)},state:function(composer){var selectedNode=composer.selection.getSelectedNode();return wysihtml5.dom.getParentElement(selectedNode,{nodeName:"UL"})}},wysihtml5.commands.italic={exec:function(composer,command){return wysihtml5.commands.formatInline.exec(composer,command,"em")},state:function(composer,command){return wysihtml5.commands.formatInline.state(composer,command,"em")}},function(wysihtml5){var CLASS_NAME="wysiwyg-text-align-center",REG_EXP=/wysiwyg-text-align-[0-9a-z]+/g;wysihtml5.commands.justifyCenter={exec:function(composer,command){return wysihtml5.commands.formatBlock.exec(composer,"formatBlock",null,CLASS_NAME,REG_EXP)},state:function(composer,command){return wysihtml5.commands.formatBlock.state(composer,"formatBlock",null,CLASS_NAME,REG_EXP)}}}(wysihtml5),function(wysihtml5){var CLASS_NAME="wysiwyg-text-align-left",REG_EXP=/wysiwyg-text-align-[0-9a-z]+/g;wysihtml5.commands.justifyLeft={exec:function(composer,command){return wysihtml5.commands.formatBlock.exec(composer,"formatBlock",null,CLASS_NAME,REG_EXP)},state:function(composer,command){return wysihtml5.commands.formatBlock.state(composer,"formatBlock",null,CLASS_NAME,REG_EXP)}}}(wysihtml5),function(wysihtml5){var CLASS_NAME="wysiwyg-text-align-right",REG_EXP=/wysiwyg-text-align-[0-9a-z]+/g;wysihtml5.commands.justifyRight={exec:function(composer,command){return wysihtml5.commands.formatBlock.exec(composer,"formatBlock",null,CLASS_NAME,REG_EXP)},state:function(composer,command){return wysihtml5.commands.formatBlock.state(composer,"formatBlock",null,CLASS_NAME,REG_EXP)}}}(wysihtml5),function(wysihtml5){var CLASS_NAME="wysiwyg-text-align-justify",REG_EXP=/wysiwyg-text-align-[0-9a-z]+/g;wysihtml5.commands.justifyFull={exec:function(composer,command){return wysihtml5.commands.formatBlock.exec(composer,"formatBlock",null,CLASS_NAME,REG_EXP)},state:function(composer,command){return wysihtml5.commands.formatBlock.state(composer,"formatBlock",null,CLASS_NAME,REG_EXP)}}}(wysihtml5),wysihtml5.commands.redo={exec:function(composer){return composer.undoManager.redo()},state:function(composer){return!1}},wysihtml5.commands.underline={exec:function(composer,command){return wysihtml5.commands.formatInline.exec(composer,command,"u")},state:function(composer,command){return wysihtml5.commands.formatInline.state(composer,command,"u")}},wysihtml5.commands.undo={exec:function(composer){return composer.undoManager.undo()},state:function(composer){return!1}},function(wysihtml5){function cleanTempElements(doc){for(var tempElement;tempElement=doc.querySelector("._wysihtml5-temp");)tempElement.parentNode.removeChild(tempElement)}var Z_KEY=90,Y_KEY=89,BACKSPACE_KEY=8,DELETE_KEY=46,MAX_HISTORY_ENTRIES=25,DATA_ATTR_NODE="data-wysihtml5-selection-node",DATA_ATTR_OFFSET="data-wysihtml5-selection-offset",UNDO_HTML='<span id="_wysihtml5-undo" class="_wysihtml5-temp">'+wysihtml5.INVISIBLE_SPACE+"</span>",REDO_HTML='<span id="_wysihtml5-redo" class="_wysihtml5-temp">'+wysihtml5.INVISIBLE_SPACE+"</span>",dom=wysihtml5.dom;wysihtml5.UndoManager=wysihtml5.lang.Dispatcher.extend({constructor:function(editor){this.editor=editor,this.composer=editor.composer,this.element=this.composer.element,this.position=0,this.historyStr=[],this.historyDom=[],this.transact(),this._observe()},_observe:function(){var that=this,doc=this.composer.sandbox.getDocument(),lastKey;if(dom.observe(this.element,"keydown",function(event){if(!event.altKey&&(event.ctrlKey||event.metaKey)){var keyCode=event.keyCode,isUndo=keyCode===Z_KEY&&!event.shiftKey,isRedo=keyCode===Z_KEY&&event.shiftKey||keyCode===Y_KEY;if(isUndo)that.undo(),event.preventDefault();else if(isRedo)that.redo(),event.preventDefault()}}),dom.observe(this.element,"keydown",function(event){var keyCode=event.keyCode;if(keyCode!==lastKey)if(lastKey=keyCode,keyCode===BACKSPACE_KEY||keyCode===DELETE_KEY)that.transact()}),wysihtml5.browser.hasUndoInContextMenu()){var interval,observed,cleanUp=function(){cleanTempElements(doc),clearInterval(interval)};dom.observe(this.element,"contextmenu",function(){if(cleanUp(),that.composer.selection.executeAndRestoreSimple(function(){if(that.element.lastChild)that.composer.selection.setAfter(that.element.lastChild);doc.execCommand("insertHTML",!1,UNDO_HTML),doc.execCommand("insertHTML",!1,REDO_HTML),doc.execCommand("undo",!1,null)}),interval=setInterval(function(){if(doc.getElementById("_wysihtml5-redo"))cleanUp(),that.redo();else if(!doc.getElementById("_wysihtml5-undo"))cleanUp(),that.undo()},400),!observed)observed=!0,dom.observe(document,"mousedown",cleanUp),dom.observe(doc,["mousedown","paste","cut","copy"],cleanUp)})}this.editor.on("newword:composer",function(){that.transact()}).on("beforecommand:composer",function(){that.transact()})},transact:function(){var previousHtml=this.historyStr[this.position-1],currentHtml=this.composer.getValue();if(currentHtml!==previousHtml){var length=this.historyStr.length=this.historyDom.length=this.position;if(length>MAX_HISTORY_ENTRIES)this.historyStr.shift(),this.historyDom.shift(),this.position--;this.position++;var range=this.composer.selection.getRange(),node=range.startContainer||this.element,offset=range.startOffset||0,element,position;if(node.nodeType===wysihtml5.ELEMENT_NODE)element=node;else element=node.parentNode,position=this.getChildNodeIndex(element,node);if(element.setAttribute(DATA_ATTR_OFFSET,offset),"undefined"!=typeof position)element.setAttribute(DATA_ATTR_NODE,position);var clone=this.element.cloneNode(!!currentHtml);this.historyDom.push(clone),this.historyStr.push(currentHtml),element.removeAttribute(DATA_ATTR_OFFSET),element.removeAttribute(DATA_ATTR_NODE)}},undo:function(){if(this.transact(),this.undoPossible())this.set(this.historyDom[--this.position-1]),this.editor.fire("undo:composer")},redo:function(){if(this.redoPossible())this.set(this.historyDom[++this.position-1]),this.editor.fire("redo:composer")},undoPossible:function(){return this.position>1},redoPossible:function(){return this.position<this.historyStr.length},set:function(historyEntry){this.element.innerHTML="";for(var i=0,childNodes=historyEntry.childNodes,length=historyEntry.childNodes.length;length>i;i++)this.element.appendChild(childNodes[i].cloneNode(!0));var offset,node,position;if(historyEntry.hasAttribute(DATA_ATTR_OFFSET))offset=historyEntry.getAttribute(DATA_ATTR_OFFSET),position=historyEntry.getAttribute(DATA_ATTR_NODE),node=this.element;else node=this.element.querySelector("["+DATA_ATTR_OFFSET+"]")||this.element,offset=node.getAttribute(DATA_ATTR_OFFSET),position=node.getAttribute(DATA_ATTR_NODE),node.removeAttribute(DATA_ATTR_OFFSET),node.removeAttribute(DATA_ATTR_NODE);if(null!==position)node=this.getChildNodeByIndex(node,+position);this.composer.selection.set(node,offset)},getChildNodeIndex:function(parent,child){for(var i=0,childNodes=parent.childNodes,length=childNodes.length;length>i;i++)if(childNodes[i]===child)return i},getChildNodeByIndex:function(parent,index){return parent.childNodes[index]}})}(wysihtml5),wysihtml5.views.View=Base.extend({constructor:function(parent,textareaElement,config){this.parent=parent,this.element=textareaElement,this.config=config,this._observeViewChange()},_observeViewChange:function(){var that=this;this.parent.on("beforeload",function(){that.parent.on("change_view",function(view,focus){if(view===that.name){if(that.parent.currentView=that,that.show(),focus)setTimeout(function(){that.focus()},0)}else that.hide()})})},focus:function(){if(this.element.ownerDocument.querySelector(":focus")!==this.element)try{this.element.focus()}catch(e){}},hide:function(){this.element.style.display="none"},show:function(){this.element.style.display=""},disable:function(){this.element.setAttribute("disabled","disabled")},enable:function(){this.element.removeAttribute("disabled")}}),function(wysihtml5){var dom=wysihtml5.dom,browser=wysihtml5.browser;wysihtml5.views.Composer=wysihtml5.views.View.extend({name:"composer",CARET_HACK:"<br>",constructor:function(parent,textareaElement,config){this.base(parent,textareaElement,config),this.textarea=this.parent.textarea,this._initSandbox()},clear:function(){this.element.innerHTML=browser.displaysCaretInEmptyContentEditableCorrectly()?"":this.CARET_HACK},getValue:function(parse){var value=this.isEmpty()?"":wysihtml5.quirks.getCorrectInnerHTML(this.element);if(parse)value=this.parent.parse(value);return value=wysihtml5.lang.string(value).replace(wysihtml5.INVISIBLE_SPACE).by("")},setValue:function(html,parse){if(parse)html=this.parent.parse(html);try{this.element.innerHTML=html}catch(e){this.element.innerText=html}},show:function(){if(this.iframe.style.display=this._displayStyle||"",!this.textarea.element.disabled)this.disable(),this.enable()},hide:function(){if(this._displayStyle=dom.getStyle("display").from(this.iframe),"none"===this._displayStyle)this._displayStyle=null;this.iframe.style.display="none"},disable:function(){this.parent.fire("disable:composer"),this.element.removeAttribute("contentEditable")},enable:function(){this.parent.fire("enable:composer"),this.element.setAttribute("contentEditable","true")},focus:function(setToEnd){if(wysihtml5.browser.doesAsyncFocus()&&this.hasPlaceholderSet())this.clear();this.base();var lastChild=this.element.lastChild;if(setToEnd&&lastChild)if("BR"===lastChild.nodeName)this.selection.setBefore(this.element.lastChild);else this.selection.setAfter(this.element.lastChild)},getTextContent:function(){return dom.getTextContent(this.element)},hasPlaceholderSet:function(){return this.getTextContent()==this.textarea.element.getAttribute("placeholder")&&this.placeholderSet},isEmpty:function(){var innerHTML=this.element.innerHTML.toLowerCase();return""===innerHTML||"<br>"===innerHTML||"<p></p>"===innerHTML||"<p><br></p>"===innerHTML||this.hasPlaceholderSet()},_initSandbox:function(){var that=this;this.sandbox=new dom.Sandbox(function(){that._create()},{stylesheets:this.config.stylesheets}),this.iframe=this.sandbox.getIframe();var textareaElement=this.textarea.element;if(dom.insert(this.iframe).after(textareaElement),textareaElement.form){var hiddenField=document.createElement("input");hiddenField.type="hidden",hiddenField.name="_wysihtml5_mode",hiddenField.value=1,dom.insert(hiddenField).after(textareaElement)}},_create:function(){var that=this;if(this.doc=this.sandbox.getDocument(),this.element=this.doc.body,this.textarea=this.parent.textarea,this.element.innerHTML=this.textarea.getValue(!0),this.selection=new wysihtml5.Selection(this.parent),this.commands=new wysihtml5.Commands(this.parent),dom.copyAttributes(["className","spellcheck","title","lang","dir","accessKey"]).from(this.textarea.element).to(this.element),dom.addClass(this.element,this.config.composerClassName),this.config.style)this.style();this.observe();var name=this.config.name;if(name)dom.addClass(this.element,name),dom.addClass(this.iframe,name);if(this.enable(),this.textarea.element.disabled)this.disable();var placeholderText="string"==typeof this.config.placeholder?this.config.placeholder:this.textarea.element.getAttribute("placeholder");if(placeholderText)dom.simulatePlaceholder(this.parent,this,placeholderText);if(this.commands.exec("styleWithCSS",!1),this._initAutoLinking(),this._initObjectResizing(),this._initUndoManager(),this._initLineBreaking(),(this.textarea.element.hasAttribute("autofocus")||document.querySelector(":focus")==this.textarea.element)&&!browser.isIos())setTimeout(function(){that.focus(!0)},100);if(!browser.clearsContentEditableCorrectly())wysihtml5.quirks.ensureProperClearing(this);if(this.initSync&&this.config.sync)this.initSync();this.textarea.hide(),this.parent.fire("beforeload").fire("load")},_initAutoLinking:function(){var that=this,supportsDisablingOfAutoLinking=browser.canDisableAutoLinking(),supportsAutoLinking=browser.doesAutoLinkingInContentEditable();if(supportsDisablingOfAutoLinking)this.commands.exec("autoUrlDetect",!1);if(this.config.autoLink){if(!supportsAutoLinking||supportsAutoLinking&&supportsDisablingOfAutoLinking)this.parent.on("newword:composer",function(){if(dom.getTextContent(that.element).match(dom.autoLink.URL_REG_EXP))that.selection.executeAndRestore(function(startContainer,endContainer){dom.autoLink(endContainer.parentNode)})}),dom.observe(this.element,"blur",function(){dom.autoLink(that.element)});var links=this.sandbox.getDocument().getElementsByTagName("a"),urlRegExp=dom.autoLink.URL_REG_EXP,getTextContent=function(element){var textContent=wysihtml5.lang.string(dom.getTextContent(element)).trim();if("www."===textContent.substr(0,4))textContent="http://"+textContent;return textContent};dom.observe(this.element,"keydown",function(event){if(links.length){var selectedNode=that.selection.getSelectedNode(event.target.ownerDocument),link=dom.getParentElement(selectedNode,{nodeName:"A"},4),textContent;if(link)textContent=getTextContent(link),setTimeout(function(){var newTextContent=getTextContent(link);if(newTextContent!==textContent)if(newTextContent.match(urlRegExp))link.setAttribute("href",newTextContent)},0)}})}},_initObjectResizing:function(){if(this.commands.exec("enableObjectResizing",!0),browser.supportsEvent("resizeend")){var properties=["width","height"],propertiesLength=properties.length,element=this.element;dom.observe(element,"resizeend",function(event){var target=event.target||event.srcElement,style=target.style,i=0,property;if("IMG"===target.nodeName){for(;propertiesLength>i;i++)if(property=properties[i],style[property])target.setAttribute(property,parseInt(style[property],10)),style[property]="";wysihtml5.quirks.redraw(element)}})}},_initUndoManager:function(){this.undoManager=new wysihtml5.UndoManager(this.parent)},_initLineBreaking:function(){function adjust(selectedNode){var parentElement=dom.getParentElement(selectedNode,{nodeName:["P","DIV"]},2);if(parentElement)that.selection.executeAndRestore(function(){if(that.config.useLineBreaks)dom.replaceWithChildNodes(parentElement);else if("P"!==parentElement.nodeName)dom.renameElement(parentElement,"p")})}var that=this,USE_NATIVE_LINE_BREAK_INSIDE_TAGS=["LI","P","H1","H2","H3","H4","H5","H6"],LIST_TAGS=["UL","OL","MENU"];if(!this.config.useLineBreaks)dom.observe(this.element,["focus","keydown"],function(){if(that.isEmpty()){var paragraph=that.doc.createElement("P");if(that.element.innerHTML="",that.element.appendChild(paragraph),!browser.displaysCaretInEmptyContentEditableCorrectly())paragraph.innerHTML="<br>",that.selection.setBefore(paragraph.firstChild);else that.selection.selectNode(paragraph,!0)}});dom.observe(this.doc,"keydown",function(event){var keyCode=event.keyCode;if(!event.shiftKey)if(keyCode===wysihtml5.ENTER_KEY||keyCode===wysihtml5.BACKSPACE_KEY){var blockElement=dom.getParentElement(that.selection.getSelectedNode(),{nodeName:USE_NATIVE_LINE_BREAK_INSIDE_TAGS},4);if(blockElement)return void setTimeout(function(){var selectedNode=that.selection.getSelectedNode(),list;if("LI"===blockElement.nodeName){if(!selectedNode)return;if(list=dom.getParentElement(selectedNode,{nodeName:LIST_TAGS},2),!list)adjust(selectedNode)}if(keyCode===wysihtml5.ENTER_KEY&&blockElement.nodeName.match(/^H[1-6]$/))adjust(selectedNode)},0);if(that.config.useLineBreaks&&keyCode===wysihtml5.ENTER_KEY&&!wysihtml5.browser.insertsLineBreaksOnReturn())that.commands.exec("insertLineBreak"),event.preventDefault()}})}})}(wysihtml5),function(wysihtml5){var dom=wysihtml5.dom,doc=document,win=global,HOST_TEMPLATE=doc.createElement("div"),TEXT_FORMATTING=["background-color","color","cursor","font-family","font-size","font-style","font-variant","font-weight","line-height","letter-spacing","text-align","text-decoration","text-indent","text-rendering","word-break","word-wrap","word-spacing"],BOX_FORMATTING=["background-color","border-collapse","border-bottom-color","border-bottom-style","border-bottom-width","border-left-color","border-left-style","border-left-width","border-right-color","border-right-style","border-right-width","border-top-color","border-top-style","border-top-width","clear","display","float","margin-bottom","margin-left","margin-right","margin-top","outline-color","outline-offset","outline-width","outline-style","padding-left","padding-right","padding-top","padding-bottom","position","top","left","right","bottom","z-index","vertical-align","text-align","-webkit-box-sizing","-moz-box-sizing","-ms-box-sizing","box-sizing","-webkit-box-shadow","-moz-box-shadow","-ms-box-shadow","box-shadow","-webkit-border-top-right-radius","-moz-border-radius-topright","border-top-right-radius","-webkit-border-bottom-right-radius","-moz-border-radius-bottomright","border-bottom-right-radius","-webkit-border-bottom-left-radius","-moz-border-radius-bottomleft","border-bottom-left-radius","-webkit-border-top-left-radius","-moz-border-radius-topleft","border-top-left-radius","width","min-width","min-height","max-width","max-height"],ADDITIONAL_CSS_RULES=["html                 { height: 100%; }","body                 { height: 100%; padding: 1px 0 0 0; margin: -1px 0 0 0; }","body > p:first-child { margin-top: 0; }","._wysihtml5-temp     { display: none; }",wysihtml5.browser.isGecko?"body.placeholder { color: graytext !important; }":"body.placeholder { color: #a9a9a9 !important; }","img:-moz-broken      { -moz-force-broken-image-icon: 1; height: 24px; width: 24px; }"],focusWithoutScrolling=function(element){if(element.setActive)try{element.setActive()}catch(e){}else{var elementStyle=element.style,originalScrollTop=doc.documentElement.scrollTop||doc.body.scrollTop,originalScrollLeft=doc.documentElement.scrollLeft||doc.body.scrollLeft,originalStyles={position:elementStyle.position,top:elementStyle.top,left:elementStyle.left,WebkitUserSelect:elementStyle.WebkitUserSelect};if(dom.setStyles({position:"absolute",top:"-99999px",left:"-99999px",WebkitUserSelect:"none"}).on(element),element.focus(),dom.setStyles(originalStyles).on(element),win.scrollTo)win.scrollTo(originalScrollLeft,originalScrollTop)}};wysihtml5.views.Composer.prototype.style=function(){var that=this,originalActiveElement=doc.querySelector(":focus"),textareaElement=this.textarea.element,hasPlaceholder=textareaElement.hasAttribute("placeholder"),originalPlaceholder=hasPlaceholder&&textareaElement.getAttribute("placeholder"),originalDisplayValue=textareaElement.style.display,originalDisabled=textareaElement.disabled,displayValueForCopying;if(this.blurStylesHost=HOST_TEMPLATE.cloneNode(!1),this.disabledStylesHost=HOST_TEMPLATE.cloneNode(!1),hasPlaceholder)textareaElement.removeAttribute("placeholder");if(textareaElement===originalActiveElement)textareaElement.blur();if(textareaElement.disabled=!1,textareaElement.style.display=displayValueForCopying="none",textareaElement.getAttribute("rows")&&"auto"===dom.getStyle("height").from(textareaElement)||textareaElement.getAttribute("cols")&&"auto"===dom.getStyle("width").from(textareaElement))textareaElement.style.display=displayValueForCopying=originalDisplayValue;dom.copyStyles(BOX_FORMATTING).from(textareaElement).to(this.iframe).andTo(this.blurStylesHost),dom.copyStyles(TEXT_FORMATTING).from(textareaElement).to(this.element).andTo(this.blurStylesHost),dom.insertCSS(ADDITIONAL_CSS_RULES).into(this.element.ownerDocument),textareaElement.disabled=!0,dom.copyStyles(BOX_FORMATTING).from(textareaElement).to(this.disabledStylesHost),dom.copyStyles(TEXT_FORMATTING).from(textareaElement).to(this.disabledStylesHost),textareaElement.disabled=originalDisabled,textareaElement.style.display=originalDisplayValue,dom.copyStyles(["display"]).from(textareaElement).to(this.iframe);var boxFormattingStyles=wysihtml5.lang.array(BOX_FORMATTING).without(["display"]);if(hasPlaceholder)textareaElement.setAttribute("placeholder",originalPlaceholder);return this.parent.on("focus:composer",function(){that.iframe.className+=" wysihtml5-sandbox-focus"}),this.parent.on("blur:composer",function(){that.iframe.className=that.iframe.className.replace("wysihtml5-sandbox-focus","").trim()}),this.parent.observe("disable:composer",function(){dom.copyStyles(boxFormattingStyles).from(that.disabledStylesHost).to(that.iframe),dom.copyStyles(TEXT_FORMATTING).from(that.disabledStylesHost).to(that.element)}),this.parent.observe("enable:composer",function(){dom.copyStyles(boxFormattingStyles).from(that.blurStylesHost).to(that.iframe),dom.copyStyles(TEXT_FORMATTING).from(that.blurStylesHost).to(that.element)}),this}}(wysihtml5),function(wysihtml5){var dom=wysihtml5.dom,browser=wysihtml5.browser,shortcuts={66:"bold",73:"italic",85:"underline"};wysihtml5.views.Composer.prototype.observe=function(){var that=this,state=this.getValue(),iframe=this.sandbox.getIframe(),element=this.element,focusBlurElement=browser.supportsEventsInIframeCorrectly()?element:this.sandbox.getWindow(),pasteEvents=["drop","paste"];dom.observe(iframe,"DOMNodeRemoved",function(){clearInterval(domNodeRemovedInterval),that.parent.fire("destroy:composer")});var domNodeRemovedInterval=setInterval(function(){if(!dom.contains(document.documentElement,iframe))clearInterval(domNodeRemovedInterval),that.parent.fire("destroy:composer")},250);if(dom.observe(focusBlurElement,"focus",function(){that.parent.fire("focus").fire("focus:composer"),setTimeout(function(){state=that.getValue()},0)}),dom.observe(focusBlurElement,"blur",function(){if(state!==that.getValue())that.parent.fire("change").fire("change:composer");that.parent.fire("blur").fire("blur:composer")}),dom.observe(element,"dragenter",function(){that.parent.fire("unset_placeholder")}),dom.observe(element,pasteEvents,function(){setTimeout(function(){that.parent.fire("paste").fire("paste:composer")},0)}),dom.observe(element,"cut",function(){setTimeout(function(){that.parent.fire("cut").fire("cut:composer")},0)}),dom.observe(element,"keyup",function(event){that.parent.synchronizer.sync();var keyCode=event.keyCode;if(that.parent.fire("keyup"),keyCode===wysihtml5.SPACE_KEY||keyCode===wysihtml5.ENTER_KEY)that.parent.fire("newword:composer");that.parent.fire("input")}),this.parent.on("cut:composer",function(){that.parent.synchronizer.sync()}),this.parent.on("change:composer",function(){that.parent.synchronizer.sync()}),this.parent.on("paste:composer",function(){that.parent.synchronizer.sync(),setTimeout(function(){that.parent.fire("newword:composer")},0)}),!browser.canSelectImagesInContentEditable())dom.observe(element,"mousedown",function(event){var target=event.target;if("IMG"===target.nodeName)that.selection.selectNode(target),event.preventDefault()});if(browser.hasHistoryIssue()&&browser.supportsSelectionModify())dom.observe(element,"keydown",function(event){if(event.metaKey||event.ctrlKey){var keyCode=event.keyCode,win=element.ownerDocument.defaultView,selection=win.getSelection();if(37===keyCode||39===keyCode){if(37===keyCode)if(selection.modify("extend","left","lineboundary"),!event.shiftKey)selection.collapseToStart();if(39===keyCode)if(selection.modify("extend","right","lineboundary"),!event.shiftKey)selection.collapseToEnd();event.preventDefault()}}});if(dom.observe(element,"keydown",function(event){that.parent.fire("keydown");var keyCode=event.keyCode,command=shortcuts[keyCode];if((event.ctrlKey||event.metaKey)&&!event.altKey&&command)that.commands.exec(command),event.preventDefault()}),dom.observe(element,"keydown",function(event){var target=that.selection.getSelectedNode(!0),keyCode=event.keyCode,parent;if(target&&"IMG"===target.nodeName&&(keyCode===wysihtml5.BACKSPACE_KEY||keyCode===wysihtml5.DELETE_KEY)){if(parent=target.parentNode,parent.removeChild(target),"A"===parent.nodeName&&!parent.firstChild)parent.parentNode.removeChild(parent);setTimeout(function(){wysihtml5.quirks.redraw(element)},0),event.preventDefault()}}),browser.hasIframeFocusIssue())dom.observe(this.iframe,"focus",function(){setTimeout(function(){if(that.doc.querySelector(":focus")!==that.element)that.focus()},0)}),dom.observe(this.element,"blur",function(){setTimeout(function(){that.selection.getSelection().removeAllRanges()},0)});var titlePrefixes={IMG:"Image: ",A:"Link: "};dom.observe(element,"mouseover",function(event){var target=event.target,nodeName=target.nodeName,title;if("A"===nodeName||"IMG"===nodeName){var hasTitle=target.hasAttribute("title");if(!hasTitle)title=titlePrefixes[nodeName]+(target.getAttribute("href")||target.getAttribute("src")),target.setAttribute("title",title)}})}}(wysihtml5),function(wysihtml5){var INTERVAL=400;wysihtml5.views.Synchronizer=Base.extend({constructor:function(editor,textarea,composer){this.editor=editor,this.textarea=textarea,this.composer=composer,this._observe()},fromComposerToTextarea:function(shouldParseHtml){this.textarea.setValue(wysihtml5.lang.string(this.composer.getValue()).trim(),shouldParseHtml)},fromTextareaToComposer:function(shouldParseHtml){var textareaValue=this.textarea.getValue();if(textareaValue)this.composer.setValue(textareaValue,shouldParseHtml);else this.composer.clear(),this.editor.fire("set_placeholder")},sync:function(shouldParseHtml){var when=10,that=this;if(this.syncTimeout)when=300,clearTimeout(this.syncTimeout);this.syncTimeout=window.setTimeout(function(){if("textarea"===that.editor.currentView.name)that.fromTextareaToComposer(shouldParseHtml);else that.fromComposerToTextarea(shouldParseHtml);clearTimeout(that.syncTimeout)},when)},_observe:function(){var that=this,form=this.textarea.element.form;if(form)wysihtml5.dom.observe(form,"submit",function(){that.sync(!0)}),wysihtml5.dom.observe(form,"reset",function(){setTimeout(function(){that.fromTextareaToComposer()},0)});this.editor.on("change_view",function(view){if("composer"===view)that.fromTextareaToComposer(!0);else that.fromComposerToTextarea(!0)})}})}(wysihtml5),wysihtml5.views.Textarea=wysihtml5.views.View.extend({name:"textarea",constructor:function(parent,textareaElement,config){this.base(parent,textareaElement,config),this._observe()},clear:function(){this.element.value=""},getValue:function(parse){var value=this.isEmpty()?"":this.element.value;if(parse)value=this.parent.parse(value);return value},setValue:function(html,parse){if(parse)html=this.parent.parse(html);this.element.value=html},hasPlaceholderSet:function(){var supportsPlaceholder=wysihtml5.browser.supportsPlaceholderAttributeOn(this.element),placeholderText=this.element.getAttribute("placeholder")||null,value=this.element.value,isEmpty=!value;return supportsPlaceholder&&isEmpty||value===placeholderText},isEmpty:function(){return!wysihtml5.lang.string(this.element.value).trim()||this.hasPlaceholderSet()},_observe:function(){var element=this.element,parent=this.parent,eventMapping={focusin:"focus",focusout:"blur"},events=wysihtml5.browser.supportsEvent("focusin")?["focusin","focusout","change"]:["focus","blur","change"];parent.on("beforeload",function(){wysihtml5.dom.observe(element,events,function(event){var eventName=eventMapping[event.type]||event.type;parent.fire(eventName).fire(eventName+":textarea")}),wysihtml5.dom.observe(element,["paste","drop"],function(){setTimeout(function(){parent.fire("paste").fire("paste:textarea")},0)})})}}),function(wysihtml5){var dom=wysihtml5.dom,CLASS_NAME_OPENED="wysihtml5-command-dialog-opened",SELECTOR_FORM_ELEMENTS="input, select, textarea",SELECTOR_FIELDS="[data-wysihtml5-dialog-field]",ATTRIBUTE_FIELDS="data-wysihtml5-dialog-field";wysihtml5.toolbar.Dialog=wysihtml5.lang.Dispatcher.extend({constructor:function(link,container){this.link=link,this.container=container},_observe:function(){if(!this._observed){var that=this,callbackWrapper=function(event){var attributes=that._serialize();if(attributes==that.elementToChange)that.fire("edit",attributes);else that.fire("save",attributes);that.hide(),event.preventDefault(),event.stopPropagation()};dom.observe(that.link,"click",function(){if(dom.hasClass(that.link,CLASS_NAME_OPENED))setTimeout(function(){that.hide()},0)}),dom.observe(this.container,"keydown",function(event){var keyCode=event.keyCode;if(keyCode===wysihtml5.ENTER_KEY)callbackWrapper(event);
if(keyCode===wysihtml5.ESCAPE_KEY)that.hide()}),dom.delegate(this.container,"[data-wysihtml5-dialog-action=save]","click",callbackWrapper),dom.delegate(this.container,"[data-wysihtml5-dialog-action=cancel]","click",function(event){that.fire("cancel"),that.hide(),event.preventDefault(),event.stopPropagation()});for(var formElements=this.container.querySelectorAll(SELECTOR_FORM_ELEMENTS),i=0,length=formElements.length,_clearInterval=function(){clearInterval(that.interval)};length>i;i++)dom.observe(formElements[i],"change",_clearInterval);this._observed=!0}},_serialize:function(){for(var data=this.elementToChange||{},fields=this.container.querySelectorAll(SELECTOR_FIELDS),length=fields.length,i=0;length>i;i++)data[fields[i].getAttribute(ATTRIBUTE_FIELDS)]=fields[i].value;return data},_interpolate:function(avoidHiddenFields){for(var field,fieldName,newValue,focusedElement=document.querySelector(":focus"),fields=this.container.querySelectorAll(SELECTOR_FIELDS),length=fields.length,i=0;length>i;i++)if(field=fields[i],field!==focusedElement)if(!avoidHiddenFields||"hidden"!==field.type)fieldName=field.getAttribute(ATTRIBUTE_FIELDS),newValue=this.elementToChange?this.elementToChange[fieldName]||"":field.defaultValue,field.value=newValue;else;else;},show:function(elementToChange){if(!dom.hasClass(this.link,CLASS_NAME_OPENED)){var that=this,firstField=this.container.querySelector(SELECTOR_FORM_ELEMENTS);if(this.elementToChange=elementToChange,this._observe(),this._interpolate(),elementToChange)this.interval=setInterval(function(){that._interpolate(!0)},500);if(dom.addClass(this.link,CLASS_NAME_OPENED),this.container.style.display="",this.fire("show"),firstField&&!elementToChange)try{firstField.focus()}catch(e){}}},hide:function(){clearInterval(this.interval),this.elementToChange=null,dom.removeClass(this.link,CLASS_NAME_OPENED),this.container.style.display="none",this.fire("hide")}})}(wysihtml5),function(wysihtml5){var dom=wysihtml5.dom,linkStyles={position:"relative"},wrapperStyles={left:0,margin:0,opacity:0,overflow:"hidden",padding:0,position:"absolute",top:0,zIndex:1},inputStyles={cursor:"inherit",fontSize:"50px",height:"50px",marginTop:"-25px",outline:0,padding:0,position:"absolute",right:"-4px",top:"50%"},inputAttributes={"x-webkit-speech":"",speech:""};wysihtml5.toolbar.Speech=function(parent,link){var input=document.createElement("input");if(!wysihtml5.browser.supportsSpeechApiOn(input))return void(link.style.display="none");var lang=parent.editor.textarea.element.getAttribute("lang");if(lang)inputAttributes.lang=lang;var wrapper=document.createElement("div");wysihtml5.lang.object(wrapperStyles).merge({width:link.offsetWidth+"px",height:link.offsetHeight+"px"}),dom.insert(input).into(wrapper),dom.insert(wrapper).into(link),dom.setStyles(inputStyles).on(input),dom.setAttributes(inputAttributes).on(input),dom.setStyles(wrapperStyles).on(wrapper),dom.setStyles(linkStyles).on(link);var eventName="onwebkitspeechchange"in input?"webkitspeechchange":"speechchange";dom.observe(input,eventName,function(){parent.execCommand("insertText",input.value),input.value=""}),dom.observe(input,"click",function(event){if(dom.hasClass(link,"wysihtml5-command-disabled"))event.preventDefault();event.stopPropagation()})}}(wysihtml5),function(wysihtml5){var CLASS_NAME_COMMAND_DISABLED="wysihtml5-command-disabled",CLASS_NAME_COMMANDS_DISABLED="wysihtml5-commands-disabled",CLASS_NAME_COMMAND_ACTIVE="wysihtml5-command-active",CLASS_NAME_ACTION_ACTIVE="wysihtml5-action-active",dom=wysihtml5.dom;wysihtml5.toolbar.Toolbar=Base.extend({constructor:function(editor,container){this.editor=editor,this.container="string"==typeof container?document.getElementById(container):container,this.composer=editor.composer,this._getLinks("command"),this._getLinks("action"),this._observe(),this.show();for(var speechInputLinks=this.container.querySelectorAll("[data-wysihtml5-command=insertSpeech]"),length=speechInputLinks.length,i=0;length>i;i++)new wysihtml5.toolbar.Speech(this,speechInputLinks[i])},_getLinks:function(type){for(var links=this[type+"Links"]=wysihtml5.lang.array(this.container.querySelectorAll("[data-wysihtml5-"+type+"]")).get(),length=links.length,i=0,mapping=this[type+"Mapping"]={},link,group,name,value,dialog;length>i;i++)link=links[i],name=link.getAttribute("data-wysihtml5-"+type),value=link.getAttribute("data-wysihtml5-"+type+"-value"),group=this.container.querySelector("[data-wysihtml5-"+type+"-group='"+name+"']"),dialog=this._getDialog(link,name),mapping[name+":"+value]={link:link,group:group,name:name,value:value,dialog:dialog,state:!1}},_getDialog:function(link,command){var that=this,dialogElement=this.container.querySelector("[data-wysihtml5-dialog='"+command+"']"),dialog,caretBookmark;if(dialogElement)dialog=new wysihtml5.toolbar.Dialog(link,dialogElement),dialog.on("show",function(){caretBookmark=that.composer.selection.getBookmark(),that.editor.fire("show:dialog",{command:command,dialogContainer:dialogElement,commandLink:link})}),dialog.on("save",function(attributes){if(caretBookmark)that.composer.selection.setBookmark(caretBookmark);that._execCommand(command,attributes),that.editor.fire("save:dialog",{command:command,dialogContainer:dialogElement,commandLink:link})}),dialog.on("cancel",function(){that.editor.focus(!1),that.editor.fire("cancel:dialog",{command:command,dialogContainer:dialogElement,commandLink:link})});return dialog},execCommand:function(command,commandValue){if(!this.commandsDisabled){var commandObj=this.commandMapping[command+":"+commandValue];if(commandObj&&commandObj.dialog&&!commandObj.state)commandObj.dialog.show();else this._execCommand(command,commandValue)}},_execCommand:function(command,commandValue){this.editor.focus(!1),this.composer.commands.exec(command,commandValue),this._updateLinkStates()},execAction:function(action){var editor=this.editor;if("change_view"===action)if(editor.currentView===editor.textarea)editor.fire("change_view","composer");else editor.fire("change_view","textarea")},_observe:function(){for(var that=this,editor=this.editor,container=this.container,links=this.commandLinks.concat(this.actionLinks),length=links.length,i=0;length>i;i++)dom.setAttributes({href:"javascript:;",unselectable:"on"}).on(links[i]);dom.delegate(container,"[data-wysihtml5-command], [data-wysihtml5-action]","mousedown",function(event){event.preventDefault()}),dom.delegate(container,"[data-wysihtml5-command]","click",function(event){var link=this,command=link.getAttribute("data-wysihtml5-command"),commandValue=link.getAttribute("data-wysihtml5-command-value");that.execCommand(command,commandValue),event.preventDefault()}),dom.delegate(container,"[data-wysihtml5-action]","click",function(event){var action=this.getAttribute("data-wysihtml5-action");that.execAction(action),event.preventDefault()}),editor.on("focus:composer",function(){that.bookmark=null,clearInterval(that.interval),that.interval=setInterval(function(){that._updateLinkStates()},500)}),editor.on("blur:composer",function(){clearInterval(that.interval)}),editor.on("destroy:composer",function(){clearInterval(that.interval)}),editor.on("change_view",function(currentView){setTimeout(function(){if(that.commandsDisabled="composer"!==currentView,that._updateLinkStates(),that.commandsDisabled)dom.addClass(container,CLASS_NAME_COMMANDS_DISABLED);else dom.removeClass(container,CLASS_NAME_COMMANDS_DISABLED)},0)})},_updateLinkStates:function(){var commandMapping=this.commandMapping,actionMapping=this.actionMapping,i,state,action,command;for(i in commandMapping){if(command=commandMapping[i],this.commandsDisabled){if(state=!1,dom.removeClass(command.link,CLASS_NAME_COMMAND_ACTIVE),command.group)dom.removeClass(command.group,CLASS_NAME_COMMAND_ACTIVE);if(command.dialog)command.dialog.hide()}else{if(state=this.composer.commands.state(command.name,command.value),wysihtml5.lang.object(state).isArray())state=1===state.length?state[0]:!0;if(dom.removeClass(command.link,CLASS_NAME_COMMAND_DISABLED),command.group)dom.removeClass(command.group,CLASS_NAME_COMMAND_DISABLED)}if(command.state!==state)if(command.state=state,state){if(dom.addClass(command.link,CLASS_NAME_COMMAND_ACTIVE),command.link.setAttribute("aria-pressed","true"),command.group)dom.addClass(command.group,CLASS_NAME_COMMAND_ACTIVE),command.group.setAttribute("aria-pressed","true");if(command.dialog)if("object"==typeof state)command.dialog.show(state);else command.dialog.hide()}else{if(dom.removeClass(command.link,CLASS_NAME_COMMAND_ACTIVE),command.link.setAttribute("aria-pressed","false"),command.group)dom.removeClass(command.group,CLASS_NAME_COMMAND_ACTIVE),command.group.setAttribute("aria-pressed","false");if(command.dialog)command.dialog.hide()}else;}for(i in actionMapping)if(action=actionMapping[i],"change_view"===action.name)if(action.state=this.editor.currentView===this.editor.textarea,action.state)dom.addClass(action.link,CLASS_NAME_ACTION_ACTIVE);else dom.removeClass(action.link,CLASS_NAME_ACTION_ACTIVE)},show:function(){this.container.style.display=""},hide:function(){this.container.style.display="none"}})}(wysihtml5),function(wysihtml5){var undef,defaultConfig={name:undef,style:!0,toolbar:undef,autoLink:!0,parserRules:{tags:{br:{},span:{},div:{},p:{}},classes:{}},parser:wysihtml5.dom.parse,composerClassName:"wysihtml5-editor",bodyClassName:"wysihtml5-supported",useLineBreaks:!0,stylesheets:[],placeholderText:undef,supportTouchDevices:!0};wysihtml5.Editor=wysihtml5.lang.Dispatcher.extend({constructor:function(textareaElement,config){if(this.textareaElement="string"==typeof textareaElement?document.getElementById(textareaElement):textareaElement,this.config=wysihtml5.lang.object({}).merge(defaultConfig).merge(config).get(),this.textarea=new wysihtml5.views.Textarea(this,this.textareaElement,this.config),this.currentView=this.textarea,this._isCompatible=wysihtml5.browser.supported(),!this._isCompatible||!this.config.supportTouchDevices&&wysihtml5.browser.isTouchDevice()){var that=this;return void setTimeout(function(){that.fire("beforeload").fire("load")},0)}if(wysihtml5.dom.addClass(document.body,this.config.bodyClassName),this.composer=new wysihtml5.views.Composer(this,this.textareaElement,this.config),this.currentView=this.composer,"function"==typeof this.config.parser)this._initParser();this.on("beforeload",function(){if(this.synchronizer=new wysihtml5.views.Synchronizer(this,this.textarea,this.composer),this.config.toolbar)this.toolbar=new wysihtml5.toolbar.Toolbar(this,this.config.toolbar)})},isCompatible:function(){return this._isCompatible},clear:function(){return this.currentView.clear(),this},getValue:function(parse){return this.currentView.getValue(parse)},setValue:function(html,parse){if(this.fire("unset_placeholder"),!html)return this.clear();else return this.currentView.setValue(html,parse),this},focus:function(setToEnd){return this.currentView.focus(setToEnd),this},disable:function(){return this.currentView.disable(),this},enable:function(){return this.currentView.enable(),this},isEmpty:function(){return this.currentView.isEmpty()},hasPlaceholderSet:function(){return this.currentView.hasPlaceholderSet()},parse:function(htmlOrElement){var returnValue=this.config.parser(htmlOrElement,this.config.parserRules,this.composer.sandbox.getDocument(),!0);if("object"==typeof htmlOrElement)wysihtml5.quirks.redraw(htmlOrElement);return returnValue},_initParser:function(){this.on("paste:composer",function(){var keepScrollPosition=!0,that=this;that.composer.selection.executeAndRestore(function(){wysihtml5.quirks.cleanPastedHTML(that.composer.element),that.parse(that.composer.element)},keepScrollPosition)})}})}(wysihtml5),wysihtml5};if("function"==typeof define&&define.amd)define("bundles/wysihtml5/wysihtml5-0.4.0pre",[],function(){return wysihtml5_init()});else window.wysihtml5=wysihtml5_init()}(window),define("bundles/wysihtml5/nls/toolbar",{es:!0,fr:!0,pt:!0,ru:!0,tr:!0,zh:!0,"zh-hk":"zh-tw","zh-mo":"zh-tw","zh-tw":!0}),define("bundles/wysihtml5/nls/root/toolbar",{B:"B",I:"I"}),!function(wndw){var jadify=function(jade,_t){var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(prefix,options,_t){if(buf.push('<div style="display:none;position:relative;" role="toolbar" tabindex="0" title="HTML editing toolbar"'+jade.cls([prefix+"-toolbar"],[!0])+'><div style="overflow:auto;"><div style="float:left;"'+jade.cls(["left",prefix+"-commands"],[null,!0])+"><span data-wysihtml5-order='0' class=\"hide\"></span>"),options["toolbar.b"])buf.push('<button data-wysihtml5-order=\'1\' data-wysihtml5-command="bold" aria-pressed="false" style="font-weight:bold; width: 30px;" type="button" title="Make text bold"'+jade.cls([prefix+"-toolbar-item"],[!0])+">"+jade.escape(null==(jade_interp=_t("B"))?"":jade_interp)+"</button>");if(options["toolbar.strong"])buf.push('<button data-wysihtml5-order=\'1\' data-wysihtml5-command="formatInline" data-wysihtml5-command-value="strong" aria-pressed="false" style="font-weight:bold; width: 30px;" type="button" title="Make text bold"'+jade.cls([prefix+"-toolbar-item"],[!0])+">"+jade.escape(null==(jade_interp=_t("B"))?"":jade_interp)+"</button>");if(options["toolbar.i"])buf.push('<button data-wysihtml5-order=\'2\' data-wysihtml5-command="italic" aria-pressed="false" style="font-style:italic; font-family: serif; width: 30px;" type="button" title="Make text italic"'+jade.cls([prefix+"-toolbar-item"],[!0])+">"+jade.escape(null==(jade_interp=_t("I"))?"":jade_interp)+"</button>");if(options["toolbar.em"])buf.push('<button data-wysihtml5-order=\'2\' data-wysihtml5-command="formatInline" data-wysihtml5-command-value="em" aria-pressed="false" style="font-style:italic; font-family: serif; width: 30px;" type="button" title="Make text italic"'+jade.cls([prefix+"-toolbar-item"],[!0])+">"+jade.escape(null==(jade_interp=_t("I"))?"":jade_interp)+"</button>");if(options["toolbar.ul"])buf.push('<button data-wysihtml5-order=\'3\' data-wysihtml5-command="insertUnOrderedList" aria-pressed="false" type="button" title="Insert bullets" style="width:30px;"'+jade.cls([prefix+"-toolbar-item"],[!0])+'><span class="icon-list-ul"></span></button>');if(options["toolbar.ol"])buf.push('<button data-wysihtml5-order=\'4\' data-wysihtml5-command="insertOrderedList" aria-pressed="false" type="button" title="Insert numbered bullets" style="width:30px;"'+jade.cls([prefix+"-toolbar-item"],[!0])+'><span class="icon-list-ol"></span></button>');buf.push('</div><div style="float:right;"'+jade.cls(["right",prefix+"-command-view"],[null,!0])+'><span data-wysihtml5-order=\'0\' class="hide"></span></div><div style="clear:both;"></div></div><div'+jade.cls([prefix+"-toolbar-modals"],[!0])+"></div></div>")}("prefix"in locals_for_with?locals_for_with.prefix:"undefined"!=typeof prefix?prefix:void 0,"options"in locals_for_with?locals_for_with.options:"undefined"!=typeof options?options:void 0,"_t"in locals_for_with?locals_for_with._t:"undefined"!=typeof _t?_t:void 0),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("bundles/wysihtml5/toolbar.html",["js/lib/jade","i18n!bundles/wysihtml5/nls/toolbar"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["bundles.wysihtml5.toolbar"]=jadify(wndw.jade.helpers)}(window),!function(global){var init=function($,_,wysihtml5,toolbarTemplate,_t,DataAttributes){var defaults={"prefix.css":"","prefix.data":"data-wysihtml5","composer.class":"wysihtml5","composer.stylesheet":"editor.css","toolbar.enabled":!0,"toolbar.separate":!1,"toolbar.b":!0,"toolbar.strong":!1,"toolbar.i":!0,"toolbar.em":!1,"toolbar.ul":!0,"toolbar.ol":!0,useLineBreaks:!0,parserRules:{tags:{b:1,i:1,p:1,ul:1,li:1,ol:1,u:1,br:1,a:{check_attributes:{href:"url",target:"allow"}}}}},setupAutoResizeTextarea=function($textarea){var resize=function(){var Height=parseInt($textarea.css("height"),10)||0,minHeight=parseInt($textarea.css("min-height"),10)||0,maxHeight=parseInt($textarea.css("max-height"),10)||0,paddingTop=parseInt($textarea.css("padding-top"),10)||0,paddingBottom=parseInt($textarea.css("padding-bottom"),10)||0,borderTop=parseInt($textarea.css("border-top"),10)||0,borderBottom=parseInt($textarea.css("border-bottom"),10)||0,adjust=function(height){var min=minHeight?Math.max(parseInt(height,10)+borderTop+borderBottom+paddingTop+paddingBottom||0,minHeight):Height+borderTop+borderBottom+paddingTop+paddingBottom;return maxHeight?Math.min(min,maxHeight):Math.max(min,height+borderTop+borderBottom+paddingTop+paddingBottom)},scrollHeight=$textarea.get(0).scrollHeight-paddingTop-paddingBottom,adjustHeight=adjust(scrollHeight);if($textarea.css({height:adjustHeight}),scrollHeight>adjustHeight)$textarea.css({"overflow-y":"auto"});else $textarea.css({"overflow-y":"hidden"})};$textarea.on("keyup focus",resize),resize()},setupAutoResize=function(editor){var $textarea=$(editor.textareaElement);editor.on("load",function(){if(editor.composer){var iframe=$(editor.composer.iframe),iframeDocument=$(iframe[0].contentWindow.document),iframeBody=iframeDocument.find("html").css({height:"100%",width:"100%",margin:0,padding:0}).find("body").css({height:"auto",width:"100%",margin:0,padding:0}),Height=parseInt($textarea.css("height"),10)||0,minHeight=parseInt($textarea.css("min-height"),10)||0,maxHeight=parseInt($textarea.css("max-height"),10)||0,paddingTop=parseInt(iframe.css("padding-top"),10)||0,paddingBottom=parseInt(iframe.css("padding-bottom"),10)||0,borderTop=parseInt(iframe.css("border-top"),10)||0,borderBottom=parseInt(iframe.css("border-bottom"),10)||0,adjust=function(height){var min=minHeight?Math.max(parseInt(height,10)+borderTop+borderBottom+paddingTop+paddingBottom||0,minHeight):Height+borderTop+borderBottom+paddingTop+paddingBottom;return maxHeight?Math.min(min,maxHeight):Math.max(min,height+borderTop+borderBottom+paddingTop+paddingBottom)},resize=function(){var $editor_wrapper=iframe;if($(iframe).is(":visible")){$editor_wrapper.height(adjust(iframeBody.outerHeight()));var $bodyChildren=iframeBody.children(),offsetTop=$bodyChildren.length&&1==$bodyChildren.get(0).nodeType?$bodyChildren.get(0).offsetTop:0;if($editor_wrapper.height(adjust(iframeBody.get(0).scrollHeight+offsetTop)+2),iframeBody.height()<parseInt(iframeBody.css("line-height"),10))$editor_wrapper.height(adjust(iframeBody.css("line-height")))}iframeBody.find("img").off("load",resize),iframeBody.find("img").on("load",resize)};iframe.css({height:$textarea.css("height")}),editor.on("keyup",resize),editor.on("aftercommand:composer",resize),editor.on("change_view",resize),resize()}})},customize=function($textarea,options){var custom=_.defaults(options,wysiEditor.defaults),concatOptions=["composer.stylesheet"];_(concatOptions).each(function(key){if(_(options).has(key))custom[key]=_.union(wysiEditor.defaults[key],options[key])});var additionalOptions=["parser"];return _(additionalOptions).each(function(key){if(_(options).has(key))custom[key]=options[key]}),DataAttributes.parse($textarea,custom,wysiEditor.defaults["prefix.data"]+"-")},wysiEditorPlugins={},wysiEditorBase=function(textarea,options,$toolbar,$footer){var $textarea=$(textarea);if(!options["toolbar.separate"])if($toolbar.insertBefore($textarea[0]),"100%"!=$textarea[0].style.width)$toolbar.css("width",$textarea[0].style.width);$textarea.after($footer);var editorOptions={toolbar:options["toolbar.enabled"]===!0?$toolbar[0]:!1,parserRules:options.parserRules,composerClassName:options["composer.class"],stylesheets:_.isArray(options["composer.stylesheet"])?options["composer.stylesheet"]:[options["composer.stylesheet"]],useLineBreaks:options.useLineBreaks};if(_(options).has("parser"))editorOptions.parser=options.parser;var editor=new wysihtml5.Editor($textarea[0],editorOptions);_.each(["change","input","paste","keyup","keydown"],function(ev){editor.on(ev,function(e){$textarea.trigger(ev,e)})}),setupAutoResize(editor),setupAutoResizeTextarea($(editor.textareaElement).addClass(options["prefix.css"]+"-rich-editor"));for(var plugin in wysiEditorPlugins)if("function"==typeof wysiEditorPlugins[plugin])editor.uid=_.uniqueId(),wysiEditorPlugins[plugin](editor,$toolbar,$footer,options);return editor},wysiEditor=function(textarea,_options){return wysiEditor.constructAndReturnElements(textarea,_options).editor};return wysiEditor.constructAndReturnElements=function(textarea,_options){var $textarea=$(textarea),options=customize($textarea,_options||{}),$toolbar=$(toolbarTemplate({_t:_t,prefix:options["prefix.css"],options:options})),$footer=$("<div>").addClass(options["prefix.css"]+"-footer"),editor=new wysiEditorBase(textarea,options,$toolbar,$footer);return{editor:editor,$toolbar:$toolbar,$footer:$footer}},wysiEditor.defaults=defaults,wysiEditor.setupSecondaryTextarea=function(editor,$textarea){wysihtml5.dom.copyStyles(["overflow-y","width"]).from(editor.textareaElement).to($textarea[0]),setupAutoResizeTextarea($textarea),$textarea.on("input keyup keydown focus blur click mouseover mouseup",function(e){$(editor.textarea.element).trigger(e.type)})},wysiEditor.insertIntoLeftToolbar=function($toolbar,$item,order){var inserted=!1,$buttons=$toolbar.find(".left").find("[data-wysihtml5-order]");$buttons.each(function(i){var $this=$(this);if(order<$this.attr("data-wysihtml5-order"))$item.insertBefore($this).attr({"data-wysihtml5-order":order});else if($buttons.length==i+1)$item.insertAfter($this).attr({"data-wysihtml5-order":order})})},wysiEditor.insertIntoRightToolbar=function($toolbar,$item,order){var inserted=!1,$buttons=$toolbar.find(".right").find("[data-wysihtml5-order]");$buttons.each(function(i){var $this=$(this);if(order<$this.attr("data-wysihtml5-order"))$item.insertBefore($this).attr({"data-wysihtml5-order":order});else if($buttons.length==i+1)$item.insertAfter($this).attr({"data-wysihtml5-order":order})})},wysiEditor.updateFooter=function($footer,$item){$footer.html($item)},wysiEditor.plugin=function(name,initialize){wysiEditorPlugins[name]=initialize},wysiEditor};if("function"==typeof define&&define.amd)define("bundles/wysihtml5/editor",["jquery","underscore","bundles/wysihtml5/wysihtml5-0.4.0pre","bundles/wysihtml5/toolbar.html","i18n!bundles/wysihtml5/nls/toolbar","js/lib/data.attributes"],function($,_,wysihtml5,toolbarTemplate,_t,DataAttributes){return init($,_,wysihtml5,toolbarTemplate,_t,DataAttributes)});else window.wysiEditor=init(window.$,window._,window.wysihtml5,window.jade.templates["bundles.wysihtml5.toolbar"],window.DataAttributes)}(window),define("bundles/wysihtml5/nls/toolbar-code",{es:!0,fr:!0,pt:!0,ru:!0,tr:!0,zh:!0,"zh-hk":"zh-tw","zh-mo":"zh-tw","zh-tw":!0}),define("bundles/wysihtml5/nls/root/toolbar-code",{"&lt;code&gt;":"&lt;code&gt;"}),!function(wndw){var jadify=function(jade,_t){var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(prefix,_t){buf.push('<button data-wysihtml5-command="code" data-wysihtml5-order=\'6\' type="button" title="Format text as code"'+jade.cls([prefix+"-toolbar-item"],[!0])+">"+(null==(jade_interp=_t("&lt;code&gt;"))?"":jade_interp)+"</button>")}("prefix"in locals_for_with?locals_for_with.prefix:"undefined"!=typeof prefix?prefix:void 0,"_t"in locals_for_with?locals_for_with._t:"undefined"!=typeof _t?_t:void 0),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("bundles/wysihtml5/toolbar-code.html",["js/lib/jade","i18n!bundles/wysihtml5/nls/toolbar-code"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["bundles.wysihtml5.toolbar-code"]=jadify(wndw.jade.helpers)}(window),!function(global){var init=function($,wysihtml5,wysiEditor,toolbarTemplate,_t){return wysihtml5.commands.code={exec:function(composer){var pre=this.state(composer);if(pre)composer.selection.executeAndRestore(function(){var code=pre.querySelector("code");if(wysihtml5.dom.replaceWithChildNodes(pre),code)wysihtml5.dom.replaceWithChildNodes(code)});else{var range=composer.selection.getRange(),selectedNodes=range.extractContents(),code=composer.doc.createElement("code");pre=composer.doc.createElement("pre"),pre.appendChild(code),code.appendChild(selectedNodes),range.insertNode(pre),composer.selection.selectNode(pre);var spacer=document.createElement("br");$(spacer).insertAfter(pre)}},state:function(composer){var selectedNode=composer.selection.getSelectedNode();return wysihtml5.dom.getParentElement(selectedNode,{nodeName:"CODE"})&&wysihtml5.dom.getParentElement(selectedNode,{nodeName:"PRE"})}},wysiEditor.defaults=$.extend(wysiEditor.defaults,{"toolbar.code":!0}),wysiEditor.plugin("code",function(editor,$toolbar,$footer,options){if(options["toolbar.code"]){var $item=$(toolbarTemplate({_t:_t,prefix:options["prefix.css"]}));wysiEditor.insertIntoLeftToolbar($toolbar,$item,6)}}),wysiEditor};if("function"==typeof define&&define.amd)define("bundles/wysihtml5/code",["jquery","bundles/wysihtml5/wysihtml5-0.4.0pre","bundles/wysihtml5/editor","bundles/wysihtml5/toolbar-code.html","i18n!bundles/wysihtml5/nls/toolbar-code"],function($,wysihtml5,wysiEditor,toolbarTemplate,_t){return init($,wysihtml5,wysiEditor,toolbarTemplate,_t)});else init(window.$,window.wysihtml5,window.wysiEditor,window.jade.templates["bundles.wysihtml5.toolbar-code"])}(window),define("bundles/wysihtml5/nls/toolbar-link",{es:!0,fr:!0,pt:!0,ru:!0,tr:!0,zh:!0,"zh-hk":"zh-tw","zh-mo":"zh-tw","zh-tw":!0}),define("bundles/wysihtml5/nls/root/toolbar-link",{Link:"Link"}),!function(wndw){var jadify=function(jade,_t){var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(prefix,_t){buf.push('<button data-wysihtml5-custom-command="link" type="button" unselectable="on" title="Insert link"'+jade.cls([prefix+"-toolbar-item"],[!0])+'><span class="icon-link"></span> '+jade.escape(null==(jade_interp=_t("Link"))?"":jade_interp)+"</button>")}("prefix"in locals_for_with?locals_for_with.prefix:"undefined"!=typeof prefix?prefix:void 0,"_t"in locals_for_with?locals_for_with._t:"undefined"!=typeof _t?_t:void 0),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("bundles/wysihtml5/toolbar-link.html",["js/lib/jade","i18n!bundles/wysihtml5/nls/toolbar-link"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["bundles.wysihtml5.toolbar-link"]=jadify(wndw.jade.helpers)}(window),define("bundles/wysihtml5/nls/toolbar-modal-link",{es:!0,fr:!0,pt:!0,ru:!0,tr:!0,zh:!0,"zh-hk":"zh-tw","zh-mo":"zh-tw","zh-tw":!0}),define("bundles/wysihtml5/nls/root/toolbar-modal-link",{Cancel:"Cancel",Create:"Create","URL &nbsp;&nbsp;":"URL &nbsp;&nbsp;","http://":"http://"}),!function(wndw){var jadify=function(jade,_t){var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(prefix,_t){buf.push('<div data-wysihtml5-modal-link="data-wysihtml5-modal-link"'+jade.attr("data-modal-overlay-class",prefix+"-overlay",!0,!1)+' role="dialog" aria-label="Create a link" class="modal hide"><form><div class="modal-body"><label style="display:inline-block;margin-right:15px;"><span>'+(null==(jade_interp=_t("URL &nbsp;&nbsp;"))?"":jade_interp)+'</span><input name="url"'+jade.attr("placeholder",_t("http://"),!0,!1)+' style="width:350px;"'+jade.cls([prefix+"-modal-url"],[!0])+'/></label></div><div class="modal-footer"><button type="submit" data-modal-close="data-modal-close" style="margin-right:10px;"'+jade.cls(["btn",prefix+"-modal-link-submit"],[null,!0])+">"+jade.escape(null==(jade_interp=_t("Create"))?"":jade_interp)+'</button><a data-modal-close="data-modal-close" href="javascript:;">'+jade.escape(null==(jade_interp=_t("Cancel"))?"":jade_interp)+"</a></div></form></div>")}("prefix"in locals_for_with?locals_for_with.prefix:"undefined"!=typeof prefix?prefix:void 0,"_t"in locals_for_with?locals_for_with._t:"undefined"!=typeof _t?_t:void 0),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("bundles/wysihtml5/toolbar-modal-link.html",["js/lib/jade","i18n!bundles/wysihtml5/nls/toolbar-modal-link"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["bundles.wysihtml5.toolbar-modal-link"]=jadify(wndw.jade.helpers)}(window),!function(global){var init=function($,Modal,wysiEditor,toolbarTemplate,toolbarTemplate_t,toolbarModalTemplate,toolbarModalTemplate_t){return wysiEditor.defaults=$.extend(wysiEditor.defaults,{"toolbar.link":!0}),wysiEditor.plugin("link",function(editor,$toolbar,$footer,options){if(options["toolbar.link"]){var $item=$(toolbarTemplate({_t:toolbarTemplate_t,prefix:options["prefix.css"]}));wysiEditor.insertIntoLeftToolbar($toolbar,$item,5),$toolbar.find("."+options["prefix.css"]+"-toolbar-modals").append(toolbarModalTemplate({_t:toolbarModalTemplate_t,prefix:options["prefix.css"]}));var $modal=$toolbar.find("[data-wysihtml5-modal-link]"),modal=Modal($modal),input=$modal.find("[name=url]"),caretBookmark;modal.on("open",function(){input.focus()}),modal.on("close",function(){editor.currentView.element.focus()}),$modal.find("form").on("submit",function(e){if(e.preventDefault(),e.stopPropagation(),editor.currentView.element.focus(),void 0!==caretBookmark||null!==caretBookmark)editor.composer.selection.setBookmark(caretBookmark),caretBookmark=null;var node=editor.currentView.selection.getSelection();if(node.focusNode&&node.focusNode.parentNode&&"A"==node.focusNode.parentNode.nodeName)editor.fire("beforecommand:composer"),node.focusNode.parentNode.title=null,node.focusNode.parentNode.href=input.val(),editor.fire("aftercommand:composer");else editor.composer.commands.exec("createLink",{href:input.val(),target:"_blank"});editor.fire("change").fire("change:composer")}),$toolbar.find("[data-wysihtml5-custom-command=link]").on("click",function(e){if(!$(this).hasClass("wysihtml5-command-active")&&!$toolbar.hasClass("wysihtml5-commands-disabled")){var node=editor.currentView.selection&&editor.currentView.selection.getSelection();if(node&&node.focusNode&&node.focusNode.parentNode&&"A"==node.focusNode.parentNode.nodeName)input.val(node.focusNode.parentNode.href);else input.val("");caretBookmark=editor.composer&&editor.composer.selection.getBookmark(),modal.open()}})}}),wysiEditor};if("function"==typeof define&&define.amd)define("bundles/wysihtml5/link",["jquery","js/lib/modals","bundles/wysihtml5/editor","bundles/wysihtml5/toolbar-link.html","i18n!bundles/wysihtml5/nls/toolbar-link","bundles/wysihtml5/toolbar-modal-link.html","i18n!bundles/wysihtml5/nls/toolbar-modal-link"],function($,Modal,wysiEditor,toolbarTemplate,toolbarTemplate_t,toolbarModalTemplate,toolbarModalTemplate_t){return init($,Modal,wysiEditor,toolbarTemplate,toolbarTemplate_t,toolbarModalTemplate,toolbarModalTemplate_t)});else init(window.$,window.Modal,window.wysiEditor,window.jade.templates["bundles.wysihtml5.toolbar-link"],window.jade.templates["bundles.wysihtml5.toolbar-modal-link"])}(window),define("bundles/wysihtml5/nls/toolbar-modes",{es:!0,fr:!0,pt:!0,ru:!0,tr:!0,zh:!0,"zh-hk":"zh-tw","zh-mo":"zh-tw","zh-tw":!0}),define("bundles/wysihtml5/nls/root/toolbar-modes",{"&lt;HTML&gt;":"&lt;HTML&gt;",Edit:"Edit","Edit: ":"Edit: ",Preview:"Preview",Rich:"Rich","`MD`":"`MD`"}),!function(wndw){var jadify=function(jade,_t){var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(preview,prefix,_t,mode,editor){if(preview)buf.push('<button title="Editor Preview" type="button" aria-pressed="false"'+jade.cls([prefix+"-toolbar-item "+prefix+"-toolbar-item-right "+prefix+"-toolbar-mode-preview"],[!0])+">"+jade.escape(null==(jade_interp=_t("Preview"))?"":jade_interp)+'</button><button style="display:none;" type="button"'+jade.cls([prefix+"-toolbar-item "+prefix+"-toolbar-item-right "+prefix+"-toolbar-mode-preview-close"],[!0])+">"+jade.escape(null==(jade_interp=_t("Edit"))?"":jade_interp)+"</button>");
if(buf.push("<!-- we want to ensure that two editors are allowed if we are going to show a drop down...--><!-- the below uses XOR to determine the that one is true, and then we confirm the other is true in the ternary--><!-- this shortcut was used as the quickest way to determine at least two are true.--><!-- this comment proves that saving effort in code means expanding in comments...-->"),mode.html^mode.markdown?mode.rich:mode.html)buf.push('<button unselectable="on" title="Editor Type"'+jade.attr("data-popup","#"+prefix+"-toolbar-mode-popup-"+editor.uid,!0,!1)+' aria-haspopup="true" aria-expanded="false"'+jade.attr("aria-owns",prefix+"-toolbar-mode-popup",!0,!1)+' data-popup-close="data-popup-close" data-popup-direction="se" style="padding-right:30px;" type="button"'+jade.cls([prefix+"-toolbar-item "+prefix+"-toolbar-item-right "+prefix+"-toolbar-mode-editor on"],[!0])+"><span>"+jade.escape(null==(jade_interp=_t("Edit:"))?"":jade_interp)+" </span><span"+jade.cls([prefix+"-toolbar-mode-editor-label"],[!0])+">"+jade.escape(null==(jade_interp=_t("Rich"))?"":jade_interp)+'</span><span style="position:absolute;top:5px;padding-left:10px;padding-right:10px;" class="icon-sort-down"></span></button>');else buf.push('<button title="Editor Type"'+jade.cls([prefix+"-toolbar-item "+prefix+"-toolbar-item-right "+prefix+"-toolbar-mode-editor on"],[!0])+"><span>"+jade.escape(null==(jade_interp=_t("Edit:"))?"":jade_interp)+" </span><span"+jade.cls([prefix+"-toolbar-mode-editor-label"],[!0])+">"+jade.escape(null==(jade_interp=_t("Rich"))?"":jade_interp)+"</span></button>");if(buf.push("<div"+jade.attr("id",prefix+"-toolbar-mode-popup-"+editor.uid,!0,!1)+' style="display:none;"'+jade.cls([prefix+"-toolbar-mode-popup"],[!0])+">"),mode.html)buf.push('<a aria-pressed="false" data-wysihtml5-custom-command="change-editor" type="button" title="Change editing mode to HTML" data-popup-close="data-popup-close"'+jade.cls([prefix+"-toolbar-mode-popup-item "+prefix+"-toolbar-mode-html"],[!0])+">"+(null==(jade_interp=_t("&lt;HTML&gt;"))?"":jade_interp)+"</a>");if(mode.markdown)buf.push('<a aria-pressed="false" data-wysihtml5-custom-command="change-editor" type="button" title="Change editing mode to Markdown" data-popup-close="data-popup-close"'+jade.cls([prefix+"-toolbar-mode-popup-item "+prefix+"-toolbar-mode-markdown"],[!0])+">"+jade.escape(null==(jade_interp=_t("`MD`"))?"":jade_interp)+"</a>");if(mode.rich)buf.push('<a aria-pressed="true" data-wysihtml5-custom-command="change-editor" type="button" title="Change editing mode to rich editor" data-popup-close="data-popup-close"'+jade.cls([prefix+"-toolbar-mode-popup-item "+prefix+"-toolbar-mode-rich"],[!0])+">"+jade.escape(null==(jade_interp=_t("Rich"))?"":jade_interp)+"</a>");buf.push("</div>")}("preview"in locals_for_with?locals_for_with.preview:"undefined"!=typeof preview?preview:void 0,"prefix"in locals_for_with?locals_for_with.prefix:"undefined"!=typeof prefix?prefix:void 0,"_t"in locals_for_with?locals_for_with._t:"undefined"!=typeof _t?_t:void 0,"mode"in locals_for_with?locals_for_with.mode:"undefined"!=typeof mode?mode:void 0,"editor"in locals_for_with?locals_for_with.editor:"undefined"!=typeof editor?editor:void 0),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("bundles/wysihtml5/toolbar-modes.html",["js/lib/jade","i18n!bundles/wysihtml5/nls/toolbar-modes"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["bundles.wysihtml5.toolbar-modes"]=jadify(wndw.jade.helpers)}(window),define("bundles/wysihtml5/nls/footer-source",{es:!0,fr:!0,pt:!0,ru:!0,tr:!0,zh:!0,"zh-hk":"zh-tw","zh-mo":"zh-tw","zh-tw":!0}),define("bundles/wysihtml5/nls/root/footer-source",{"&lt;b&gt;, &lt;i&gt;, &lt;a&gt;, &lt;p&gt;, &lt;br&gt;, &lt;ul&gt;, &lt;ol&gt;, &lt;li&gt;":"&lt;b&gt;, &lt;i&gt;, &lt;a&gt;, &lt;p&gt;, &lt;br&gt;, &lt;ul&gt;, &lt;ol&gt;, &lt;li&gt;","&lt;ul&gt;":"&lt;ul&gt;","&nbsp;&nbsp;":"&nbsp;&nbsp;","<br>&lt;/ul&gt;":"<br>&lt;/ul&gt;","<br>&lt;li&gt;peanutbutter&lt;/li&gt;":"<br>&lt;li&gt;peanutbutter&lt;/li&gt;","<br>&lt;li&gt;pineapples&lt;/li&gt;":"<br>&lt;li&gt;pineapples&lt;/li&gt;","<ul><li>pineapples</li><li>peanut butter</li></ul>":"<ul><li>pineapples</li><li>peanut butter</li></ul>","Allowed tags:":"Allowed tags:","Auto-format HTML":"Auto-format HTML","Got it, thanks!":"Got it, thanks!",HTML:"HTML","HTML is the markup language that all webpages are written in.":"HTML is the markup language that all webpages are written in.",Help:"Help","Imagine all the unicorns &lt;br&gt; Living life in peace":"Imagine all the unicorns &lt;br&gt; Living life in peace","Imagine all the unicorns <br>Living life in peace":"Imagine all the unicorns <br>Living life in peace",Output:"Output","The dugong (&lt;i&gt;Dugong dugon&lt;/i&gt;) is a &lt;b&gt;large&lt;/b&gt; marine mammal":"The dugong (&lt;i&gt;Dugong dugon&lt;/i&gt;) is a &lt;b&gt;large&lt;/b&gt; marine mammal","The dugong (<i>Dugong dugon</i>) is a <b>large</b> marine mammal":"The dugong (<i>Dugong dugon</i>) is a <b>large</b> marine mammal",'To use it, you write your content and surround parts of it in "tags" that':'To use it, you write your content and surround parts of it in "tags" that',"You can either use the rich editor or the HTML editor here, whichever you prefer.":"You can either use the rich editor or the HTML editor here, whichever you prefer.","tell the browser what it is. For example:":"tell the browser what it is. For example:"}),!function(wndw){var jadify=function(jade,_t){var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(prefix,_t){buf.push("<div"+jade.cls([prefix+"-footer-html"],[!0])+'><div style="float:left;">'+jade.escape(null==(jade_interp=_t("Allowed tags:"))?"":jade_interp)+' <span style="font-family:monospace">'+(null==(jade_interp=_t("&lt;b&gt;, &lt;i&gt;, &lt;a&gt;, &lt;p&gt;, &lt;br&gt;, &lt;ul&gt;, &lt;ol&gt;, &lt;li&gt;"))?"":jade_interp)+'</span>&nbsp;&nbsp;<a href="javascript:void(0);" data-wysihtml5-link="help">'+jade.escape(null==(jade_interp=_t("Help"))?"":jade_interp)+'</a></div><div style="float:right;"><a href="javascript:void(0);" title="auto format and indent your HTML source code" data-wysihtml5-link="format">'+jade.escape(null==(jade_interp=_t("Auto-format HTML"))?"":jade_interp)+'</a></div><div data-wysihtml5-modal-image="data-wysihtml5-modal-image"'+jade.attr("data-modal-overlay-class",prefix+"-overlay",!0,!1)+' role="dialog" aria-label="Learn HTML" tabindex="-1" class="modal hide"><div class="modal-body"><p>'+jade.escape(null==(jade_interp=_t("HTML is the markup language that all webpages are written in."))?"":jade_interp)+"\n"+jade.escape(null==(jade_interp=_t("You can either use the rich editor or the HTML editor here, whichever you prefer."))?"":jade_interp)+"</p><p>"+jade.escape(null==(jade_interp=_t('To use it, you write your content and surround parts of it in "tags" that'))?"":jade_interp)+"\n"+jade.escape(null==(jade_interp=_t("tell the browser what it is. For example:"))?"":jade_interp)+'</p><table style="margin-bottom:0px;" class="table table-bordered"><thead><tr><th>'+jade.escape(null==(jade_interp=_t("HTML"))?"":jade_interp)+"</th><th>"+jade.escape(null==(jade_interp=_t("Output"))?"":jade_interp)+"</th></tr></thead><tbody><tr><td>"+(null==(jade_interp=_t("The dugong (&lt;i&gt;Dugong dugon&lt;/i&gt;) is a &lt;b&gt;large&lt;/b&gt; marine mammal"))?"":jade_interp)+"</td><td>"+(null==(jade_interp=_t("The dugong (<i>Dugong dugon</i>) is a <b>large</b> marine mammal"))?"":jade_interp)+"</td></tr><tr><td>"+(null==(jade_interp=_t("Imagine all the unicorns &lt;br&gt; Living life in peace"))?"":jade_interp)+"</td><td>"+(null==(jade_interp=_t("Imagine all the unicorns <br>Living life in peace"))?"":jade_interp)+"</td></tr><tr><td>"+(null==(jade_interp=_t("&lt;ul&gt;"))?"":jade_interp)+"\n"+(null==(jade_interp=_t("<br>&lt;li&gt;pineapples&lt;/li&gt;"))?"":jade_interp)+"\n"+(null==(jade_interp=_t("<br>&lt;li&gt;peanutbutter&lt;/li&gt;"))?"":jade_interp)+"\n"+(null==(jade_interp=_t("<br>&lt;/ul&gt;"))?"":jade_interp)+"</td><td>"+(null==(jade_interp=_t("<ul><li>pineapples</li><li>peanut butter</li></ul>"))?"":jade_interp)+'</td></tr></tbody></table></div><div class="modal-footer"><button type="button" data-modal-close="data-modal-close" style="margin-right:10px;" class="btn">'+jade.escape(null==(jade_interp=_t("Got it, thanks!"))?"":jade_interp)+"</button></div></div></div>")}("prefix"in locals_for_with?locals_for_with.prefix:"undefined"!=typeof prefix?prefix:void 0,"_t"in locals_for_with?locals_for_with._t:"undefined"!=typeof _t?_t:void 0),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("bundles/wysihtml5/footer-source.html",["js/lib/jade","i18n!bundles/wysihtml5/nls/footer-source"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["bundles.wysihtml5.footer-source"]=jadify(wndw.jade.helpers)}(window),define("bundles/wysihtml5/nls/footer-markdown",{es:!0,fr:!0,pt:!0,ru:!0,tr:!0,zh:!0,"zh-hk":"zh-tw","zh-mo":"zh-tw","zh-tw":!0}),define("bundles/wysihtml5/nls/root/footer-markdown",{'Now in <a href="http://daringfireball.net/projects/markdown/syntax" target="_blank">Markdown</a> mode.':'Now in <a href="http://daringfireball.net/projects/markdown/syntax" target="_blank">Markdown</a> mode.'}),!function(wndw){var jadify=function(jade,_t){var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(prefix,_t){buf.push("<div"+jade.cls([prefix+"-footer-markdown"],[!0])+'><div style="float:left;">'+(null==(jade_interp=_t('Now in <a href="http://daringfireball.net/projects/markdown/syntax" target="_blank">Markdown</a> mode.'))?"":jade_interp)+'</div><div style="float:right;"></div></div>')}("prefix"in locals_for_with?locals_for_with.prefix:"undefined"!=typeof prefix?prefix:void 0,"_t"in locals_for_with?locals_for_with._t:"undefined"!=typeof _t?_t:void 0),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("bundles/wysihtml5/footer-markdown.html",["js/lib/jade","i18n!bundles/wysihtml5/nls/footer-markdown"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["bundles.wysihtml5.footer-markdown"]=jadify(wndw.jade.helpers)}(window),define("bundles/wysihtml5/nls/footer-rich",{es:!0,fr:!0,pt:!0,ru:!0,tr:!0,zh:!0,"zh-hk":"zh-tw","zh-mo":"zh-tw","zh-tw":!0}),define("bundles/wysihtml5/nls/root/footer-rich",{"Default Editor":"Default Editor"}),!function(wndw){var jadify=function(jade,_t){var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(prefix){buf.push("<div"+jade.cls([prefix+"-footer-rich"],[!0])+'><div style="float:left;"></div><div style="float:right;"></div></div>')}("prefix"in locals_for_with?locals_for_with.prefix:"undefined"!=typeof prefix?prefix:void 0),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("bundles/wysihtml5/footer-rich.html",["js/lib/jade","i18n!bundles/wysihtml5/nls/footer-rich"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["bundles.wysihtml5.footer-rich"]=jadify(wndw.jade.helpers)}(window),!function(){function js_beautify(js_source_text,options){var beautifier=new Beautifier(js_source_text,options);return beautifier.beautify()}function Beautifier(js_source_text,options){function create_flags(flags_base,mode){var next_indent_level=0;if(flags_base)if(next_indent_level=flags_base.indentation_level,next_indent_level+=flags_base.var_line&&flags_base.var_line_reindented?1:0,!just_added_newline()&&flags_base.line_indent_level>next_indent_level)next_indent_level=flags_base.line_indent_level;var next_flags={mode:mode,parent:flags_base,last_text:flags_base?flags_base.last_text:"",last_word:flags_base?flags_base.last_word:"",var_line:!1,var_line_tainted:!1,var_line_reindented:!1,in_html_comment:!1,multiline_frame:!1,if_block:!1,do_block:!1,do_while:!1,in_case_statement:!1,in_case:!1,case_body:!1,indentation_level:next_indent_level,line_indent_level:flags_base?flags_base.line_indent_level:next_indent_level,start_line_index:output_lines.length,ternary_depth:0};return next_flags}function create_output_line(){return{text:[]}}function trim_output(eat_newlines){if(eat_newlines=void 0===eat_newlines?!1:eat_newlines,output_lines.length)for(trim_output_line(output_lines[output_lines.length-1],eat_newlines);eat_newlines&&output_lines.length>1&&0===output_lines[output_lines.length-1].text.length;)output_lines.pop(),trim_output_line(output_lines[output_lines.length-1],eat_newlines)}function trim_output_line(line){for(;line.text.length&&(" "===line.text[line.text.length-1]||line.text[line.text.length-1]===indent_string||line.text[line.text.length-1]===preindent_string);)line.text.pop()}function trim(s){return s.replace(/^\s+|\s+$/g,"")}function split_newlines(s){s=s.replace(/\x0d/g,"");for(var out=[],idx=s.indexOf("\n");-1!==idx;)out.push(s.substring(0,idx)),s=s.substring(idx+1),idx=s.indexOf("\n");if(s.length)out.push(s);return out}function just_added_newline(){var line=output_lines[output_lines.length-1];return 0===line.text.length}function just_added_blankline(){if(just_added_newline()){if(1===output_lines.length)return!0;var line=output_lines[output_lines.length-2];return 0===line.text.length}return!1}function allow_wrap_or_preserved_newline(force_linewrap){if(force_linewrap=void 0===force_linewrap?!1:force_linewrap,opt.wrap_line_length&&!force_linewrap){var line=output_lines[output_lines.length-1],proposed_line_length=0;if(line.text.length>0)if(proposed_line_length=line.text.join("").length+token_text.length+(output_space_before_token?1:0),proposed_line_length>=opt.wrap_line_length)force_linewrap=!0}if((opt.preserve_newlines&&input_wanted_newline||force_linewrap)&&!just_added_newline())if(print_newline(!1,!0),!is_array(flags.mode)&&!is_expression(flags.mode))output_wrapped=!0}function print_newline(force_newline,preserve_statement_flags){if(output_wrapped=!1,output_space_before_token=!1,!preserve_statement_flags)if(";"!==flags.last_text)for(;flags.mode===MODE.Statement&&!flags.if_block&&!flags.do_block;)restore_mode();if(1!==output_lines.length||!just_added_newline())if(force_newline||!just_added_newline())flags.multiline_frame=!0,output_lines.push(create_output_line())}function print_token_line_indentation(){if(just_added_newline()){var line=output_lines[output_lines.length-1];if(opt.keep_array_indentation&&is_array(flags.mode)&&input_wanted_newline){line.text.push("");for(var i=0;i<whitespace_before_token.length;i+=1)line.text.push(whitespace_before_token[i])}else{if(preindent_string)line.text.push(preindent_string);print_indent_string(flags.indentation_level+(flags.var_line&&flags.var_line_reindented?1:0)+(output_wrapped?1:0))}}}function print_indent_string(level){if(output_lines.length>1){var line=output_lines[output_lines.length-1];flags.line_indent_level=level;for(var i=0;level>i;i+=1)line.text.push(indent_string)}}function print_token_space_before(){var line=output_lines[output_lines.length-1];if(output_space_before_token&&line.text.length){var last_output=line.text[line.text.length-1];if(" "!==last_output&&last_output!==indent_string)line.text.push(" ")}}function print_token(printable_token){printable_token=printable_token||token_text,print_token_line_indentation(),output_wrapped=!1,print_token_space_before(),output_space_before_token=!1,output_lines[output_lines.length-1].text.push(printable_token)}function indent(){flags.indentation_level+=1}function deindent(){if(flags.indentation_level>0&&(!flags.parent||flags.indentation_level>flags.parent.indentation_level))flags.indentation_level-=1}function remove_redundant_indentation(frame){if(!frame.multiline_frame)for(var index=frame.start_line_index,splice_index=0,line;index<output_lines.length;)if(line=output_lines[index],index++,0!==line.text.length){if(preindent_string&&line.text[0]===preindent_string)splice_index=1;else splice_index=0;if(line.text[splice_index]===indent_string)line.text.splice(splice_index,1)}else;}function set_mode(mode){if(flags)flag_store.push(flags),previous_flags=flags;else previous_flags=create_flags(null,mode);flags=create_flags(previous_flags,mode)}function is_array(mode){return mode===MODE.ArrayLiteral}function is_expression(mode){return in_array(mode,[MODE.Expression,MODE.ForInitializer,MODE.Conditional])}function restore_mode(){if(flag_store.length>0)previous_flags=flags,flags=flag_store.pop()}function start_of_statement(){if("do"===flags.last_text||"else"===flags.last_text&&"if"!==token_text||"TK_END_EXPR"===last_type&&(previous_flags.mode===MODE.ForInitializer||previous_flags.mode===MODE.Conditional)){if(allow_wrap_or_preserved_newline(in_array(token_text,["do","for","if","while"])),set_mode(MODE.Statement),just_added_newline())indent(),output_wrapped=!1;return!0}return!1}function all_lines_start_with(lines,c){for(var i=0;i<lines.length;i++){var line=trim(lines[i]);if(line.charAt(0)!==c)return!1}return!0}function is_special_word(word){return in_array(word,["case","return","do","if","throw","else"])}function in_array(what,arr){for(var i=0;i<arr.length;i+=1)if(arr[i]===what)return!0;return!1}function unescape_string(s){for(var esc=!1,out="",pos=0,s_hex="",escaped=0,c;esc||pos<s.length;)if(c=s.charAt(pos),pos++,esc){if(esc=!1,"x"===c)s_hex=s.substr(pos,2),pos+=2;else if("u"===c)s_hex=s.substr(pos,4),pos+=4;else{out+="\\"+c;continue}if(!s_hex.match(/^[0123456789abcdefABCDEF]+$/))return s;if(escaped=parseInt(s_hex,16),escaped>=0&&32>escaped){if("x"===c)out+="\\x"+s_hex;else out+="\\u"+s_hex;continue}else if(34===escaped||39===escaped||92===escaped)out+="\\"+String.fromCharCode(escaped);else if("x"===c&&escaped>126&&255>=escaped)return s;else out+=String.fromCharCode(escaped)}else if("\\"===c)esc=!0;else out+=c;return out}function is_next(find){for(var local_pos=parser_pos,c=input.charAt(local_pos);in_array(c,whitespace)&&c!==find;){if(local_pos++,local_pos>=input_length)return!1;c=input.charAt(local_pos)}return c===find}function get_next_token(){var i,resulting_string;if(n_newlines=0,parser_pos>=input_length)return["","TK_EOF"];input_wanted_newline=!1,whitespace_before_token=[];var c=input.charAt(parser_pos);for(parser_pos+=1;in_array(c,whitespace);){if("\n"===c)n_newlines+=1,whitespace_before_token=[];else if(n_newlines)if(c===indent_string)whitespace_before_token.push(indent_string);else if("\r"!==c)whitespace_before_token.push(" ");if(parser_pos>=input_length)return["","TK_EOF"];c=input.charAt(parser_pos),parser_pos+=1}if(in_array(c,wordchar)){if(input_length>parser_pos)for(;in_array(input.charAt(parser_pos),wordchar)&&(c+=input.charAt(parser_pos),parser_pos+=1,parser_pos!==input_length););if(parser_pos!==input_length&&c.match(/^[0-9]+[Ee]$/)&&("-"===input.charAt(parser_pos)||"+"===input.charAt(parser_pos))){var sign=input.charAt(parser_pos);parser_pos+=1;var t=get_next_token();return c+=sign+t[0],[c,"TK_WORD"]}if("in"===c)return[c,"TK_OPERATOR"];else return[c,"TK_WORD"]}if("("===c||"["===c)return[c,"TK_START_EXPR"];if(")"===c||"]"===c)return[c,"TK_END_EXPR"];if("{"===c)return[c,"TK_START_BLOCK"];if("}"===c)return[c,"TK_END_BLOCK"];if(";"===c)return[c,"TK_SEMICOLON"];if("/"===c){var comment="",inline_comment=!0;if("*"===input.charAt(parser_pos)){if(parser_pos+=1,input_length>parser_pos)for(;input_length>parser_pos&&("*"!==input.charAt(parser_pos)||!input.charAt(parser_pos+1)||"/"!==input.charAt(parser_pos+1));){if(c=input.charAt(parser_pos),comment+=c,"\n"===c||"\r"===c)inline_comment=!1;if(parser_pos+=1,parser_pos>=input_length)break}if(parser_pos+=2,inline_comment&&0===n_newlines)return["/*"+comment+"*/","TK_INLINE_COMMENT"];else return["/*"+comment+"*/","TK_BLOCK_COMMENT"]}if("/"===input.charAt(parser_pos)){for(comment=c;"\r"!==input.charAt(parser_pos)&&"\n"!==input.charAt(parser_pos)&&(comment+=input.charAt(parser_pos),parser_pos+=1,!(parser_pos>=input_length)););return[comment,"TK_COMMENT"]}}if("'"===c||'"'===c||("/"===c||opt.e4x&&"<"===c&&input.slice(parser_pos-1).match(/^<([-a-zA-Z:0-9_.]+|{[^{}]*}|!\[CDATA\[[\s\S]*?\]\])\s*([-a-zA-Z:0-9_.]+=('[^']*'|"[^"]*"|{[^{}]*})\s*)*\/?\s*>/))&&("TK_WORD"===last_type&&is_special_word(flags.last_text)||"TK_END_EXPR"===last_type&&in_array(previous_flags.mode,[MODE.Conditional,MODE.ForInitializer])||in_array(last_type,["TK_COMMENT","TK_START_EXPR","TK_START_BLOCK","TK_END_BLOCK","TK_OPERATOR","TK_EQUALS","TK_EOF","TK_SEMICOLON","TK_COMMA"]))){var sep=c,esc=!1,has_char_escapes=!1;if(resulting_string=c,input_length>parser_pos)if("/"===sep)for(var in_char_class=!1;esc||in_char_class||input.charAt(parser_pos)!==sep;){if(resulting_string+=input.charAt(parser_pos),!esc){if(esc="\\"===input.charAt(parser_pos),"["===input.charAt(parser_pos))in_char_class=!0;else if("]"===input.charAt(parser_pos))in_char_class=!1}else esc=!1;if(parser_pos+=1,parser_pos>=input_length)return[resulting_string,"TK_STRING"]}else if(opt.e4x&&"<"===sep){var xmlRegExp=/<(\/?)([-a-zA-Z:0-9_.]+|{[^{}]*}|!\[CDATA\[[\s\S]*?\]\])\s*([-a-zA-Z:0-9_.]+=('[^']*'|"[^"]*"|{[^{}]*})\s*)*(\/?)\s*>/g,xmlStr=input.slice(parser_pos-1),match=xmlRegExp.exec(xmlStr);if(match&&0===match.index){for(var rootTag=match[2],depth=0;match;){var isEndTag=!!match[1],tagName=match[2],isSingletonTag=!!match[match.length-1]||"![CDATA["===tagName.slice(0,8);if(tagName===rootTag&&!isSingletonTag)if(isEndTag)--depth;else++depth;if(0>=depth)break;match=xmlRegExp.exec(xmlStr)}var xmlLength=match?match.index+match[0].length:xmlStr.length;return parser_pos+=xmlLength-1,[xmlStr.slice(0,xmlLength),"TK_STRING"]}}else for(;esc||input.charAt(parser_pos)!==sep;){if(resulting_string+=input.charAt(parser_pos),esc){if("x"===input.charAt(parser_pos)||"u"===input.charAt(parser_pos))has_char_escapes=!0;esc=!1}else esc="\\"===input.charAt(parser_pos);if(parser_pos+=1,parser_pos>=input_length)return[resulting_string,"TK_STRING"]}if(parser_pos+=1,resulting_string+=sep,has_char_escapes&&opt.unescape_strings)resulting_string=unescape_string(resulting_string);if("/"===sep)for(;input_length>parser_pos&&in_array(input.charAt(parser_pos),wordchar);)resulting_string+=input.charAt(parser_pos),parser_pos+=1;return[resulting_string,"TK_STRING"]}if("#"===c){if(1===output_lines.length&&0===output_lines[0].text.length&&"!"===input.charAt(parser_pos)){for(resulting_string=c;input_length>parser_pos&&"\n"!==c;)c=input.charAt(parser_pos),resulting_string+=c,parser_pos+=1;return[trim(resulting_string)+"\n","TK_UNKNOWN"]}var sharp="#";if(input_length>parser_pos&&in_array(input.charAt(parser_pos),digits)){do c=input.charAt(parser_pos),sharp+=c,parser_pos+=1;while(input_length>parser_pos&&"#"!==c&&"="!==c);if("#"===c);else if("["===input.charAt(parser_pos)&&"]"===input.charAt(parser_pos+1))sharp+="[]",parser_pos+=2;else if("{"===input.charAt(parser_pos)&&"}"===input.charAt(parser_pos+1))sharp+="{}",parser_pos+=2;return[sharp,"TK_WORD"]}}if("<"===c&&"<!--"===input.substring(parser_pos-1,parser_pos+3)){for(parser_pos+=3,c="<!--";"\n"!==input.charAt(parser_pos)&&input_length>parser_pos;)c+=input.charAt(parser_pos),parser_pos++;return flags.in_html_comment=!0,[c,"TK_COMMENT"]}if("-"===c&&flags.in_html_comment&&"-->"===input.substring(parser_pos-1,parser_pos+2))return flags.in_html_comment=!1,parser_pos+=2,["-->","TK_COMMENT"];if("."===c)return[c,"TK_DOT"];if(in_array(c,punct)){for(;input_length>parser_pos&&in_array(c+input.charAt(parser_pos),punct)&&(c+=input.charAt(parser_pos),parser_pos+=1,!(parser_pos>=input_length)););if(","===c)return[c,"TK_COMMA"];else if("="===c)return[c,"TK_EQUALS"];else return[c,"TK_OPERATOR"]}return[c,"TK_UNKNOWN"]}function handle_start_expr(){if(start_of_statement());var next_mode=MODE.Expression;if("["===token_text){if("TK_WORD"===last_type||")"===flags.last_text){if(in_array(flags.last_text,line_starters))output_space_before_token=!0;if(set_mode(next_mode),print_token(),indent(),opt.space_in_paren)output_space_before_token=!0;return}if(next_mode=MODE.ArrayLiteral,is_array(flags.mode))if("["===flags.last_text||","===flags.last_text&&("]"===last_last_text||"}"===last_last_text))if(!opt.keep_array_indentation)print_newline()}else if("for"===flags.last_text)next_mode=MODE.ForInitializer;else if(in_array(flags.last_text,["if","while"]))next_mode=MODE.Conditional;else;if(";"===flags.last_text||"TK_START_BLOCK"===last_type)print_newline();else if("TK_END_EXPR"===last_type||"TK_START_EXPR"===last_type||"TK_END_BLOCK"===last_type||"."===flags.last_text)allow_wrap_or_preserved_newline(input_wanted_newline),output_wrapped=!1;else if("TK_WORD"!==last_type&&"TK_OPERATOR"!==last_type)output_space_before_token=!0;else if("function"===flags.last_word||"typeof"===flags.last_word){if(opt.jslint_happy)output_space_before_token=!0}else if(in_array(flags.last_text,line_starters)||"catch"===flags.last_text)if(opt.space_before_conditional)output_space_before_token=!0;if("("===token_text)if("TK_EQUALS"===last_type||"TK_OPERATOR"===last_type)if(flags.mode!==MODE.ObjectLiteral)allow_wrap_or_preserved_newline();if(set_mode(next_mode),print_token(),opt.space_in_paren)output_space_before_token=!0;indent()}function handle_end_expr(){for(;flags.mode===MODE.Statement;)restore_mode();if("]"===token_text&&is_array(flags.mode)&&flags.multiline_frame&&!opt.keep_array_indentation)print_newline();if(flags.multiline_frame)allow_wrap_or_preserved_newline();if(opt.space_in_paren)output_space_before_token=!0;if("]"===token_text&&opt.keep_array_indentation)print_token(),restore_mode();else restore_mode(),print_token();if(remove_redundant_indentation(previous_flags),flags.do_while&&previous_flags.mode===MODE.Conditional)previous_flags.mode=MODE.Expression,flags.do_block=!1,flags.do_while=!1}function handle_start_block(){set_mode(MODE.BlockStatement);var empty_braces=is_next("}"),empty_anonymous_function=empty_braces&&"function"===flags.last_word&&"TK_END_EXPR"===last_type;if("expand"===opt.brace_style)if("TK_OPERATOR"!==last_type&&(empty_anonymous_function||"TK_EQUALS"===last_type||is_special_word(flags.last_text)&&"else"!==flags.last_text))output_space_before_token=!0;else print_newline();else if("TK_OPERATOR"!==last_type&&"TK_START_EXPR"!==last_type)if("TK_START_BLOCK"===last_type)print_newline();else output_space_before_token=!0;else if(is_array(previous_flags.mode)&&","===flags.last_text)if("}"===last_last_text)output_space_before_token=!0;else print_newline();print_token(),indent()}function handle_end_block(){for(;flags.mode===MODE.Statement;)restore_mode();var empty_braces="TK_START_BLOCK"===last_type;if("expand"===opt.brace_style){if(!empty_braces)print_newline()}else if(!empty_braces)if(is_array(flags.mode)&&opt.keep_array_indentation)opt.keep_array_indentation=!1,print_newline(),opt.keep_array_indentation=!0;else print_newline();restore_mode(),print_token()}function handle_word(){if(start_of_statement());else if(input_wanted_newline&&!is_expression(flags.mode)&&("TK_OPERATOR"!==last_type||"--"===flags.last_text||"++"===flags.last_text)&&"TK_EQUALS"!==last_type&&(opt.preserve_newlines||"var"!==flags.last_text))print_newline();if(flags.do_block&&!flags.do_while)if("while"===token_text)return output_space_before_token=!0,print_token(),output_space_before_token=!0,void(flags.do_while=!0);else print_newline(),flags.do_block=!1;if(flags.if_block)if("else"!==token_text){for(;flags.mode===MODE.Statement;)restore_mode();flags.if_block=!1}if("case"===token_text||"default"===token_text&&flags.in_case_statement){if(print_newline(),flags.case_body||opt.jslint_happy)deindent(),flags.case_body=!1;return print_token(),flags.in_case=!0,void(flags.in_case_statement=!0)}if("function"===token_text){if(flags.var_line&&"TK_EQUALS"!==last_type)flags.var_line_reindented=!0;if((just_added_newline()||";"===flags.last_text||"}"===flags.last_text)&&"{"!==flags.last_text&&!is_array(flags.mode))if(!just_added_blankline())print_newline(),print_newline(!0);if("TK_WORD"===last_type)if("get"===flags.last_text||"set"===flags.last_text||"new"===flags.last_text||"return"===flags.last_text)output_space_before_token=!0;else print_newline();else if("TK_OPERATOR"===last_type||"="===flags.last_text)output_space_before_token=!0;else if(is_expression(flags.mode));else print_newline()}if("TK_COMMA"===last_type||"TK_START_EXPR"===last_type||"TK_EQUALS"===last_type||"TK_OPERATOR"===last_type)if(flags.mode!==MODE.ObjectLiteral)allow_wrap_or_preserved_newline();if("function"===token_text)return print_token(),void(flags.last_word=token_text);if(prefix="NONE","TK_END_BLOCK"===last_type)if(!in_array(token_text,["else","catch","finally"]))prefix="NEWLINE";else if("expand"===opt.brace_style||"end-expand"===opt.brace_style)prefix="NEWLINE";else prefix="SPACE",output_space_before_token=!0;else if("TK_SEMICOLON"===last_type&&flags.mode===MODE.BlockStatement)prefix="NEWLINE";else if("TK_SEMICOLON"===last_type&&is_expression(flags.mode))prefix="SPACE";else if("TK_STRING"===last_type)prefix="NEWLINE";else if("TK_WORD"===last_type)prefix="SPACE";else if("TK_START_BLOCK"===last_type)prefix="NEWLINE";else if("TK_END_EXPR"===last_type)output_space_before_token=!0,prefix="NEWLINE";if(in_array(token_text,line_starters)&&")"!==flags.last_text)if("else"===flags.last_text)prefix="SPACE";else prefix="NEWLINE";if(in_array(token_text,["else","catch","finally"]))if("TK_END_BLOCK"!==last_type||"expand"===opt.brace_style||"end-expand"===opt.brace_style)print_newline();else{trim_output(!0);var line=output_lines[output_lines.length-1];if("}"!==line.text[line.text.length-1])print_newline();output_space_before_token=!0}else if("NEWLINE"===prefix){if(is_special_word(flags.last_text))output_space_before_token=!0;else if("TK_END_EXPR"!==last_type){if(("TK_START_EXPR"!==last_type||"var"!==token_text)&&":"!==flags.last_text)if("if"===token_text&&"else"===flags.last_word&&"{"!==flags.last_text)output_space_before_token=!0;else flags.var_line=!1,flags.var_line_reindented=!1,print_newline()}else if(in_array(token_text,line_starters)&&")"!==flags.last_text)flags.var_line=!1,flags.var_line_reindented=!1,print_newline()}else if(is_array(flags.mode)&&","===flags.last_text&&"}"===last_last_text)print_newline();else if("SPACE"===prefix)output_space_before_token=!0;if(print_token(),flags.last_word=token_text,"var"===token_text)flags.var_line=!0,flags.var_line_reindented=!1,flags.var_line_tainted=!1;if("do"===token_text)flags.do_block=!0;if("if"===token_text)flags.if_block=!0}function handle_semicolon(){if(start_of_statement())output_space_before_token=!1;for(;flags.mode===MODE.Statement&&!flags.if_block&&!flags.do_block;)restore_mode();if(print_token(),flags.var_line=!1,flags.var_line_reindented=!1,flags.mode===MODE.ObjectLiteral)flags.mode=MODE.BlockStatement}function handle_string(){if(start_of_statement())output_space_before_token=!0;else if("TK_WORD"===last_type)output_space_before_token=!0;else if("TK_COMMA"===last_type||"TK_START_EXPR"===last_type||"TK_EQUALS"===last_type||"TK_OPERATOR"===last_type){if(flags.mode!==MODE.ObjectLiteral)allow_wrap_or_preserved_newline()}else print_newline();print_token()}function handle_equals(){if(flags.var_line)flags.var_line_tainted=!0;output_space_before_token=!0,print_token(),output_space_before_token=!0}function handle_comma(){if(!flags.var_line)if("TK_END_BLOCK"===last_type&&flags.mode!==MODE.Expression)if(print_token(),flags.mode===MODE.ObjectLiteral&&"}"===flags.last_text)print_newline();else output_space_before_token=!0;else if(flags.mode===MODE.ObjectLiteral)print_token(),print_newline();else print_token(),output_space_before_token=!0;else{if(is_expression(flags.mode)||"TK_END_BLOCK"===last_type)flags.var_line_tainted=!1;if(flags.var_line)flags.var_line_reindented=!0;if(print_token(),flags.var_line_tainted)flags.var_line_tainted=!1,print_newline();else output_space_before_token=!0
}}function handle_operator(){var space_before=!0,space_after=!0;if(is_special_word(flags.last_text))return output_space_before_token=!0,void print_token();if("*"===token_text&&"TK_DOT"===last_type&&!last_last_text.match(/^\d+$/))return void print_token();if(":"===token_text&&flags.in_case)return flags.case_body=!0,indent(),print_token(),print_newline(),void(flags.in_case=!1);if("::"===token_text)return void print_token();if(input_wanted_newline&&("--"===token_text||"++"===token_text))print_newline();if(in_array(token_text,["--","++","!"])||in_array(token_text,["-","+"])&&(in_array(last_type,["TK_START_BLOCK","TK_START_EXPR","TK_EQUALS","TK_OPERATOR"])||in_array(flags.last_text,line_starters)||","===flags.last_text)){if(space_before=!1,space_after=!1,";"===flags.last_text&&is_expression(flags.mode))space_before=!0;if("TK_WORD"===last_type&&in_array(flags.last_text,line_starters))space_before=!0;if(!(flags.mode!==MODE.BlockStatement&&flags.mode!==MODE.Statement||"{"!==flags.last_text&&";"!==flags.last_text))print_newline()}else if(":"===token_text)if(0===flags.ternary_depth){if(flags.mode===MODE.BlockStatement)flags.mode=MODE.ObjectLiteral;space_before=!1}else flags.ternary_depth-=1;else if("?"===token_text)flags.ternary_depth+=1;output_space_before_token=output_space_before_token||space_before,print_token(),output_space_before_token=space_after}function handle_block_comment(){var lines=split_newlines(token_text),j,javadoc=!1;if(print_newline(!1,!0),lines.length>1)if(all_lines_start_with(lines.slice(1),"*"))javadoc=!0;for(print_token(lines[0]),j=1;j<lines.length;j++)if(print_newline(!1,!0),javadoc)print_token(" "+trim(lines[j]));else output_lines[output_lines.length-1].text.push(lines[j]);print_newline(!1,!0)}function handle_inline_comment(){output_space_before_token=!0,print_token(),output_space_before_token=!0}function handle_comment(){if(input_wanted_newline)print_newline(!1,!0);else trim_output(!0);output_space_before_token=!0,print_token(),print_newline(!1,!0)}function handle_dot(){if(is_special_word(flags.last_text))output_space_before_token=!0;else allow_wrap_or_preserved_newline(")"===flags.last_text&&opt.break_chained_methods);print_token()}function handle_unknown(){if(print_token(),"\n"===token_text[token_text.length-1])print_newline()}var input,output_lines,token_text,token_type,last_type,last_last_text,indent_string,flags,previous_flags,flag_store,whitespace,wordchar,punct,parser_pos,line_starters,digits,prefix,input_wanted_newline,output_wrapped,output_space_before_token,input_length,n_newlines,whitespace_before_token,handlers,MODE,opt,preindent_string="";if(whitespace="\n\r	 ".split(""),wordchar="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_$".split(""),digits="0123456789".split(""),punct="+ - * / % & ++ -- = += -= *= /= %= == === != !== > < >= <= >> << >>> >>>= >>= <<= && &= | || ! !! , : ? ^ ^= |= ::",punct+=" <%= <% %> <?= <? ?>",punct=punct.split(" "),line_starters="continue,try,throw,return,var,if,switch,case,default,for,while,break,function".split(","),MODE={BlockStatement:"BlockStatement",Statement:"Statement",ObjectLiteral:"ObjectLiteral",ArrayLiteral:"ArrayLiteral",ForInitializer:"ForInitializer",Conditional:"Conditional",Expression:"Expression"},handlers={TK_START_EXPR:handle_start_expr,TK_END_EXPR:handle_end_expr,TK_START_BLOCK:handle_start_block,TK_END_BLOCK:handle_end_block,TK_WORD:handle_word,TK_SEMICOLON:handle_semicolon,TK_STRING:handle_string,TK_EQUALS:handle_equals,TK_OPERATOR:handle_operator,TK_COMMA:handle_comma,TK_BLOCK_COMMENT:handle_block_comment,TK_INLINE_COMMENT:handle_inline_comment,TK_COMMENT:handle_comment,TK_DOT:handle_dot,TK_UNKNOWN:handle_unknown},options=options?options:{},opt={},void 0!==options.space_after_anon_function&&void 0===options.jslint_happy)options.jslint_happy=options.space_after_anon_function;if(void 0!==options.braces_on_own_line)opt.brace_style=options.braces_on_own_line?"expand":"collapse";if(opt.brace_style=options.brace_style?options.brace_style:opt.brace_style?opt.brace_style:"collapse","expand-strict"===opt.brace_style)opt.brace_style="expand";for(opt.indent_size=options.indent_size?parseInt(options.indent_size,10):4,opt.indent_char=options.indent_char?options.indent_char:" ",opt.preserve_newlines=void 0===options.preserve_newlines?!0:options.preserve_newlines,opt.break_chained_methods=void 0===options.break_chained_methods?!1:options.break_chained_methods,opt.max_preserve_newlines=void 0===options.max_preserve_newlines?0:parseInt(options.max_preserve_newlines,10),opt.space_in_paren=void 0===options.space_in_paren?!1:options.space_in_paren,opt.jslint_happy=void 0===options.jslint_happy?!1:options.jslint_happy,opt.keep_array_indentation=void 0===options.keep_array_indentation?!1:options.keep_array_indentation,opt.space_before_conditional=void 0===options.space_before_conditional?!0:options.space_before_conditional,opt.unescape_strings=void 0===options.unescape_strings?!1:options.unescape_strings,opt.wrap_line_length=void 0===options.wrap_line_length?0:parseInt(options.wrap_line_length,10),opt.e4x=void 0===options.e4x?!1:options.e4x,indent_string="";opt.indent_size>0;)indent_string+=opt.indent_char,opt.indent_size-=1;for(;js_source_text&&(" "===js_source_text.charAt(0)||"	"===js_source_text.charAt(0));)preindent_string+=js_source_text.charAt(0),js_source_text=js_source_text.substring(1);input=js_source_text,input_length=js_source_text.length,last_type="TK_START_BLOCK",last_last_text="",output_lines=[create_output_line()],output_wrapped=!1,output_space_before_token=!1,whitespace_before_token=[],flag_store=[],set_mode(MODE.BlockStatement),parser_pos=0,this.beautify=function(){for(var t,i,keep_whitespace,sweet_code;t=get_next_token(),token_text=t[0],token_type=t[1],"TK_EOF"!==token_type;){if(keep_whitespace=opt.keep_array_indentation&&is_array(flags.mode),input_wanted_newline=n_newlines>0,keep_whitespace)for(i=0;n_newlines>i;i+=1)print_newline(i>0);else{if(opt.max_preserve_newlines&&n_newlines>opt.max_preserve_newlines)n_newlines=opt.max_preserve_newlines;if(opt.preserve_newlines)if(n_newlines>1)for(print_newline(),i=1;n_newlines>i;i+=1)print_newline(!0)}if(handlers[token_type](),"TK_INLINE_COMMENT"!==token_type&&"TK_COMMENT"!==token_type&&"TK_UNKNOWN"!==token_type)last_last_text=flags.last_text,last_type=token_type,flags.last_text=token_text}sweet_code=output_lines[0].text.join("");for(var line_index=1;line_index<output_lines.length;line_index++)sweet_code+="\n"+output_lines[line_index].text.join("");return sweet_code=sweet_code.replace(/[\r\n ]+$/,"")}}if("function"==typeof define)define("js/lib/beautify",[],function(){return js_beautify});else if("undefined"!=typeof exports)exports.js_beautify=js_beautify;else if("undefined"!=typeof window)window.js_beautify=js_beautify;else if("undefined"!=typeof global)global.js_beautify=js_beautify}(),!function(){function css_beautify(source_text,options){function next(){return ch=source_text.charAt(++pos)}function peek(){return source_text.charAt(pos+1)}function eatString(comma){for(var start=pos;next();)if("\\"===ch)next(),next();else if(ch===comma)break;else if("\n"===ch)break;return source_text.substring(start,pos+1)}function eatWhitespace(){for(var start=pos;whiteRe.test(peek());)pos++;return pos!==start}function skipWhitespace(){var start=pos;do;while(whiteRe.test(next()));return pos!==start+1}function eatComment(){var start=pos;for(next();next();)if("*"===ch&&"/"===peek()){pos++;break}return source_text.substring(start,pos+1)}function lookBack(str){return source_text.substring(pos-str.length,pos).toLowerCase()===str}function indent(){indentLevel++,indentString+=singleIndent}function outdent(){indentLevel--,indentString=indentString.slice(0,-indentSize)}options=options||{};var indentSize=options.indent_size||4,indentCharacter=options.indent_char||" ";if("string"==typeof indentSize)indentSize=parseInt(indentSize,10);var whiteRe=/^\s+$/,wordRe=/[\w$\-_]/,pos=-1,ch,indentString=source_text.match(/^[\r\n]*[\t ]*/)[0],singleIndent=Array(indentSize+1).join(indentCharacter),indentLevel=0,print={};print["{"]=function(ch){print.singleSpace(),output.push(ch),print.newLine()},print["}"]=function(ch){print.newLine(),output.push(ch),print.newLine()},print.newLine=function(keepWhitespace){if(!keepWhitespace)for(;whiteRe.test(output[output.length-1]);)output.pop();if(output.length)output.push("\n");if(indentString)output.push(indentString)},print.singleSpace=function(){if(output.length&&!whiteRe.test(output[output.length-1]))output.push(" ")};var output=[];if(indentString)output.push(indentString);for(;;){var isAfterSpace=skipWhitespace();if(!ch)break;if("{"===ch)indent(),print["{"](ch);else if("}"===ch)outdent(),print["}"](ch);else if('"'===ch||"'"===ch)output.push(eatString(ch));else if(";"===ch)output.push(ch,"\n",indentString);else if("/"===ch&&"*"===peek())print.newLine(),output.push(eatComment(),"\n",indentString);else if("("===ch)if(lookBack("url")){if(output.push(ch),eatWhitespace(),next())if(")"!==ch&&'"'!==ch&&"'"!==ch)output.push(eatString(")"));else pos--}else{if(isAfterSpace)print.singleSpace();output.push(ch),eatWhitespace()}else if(")"===ch)output.push(ch);else if(","===ch)eatWhitespace(),output.push(ch),print.singleSpace();else if("]"===ch)output.push(ch);else if("["===ch||"="===ch)eatWhitespace(),output.push(ch);else{if(isAfterSpace)print.singleSpace();output.push(ch)}}var sweetCode=output.join("").replace(/[\n ]+$/,"");return sweetCode}if("function"==typeof define)define("js/lib/beautify-css",[],function(){return{css_beautify:css_beautify}});else if("undefined"!=typeof exports)exports.css_beautify=css_beautify;else if("undefined"!=typeof window)window.css_beautify=css_beautify;else if("undefined"!=typeof global)global.css_beautify=css_beautify}(),!function(){function trim(s){return s.replace(/^\s+|\s+$/g,"")}function ltrim(s){return s.replace(/^\s+/g,"")}function rtrim(s){return s.replace(/\s+$/g,"")}function style_html(html_source,options,js_beautify,css_beautify){function Parser(){return this.pos=0,this.token="",this.current_mode="CONTENT",this.tags={parent:"parent1",parentcount:1,parent1:""},this.tag_type="",this.token_text=this.last_token=this.last_text=this.token_type="",this.newlines=0,this.indent_content=indent_inner_html,this.Utils={whitespace:"\n\r	 ".split(""),single_token:"br,input,link,meta,!doctype,basefont,base,area,hr,wbr,param,img,isindex,?xml,embed,?php,?,?=".split(","),extra_liners:"head,body,/html".split(","),in_array:function(what,arr){for(var i=0;i<arr.length;i++)if(what===arr[i])return!0;return!1}},this.is_whitespace=function(text){for(var n=0;n<text.length;text++)if(!this.Utils.in_array(text.charAt(n),this.Utils.whitespace))return!1;return!0},this.traverse_whitespace=function(){var input_char="";if(input_char=this.input.charAt(this.pos),this.Utils.in_array(input_char,this.Utils.whitespace)){for(this.newlines=0;this.Utils.in_array(input_char,this.Utils.whitespace);){if(preserve_newlines&&"\n"===input_char&&this.newlines<=max_preserve_newlines)this.newlines+=1;this.pos++,input_char=this.input.charAt(this.pos)}return!0}return!1},this.space_or_wrap=function(content){if(this.line_char_count>=this.wrap_line_length)this.print_newline(!1,content),this.print_indentation(content);else this.line_char_count++,content.push(" ")},this.get_content=function(){for(var input_char="",content=[],space=!1;"<"!==this.input.charAt(this.pos);){if(this.pos>=this.input.length)return content.length?content.join(""):["","TK_EOF"];if(!this.traverse_whitespace()){if(indent_handlebars){var peek3=this.input.substr(this.pos,3);if("{{#"===peek3||"{{/"===peek3)break;else if("{{"===this.input.substr(this.pos,2))if("{{else}}"===this.get_tag(!0))break}input_char=this.input.charAt(this.pos),this.pos++,this.line_char_count++,content.push(input_char)}else this.space_or_wrap(content)}return content.length?content.join(""):""},this.get_contents_to=function(name){if(this.pos===this.input.length)return["","TK_EOF"];var input_char="",content="",reg_match=new RegExp("</"+name+"\\s*>","igm");reg_match.lastIndex=this.pos;var reg_array=reg_match.exec(this.input),end_script=reg_array?reg_array.index:this.input.length;if(this.pos<end_script)content=this.input.substring(this.pos,end_script),this.pos=end_script;return content},this.record_tag=function(tag){if(this.tags[tag+"count"])this.tags[tag+"count"]++,this.tags[tag+this.tags[tag+"count"]]=this.indent_level;else this.tags[tag+"count"]=1,this.tags[tag+this.tags[tag+"count"]]=this.indent_level;this.tags[tag+this.tags[tag+"count"]+"parent"]=this.tags.parent,this.tags.parent=tag+this.tags[tag+"count"]},this.retrieve_tag=function(tag){if(this.tags[tag+"count"]){for(var temp_parent=this.tags.parent;temp_parent&&tag+this.tags[tag+"count"]!==temp_parent;)temp_parent=this.tags[temp_parent+"parent"];if(temp_parent)this.indent_level=this.tags[tag+this.tags[tag+"count"]],this.tags.parent=this.tags[temp_parent+"parent"];if(delete this.tags[tag+this.tags[tag+"count"]+"parent"],delete this.tags[tag+this.tags[tag+"count"]],1===this.tags[tag+"count"])delete this.tags[tag+"count"];else this.tags[tag+"count"]--}},this.indent_to_tag=function(tag){if(this.tags[tag+"count"]){for(var temp_parent=this.tags.parent;temp_parent&&tag+this.tags[tag+"count"]!==temp_parent;)temp_parent=this.tags[temp_parent+"parent"];if(temp_parent)this.indent_level=this.tags[tag+this.tags[tag+"count"]]}},this.get_tag=function(peek){var input_char="",content=[],comment="",space=!1,tag_start,tag_end,tag_start_char,orig_pos=this.pos,orig_line_char_count=this.line_char_count;peek=void 0!==peek?peek:!1;do{if(this.pos>=this.input.length){if(peek)this.pos=orig_pos,this.line_char_count=orig_line_char_count;return content.length?content.join(""):["","TK_EOF"]}if(input_char=this.input.charAt(this.pos),this.pos++,!this.Utils.in_array(input_char,this.Utils.whitespace)){if("'"===input_char||'"'===input_char)input_char+=this.get_unformatted(input_char),space=!0;if("="===input_char)space=!1;if(content.length&&"="!==content[content.length-1]&&">"!==input_char&&space)this.space_or_wrap(content),space=!1;if(indent_handlebars&&"<"===tag_start_char)if(input_char+this.input.charAt(this.pos)==="{{"){if(input_char+=this.get_unformatted("}}"),content.length&&" "!==content[content.length-1]&&"<"!==content[content.length-1])input_char=" "+input_char;space=!0}if("<"===input_char&&!tag_start_char)tag_start=this.pos-1,tag_start_char="<";if(indent_handlebars&&!tag_start_char)if(content.length>=2&&"{"===content[content.length-1]&&"{"==content[content.length-2]){if("#"===input_char||"/"===input_char)tag_start=this.pos-3;else tag_start=this.pos-2;tag_start_char="{"}if(this.line_char_count++,content.push(input_char),content[1]&&"!"===content[1]){content=[this.get_comment(tag_start)];break}if(indent_handlebars&&"{"===tag_start_char&&content.length>2&&"}"===content[content.length-2]&&"}"===content[content.length-1])break}else space=!0}while(">"!==input_char);var tag_complete=content.join(""),tag_index,tag_offset;if(-1!==tag_complete.indexOf(" "))tag_index=tag_complete.indexOf(" ");else if("{"===tag_complete[0])tag_index=tag_complete.indexOf("}");else tag_index=tag_complete.indexOf(">");if("<"===tag_complete[0]||!indent_handlebars)tag_offset=1;else tag_offset="#"===tag_complete[2]?3:2;var tag_check=tag_complete.substring(tag_offset,tag_index).toLowerCase();if("/"===tag_complete.charAt(tag_complete.length-2)||this.Utils.in_array(tag_check,this.Utils.single_token)){if(!peek)this.tag_type="SINGLE"}else if(indent_handlebars&&"{"===tag_complete[0]&&"else"===tag_check){if(!peek)this.indent_to_tag("if"),this.tag_type="HANDLEBARS_ELSE",this.indent_content=!0,this.traverse_whitespace()}else if("script"===tag_check){if(!peek)this.record_tag(tag_check),this.tag_type="SCRIPT"}else if("style"===tag_check){if(!peek)this.record_tag(tag_check),this.tag_type="STYLE"}else if(this.is_unformatted(tag_check,unformatted))comment=this.get_unformatted("</"+tag_check+">",tag_complete),content.push(comment),tag_end=this.pos-1,this.tag_type="SINGLE";else if("!"===tag_check.charAt(0)){if(!peek)this.tag_type="SINGLE",this.traverse_whitespace()}else if(!peek){if("/"===tag_check.charAt(0)){if(this.retrieve_tag(tag_check.substring(1)),this.tag_type="END",this.traverse_whitespace())this.space_or_wrap(content)}else{if(this.record_tag(tag_check),"html"!==tag_check.toLowerCase())this.indent_content=!0;if(this.tag_type="START",this.traverse_whitespace())this.space_or_wrap(content)}if(this.Utils.in_array(tag_check,this.Utils.extra_liners))if(this.print_newline(!1,this.output),this.output.length&&"\n"!==this.output[this.output.length-2])this.print_newline(!0,this.output)}if(peek)this.pos=orig_pos,this.line_char_count=orig_line_char_count;return content.join("")},this.get_comment=function(start_pos){var comment="",delimiter=">",matched=!1;for(this.pos=start_pos,input_char=this.input.charAt(this.pos),this.pos++;this.pos<=this.input.length&&(comment+=input_char,comment[comment.length-1]!==delimiter[delimiter.length-1]||-1===comment.indexOf(delimiter));){if(!matched&&comment.length<10)if(0===comment.indexOf("<![if"))delimiter="<![endif]>",matched=!0;else if(0===comment.indexOf("<![cdata["))delimiter="]]>",matched=!0;else if(0===comment.indexOf("<!["))delimiter="]>",matched=!0;else if(0===comment.indexOf("<!--"))delimiter="-->",matched=!0;input_char=this.input.charAt(this.pos),this.pos++}return comment},this.get_unformatted=function(delimiter,orig_tag){if(orig_tag&&-1!==orig_tag.toLowerCase().indexOf(delimiter))return"";var input_char="",content="",min_index=0,space=!0;do{if(this.pos>=this.input.length)return content;if(input_char=this.input.charAt(this.pos),this.pos++,this.Utils.in_array(input_char,this.Utils.whitespace)){if(!space){this.line_char_count--;continue}if("\n"===input_char||"\r"===input_char){content+="\n",this.line_char_count=0;continue}}if(content+=input_char,this.line_char_count++,space=!0,indent_handlebars&&"{"===input_char&&content.length&&"{"===content[content.length-2])content+=this.get_unformatted("}}"),min_index=content.length}while(-1===content.toLowerCase().indexOf(delimiter,min_index));return content},this.get_token=function(){var token;if("TK_TAG_SCRIPT"===this.last_token||"TK_TAG_STYLE"===this.last_token){var type=this.last_token.substr(7);if(token=this.get_contents_to(type),"string"!=typeof token)return token;else return[token,"TK_"+type]}if("CONTENT"===this.current_mode)if(token=this.get_content(),"string"!=typeof token)return token;else return[token,"TK_CONTENT"];if("TAG"===this.current_mode)if(token=this.get_tag(),"string"!=typeof token)return token;else{var tag_name_type="TK_TAG_"+this.tag_type;return[token,tag_name_type]}},this.get_full_indent=function(level){if(level=this.indent_level+level||0,1>level)return"";else return Array(level+1).join(this.indent_string)},this.is_unformatted=function(tag_check,unformatted){if(!this.Utils.in_array(tag_check,unformatted))return!1;if("a"!==tag_check.toLowerCase()||!this.Utils.in_array("a",unformatted))return!0;var next_tag=this.get_tag(!0),tag=(next_tag||"").match(/^\s*<\s*\/?([a-z]*)\s*[^>]*>\s*$/);if(!tag||this.Utils.in_array(tag,unformatted))return!0;else return!1},this.printer=function(js_source,indent_character,indent_size,wrap_line_length,brace_style){this.input=js_source||"",this.output=[],this.indent_character=indent_character,this.indent_string="",this.indent_size=indent_size,this.brace_style=brace_style,this.indent_level=0,this.wrap_line_length=wrap_line_length,this.line_char_count=0;for(var i=0;i<this.indent_size;i++)this.indent_string+=this.indent_character;this.print_newline=function(force,arr){if(this.line_char_count=0,arr&&arr.length)if(force||"\n"!==arr[arr.length-1])arr.push("\n")},this.print_indentation=function(arr){for(var i=0;i<this.indent_level;i++)arr.push(this.indent_string),this.line_char_count+=this.indent_string.length},this.print_token=function(text){if(!this.is_whitespace(text)||this.output.length){if(text||""!==text)if(this.output.length&&"\n"===this.output[this.output.length-1])this.print_indentation(this.output),text=ltrim(text);this.print_token_raw(text)}},this.print_token_raw=function(text){if(this.newlines>0)text=rtrim(text);if(text&&""!==text)if(text.length>1&&"\n"===text[text.length-1])this.output.push(text.slice(0,-1)),this.print_newline(!1,this.output);else this.output.push(text);for(var n=0;n<this.newlines;n++)this.print_newline(n>0,this.output);this.newlines=0},this.indent=function(){this.indent_level++},this.unindent=function(){if(this.indent_level>0)this.indent_level--}},this}var multi_parser,indent_inner_html,indent_size,indent_character,wrap_line_length,brace_style,unformatted,preserve_newlines,max_preserve_newlines;if(options=options||{},!(void 0!==options.wrap_line_length&&0!==parseInt(options.wrap_line_length,10)||void 0!==options.max_char&&0!==parseInt(options.max_char,10)))options.wrap_line_length=options.max_char;for(indent_inner_html=options.indent_inner_html||!1,indent_size=parseInt(options.indent_size||4,10),indent_character=options.indent_char||" ",brace_style=options.brace_style||"collapse",wrap_line_length=0===parseInt(options.wrap_line_length,10)?32786:parseInt(options.wrap_line_length||250,10),unformatted=options.unformatted||["a","span","img","bdo","em","strong","dfn","code","samp","kbd","var","cite","abbr","acronym","q","sub","sup","tt","i","b","big","small","u","s","strike","font","ins","del","pre","address","dt","h1","h2","h3","h4","h5","h6"],preserve_newlines=options.preserve_newlines||!0,max_preserve_newlines=preserve_newlines?parseInt(options.max_preserve_newlines||32786,10):0,indent_handlebars=options.indent_handlebars||!1,multi_parser=new Parser,multi_parser.printer(html_source,indent_character,indent_size,wrap_line_length,brace_style);;){var t=multi_parser.get_token();if(multi_parser.token_text=t[0],multi_parser.token_type=t[1],"TK_EOF"===multi_parser.token_type)break;switch(multi_parser.token_type){case"TK_TAG_START":if(multi_parser.print_newline(!1,multi_parser.output),multi_parser.print_token(multi_parser.token_text),multi_parser.indent_content)multi_parser.indent(),multi_parser.indent_content=!1;multi_parser.current_mode="CONTENT";break;case"TK_TAG_STYLE":case"TK_TAG_SCRIPT":multi_parser.print_newline(!1,multi_parser.output),multi_parser.print_token(multi_parser.token_text),multi_parser.current_mode="CONTENT";break;case"TK_TAG_END":if("TK_CONTENT"===multi_parser.last_token&&""===multi_parser.last_text){var tag_name=multi_parser.token_text.match(/\w+/)[0],tag_extracted_from_last_output=null;if(multi_parser.output.length)tag_extracted_from_last_output=multi_parser.output[multi_parser.output.length-1].match(/(?:<|{{#)\s*(\w+)/);if(null===tag_extracted_from_last_output||tag_extracted_from_last_output[1]!==tag_name)multi_parser.print_newline(!1,multi_parser.output)}multi_parser.print_token(multi_parser.token_text),multi_parser.current_mode="CONTENT";break;case"TK_TAG_SINGLE":var tag_check=multi_parser.token_text.match(/^\s*<([a-z]+)/i);if(!tag_check||!multi_parser.Utils.in_array(tag_check[1],unformatted))multi_parser.print_newline(!1,multi_parser.output);multi_parser.print_token(multi_parser.token_text),multi_parser.current_mode="CONTENT";break;case"TK_TAG_HANDLEBARS_ELSE":if(multi_parser.print_token(multi_parser.token_text),multi_parser.indent_content)multi_parser.indent(),multi_parser.indent_content=!1;multi_parser.current_mode="CONTENT";break;case"TK_CONTENT":multi_parser.print_token(multi_parser.token_text),multi_parser.current_mode="TAG";break;case"TK_STYLE":case"TK_SCRIPT":if(""!==multi_parser.token_text){multi_parser.print_newline(!1,multi_parser.output);var text=multi_parser.token_text,_beautifier,script_indent_level=1;if("TK_SCRIPT"===multi_parser.token_type)_beautifier="function"==typeof js_beautify&&js_beautify;else if("TK_STYLE"===multi_parser.token_type)_beautifier="function"==typeof css_beautify&&css_beautify;if("keep"===options.indent_scripts)script_indent_level=0;else if("separate"===options.indent_scripts)script_indent_level=-multi_parser.indent_level;var indentation=multi_parser.get_full_indent(script_indent_level);if(_beautifier)text=_beautifier(text.replace(/^\s*/,indentation),options);else{var white=text.match(/^\s*/)[0],_level=white.match(/[^\n\r]*$/)[0].split(multi_parser.indent_string).length-1,reindent=multi_parser.get_full_indent(script_indent_level-_level);text=text.replace(/^\s*/,indentation).replace(/\r\n|\r|\n/g,"\n"+reindent).replace(/\s+$/,"")}if(text)multi_parser.print_token_raw(indentation+trim(text)),multi_parser.print_newline(!1,multi_parser.output)}multi_parser.current_mode="TAG"}multi_parser.last_token=multi_parser.token_type,multi_parser.last_text=multi_parser.token_text}return multi_parser.output.join("")}if("function"==typeof define)define("js/lib/beautify-html",["js/lib/beautify","js/lib/beautify-css"],function(js_beautify,css_beautify){return{html_beautify:function(html_source,options){return style_html(html_source,options,js_beautify,css_beautify)}}});else if("undefined"!=typeof exports){var js_beautify=require("./beautify.js").js_beautify,css_beautify=require("./beautify-css.js").css_beautify;exports.html_beautify=function(html_source,options){return style_html(html_source,options,js_beautify,css_beautify)}}else if("undefined"!=typeof window)window.html_beautify=function(html_source,options){return style_html(html_source,options,window.js_beautify,window.css_beautify)};else if("undefined"!=typeof global)global.html_beautify=function(html_source,options){return style_html(html_source,options,global.js_beautify,global.css_beautify)}}(),function(){var DEFAULT_OPTIONS,HtmlParser,PREVIOUS_MD,REGEX,REPLACEMENTS,R_HIDDEN_STYLES,R_HIDDEN_VALUE,R_IGNORE_CHILDREN,R_PARAGRAPH_ONLY,key,md,padLeft,result,__hasProp={}.hasOwnProperty,_this=this;DEFAULT_OPTIONS={absolute:!1,base:"undefined"!=typeof window&&null!==window?window.document.baseURI:"file://"+process.cwd(),debug:!1,inline:!1},PREVIOUS_MD=this.md,REPLACEMENTS={"\\\\":"\\\\","\\[":"\\[","\\]":"\\]",">":"\\>",_:"\\_","\\*":"\\*","`":"\\`","#":"\\#","([0-9])\\.(\\s|$)":"$1\\.$2","©":"(c)","®":"(r)","™":"(tm)"," ":" ","·":"\\*"," ":" "," ":" "," ":" ","‘":"'","’":"'","“":'"',"”":'"',"…":"...","–":"--","—":"---"},R_HIDDEN_STYLES=/(display|visibility)\s*:\s*[a-z]+/gi,R_HIDDEN_VALUE=/(none|hidden)\s*$/i,R_IGNORE_CHILDREN=/^(APPLET|AREA|AUDIO|BUTTON|CANVAS|DATALIST|EMBED|HEAD|INPUT|MAP|MENU|METER|NOFRAMES|NOSCRIPT|OBJECT|OPTGROUP|OPTION|PARAM|PROGRESS|RP|RT|RUBY|SCRIPT|SELECT|STYLE|TEXTAREA|TITLE|VIDEO)$/,R_PARAGRAPH_ONLY=/^(ADDRESS|ARTICLE|ASIDE|DIV|FIELDSET|FOOTER|HEADER|NAV|P|SECTION)$/,REGEX=function(){result={};for(key in REPLACEMENTS)if(__hasProp.call(REPLACEMENTS,key))result[key]=new RegExp(key,"g");else;return result}(),padLeft=function(str,times,padStr){var i,_i;if(null==str)str="";if(null==times)times=0;if(null==padStr)padStr=" ";if(!padStr)return str;for(i=_i=0;times>=0?times>_i:_i>times;i=times>=0?++_i:--_i)str=padStr+str;return str},HtmlParser=function(){function HtmlParser(html,options){var defaultValue,doc;if(this.html=null!=html?html:"",this.options=null!=options?options:{},this.atLeft=this.atNoWS=this.atP=!0,this.buffer="",this.exceptions=[],this.order=1,this.listDepth=0,this.inCode=this.inPre=this.inOrderedList=!1,this.last=null,this.left="\n",this.links=[],this.linkMap={},this.unhandled={},this.tableColumns=[],this.tableDepth=0,"object"!=typeof this.options)this.options={};for(key in DEFAULT_OPTIONS)if(__hasProp.call(DEFAULT_OPTIONS,key)){if(defaultValue=DEFAULT_OPTIONS[key],"undefined"==typeof this.options[key])this.options[key]=defaultValue}else;if(this.win="undefined"!=typeof window&&null!==window?window:null,null==this.win)doc=require("jsdom").jsdom(null,null,{features:{FetchExternalResources:!1},url:this.options.base}),this.win=doc.createWindow();if(null==this.win.Node)this.win.Node={ELEMENT_NODE:1,TEXT_NODE:3}}return HtmlParser.prototype.append=function(str){if(null!=this.last)this.buffer+=this.last;return this.last=str},HtmlParser.prototype.attr=function(ele,attribute,direct){var value;if(null==direct)direct=!0;return value=direct||"function"!=typeof ele.getAttribute?ele[attribute]:ele.getAttribute(attribute),null!=value?value:""},HtmlParser.prototype.br=function(){return this.append("  "+this.left),this.atLeft=this.atNoWS=!0},HtmlParser.prototype.tr=function(){var _this=this;return this.output("|"),this.tableColumns[++this.tableDepth]=[],function(){var column,tableColumns,_i,_len;if(tableColumns=_this.tableColumns[_this.tableDepth],tableColumns.length){for(_this.output("\n|"),_i=0,_len=tableColumns.length;_len>_i;_i++){switch(column=tableColumns[_i]){case"right":_this.output("----:");break;case"center":_this.output(":----:");break;default:_this.output(":----")}_this.output("|")}delete _this.tableColumns[_this.tableDepth--]}return _this.output("\n")}},HtmlParser.prototype.code=function(){var old,_this=this;return old=this.inCode,this.inCode=!0,function(){return _this.inCode=old}},HtmlParser.prototype.has=function(ele,attribute,direct){if(null==direct)direct=!0;if(direct||"function"!=typeof ele.hasAttribute)return ele.hasOwnProperty(attribute);else return ele.hasAttribute(attribute)},HtmlParser.prototype.inCodeProcess=function(str){return str.replace(/`/g,"\\`")},HtmlParser.prototype.isVisible=function(ele){var display,err,properties,property,style,visibility,visible,_i,_len;if(style=this.attr(ele,"style",!1),properties=null!=style?"function"==typeof style.match?style.match(R_HIDDEN_STYLES):void 0:void 0,visible=!0,null!=properties)for(_i=0,_len=properties.length;_len>_i;_i++)property=properties[_i],visible=!R_HIDDEN_VALUE.test(property);if(visible&&"function"==typeof this.win.getComputedStyle)try{if(style=this.win.getComputedStyle(ele,null),"function"==typeof(null!=style?style.getPropertyValue:void 0))display=style.getPropertyValue("display"),visibility=style.getPropertyValue("visibility"),visible="none"!==display&&"hidden"!==visibility}catch(_error){err=_error,this.thrown(err,"getComputedStyle")}return visible},HtmlParser.prototype.li=function(){var str;return str=this.inOrderedList?""+this.order++ +". ":"* ",str=padLeft(str,2*(this.listDepth-1)),this.append(str)},HtmlParser.prototype.nonPreProcess=function(str){var value;str=str.replace(/\n([ \t]*\n)+/g,"\n"),str=str.replace(/\n[ \t]+/g,"\n"),str=str.replace(/[ \t]+/g," ");for(key in REPLACEMENTS)if(__hasProp.call(REPLACEMENTS,key))value=REPLACEMENTS[key],str=str.replace(REGEX[key],value);else;return str},HtmlParser.prototype.ol=function(){var inOrderedList,order,_this=this;if(0===this.listDepth)this.p();return inOrderedList=this.inOrderedList,order=this.order,this.inOrderedList=!0,this.order=1,this.listDepth++,function(){return _this.inOrderedList=inOrderedList,_this.order=order,_this.listDepth--}},HtmlParser.prototype.output=function(str){if(str){if(!this.inPre)str=this.atNoWS?str.replace(/^[ \t\n]+/,""):/^[ \t]*\n/.test(str)?str.replace(/^[ \t\n]+/,"\n"):str.replace(/^[ \t]+/," ");if(""!==str)return this.atP=/\n\n$/.test(str),this.atLeft=/\n$/.test(str),this.atNoWS=/[ \t\n]$/.test(str),this.append(str.replace(/\n/g,this.left))}},HtmlParser.prototype.outputLater=function(str){var _this=this;return function(){return _this.output(str)}},HtmlParser.prototype.p=function(){if(!this.atP){if(!this.atLeft)this.append(this.left),this.atLeft=!0;return this.append(this.left),this.atNoWS=this.atP=!0}},HtmlParser.prototype.parse=function(){var container,i,link,tag,unhandledTags,_i,_len,_ref;if(this.buffer="",!this.html)return this.buffer;if(container=this.win.document.createElement("div"),"string"==typeof this.html)container.innerHTML=this.html;else container.appendChild(this.html);if(this.process(container),this.links.length)for(this.append("\n\n"),_ref=this.links,i=_i=0,_len=_ref.length;_len>_i;i=++_i)if(link=_ref[i])this.append("["+i+"]: "+link+"\n");if(this.options.debug)unhandledTags=function(){var _ref1,_results;_ref1=this.unhandled,_results=[];for(tag in _ref1)if(__hasProp.call(_ref1,tag))_results.push(tag);else;return _results}.call(this).sort(),console.log(unhandledTags.length?"Ignored tags;\n"+unhandledTags.join(", "):"No tags were ignored"),console.log(this.exceptions.length?"Exceptions;\n"+this.exceptions.join("\n"):"No exceptions were thrown");
return this.append(""),this.buffer=this.buffer.replace(/\s+$/,"")},HtmlParser.prototype.pre=function(){var old,_this=this;return old=this.inPre,this.inPre=!0,function(){return _this.inPre=old}},HtmlParser.prototype.process=function(ele){var after,after1,after2,alignment,childNode,err,href,i,ignoreEmptyChild,level,skipChildren,src,suffix,summary,title,_base,_i,_len,_ref,_ref1;if(this.isVisible(ele))if(ele.nodeType===this.win.Node.ELEMENT_NODE){skipChildren=!1,ignoreEmptyChild=!1;try{if(R_IGNORE_CHILDREN.test(ele.tagName))skipChildren=!0;else if(/^H[1-6]$/.test(ele.tagName))level=parseInt(ele.tagName.match(/([1-6])$/)[1]),this.p(),this.output(""+function(){var _i,_results;for(_results=[],i=_i=1;level>=1?level>=_i:_i>=level;i=level>=1?++_i:--_i)_results.push("#");return _results}().join("")+" ");else if(R_PARAGRAPH_ONLY.test(ele.tagName))this.p();else switch(ele.tagName){case"BODY":case"FORM":break;case"DETAILS":if(this.p(),!this.has(ele,"open",!1))if(skipChildren=!0,summary=ele.getElementsByTagName("summary")[0])this.process(summary);break;case"BR":this.br();break;case"HR":this.p(),this.output("---"),this.p();break;case"CITE":case"DFN":case"EM":case"I":case"U":case"VAR":this.output("_"),this.atNoWS=!0,after=this.outputLater("_");break;case"DT":case"B":case"STRONG":if("DT"===ele.tagName)this.p();this.output("**"),this.atNoWS=!0,after=this.outputLater("**");break;case"Q":this.output('"'),this.atNoWS=!0,after=this.outputLater('"');break;case"OL":case"UL":after="OL"===ele.tagName?this.ol():this.ul();break;case"LI":this.replaceLeft("\n"),this.li();break;case"PRE":after1=this.pushLeft("    "),after2=this.pre(),after=function(){return after1(),after2()};break;case"CODE":case"KBD":case"SAMP":if(this.inPre)break;this.output("`"),after1=this.code(),after2=this.outputLater("`"),after=function(){return after1(),after2()};break;case"BLOCKQUOTE":case"DD":after=this.pushLeft("> ");break;case"A":if(href=this.attr(ele,"href",this.options.absolute),!href)break;if(title=this.attr(ele,"title"))href+=' "'+title+'"';suffix=this.options.inline?"("+href+")":"["+(null!=(_base=this.linkMap)[href]?(_base=this.linkMap)[href]:_base[href]=this.links.push(href)-1)+"]",this.output("["),this.atNoWS=!0,after=this.outputLater("]"+suffix);break;case"IMG":if(skipChildren=!0,src=this.attr(ele,"src",this.options.absolute),!src)break;this.output("!["+this.attr(ele,"alt")+"]("+src+")");break;case"FRAME":case"IFRAME":skipChildren=!0;try{if(null!=(_ref=ele.contentDocument)?_ref.documentElement:void 0)this.process(ele.contentDocument.documentElement)}catch(_error){err=_error,this.thrown(err,"contentDocument")}break;case"TR":ignoreEmptyChild=!0,after=this.tr();break;case"THEAD":case"TFOOT":case"TBODY":case"TABLE":ignoreEmptyChild=!0;break;case"TH":alignment=ele.style?ele.style.textAlign:"left",this.tableColumns[this.tableDepth].push(alignment),after=this.outputLater("|");break;case"TD":after=this.outputLater("|");break;default:if(this.options.debug)this.unhandled[ele.tagName]=null}}catch(_error){err=_error,this.thrown(err,ele.tagName)}if(!skipChildren)for(_ref1=ele.childNodes,_i=0,_len=_ref1.length;_len>_i;_i++)if(childNode=_ref1[_i],ignoreEmptyChild===!1||!1===/\s+/.test(childNode.nodeValue))this.process(childNode);return null!=after?after.call(this):void 0}else if(ele.nodeType===this.win.Node.TEXT_NODE)return this.output(this.inPre?ele.nodeValue:this.inCode?this.inCodeProcess(ele.nodeValue):this.nonPreProcess(ele.nodeValue))},HtmlParser.prototype.pushLeft=function(str){var old,_this=this;if(old=this.left,this.left+=str,this.atP)this.append(str);else this.p();return function(){return _this.left=old,_this.atLeft=_this.atP=!1,_this.p()}},HtmlParser.prototype.replaceLeft=function(str){if(!this.atLeft)return this.append(this.left.replace(/[ ]{2,4}$/,str)),this.atLeft=this.atNoWS=this.atP=!0;else if(this.last)return this.last=this.last.replace(/[ ]{2,4}$/,str)},HtmlParser.prototype.thrown=function(exception,message){if(this.options.debug)return this.exceptions.push(""+message+": "+exception);else return void 0},HtmlParser.prototype.ul=function(){var inOrderedList,order,_this=this;if(0===this.listDepth)this.p();return inOrderedList=this.inOrderedList,order=this.order,this.inOrderedList=!1,this.order=1,this.listDepth++,function(){return _this.inOrderedList=inOrderedList,_this.order=order,_this.listDepth--}},HtmlParser}();var md=md=function(html,options){return new HtmlParser(html,options).parse()};if(md.version=md.VERSION="3.0.2",md.noConflict=function(){return _this.md=PREVIOUS_MD,md},"undefined"!=typeof module&&null!==module?module.exports:void 0)module.exports=md;else if("function"==typeof define&&define.amd)define("js/lib/html.md",[],function(){return md});else window.htmlMD=md}.call(this),!function(global){var init=function($,_,wysiEditor,toolbarTemplate,toolbarTemplate_t,sourceFooterTemplate,sourceFooterTemplate_t,mdFooterTemplate,mdFooterTemplate_t,richFooterTemplate,richFooterTemplate_t,Modal,cookie,prettyify,Marked,HTML2Markdown){return wysiEditor.defaults=$.extend(wysiEditor.defaults,{"toolbar.modes":!0,"toolbar.mode.html":!0,"toolbar.mode.markdown":!1,"toolbar.mode.rich":!0,"composer.default":"rich","composer.group":"wysihtml5","composer.defaultPersist":!0,"footer.markdown":!1,"footer.html":!1,"footer.rich":!1,"toolbar.preview":!0}),wysiEditor.plugin("modes",function(editor,$toolbar,$footer,options){if(options["toolbar.modes"]){var sourceClass=options["prefix.css"]+"-toolbar-mode-html",wysiClass=options["prefix.css"]+"-toolbar-mode-rich",mdClass=options["prefix.css"]+"-toolbar-mode-markdown",modeCookie=options["prefix.data"].replace(/-/g,".")+"default.mode."+options["composer.group"],currentEditor,$item=$(toolbarTemplate({_t:toolbarTemplate_t,prefix:options["prefix.css"],editor:editor,preview:options["toolbar.preview"],mode:{html:options["toolbar.mode.html"],markdown:options["toolbar.mode.markdown"],rich:options["toolbar.mode.rich"]}}));wysiEditor.insertIntoRightToolbar($toolbar,$item,100);var lastEditor=wysiClass,$markdownTextarea=null,setModeDefault=function(mode){var $button=$toolbar.find("."+options["prefix.css"]+"-toolbar-mode-"+mode);if(options["composer.defaultPersist"])cookie.set(modeCookie,mode,{expires:36500});currentEditor=mode,$toolbar.find("."+options["prefix.css"]+"-toolbar-mode-editor-label").html($button.html()),$toolbar.find("[data-wysihtml5-custom-command=change-editor]").removeClass("wysihtml5-command-active"),$toolbar.find("."+options["prefix.css"]+"-toolbar-mode-"+mode).addClass("wysihtml5-command-active")},hideEditors=function(){var mode=currentEditor;if("html"==mode)$(editor.textareaElement).hide();else if("rich"==mode)$toolbar.addClass("wysihtml5-commands-disabled"),$(editor.composer.iframe).hide();else if("markdown"==mode)$markdownTextarea.hide();$footer.hide(),editor.fire("modeChange","preview")},showEditors=function(){var mode=currentEditor;if("html"==mode)$(editor.textareaElement).show().focus();else if("rich"==mode)$toolbar.removeClass("wysihtml5-commands-disabled"),$(editor.composer.iframe).show(),editor.focus();else if("markdown"==mode)$markdownTextarea.show().focus();$footer.show(),$(editor.textareaElement).parent().find("#"+options["prefix.css"]+"-toolbar-mode-previewer-"+editor.uid).remove(),editor.fire("modeChange",mode)},modePreview=function(){$toolbar.find("."+options["prefix.css"]+"-toolbar-mode-editor").hide(),$toolbar.find("."+options["prefix.css"]+"-toolbar-mode-preview-close").show(),$toolbar.find("."+options["prefix.css"]+"-toolbar-mode-preview").addClass("on").attr({"aria-pressed":"true"});var $textarea=$(editor.textareaElement),$oframe=$(editor.composer.iframe),$frame=$oframe.clone().removeClass("wysihtml5-sandbox").addClass(options["prefix.css"]+"-toolbar-mode-previewer").attr({id:options["prefix.css"]+"-toolbar-mode-previewer-"+editor.uid}),$div=$("<div>").hide().addClass(editor.config.composeClassName).appendTo($toolbar),attrs=["dir"],styles=["color","cursor","font-family","font-size","font-style","font-variant","font-weight","line-height","letter-spacing","text-align","text-decoration","text-indent","text-rendering","word-break","word-wrap","word-spacing"];hideEditors(),$frame.load(function(){var doc=$frame[0].contentWindow.document,odoc=$oframe[0].contentWindow.document,$textarea=$(editor.textareaElement),$obody=$("body",odoc),$body=$("body",doc);_.each(attrs,function(attr){var textareaAttrValue=$textarea.attr(attr);if(void 0!==textareaAttrValue)$body.attr(attr,textareaAttrValue)}),_.each(styles,function(style){$body.css(style,$obody.css(style))}),$body.addClass(options["prefix.css"]+"-preview");var $head=$("head",doc);_.each(editor.config.stylesheets,function(stylesheet){$("<link>",doc).attr({rel:"stylesheet",href:stylesheet}).appendTo($head)}),$div.append(editor.getValue(!0)).show(),editor.fire("preview",$div[0]),$div.appendTo($body);var resize=function(){var $bodyChildren=$body.children(),offsetTop=$bodyChildren.length&&1==$bodyChildren.get(0).nodeType?$bodyChildren.get(0).offsetTop:0;$frame.height($body.get(0).scrollHeight+offsetTop)};window.setTimeout(function(){resize(),window.setTimeout(resize,200)},0)}),$frame.css({border:"none",padding:0}).insertBefore($textarea).show()},modePreviewClose=function(){$toolbar.find("."+options["prefix.css"]+"-toolbar-mode-editor").show(),$toolbar.find("."+options["prefix.css"]+"-toolbar-mode-preview").show().removeClass("on").attr({"aria-pressed":"false"}),$toolbar.find("."+options["prefix.css"]+"-toolbar-mode-preview-close").hide(),$toolbar.find("."+options["prefix.css"]+"-toolbar-mode-previewer").remove(),showEditors()},handleWysiMode=function(focus){var $html;if(editor.fire("change_view","composer",focus),editor.fire("modeChange","rich"),lastEditor=wysiClass,options["footer.rich"]!==!1)if(_.isFunction(options["footer.rich"]))$html=$(options["footer.rich"]({options:options,editor:editor}));else $html=$(options["footer.rich"]||"");else $html=$(richFooterTemplate({_t:richFooterTemplate_t,prefix:options["prefix.css"]}));setModeDefault("rich"),wysiEditor.updateFooter($footer,$html),editor.fire("toggleToWysiMode")},handleSourceMode=function(focus){var $html;if(lastEditor!=mdClass)editor.fire("change_view","textarea",focus);if(lastEditor=sourceClass,editor.fire("modeChange","html"),options["footer.html"]!==!1)if(_.isFunction(options["footer.html"]))$html=$(options["footer.html"]({options:options,editor:editor}));else $html=$(options["footer.html"]);else $html=$(sourceFooterTemplate({_t:sourceFooterTemplate_t,prefix:options["prefix.css"]})),$html.find("a[data-wysihtml5-link=help]").on("click",function(e){e.preventDefault(),Modal($html.find(".modal")).open()}),$html.find("a[data-wysihtml5-link=format]").on("click",function(e){e.preventDefault(),editor.setValue(prettyify.html_beautify(editor.getValue())||editor.getValue()),editor.fire("aftercommand:composer")});setModeDefault("html"),wysiEditor.updateFooter($footer,$html),$(editor.textareaElement).show(),editor.fire("toggleToSourceMode")},handleMarkdownMode=function(focus){var $html,isMarkdownTextAreaBeingSetup=!1;if(editor.fire("modeChange","rich"),lastEditor!=sourceClass)editor.fire("change_view","textarea");if($(editor.textareaElement).hide(),lastEditor=mdClass,!$markdownTextarea)isMarkdownTextAreaBeingSetup=!0,$markdownTextarea=$("<textarea></textarea>").addClass(options["prefix.css"]+"-markdown-editor"),$(editor.textareaElement).after($markdownTextarea),wysiEditor.setupSecondaryTextarea(editor,$markdownTextarea);if($markdownTextarea.val(HTML2Markdown(editor.getValue(),{inline:!0})),$markdownTextarea.on("keyup",function(){editor.setValue(Marked($(this).val(),{math:!0}))}),isMarkdownTextAreaBeingSetup)wysiEditor.setupSecondaryTextarea(editor,$markdownTextarea);if(options["footer.markdown"]!==!1)if(_.isFunction(options["footer.markdown"]))$html=$(options["footer.markdown"]({options:options,editor:editor}));else $html=$(options["footer.markdown"]);else $html=$(mdFooterTemplate({_t:mdFooterTemplate_t,prefix:options["prefix.css"]}));if(setModeDefault("markdown"),wysiEditor.updateFooter($footer,$html),focus)setTimeout(function(){$markdownTextarea.show().focus()},0)};if(options["toolbar.preview"])$toolbar.find("."+options["prefix.css"]+"-toolbar-mode-preview").on("click",function(e){if(!$(this).hasClass("on"))modePreview()}),$toolbar.find("."+options["prefix.css"]+"-toolbar-mode-preview-close").on("click",function(e){modePreviewClose()});$toolbar.find("[data-wysihtml5-custom-command=change-editor]").on("click",function(e){var $command=$(this);if(!$command.hasClass("wysihtml5-command-active")){if(wysiEditor.updateFooter($footer,""),$markdownTextarea)$markdownTextarea.hide();if($command.hasClass(wysiClass))handleWysiMode(!0);else if($command.hasClass(sourceClass))handleSourceMode(!0);else if($command.hasClass(mdClass))handleMarkdownMode(!0)}}),editor.on("load",function(){var modePrefer=options["composer.defaultPersist"]?cookie.get(modeCookie):currentEditor;if(options["toolbar.mode.markdown"]&&("markdown"==options["composer.default"]&&!modePrefer||"markdown"==modePrefer))$toolbar.find("[data-wysihtml5-custom-command=change-editor]").show().removeClass("wysihtml5-command-active"),$toolbar.find("."+mdClass).addClass("wysihtml5-command-active"),handleMarkdownMode(!1);else if(options["toolbar.mode.html"]&&("html"==options["composer.default"]&&!modePrefer||"html"==modePrefer))$toolbar.find("[data-wysihtml5-custom-command=change-editor]").show().removeClass("wysihtml5-command-active"),$toolbar.find("."+sourceClass).addClass("wysihtml5-command-active"),handleSourceMode(!1);else{var $html;if(options["footer.rich"]!==!1)if(_.isFunction(options["footer.rich"]))$html=$(options["footer.rich"]({options:options,editor:editor}));else $html=$(options["footer.rich"]);else $html=$(richFooterTemplate({prefix:options["prefix.css"]}));setModeDefault("rich"),wysiEditor.updateFooter($footer,$html)}})}}),wysiEditor};if("function"==typeof define&&define.amd)define("bundles/wysihtml5/modes",["jquery","underscore","bundles/wysihtml5/editor","bundles/wysihtml5/toolbar-modes.html","i18n!bundles/wysihtml5/nls/toolbar-modes","bundles/wysihtml5/footer-source.html","i18n!bundles/wysihtml5/nls/footer-source","bundles/wysihtml5/footer-markdown.html","i18n!bundles/wysihtml5/nls/footer-markdown","bundles/wysihtml5/footer-rich.html","i18n!bundles/wysihtml5/nls/footer-rich","js/lib/modals","js/lib/cookie","js/lib/beautify-html","js/lib/marked","js/lib/html.md"],function($,_,wysiEditor,toolbarTemplate,toolbarTemplate_t,sourceFooterTemplate,sourceFooterTemplate_t,mdFooterTemplate,mdFooterTemplate_t,richFooterTemplate,richFooterTemplate_t,Modal,cookie,prettyify,Marked,HTML2Markdown){return init($,_,wysiEditor,toolbarTemplate,toolbarTemplate_t,sourceFooterTemplate,sourceFooterTemplate_t,mdFooterTemplate,mdFooterTemplate_t,richFooterTemplate,richFooterTemplate_t,Modal,cookie,prettyify,Marked,HTML2Markdown)});else init(window.$,window._,window.wysihtml5,window.wysiEditor,window.jade.templates["bundles.wysihtml5.toolbar-modes"],window.jade.templates["bundles.wysihtml5.footer-source"],window.jade.templates["bundles.wysihtml5.footer-markdown"],window.jade.templates["bundles.wysihtml5.footer-rich"],window.Modal,window.Cookie,window.beautify_html,window.marked,window.HTML2Markdown)}(window),define("bundles/wysihtml5/nls/toolbar-transloadit",{es:!0,fr:!0,pt:!0,ru:!0,tr:!0,zh:!0,"zh-hk":"zh-tw","zh-mo":"zh-tw","zh-tw":!0}),define("bundles/wysihtml5/nls/root/toolbar-transloadit",{Pic:"Pic"}),!function(wndw){var jadify=function(jade,_t){var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(prefix,_t){buf.push('<button data-wysihtml5-custom-command="image" data-wysihtml5-order=\'7\' type="button" unselectable="on" title="Insert image"'+jade.cls([prefix+"-toolbar-item"],[!0])+'><span class="icon-picture"></span> '+jade.escape(null==(jade_interp=_t("Pic"))?"":jade_interp)+"</button>")}("prefix"in locals_for_with?locals_for_with.prefix:"undefined"!=typeof prefix?prefix:void 0,"_t"in locals_for_with?locals_for_with._t:"undefined"!=typeof _t?_t:void 0),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("bundles/wysihtml5/toolbar-transloadit.html",["js/lib/jade","i18n!bundles/wysihtml5/nls/toolbar-transloadit"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["bundles.wysihtml5.toolbar-transloadit"]=jadify(wndw.jade.helpers)}(window),define("bundles/wysihtml5/nls/toolbar-modal-transloadit",{es:!0,fr:!0,pt:!0,ru:!0,tr:!0,zh:!0,"zh-hk":"zh-tw","zh-mo":"zh-tw","zh-tw":!0}),define("bundles/wysihtml5/nls/root/toolbar-modal-transloadit",{Cancel:"Cancel",Insert:"Insert","Pick File":"Pick File","What size would you like to embed it at?":"What size would you like to embed it at?",x:"x"}),!function(wndw){var jadify=function(jade,_t){var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(prefix,_t){buf.push('<div data-wysihtml5-modal-image="data-wysihtml5-modal-image"'+jade.attr("data-modal-overlay-class",prefix+"-overlay",!0,!1)+' role="dialog" aria-label="Create Image" tabindex="-1" class="modal hide"><form><div class="modal-body"><div class="control-group bootstrap-wysihtml5-upload-image"><div style="text-align:center;" class="uploader-controls transloadit-uploader"><div class="uploader-preview"><div><img src=""/></div><div style="margin-top:10px;"><span>'+jade.escape(null==(jade_interp=_t("What size would you like to embed it at?"))?"":jade_interp)+' </span><input type="text" style="width:50px;margin-left: 5px; margin-right:5px;" class="uploader-input-width"/><span>'+jade.escape(null==(jade_interp=_t("x"))?"":jade_interp)+'</span><input type="text" style="width:50px;margin-left:5px;" class="uploader-input-height"/></div></div><div class="uploader-side"><button type="button" class="btn uploader-button">'+jade.escape(null==(jade_interp=_t("Pick File"))?"":jade_interp)+'</button><div class="uploader-file-input"><input type="file" name="my_file" accept="image/png,image/jpeg,image/gif,image/jpg"/></div><div style="display:none;" class="progress progress-striped active uploader-progress"><div style="width:0%" class="bar"></div></div><div class="uploader-input hide"><input type="text" value="" name="result" class="uploader-input-url"/></div></div></div></div></div><div class="modal-footer"><button type="submit" data-modal-close="data-modal-close" style="margin-right:10px;"'+jade.cls(["btn","hide",prefix+"-modal-image-submit"],[null,null,!0])+">"+jade.escape(null==(jade_interp=_t("Insert"))?"":jade_interp)+'</button><a data-modal-close="data-modal-close" href="javascript:;">'+jade.escape(null==(jade_interp=_t("Cancel"))?"":jade_interp)+"</a></div></form></div>")}("prefix"in locals_for_with?locals_for_with.prefix:"undefined"!=typeof prefix?prefix:void 0,"_t"in locals_for_with?locals_for_with._t:"undefined"!=typeof _t?_t:void 0),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("bundles/wysihtml5/toolbar-modal-transloadit.html",["js/lib/jade","i18n!bundles/wysihtml5/nls/toolbar-modal-transloadit"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["bundles.wysihtml5.toolbar-modal-transloadit"]=jadify(wndw.jade.helpers)}(window),define("js/lib/jquery.easing",["jquery"],function(jQuery){jQuery.easing.jswing=jQuery.easing.swing,jQuery.extend(jQuery.easing,{def:"easeOutQuad",swing:function(x,t,b,c,d){return jQuery.easing[jQuery.easing.def](x,t,b,c,d)},easeInQuad:function(x,t,b,c,d){return c*(t/=d)*t+b},easeOutQuad:function(x,t,b,c,d){return-c*(t/=d)*(t-2)+b},easeInOutQuad:function(x,t,b,c,d){if((t/=d/2)<1)return c/2*t*t+b;else return-c/2*(--t*(t-2)-1)+b},easeInCubic:function(x,t,b,c,d){return c*(t/=d)*t*t+b},easeOutCubic:function(x,t,b,c,d){return c*((t=t/d-1)*t*t+1)+b},easeInOutCubic:function(x,t,b,c,d){if((t/=d/2)<1)return c/2*t*t*t+b;else return c/2*((t-=2)*t*t+2)+b},easeInQuart:function(x,t,b,c,d){return c*(t/=d)*t*t*t+b},easeOutQuart:function(x,t,b,c,d){return-c*((t=t/d-1)*t*t*t-1)+b},easeInOutQuart:function(x,t,b,c,d){if((t/=d/2)<1)return c/2*t*t*t*t+b;else return-c/2*((t-=2)*t*t*t-2)+b},easeInQuint:function(x,t,b,c,d){return c*(t/=d)*t*t*t*t+b},easeOutQuint:function(x,t,b,c,d){return c*((t=t/d-1)*t*t*t*t+1)+b},easeInOutQuint:function(x,t,b,c,d){if((t/=d/2)<1)return c/2*t*t*t*t*t+b;else return c/2*((t-=2)*t*t*t*t+2)+b},easeInSine:function(x,t,b,c,d){return-c*Math.cos(t/d*(Math.PI/2))+c+b},easeOutSine:function(x,t,b,c,d){return c*Math.sin(t/d*(Math.PI/2))+b},easeInOutSine:function(x,t,b,c,d){return-c/2*(Math.cos(Math.PI*t/d)-1)+b},easeInExpo:function(x,t,b,c,d){return 0==t?b:c*Math.pow(2,10*(t/d-1))+b},easeOutExpo:function(x,t,b,c,d){return t==d?b+c:c*(-Math.pow(2,-10*t/d)+1)+b},easeInOutExpo:function(x,t,b,c,d){if(0==t)return b;if(t==d)return b+c;if((t/=d/2)<1)return c/2*Math.pow(2,10*(t-1))+b;else return c/2*(-Math.pow(2,-10*--t)+2)+b},easeInCirc:function(x,t,b,c,d){return-c*(Math.sqrt(1-(t/=d)*t)-1)+b},easeOutCirc:function(x,t,b,c,d){return c*Math.sqrt(1-(t=t/d-1)*t)+b},easeInOutCirc:function(x,t,b,c,d){if((t/=d/2)<1)return-c/2*(Math.sqrt(1-t*t)-1)+b;else return c/2*(Math.sqrt(1-(t-=2)*t)+1)+b},easeInElastic:function(x,t,b,c,d){var s=1.70158,p=0,a=c;if(0==t)return b;if(1==(t/=d))return b+c;if(!p)p=.3*d;if(a<Math.abs(c)){a=c;var s=p/4}else var s=p/(2*Math.PI)*Math.asin(c/a);return-(a*Math.pow(2,10*(t-=1))*Math.sin(2*(t*d-s)*Math.PI/p))+b},easeOutElastic:function(x,t,b,c,d){var s=1.70158,p=0,a=c;if(0==t)return b;if(1==(t/=d))return b+c;if(!p)p=.3*d;if(a<Math.abs(c)){a=c;var s=p/4}else var s=p/(2*Math.PI)*Math.asin(c/a);return a*Math.pow(2,-10*t)*Math.sin(2*(t*d-s)*Math.PI/p)+c+b},easeInOutElastic:function(x,t,b,c,d){var s=1.70158,p=0,a=c;if(0==t)return b;if(2==(t/=d/2))return b+c;if(!p)p=.3*d*1.5;if(a<Math.abs(c)){a=c;var s=p/4}else var s=p/(2*Math.PI)*Math.asin(c/a);if(1>t)return-.5*a*Math.pow(2,10*(t-=1))*Math.sin(2*(t*d-s)*Math.PI/p)+b;else return a*Math.pow(2,-10*(t-=1))*Math.sin(2*(t*d-s)*Math.PI/p)*.5+c+b},easeInBack:function(x,t,b,c,d,s){if(void 0==s)s=1.70158;return c*(t/=d)*t*((s+1)*t-s)+b},easeOutBack:function(x,t,b,c,d,s){if(void 0==s)s=1.70158;return c*((t=t/d-1)*t*((s+1)*t+s)+1)+b},easeInOutBack:function(x,t,b,c,d,s){if(void 0==s)s=1.70158;if((t/=d/2)<1)return c/2*t*t*(((s*=1.525)+1)*t-s)+b;else return c/2*((t-=2)*t*(((s*=1.525)+1)*t+s)+2)+b},easeInBounce:function(x,t,b,c,d){return c-jQuery.easing.easeOutBounce(x,d-t,0,c,d)+b},easeOutBounce:function(x,t,b,c,d){if((t/=d)<1/2.75)return 7.5625*c*t*t+b;else if(2/2.75>t)return c*(7.5625*(t-=1.5/2.75)*t+.75)+b;else if(2.5/2.75>t)return c*(7.5625*(t-=2.25/2.75)*t+.9375)+b;else return c*(7.5625*(t-=2.625/2.75)*t+.984375)+b},easeInOutBounce:function(x,t,b,c,d){if(d/2>t)return.5*jQuery.easing.easeInBounce(x,2*t,0,c,d)+b;else return.5*jQuery.easing.easeOutBounce(x,2*t-d,0,c,d)+.5*c+b}})}),define("js/lib/jquery.jsonp",["jquery"],function($){function noop(){}function genericCallback(data){lastValue=[data]}function appendScript(node){head.insertBefore(node,head.firstChild)}function callIfDefined(method,object,parameters){return method&&method.apply(object.context||object,parameters)}function qMarkOrAmp(url){return/\?/.test(url)?"&":"?"}function jsonp(xOptions){function notifySuccess(json){!done++&&setTimeout(function(){cleanUp(),pageCacheFlag&&(pageCache[url]={s:[json]}),dataFilter&&(json=dataFilter.apply(xOptions,[json])),callIfDefined(xOptions.success,xOptions,[json,STR_SUCCESS]),callIfDefined(completeCallback,xOptions,[xOptions,STR_SUCCESS])},0)}function notifyError(type){!done++&&setTimeout(function(){cleanUp(),pageCacheFlag&&type!=STR_TIMEOUT&&(pageCache[url]=type),callIfDefined(xOptions.error,xOptions,[xOptions,type]),callIfDefined(completeCallback,xOptions,[xOptions,type])},0)}xOptions=$.extend({},xOptionsDefaults,xOptions);var completeCallback=xOptions.complete,dataFilter=xOptions.dataFilter,callbackParameter=xOptions.callbackParameter,successCallbackName=xOptions.callback,cacheFlag=xOptions.cache,pageCacheFlag=xOptions.pageCache,charset=xOptions.charset,url=xOptions.url,data=xOptions.data,timeout=xOptions.timeout,pageCached,done=0,cleanUp=noop;if(xOptions.abort=function(){!done++&&cleanUp()},callIfDefined(xOptions.beforeSend,xOptions,[xOptions])===!1||done)return xOptions;else return url=url||STR_EMPTY,data=data?"string"==typeof data?data:$.param(data,xOptions.traditional):STR_EMPTY,url+=data?qMarkOrAmp(url)+data:STR_EMPTY,callbackParameter&&(url+=qMarkOrAmp(url)+escape(callbackParameter)+"=?"),!cacheFlag&&!pageCacheFlag&&(url+=qMarkOrAmp(url)+"_"+(new Date).getTime()+"="),url=url.replace(/=\?(&|$)/,"="+successCallbackName+"$1"),pageCacheFlag&&(pageCached=pageCache[url])?pageCached.s?notifySuccess(pageCached.s[0]):notifyError(pageCached):setTimeout(function(script,scriptAfter,timeoutTimer){function callback(result){(script[STR_ONCLICK]||noop)(),result=lastValue,lastValue=void 0,result?notifySuccess(result[0]):notifyError(STR_ERROR)}if(!done){if(timeoutTimer=timeout>0&&setTimeout(function(){notifyError(STR_TIMEOUT)},timeout),cleanUp=function(){timeoutTimer&&clearTimeout(timeoutTimer),script[STR_ONREADYSTATECHANGE]=script[STR_ONCLICK]=script[STR_ONLOAD]=script[STR_ONERROR]=null,head[STR_REMOVE_CHILD](script),scriptAfter&&head[STR_REMOVE_CHILD](scriptAfter)},window[successCallbackName]=genericCallback,script=$(STR_SCRIPT_TAG)[0],script.id=STR_JQUERY_JSONP+count++,charset)script[STR_CHARSET]=charset;if(browser.msie)script.event=STR_ONCLICK,script.htmlFor=script.id,script[STR_ONREADYSTATECHANGE]=function(){"loaded"==script.readyState&&callback()};else script[STR_ONERROR]=script[STR_ONLOAD]=callback,browser.opera?(scriptAfter=$(STR_SCRIPT_TAG)[0]).text="jQuery('#"+script.id+"')[0]."+STR_ONERROR+"()":script[STR_ASYNC]=STR_ASYNC;script.src=url,appendScript(script),scriptAfter&&appendScript(scriptAfter)}},0),xOptions}var STR_ASYNC="async",STR_CHARSET="charset",STR_EMPTY="",STR_ERROR="error",STR_JQUERY_JSONP="_jqjsp",STR_ON="on",STR_ONCLICK=STR_ON+"click",STR_ONERROR=STR_ON+STR_ERROR,STR_ONLOAD=STR_ON+"load",STR_ONREADYSTATECHANGE=STR_ON+"readystatechange",STR_REMOVE_CHILD="removeChild",STR_SCRIPT_TAG="<script/>",STR_SUCCESS="success",STR_TIMEOUT="timeout",browser=$.browser,head=$("head")[0]||document.documentElement,pageCache={},count=0,lastValue,xOptionsDefaults={callback:STR_JQUERY_JSONP,url:location.href};jsonp.setup=function(xOptions){$.extend(xOptionsDefaults,xOptions)},$.jsonp=jsonp}),define("js/lib/jquery.transloadit2",["jquery","js/lib/jquery.easing","js/lib/jquery.jsonp","js/lib/json2"],function($){function Uploader(){this.assemblyId=null,this.instance=null,this.documentTitle=null,this.timer=null,this._options={},this.uploads=[],this.results={},this.ended=null,this.pollStarted=null,this.pollRetries=0,this.seq=0,this.started=!1,this.assembly=null,this.params=null,this.bytesReceivedBefore=0,this.lastPoll=0,this.$params=null,this.$form=null,this.$files=null,this.$fileClones=null,this.$iframe=null,this.$modal=null}var PROTOCOL="https:"==document.location.protocol?"https://":"http://",OPTIONS={service:PROTOCOL+"api2.transloadit.com/",assets:PROTOCOL+"assets.transloadit.com/",onPick:function(){},onStart:function(){},onProgress:function(){},onUpload:function(){},onResult:function(){},onCancel:function(){},onError:function(){},onSuccess:function(){},interval:2500,pollTimeout:8e3,poll404Retries:15,pollConnectionRetries:3,wait:!1,processZeroFiles:!0,autoSubmit:!0,modal:!0,exclude:"",fields:!1,params:null,debug:!0},CSS_LOADED=!1;$.fn.transloadit=function(){var args=Array.prototype.slice.call(arguments),method,uploader,r;if(1==args.length&&"object"==typeof args[0]||void 0===args[0])args.unshift("init");if(method=args.shift(),"init"==method)uploader=new Uploader,args.unshift(this),this.data("transloadit.uploader",uploader);else uploader=this.data("transloadit.uploader");if(!uploader)throw new Error("Element is not initialized for transloadit!");return r=uploader[method].apply(uploader,args),void 0===r?this:r},Uploader.prototype.init=function($form,options){this.$form=$form,this.options($.extend({},OPTIONS,options||{}));var self=this;$form.find('input[type="file"]').on("change",function(){if(self.validate(),self.detectFileInputs(),self.checkFileTypes(),!self._options.processZeroFiles&&0===self.$files.length)self.submitForm();else self._options.onPick(),self.getBoredInstance();return!1}),this.includeCss()},Uploader.prototype.getBoredInstance=function(){var self=this;if(this.instance=null,$.jsonp({url:this._options.service+"instances/bored",timeout:self._options.pollTimeout,callbackParameter:"callback",success:function(instance){if(instance.error)return self.ended=!0,self.renderError(instance),void self._options.onError(instance);else return self.instance=instance.api2_host,void self.start()},error:function(xhr,status){self.ended=!0;var err={error:"CONNECTION_ERROR",message:"There was a problem connecting to the upload server",reason:"JSONP request status: "+status};self.renderError(err),self._options.onError(err)}}),this._options.modal)this.showModal()},Uploader.prototype.start=function(){var self=this;this.started=!1,this.ended=!1,this.bytesReceivedBefore=0,this.pollRetries=0,this.seq=0,this.uploads=[],this.results={},this.assemblyId=this.uuid(),this.$fileClones=$().not(document),this.$files.each(function(){var $clone=$(this).clone(!0);self.$fileClones=self.$fileClones.add($clone),$clone.insertAfter(this)}),this.$iframe=$('<iframe id="transloadit-'+this.assemblyId+'" name="transloadit-'+this.assemblyId+'"/>').appendTo("body").hide(),this.$uploadForm=$('<form enctype="multipart/form-data" />').attr("action",PROTOCOL+this.instance+"/assemblies/"+this.assemblyId+"?redirect=false").attr("target","transloadit-"+this.assemblyId).attr("method","POST").append(this.$files).appendTo("body").hide();var fieldsFilter="[name=params], [name=signature]";if(this._options.fields===!0)fieldsFilter="*";else if("string"==typeof this._options.fields)fieldsFilter+=", "+this._options.fields;var $clones=this.clone(this.$form.find(":input[type!=file]").filter(fieldsFilter));if(this._options.params&&!this.$params)$clones=$clones.add('<input name="params" value=\''+JSON.stringify(this._options.params)+"'>");$clones.prependTo(this.$uploadForm),this.$uploadForm.submit(),this.lastPoll=+new Date,setTimeout(function(){self._poll()},300)},Uploader.prototype.clone=function($obj){for(var $result=$obj.clone(),myTextareas=$obj.filter("textarea"),resultTextareas=$result.filter("textarea"),i=0,l=myTextareas.length;l>i;++i)$(resultTextareas[i]).val($(myTextareas[i]).val());return $result},Uploader.prototype.checkFileTypes=function(){var self=this,acceptedTypes=self.$files.attr("accept");if(!acceptedTypes)return!0;if("video/*"==acceptedTypes)acceptedTypes="video/mp4,video/m4v,video/flv,video/avi,video/mpg,video/mov,video/wmv,video/h264,video/mkv";if("image/*"==acceptedTypes)acceptedTypes="image/png,image/jpeg,image/gif,image/jpg,image/ico";acceptedTypes=acceptedTypes.split(","),self.$files=self.$files.filter(function(){for(var fileExt=this.value.split(".").pop().toLowerCase(),i=0;i<acceptedTypes.length;i++)if(fileExt==acceptedTypes[i].split("/")[1])return!0;return self._options.onError("Sorry, we don't accept "+fileExt+" files."),!1})},Uploader.prototype.detectFileInputs=function(){var $files=this.$form.find("input[type=file]").not(this._options.exclude);if(!this._options.processZeroFiles)$files=$files.filter(function(){return""!==this.value});this.$files=$files},Uploader.prototype.validate=function(){if(!this._options.params){var $params=this.$form.find("input[name=params]");if(!$params.length)return void alert("Could not find input[name=params] in your form.");try{this.params=JSON.parse($params.val())}catch(e){return void alert("Error: input[name=params] seems to contain invalid JSON.")}}else this.params=this._options.params;if(this.params.redirect_url)this.$form.attr("action",this.params.redirect_url);
else if(this._options.autoSubmit&&this.$form.attr("action")==this._options.service+"assemblies")return void alert("Error: input[name=params] does not include a redirect_url");this.$params=$params},Uploader.prototype._poll=function(query){var self=this;if(!this.ended){if($.browser.mozilla&&!this.documentTitle)this.documentTitle=document.title,document.title="Loading...";this.pollStarted=+new Date,$.jsonp({url:PROTOCOL+this.instance+"/assemblies/"+this.assemblyId+(query||"?seq="+this.seq),timeout:self._options.pollTimeout,callbackParameter:"callback",success:function(assembly){if(!self.ended){if(self.assembly=assembly,"ASSEMBLY_NOT_FOUND"==assembly.error)if(self.pollRetries++,self.pollRetries>self._options.poll404Retries)return document.title=self.documentTitle,self.ended=!0,self.renderError(assembly),void self._options.onError(assembly);else return void setTimeout(function(){self._poll()},400);else if(assembly.error)return self.ended=!0,self.renderError(assembly),document.title=self.documentTitle,void self._options.onError(assembly);if(self.seq=assembly.last_seq,!self.started)self.started=!0,self._options.onStart(assembly);self.pollRetries=0;var isUploading="ASSEMBLY_UPLOADING"==assembly.ok,isExecuting="ASSEMBLY_EXECUTING"==assembly.ok,isCanceled="ASSEMBLY_CANCELED"==assembly.ok,isComplete="ASSEMBLY_COMPLETED"==assembly.ok;self._options.onProgress(assembly.bytes_received,assembly.bytes_expected,assembly);for(var i=0;i<assembly.uploads.length;i++)self._options.onUpload(assembly.uploads[i],assembly),self.uploads.push(assembly.uploads[i]);for(var step in assembly.results){self.results[step]=self.results[step]||[];for(var i=0;i<assembly.results[step].length;i++)self._options.onResult(step,assembly.results[step][i],assembly),self.results[step].push(assembly.results[step][i])}if(isCanceled)return self.ended=!0,document.title=self.documentTitle,void self._options.onCancel(assembly);if(self.renderProgress(assembly),isComplete||!self._options.wait&&isExecuting){if(self.ended=!0,document.title=self.documentTitle,assembly.uploads=self.uploads,assembly.results=self.results,self._options.onSuccess(assembly),self._options.modal)self.cancel();return void self.submitForm()}var ping=self.pollStarted-+new Date,timeout=ping<self._options.interval?self._options.interval:ping;self.timer=setTimeout(function(){self._poll()},timeout),self.lastPoll=+new Date}},error:function(xhr,status){if(!self.ended){if(self.pollRetries++,self.pollRetries>self._options.pollConnectionRetries){document.title=self.documentTitle,self.ended=!0;var err={error:"CONNECTION_ERROR",message:"There was a problem connecting to the upload server",reason:"JSONP request status: "+status};return self.renderError(err),void self._options.onError(err)}setTimeout(function(){self._poll()},350)}}})}},Uploader.prototype.stop=function(){document.title=this.documentTitle,this.ended=!0},Uploader.prototype.cancel=function(){if(!this.ended){var self=this;if(this.$params)this.$params.prependTo(this.$form);if(this.$fileClones.each(function(i){var $original=$(self.$files[i]),$clone=$(this);$original.insertAfter($clone),$clone.remove()}),clearTimeout(self.timer),this._poll("?method=delete"),"Microsoft Internet Explorer"==navigator.appName)this.$iframe[0].contentWindow.document.execCommand("Stop");setTimeout(function(){self.$iframe.remove()},500)}if(this._options.modal)$.mask.close(),this.$modal.remove()},Uploader.prototype.submitForm=function(){if(this.$fileClones);if(null!==this.assembly)$("<textarea/>").attr("name","transloadit").text(JSON.stringify(this.assembly)).prependTo(this.$form).hide();if(this._options.autoSubmit)this.$form.unbind("submit.transloadit").submit()},Uploader.prototype.showModal=function(){this.$modal=$('<div id="transloadit"><div class="content"><a href="#close" class="close"></a><p class="status"></p><div class="progress"><label>starting upload ...</label><span></span></div><p class="error"></p></div></div>').appendTo("body"),$.extend(this.$modal,{$status:this.$modal.find(".status"),$content:this.$modal.find(".content"),$close:this.$modal.find(".close"),$label:this.$modal.find("label"),$progress:this.$modal.find(".progress"),$progressSpan:this.$modal.find(".progress span"),$error:this.$modal.find(".error")});var self=this;this.$modal.$close.click(function(){self.cancel()}),this.$modal.$error.hide();var self=this,expose=this.$modal.expose({api:!0,maskId:"transloadit_expose",opacity:.9,loadSpeed:250,closeOnEsc:!1,closeOnClick:!1});this.$modal.$close.click(function(){return self.cancel(),!1})},Uploader.prototype.renderError=function(assembly){if(this._options.modal){this.$modal.$content.addClass("content-error"),this.$modal.$progress.hide();var text=this._options.debug?assembly.error+": "+assembly.message+"<br><br>"+(assembly.reason||""):"There was an internal error, please try your upload again.";this.$modal.$error.html(text).show()}},Uploader.prototype.renderProgress=function(assembly){if(this._options.modal){var progress=assembly.bytes_received/assembly.bytes_expected,bytesReceived=assembly.bytes_received-this.bytesReceivedBefore,timeSinceLastPoll=+new Date-this.lastPoll,duration=1==progress?1e3:2*this._options.interval,text=1==progress?"processing ...":(assembly.bytes_received/1024/1024).toFixed(2)+" MB / "+(assembly.bytes_expected/1024/1024).toFixed(2)+" MB ("+(bytesReceived/1024/(timeSinceLastPoll/1e3)).toFixed(1)+" kB / sec)";this.bytesReceivedBefore=assembly.bytes_received,this.$modal.$label.text(text),this.$modal.$progressSpan.stop().animate({width:100*progress+"%"},duration,"easeOutCubic")}},Uploader.prototype.includeCss=function(){if(!CSS_LOADED&&this._options.modal)CSS_LOADED=!0,$('<link rel="stylesheet" type="text/css" href="'+this._options.assets+'css/transloadit2.css" />').appendTo("head")},Uploader.prototype.uuid=function(){var uuid="",i;for(i=0;32>i;i++)uuid+=Math.floor(16*Math.random()).toString(16);return uuid},Uploader.prototype.options=function(options){if(0==arguments.length)return this._options;else return void $.extend(this._options,options)},Uploader.prototype.option=function(key,val){if(1==arguments.length)return this._options[key];else return void(this._options[key]=val)}}),!function(global){var init=function($,wysiEditor,Modal,toolbarTemplate,toolbarTemplate_t,modalTemplate,modalTemplate_t,Transloadit){var TransloaditUploader=function(modal,options){var self=this;this.modal=modal,this.$element=this.modal.$el.find(".transloadit-uploader"),this.$preview=this.$element.find(".uploader-preview"),this.$button=this.$element.find(".uploader-button"),this.$progress=this.$element.find(".uploader-progress"),this.$input=this.$element.find(".uploader-input-url");var transloaditParams={max_size:options["transloadit.max_size"]||1048576,auth:{key:options["transloadit.key"]},template_id:options["transloadit.template"],steps:{store:{}}};this.$element.transloadit({params:transloaditParams,wait:!0,modal:!1,autoSubmit:!1,processZeroFiles:!1,onPick:function(assembly){self.$element.find(".help-inline.errror").remove(),self.$progress.show(),self.$progress.find(".bar").css("width","0%")},onStart:function(assembly){self.$button.hide()},onProgress:function(bytesReceived,bytesExpected){var progress=(bytesReceived/bytesExpected*100).toFixed(2);if(progress=Math.min(95,progress),!isNaN(progress))self.$progress.find(".bar").css("width",progress+"%")},onSuccess:function(assembly){function makeHttps(url){return url.replace(/^http:\/\//i,"https://")}function getResultForStep(stepId){var result=assembly.results[stepId][0];if(result.value=makeHttps(result.url),"image"==result.type)result.image=result.value;return result}self.$progress.fadeOut();var numResults=0,mainStepId;if($.each(assembly.results,function(stepId,stepData){numResults++,mainStepId=stepId}),assembly.results[":original"]&&numResults>1)mainStepId=":original";var mainResult=getResultForStep(mainStepId);self.$input.val(mainResult.value).trigger("change"),self.updatePreview(!0),self.$preview.show(),self.$element.find('input[name="uploader_file_input"]').val("")},onError:function(error){var $errorsDom=$('<span class="help-inline error"></span>').append(error);self.$button.show(),self.$element.find(".uploader-side").append($errorsDom),self.$element.find('input[name="uploader_file_input"]').val("")}}),this.updatePreview()};return TransloaditUploader.prototype.updatePreview=function(){var that=this;if(that.$width=that.$element.find(".uploader-input-width"),that.$height=that.$element.find(".uploader-input-height"),this.$input.val()){var $image=this.$preview.find("img");$image.attr("src",this.$input.val()).show(),this.$preview.show(),$image.on("load",function(){that.$width.val($image.width()),that.$height.val($image.height()),that.modal.reposition(),that.$width.on("keyup",function(){var height=Math.round($image.height()/$image.width()*that.$width.val());that.$height.val(height)}),that.$height.on("keyup",function(){var width=Math.round($image.width()/$image.height()*that.$height.val());that.$width.val(width)})})}else this.$preview.hide(),this.modal.reposition()},TransloaditUploader.prototype.reset=function(){this.$input.val(""),this.updatePreview(),this.$button.show()},wysiEditor.defaults=$.extend(wysiEditor.defaults,{"toolbar.image":!1,"transloadit.key":"","transloadit.template":""}),wysiEditor.plugin("transloadit",function(editor,$toolbar,$footer,options){if(options["toolbar.image"]){var $item=$(toolbarTemplate({_t:toolbarTemplate_t,prefix:options["prefix.css"]}));wysiEditor.insertIntoLeftToolbar($toolbar,$item,7),$toolbar.find("."+options["prefix.css"]+"-toolbar-modals").append(modalTemplate({_t:modalTemplate_t,prefix:options["prefix.css"]}));var $modal=$toolbar.find("[data-wysihtml5-modal-image]"),$button=$modal.find("[type=submit]"),modal=Modal($modal),caretBookmark,uploader=new TransloaditUploader(modal,options),$input=$modal.find("[name=result]");modal.on("close",function(){editor.currentView.element.focus()}),$input.bind("change input textinput blur",function(){if($input.val().indexOf("http")>-1)$button.removeAttr("disabled").show()}),$modal.find("form").on("submit",function(e){if(e.preventDefault(),e.stopPropagation(),editor.currentView.element.focus(),void 0!==caretBookmark||null!==caretBookmark)editor.composer.selection.setBookmark(caretBookmark),caretBookmark=null;var urlToInsert=$input.val();if(urlToInsert){var width=$modal.find(".uploader-input-width").val(),height=$modal.find(".uploader-input-height").val(),style=height||width?"width:"+width+"px;height:"+height+"px;":"";editor.composer.commands.exec("insertImage",{src:urlToInsert,style:style}),editor.fire("change").fire("change:composer")}}),$toolbar.find("[data-wysihtml5-custom-command=image]").on("click",function(e){if(!$(this).hasClass("wysihtml5-command-active")&&!$toolbar.hasClass("wysihtml5-commands-disabled"))caretBookmark=editor.composer&&editor.composer.selection.getBookmark(),uploader.reset(),$button.attr("disabled","").hide(),modal.open()})}}),wysiEditor};if("function"==typeof define&&define.amd)define("bundles/wysihtml5/transloadit",["jquery","bundles/wysihtml5/editor","js/lib/modals","bundles/wysihtml5/toolbar-transloadit.html","i18n!bundles/wysihtml5/nls/toolbar-transloadit","bundles/wysihtml5/toolbar-modal-transloadit.html","i18n!bundles/wysihtml5/nls/toolbar-modal-transloadit","js/lib/jquery.transloadit2"],function($,wysiEditor,Modals,toolbarTemplate,toolbarTemplate_t,modalTemplate,modalTemplate_t,Transloadit){return init($,wysiEditor,Modals,toolbarTemplate,toolbarTemplate_t,modalTemplate,modalTemplate_t,Transloadit)});else init(window.$,window.wysiEditor,window.Modal,window.jade.templates["bundles.wysihtml5.toolbar-transloadit"],window.jade.templates["bundles.wysihtml5.toolbar-modal-transloadit"])}(window),!function(wndw){var module=function(thirdparties){var initialized=!1,mathJaxCB=function(cb){return function(){if(initialized)return cb();else return initialized=!0,MathJax.Hub.Config({config:["MMLorHTML.js"],styleSheets:[],styles:{},jax:["input/TeX"],extensions:["tex2jax.js"],preJax:null,postJax:null,preRemoveClass:"MathJax_Preview",showProcessingMessages:!0,messageStyle:"none",displayAlign:"center",displayIndent:"0em",delayStartupUntil:"none",skipStartupTypeset:!1,elements:[],tex2jax:{inlineMath:[["$$","$$"],["\\(","\\)"]],displayMath:[["\\[","\\]"]],skipTags:["script","noscript","style","textarea","pre","code"],ignoreClass:"tex2jax_ignore",processClass:"tex2jax_process",processEscapes:!1,processEnvironments:!0,preview:"TeX"},mml2jax:{preview:"alttext"},jsMath2jax:{preview:"TeX"},TeX:{TagSide:"right",TagIndent:".8em",MultLineWidth:"85%",Macros:{},extensions:["AMSmath.js","AMSsymbols.js"]},MathML:{useMathMLspacing:!1},"HTML-CSS":{scale:100,availableFonts:["STIX","TeX"],preferredFont:"TeX",webFont:"TeX",imageFont:"TeX",undefinedFamily:"STIXGeneral,'Arial Unicode MS',serif",showMathMenu:!0,styles:{},tooltip:{delayPost:600,delayClear:600,offsetX:10,offsetY:5}},NativeMML:{scale:100,showMathMenu:!0,showMathMenuMSIE:!0,styles:{}},MathMenu:{delay:400,helpURL:"http://www.mathjax.org/help/user/",showRenderer:!0,showFontMenu:!1,showContext:!1,windowSettings:{status:"no",toolbar:"no",locationbar:"no",menubar:"no",directories:"no",personalbar:"no",resizable:"yes",scrollbars:"yes",width:100,height:50},styles:{}},MMLorHTML:{prefer:{MSIE:"MML",Firefox:"MML",Opera:"HTML",other:"HTML"}}}),MathJax.Hub.Configured(),cb()}};return{render:function(dom,cb){var callback=mathJaxCB(function(){if(dom)MathJax.Hub.Queue(["Typeset",MathJax.Hub,dom],cb);else MathJax.Hub.Queue(["Typeset",MathJax.Hub],cb)});thirdparties.ready("MathJax",callback)}}};if("function"==typeof define&&define.amd)define("js/lib/coursera.mathjax",["js/lib/third-parties"],function(thirdparties){return module(thirdparties)});else wndw.mathjax=module(window.thirdparties)}(window),define("bundles/wysihtml5/nls/toolbar-latex",{es:!0,fr:!0,pt:!0,ru:!0,tr:!0,zh:!0,"zh-hk":"zh-tw","zh-mo":"zh-tw","zh-tw":!0}),define("bundles/wysihtml5/nls/root/toolbar-latex",{Math:"Math"}),!function(wndw){var jadify=function(jade,_t){var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(prefix,_t){buf.push('<button data-wysihtml5-custom-command="latex" title="Equation Editor" type="button"'+jade.cls([prefix+"-toolbar-item "+prefix+"-toolbar-latex"],[!0])+">"+jade.escape(null==(jade_interp=_t("Math"))?"":jade_interp)+"</button>")}("prefix"in locals_for_with?locals_for_with.prefix:"undefined"!=typeof prefix?prefix:void 0,"_t"in locals_for_with?locals_for_with._t:"undefined"!=typeof _t?_t:void 0),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("bundles/wysihtml5/toolbar-latex.html",["js/lib/jade","i18n!bundles/wysihtml5/nls/toolbar-latex"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["bundles.wysihtml5.toolbar-latex"]=jadify(wndw.jade.helpers)}(window),define("bundles/wysihtml5/nls/toolbar-modal-latex",{es:!0,fr:!0,pt:!0,ru:!0,tr:!0,zh:!0,"zh-hk":"zh-tw","zh-mo":"zh-tw","zh-tw":!0}),define("bundles/wysihtml5/nls/root/toolbar-modal-latex",{Cancel:"Cancel",Create:"Create","LaTeX:":"LaTeX:","Preview:":"Preview:","enter a latex equation":"enter a latex equation"}),!function(wndw){var jadify=function(jade,_t){var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(prefix,_t){buf.push('<div data-wysihtml5-modal-latex="data-wysihtml5-modal-latex"'+jade.attr("data-modal-overlay-class",prefix+"-overlay",!0,!1)+' class="modal hide"><form style="margin:0px;padding:0px;"><div style="overflow:auto;"><div style="float:left;width:20%;"><label style="padding:10px;font-weight:bold;text-align:right;">'+jade.escape(null==(jade_interp=_t("LaTeX:"))?"":jade_interp)+'</label></div><div style="float:right;width:80%;"><textarea name="latex"'+jade.attr("placeholder",_t("enter a latex equation"),!0,!1)+jade.cls([prefix+"-modal-latex-textarea"],[!0])+'></textarea></div></div><div class="coursera-wysihtml5-latex-preview-area"><div style="float:left;width:20%;"><label style="padding:10px;font-weight:bold;text-align:right;">'+jade.escape(null==(jade_interp=_t("Preview:"))?"":jade_interp)+'</label></div><div style="float:right;width:80%;"><div class="coursera-wysihtml5-latex-preview"></div></div></div><div class="modal-footer"><button type="submit" data-modal-close="data-modal-close" style="margin-right:10px;"'+jade.cls(["btn",prefix+"-modal-link-submit"],[null,!0])+">"+jade.escape(null==(jade_interp=_t("Create"))?"":jade_interp)+'</button><a data-modal-close="data-modal-close" href="javascript:;">'+jade.escape(null==(jade_interp=_t("Cancel"))?"":jade_interp)+"</a></div></form></div>")}("prefix"in locals_for_with?locals_for_with.prefix:"undefined"!=typeof prefix?prefix:void 0,"_t"in locals_for_with?locals_for_with._t:"undefined"!=typeof _t?_t:void 0),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("bundles/wysihtml5/toolbar-modal-latex.html",["js/lib/jade","i18n!bundles/wysihtml5/nls/toolbar-modal-latex"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["bundles.wysihtml5.toolbar-modal-latex"]=jadify(wndw.jade.helpers)}(window),!function(global){var findLatexRegions=function(text){for(var re=/\${2}/g,latexRegions=[],matchObj={},result=re.exec(text);result;){if(!matchObj.start)matchObj.start=result.index+"$$".length;else matchObj.end=result.index,matchObj.text=text.substring(matchObj.start,matchObj.end),latexRegions.push(matchObj),matchObj={};result=re.exec(text)}return latexRegions},regionForPosition=function(pos,regions){for(var region,i=0;region=regions[i];i++)if(region.start<=pos&&region.end>=pos)return region;return null},init=function($,_,Modal,mathjax,wysiEditor,toolbarTemplate,toolbarTemplate_t,toolbarModalTemplate,toolbarModalTemplate_t,Popup){var mathEditor=function(editor,$toolbar,latexRegions,input,output,modal){latexRegions=[],input.val(""),output.html("");var pos=editor.composer.selection.getBookmark();if(pos){if(3===pos.startContainer.nodeType){latexRegions=findLatexRegions(pos.startContainer.textContent);var currentLatex=regionForPosition(pos.startOffset,latexRegions);if(currentLatex)input.val(currentLatex.text),input.trigger("keyup")}caretBookmark=pos}modal.open()},renderMath=_.debounce(mathjax.render,200);return wysiEditor.defaults=$.extend(wysiEditor.defaults,{"toolbar.latex":!1}),wysiEditor.plugin("latex",function(editor,$toolbar,$footer,options){if(options["toolbar.latex"]){var $item=$(toolbarTemplate({_t:toolbarTemplate_t,prefix:options["prefix.css"]}));wysiEditor.insertIntoLeftToolbar($toolbar,$item,100),$toolbar.find("."+options["prefix.css"]+"-toolbar-modals").append(toolbarModalTemplate({_t:toolbarModalTemplate_t,prefix:options["prefix.css"]}));var $modal=$toolbar.find("[data-wysihtml5-modal-latex]"),modal=Modal($modal),input=$modal.find("[name=latex]"),output=$modal.find(".coursera-wysihtml5-latex-preview"),caretBookmark,latexRegions=[];editor.on("preview",function(div){mathjax.render(div)}),input.on("keyup",function(){output.text("$$"+input.val()+"$$"),renderMath(output[0])}),input.trigger("keyup"),modal.on("open",function(){input.focus()}),modal.on("close",function(){editor.currentView.element.focus()}),$modal.find("form").on("submit",function(e){e.preventDefault(),editor.currentView.element.focus();var includeTokens,start,end,latexVal,startVal,endVal,text;if(!caretBookmark)caretBookmark=editor.composer.selection.getBookmark();editor.composer.selection.setBookmark(caretBookmark);var currentLatex=regionForPosition(caretBookmark.startOffset,latexRegions);if(currentLatex)start=currentLatex.start,end=currentLatex.end,includeTokens=!1;else start=caretBookmark.startOffset,end=start,includeTokens=!0;if(latexVal=input.val(),includeTokens)latexVal="$$"+latexVal+"$$";if(3===caretBookmark.startContainer.nodeType)startVal=caretBookmark.startContainer.textContent.substring(0,start),endVal=caretBookmark.startContainer.textContent.substring(end),caretBookmark.startContainer.textContent=startVal+latexVal+endVal;else text=document.createTextNode(latexVal),caretBookmark.insertNode(text);caretBookmark=null,editor.fire("change").fire("change:composer")}),$toolbar.find("."+options["prefix.css"]+"-toolbar-latex").on("click",function(e){if(!$(this).hasClass("wysihtml5-command-active")&&!$toolbar.hasClass("wysihtml5-commands-disabled"))mathEditor(editor,$toolbar,latexRegions,input,output,modal)})}}),wysiEditor};if("function"==typeof define&&define.amd)define("bundles/wysihtml5/latex",["jquery","underscore","js/lib/modals","js/lib/coursera.mathjax","bundles/wysihtml5/editor","bundles/wysihtml5/toolbar-latex.html","i18n!bundles/wysihtml5/nls/toolbar-latex","bundles/wysihtml5/toolbar-modal-latex.html","i18n!bundles/wysihtml5/nls/toolbar-modal-latex","js/lib/popups"],function($,_,Modal,mathjax,wysiEditor,toolbarTemplate,toolbarTemplate_t,toolbarModalTemplate,toolbarModalTemplate_t,Popup){return init($,_,Modal,mathjax,wysiEditor,toolbarTemplate,toolbarTemplate_t,toolbarModalTemplate,toolbarModalTemplate_t,Popup)});else init(window.$,window._,window.Modal,window.mathjax,window.wysiEditor,window.jade.templates["bundles.wysihtml5.toolbar-latex"],window.jade.templates["bundles.wysihtml5.toolbar-modal-latex"],window.Popup)}(window),define("bundles/wysihtml5/nls/toolbar-textbook",{es:!0,fr:!0,pt:!0,ru:!0,tr:!0,zh:!0,"zh-hk":"zh-tw","zh-mo":"zh-tw","zh-tw":!0}),define("bundles/wysihtml5/nls/root/toolbar-textbook",{Textbook:"Textbook"}),!function(wndw){var jadify=function(jade,_t){var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(prefix,_t){buf.push('<button data-wysihtml5-custom-command="textbook" data-wysihtml5-order=\'13\' type="button"'+jade.cls([prefix+"-toolbar-item"],[!0])+">"+jade.escape(null==(jade_interp=_t("Textbook"))?"":jade_interp)+"</button>")}("prefix"in locals_for_with?locals_for_with.prefix:"undefined"!=typeof prefix?prefix:void 0,"_t"in locals_for_with?locals_for_with._t:"undefined"!=typeof _t?_t:void 0),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("bundles/wysihtml5/toolbar-textbook.html",["js/lib/jade","i18n!bundles/wysihtml5/nls/toolbar-textbook"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["bundles.wysihtml5.toolbar-textbook"]=jadify(wndw.jade.helpers)}(window),define("bundles/wysihtml5/nls/toolbar-modal-textbook",{es:!0,fr:!0,pt:!0,ru:!0,tr:!0,zh:!0,"zh-hk":"zh-tw","zh-mo":"zh-tw","zh-tw":!0}),define("bundles/wysihtml5/nls/root/toolbar-modal-textbook",{Cancel:"Cancel",Create:"Create","Make a textbook link!":"Make a textbook link!","Select page number (optional)":"Select page number (optional)"}),!function(wndw){var jadify=function(jade,_t){var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(prefix,_t){buf.push('<div data-wysihtml5-modal-textbook="data-wysihtml5-modal-textbook"'+jade.attr("data-modal-overlay-class",prefix+"-overlay",!0,!1)+' role="dialog" aria-label="Create a textbook link" class="modal hide"><form><div class="modal-body"><div><label style="display:inline-block;margin-right:15px;"><span>'+jade.escape(null==(jade_interp=_t("Make a textbook link!"))?"":jade_interp)+'</span></label><select name="textbook-modal-options"></select></div><div><label style="display:inline-block;margin-right:15px;"><span>'+jade.escape(null==(jade_interp=_t("Select page number (optional)"))?"":jade_interp)+'</span></label><input type="text" name="textbook-modal-options-page"/></div></div><div class="modal-footer"><button type="submit" data-modal-close="data-modal-close" style="margin-right:10px;"'+jade.cls(["btn",prefix+"-modal-textbook-submit"],[null,!0])+">"+jade.escape(null==(jade_interp=_t("Create"))?"":jade_interp)+'</button><a data-modal-close="data-modal-close" href="javascript:;">'+jade.escape(null==(jade_interp=_t("Cancel"))?"":jade_interp)+"</a></div></form></div>")}("prefix"in locals_for_with?locals_for_with.prefix:"undefined"!=typeof prefix?prefix:void 0,"_t"in locals_for_with?locals_for_with._t:"undefined"!=typeof _t?_t:void 0),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("bundles/wysihtml5/toolbar-modal-textbook.html",["js/lib/jade","i18n!bundles/wysihtml5/nls/toolbar-modal-textbook"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["bundles.wysihtml5.toolbar-modal-textbook"]=jadify(wndw.jade.helpers)}(window),!function(global){var init=function($,Modal,wysiEditor,toolbarTemplate,toolbarTemplate_t,toolbarModalTemplate,toolbarModalTemplate_t){return wysiEditor.defaults=$.extend(wysiEditor.defaults,{"toolbar.textbook":!1}),wysiEditor.plugin("textbook",function(editor,$toolbar,$footer,options){if(options["toolbar.textbook"]){var $item=$(toolbarTemplate({_t:toolbarTemplate_t,prefix:options["prefix.css"]}));wysiEditor.insertIntoLeftToolbar($toolbar,$item,13),$toolbar.find("."+options["prefix.css"]+"-toolbar-modals").append(toolbarModalTemplate({_t:toolbarModalTemplate_t,prefix:options["prefix.css"]}));for(var $modal=$toolbar.find("[data-wysihtml5-modal-textbook]"),modal=Modal($modal),textbookData=($(editor.textareaElement).attr(options["prefix.data"]+"-toolbar-textbook-options")||"").split(","),courseBase=$(editor.textareaElement).attr(options["prefix.data"]+"-toolbar-textbook-coursebase")||"",$textbookModalOptions=$modal.find("[name=textbook-modal-options]"),$textbookModalOptionsPage=$modal.find("[name=textbook-modal-options-page]"),i=0;i<textbookData.length;i++){var tuple=textbookData[i].split("="),title=tuple[0],isbn=tuple[1],textbookDataHTML='<option value="'+isbn+'">'+title+"</option>";$textbookModalOptions.append(textbookDataHTML)}modal.on("open",function(){$textbookModalOptionsPage.val("")}),modal.on("close",function(){editor.currentView.element.focus()}),$modal.find("form").on("submit",function(e){e.preventDefault(),e.stopPropagation(),editor.currentView.element.focus();var node=editor.currentView.selection.getSelection(),apiPageNo=$textbookModalOptionsPage.val(),hrefLink=courseBase+"textbook/api/"+$textbookModalOptions.val();if(apiPageNo.length>0)hrefLink=hrefLink+"/"+apiPageNo;if(node.focusNode&&node.focusNode.parentNode&&"A"==node.focusNode.parentNode.nodeName)node.focusNode.parentNode.title=null,node.focusNode.parentNode.href=hrefLink;else editor.composer.commands.exec("createLink",{href:hrefLink,target:"_blank"});editor.fire("change").fire("change:composer")}),$toolbar.find("[data-wysihtml5-custom-command=textbook]").on("click",function(e){if(!$(this).hasClass("wysihtml5-command-active")&&!$toolbar.hasClass("wysihtml5-commands-disabled"))modal.open()})}}),wysiEditor};if("function"==typeof define&&define.amd)define("bundles/wysihtml5/textbook",["jquery","js/lib/modals","bundles/wysihtml5/editor","bundles/wysihtml5/toolbar-textbook.html","i18n!bundles/wysihtml5/nls/toolbar-textbook","bundles/wysihtml5/toolbar-modal-textbook.html","i18n!bundles/wysihtml5/nls/toolbar-modal-textbook"],function($,Modal,wysiEditor,toolbarTemplate,toolbarTemplate_t,toolbarModalTemplate,toolbarModalTemplate_t){return init($,Modal,wysiEditor,toolbarTemplate,toolbarTemplate_t,toolbarModalTemplate,toolbarModalTemplate_t)});else init(window.$,window.Modal,window.wysiEditor,window.jade.templates["bundles.wysihtml5.toolbar-textbook"],window.jade.templates["bundles.wysihtml5.toolbar-modal-textbook"])}(window),!function(global){var init=function(_,config,wysiEditor){var defaults={"prefix.css":"coursera-wysihtml5","prefix.data":"data-coursera-wysihtml5","toolbar.modes":!0,"toolbar.image":!1,"composer.class":"coursera-wysihtml5","composer.default":"rich","composer.stylesheet":config.url.app_assets+"bundles/wysihtml5/editor.css","transloadit.key":"05912e90e83346abb96c261bf458b615","transloadit.template":"a295b36c8fd44fbdb89e8eab06980081",parserRules:{tags:{b:1,i:1,p:1,span:{check_attributes:{"data-additional-details":"allow"}},div:1,ul:1,li:1,ol:1,pre:1,code:1,u:1,br:1,table:1,tr:1,td:1,th:1,thead:1,tbody:1,h1:1,h2:1,h3:1,h4:1,h5:1,strong:{rename_tag:"b"},em:{rename_tag:"i"},img:{check_attributes:{src:"url",style:"allow",alt:"allow"}},a:{check_attributes:{href:"url",target:"alt"}}}}};return wysiEditor.defaults=_.extend(wysiEditor.defaults,defaults),wysiEditor};if("function"==typeof define&&define.amd)define("js/lib/coursera.wysihtml5",["underscore","js/core/config","bundles/wysihtml5/editor","bundles/wysihtml5/code","bundles/wysihtml5/link","bundles/wysihtml5/modes","bundles/wysihtml5/transloadit","bundles/wysihtml5/latex","bundles/wysihtml5/textbook"],function(_,config,wysiEditor){return init(_,config,wysiEditor)});else init(window._,window.configure,window.wysiEditor)}(window),define("pages/forum/views/EditorUtil",["backbone","jquery","underscore","pages/spark/app","js/lib/coursera.wysihtml5","js/lib/util","js/lib/cookie"],function(Backbone,$,_,Coursera,wysihtml5,util,cookie){function makeEditor($form){var showToolbar=!0,defaultComposer="rich";if(util.isIOS())defaultComposer="markdown";var editor=wysihtml5($form.find("textarea"),{"toolbar.image":!0,"toolbar.latex":!0,"toolbar.code":!0,"toolbar.mode.markdown":!0,"composer.default":defaultComposer,"composer.group":"forums","composer.stylesheet":[Coursera.config.url.app_assets+"css/spark.main.css",Coursera.config.url.app_assets+"css/spark.forum.hg.css",Coursera.config.url.app_assets+"bundles/wysihtml5/editor.css"]});return $form.find("input[name=text_type]").val("html"),editor}function getPropsFromForm($form){var values={};return $form.find("input,textarea,select").each(function(){if("checkbox"==$(this).attr("type"))if($(this).is(":checked"))values[$(this).attr("name")]=$(this).val();else values[$(this).attr("name")]=0;else values[$(this).attr("name")]=$(this).val()}),values}return{makeEditor:makeEditor,getPropsFromForm:getPropsFromForm}}),!function(){var Tooltips=function($,LucidJS,_,DataAttributes){var ESCAPE=27,_private={defaults:{"bind.open":"mouseenter focusin","bind.close":"mouseleave focusout","bind.keydown":"keydown","animate.in.type":"custom","animate.in.from":'{"opacity":0}',"animate.in.to":'{"opacity":0.8}',"animate.in.duration":200,"animate.out.type":"custom","animate.out.from":'{"opacity":0.8}',"animate.out.to":'{"opacity":0}',"animate.out.duration":200,position:"top",style:"tooltip","style.z-index":1e6,offset:10,"attribute.tooltip":"data-tooltip"},tooltip:$("<div>").attr("aria-role","tooltip"),getTooltip:function(el,options){var tooltip=$(el).data("tooltip.me");if(tooltip&&tooltip.constructor==Tooltip.prototype.constructor)if(_private.build.call(tooltip,options?options.text:null),options)return tooltip.customize(options);else return tooltip;else return null},makeTooltip:function(el,settings){var $el=$(el),tooltip=_private.getTooltip($el);if(!tooltip)tooltip=new Tooltip($el,settings),$el.data("tooltip.me",tooltip);return _private.build.call(tooltip,settings?settings.text:null),tooltip},monitorKeys:function(e){if(e.keyCode==ESCAPE)this.close()},show:function(){this.emitter.trigger("show",this)},close:function(){this.$tooltip.hide().remove(),this.emitter.trigger("close",this)},build:function(_text){var arrow=$("<div>").addClass(this.options.style+"-arrow"),inner=$("<div>").addClass(this.options.style+"-inner"),text=_text||this.$el.attr(this.options["attribute.tooltip"]);this.$tooltip=_private.tooltip.empty().remove().removeClass().stop(!0,!0).addClass(this.options.style).addClass(this.options.position).css({visibility:"hidden",position:"absolute",display:"block","z-index":this.options["style.z-index"]}).append(arrow).append(inner.html(text))}},Tooltip=function(el,settings){this.$el=$(el),this.customize(settings),this.emitter=LucidJS.emitter(this)};Tooltip.prototype.customize=function(settings){if(this.options=_.extend({},DataAttributes.parse(this.$el,_private.defaults,"data-tooltip-"),settings),this.options.offset)this.options.offset=parseInt(this.options.offset,10)||0;
return this},Tooltip.prototype.open=function(){var that=this,position=this.$el.offset(),position2=this.$tooltip.appendTo("body").offset(),width=this.$el.outerWidth(),height=this.$el.outerHeight(),width2=this.$tooltip.outerWidth(),height2=this.$tooltip.outerHeight(),middleW=position.left+width/2,middleH=position.top+height/2;if("top"==this.options.position)this.$tooltip.css({left:middleW-width2/2,top:position.top-height2-this.options.offset});else if("left"==this.options.position)this.$tooltip.css({left:position.left-width2-this.options.offset,top:middleH-height2/2});else if("right"==this.options.position)this.$tooltip.css({left:position.left+width+this.options.offset,top:middleH-height2/2});else this.$tooltip.css({left:middleW-width2/2,top:position.top+height+this.options.offset});if("custom"==this.options["animate.in.type"]){if(this.options["animate.in.from"])if(_.isObject(this.options["animate.in.from"]))this.$tooltip.css(this.options["animate.in.from"]);else if(_.isString(this.options["animate.in.from"]))this.$tooltip.css($.parseJSON(this.options["animate.in.from"]));if(this.$tooltip.css({visibility:"visible",display:"block"}),this.options["animate.in.to"])if(_.isObject(this.options["animate.in.to"]))this.$tooltip.animate(this.options["animate.in.to"],{duration:this.options["animate.in.duration"],complete:_.bind(_private.show,this)});else if(_.isString(this.options["animate.in.to"]))this.$tooltip.animate($.parseJSON(this.options["animate.in.to"]),{duration:this.options["animate.in.duration"],complete:_.bind(_private.show,this)})}else this.emitter.trigger("opening",this),this.$tooltip.css({display:"block"}),_private.show.call(this);return $(document).on(this.options["bind.keydown"]+".popup",_.bind(_private.monitorKeys,this)),this},Tooltip.prototype.close=function(){if("custom"==this.options["animate.out.type"]){if(this.options["animate.out.from"])if(_.isObject(this.options["animate.out.from"]))this.$tooltip.css(this.options["animate.out.from"]);else if(_.isString(this.options["animate.out.from"]))this.$tooltip.css($.parseJSON(this.options["animate.out.from"]));if(this.options["animate.out.to"])if(_.isObject(this.options["animate.out.to"]))this.$tooltip.animate(this.options["animate.out.to"],{duration:this.options["animate.out.duration"],complete:_.bind(_private.close,this)});else if(_.isString(this.options["animate.out.to"]))this.$tooltip.animate($.parseJSON(this.options["animate.out.to"]),{duration:this.options["animate.out.duration"],complete:_.bind(_private.close,this)});this.emitter.trigger("closing",this)}else this.emitter.trigger("closing",this),_private.close.call(this)};var external=function(){return _private.getTooltip.apply(null,arguments)||_private.makeTooltip.apply(this,arguments)};return external.start=function(view,_options){var $view=$(view),options=_.extend({},_private.defaults,_options);$view.on(options["bind.open"]+".tooltip","["+options["attribute.tooltip"]+"]",function(e){var $anchor=$(this);if("disabled"!=$anchor.attr("disabled")){options=_.extend({},_options,DataAttributes.parse($anchor,_private.defaults,"data-tooltip-"));var tooltip=_private.makeTooltip($anchor,options);if($anchor.attr(options["attribute.tooltip"]))tooltip.open(),tooltip.on("open",function(){$anchor.data("tooltip.it",tooltip)}),tooltip.on("close",function(){$anchor.data("tooltip.it",null)})}}),$view.on(options["bind.close"]+".tooltip","["+options["attribute.tooltip"]+"]",function(e){var $anchor=$(this);options=_.extend({},_options,DataAttributes.parse($anchor,_private.defaults,"data-tooltip-"));var tooltip=_private.getTooltip($anchor,options);if(tooltip)tooltip.close()})},external.stop=function(view){var $view=$(view),pop=$view.data("tooltip.it");if($view.off(".tooltip"),tooltip)tooltip.close()},external.start("body"),external};if("function"==typeof define&&define.amd)define("js/lib/tooltips",["jquery","js/lib/lucid","underscore","js/lib/data.attributes"],function($,LucidJS,_,DataAttributes){return Tooltips($,LucidJS,_,DataAttributes)});else if("undefined"!=typeof window&&"undefined"==typeof ender)window.Tooltip=Tooltips(window.$,window.LucidJS,window._,window.DataAttributes)}(),define("pages/forum/views/EntryView",["backbone","jquery","underscore","js/lib/moment","js/lib/util","pages/spark/app","pages/forum/views/EntryView.html","pages/forum/views/EntryBylineView.html","pages/forum/views/EntryEditView.html","pages/forum/views/EditorUtil","js/lib/popups","js/lib/modals","js/lib/coursera.mathjax","js/lib/badgeville","js/lib/tooltips"],function(Backbone,$,_,moment,util,Coursera,template,bylineTemplate,editTemplate,EditorUtil,Popup,Modal,mathjax,BadgevilleUtil,Tooltips){var TRACKER_LABEL="Forum Entry",ENTER=13,view=Backbone.View.extend({template:template,tagName:"div",events:{"click .course-forum-post-admin-details-link":"onAdminDetailsClick","click .course-forum-post-action-link":"onEntryActionClick","click .course-forum-post-edit-link":"onEntryEditClick","click .course-forum-post-controls-toggle":"onGearClick","click .course-forum-post-edit-form button.course-forum-post-edit-save":"onEntryEditSave","click .course-forum-post-vote-button":"onVoteClick","keyup .course-forum-post-vote-button":"onKeyPress","click a.course-forum-post-edit-cancel":"onEntryEditCancel","click a[href*=forum-code-of-conduct]":"onConductClick"},initialize:function(options){this.options=options,this.thread=this.options.thread,this.model.bind("sync",this.render,this),this.model.bind("change",this.renderBylineMaybe,this),this.model.bind("error",this.renderError,this),this.thread.bind("change",this.updateResolutionOptions,this)},render:function(e){var self=this;if(self.renderEntry(),self.model.isNew())self.renderEditMode();else mathjax.render(self.el);return self},renderEntry:function(e){var self=this,entry=this.model;self.$el.html(self.template({entry:entry,user:Coursera.user,reporterLink:entry.get("_reporter_link")+"?url="+encodeURIComponent(entry.getPermalink())})),self.renderByline(),self.$viewContainer=self.$(".course-forum-post-view-container");var changedAttrs=this.model.changedAttributes();if(changedAttrs)if(changedAttrs[this.model.textProp])self.$(".course-forum-post-text").animate({"margin-left":"-=5"},100).animate({"margin-left":"+=5"},100);else if(changedAttrs.votes)self.$(".course-forum-post-vote-controls").animate({"margin-left":"-=5"},100).animate({"margin-left":"+=5"},100);if(!self.model.get("_viewer_can_vote"))self.$(".course-forum-post-vote-button").addClass("course-forum-post-vote-disabled"),self.$(".course-forum-post-vote-controls").removeAttr("data-tooltip"),self.$(".course-forum-post-vote-controls").removeAttr("data-tooltip-position");return self},renderBylineMaybe:function(e){var changedAttrs=this.model.changedAttributes();if(changedAttrs&&changedAttrs._user_profile)this.renderByline()},renderByline:function(){var self=this;if(this.$(".course-forum-post-byline").html(bylineTemplate({spark_class_short_name:Coursera.course.get("shortname"),spark_class_id:Coursera.course.get("id"),entry:this.model,config:Coursera.config})),util.prettifyTime(this.$(".course-forum-post-byline time")),BadgevilleUtil.isEnabled())if(self.setupBadgevilleByline=!1,self.model.get("user_id")&&BadgevilleUtil.getUserBucket(Coursera.user.get("id")).thread_byline){var debouncedRender=_.throttle(_.bind(self.renderBadgevilleBylineMaybe,self),300);$(window).on("scroll.badgevillebylines"+this.model.get("id"),debouncedRender),window.setTimeout(function(){self.renderBadgevilleBylineMaybe()},1),window.setTimeout(function(){self.renderBadgevilleBylineMaybe()},500)}},renderBadgevilleBylineMaybe:function(e){if(BadgevilleUtil.isAPILoaded()){var self=this,$badgevilleByline=self.$(".course-forum-profile-badgeville");if(!self.setupBadgevilleByline&&self.$el.is(":visible")&&util.inView($badgevilleByline,200))BadgevilleUtil.setupByline(self.model.get("user_id"),$badgevilleByline),$(window).off("scroll.badgevillebylines"+self.model.get("id")),self.setupBadgevilleByline=!0}},renderError:function(e,xhr){this.$(".course-forum-entry-error").remove(),this.$editContainer.find(".course-forum-post-edit-save").removeAttr("disabled");var $errorDiv=$("<div>");$errorDiv.append(xhr.responseText).addClass("alert alert-error course-forum-entry-error"),this.$el.append($errorDiv)},onGearClick:function(e){Coursera.multitracker.push([TRACKER_LABEL,"Controls Open"])},onAdminDetailsClick:function(){this.$(".course-forum-post-admin-container").show(),Coursera.multitracker.push([TRACKER_LABEL,"Admin Details"])},onEntryEditCancel:function(){if(this.$editContainer.hide(),!this.model.isNew())this.$viewContainer.show()},onEntryEditClick:function(){var self=this;self.renderEditMode(),Coursera.multitracker.push([TRACKER_LABEL,"Edit"])},renderEditMode:function(){var self=this,moocCourseId=430,reportNewProblemLink=self.thread.get("courseId")==moocCourseId?".":"../help/report";self.$el.append(editTemplate({entry:this.model,reportNewProblemLink:reportNewProblemLink})),self.$editContainer=self.$(".course-forum-post-edit-container"),self.$viewContainer.hide(),self.$editContainer.show();var editor=EditorUtil.makeEditor(self.$editContainer.find("form"));if("comment"==self.model.entryType)editor.on("load",function(){if(editor.composer)editor.composer.element.focus()});self.$editContainer.find(".course-forum-post-edit-save").removeAttr("disabled"),self.updateResolutionOptions()},updateResolutionOptions:function(){var self=this,thread=this.thread;if(thread){if(self.$(".course-forum-post-viewer-wants-resolve").hide(),self.$(".course-forum-post-viewer-wants-unresolve").hide(),self.$(".course-forum-post-viewer-cant-unresolve").hide(),thread.isUnresolved()&&thread.viewerCanResolve())self.$(".course-forum-post-viewer-wants-resolve").show();if(thread.isResolved())if(thread.viewerCanResolve())self.$(".course-forum-post-viewer-wants-unresolve").show();else self.$(".course-forum-post-viewer-cant-unresolve").show()}},onEntryEditSave:function(e){var self=this;e.preventDefault();var props=EditorUtil.getPropsFromForm(self.$editContainer.find("form")),wasNew=self.model.isNew(),thread=self.thread;if(thread.isResolved()&&thread.viewerCanResolve())props._viewer_wants_unresolve=1;if(self.$el.find("div.course-forum-post-edit-container").hide(),self.$el.find("div.course-forum-post-edit-container-loading").show(),wasNew)self.model.set(props),self.model.create({message:{waiting:"Saving...",success:"Saved!"}}).done(function(){if(self.$el.find("div.course-forum-post-edit-container-loading").hide(),thread.get("posts").add(self.model),thread.updateRange(),1!=props.anonymous)BadgevilleUtil.credit({verb:"created-entry",thread:self.model.get("thread_id"),entry:self.model.get("id"),week:BadgevilleUtil.getWeek()})}).fail(function(){self.$el.find("div.course-forum-post-edit-container-loading").hide(),self.$el.find("div.course-forum-post-edit-container").show()});else self.model.update(props,{message:{waiting:"Saving...",success:"Saved!"}}).done(function(){self.$el.find("div.course-forum-post-edit-container-loading").hide(),thread.trigger("posts:refresh")}).fail(function(){self.$el.find("div.course-forum-post-edit-container-loading").hide(),self.$el.find("div.course-forum-post-edit-container").show()});if(props._viewer_wants_resolve)self.thread.setResolved(!0);else if(thread.isResolved()&&thread.viewerCanResolve())self.thread.setResolved(!1);return self.$editContainer.find(".course-forum-post-edit-save").attr("disabled","disabled"),Coursera.multitracker.push([TRACKER_LABEL,"Edit Save"]),!1},onEntryActionClick:function(e){var self=this,$link=$(e.target),property=$link.attr("data-property"),value=$link.attr("data-value"),props={};props[property]=value,this.model.update(props,{message:{waiting:"Processing...",success:"Processed!"}}),Coursera.multitracker.push([TRACKER_LABEL,"Action "+property+" "+value])},onVoteClick:function(e){var self=this;e.preventDefault(),e.stopPropagation();var $button=$(e.currentTarget);if(!$button.hasClass("course-forum-post-vote-disabled")){var alreadyVoted=self.model.get("_viewer_voted"),voteAction=$button.attr("data-direction-value");return Coursera.api.post(this.model.votesUrl(),{data:{direction:voteAction},message:{waiting:"Recording vote...",success:"Recorded vote!"}}).done(function(data){if(self.model.set(data),self.renderEntry(),BadgevilleUtil.isEnabled()&&!alreadyVoted)if(BadgevilleUtil.credit({verb:"voted",direction:voteAction,thread:self.model.get("thread_id"),week:BadgevilleUtil.getWeek()}),1==voteAction){var threadId=self.model.get("thread_id"),entryId=self.model.get("thread_id")+self.model.entryType+self.model.get("id");if(BadgevilleUtil.creditOther(self.model.get("user_id"),{verb:"got-upvote-on-entry",thread:threadId,entry:entryId,num_votes:self.model.get("votes"),entry_type:self.model.get("original")?"original":"reply",week:BadgevilleUtil.getWeek()}),self.model.get("votes")>=3)BadgevilleUtil.creditOther(self.model.get("user_id"),{verb:"got-3-upvotes-on-entry",thread:threadId,entry:entryId,num_votes:self.model.get("votes"),entry_type:self.model.get("original")?"original":"reply",week:BadgevilleUtil.getWeek()})}}),!1}},onConductClick:function(){Coursera.multitracker.push([TRACKER_LABEL,"Click code of conduct"])},onKeyPress:function(e){var $target=$(e.target);if(event.keyCode==ENTER)$target.click()}});return view}),define("pages/forum/views/PostView",["backbone","jquery","underscore","pages/forum/views/EntryView"],function(Backbone,$,_,EntryView){var view=EntryView.extend({});return view}),define("pages/forum/views/CommentView",["backbone","jquery","underscore","pages/forum/views/EntryView"],function(Backbone,$,_,EntryView){var view=EntryView.extend({});return view}),define("pages/forum/views/PostContainerView",["backbone","jquery","underscore","pages/spark/app","pages/forum/models/CommentModel","pages/forum/views/PostContainerView.html","pages/forum/views/PostView","pages/forum/views/CommentView"],function(Backbone,$,_,Coursera,CommentModel,template,PostView,CommentView){var TRACKER_LABEL="Forum Post Container",view=Backbone.View.extend({template:template,events:{"click .course-forum-new-comment-link":"onNewCommentClick"},initialize:function(options){this.options=options,this.post=this.model,this.thread=this.options.thread,this.post.bind("sync",this.hideCommentsMaybe,this),this.comments=this.options.comments,this.comments.bind("reset",this.renderComments,this),this.comments.bind("add",this.renderComments,this)},render:function(){var self=this;return self.$el.html(self.template({post:self.post})),self.$newCommentContainer=self.$el.find(".course-forum-new-comment-container"),self.renderPost(),self.renderComments(),self.hideCommentsMaybe(),self},renderPost:function(){var self=this;self.$el.find(".course-forum-post-top-container").empty();var view=new PostView({model:self.post,thread:self.thread});self.$el.find(".course-forum-post-top-container").append(view.render().$el)},hideCommentsMaybe:function(){if(this.post.get("deleted"))this.$(".course-forum-comments-container").hide();else this.$(".course-forum-comments-container").show()},renderComments:function(){var self=this;self.$el.find(".course-forum-comments-container").empty(),self.comments.each(function(comment){view=new CommentView({model:comment,thread:self.thread}),self.$el.find(".course-forum-comments-container").append(view.render().$el)})},initNewComment:function(){this.newComment=CommentModel.findOrCreate({thread:this.thread,thread_id:this.thread.get("id"),post_id:this.post.get("id")}),this.newComment.bind("sync",this.saveNewCommentMaybe,this);var view=new CommentView({model:this.newComment,thread:this.thread});this.$newCommentContainer.html(view.render().$el)},saveNewCommentMaybe:function(){var self=this;if(!this.newComment.isNew())this.comments.add(this.newComment),this.newComment.unbind("sync",this.saveNewCommentMaybe,this),this.newComment=null,this.$newCommentContainer.empty()},onNewCommentClick:function(){if(!this.newComment)this.initNewComment();this.$newCommentContainer.find(".course-forum-post-edit-container").show(),Coursera.multitracker.push([TRACKER_LABEL,"Click New Comment"])}});return view}),define("pages/forum/views/error/nls/AccessErrorView",{}),!function(wndw){var jadify=function(jade,_t){var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(_t,forumLink){buf.push('<h2 class="course-page-header">'+jade.escape(null==(jade_interp=_t("Thread Removed"))?"":jade_interp)+"</h2><p>"+jade.escape(null==(jade_interp=_t("This thread has been removed by staff. Please return to the"))?"":jade_interp)+" <a"+jade.attr("href",forumLink,!0,!1)+">"+jade.escape(null==(jade_interp=_t("forums"))?"":jade_interp)+"</a>.</p>")}("_t"in locals_for_with?locals_for_with._t:"undefined"!=typeof _t?_t:void 0,"forumLink"in locals_for_with?locals_for_with.forumLink:"undefined"!=typeof forumLink?forumLink:void 0),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("pages/forum/views/error/AccessErrorView.html",["js/lib/jade","i18n!pages/forum/views/error/nls/AccessErrorView"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["pages.forum.views.error.AccessErrorView"]=jadify(wndw.jade.helpers)}(window),define("pages/forum/views/ThreadView",["backbone","jquery","underscore","js/lib/util","js/lib/cookie","js/lib/metatags","pages/spark/app","pages/forum/views/ThreadView.html","pages/forum/views/ThreadSortView.html","pages/forum/views/ForumCrumbsView.html","pages/forum/views/ThreadHeaderView","pages/forum/views/ThreadTagsView","pages/forum/views/PostContainerView","pages/forum/views/error/AccessErrorView.html","pages/forum/models/ThreadModel","pages/forum/models/PostModel","js/lib/badgeville"],function(Backbone,$,_,util,cookie,metatags,Coursera,ThreadTemplate,ThreadSortTemplate,ForumCrumbsTemplate,ThreadHeaderView,ThreadTagsView,PostContainerView,AccessErrorView,ThreadModel,PostModel,BadgevilleUtil){var getPostsBefore=_.throttle(function(ctx){ctx.model.getPostsBefore()},1500),getPostsAfter=_.throttle(function(ctx){ctx.model.getPostsAfter()},1500),scrollToEl=function($el){if($el.position())$("html,body").scrollTop($el.position().top)},order,TRACKER_LABEL="Forum Thread",view=Backbone.View.extend({defaults:{},events:{"click .course-forum-thread-admin-details-link":"onAdminDetailsClick"},initialize:function(options){var that=this;this.options=options,this.hangoutsEnabled=!_.isUndefined(this.options.hangoutsEnabled)?this.options.hangoutsEnabled:!1,this.thread=this.model,this.thread.bind("error",this.renderError,this),this.thread.read({data:{post_id:this.options.post,comment_id:this.options.comment,sort:this.thread.get("_sort_order")},message:{waiting:"Fetching thread information..."}},function(){if(that.thread.get("is_spam")&&!Coursera.user.canModerateForum()){var returnLink=that.thread.get("crumbs")[0].link;that.$el.html(AccessErrorView({forumLink:returnLink}))}else that.thread.onFetchPosts(),that.render(),that.thread.on("change",that.render,that),that.thread.on("posts:refresh",that.render,that)}),this.postContainers={},this.thread.bind("posts:monitor",this.scrollEnable,this),this.thread.bind("posts:unmonitor",this.scrollDisable,this),this.onScrollHandler=_.bind(this.onScroll,this),this.scrollEnable()},scrollDisable:function(){$(window).off("scroll",this.onScrollHandler)},scrollEnable:function(){$(window).on("scroll",this.onScrollHandler)},renderError:function(e,xhr){this.$(".course-forum-thread-error").remove();var $errorDiv=$("<div>");$errorDiv.append(xhr.responseText).addClass("alert alert-error course-forum-thread-error"),this.$el.append($errorDiv)},updatePageMeta:function(){if("page"!=this.options.mode)return;document.title=this.thread.get("title"),metatags.set({"og:title":this.thread.get("title"),"og:url":this.thread.get("link")})},render:function(){var self=this,changedAttrs=self.thread.changedAttributes();if(self.updatePageMeta(),!self.$(".course-forum-thread-posts-container").length)if(self.$el.html(ThreadTemplate({reporterLink:self.thread.get("_reporter_link")+"?url="+encodeURIComponent(window.location.href),thread:self.thread})),self.$(".course-forum-thread-crumbs").html(ForumCrumbsTemplate({_:_,crumbs:this.thread.get("crumbs")})),this.thread.get("user_id")!=Coursera.user.get("id"))window.setTimeout(function(){BadgevilleUtil.credit({verb:"viewed",thread:self.thread.get("id")})},7e3);if(self.$(".course-forum-thread-header-wrapper").html(new ThreadHeaderView({model:this.thread}).render().el),self.$(".course-forum-thread-tags").html(new ThreadTagsView({model:this.thread}).render().el),self.renderPosts(),self.$(".course-forum-thread-posts-container").is(":empty")||changedAttrs&&_.intersection(_.keys(changedAttrs),["locked","start_range","end_range","num_posts"]).length>0){self.$(".course-forum-thread-sort").html(ThreadSortTemplate({thread:this.thread}));var activeSortButton=null;if(self.$(".course-forum-thread-sort ul li").each(function(index,el){var $el=self.$(el);if($el.attr("data-sort-name")===self.thread.get("sort"))$el.addClass("active"),activeSortButton=$el}),!activeSortButton)self.$(".course-forum-thread-sort ul li").eq(1).addClass("active");self.scrollToPermalinkMaybe(),self.maybeShowHangoutPopup()}if(1==self.thread.get("deleted"))self.$el.addClass("course-forum-thread-deleted");else self.$el.removeClass("course-forum-thread-deleted");if(1==self.thread.get("locked"))self.$(".course-forum-thread-new-post").hide(),self.$(".course-forum-new-comment-link-container").hide();else self.$(".course-forum-thread-new-post").show(),self.$(".course-forum-new-comment-link-container").show();return self},scrollToPermalinkMaybe:function(){var self=this;if(!self.hasScrolled){self.hasScrolled=!0;var post=this.options.post,comment=this.options.comment,$el;if(post)$el=self.$('[data-permalink="post-'+post+'"]');else if(comment)$el=self.$('[data-permalink="comment-'+comment+'"]');if($el)$el.addClass("course-forum-permalink"),scrollToEl($el),self.thread.getPostsBefore(function(){scrollToEl($el)})}},initNewPost:function(order){var self=this;this.newPost=new PostModel({thread_id:this.thread.get("id"),order:order});var view=new PostContainerView({thread:this.thread,model:this.newPost,comments:this.thread.getCommentsForPost(this.newPost)});self.$el.find(".course-forum-thread-new-post").html(view.render().$el)},renderPosts:function(){var self=this,previousPost=null;if(self.model.get("posts").each(function(post,index){if(!_.has(self.postContainers,post.get("id"))&&post.get("post_text")){var view=new PostContainerView({model:post,thread:self.thread,comments:self.thread.getCommentsForPost(post)}),nearestNextPost=self.thread.get("posts").find(function(otherPost){return otherPost.get("order")>post.get("order")&&self.postContainers[otherPost.get("id")]}),nearestPrevPost=_.find(self.thread.get("posts").toArray().reverse(),function(otherPost){return otherPost.get("order")<post.get("order")&&self.postContainers[otherPost.get("id")]});if(nearestNextPost){var nextPostContainer=self.postContainers[nearestNextPost.get("id")];nextPostContainer.$el.before(view.render().$el)}else if(nearestPrevPost){var prevPostContainer=self.postContainers[nearestPrevPost.get("id")];prevPostContainer.$el.after(view.render().$el)}else self.$el.find(".course-forum-thread-posts-container").append(view.render().$el);self.postContainers[post.get("id")]=view}}),self.thread.get("end_range")===self.thread.get("posts").size())self.hideBottomScrollIndicator(),self.initNewPost(self.thread.getLastPost().get("order")+1);if(1===self.thread.get("start_range"))self.$el.find(".course-forum-top-scroll-indicator").hide()},hideBottomScrollIndicator:function(){this.$el.find(".course-forum-bottom-scroll-indicator").hide(),this.$el.find(".course-forum-thread-new-post")},onScroll:function(){this.hasScrolled=!0;var $el=$(window),buffer=400;if($el.scrollTop()+$el.height()+buffer>$(document).height())if(this.thread.get("posts").size()>this.thread.getLastPost().get("order"))getPostsAfter(this);if($el.scrollTop()<100)if(this.thread.getFullPosts().length&&this.thread.getFirstPost().get("order")>1)getPostsBefore(this)},onAdminDetailsClick:function(){this.$(".course-forum-post-admin-container").show(),Coursera.multitracker.push([TRACKER_LABEL,"Admin Details"])},maybeShowHangoutPopup:function(){var COOKIE_DISABLED="course.forum.hangouts.disabled",$hangoutPopup=this.$(".course-forum-hangouts-popup");if(this.hangoutsEnabled&&!$hangoutPopup.is(":visible")&&window.outerWidth>1200&&this.thread.userContributed(Coursera.user.get("id"))&&this.thread.getTotalVotes()>=2&&this.thread.get("posts").size()+this.thread.get("comments").size()>=3&&!cookie.get(COOKIE_DISABLED))this.$("[data-action=start]").on("click",function(){$(this).next("p").show(),Coursera.multitracker.push([TRACKER_LABEL,"Hangout Popup Start Click"]),$(this).off("click")}),this.$("[data-action=join]").on("click",function(){$(this).next("p").show(),Coursera.multitracker.push([TRACKER_LABEL,"Hangout Popup Join Click"]),$(this).off("click")}),this.$("[data-action=hide]").on("click",function(){$hangoutPopup.hide(),Coursera.multitracker.push([TRACKER_LABEL,"Hangout Popup Close Click"]),$(this).off("click")}),this.$("[data-action=nothanks]").on("click",function(){$hangoutPopup.hide(),Coursera.multitracker.push([TRACKER_LABEL,"Hangout Popup NoThanks Click"]),cookie.set(COOKIE_DISABLED,"true"),$(this).off("click")}),$hangoutPopup.show(),Coursera.multitracker.push([TRACKER_LABEL,"Hangout Popup Show"])}});return view}),!function(wndw){var jadify=function(jade,_t){_t="undefined"!=typeof _t?_t:function(key,interpolationHash){if("object"==typeof interpolationHash)return key.replace(/[#!]\{([^}]+?)\}/g,function(match,interpKey){return interpolationHash[interpKey]||interpKey});else return key};var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(config,linkToReporter){buf.push("<link"+jade.attr("href",config.url.assets+"pages/home/account/select2.css",!0,!1)+' rel="stylesheet" type="text/css"/><div class="course-forum-thread-new"><div style="display:none; float:right;" class="course-forum-thread-new-problem"><a'+jade.attr("href",linkToReporter,!0,!1)+' class="btn btn-info">I want to report a problem &raquo;</a></div><h2 class="course-page-header">New Thread</h2><p>Thanks for contributing to our forums!\nTo ensure a positive and productive discussion,\nplease read our <a target="_blank" href="http://help.coursera.org/customer/portal/articles/1220499-forum-code-of-conduct?ref=newthread">forum posting policies</a>.</p><form class="form-horizontal course-forum-thread-new-form"><input type="hidden" name="text_type" value="html"/><div class="control-group course-forum-thread-new-bug"><div class="controls"><label class="checkbox"><input type="checkbox" name="is_bug_report"/>Is this a bug report?</label><span class="help-inline">Please check if your problem or question has been addressed <a href="http://help.coursera.org">here</a>.</span></div></div><div class="control-group hide course-forum-thread-new-platform"><div class="controls"><label class="checkbox"><input type="checkbox" name="is_coursera_bug_report"/>This is a Coursera-platform bug report.</label><span class="help-inline">(e.g. video playback issues, 404 errors, issues encountered when submitting homeworks).</span></div></div><div class="control-group hide course-forum-thread-new-materials"><div class="controls"><label class="checkbox"><input type="checkbox" name="is_course_material_report"/>This is a report on a course material issue.</label><span class="help-inline">(e.g. typos and potential errors in the lectures, assignments/grading, and other course materials).</span></div></div><div class="control-group"><label for="course-forum-thread-new-title-input" class="control-label">Title</label><div class="controls"><input type="text" name="title" id="course-forum-thread-new-title-input"/><p class="help-block">Give your post a good, informative title.<br/><span class="icon-thumbs-up"> Good</span>: "When is assignment 1 due?"<br/><span class="icon-thumbs-down"> Bad</span>: "I have a question regarding assignments." </p><div style="padding-top:15px;display:none" aria-atomic="true" aria-live="polite" class="course-forum-new-suggestions"><p>Some of these other threads may be of interest:<ul class="course-forum-new-suggestions-list"></ul></p></div></div></div><div class="control-group"><label for="course-forum-thread-new-content-input" class="control-label">Content</label><div class="controls"><textarea name="text" style="min-height: 200px;" id="course-forum-thread-new-content-input" dir="auto"></textarea></div></div><div class="control-group"><label for="course-forum-thread-new-tags-input" class="control-label">Tags</label><div class="controls"><input type="text" name="tags" style="width:475px;" id="course-forum-thread-new-tags-input" class="input-medium"/><br/><span class="help-inline">Try to use existing tags.</span></div></div><div class="control-group"><label for="course-forum-thread-new-forum-input" class="control-label">Forum:</label><div class="controls"><select name="forum_id" id="course-forum-thread-new-forum-input" class="course-forum-thread-new-subforums"></select><p class="help-block">Post in the appropriate sub-forum so that you reach an audience\nthat cares the most about your thread. Every class is different, so please first browse to see how\nyour class forums are organized. </p></div></div><div class="control-group"><div class="controls"><label class="checkbox"><input type="checkbox" name="anonymous" value="1"/>Make this post anonymous to other students</label></div></div><div class="control-group"><div class="controls"><label class="checkbox"><input type="checkbox" name="_user_is_subscribed" value="1" checked="checked"/>Subscribe to this thread at the same time</label></div></div><div class="control-group"><div class="controls"><button type="submit" class="btn btn-primary">Create new thread</button><span class="help-inline error course-forum-thread-new-error"></span></div></div></form></div>')}("config"in locals_for_with?locals_for_with.config:"undefined"!=typeof config?config:void 0,"linkToReporter"in locals_for_with?locals_for_with.linkToReporter:"undefined"!=typeof linkToReporter?linkToReporter:void 0),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("pages/forum/views/ThreadNewView.html",["js/lib/jade"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["pages.forum.views.ThreadNewView"]=jadify(wndw.jade.helpers)}(window),define("pages/forum/views/ThreadNewView",["backbone","jquery","underscore","pages/spark/app","pages/forum/models/ForumCollection","pages/forum/views/ThreadNewView.html","pages/forum/views/EditorUtil","pages/forum/models/ThreadModel","js/lib/select2","js/lib/badgeville"],function(Backbone,$,_,Coursera,ForumCollection,ThreadNewTemplate,EditorUtil,ThreadModel,Select2,BadgevilleUtil){var TRACKER_LABEL="Forum Thread New",TAG_TECHNICAL="BugInPlatform",TAG_MATERIALS="BugInCourseMaterial",TAG_BUG="BugReport",FORUM_TECHNICAL="technical",FORUM_MATERIALS="course material",view=Backbone.View.extend({defaults:{},events:{"submit .course-forum-thread-new-form":"onThreadSave","change input[name=is_bug_report]":"onBugChange","change input[name=is_coursera_bug_report]":"onBugTypeChange","change input[name=is_course_material_report]":"onBugTypeChange","blur input[name=title]":"onTitleChange","click a[href*=forum-code-of-conduct]":"onConductClick"},initialize:function(options){this.options=options,this.thread=this.model,this.render()},render:function(){var self=this;if(self.$el.html(ThreadNewTemplate({config:Coursera.config,linkToReporter:self.options.linkToReporter})),self.$form=self.$(".course-forum-thread-new-form"),self.editor=EditorUtil.makeEditor(self.$form),self.options.linkToReporter)self.$(".course-forum-thread-new-bug").hide(),self.$(".course-forum-thread-new-problem").show();
self.$bugCheckbox=self.$('input[name="is_bug_report"]'),self.$techCheckbox=self.$('input[name="is_coursera_bug_report"]'),self.$materialsCheckbox=self.$('input[name="is_course_material_report"]'),self.bugFields=[self.$techCheckbox,self.$materialsCheckbox],self.$tagsInput=self.$('input[name="tags"]'),self.$titleInput=self.$("input[name=title]"),self.$forumsDropdown=self.$(".course-forum-thread-new-subforums"),self.$titleInput.off("keyup input").on("keyup input",_.debounce(_.bind(this.onTitleChange,this),400)),Coursera.api.get("forum/forums").done(function(data){var forumCollection=new ForumCollection(data),recursiveHelper=function(forum){if(forum.isOpen()){if(0!==forum.get("id")&&(forum.get("can_post")||Coursera.user.canModerateForum())){var $option=$("<option>");if($option.attr("value",forum.id),$option.text(forum.getFullName()),forum.id==self.thread.get("forum_id"))$option.attr("selected","selected"),self.forum=forum;self.$forumsDropdown.append($option)}for(var childForums=forumCollection.where({parent_id:forum.get("id")}),i=0;i<childForums.length;i++)recursiveHelper(childForums[i])}};recursiveHelper(forumCollection.get(0)),self.forums=data,self.setupBugFields()}),Coursera.api.get("forum/tags").done(function(data){var tags=_.map(data,function(datum){return datum.tag_name});if(self.$tagsInput.select2({tags:tags}),self.options.tagName)self.addTag(self.options.tagName)})},setupBugFields:function(){var self=this;if(!self.forum)return;if(self.options.linkToReporter)return;var inTechForum=self.forum.get("name").toLowerCase().indexOf(FORUM_TECHNICAL)>-1,inMaterialsForum=self.forum.get("name").toLowerCase().indexOf(FORUM_MATERIALS)>-1;if(inTechForum||inMaterialsForum)self.$bugCheckbox.attr("checked","checked");if(inTechForum)self.$techCheckbox.attr("checked","checked");if(inMaterialsForum)self.$materialsCheckbox.attr("checked","checked");self.onBugChange(),self.onBugTypeChange()},onBugChange:function(){var self=this;if(self.$bugCheckbox.is(":checked")){$.each(self.bugFields,function(ind,$field){$field.parents(".control-group").show()});var $textArea=self.$("textarea[name=text]");if(""===$textArea.val()){var template="The problem summary:<br><br>Steps to reproduce:<ol><li></li></ol><br>Screenshot:<br><br>";self.editor.setValue(template)}self.addTag(TAG_BUG)}else $.each(self.bugFields,function(ind,$field){$field.parents(".control-group").hide()}),self.removeTag(TAG_BUG)},updateTags:function(tags){var self=this;self.$tagsInput.val(_.uniq(tags)),self.$tagsInput.select2("val",_.uniq(tags))},addTag:function(tagName){var self=this,currentTags=[];if(""!==self.$tagsInput.val())currentTags=self.$tagsInput.val().split(",");currentTags.push(tagName),self.updateTags(currentTags)},removeTag:function(tagName){var self=this,currentTags=[];if(""!==self.$tagsInput.val())currentTags=self.$tagsInput.val().split(",");currentTags=_.without(currentTags,tagName),self.updateTags(currentTags)},onBugTypeChange:function(){var self=this;if(self.$techCheckbox.is(":checked"))self.addTag(TAG_TECHNICAL),self.$forumsDropdown.find("option").each(function(){if($(this).text().toLowerCase().indexOf(FORUM_TECHNICAL)>-1)$(this).attr("selected","selected")});else self.removeTag(TAG_TECHNICAL);if(self.$materialsCheckbox.is(":checked"))self.addTag(TAG_MATERIALS),self.$forumsDropdown.find("option").each(function(){if($(this).text().toLowerCase().indexOf(FORUM_MATERIALS)>-1)$(this).attr("selected","selected")});else self.removeTag(TAG_MATERIALS)},onTitleChange:function(){var self=this,searchText=self.$titleInput.val();if(!searchText)return;var searchUrl="forum/search?query="+encodeURIComponent(searchText)+"&page_size=7";Coursera.api.get(searchUrl).done(function(data){if(data.threads&&data.threads.length)self.$(".course-forum-new-suggestions-list").empty(),_.each(data.threads,function(thread){var $threadLink=$("<a>").attr("href",thread.link).text(thread.title),$threadItem=$("<li></li>").append($threadLink);self.$(".course-forum-new-suggestions-list").append($threadItem)}),self.$(".course-forum-new-suggestions").show("fast")})},redirectToThread:function(id){var baseUrl=window.location.pathname.substr(0,window.location.pathname.lastIndexOf("/")+1);window.location.href=baseUrl+"thread?thread_id="+id},onThreadSave:function(e){function renderError(msg){self.$(".course-forum-thread-new-error").closest(".control-group").addClass("error"),self.$(".course-forum-thread-new-error").html("Error: "+msg),self.$form.find("button").attr("disabled",null)}e.preventDefault();var self=this;self.$form.find("button").attr("disabled","disabled");var props=EditorUtil.getPropsFromForm(self.$form);props.tags=_.map(props.tags.split(","),function(tagName){return{tag_name:tagName}}),self.thread.update(props,{message:{waiting:"Creating thread...",success:"Created thread!"}}).done(function(data){if(data.id)if(1!=props.anonymous&&BadgevilleUtil.isEnabled())BadgevilleUtil.credit({verb:"created-thread",week:BadgevilleUtil.getWeek()},function(){self.redirectToThread(data.id)});else self.redirectToThread(data.id);else renderError("Could not create thread.")}).fail(function(xhr){renderError(xhr.responseText)})},onConductClick:function(){Coursera.multitracker.push([TRACKER_LABEL,"Click code of conduct"])}});return view}),!function(wndw){var jadify=function(jade,_t){_t="undefined"!=typeof _t?_t:function(key,interpolationHash){if("object"==typeof interpolationHash)return key.replace(/[#!]\{([^}]+?)\}/g,function(match,interpKey){return interpolationHash[interpKey]||interpKey});else return key};var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp;return buf.push('<h5 style="font-weight:normal">Forum activity for:</h5><div class="coursera-profile-basics"></div><div style="display:none; overflow:hidden; border-top: 1px solid #ccc; margin:15px 0px; padding-top: 6px;" class="coursera-profile-badgeville-missions"><a href="../wiki/view?page=CourseBadges" style="float: right;">Learn more about badges</a><div class="coursera-profile-badgeville-missions-list"><span>Loading...</span></div></div><div style="display:none; overflow:hidden; border-top: 1px solid #ccc; margin:15px 0px;" class="coursera-profile-forum-activities"></div><div style="display:none; clear: both; width: 100%; text-align: center; margin-top: 30px;" class="course-forum-profile-search"><a style="display:none; border: 1px solid #CCC; padding: 10px;">Find all activities</a></div>'),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("pages/forum/views/UserProfileView.html",["js/lib/jade"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["pages.forum.views.UserProfileView"]=jadify(wndw.jade.helpers)}(window),!function(wndw){var jadify=function(jade,_t){_t="undefined"!=typeof _t?_t:function(key,interpolationHash){if("object"==typeof interpolationHash)return key.replace(/[#!]\{([^}]+?)\}/g,function(match,interpKey){return interpolationHash[interpKey]||interpKey});else return key};var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(total,threads){if(buf.push('<div class="span3"><h5>'),total>threads.length)buf.push("Last "+jade.escape(null==(jade_interp=threads.length)?"":jade_interp)+" threads (of "+jade.escape(null==(jade_interp=total)?"":jade_interp)+")");else buf.push(""+jade.escape(null==(jade_interp=threads.length)?"":jade_interp)+" "+jade.escape(null==(jade_interp=1==threads.length?"thread":"threads")?"":jade_interp));buf.push("</h5><ul>"),function(){var $$obj=threads;if("number"==typeof $$obj.length)for(var $index=0,$$l=$$obj.length;$$l>$index;$index++){var thread=$$obj[$index];buf.push("<li><a"+jade.attr("href",thread.link,!0,!1)+">"+jade.escape(null==(jade_interp=thread.title)?"":jade_interp)+"</a></li>")}else{var $$l=0;for(var $index in $$obj){$$l++;var thread=$$obj[$index];buf.push("<li><a"+jade.attr("href",thread.link,!0,!1)+">"+jade.escape(null==(jade_interp=thread.title)?"":jade_interp)+"</a></li>")}}}.call(this),buf.push("</ul></div>")}("total"in locals_for_with?locals_for_with.total:"undefined"!=typeof total?total:void 0,"threads"in locals_for_with?locals_for_with.threads:"undefined"!=typeof threads?threads:void 0),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("pages/forum/views/UserProfileThreadLink.html",["js/lib/jade"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["pages.forum.views.UserProfileThreadLink"]=jadify(wndw.jade.helpers)}(window),!function(wndw){var jadify=function(jade,_t){_t="undefined"!=typeof _t?_t:function(key,interpolationHash){if("object"==typeof interpolationHash)return key.replace(/[#!]\{([^}]+?)\}/g,function(match,interpKey){return interpolationHash[interpKey]||interpKey});else return key};var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(total,entries,header){if(buf.push('<div class="span4"><h5>'),total>entries.length)buf.push("Last "+jade.escape(null==(jade_interp=entries.length)?"":jade_interp)+" "+jade.escape(null==(jade_interp=header)?"":jade_interp)+"s (of "+jade.escape(null==(jade_interp=total)?"":jade_interp)+")");else buf.push(""+jade.escape(null==(jade_interp=entries.length)?"":jade_interp)+" "+jade.escape(null==(jade_interp=1==entries.length?header:header+"s")?"":jade_interp));buf.push("</h5><ul>"),function(){var $$obj=entries;if("number"==typeof $$obj.length)for(var $index=0,$$l=$$obj.length;$$l>$index;$index++){var entry=$$obj[$index];buf.push("<li><span>In <a"+jade.attr("href",entry.link,!0,!1)+">"+jade.escape(null==(jade_interp=entry.thread_title)?"":jade_interp)+': </a></span><span>"'+jade.escape(null==(jade_interp=entry.snippet)?"":jade_interp)+'"</span></li>')}else{var $$l=0;for(var $index in $$obj){$$l++;var entry=$$obj[$index];buf.push("<li><span>In <a"+jade.attr("href",entry.link,!0,!1)+">"+jade.escape(null==(jade_interp=entry.thread_title)?"":jade_interp)+': </a></span><span>"'+jade.escape(null==(jade_interp=entry.snippet)?"":jade_interp)+'"</span></li>')}}}.call(this),buf.push("</ul></div>")}("total"in locals_for_with?locals_for_with.total:"undefined"!=typeof total?total:void 0,"entries"in locals_for_with?locals_for_with.entries:"undefined"!=typeof entries?entries:void 0,"header"in locals_for_with?locals_for_with.header:"undefined"!=typeof header?header:void 0),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("pages/forum/views/UserProfileEntryLink.html",["js/lib/jade"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["pages.forum.views.UserProfileEntryLink"]=jadify(wndw.jade.helpers)}(window),!function(wndw){var jadify=function(jade,_t){var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(user,config,spark_class_short_name,spark_class_id){if(buf.push('<div style="overflow:hidden; position:relative;">'),user.external_id)buf.push("<a"+jade.attr("href",config.url.base+"user/i/"+user.external_id,!0,!1)+' style="float:right;"><span class="icon-user"></span> View Coursera profile</a>');if(buf.push('<img style="width:60px;height:60px;float:left;border:1px solid #ccc; margin-bottom: 10px;"'+jade.attr("src",user.photo_120||config.url.assets+"images/icons/avatar.jpg",!0,!1)+' alt=""/><div style="float:left; margin-left: 10px;"><h4 style="margin-top:0px;">'+jade.escape(null==(jade_interp=user.display_name||user.full_name)?"":jade_interp)),"Student"!=user.forum_title)buf.push('<span class="course-forum-profile-badge">'+jade.escape(null==(jade_interp=user.forum_title)?"":jade_interp)+"</span>");else if(user.in_signature_track)buf.push('<a style="text-decoration: none; font-weight: normal;"'+jade.attr("href",config.url.base+"signature/course/"+spark_class_short_name+"/"+spark_class_id+"?utm_source=spark&utm_medium=forum",!0,!1)+' target="_blank"><span class="course-forum-profile-badge-signaturetrack">Signature Track</span></a>');if(buf.push("</h4></div>"),user.bio)buf.push('<p style="clear:left;">'+jade.escape(null==(jade_interp=user.bio)?"":jade_interp)+"</p>");buf.push('<div style="position: absolute; bottom: 0px; right: 0px; text-align: right;"></div></div>')}("user"in locals_for_with?locals_for_with.user:"undefined"!=typeof user?user:void 0,"config"in locals_for_with?locals_for_with.config:"undefined"!=typeof config?config:void 0,"spark_class_short_name"in locals_for_with?locals_for_with.spark_class_short_name:"undefined"!=typeof spark_class_short_name?spark_class_short_name:void 0,"spark_class_id"in locals_for_with?locals_for_with.spark_class_id:"undefined"!=typeof spark_class_id?spark_class_id:void 0),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("pages/forum/views/UserProfileBasics.html",["js/lib/jade"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["pages.forum.views.UserProfileBasics"]=jadify(wndw.jade.helpers)}(window),define("pages/forum/views/UserProfileView",["backbone","jquery","underscore","pages/spark/app","js/lib/api","pages/forum/views/UserProfileView.html","pages/forum/views/UserProfileThreadLink.html","pages/forum/views/UserProfileEntryLink.html","pages/forum/views/UserProfileBasics.html","js/lib/badgeville"],function(Backbone,$,_,Coursera,API,UserProfileTemplate,UserProfileThreadLinkTemplate,UserProfileEntryLinkTemplate,UserProfileBasicsTemplate,BadgevilleUtil){var view=Backbone.View.extend({defaults:{},events:{},initialize:function(options){var self=this;this.options=options,this.setupBadgevilleMissions=!1,this.courseraWWWAPI=API("",{type:"rest","csrf.cookie":"csrf_token","csrf.token":"X-CSRF-Token"}),Coursera.api.get("user/information/"+this.options.id).done(function(data){self.getUserProfile(data,self.options.id)}),Coursera.api.get("user/information/"+this.options.id+"/activities").done(function(data){self.renderActivities(data)}),this.render()},render:function(){var self=this;if(!self.$(".coursera-profile-basics").length)self.$el.html(UserProfileTemplate())},getUserProfile:function(data,id){var self=this,url=Coursera.config.url.base+Coursera.config.url.api+"user/profiles?user-ids="+id;self.courseraWWWAPI.get(url,{dataType:"jsonp",type:"get",success:function(profiles){if(profiles&&1==profiles.length)self.renderBasics(_.extend(data,profiles[0]));else self.renderBasics(data)}})},renderBasics:function(data){var self=this;if(self.$(".coursera-profile-basics").html(UserProfileBasicsTemplate({spark_class_short_name:Coursera.course.get("shortname"),spark_class_id:Coursera.course.get("id"),config:Coursera.config,user:data})),BadgevilleUtil.isEnabled())self.renderBadgevilleTimeout=window.setTimeout(function(){self.renderBadgevilleMissions()},200);if(data.search_link)self.$(".course-forum-profile-search a").attr("href",data.search_link).show()},renderBadgevilleMissions:function(){var self=this;if(BadgevilleUtil.isEnabled())self.$(".coursera-profile-badgeville-missions").show(),BadgevilleUtil.setupMissionsDisplay(self.user.get("id"),self.$(".coursera-profile-badgeville-missions-list"),BadgevilleUtil.getUserBucket(Coursera.user.get("id")).badge_ladder,Coursera.user.get("id")==self.user.get("id")?"you":"they"),window.clearTimeout(self.renderBadgevilleTimeout)},renderActivities:function(activities){var self=this;if(activities)if(activities.threads.length||activities.posts.length||activities.comments.length){var $activities=self.$(".coursera-profile-forum-activities");if(activities.totals.threads>0)$activities.append(UserProfileThreadLinkTemplate({threads:activities.threads,total:activities.totals.threads}));if(activities.totals.posts>0)$activities.append(UserProfileEntryLinkTemplate({entries:activities.posts,header:"post",total:activities.totals.posts}));if(activities.totals.comments>0)$activities.append(UserProfileEntryLinkTemplate({entries:activities.comments,header:"comment",total:activities.totals.comments}));if(activities.totals.threads>activities.threads.length||activities.totals.posts>activities.posts.length||activities.totals.comments>activities.comments.length)self.$(".course-forum-profile-search").show();$activities.show()}}});return view}),!function(wndw){var jadify=function(jade,_t){var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(reporterLink,forum,config){if(buf.push('<a target="_blank"'+jade.attr("href",reporterLink,!0,!1)+' title="Help center for course issues. This will open in a new tab." class="coursera-reporter-link">Help</a><div class="course-forum-crumbs"></div><div class="course-forum-header-wrapper"></div><form method="get"'+jade.attr("action",forum.get("_search_link"),!0,!1)+' class="form-search pull-right"><label for="course-forum-search-input" class="hidden">Search </label><input id="course-forum-search-input" type="text" name="q" class="input-medium search-query"/><span>&nbsp;</span><button type="submit" class="btn">Search</button></form><h2 class="hidden">'+jade.escape(null==(jade_interp=forum.get("name"))?"":jade_interp)),-1!=forum.get("parent_id"))buf.push('<a href="list?forum_id=parent_id"><i class="icon-arrow-up">Go to parent forum</i></a>');if(buf.push('</h2><p class="course-forum-description">'+jade.escape(null==(jade_interp=forum.get("description"))?"":jade_interp)+'\nPlease read our <a target="_blank" href="http://help.coursera.org/customer/portal/articles/1220499-forum-code-of-conduct?ref=fromforumlist">forum posting policies</a> before posting or starting a new thread.</p>'),"Signature Track"===forum.get("name"))buf.push("<h5>Useful Links</h5><ul><li><a"+jade.attr("href",config.url.base+"signature/guidebook",!0,!1)+' target="_new" class="course-forum-signature-track">Signature Track Guidebook</a><span>: Short and sweet answers to all your basic questions, including troubleshooting tips</span></li><li><a href="http://help.coursera.org/customer/widget/emails/new" target="_new" class="course-forum-signature-track">Signature Track Support Center</a><span>: Contact form to get help from the Signature Track Support Team</span></li><li><a href="http://help.coursera.org/" target="_new" class="course-forum-signature-track">Student Support Center</a><span>: For all other types of questions about Coursera</span></li></ul>');buf.push('<div class="course-forum-subforums-listing-wrapper"></div><div style="clear:right; margin-top: 10px;" class="course-forum-your-threads-listing-wrapper"></div><div style="clear:right; margin-top:30px;" class="course-forum-threads-listing-wrapper"></div><div style="margin-top: 10px;" class="course-forum-reputations-link"><a'+jade.attr("href",forum.get("_reputation_link"),!0,!1)+'><i class="icon-star"></i> See top forum posters</a></div>')}("reporterLink"in locals_for_with?locals_for_with.reporterLink:"undefined"!=typeof reporterLink?reporterLink:void 0,"forum"in locals_for_with?locals_for_with.forum:"undefined"!=typeof forum?forum:void 0,"config"in locals_for_with?locals_for_with.config:"undefined"!=typeof config?config:void 0),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("pages/forum/views/ForumView.html",["js/lib/jade"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["pages.forum.views.ForumView"]=jadify(wndw.jade.helpers)}(window),!function(wndw){var jadify=function(jade,_t,_h){var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(forum){if(forum.get("forum_moderators_only"))buf.push('<div style="margin-top: 15px" class="alert">This is a private forum. Only university administrators, course staff, and Coursera staff can see this forums. All threads in this forum will be automatically marked as private.</div>');buf.push('<div class="course-forum-title"><h2>'+jade.escape(null==(jade_interp=forum.get("name"))?"":jade_interp)+'</h2></div><div class="course-forum-header"><div class="course-forum-controls">');var popupId="course-forum-controls-popup-"+forum.get("id");if(buf.push('<a title="Forum controls" tabindex="0" role="button" aria-haspopup="true" aria-expanded="false"'+jade.attr("aria-owns",popupId,!0,!1)+jade.attr("data-popup","#"+popupId,!0,!1)+' data-popup-direction="se" class="course-forum-controls-toggle"><i class="icon-cog"><span class="hidden">Forum controls</span></i></a><div'+jade.attr("id",popupId,!0,!1)+' class="course-forum-controls-popup hide"><a href="javascript:void(0)">Mark all as read</a></div></div><div style="margin-right:10px; display:inline-block;">'),0==forum.get("id"))buf.push("<a"+jade.attr("href",forum.get("_profile_link"),!0,!1)+'><span class="icon-comments"></span> View your latest activity</a>&nbsp; | &nbsp;');if(forum.get("_viewer_subscription"))buf.push('<i class="icon-envelope"></i> You are subscribed.  <a href="javascript:void(0);" class="course-forum-unsubscribe-link">Unsubscribe</a>');else buf.push('<a href="javascript:void(0);" class="course-forum-subscribe-link">Subscribe for email updates.</a>');buf.push("</div></div>")}("forum"in locals_for_with?locals_for_with.forum:"undefined"!=typeof forum?forum:void 0),buf.join("")};return function(locals){if(locals)if(locals._h)_h=locals._h.merge(_h);return yudify(locals)}};if("function"==typeof define&&define.amd)define("pages/forum/views/ForumHeaderView.html",["js/lib/jade","js/lib/jade._h"],function(jade,_h){var _t;return jadify(jade,_t,_h)});else wndw.jade.templates["pages.forum.views.ForumHeaderView"]=jadify(wndw.jade.helpers)}(window),!function(wndw){var jadify=function(jade,_t,_h){var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(config){buf.push('<div class="modal"><div class="modal-header"><button aria-hidden="true" data-modal-close="data-modal-close" class="close">×</button><h4 style="margin-left: 20px">Forum subscriptions</h4></div><div style="margin-left: 50px; margin-right: 50px; margin-top: 20px" class="modal-body"><div class="loading"><img'+jade.attr("src",config.url.assets+"images/icons/loading.gif",!0,!1)+'/>&nbsp;&nbsp;Loading...</div><div class="no-loading hide"><p style="font-size: 15px; font-weight: bold">Subscribe for email updates for new threads from:</p><div style="margin-left: 20px" class="forum-titles"></div></div></div><div class="modal-footer"><button data-subscriptions-submit="data-subscriptions-submit" type="button" class="btn btn-primary">Done!</button><button data-modal-close="data-modal-close" type="button" class="btn">Cancel</button></div></div>')}("config"in locals_for_with?locals_for_with.config:"undefined"!=typeof config?config:void 0),buf.join("")};return function(locals){if(locals)if(locals._h)_h=locals._h.merge(_h);return yudify(locals)}};if("function"==typeof define&&define.amd)define("pages/forum/views/ForumSubscribeModalView.html",["js/lib/jade","js/lib/jade._h"],function(jade,_h){var _t;return jadify(jade,_t,_h)});else wndw.jade.templates["pages.forum.views.ForumSubscribeModalView"]=jadify(wndw.jade.helpers)}(window),define("pages/forum/views/ForumSubscribeModalView",["backbone","jquery","underscore","pages/spark/app","js/lib/modals","pages/forum/models/ForumCollection","pages/forum/views/ForumSubscribeModalView.html"],function(Backbone,$,_,Coursera,Modal,ForumCollection,ForumSubscribeModalTemplate){var SUPPORT_FORUM_PARENT_ID=-2,view=Backbone.View.extend({events:{"click [data-subscriptions-submit]":"submitSubscriptions"},initialize:function(options){var self=this;self.options=options,self.forum=self.model,self.model.api.get(self.model.url,{data:{can_subscribe:1}}).done(function(forums){self.forums=new ForumCollection(self.filterRelevantSubforums(forums,self.forum.get("id")));var forum_ids=self.forums.pluck("id");self.model.api.get("forum/subscriptions",{data:{forum_ids:forum_ids.join()}}).done(function(forumSubscriptions){self.subscriptions=forumSubscriptions,self.showForums(self.forum),self.$el.find(".no-loading").show(),self.$el.find(".loading").hide()})})},render:function(){return this.$el.html(ForumSubscribeModalTemplate({config:Coursera.config,model:this.model})),this},filterRelevantSubforums:function(forumsList,origId){var rootForum=_.find(forumsList,function(f){return f.id==origId}),forums=[];if(rootForum)forums.push(rootForum);var recurseHelper=function(id){_.each(_.filter(forumsList,function(f){return f.parent_id==id}),function(f){forums.push(f),recurseHelper(f.id)})};if(recurseHelper(origId),0===origId)recurseHelper(SUPPORT_FORUM_PARENT_ID);return forums},showForums:function(rootForum){var self=this,tabindex=1,$forumTitles=self.$el.find(".forum-titles"),addForumLine=function(forum,tabCount){for(var subscription=_.find(self.subscriptions,function(subscription){return subscription.forum_id==forum.get("id")}),tabs="",i=0;tabCount>i;i++)tabs+="&emsp;&emsp;";var checkbox="";if(subscription||rootForum.get("id")===forum.get("id"))checkbox=" checked";$forumTitles.append($("<p>"+tabs+'<input style="vertical-align: top; margin-right: 10px;" type="checkbox" id="forum'+forum.get("id")+'" data-forum-id='+forum.get("id")+checkbox+" tabindex="+tabindex+'><label style="display: inline;" for="forum'+forum.get("id")+'">'+forum.get("name")+"</label></p>")),tabindex++},showForumsRecurseHelper=function(id,tabCount){_.each(self.forums.where({parent_id:id}),function(forum){if(forum.isOpen())addForumLine(forum,tabCount),showForumsRecurseHelper(forum.id,tabCount+1)})},TAB_COUNT=0;if(0===rootForum.get("id"))showForumsRecurseHelper(rootForum.get("id"),TAB_COUNT),_.each(self.forums.where({parent_id:SUPPORT_FORUM_PARENT_ID}),function(forum){addForumLine(forum,TAB_COUNT)});else{var rootForumObj=self.forums.where({id:rootForum.get("id")});if(1==rootForumObj.length)addForumLine(rootForumObj[0],TAB_COUNT);showForumsRecurseHelper(rootForum.get("id"),TAB_COUNT+1)}},submitSubscriptions:function(){var self=this,changed={};self.$el.find("[data-forum-id]").each(function(){var $this=$(this),forum_id=$this.attr("data-forum-id"),newState=$this.is(":checked"),oldState=!!_.find(self.subscriptions,function(subscription){return subscription.forum_id==forum_id});if(newState!=oldState)changed[forum_id]=newState});var add_forum_ids=[],remove_forum_ids=[];for(var forum_id in changed){var state=changed[forum_id];if(state)add_forum_ids.push(forum_id);else remove_forum_ids.push(forum_id)}var data={add_forum_ids:add_forum_ids.join(),remove_forum_ids:remove_forum_ids.join()};self.model.api.post("forum/subscriptions",{data:data,message:{waiting:"Updating your subscriptions...",success:"Subscriptions updated!",error:"There was an error, please try again."}}).done(function(data){self.forum.set({_viewer_subscription:data})}),self.options.parent.trigger("close.subscribe")}});return view}),define("pages/forum/views/ForumHeaderView",["backbone","jquery","underscore","js/lib/util","js/lib/modals","pages/spark/app","pages/forum/views/ForumHeaderView.html","pages/forum/views/ForumSubscribeModalView"],function(Backbone,$,_,util,Modal,Coursera,ForumHeaderTemplate,ForumSubscribeModal){var view=Backbone.View.extend({events:{"click .course-forum-subscribe-link":"onSubscribeClick","click .course-forum-unsubscribe-link":"onUnsubscribeClick","click .course-forum-controls-popup a":"onMarkReadClick"},initialize:function(options){this.options=options,this.forum=this.model,this.forum.bind("change",this.render,this)},render:function(){var fields=["_viewer_subscription"],changedAttrs=this.forum.changedAttributes();if(!this.$(".course-forum-controls").length||changedAttrs&&_.intersection(_.keys(changedAttrs),fields).length>0)this.$el.html(ForumHeaderTemplate({forum:this.forum}));return this},onUnsubscribeClick:function(e){var self=this;Coursera.api["delete"](this.model.subscriptionsUrl(),{message:{waiting:"Unsubscribing...",success:"Unsubscribed!"}}).done(function(data){self.forum.set({_viewer_subscription:data})})},onSubscribeClick:function(e){var self=this,forumSubscribeModal=new ForumSubscribeModal({parent:self,model:self.model}),modal=new Modal(forumSubscribeModal.render().$el,{"overlay.class":"course-modal-overlay-dark"}).open();self.on("close.subscribe",function(){modal.close()})},onMarkReadClick:function(){var self=this;Coursera.api.post(this.model.readRecordsUrl(),{message:{waiting:"Marking as read...",success:"Done!"}}).done(function(data){self.forum.set({_marked_as_read:(new Date).getTime()})})}});return view}),define("js/lib/truncate",["jquery","underscore"],function($,_){function byLength(string,nMaxChars){if(!string)return"";if(string.length<=nMaxChars)return string;var xMaxFit=nMaxChars-3,xTruncateAt=string.lastIndexOf(" ",xMaxFit);if(-1==xTruncateAt||nMaxChars/2>xTruncateAt)xTruncateAt=xMaxFit;return string.substr(0,xTruncateAt)+"..."}function byUTF8Bytes(string,nMaxChars){var toBytesUTF8=function(chars){return unescape(encodeURIComponent(chars))},fromBytesUTF8=function(bytes){return decodeURIComponent(escape(bytes))};if(toBytesUTF8(string).length<=nMaxChars)return string;for(var nMaxFit=nMaxChars-3,bytes=toBytesUTF8(string).substring(0,nMaxFit);;){try{return fromBytesUTF8(bytes)+"..."}catch(e){}bytes=bytes.substring(0,bytes.length-1)}}function byElemText($el){var originalText=$el.text(),truncateChars=0,iteration=function(){if($el.prop("scrollHeight")>$el.height()+6)truncateChars+=1,$el.text(originalText.slice(0,originalText.length-truncateChars)),$el.append("&hellip;"),_.defer(iteration)};_.defer(iteration)}function byElemHtml($el){var originalText=$el.html(),truncateChars=0,iteration=function(){if($el.prop("scrollHeight")>$el.height()+6)truncateChars+=1,$el.html(originalText.slice(0,originalText.length-truncateChars)),$el.append("&nbsp;&hellip;"),_.defer(iteration)};_.defer(iteration)}return{byLength:byLength,byUTF8Bytes:byUTF8Bytes,byElemText:byElemText,byElemHtml:byElemHtml}}),!function(wndw){var jadify=function(jade,_t){_t="undefined"!=typeof _t?_t:function(key,interpolationHash){if("object"==typeof interpolationHash)return key.replace(/[#!]\{([^}]+?)\}/g,function(match,interpKey){return interpolationHash[interpKey]||interpKey});else return key};var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(forum,truncate){if(forum.get("subforums")&&forum.get("subforums").length>0)buf.push('<h3 class="hidden">Sub-forums</h3><table style="margin-bottom:25px;" class="table course-forum-forums-listing"><caption class="hidden"><h4>Sub-forums</h4></caption><thead><tr><th>Sub-forum</th><th width="30%">Latest Activity</th></tr></thead><tbody>'),function(){var $$obj=forum.get("subforums");if("number"==typeof $$obj.length)for(var $index=0,$$l=$$obj.length;$$l>$index;$index++){var subforum=$$obj[$index],popupId="course-forum-forums-subforum-"+subforum.id;if(buf.push('<tr><td><h5 style="margin:0px;"><a'+jade.attr("href",subforum.link,!0,!1)+' style="display:inline;" data-ab-user-convert-for="honorcode_to_welcome2" data-ab-user-convert="enter_forum">'+jade.escape(null==(jade_interp=subforum.name)?"":jade_interp)+"</a></h5><span>"+jade.escape(null==(jade_interp=subforum.description)?"":jade_interp)+'</span></td><td style="vertical-align:middle;">'),subforum.last_updated_time>-1)buf.push("<a"+jade.attr("href",subforum.last_updated_link,!0,!1)+">"+jade.escape(null==(jade_interp=truncate.byLength(subforum.last_updated_title,40))?"":jade_interp)+" </a>(<time"+jade.attr("datetime",subforum.last_updated_time,!0,!1)+"></time>)");else buf.push("None");buf.push("</td></tr>")}else{var $$l=0;for(var $index in $$obj){$$l++;var subforum=$$obj[$index],popupId="course-forum-forums-subforum-"+subforum.id;if(buf.push('<tr><td><h5 style="margin:0px;"><a'+jade.attr("href",subforum.link,!0,!1)+' style="display:inline;" data-ab-user-convert-for="honorcode_to_welcome2" data-ab-user-convert="enter_forum">'+jade.escape(null==(jade_interp=subforum.name)?"":jade_interp)+"</a></h5><span>"+jade.escape(null==(jade_interp=subforum.description)?"":jade_interp)+'</span></td><td style="vertical-align:middle;">'),subforum.last_updated_time>-1)buf.push("<a"+jade.attr("href",subforum.last_updated_link,!0,!1)+">"+jade.escape(null==(jade_interp=truncate.byLength(subforum.last_updated_title,40))?"":jade_interp)+" </a>(<time"+jade.attr("datetime",subforum.last_updated_time,!0,!1)+"></time>)");
else buf.push("None");buf.push("</td></tr>")}}}.call(this),buf.push("</tbody></table>")}("forum"in locals_for_with?locals_for_with.forum:"undefined"!=typeof forum?forum:void 0,"truncate"in locals_for_with?locals_for_with.truncate:"undefined"!=typeof truncate?truncate:void 0),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("pages/forum/views/ForumListView.html",["js/lib/jade"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["pages.forum.views.ForumListView"]=jadify(wndw.jade.helpers)}(window),define("pages/forum/views/ForumListView",["backbone","jquery","underscore","js/lib/util","js/lib/truncate","pages/spark/app","pages/forum/views/ForumListView.html"],function(Backbone,$,_,util,truncate,Coursera,ForumListTemplate){var view=Backbone.View.extend({className:"course-forum-subforums-listing",events:{},initialize:function(options){this.options=options,this.forum=this.model,this.forum.bind("sync",this.render,this)},render:function(){return this.$el.html(ForumListTemplate({truncate:truncate,forum:this.forum})),this.$el.find("time").each(function(){util.prettifyTime($(this))}),this}});return view}),!function(){var HashChangeEvent=function($,window,undefined){"$:nomunge";function get_fragment(url){return url=url||window[str_location][str_href],url.replace(/^[^#]*#?(.*)$/,"$1")}var fake_onhashchange,jq_event_special=$.event.special,str_location="location",str_hashchange="hashchange",str_href="href",browser=$.browser,mode=document.documentMode,is_old_ie=browser.msie&&(mode===undefined||8>mode),supports_onhashchange="on"+str_hashchange in window&&!is_old_ie;$[str_hashchange+"Delay"]=100,jq_event_special[str_hashchange]=$.extend(jq_event_special[str_hashchange],{setup:function(){if(supports_onhashchange)return!1;else return void $(fake_onhashchange.start)},teardown:function(){if(supports_onhashchange)return!1;else return void $(fake_onhashchange.stop)}}),fake_onhashchange=function(){function init(){if(set_history=get_history=function(val){return val},is_old_ie)iframe=$('<iframe src="javascript:0"/>').hide().insertAfter("body")[0].contentWindow,get_history=function(){return get_fragment(iframe.document[str_location][str_href])},(set_history=function(hash,history_hash){if(hash!==history_hash){var doc=iframe.document;doc.open().close(),doc[str_location].hash="#"+hash}})(get_fragment())}var self={},timeout_id,iframe,set_history,get_history;return self.start=function(){if(!timeout_id){var last_hash=get_fragment();set_history||init(),function loopy(){var hash=get_fragment(),history_hash=get_history(last_hash);if(hash!==last_hash)set_history(last_hash=hash,history_hash),$(window).trigger(str_hashchange);else if(history_hash!==last_hash)window[str_location][str_href]=window[str_location][str_href].replace(/#.*/,"")+"#"+history_hash;timeout_id=setTimeout(loopy,$[str_hashchange+"Delay"])}()}},self.stop=function(){if(!iframe)timeout_id&&clearTimeout(timeout_id),timeout_id=0},self}()};if("function"==typeof define&&define.amd)define("js/lib/jquery.hashchange",["jquery"],function(){return HashChangeEvent});else window.HashChangeEvent=HashChangeEvent(window.jQuery)}(),!function(){var jQueryBBQPlugin=function($,window){"$:nomunge";function is_string(arg){return"string"==typeof arg}function curry(func){var args=aps.call(arguments,1);return function(){return func.apply(this,args.concat(aps.call(arguments)))}}function get_fragment(url){return url.replace(/^[^#]*#?(.*)$/,"$1")}function get_querystring(url){return url.replace(/(?:^[^?#]*\?([^#]*).*$)?.*/,"$1")}function jq_param_sub(is_fragment,get_func,url,params,merge_mode){var result,qs,matches,url_params,hash;if(params!==undefined){if(matches=url.match(is_fragment?/^([^#]*)\#?(.*)$/:/^([^#?]*)\??([^#]*)(#?.*)/),hash=matches[3]||"",2===merge_mode&&is_string(params))qs=params.replace(is_fragment?re_trim_fragment:re_trim_querystring,"");else if(url_params=jq_deparam(matches[2]),params=is_string(params)?jq_deparam[is_fragment?str_fragment:str_querystring](params):params,qs=2===merge_mode?params:1===merge_mode?$.extend({},params,url_params):$.extend({},url_params,params),qs=jq_param(qs),is_fragment)qs=qs.replace(re_no_escape,decode);result=matches[1]+(is_fragment?"#":qs||!matches[1]?"?":"")+qs+hash}else result=get_func(url!==undefined?url:window[str_location][str_href]);return result}function jq_deparam_sub(is_fragment,url_or_params,coerce){if(url_or_params===undefined||"boolean"==typeof url_or_params)coerce=url_or_params,url_or_params=jq_param[is_fragment?str_fragment:str_querystring]();else url_or_params=is_string(url_or_params)?url_or_params.replace(is_fragment?re_trim_fragment:re_trim_querystring,""):url_or_params;return jq_deparam(url_or_params,coerce)}function jq_fn_sub(mode,force_attr,params,merge_mode){if(!is_string(params)&&"object"!=typeof params)merge_mode=params,params=force_attr,force_attr=undefined;return this.each(function(){var that=$(this),attr=force_attr||jq_elemUrlAttr()[(this.nodeName||"").toLowerCase()]||"",url=attr&&that.attr(attr)||"";that.attr(attr,jq_param[mode](url,params,merge_mode))})}var undefined,aps=Array.prototype.slice,decode=decodeURIComponent,jq_param=$.param,jq_param_fragment,jq_deparam,jq_deparam_fragment,jq_bbq=$.bbq=$.bbq||{},jq_bbq_pushState,jq_bbq_getState,jq_elemUrlAttr,jq_event_special=$.event.special,str_hashchange="hashchange",str_querystring="querystring",str_fragment="fragment",str_elemUrlAttr="elemUrlAttr",str_location="location",str_href="href",str_src="src",re_trim_querystring=/^.*\?|#.*$/g,re_trim_fragment=/^.*\#/,re_no_escape,elemUrlAttr_cache={};jq_param[str_querystring]=curry(jq_param_sub,0,get_querystring),jq_param[str_fragment]=jq_param_fragment=curry(jq_param_sub,1,get_fragment),jq_param_fragment.noEscape=function(chars){chars=chars||"";var arr=$.map(chars.split(""),encodeURIComponent);re_no_escape=new RegExp(arr.join("|"),"g")},jq_param_fragment.noEscape(",/"),$.deparam=jq_deparam=function(params,coerce){var obj={},coerce_types={"true":!0,"false":!1,"null":null};return $.each(params.replace(/\+/g," ").split("&"),function(j,v){var param=v.split("="),key=decode(param[0]),val,cur=obj,i=0,keys=key.split("]["),keys_last=keys.length-1;if(/\[/.test(keys[0])&&/\]$/.test(keys[keys_last]))keys[keys_last]=keys[keys_last].replace(/\]$/,""),keys=keys.shift().split("[").concat(keys),keys_last=keys.length-1;else keys_last=0;if(2===param.length){if(val=decode(param[1]),coerce)val=val&&!isNaN(val)?+val:"undefined"===val?undefined:coerce_types[val]!==undefined?coerce_types[val]:val;if(keys_last)for(;keys_last>=i;i++)key=""===keys[i]?cur.length:keys[i],cur=cur[key]=keys_last>i?cur[key]||(keys[i+1]&&isNaN(keys[i+1])?{}:[]):val;else if($.isArray(obj[key]))obj[key].push(val);else if(obj[key]!==undefined)obj[key]=[obj[key],val];else obj[key]=val}else if(key)obj[key]=coerce?undefined:""}),obj},jq_deparam[str_querystring]=curry(jq_deparam_sub,0),jq_deparam[str_fragment]=jq_deparam_fragment=curry(jq_deparam_sub,1),$[str_elemUrlAttr]||($[str_elemUrlAttr]=function(obj){return $.extend(elemUrlAttr_cache,obj)})({a:str_href,base:str_href,iframe:str_src,img:str_src,input:str_src,form:"action",link:str_href,script:str_src}),jq_elemUrlAttr=$[str_elemUrlAttr],$.fn[str_querystring]=curry(jq_fn_sub,str_querystring),$.fn[str_fragment]=curry(jq_fn_sub,str_fragment),jq_bbq.pushState=jq_bbq_pushState=function(params,merge_mode){if(is_string(params)&&/^#/.test(params)&&merge_mode===undefined)merge_mode=2;var has_args=params!==undefined,url=jq_param_fragment(window[str_location][str_href],has_args?params:{},has_args?merge_mode:2);window[str_location][str_href]=url+(/#/.test(url)?"":"#")},jq_bbq.getState=jq_bbq_getState=function(key,coerce){return key===undefined||"boolean"==typeof key?jq_deparam_fragment(key):jq_deparam_fragment(coerce)[key]},jq_bbq.removeState=function(arr){var state={};if(arr!==undefined)state=jq_bbq_getState(),$.each($.isArray(arr)?arr:arguments,function(i,v){delete state[v]});jq_bbq_pushState(state,2)},jq_event_special[str_hashchange]=$.extend(jq_event_special[str_hashchange],{add:function(handleObj){function new_handler(e){var hash=e[str_fragment]=jq_param_fragment();e.getState=function(key,coerce){return key===undefined||"boolean"==typeof key?jq_deparam(hash,key):jq_deparam(hash,coerce)[key]},old_handler.apply(this,arguments)}var old_handler;if($.isFunction(handleObj))return old_handler=handleObj,new_handler;else old_handler=handleObj.handler,handleObj.handler=new_handler}})};if("function"==typeof define&&define.amd)define("js/lib/jquery.bbq",["jquery","js/lib/jquery.hashchange"],function($){jQueryBBQPlugin($,window)});else jQueryBBQPlugin(window.$,window)}(),define("js/lib/WidgetView",["backbone","jquery","underscore","js/lib/util","js/lib/jquery.bbq"],function(Backbone,$,_,util,bbq){var WIDGET_INFIX="-state-",WidgetView=Backbone.View.extend({initialize:function(options){this.options=options},getWidgetId:function(){return this.widgetId=this.widgetId||this.options.widgetId||_.uniqueId(),this.widgetId},getWidgetKey:function(key){return this.getWidgetId()+WIDGET_INFIX+key},addWidgetStateListener:function(){function getHashParams(url){if(url.indexOf("#")>-1){var params=$.deparam(url.split("#")[1]);return _.each(params,function(value,key){if(-1==key.indexOf(self.getWidgetId()+WIDGET_INFIX))delete params[key]}),params}return{}}var self=this,oldURL=window.location.href,newURL;$(window).bind("hashchange",function(e){newURL=window.location.href;var oldParams=getHashParams(oldURL),newParams=getHashParams(newURL),changedParams=[];_.each(newParams,function(value,key){if(oldParams[key]&&oldParams[key]!==value)changedParams.push(key)}),changedParams=_.union(changedParams,_.difference(_.keys(newParams),_.keys(oldParams))),changedParams=_.map(changedParams,function(key){return key.split(WIDGET_INFIX)[1]}),self.trigger("widget:changed",changedParams),oldURL=window.location.href})},getWidgetState:function(key){return $.bbq.getState(this.getWidgetKey(key))},changeWidgetState:function(params){var self=this,state={};_.each(params,function(value,key){state[self.getWidgetKey(key)]=value}),$.bbq.pushState(state)}});return WidgetView}),!function(wndw){var jadify=function(jade,_t){var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(forumThreads,threads,showSortControls,showNewThread,newThreadProblem,newThreadLink,reportLink,user,showMore,maxDisplayed,showEmptyMessage){var currentPage=forumThreads.get("current_page"),maxPages=forumThreads.get("max_pages");if(forumThreads.get("total_threads")>0){if(buf.push('<div class="course-forum-threads-listing"><table class="table"><caption style="min-height:42px;">'),threads.length>0&&showSortControls)buf.push('<ul class="course-forum-threads-sort nav nav-pills pull-right"><li data-sort-name="topquestions"><a href="javascript:void(0)">Top threads</a></li><li data-sort-name="lastupdated"><a href="javascript:void(0)">Last updated</a></li><li data-sort-name="firstposted"><a href="javascript:void(0)">Last created</a></li></ul>');if(forumThreads.get("tag_name"))buf.push("<h4>Threads tagged with: "+jade.escape(null==(jade_interp=forumThreads.get("tag_name"))?"":jade_interp)+"</h4>");else if("subscribed"==forumThreads.get("sort"))buf.push("<h4>Your Subscribed Threads</h4>");else{if(buf.push("<h4>All Threads"),currentPage>1)buf.push("<small> (Page\n"+jade.escape(null==(jade_interp=currentPage)?"":jade_interp)+"\nof\n"+jade.escape(null==(jade_interp=maxPages)?"":jade_interp)+"\n)</small>");buf.push("</h4>")}if(showNewThread)if(newThreadProblem)buf.push("<a"+jade.attr("href",newThreadLink,!0,!1)+' class="btn btn-small course-forum-threads-new-button">Visit help center</a><a'+jade.attr("href",reportLink,!0,!1)+' class="btn btn-small course-forum-threads-report-button">Report issue</a>');else buf.push("<a"+jade.attr("href",newThreadLink,!0,!1)+' class="btn btn-small course-forum-threads-new-button">Start new thread</a>');if(buf.push('</caption><thead class="hidden"><tr><th><h5 class="hidden">Thread title and author</h5></th><th><h5 class="hidden">Number of points</h5></th><th><h5 class="hidden">Number of posts</h5></th><th><h5 class="hidden">Number of views</h5></th></tr></thead><tbody>'),threads.each(function(thread,num){var spamClass=1==thread.get("is_spam")&&user.canModerateForum()?"course-forum-threads-listing-spam":"";buf.push("<tr"+jade.attr("style",showMore&&num>=maxDisplayed?"display:none;":"",!0,!1)+jade.cls(["course-forum-threads-listing-row",spamClass],[null,!0])+"><td>");var readClass=!thread.get("_viewer_read")?"course-forum-threads-listing-unread":"";if(buf.push('<div style="font-size:16px;"'+jade.cls([readClass],[!0])+">"),1==thread.get("approved"))buf.push('<span title="Approved by staff" class="icon-thumbs-up"></span><span class="hidden">Approved</span>&nbsp;');if(thread.isResolved())buf.push('<span title="Resolved" class="icon-check"></span><span class="hidden">Resolved</span>&nbsp;');if(thread.isUnresolved())buf.push('<span title="Unresolved" class="icon-question-sign"></span><span class="hidden">Unresolved</span>&nbsp;');if(1==thread.get("stickied"))buf.push('<span title="Pinned by staff" class="icon-pushpin"></span><span class="hidden">Pinned</span>&nbsp;');if(1==thread.get("private"))buf.push('<span title="This is a private thread. Only the author and forum moderators can see and respond." class="icon-key"></span><span class="hidden">This is a private thread. Only the author and forum moderators can see and respond.</span>&nbsp;');if(buf.push("<a"+jade.attr("href",thread.get("_link"),!0,!1)+"><span>"+jade.escape(null==(jade_interp=thread.get("title"))?"":jade_interp)+"</span>"),!thread.get("_viewer_read"))buf.push('<span class="hidden"> (Un-read)</span>');if(buf.push('</a></div><div style="opacity:.8">'),1==thread.get("instructor_replied"))buf.push('<span class="course-forum-profile-badge">Staff Replied</span><span> &middot; </span>');buf.push("<span>Started by ");var author=thread.get("_starter");if(author.is_anonymous)buf.push("<span>Anonymous</span>");else{if(buf.push("<a"+jade.attr("href",author._user_profile_link,!0,!1)+">"),author._user_profile){if(author._user_profile.photo_24)buf.push("<img"+jade.attr("src",author._user_profile.photo_24,!0,!1)+' alt=""/>');buf.push(""+jade.escape(null==(jade_interp=author._user_profile.display_name)?"":jade_interp)+" ")}else buf.push(""+jade.escape(null==(jade_interp=author.full_name)?"":jade_interp)+" ");buf.push("</a>")}if(-1!=author.id&&author.forum_title&&"Student"!=author.forum_title)buf.push('<span class="course-forum-profile-badge">'+jade.escape(null==(jade_interp=author.forum_title)?"":jade_interp)+"</span>");buf.push("</span><span> &middot; </span><span>Last post by ");var author=thread.get("_last_poster");if(author.is_anonymous)buf.push("<span>Anonymous</span>");else{if(buf.push("<a"+jade.attr("href",author._user_profile_link,!0,!1)+">"),author._user_profile){if(author._user_profile.photo_24)buf.push("<img"+jade.attr("src",author._user_profile.photo_24,!0,!1)+' alt=""/>');buf.push(""+jade.escape(null==(jade_interp=author._user_profile.display_name)?"":jade_interp)+" ")}else buf.push(""+jade.escape(null==(jade_interp=author.full_name)?"":jade_interp)+" ");buf.push("</a>")}if(-1!=author.id&&author.forum_title&&"Student"!=author.forum_title)buf.push('<span class="course-forum-profile-badge">'+jade.escape(null==(jade_interp=author.forum_title)?"":jade_interp)+"</span>");buf.push("</span> (<time"+jade.attr("datetime",thread.get("last_updated_time"),!0,!1)+"></time>)</div><div></div></td><td"+jade.cls(["course-forum-stat",thread.get("votes")>0?"course-forum-stat-important":""],[null,!0])+"><span>"+jade.escape(null==(jade_interp=thread.get("votes"))?"":jade_interp)+"</span><br/> "+jade.escape(null==(jade_interp=1==thread.get("votes")?"point":"points")?"":jade_interp)+"</td><td"+jade.cls(["course-forum-stat",thread.get("num_posts")>0?"course-forum-stat-important":""],[null,!0])+"><span>"+jade.escape(null==(jade_interp=thread.get("num_posts"))?"":jade_interp)+"</span><br/> "+jade.escape(null==(jade_interp=1==thread.get("num_posts")?"post":"posts")?"":jade_interp)+'</td><td class="course-forum-stat"><span>'+jade.escape(null==(jade_interp=thread.get("num_views"))?"":jade_interp)+"</span><br/> "+jade.escape(null==(jade_interp=1==thread.get("num_views")?"view":"views")?"":jade_interp)+"</td></tr>")}),buf.push("</tbody></table>"),showMore)buf.push('<a class="course-forum-thread-showmore btn">Show More <span class="icon-double-angle-down"></span></a>');if(maxPages>1){if(buf.push("<div"+jade.attr("style",showMore?"display:none;":"",!0,!1)+' class="pagination course-forum-thread-paginator"><ul>'),currentPage>1)buf.push('<li class="prev"><a href="javascript:void(0);"'+jade.attr("data-page-num",currentPage-1,!0,!1)+">&larr; Previous</a></li>");for(var displayedDots=!1,i=1;currentPage>i;i++)if(i>2&&currentPage-2>i){if(!displayedDots)displayedDots=!0,buf.push('<li><a href="javascript:void(0);">...</a></li>')}else buf.push('<li><a href="javascript:void(0);"'+jade.attr("data-page-num",i,!0,!1)+">"+jade.escape(null==(jade_interp=i)?"":jade_interp)+"</a></li>");buf.push('<li class="active"><a href="javascript:void(0);">'+jade.escape(null==(jade_interp=currentPage)?"":jade_interp)+"</a></li>");for(var displayedDots=!1,i=currentPage+1;maxPages>=i;i++)if(i>currentPage+2&&maxPages-1>i){if(!displayedDots)displayedDots=!0,buf.push('<li><a href="javascript:void(0);">...</a></li>')}else buf.push('<li><a href="javascript:void(0);"'+jade.attr("data-page-num",i,!0,!1)+">"+jade.escape(null==(jade_interp=i)?"":jade_interp)+"</a></li>");if(maxPages>currentPage)buf.push('<li class="prev"><a href="javascript:void(0);"'+jade.attr("data-page-num",currentPage+1,!0,!1)+">&rarr; Next</a></li>");buf.push("</ul></div>")}buf.push("</div>")}else if(0==forumThreads.get("total_threads")){if(showEmptyMessage){if(forumThreads.get("tag_name"))buf.push("<h4>Threads tagged with: "+jade.escape(null==(jade_interp=forumThreads.get("tag_name"))?"":jade_interp)+"</h4>");if(showNewThread){if(buf.push("<p>There's nothing here yet, you can be the first!</p>"),newThreadProblem)buf.push("<a"+jade.attr("href",newThreadLink,!0,!1)+' class="btn course-forum-threads-new-button">Visit help center</a><span> or </span><a'+jade.attr("href",reportLink,!0,!1)+' class="btn course-forum-threads-report-button">Report issue</a>');else buf.push("<a"+jade.attr("href",newThreadLink,!0,!1)+' class="btn course-forum-threads-new-button">Start new thread</a>');buf.push("<br/><br/>")}else buf.push("<p>There's nothing here yet. Sorry! ☹</p>")}}else buf.push("<p>Loading...</p>")}("forumThreads"in locals_for_with?locals_for_with.forumThreads:"undefined"!=typeof forumThreads?forumThreads:void 0,"threads"in locals_for_with?locals_for_with.threads:"undefined"!=typeof threads?threads:void 0,"showSortControls"in locals_for_with?locals_for_with.showSortControls:"undefined"!=typeof showSortControls?showSortControls:void 0,"showNewThread"in locals_for_with?locals_for_with.showNewThread:"undefined"!=typeof showNewThread?showNewThread:void 0,"newThreadProblem"in locals_for_with?locals_for_with.newThreadProblem:"undefined"!=typeof newThreadProblem?newThreadProblem:void 0,"newThreadLink"in locals_for_with?locals_for_with.newThreadLink:"undefined"!=typeof newThreadLink?newThreadLink:void 0,"reportLink"in locals_for_with?locals_for_with.reportLink:"undefined"!=typeof reportLink?reportLink:void 0,"user"in locals_for_with?locals_for_with.user:"undefined"!=typeof user?user:void 0,"showMore"in locals_for_with?locals_for_with.showMore:"undefined"!=typeof showMore?showMore:void 0,"maxDisplayed"in locals_for_with?locals_for_with.maxDisplayed:"undefined"!=typeof maxDisplayed?maxDisplayed:void 0,"showEmptyMessage"in locals_for_with?locals_for_with.showEmptyMessage:"undefined"!=typeof showEmptyMessage?showEmptyMessage:void 0),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("pages/forum/views/ForumThreadsView.html",["js/lib/jade"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["pages.forum.views.ForumThreadsView"]=jadify(wndw.jade.helpers)}(window),define("pages/forum/views/ForumThreadsView",["backbone","jquery","underscore","js/lib/util","js/lib/jquery.bbq","js/lib/WidgetView","pages/spark/app","pages/forum/views/ForumThreadsView.html"],function(Backbone,$,_,util,bbq,WidgetView,Coursera,ForumThreadsTemplate){var view=WidgetView.extend({events:{"click .course-forum-thread-paginator":"onPageClick","click .course-forum-thread-showmore":"onShowMoreClick","click .course-forum-threads-sort li a":"onSortClick"},initialize:function(options){var self=this;if(this.options=options,this.forum=this.model,this.forumThreads=this.options.threads,this.showNewThread=!_.isUndefined(this.options.showNewThread)?this.options.showNewThread:!1,this.showSortControls=!_.isUndefined(this.options.showSortControls)?this.options.showSortControls:!0,this.maxDisplayed=!_.isUndefined(this.options.maxDisplayed)?this.options.maxDisplayed:this.forumThreads.get("page_size"),this.showEmptyMessage=!_.isUndefined(this.options.showEmptyMessage)?this.options.showEmptyMessage:!0,this.mode=this.options.mode||"widget",this.getWidgetState("sort"))this.forumThreads.set("sort",this.getWidgetState("sort"),{silent:!0});this.forum.bind("change",this.onForumChange,this),this.forumThreads.bind("change",this.onThreadsChange,this);var pageNum=this.getWidgetState("page_num")||1;this.forumThreads.loadPage(pageNum),self.addWidgetStateListener(),self.bind("widget:changed",function(changedParams){if(_.contains(changedParams,"sort"))self.changeSort(self.getWidgetState("sort"));if(_.contains(changedParams,"page_num"))self.changePage(self.getWidgetState("page_num"))})},onForumChange:function(e){if(this.forum.changedAttributes()&&this.forum.changedAttributes()._marked_as_read)this.forumThreads.get("threads").each(function(thread){thread.set("_viewer_read",!0,{silent:!0})}),this.render();if(this.forum.changedAttributes()&&this.forum.changedAttributes()._new_thread_link)this.render()},onThreadsChange:function(){this.render()},render:function(){function selectItem($item){$item.parent("ul").remove(".course-forum-threads-sort-selected-marker"),$item.parent("ul").find("li").removeClass("active"),$item.addClass("active"),$item.append($("<span>").addClass("course-forum-threads-sort-selected-marker").append("(selected)"))}var self=this,reportLink="/"+Coursera.course.get("sessionName")+"/help/report",isMoocSupportForum="430"==this.forum.get("course_id"),showMore=1==this.forumThreads.get("current_page")&&this.forumThreads.get("page_size")>this.maxDisplayed&&this.forumThreads.get("threads").size()>this.maxDisplayed,showNewThreadThisTime=this.showNewThread;if(this.forum.get("_new_thread_link")){if(showNewThreadThisTime=this.showNewThread&&-1!=this.forum.get("parent_id")&&(this.forum.get("can_post")||Coursera.user.canModerateForum()),this.newThreadLink=this.forum.get("_new_thread_link"),this.forumThreads.get("tag_name"))this.newThreadLink=util.changeUrlParam(this.newThreadLink,"tag_name",this.forumThreads.get("tag_name"));if(_.contains([1e4,10001,10002],this.forum.get("id")))if(this.newThreadProblem=!0,isMoocSupportForum)this.newThreadLink=window.location.origin+"/mooc/help/report"}else showNewThreadThisTime=!1;if(!isMoocSupportForum){switch(this.forum.get("id")){case 10002:reportLink="/"+Coursera.course.get("sessionName")+"/help/report/flag-overview";break;case 1e4:reportLink="/"+Coursera.course.get("sessionName")+"/help/report/pages-mistake"}var url=util.getUrlParam(window.location.href,"url");if(url)reportLink=util.changeUrlParam(reportLink,"url",encodeURIComponent(decodeURIComponent(url)))}this.$el.html(ForumThreadsTemplate({user:Coursera.user,forumThreads:this.forumThreads,threads:this.forumThreads.get("threads"),newThreadLink:this.newThreadLink,reportLink:reportLink,newThreadProblem:this.newThreadProblem,showNewThread:showNewThreadThisTime,showSortControls:this.showSortControls,showMore:showMore,maxDisplayed:this.maxDisplayed,showEmptyMessage:this.showEmptyMessage})),this.$el.find("time").each(function(){util.prettifyTime($(this))});var activeSortButton=null,$sorts=self.$(".course-forum-threads-sort li");return $sorts.each(function(index,el){var $el=self.$(el);if($el.attr("data-sort-name")===self.forumThreads.get("sort"))selectItem($el),activeSortButton=$el}),this},onShowMoreClick:function(e){this.$(".course-forum-thread-paginator").show(),this.$(".course-forum-threads-listing-row").show(),this.$(".course-forum-thread-showmore").hide()},onPageClick:function(e){this.changeWidgetState({page_num:$(e.target).attr("data-page-num")})},onSortClick:function(e){this.changeWidgetState({page_num:1,sort:$(e.target).parent().attr("data-sort-name")})},changePage:function(pageNum){var self=this;self.forumThreads.loadPage(pageNum).done(function(){$("html,body").scrollTop(self.$el.position().top)})},changeSort:function(sort){this.forumThreads.set("sort",sort),this.forumThreads.loadPage(1)}});return view}),define("pages/forum/views/ForumView",["backbone","jquery","underscore","js/lib/util","js/lib/popups","pages/spark/app","pages/forum/views/ForumView.html","pages/forum/views/ForumCrumbsView.html","pages/forum/views/ForumHeaderView","pages/forum/views/ForumListView","pages/forum/views/ForumThreadsView","pages/forum/models/ForumThreadsModel","js/lib/badgeville"],function(Backbone,$,_,util,Popup,Coursera,ForumTemplate,ForumCrumbsTemplate,ForumHeaderView,ForumListView,ForumThreadsView,ForumThreadsModel,BadgevilleUtil){var TRACKER_LABEL="Forum",view=Backbone.View.extend({events:{"click .course-forum-description a[href*=forum-code-of-conduct]":"onConductClick"},initialize:function(options){this.options=options,this.forum=this.model,this.forum.bind("change",this.render,this),this.forum.read(),this.mode=this.options.mode||"widget"},render:function(){var self=this;if(!self.$(".course-forum-header").length){if(self.$el.html(ForumTemplate({reporterLink:self.forum.get("_reporter_link")+"?url="+encodeURIComponent(window.location.href),forum:self.forum,config:Coursera.config})),BadgevilleUtil.isEnabled())self.$(".course-forum-reputations-link").hide();if(self.$(".course-forum-crumbs").html(ForumCrumbsTemplate({_:_,crumbs:_.initial(self.forum.get("crumbs")||[])})),self.$(".course-forum-header-wrapper").html(new ForumHeaderView({model:this.forum}).render().el),self.$(".course-forum-subforums-listing-wrapper").html(new ForumListView({model:this.forum}).render().el),"1"==this.forum.get("show_threads")||-1==this.forum.get("parent_id"))self.$(".course-forum-your-threads-listing-wrapper").append(new ForumThreadsView({model:this.forum,threads:new ForumThreadsModel({id:this.forum.get("id"),course_id:this.forum.get("course_id"),sort:"subscribed"}),showNewThread:!1,mode:this.mode,showSortControls:!1,maxDisplayed:3,showEmptyMessage:!1,widgetId:"forum-threads-subscribed-"+this.forum.get("id")}).render().el),self.$(".course-forum-threads-listing-wrapper").append(new ForumThreadsView({model:this.forum,threads:new ForumThreadsModel({id:this.forum.get("id"),course_id:this.forum.get("course_id")}),showNewThread:!0,mode:this.mode,showSortControls:!0,widgetId:"forum-threads-all-"+this.forum.get("id")}).render().el)}},onConductClick:function(){Coursera.multitracker.push([TRACKER_LABEL,"Click code of conduct"])}});return view}),!function(wndw){var jadify=function(jade,_t){var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(threads,user){buf.push('<div class="course-forum-threads-listing"><table><caption><h4 style="text-align: left;" class="hidden">Threads</h4></caption><thead class="hidden"><tr><th><h5>Thread title</h5></th></tr></thead><tbody><tr><td><ul style="list-style:none;margin:0px;">'),threads.each(function(thread){var spamClass=1==thread.get("is_spam")&&user.canModerateForum()?"course-forum-threads-listing-spam":"";buf.push('<li style="margin-bottom:15px;"'+jade.cls([spamClass],[!0])+">");var readClass=!thread.get("_viewer_read")?"course-forum-threads-listing-unread":"";if(buf.push('<div style="font-size: 14px; line-height: 16px; margin-bottom: 3px;"'+jade.cls([readClass],[!0])+"><a"+jade.attr("href",thread.get("_link"),!0,!1)+"><span>"+jade.escape(null==(jade_interp=thread.get("title"))?"":jade_interp)+"</span>"),!thread.get("_viewer_read"))buf.push('<span class="hidden"> (Un-read)</span>');buf.push('</a></div><div style="opacity:.8; opacity: .8; font-size: 11px; margin-bottom: 6px; line-height: 13px;"><span>Last post by ');var author=thread.get("_last_poster");if(author.is_anonymous)buf.push("<span>Anonymous</span>");else{if(buf.push("<a"+jade.attr("href",author._user_profile_link,!0,!1)+">"),author._user_profile){if(author._user_profile.photo_24)buf.push("<img"+jade.attr("src",author._user_profile.photo_24,!0,!1)+' alt=""/>');buf.push(""+jade.escape(null==(jade_interp=author._user_profile.display_name)?"":jade_interp)+" ")}else buf.push(""+jade.escape(null==(jade_interp=author.full_name)?"":jade_interp)+" ");buf.push("</a>")}if(-1!=author.id&&author.forum_title&&"Student"!=author.forum_title)buf.push('<span class="course-forum-profile-badge">'+jade.escape(null==(jade_interp=author.forum_title)?"":jade_interp)+"</span>");buf.push("</span> (<time"+jade.attr("datetime",thread.get("last_updated_time"),!0,!1)+"></time>)</div></li>")}),buf.push("</ul></td></tr></tbody></table></div>")}("threads"in locals_for_with?locals_for_with.threads:"undefined"!=typeof threads?threads:void 0,"user"in locals_for_with?locals_for_with.user:"undefined"!=typeof user?user:void 0),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("pages/forum/views/ForumThreadsMiniView.html",["js/lib/jade"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["pages.forum.views.ForumThreadsMiniView"]=jadify(wndw.jade.helpers)}(window),define("pages/forum/views/ForumThreadsMiniView",["backbone","jquery","underscore","js/lib/util","pages/spark/app","pages/forum/views/ForumThreadsMiniView.html"],function(Backbone,$,_,util,Coursera,ForumThreadsMiniTemplate){var view=Backbone.View.extend({events:{},initialize:function(options){this.forumThreads=this.model,this.forumThreads.bind("change",this.render,this),this.forumThreads.loadPage(1),this.options=options},render:function(){var self=this;return this.$el.html(ForumThreadsMiniTemplate({user:Coursera.user,threads:this.forumThreads.get("threads")})),this.$el.find("time").each(function(){util.prettifyTime($(this))}),this}});return view}),!function(wndw){var jadify=function(jade,_t){var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(reputations,user,Math){buf.push('<h2 class="course-page-header">Forum Reputations</h2><br/><table class="table table-bordered table-striped"><thead><tr><th style="width:60%">Name</th><th style="width:10%">Threads</th><th style="width:10%">Posts/Comments</th><th style="width:10%" colspan="2">Upvoted/Downvoted</th><th style="width:10%">Points</th></tr></thead><tbody>'),reputations.each(function(reputableUser){buf.push("<tr><td>");var author=reputableUser.toJSON();if(author.is_anonymous)buf.push("<span>Anonymous</span>");else{if(buf.push("<a"+jade.attr("href",author._user_profile_link,!0,!1)+">"),author._user_profile){if(author._user_profile.photo_24)buf.push("<img"+jade.attr("src",author._user_profile.photo_24,!0,!1)+' alt=""/>');buf.push(""+jade.escape(null==(jade_interp=author._user_profile.display_name)?"":jade_interp)+" ")}else buf.push(""+jade.escape(null==(jade_interp=author.full_name)?"":jade_interp)+" ");buf.push("</a>")}if(-1!=author.id&&author.forum_title&&"Student"!=author.forum_title)buf.push('<span class="course-forum-profile-badge">'+jade.escape(null==(jade_interp=author.forum_title)?"":jade_interp)+"</span>");
if(user.canAccessAdmin())buf.push(' (<a target="_blank"'+jade.attr("href",reputableUser.get("_user_details_link"),!0,!1)+">View Grades</a>)");buf.push("</td><td>"+jade.escape(null==(jade_interp=reputableUser.get("thread_count"))?"":jade_interp)+"</td><td>"+jade.escape(null==(jade_interp=reputableUser.get("entry_count"))?"":jade_interp)+'</td><td style="color:green;font-weight:bold;text-align:right;"><span>'+jade.escape(null==(jade_interp=reputableUser.get("upvote_count"))?"":jade_interp)+'</span></td><td style="text-align:left;color:#DB7676;"><span>'+jade.escape(null==(jade_interp=Math.abs(reputableUser.get("downvote_count")))?"":jade_interp)+"</span></td><td>"+jade.escape(null==(jade_interp=reputableUser.get("points"))?"":jade_interp)+"</td></tr>")}),buf.push("</tbody></table><br/><p>*Forum points are awarded based on the sum of the square root of all the votes received for each post.</p>")}("reputations"in locals_for_with?locals_for_with.reputations:"undefined"!=typeof reputations?reputations:void 0,"user"in locals_for_with?locals_for_with.user:"undefined"!=typeof user?user:void 0,"Math"in locals_for_with?locals_for_with.Math:"undefined"!=typeof Math?Math:void 0),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("pages/forum/views/ForumReputationsView.html",["js/lib/jade"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["pages.forum.views.ForumReputationsView"]=jadify(wndw.jade.helpers)}(window),define("pages/forum/views/ForumReputationsView",["backbone","jquery","underscore","js/lib/util","pages/spark/app","pages/forum/views/ForumReputationsView.html"],function(Backbone,$,_,util,Coursera,ForumReputationsTemplate){var view=Backbone.View.extend({events:{},initialize:function(options){var that=this;this.options=options,this.reputations=this.collection,this.reputations.bind("reset",this.render,this),this.reputationsPromise=this.reputations.read()},render:function(){var self=this;return this.reputationsPromise.done(function(){self.$el.html(ForumReputationsTemplate({user:Coursera.user,reputations:self.reputations}))}),this}});return view}),define("pages/course-search/models/SearchResultModel",["underscore","backbone","pages/spark/app","js/lib/util","js/lib/moment","js/lib/backbone.api","backbone.relational","js/lib/marked"],function(_,Backbone,Coursera,util,moment,BackboneModelAPI,BackboneRelational,Marked){var ICON_TYPES={forumpost:"comments",forumcomment:"comments",assignment:"edit",humangrading:"edit",quiz:"edit",announcement:"bullhorn",lecturesubtitle:"youtube-play",wikipage:"file-text"},MAX_HEIGHT=42,BEFORE_CHARS=30,AFTER_CHARS=120,CLIP_CHARS=180,model=Backbone.Model.extend({api:Coursera.api,idAttribute:"generatedId",getHighlightedTitle:function(){if(this.get("title"))return this.highlight(this.get("title"),this.get("query"));else return"Untitled"},getTruncatedContent:function(){var content=this.get("content");if(content.length>CLIP_CHARS)content=content.substring(0,CLIP_CHARS);return content},getRelevantContentFor:function(query){var content=this.get("content"),queryRegex=new RegExp("\\b("+query+"s?)\\b","ig"),slice="",result=null,match=queryRegex.exec(content);if(match){var start=Math.max(0,match.index-BEFORE_CHARS),end=Math.min(content.length,match.index+query.length+AFTER_CHARS);if(slice=content.slice(start,end).trim(),start>0)slice="&hellip; "+slice.replace(/[^\s]+/i,"");if(end<content.length&&end>match.index+query.length){var lastSpace=slice.lastIndexOf(" ");slice=slice.substring(0,lastSpace).trim();var lastChar=slice[slice.length-1];if(-1===lastChar.search(/[\.\?!]/))slice+=" &hellip;"}return slice}},getRelevantContent:function(){var itemType=this.get("itemType");if("quiz"===itemType||"humangrading"===itemType||"assignment"===itemType)return"";if("lecturesubtitle"===itemType)return this.getLectureSnippets();var content=this.get("content"),query=this.get("query"),result="";if(result=this.getRelevantContentFor(query))return this.highlight(result,query);var words=query.split(" ");if(words.length>1)for(var i=0;i<words.length;++i)if(result=this.getRelevantContentFor(words[i]))return this.highlight(result,query);return this.getTruncatedContent()},getLectureSnippets:function(){var content=this.get("content"),srtRegex=/\d+\s(\d\d:\d\d:\d\d),[\d]+\s-->\s[\d,:]+\s(.+?)\s\s\s/gi,results="",query=this.get("query"),queryRegex=new RegExp("\\b("+query+"s?)\\b","ig"),numMatches=0,match;do if(match=srtRegex.exec(content)){var timestamp=match[1],text="&hellip;"+match[2];if(queryRegex.exec(text)){if("."!==text[text.length-1])text+="&hellip;";var seconds=60*parseInt(timestamp.substr(3,5),10)+parseInt(timestamp.substr(6,8),10);if("00:0"==timestamp.substr(0,4))timestamp=timestamp.substring(4);else if("00"==timestamp.substr(0,2))timestamp=timestamp.substring(3);else seconds+=3600*parseInt(timestamp.substr(0,2),10);var timestampLink='<a href="'+this.getURL()+"?seekto="+seconds+'">'+timestamp+"</a>",snippet='<span class="timestamp-link">'+timestampLink+" – "+text+"</span>";results+=this.highlight(snippet,query),++numMatches}}while(2>numMatches&&match);return results},highlight:function(content,query){for(var words=query.split(" "),i=0;i<words.length;++i){var queryRegex=new RegExp("\\b("+words[i]+"s?)\\b","ig");content=content.replace(queryRegex,"<mark>$1</mark>")}return content},getIconType:function(){return ICON_TYPES[this.get("itemType")]},hasAdditionalInfo:function(){var itemType=this.get("itemType");if("forumpost"==itemType||"forumcomment"==itemType||"announcement"==itemType)return!0;else return!1},getTimePosted:function(){return moment.unix(this.get("created")).format("MMMM Do[,] YYYY")},getAuthor:function(){var root=util.extractFirstSubdir(window.location.href);return'<a href="'+root+"forum/profile?user_id="+this.get("userId")+'">'+this.get("userFullName")+"</a>"},getURL:function(){var root=util.extractFirstSubdir(window.location.href);switch(this.get("itemType")){case"forumpost":return root+"forum/thread?thread_id="+this.get("parentId")+"#post-"+this.get("id");case"forumcomment":return root+"forum/thread?thread_id="+this.get("parentId")+"#comment-"+this.get("id");case"assignment":return root+"assignment/view?assignment_id="+this.get("id");case"humangrading":return root+"human_grading";case"quiz":return root+"quiz/start?quiz_id="+this.get("id");case"announcement":return root+"class/index#announcement-"+this.get("id");case"lecturesubtitle":return root+"lecture/"+this.get("id");case"wikipage":return root+"wiki/view?page="+this.get("id")}return root+"class/index"}});return _.extend(model.prototype,BackboneModelAPI),model}),!function(wndw){var jadify=function(jade,_t){_t="undefined"!=typeof _t?_t:function(key,interpolationHash){if("object"==typeof interpolationHash)return key.replace(/[#!]\{([^}]+?)\}/g,function(match,interpKey){return interpolationHash[interpKey]||interpKey});else return key};var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(query,elements,total,maxPages,currentPage){if(buf.push('<div class="input-append course-search-box"><form method="get" data-js-search-form="data-js-search-form" class="form-inline"><label for="coursera-nav-search-bar" style="display:none;">Search for lecture</label><input id="coursera-nav-search-bar" type="text" name="q"'+jade.attr("value",query,!0,!1)+' data-js-search-input="data-js-search-input"/>&nbsp;<button type="submit" class="btn">Search</button></form></div>'),query&&elements.size()>0){if(buf.push('<div data-js-search-results="data-js-search-results" class="course-search-num-results">Found '),elements.size()>=100)buf.push("about");if(buf.push("<strong>"+jade.escape(null==(jade_interp=total)?"":jade_interp)+"</strong> result(s) for '"+jade.escape(null==(jade_interp=query)?"":jade_interp)+'\'</div><div data-js-search-filters="data-js-search-filters" class="course-search-filters"><div data-filter="all">All results</div><div data-filter="courseContent">Course Content</div><div data-filter="discussions">Discussions</div></div><div data-js-search-entries="data-js-search-entries">'),elements.each(function(element){if(buf.push('<div data-js-search-entry="data-js-search-entry" class="course-search-result-container"><i'+jade.cls(["course-search-result-icon","icon-2x","icon-"+element.getIconType()],[null,null,!0])+"></i><a"+jade.attr("href",element.getURL(),!0,!1)+'><h3 class="course-search-result-header">'+(null==(jade_interp=element.getHighlightedTitle())?"":jade_interp)+'</h3></a><p class="course-search-result-text">'+(null==(jade_interp=element.getRelevantContent())?"":jade_interp)+"</p>"),element.hasAdditionalInfo()){if(buf.push('<p class="course-search-result-info">Posted on '+(null==(jade_interp=element.getTimePosted())?"":jade_interp)),element.get("userFullName"))buf.push(" by "+(null==(jade_interp=element.getAuthor())?"":jade_interp));buf.push("</p>")}buf.push("</div>")}),buf.push("</div>"),maxPages>1){if(buf.push('<div class="pagination course-search-pagination"><ul>'),currentPage>1)buf.push('<li class="prev"><a href="javascript:void(0);"'+jade.attr("data-page-num",currentPage-1,!0,!1)+">&larr; Previous</a></li>");for(var displayedDots=!1,i=1;currentPage>i;i++)if(i>2&&currentPage-2>i){if(!displayedDots)displayedDots=!0,buf.push('<li><a href="javascript:void(0);">...</a></li>')}else buf.push('<li><a href="javascript:void(0);"'+jade.attr("data-page-num",i,!0,!1)+">"+jade.escape(null==(jade_interp=i)?"":jade_interp)+"</a></li>");buf.push('<li class="active"><a href="javascript:void(0);">'+jade.escape(null==(jade_interp=currentPage)?"":jade_interp)+"</a></li>");for(var displayedDots=!1,i=currentPage+1;maxPages>=i;i++)if(i>currentPage+2&&maxPages-1>i){if(!displayedDots)displayedDots=!0,buf.push('<li><a href="javascript:void(0);">...</a></li>')}else buf.push('<li><a href="javascript:void(0);"'+jade.attr("data-page-num",i,!0,!1)+">"+jade.escape(null==(jade_interp=i)?"":jade_interp)+"</a></li>");if(maxPages>currentPage)buf.push('<li class="prev"><a href="javascript:void(0);"'+jade.attr("data-page-num",currentPage+1,!0,!1)+">&rarr; Next</a></li>");buf.push("</ul></div>")}}else buf.push('<div data-js-search-results="data-js-search-results" class="course-search-num-results">Sorry, we didn\'t find any results. Please rephrase or generalize your search and try again.</div><div data-js-search-filters="data-js-search-filters" class="course-search-filters"><div data-filter="all">All results</div><div data-filter="courseContent">Course Content</div><div data-filter="discussions">Discussions</div></div>')}("query"in locals_for_with?locals_for_with.query:"undefined"!=typeof query?query:void 0,"elements"in locals_for_with?locals_for_with.elements:"undefined"!=typeof elements?elements:void 0,"total"in locals_for_with?locals_for_with.total:"undefined"!=typeof total?total:void 0,"maxPages"in locals_for_with?locals_for_with.maxPages:"undefined"!=typeof maxPages?maxPages:void 0,"currentPage"in locals_for_with?locals_for_with.currentPage:"undefined"!=typeof currentPage?currentPage:void 0),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("pages/course-search/views/SearchResultsView.html",["js/lib/jade"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["pages.course-search.views.SearchResultsView"]=jadify(wndw.jade.helpers)}(window),define("pages/course-search/models/SearchResultCollection",["backbone","pages/course-search/models/SearchResultModel"],function(Backbone,SearchResultModel){var collection=Backbone.Collection.extend({model:SearchResultModel});return collection}),define("pages/course-search/models/ResultWrapperModel",["underscore","backbone","js/lib/backbone.api","js/lib/util","pages/spark/app","pages/course-search/models/SearchResultModel","pages/course-search/models/SearchResultCollection"],function(_,Backbone,BackboneModelAPI,util,Coursera,SearchResultModel,SearchResultCollection){var COURSE_CONTENT=["wikipage","lecturesubtitle","quiz","assignment","announcement","humangrading"],DISCUSSIONS=["forumpost","forumcomment"],model=Backbone.Model.extend({defaults:{start_page:1,page_size:10,filter:"all",elements:new SearchResultCollection},api:Coursera.api,loadPage:function(pageNum){var self=this,offset=((pageNum||this.get("start_page"))-1)*this.get("page_size"),params={__offset:offset,__limit:this.get("page_size")},classNum=this.get("course_id"),root=util.extractFirstSubdir(window.location.href),searchUrl=root+"courservice/search/v1/"+classNum+"?q="+encodeURIComponent(this.get("query"));for(var param in params)searchUrl+="&"+param+"="+params[param];switch(this.get("filter")){case"all":break;case"courseContent":_.each(COURSE_CONTENT,function(type){searchUrl+="&itemType="+type});break;case"discussions":_.each(DISCUSSIONS,function(type){searchUrl+="&itemType="+type})}return Coursera.api.get(searchUrl).done(function(data){var query=data.query_info.q[0];_.each(data.elements,function(element){element.query=query}),data.elements=new SearchResultCollection(data.elements),self.set(data)})},getMaxPages:function(){return Math.ceil(this.get("paging").total/this.get("paging").__limit)}});return _.extend(model.prototype,BackboneModelAPI),model}),define("pages/course-search/views/SearchResultsView",["backbone","jquery","underscore","js/lib/truncate","js/lib/WidgetView","pages/spark/app","pages/course-search/models/SearchResultModel","pages/course-search/views/SearchResultsView.html","pages/course-search/models/ResultWrapperModel"],function(Backbone,$,_,truncate,WidgetView,Coursera,SearchResultModel,SearchResultsTemplate,ResultWrapperModel){var view=WidgetView.extend({dom:{ENTRIES:"[data-js-search-entry]",FORM:"[data-js-search-form]",INPUT:"[data-js-search-input]",PAGE_LINK:"[data-page-num]",RESULTS:"[data-js-search-results]",FILTER:"[data-filter]",FILTER_ALL:"[data-filter=all]",FILTER_CC:"[data-filter=courseContent]",FILTER_DISC:"[data-filter=discussions]"},events:function(){var allEvents={};return allEvents["click "+this.dom.FILTER]="onFilterClick",allEvents["click "+this.dom.PAGE_LINK]="onPageClick",allEvents["submit "+this.dom.FORM]="onFormSubmit",allEvents},initialize:function(options){this.options=options,Coursera.multitracker.push(["course.search.left_nav"]);var self=this,query=self.getWidgetState("query")||self.options.query||"",filter=self.getWidgetState("filter")||self.options.filter||"all";self.changeWidgetState({query:query,filter:filter}),self.addWidgetStateListener(),self.bind("widget:changed",function(changedParams){if(_.contains(changedParams,"page_num")||_.contains(changedParams,"query")||_.contains(changedParams,"filter"))self.render()}),self.render()},render:function(){Coursera.multitracker.push(["course.search.render"]);var self=this,query=self.getWidgetState("query");query=$.trim(query);var pageNum=self.getWidgetState("page_num")||1,filter=self.getWidgetState("filter");if(Coursera.multitracker.push(["course.search.query",query]),!query)return self.$el.html(SearchResultsTemplate({query:query||"",maxPages:1,total:0,currentPage:1})),self.$(self.dom.FILTER).removeClass("selected"),void self.$("[data-filter="+filter+"]").addClass("selected");var searchResults=new ResultWrapperModel({query:query,start_page:pageNum,page_size:10,course_id:self.options.course_id,filter:filter});searchResults.loadPage(pageNum).done(function(){return Coursera.multitracker.push(["course.search.result_data",{query:query,"num results":searchResults.get("paging").total}]),self.$el.html(SearchResultsTemplate({query:query||"",maxPages:searchResults.getMaxPages(),total:searchResults.get("paging").total,currentPage:parseInt(searchResults.get("start_page"),10),elements:searchResults.get("elements")})),$(".course-search-result-text").each(function(){truncate.byElemHtml($(this))}),$("html, body").scrollTop(self.$el.position().top),self.$(self.dom.FILTER).removeClass("selected"),self.$("[data-filter="+filter+"]").addClass("selected"),self})},onFilterClick:function(e){var filter=$(e.currentTarget).attr("data-filter");this.changeWidgetState({filter:filter}),this.changeWidgetState({page_num:1}),Coursera.multitracker.push(["course.search.filter",filter])},onPageClick:function(e){var pageNum=$(e.currentTarget).attr("data-page-num");this.changeWidgetState({page_num:pageNum}),Coursera.multitracker.push(["course.search.pagination",pageNum])},onFormSubmit:function(e){e.preventDefault();var query=this.$(this.dom.INPUT).val();this.changeWidgetState({page_num:1,query:query}),Coursera.multitracker.push(["course.search.primary"])}});return view}),!function(wndw){var jadify=function(jade,_t){var yudify=function template(locals){var buf=[],jade_mixins={},jade_interp,locals_for_with=locals||{};return function(title,showSearch,query,entries,total,config,spark_class_short_name,spark_class_id,maxPages,currentPage){if(buf.push('<h2 class="course-page-header">'+jade.escape(null==(jade_interp=title||"Search forums")?"":jade_interp)+'</h2><a data-coursera-admin-helpwidget-link="data-coursera-admin-helpwidget-link" rel="help" href="https://class.coursera.org/mooc/help/setup/forum" title="Forum moderation" style="display:none;">Learn more.</a>'),showSearch)buf.push('<div style="text-align:right;padding:5px"><form method="get" data-js-search-form="data-js-search-form" class="form-inline"><input type="text" name="q"'+jade.attr("value",query,!0,!1)+' data-js-search-input="data-js-search-input"/>&nbsp;<button type="submit" class="btn btn-primary">Search All Forums</button></form></div>');if(query)if(entries.size()>0){if(buf.push('<div style="text-align:right;" data-js-search-results="data-js-search-results">Your search returned approximately <strong>'+jade.escape(null==(jade_interp=total)?"":jade_interp)+'</strong> results </div><div data-js-search-entries="data-js-search-entries">'),entries.each(function(entry){if(buf.push('<div style="margin-top:30px;" data-js-search-entry="data-js-search-entry" class="course-forum-post-container"><div class="course-forum-post-header"><h5 class="course-forum-post-byline">'),entry.get("anonymous"))buf.push("<span>Anonymous</span>");else{if(buf.push("<a"+jade.attr("href",entry.get("_user_profile_link"),!0,!1)+">"),entry.get("_user_profile")){if(entry.get("_user_profile").photo_24)buf.push("<img"+jade.attr("src",entry.get("_user_profile").photo_24,!0,!1)+' alt=""/>');buf.push(""+jade.escape(null==(jade_interp=entry.get("_user_profile").display_name)?"":jade_interp))}else buf.push(""+jade.escape(null==(jade_interp=entry.get("_user_full_name"))?"":jade_interp));buf.push("</a>")}if(!entry.get("anonymous"))if(entry.get("_user_title")&&"Student"!=entry.get("_user_title"))buf.push('<span class="course-forum-profile-badge">'+jade.escape(null==(jade_interp=entry.get("_user_title"))?"":jade_interp)+"</span>");else if(entry.get("_show_signature_track_label"))buf.push('<a style="text-decoration: none;"'+jade.attr("href",config.url.base+"signature/course/"+spark_class_short_name+"/"+spark_class_id+"?utm_source=spark&utm_medium=forum",!0,!1)+' target="_blank"><span class="course-forum-profile-badge-signaturetrack">Signature Track</span></a>');buf.push('<span style="vertical-align: middle; margin-left: 5px;" class="course-forum-profile-badgeville"></span><span style="vertical-align:middle">· </span><a'+jade.attr("href",entry.getPermalink(),!0,!1)+jade.attr("name",entry.getPermalinkHash(),!0,!1)+' style="vertical-align:middle"><time'+jade.attr("datetime",entry.get("post_time"),!0,!1)+">"+jade.escape(null==(jade_interp=entry.get("post_time"))?"":jade_interp)+'</time>&nbsp;<span class="icon-link"></span></a><span style="float:right;">Posted in <a'+jade.attr("href",entry.get("thread").get("link"),!0,!1)+">"+jade.escape(null==(jade_interp=entry.get("thread").get("title"))?"":jade_interp)+'</a></span></h5></div></div><div class="course-forum-post-text">'+(null==(jade_interp=entry.get(entry.textProp))?"":jade_interp)+"</div>")}),buf.push("</div>"),maxPages>1){if(buf.push('<div class="pagination"><ul>'),currentPage>1)buf.push('<li class="prev"><a href="javascript:void(0);"'+jade.attr("data-page-num",currentPage-1,!0,!1)+">&larr; Previous</a></li>");for(var displayedDots=!1,i=1;currentPage>i;i++)if(i>2&&currentPage-2>i){if(!displayedDots)displayedDots=!0,buf.push('<li><a href="javascript:void(0);">...</a></li>')}else buf.push('<li><a href="javascript:void(0);"'+jade.attr("data-page-num",i,!0,!1)+">"+jade.escape(null==(jade_interp=i)?"":jade_interp)+"</a></li>");buf.push('<li class="active"><a href="javascript:void(0);">'+jade.escape(null==(jade_interp=currentPage)?"":jade_interp)+"</a></li>");for(var displayedDots=!1,i=currentPage+1;maxPages>=i;i++)if(i>currentPage+2&&maxPages-1>i){if(!displayedDots)displayedDots=!0,buf.push('<li><a href="javascript:void(0);">...</a></li>')}else buf.push('<li><a href="javascript:void(0);"'+jade.attr("data-page-num",i,!0,!1)+">"+jade.escape(null==(jade_interp=i)?"":jade_interp)+"</a></li>");if(maxPages>currentPage)buf.push('<li class="prev"><a href="javascript:void(0);"'+jade.attr("data-page-num",currentPage+1,!0,!1)+">&rarr; Next</a></li>");buf.push("</ul></div>")}}else buf.push('<div style="text-align:center;padding:20px;background-color:#f9f9f9;border:1px solid #e3e3e3;" data-js-no-results="data-js-no-results">Sorry, no results found. Please rephrase or generalize your search query and try again.</div>')}("title"in locals_for_with?locals_for_with.title:"undefined"!=typeof title?title:void 0,"showSearch"in locals_for_with?locals_for_with.showSearch:"undefined"!=typeof showSearch?showSearch:void 0,"query"in locals_for_with?locals_for_with.query:"undefined"!=typeof query?query:void 0,"entries"in locals_for_with?locals_for_with.entries:"undefined"!=typeof entries?entries:void 0,"total"in locals_for_with?locals_for_with.total:"undefined"!=typeof total?total:void 0,"config"in locals_for_with?locals_for_with.config:"undefined"!=typeof config?config:void 0,"spark_class_short_name"in locals_for_with?locals_for_with.spark_class_short_name:"undefined"!=typeof spark_class_short_name?spark_class_short_name:void 0,"spark_class_id"in locals_for_with?locals_for_with.spark_class_id:"undefined"!=typeof spark_class_id?spark_class_id:void 0,"maxPages"in locals_for_with?locals_for_with.maxPages:"undefined"!=typeof maxPages?maxPages:void 0,"currentPage"in locals_for_with?locals_for_with.currentPage:"undefined"!=typeof currentPage?currentPage:void 0),buf.join("")};return function(locals){if(locals&&locals._t)_t=locals._t.merge(_t);return yudify(locals)}};if("function"==typeof define&&define.amd)define("pages/forum/views/ForumSearchView.html",["js/lib/jade"],function(jade,_t){return jadify(jade,_t)});else wndw.jade.templates["pages.forum.views.ForumSearchView"]=jadify(wndw.jade.helpers)}(window),define("pages/forum/views/ForumSearchView",["backbone","jquery","underscore","js/lib/util","pages/spark/app","js/lib/WidgetView","pages/forum/models/PostModel","pages/forum/models/CommentModel","pages/forum/models/ThreadModel","pages/forum/views/ForumSearchView.html"],function(Backbone,$,_,util,Coursera,WidgetView,PostModel,CommentModel,ThreadModel,ForumSearchTemplate){var view=WidgetView.extend({dom:{ENTRIES:"[data-js-search-entry]",FORM:"[data-js-search-form]",INPUT:"[data-js-search-input]",PAGE_LINK:"[data-page-num]",RESULTS:"[data-js-search-results]",NO_RESULTS:"[data-js-no-results]"},events:function(){var allEvents={};return allEvents["submit "+this.dom.FORM]="onFormSubmit",allEvents["click "+this.dom.PAGE_LINK]="onPageClick",allEvents},initialize:function(options){var self=this;this.options=options;var query=this.getWidgetState("query")||this.options.query||"";self.changeWidgetState({query:query}),self.addWidgetStateListener(),self.bind("widget:changed",function(changedParams){if(_.contains(changedParams,"page_num")||_.contains(changedParams,"query"))self.render()}),self.render()},render:function(){var self=this,query=$.trim(self.getWidgetState("query")),pageNum=self.getWidgetState("page_num")||1;if(!query)return void self.$el.html(ForumSearchTemplate({query:query||"",title:"",showSearch:!0}));var searchUrl="forum/search?query="+encodeURIComponent(query)+"&page_size=20&start_page="+pageNum;return Coursera.api.get(searchUrl,{message:{waiting:"Searching...",success:"Done searching!"}}).done(function(data){entries=new Backbone.Collection,_.each(data.entries,function(entry){if(entry.thread._ignore_profiles=!0,"post"==entry.entry_type)entry=PostModel.findOrCreate(entry);else entry=CommentModel.findOrCreate(entry);if(entry.get("thread")&&!(entry.get("thread")instanceof ThreadModel))entry.set("thread",ThreadModel.findOrCreate(entry.get("thread")),{silent:!0});entries.add(entry)}),self.$el.html(ForumSearchTemplate({spark_class_short_name:window.spark_class_short_name,spark_class_id:window.spark_class_id,config:Coursera.config,query:data.query||"",title:data.title,showSearch:data.show_search,maxPages:data.max_pages,total:data.total,currentPage:data.start_page,entries:entries})),_.each(self.$(self.dom.ENTRIES).find("time"),function(entry){util.prettifyTime($(entry))}),$("html,body").scrollTop(self.$el.position().top)}),this},onPageClick:function(e){this.changeWidgetState({page_num:$(e.currentTarget).attr("data-page-num")})},onFormSubmit:function(e){e.preventDefault(),this.changeWidgetState({page_num:1,query:this.$(this.dom.INPUT).val()})}});return view}),define("pages/forum/widgets",["jquery","underscore","backbone","js/lib/util","pages/spark/app","pages/spark/models/user","pages/forum/models/ThreadModel","pages/forum/models/ForumModel","pages/forum/models/ForumThreadsModel","pages/forum/models/ReputationsCollection","pages/forum/views/ThreadView","pages/forum/views/ThreadNewView","pages/forum/views/UserProfileView","pages/forum/views/ForumView","pages/forum/views/ForumThreadsView","pages/forum/views/ForumThreadsMiniView","pages/forum/views/ForumReputationsView","pages/course-search/views/SearchResultsView","pages/forum/views/ForumSearchView"],function($,_,Backbone,util,Coursera,UserModel,ThreadModel,ForumModel,ForumThreadsModel,ReputationsCollection,ThreadView,ThreadNewView,UserProfileView,ForumView,ForumThreadsView,ForumThreadsMiniView,ForumReputationsView,SearchResultsView,ForumSearchView){$(document).ready(function(){$("[data-coursera-forum-thread-widget]").each(function(){var triageEnabled=$(this).is("[data-triage-enabled]"),hangoutsEnabled=$(this).is("[data-hangouts-enabled]"),courseId=Coursera.course.get("id"),threadId=parseInt($(this).attr("data-thread-id"),10),threadMode=$(this).attr("data-thread-mode"),hash=window.location.hash.replace("#","").split("-"),opt={};opt[hash[0]]=hash[1];var sort=util.getUrlParam(window.location.href,"sort"),thread=ThreadModel.findOrCreate({courseId:courseId,triageEnabled:triageEnabled,id:threadId,_sort_order:sort});new ThreadView(_.extend(opt,{el:$(this)[0],model:thread,mode:threadMode,hangoutsEnabled:hangoutsEnabled}))}),$("[data-coursera-forum-thread-new-widget]").each(function(){var thread=ThreadModel.findOrCreate({forum_id:$(this).attr("data-forum-id")});new ThreadNewView({el:$(this)[0],model:thread,tagName:$(this).attr("data-tag-name"),linkToReporter:$(this).attr("data-link-to-reporter")})}),$("[data-coursera-forum-widget]").each(function(){var forumId=$(this).attr("data-forum-id"),embedMode=$(this).attr("data-embed-mode"),forum=ForumModel.findOrCreate({id:forumId,course_id:Coursera.course.get("id")});new ForumView({el:$(this)[0],mode:embedMode,model:forum})}),$("[data-coursera-forum-threads-widget]").each(function(){var forum=ForumModel.findOrCreate({id:$(this).attr("data-forum-id")||"0",course_id:Coursera.course.get("id")}),forumThreads=new ForumThreadsModel({id:forum.get("id"),tag_id:$(this).attr("data-tag-id"),tag_name:$(this).attr("data-tag-name"),course_id:Coursera.course.get("id"),sort:util.getUrlParam(window.location.href,"sort")});new ForumThreadsView({el:$(this)[0],mode:$(this).attr("data-embed-mode"),model:forum,threads:forumThreads,showNewThread:!0}),forum.read()}),$("[data-coursera-forum-mini-threads-widget]").each(function(){var forumThreads=new ForumThreadsModel({id:$(this).attr("data-forum-id")||"0",page_size:5});new ForumThreadsMiniView({el:$(this)[0],model:forumThreads})}),$("[data-coursera-forum-user-profile-widget]").each(function(){new UserProfileView({el:$(this)[0],mode:$(this).attr("data-embed-mode"),id:$(this).attr("data-user-id")})}),$("[data-coursera-forum-reputations-widget]").each(function(){new ForumReputationsView({el:$(this)[0],mode:$(this).attr("data-embed-mode"),collection:new ReputationsCollection}).render()}),$("[data-coursera-forum-search-widget]").each(function(){new ForumSearchView({el:$(this)[0],query:$(this).attr("data-query")}).render()}),$("[data-coursera-reporter-widget]").each(function(){var area=$(this).attr("data-coursera-reporter-area"),problem=$(this).attr("data-coursera-reporter-problem"),title=$(this).attr("data-coursera-reporter-title"),url=$(this).attr("data-coursera-reporter-url");new ReporterView({el:$(this)[0],area:area,problem:problem,itemTitle:title,itemUrl:url}).render()}),$("[data-coursera-course-search-widget]").each(function(){var courseId=Coursera.course.get("id");new SearchResultsView({el:$(this)[0],course_id:courseId,query:$(this).attr("data-query")||""}).render()})})});